<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>OpenSSL CVE-2022-0778æ¼æ´é—®é¢˜å¤ç°ä¸éæ³•è¯ä¹¦æ„é€ </title>
    <url>/posts/83951100/</url>
    <content><![CDATA[<div class="note primary">
            <p>æœ¬æ–‡ä»‹ç»CVE-2022 0778æ¼æ´åŠå…¶å¤ç°æ–¹æ³•ï¼Œå¹¶ç²¾å¿ƒæ„é€ äº†å…·æœ‰ä¸€ä¸ªéæ³•æ¤­åœ†æ›²çº¿å‚æ•°çš„è¯ä¹¦å¯ä»¥è§¦å‘è¯¥æ¼æ´ã€‚</p>
          </div>

<span id="more"></span>



<h1 id="æ¼æ´æè¿°-1"><a href="#æ¼æ´æè¿°-1" class="headerlink" title="æ¼æ´æè¿°[^1]"></a>æ¼æ´æè¿°[^1]</h1><p>æ¼æ´å‡ºè‡ª<code>BN_mod_sqrt()</code>æ¥å£å‡½æ•°ï¼Œå®ƒç”¨äºè®¡ç®—æ¨¡å¹³æ–¹æ ¹ï¼Œä¸”æœŸæœ›å‚æ•°påº”è¯¥æ˜¯ä¸ªè´¨æ•°ï¼Œä½†æ˜¯å‡½æ•°å†…å¹¶æ²¡æœ‰è¿›è¡Œæ£€æŸ¥ï¼Œè¿™å¯¼è‡´å†…éƒ¨å¯èƒ½å‡ºç°æ— é™å¾ªç¯ã€‚è¿™ä¸ªå‡½æ•°åœ¨è§£æå¦‚ä¸‹æ ¼å¼çš„è¯ä¹¦æ—¶ä¼šè¢«ç”¨åˆ°ï¼š</p>
<ul>
<li>è¯ä¹¦åŒ…å«å‹ç¼©æ ¼å¼çš„æ¤­åœ†æ›²çº¿å…¬é’¥æ—¶</li>
<li>è¯ä¹¦å¸¦æœ‰æ˜¾å¼æ¤­åœ†æ›²çº¿å‚æ•°ï¼Œå…¶åŸºç‚¹æ˜¯å‹ç¼©æ ¼å¼ç¼–ç çš„</li>
</ul>
<p>æ€»ä¹‹ï¼Œåœ¨è§£æè¯ä¹¦æ—¶éœ€è¦å¯¹ç‚¹åæ ‡è¿›è¡Œè§£å‹ç¼©æ“ä½œçš„å°±ä¼šè°ƒç”¨åˆ°è¿™ä¸ªå‡½æ•°ã€‚æ‰€ä»¥å¤–éƒ¨å¯ä»¥é€šè¿‡ç²¾å¿ƒæ„é€ ä¸€ä¸ªå…·æœ‰éæ³•çš„æ˜¾å¼æ›²çº¿å‚æ•°çš„è¯ä¹¦æ¥è§¦å‘æ— é™å¾ªç¯ï¼Œä»è€Œé€ æˆDoSæ‹’ç»æœåŠ¡æ”»å‡»ã€‚</p>
<div class="note default no-icon">
            <p>å®˜æ–¹è¡¥ä¸commit[^2] </p>
          </div>

<h1 id="å‡½æ•°åˆ†æ"><a href="#å‡½æ•°åˆ†æ" class="headerlink" title="å‡½æ•°åˆ†æ"></a>å‡½æ•°åˆ†æ</h1><p>æˆ‘ä»¬å…ˆç®€å•è¿‡ä¸€ä¸‹è¿™ä¸ªå‡½æ•°çš„å®ç°ã€‚å®ç°å‡½æ•°ç­¾åå¦‚ä¸‹ï¼Œaæ˜¯æ“ä½œæ•°ï¼Œpæ˜¯æ¨¡æ•°</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function">BIGNUM *<span class="title">BN_mod_sqrt</span><span class="params">(BIGNUM *in, <span class="keyword">const</span> BIGNUM *a, <span class="keyword">const</span> BIGNUM *p, BN_CTX *ctx)</span></span></span><br></pre></td></tr></table></figure>

<p>é¦–å…ˆå¯¹påšäº†ç®€å•çš„æ£€æŸ¥ï¼Œå¯¹pæ˜¯å¶æ•°ã€1è¿™ä¸¤ä¸ªæ˜¾ç„¶ä¸æ˜¯è´¨æ•°çš„æƒ…å†µç›´æ¥æŠ¥é”™ï¼Œå¯¹pä¸º2çš„æƒ…å†µè¿›è¡Œäº†ç‰¹æ®Šå¤„ç†ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (!BN_is_odd(p) || BN_abs_is_word(p, <span class="number">1</span>)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (BN_abs_is_word(p, <span class="number">2</span>)) &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    BNerr(BN_F_BN_MOD_SQRT, BN_R_P_IS_NOT_PRIME);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥å¯¹aæ˜¯0æˆ–1çš„ç‰¹æ®Šæƒ…å†µåšäº†ç‰¹æ®Šå¤„ç†</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (BN_is_zero(a) || BN_is_one(a)) &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç„¶åè®¡ç®—<code>A := a mod p</code>ï¼Œå°±æ˜¯è®¡ç®—éè´Ÿä½™æ•°</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (!BN_nnmod(A, a, p, ctx))</span><br></pre></td></tr></table></figure>

<p>ä¸‹é¢å‡ è¡Œçš„å­—é¢æ„æ€æ˜¯ä»pçš„ç¬¬1ä½å¼€å§‹æ•°æœ‰å‡ ä¸ªè¿ç»­çš„0ï¼Œå…¶å®æ˜¯å°†|p| - 1è¡¨ç¤ºæˆå¦‚ä¸‹çš„æ ¼å¼ï¼š<code>|p| - 1 == 2^e * q</code>ï¼Œå³è¡¨ç¤ºæˆ2çš„å¹‚æ¬¡æ–¹çš„å¥‡æ•°å€ï¼Œå…¶ä¸­qæ˜¯å¥‡æ•°ã€‚ä¾‹å¦‚pä¸º49ï¼Œè¡¨ç¤ºäºŒè¿›åˆ¶æ˜¯110001ï¼Œé‚£ä¹ˆeä¸º4ï¼Œqä¸º3ï¼Œ<code>49 - 1 == 2^4 * 3</code></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">e = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">while</span> (!BN_is_bit_set(p, e))</span><br><span class="line">    e++;</span><br></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥å¯¹eç­‰äº1æˆ–2çš„ç®€å•æƒ…å†µè¿›è¡Œç‰¹æ®Šå¤„ç†ï¼Œå› ä¸ºä¸ä¼šèµ°åˆ°æ— é™å¾ªç¯ï¼Œæˆ‘ä»¬è·³è¿‡</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (e == <span class="number">1</span>) &#123;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (e == <span class="number">2</span>) &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯¹äºe &gt; 2çš„æƒ…å†µï¼Œå°±éœ€è¦è€è€å®å®ç”¨Tonelli&#x2F;Shanksç®—æ³•æ¥è®¡ç®—äº†ã€‚é¦–å…ˆéœ€è¦æ‰¾åˆ°ä¸€ä¸ªä¸æ˜¯å¹³æ–¹æ•°çš„yï¼Œä¸”<code>0 &lt; y &lt; |p|</code>ï¼Œå› ä¸ºä¸æ˜¯é‡ç‚¹æˆ‘ä»¬è·³è¿‡ã€‚</p>
<p>æ¥ä¸‹æ¥è®¡ç®—qçš„å€¼ï¼Œå°†på³ç§»eä½å°±å¾—åˆ°äº†q</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">	<span class="keyword">if</span> (!BN_copy(q, p))</span><br><span class="line">   <span class="comment">// ...</span></span><br><span class="line"><span class="keyword">if</span> (!BN_rshift(q, q, e))</span><br></pre></td></tr></table></figure>

<p><code>y := (y ^ q) mod p</code>ï¼Œå› ä¸ºyæ˜¯ä¸ªéå¹³æ–¹æ•°ï¼Œæ‰€ä»¥è®¡ç®—qæ¬¡æ–¹å¯ä»¥å¾—åˆ°ä¸€ä¸ªé˜¶ä¸º2^eçš„å€¼ã€‚ï¼ˆDonâ€™t ask me why ï¼Œæ³¨é‡Šè¿™ä¹ˆå†™çš„ğŸ¤·â€â™‚ï¸ï¼‰</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (!BN_mod_exp(y, y, q, p, ctx))</span><br></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥æ˜¯è®¡ç®—<code> x := a^((q-1)/2)</code></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (!BN_rshift1(t, q))</span><br><span class="line">    </span><br><span class="line"><span class="keyword">if</span> (!BN_mod_exp(x, A, t, p, ctx))</span><br></pre></td></tr></table></figure>

<p>ä¸‹é¢ä¸¤ä¸ªè®¡ç®—<code>b := a*x^2  (= a^q) </code></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (!BN_mod_sqr(b, x, p, ctx))</span><br><span class="line">    </span><br><span class="line"><span class="keyword">if</span> (!BN_mod_mul(b, b, A, p, ctx))</span><br></pre></td></tr></table></figure>

<p>ç„¶åè®¡ç®—<code>x := a*x   (= a^((q+1)/2)) </code></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (!BN_mod_mul(x, x, A, p, ctx))</span><br></pre></td></tr></table></figure>

<p>ç»ˆäºè¦è¿›å…¥æˆ‘ä»¬æœ€å…³å¿ƒçš„å¾ªç¯ç»“æ„äº†ï¼Œè¿™é‡Œæœ‰ä¸¤å±‚å¾ªç¯ï¼Œæ­»å¾ªç¯æ˜¯å‘ç”Ÿåœ¨å†…å±‚çš„å¾ªç¯ä¸­ã€‚æˆ‘ä»¬æ¥çœ‹ä¸‹ä¿®æ”¹å‰åçš„ä»£ç çš„åŒºåˆ«ï¼Œä¸‹é¢çš„æ˜¯æœ‰é—®é¢˜çš„å¾ªç¯ä»£ç ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// before</span></span><br><span class="line">i = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">if</span> (!BN_mod_sqr(t, b, p, ctx))</span><br><span class="line">    <span class="keyword">goto</span> end;</span><br><span class="line"><span class="keyword">while</span> (!BN_is_one(t)) &#123;</span><br><span class="line">    i++;</span><br><span class="line">    <span class="keyword">if</span> (i == e) &#123;</span><br><span class="line">        ERR_raise(ERR_LIB_BN, BN_R_NOT_A_SQUARE);</span><br><span class="line">        <span class="keyword">goto</span> end;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!BN_mod_mul(t, t, t, p, ctx))</span><br><span class="line">        <span class="keyword">goto</span> end;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªæ˜¯ä¿®å¤åçš„å¾ªç¯ä»£ç ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// after</span></span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">1</span>; i &lt; e; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (i == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!BN_mod_sqr(t, b, p, ctx))</span><br><span class="line">            <span class="keyword">goto</span> end;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!BN_mod_mul(t, t, t, p, ctx))</span><br><span class="line">            <span class="keyword">goto</span> end;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (BN_is_one(t))</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¹ä¸€çœ‹å¥½åƒæ²¡ä»€ä¹ˆåŒºåˆ«ï¼Œåªæ˜¯æŠŠwhileå¾ªç¯æ”¹æˆäº†forå¾ªç¯ã€‚åŒºåˆ«éå¸¸ç»†å¾®ï¼Œä¸»è¦æœ‰ä¸¤ç‚¹ï¼š</p>
<ol>
<li>ç»“æŸå¾ªç¯çš„åˆ¤æ–­æ¡ä»¶ä¸åŒï¼Œå‰è€…æ˜¯åˆ¤æ–­tæ˜¯å¦ä¸º1æ¥æ­£å¸¸ç»“æŸï¼Œåœ¨å¾ªç¯å†…åˆ¤æ–­<code>i == e</code>æ¥å¼‚å¸¸ç»“æŸï¼›è€Œåè€…æ˜¯åˆ¤æ–­<code>i &lt; e</code>æ¥å¼‚å¸¸ç»“æŸï¼Œå¾ªç¯ä¸­åˆ¤æ–­tæ˜¯å¦ä¸º1æ¥æ­£å¸¸ç»“æŸ</li>
<li>è¿˜æœ‰éå¸¸é‡è¦çš„ä¸€ç‚¹åŒºåˆ«ï¼Œå°±æ˜¯å‰è€…iä¸º1çš„æƒ…å†µå¹¶ä¸åœ¨å¾ªç¯ä¸­</li>
</ol>
<p>é—®é¢˜å°±æ˜¯ç”±äºè¿™ç‚¹ç»†å¾®çš„åŒºåˆ«äº§ç”Ÿçš„ï¼Œè€ƒè™‘è¿™æ ·ä¸€ç§æƒ…å†µï¼Œå¦‚ä¸‹å†…å±‚å¾ªç¯ä¸€å¼€å§‹eå°±å°äºç­‰äºiï¼ˆæ¯”å¦‚e&#x3D;1ï¼‰ï¼Œé‚£ä¹ˆ<code>i == e</code>æ¡ä»¶å°†æ°¸è¿œä¸ä¼šæ»¡è¶³ã€‚å¦‚æœå†ä½¿å¾—tæ°¸è¿œä¸ç­‰äº1ï¼Œé‚£ä¹ˆå°±ä¼šè¿›å…¥æ­»å¾ªç¯äº†ã€‚</p>
<p>å¯¹äºç¬¬ä¸€æ¬¡è¿›å…¥å¤–å±‚å¾ªç¯ï¼Œeè‚¯å®šæ˜¯å¤§äº2çš„ï¼Œä¸ä¼šè¿›å…¥æ­»å¾ªç¯ï¼Œä½†æ˜¯åˆ«å¿˜äº†åœ¨å¤–å±‚å¾ªç¯æœ€åä¼šæŠŠièµ‹å€¼ç»™eï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">       <span class="comment">// ...</span></span><br><span class="line">    	<span class="keyword">for</span> (i = <span class="number">1</span>; i &lt; e; i++) &#123;</span><br><span class="line">           <span class="comment">// ...</span></span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">/* t := y^2^(e - i - 1) */</span></span><br><span class="line">       <span class="keyword">if</span> (!BN_copy(t, y))</span><br><span class="line">           <span class="keyword">goto</span> end;</span><br><span class="line">       <span class="keyword">for</span> (j = e - i - <span class="number">1</span>; j &gt; <span class="number">0</span>; j--) &#123;</span><br><span class="line">           <span class="keyword">if</span> (!BN_mod_sqr(t, t, p, ctx))</span><br><span class="line">               <span class="keyword">goto</span> end;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">if</span> (!BN_mod_mul(y, t, t, p, ctx))  <span class="comment">// y := t^2 = y^2^(e-i)</span></span><br><span class="line">           <span class="keyword">goto</span> end;</span><br><span class="line">       <span class="keyword">if</span> (!BN_mod_mul(x, x, t, p, ctx))  <span class="comment">// x = x*t</span></span><br><span class="line">           <span class="keyword">goto</span> end;</span><br><span class="line">       <span class="keyword">if</span> (!BN_mod_mul(b, b, y, p, ctx))  <span class="comment">// b = y^2^(e-i) y is the original</span></span><br><span class="line">           <span class="keyword">goto</span> end;</span><br><span class="line">       e = i;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>æ‰€ä»¥ç»“åˆè¿™äº›æ¡ä»¶ï¼Œå°±å¯ä»¥å°è¯•æ„é€ å‡ºèƒ½å¤Ÿè¿›å…¥æ­»å¾ªç¯çš„æ”»å‡»æ–¹å¼ï¼š</p>
<ol>
<li>æŒ‘é€‰åˆé€‚çš„aå’Œpï¼Œä½¿å¾—<code>b^2=1(mod p)</code>ï¼Œå…¶ä¸­bæ˜¯ç”±aè®¡ç®—å‡ºæ¥çš„ï¼Œè¿™æ ·å¤–å±‚å¾ªç¯åœ¨ç¬¬ä¸€æ¬¡è¿­ä»£æ—¶ä¸ä¼šè¿›å…¥whileå†…å±‚å¾ªç¯ï¼Œiçš„å€¼å°±ä¸º1ï¼Œäºæ˜¯å¤–å±‚å¾ªç¯ç¬¬äºŒæ¬¡è¿­ä»£æ—¶eå°±å˜æˆäº†1</li>
<li>å¤–å±‚å¾ªç¯è¿›è¡Œç¬¬äºŒæ¬¡è¿­ä»£æ—¶ï¼Œåªè¦ä½¿å¾—<code>t != 1 (mod p)</code>æ°¸è¿œæ»¡è¶³ï¼Œå°±ä¼šè¿›å…¥æ­»å¾ªç¯äº†</li>
</ol>
<p><strong>æ³¨æ„</strong>ï¼šç¬¬1ä¸ªæ¡ä»¶åœ¨pä¸ºæ­£å¸¸çš„è´¨æ•°æ—¶ä¹Ÿæ˜¯ä¼šå‘ç”Ÿçš„ï¼Œä½†å¦‚æœpæ˜¯åˆæ•°é‚£ä¹ˆç¬¬äºŒæ¡ä¹Ÿå°†æ»¡è¶³ã€‚</p>
<h1 id="å¤ç°é—®é¢˜"><a href="#å¤ç°é—®é¢˜" class="headerlink" title="å¤ç°é—®é¢˜"></a>å¤ç°é—®é¢˜</h1><p>è¦å¤ç°é—®é¢˜ï¼Œå…¶å®å°±æ˜¯æŒ‘é€‰åˆé€‚çš„å‚æ•°aå’Œpä½¿å¾—ä¸Šé¢çš„æ¡ä»¶æˆç«‹ã€‚pçš„é€‰å–éœ€è¦èƒ½å¤Ÿæ»¡é€šè¿‡å‡½æ•°å‰é¢çš„ä¸€äº›æ£€æŸ¥ï¼Œä¸èƒ½æ˜¯å¤ªæ˜æ˜¾çš„åˆæ•°ï¼Œå¿…é¡»æ˜¯å¥‡æ•°ï¼Œä¸”eéœ€è¦å¤§äº2ï¼Œå³äºŒè¿›åˆ¶è¡¨ç¤ºçš„på¿…é¡»æ˜¯<code>â€¦001</code>å½¢å¼ã€‚æ­¤å¤–açš„é€‰å–éœ€è¦æ»¡è¶³<code>a == -1 (mod p)</code>ä¸”<code>b == -1 (mod p)</code>ï¼Œè¿™æ ·åœ¨ç¬¬ä¸€æ¬¡å¤–å±‚è¿­ä»£åeå°±ä¼šè®¾ä¸º1ï¼Œä½¿å¾—ç¬¬äºŒæ¬¡è¿›å…¥å¤–å±‚è¿­ä»£è¿›å…¥æ­»å¾ªç¯ã€‚</p>
<p>ç¡®å®šaå’Œpéœ€è¦ä¸€å®šçš„æ•°å­¦çŸ¥è¯†ï¼Œéœ€è¦äº†è§£Tonelli&#x2F;Shanksç®—æ³•çš„å®ç°ã€‚æˆ‘ä¸æ˜¯å­¦æ•°å­¦çš„ï¼Œæ²¡å­¦è¿‡æ•°è®ºé‚£äº›ä¸œè¥¿ï¼Œæ‰€ä»¥è¦å®Œå…¨äº†è§£å…¶æ•°å­¦åŸç†éœ€è¦èŠ±äº›æ—¶é—´ã€‚å¥½åœ¨drago-96åŒå­¦å¸®æˆ‘ä»¬åšäº†è¿™ä¸ªäº‹æƒ…ï¼Œä»–æœ€ç»ˆé€‰å–äº†p&#x3D;697ï¼Œa&#x3D;696è¿™ä¸ªç»„åˆã€‚æœ‰å…´è¶£çš„å¯ä»¥çœ‹ä¸€ä¸‹æ•°å­¦è¯´æ˜[^3]ã€‚</p>
<p>æœ‰äº†aå’Œpï¼Œç„¶åå†™ä¸€ä¸ªç®€å•çš„æµ‹è¯•ç¨‹åºå°±å¯ä»¥å¤ç°é—®é¢˜äº†</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;openssl/bn.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    BN_CTX *ctx;</span><br><span class="line">    ctx = BN_CTX_new();</span><br><span class="line">    BIGNUM *res, *a, *p;</span><br><span class="line">    BN_CTX_start(ctx);</span><br><span class="line">    res = BN_CTX_get(ctx);</span><br><span class="line">    a = BN_CTX_get(ctx);</span><br><span class="line">    p = BN_CTX_get(ctx);</span><br><span class="line"></span><br><span class="line">    BN_dec2bn(&amp;p, <span class="string">&quot;697&quot;</span>);</span><br><span class="line">    BN_dec2bn(&amp;a, <span class="string">&quot;696&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;p = %s\n&quot;</span>, BN_bn2dec(p));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;a = %s\n&quot;</span>, BN_bn2dec(a));</span><br><span class="line"></span><br><span class="line">    BIGNUM* check = BN_mod_sqrt(res, a, p, ctx);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, BN_bn2dec(res));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯¹äºä¿®å¤å‰çš„ä»£ç ï¼Œç¨‹åºæ‰§è¡Œåä¼šè¿›å…¥æ­»å¾ªç¯</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ./sqrt</span><br><span class="line">p = 697</span><br><span class="line">a = 696</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>è€Œä¿®æ”¹åå¯ä»¥æ­£å¸¸ç»“æŸã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ./sqrt</span><br><span class="line">p = 697</span><br><span class="line">a = 696</span><br><span class="line">0</span><br><span class="line">$ </span><br></pre></td></tr></table></figure>

<h1 id="æ„é€ éæ³•è¯ä¹¦"><a href="#æ„é€ éæ³•è¯ä¹¦" class="headerlink" title="æ„é€ éæ³•è¯ä¹¦"></a>æ„é€ éæ³•è¯ä¹¦</h1><p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥å°è¯•æ„é€ ä¸€ä¸ªéæ³•çš„è¯ä¹¦ï¼Œä½¿è¯ä¹¦å¸¦æœ‰æ˜¾å¼æ¤­åœ†æ›²çº¿å‚æ•°ï¼Œä¸”åŸºç‚¹æ˜¯å‹ç¼©æ ¼å¼ç¼–ç çš„ã€‚ç„¶åæˆ‘ä»¬å°†è¯ä¹¦ä¸­æ›²çº¿å‚æ•°ä¿®æ”¹æˆæˆ‘ä»¬æƒ³è¦çš„å€¼ã€‚</p>
<h2 id="åˆ›å»ºä¸€ä¸ªæ­£å¸¸çš„å¸¦æ˜¾å¼æ›²çº¿å‚æ•°çš„è¯ä¹¦"><a href="#åˆ›å»ºä¸€ä¸ªæ­£å¸¸çš„å¸¦æ˜¾å¼æ›²çº¿å‚æ•°çš„è¯ä¹¦" class="headerlink" title="åˆ›å»ºä¸€ä¸ªæ­£å¸¸çš„å¸¦æ˜¾å¼æ›²çº¿å‚æ•°çš„è¯ä¹¦"></a>åˆ›å»ºä¸€ä¸ªæ­£å¸¸çš„å¸¦æ˜¾å¼æ›²çº¿å‚æ•°çš„è¯ä¹¦</h2><p>é¦–å…ˆæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªecå¯†é’¥ï¼Œå› ä¸ºæˆ‘ä»¬æƒ³è¦è¯ä¹¦ä¸­åŒ…å«æ˜¾å¼çš„æ›²çº¿å‚æ•°ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨ç”Ÿæˆå¯†é’¥æ—¶ä¹Ÿé€‰æ‹©å¸¦æ˜¾å¼å‚æ•°</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ openssl ecparam -out ec.key -name prime256v1 -genkey -noout -param_enc explicit -conv_form compressed</span><br></pre></td></tr></table></figure>

<p>æ¥ç€ä¸ºäº†æ–¹ä¾¿èµ·è§ï¼Œæˆ‘ä»¬ç›´æ¥è‡ªç­¾å‘ä¸€ä¸ªè¯ä¹¦ã€‚è¿™é‡Œå°†è¾“å‡ºæ ¼å¼è®¾ä¸ºDERä¹Ÿæ˜¯ä¸ºäº†æ–¹ä¾¿æˆ‘ä»¬åé¢çš„ä¿®æ”¹ASN1ç»“æ„ã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ openssl req -new -x509 -key ec.key -out cert.der -outform DER -days 360 -subj <span class="string">&quot;/CN=TEST/&quot;</span></span><br></pre></td></tr></table></figure>

<p>ç¡®è®¤ä¸€ä¸‹è¯ä¹¦ä¿¡æ¯ï¼Œå…¶ä¸­åŒ…å«äº†æ›²çº¿å‚æ•°ä¿¡æ¯ï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ openssl x509 -<span class="keyword">in</span> cert.der -text -noout -inform DER</span><br><span class="line">...</span><br><span class="line">                Field Type: prime-field</span><br><span class="line">                Prime:</span><br><span class="line">                    00:ff:ff:ff:ff:00:00:00:01:00:00:00:00:00:00:</span><br><span class="line">                    00:00:00:00:00:00:ff:ff:ff:ff:ff:ff:ff:ff:ff:</span><br><span class="line">                    ff:ff:ff</span><br><span class="line">                A:</span><br><span class="line">                    00:ff:ff:ff:ff:00:00:00:01:00:00:00:00:00:00:</span><br><span class="line">                    00:00:00:00:00:00:ff:ff:ff:ff:ff:ff:ff:ff:ff:</span><br><span class="line">                    ff:ff:<span class="built_in">fc</span></span><br><span class="line">                B:</span><br><span class="line">                    5a:c6:35:d8:aa:3a:93:e7:b3:eb:bd:55:76:98:86:</span><br><span class="line">                    bc:65:1d:06:b0:cc:53:b0:f6:3b:ce:3c:3e:27:d2:</span><br><span class="line">                    60:4b</span><br><span class="line">                Generator (compressed):</span><br><span class="line">                    03:6b:17:d1:f2:e1:2c:42:47:f8:bc:e6:e5:63:a4:</span><br><span class="line">                    40:f2:77:03:7d:81:2d:eb:33:a0:f4:a1:39:45:d8:</span><br><span class="line">                    98:c2:96</span><br><span class="line">                Order:</span><br><span class="line">                    00:ff:ff:ff:ff:00:00:00:00:ff:ff:ff:ff:ff:ff:</span><br><span class="line">                    ff:ff:bc:e6:fa:ad:a7:17:9e:84:f3:b9:ca:c2:<span class="built_in">fc</span>:</span><br><span class="line">                    63:25:51</span><br><span class="line">...                    </span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­çš„Primeã€Aã€Bã€Generatorå°±æ˜¯æˆ‘ä»¬éœ€è¦ä¿®æ”¹çš„ç›®æ ‡å‚æ•°ã€‚é‚£ä¹ˆæˆ‘ä»¬åº”è¯¥å°†å…¶æ”¹æˆä»€ä¹ˆå‘¢ï¼Ÿç„¶ååˆé€šè¿‡ä»€ä¹ˆæ–¹æ³•è¿›è¡Œä¿®æ”¹å‘¢ï¼Ÿ</p>
<h2 id="æ„é€ éæ³•è¯ä¹¦-1"><a href="#æ„é€ éæ³•è¯ä¹¦-1" class="headerlink" title="æ„é€ éæ³•è¯ä¹¦"></a>æ„é€ éæ³•è¯ä¹¦</h2><p>é¦–å…ˆï¼Œåœ¨å®é™…åŠ¨æ‰‹æˆ‘ä»¬å…ˆéœ€è¦ææ¸…æ¥šè¿™å‡ ä¸ªå€¼æ˜¯ä»€ä¹ˆæ„æ€ã€éœ€è¦æ»¡è¶³ä»€ä¹ˆå…³ç³»ã€‚å®šä¹‰åœ¨æœ‰é™åŸŸä¸Šçš„æ¤­åœ†æ›²çº¿æ»¡è¶³å¦‚ä¸‹æ–¹ç¨‹<br>$$<br>y^2 \equiv x^3+ax+b\quad (mod\ p)<br>$$<br>å…¶ä¸­çš„aå°±æ˜¯æ›²çº¿å‚æ•°Aï¼Œbå°±æ˜¯æ›²çº¿å‚æ•°Bï¼Œpå³ä¸ºæ›²çº¿å‚æ•°Primeï¼Œaã€bã€på‚æ•°ç¡®å®šäº†ä¸€æ¡æ¤­åœ†æ›²çº¿ã€‚è§£å‹ç¼©ç‚¹åæ ‡å°±æ˜¯æ ¹æ®xåæ ‡æ¥è®¡ç®—yåæ ‡ï¼Œä»ä¸Šé¢çš„å…¬å¼å¯ä»¥çœ‹åˆ°è¿™éœ€è¦ç”¨åˆ°æ±‚å¹³æ–¹æ ¹çš„è¿ç®—ï¼š<br>$$<br>y&#x3D;\sqrt{x^3+ax+b}\quad (mod\ p)<br>$$<br>æˆ‘ä»¬æ²¿ç”¨ä¹‹å‰ä½¿ç”¨çš„697&#x2F;696ç»„åˆï¼Œå³æ­¤æ—¶ p &#x3D; 697ï¼Œ$x^3+ax+b&#x3D;696$ã€‚æˆ‘ä»¬åªè¦é€‰æ‹©åˆé€‚çš„aã€bã€xæ˜¯åé¢é‚£ä¸ªç­‰å¼æˆç«‹å°±å¯ä»¥äº†ã€‚</p>
<p>æˆ‘ä»¬ä»¤x&#x3D;8ï¼Œa&#x3D;23ï¼Œb&#x3D;0ï¼Œç­‰å¼æˆç«‹ã€‚</p>
<p>æ¥ä¸‹æ¥å°±è¦ç€æ‰‹ä¿®æ”¹æˆ‘ä»¬çš„è¯ä¹¦ï¼Œå¾’æ‰‹ä¿®æ”¹ASN1ç»“æ„çœŸçš„æ˜¯è¦äº†æˆ‘çš„è€å‘½ï¼Œå¤§å®¶å¦‚æœçŸ¥é“æœ‰ä»€ä¹ˆæ–¹ä¾¿çš„å·¥å…·è¿˜è¯·ä¸åèµæ•™ã€‚å› ä¸ºè¿™éƒ¨åˆ†è¿˜æ²¡æ³•è‡ªåŠ¨åŒ–ï¼ˆè‡³å°‘ç›®å‰æ²¡æœ‰ï¼‰ï¼Œæ‰€ä»¥æˆ‘å°±è®²ä¸€ä¸‹å¤§æ¦‚ä¿®æ”¹çš„æ–¹æ³•ã€‚ç”¨åˆ°çš„å·¥å…·ä¸»è¦æ˜¯<code>xxd</code>è½¬æˆhexæ ¼å¼è¿›è¡Œç¼–è¾‘ï¼Œå®Œæˆä¹‹åå†<code>xxd -r</code>è½¬å›å»ã€‚</p>
<ol>
<li>ä½ éœ€è¦ä¿®æ”¹Primeã€Aã€Bã€Generator4ä¸ªç›®æ ‡å­—æ®µçš„å€¼<ol>
<li>å…¶ä¸­Primeä¸º697ï¼Œå³åå…­è¿›åˆ¶çš„02b9</li>
<li>Aä¸º23ï¼Œå³ åå…­è¿›åˆ¶çš„17</li>
<li>Bä¸º0</li>
<li>Generatorçš„xä¸º8ï¼Œåˆå› ä¸ºæ˜¯å‹ç¼©æ ¼å¼ï¼Œå°†å…¶æ”¹æˆåå…­è¿›åˆ¶çš„020008ï¼ˆæˆ–030008ï¼‰</li>
</ol>
</li>
<li>å› ä¸ºASN1æ˜¯åµŒå¥—çš„ç»“æ„ï¼Œæ‰€ä»¥ä¿®æ”¹äº†å†…å±‚é•¿åº¦ä¹‹åï¼Œä½ è¿˜éœ€è¦æŠŠå¤–å±‚çš„æ‰€ä»¥é•¿åº¦éƒ½è¿›è¡Œç›¸åº”çš„ä¿®æ­£ï¼Œè¿™æ˜¯ä¸ªä½“åŠ›æ´»ã€‚</li>
<li>å¦å¤–OpenSSLä»£ç ä¸­ä¼šå¯¹ASN1_INTEGERè¿›è¡Œpaddingæ ¼å¼çš„æ£€æŸ¥ï¼Œæ‰€ä»¥Primeå€¼çš„å‰é¢ä¸èƒ½å¤šä½™çš„0å­—èŠ‚ï¼Œæ‰€ä»¥æˆ‘ä»¬å¿…é¡»ä¿®æ”¹Primeçš„é•¿åº¦</li>
<li>è€Œä¸”OpenSSLè¿˜ä¼šå¯¹æ£€æŸ¥ç‚¹å­—ç¬¦ä¸²é•¿åº¦ä¸Primeçš„é•¿åº¦çš„å…³ç³»ï¼ˆå¯¹äºå‹ç¼©æ ¼å¼ï¼Œç‚¹å­—ç¬¦ä¸²çš„é•¿åº¦éœ€è¦æ¯”Primeé•¿åº¦å¤š1ï¼‰ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬å°†Genratorè®¾ç½®æˆ030008ï¼Œè€Œä¸æ˜¯0308çš„åŸå› </li>
<li>è¿˜æœ‰æ³¨æ„ä¸€ç‚¹ï¼Œå°±æ˜¯<code>xxd -r</code>è½¬å›å»ä¹‹åå¯èƒ½ä¼šåœ¨æ–‡ä»¶æœ«å°¾æ·»åŠ ä¸€ä¸ª0aæ¢è¡Œï¼Œä½ éœ€è¦å°†å…¶å‰”é™¤ã€‚æ–¹æ³•æœ‰å¾ˆå¤šï¼Œå…¶ä¸­ä¸€ç§å°±æ˜¯ä½¿ç”¨splitå‘½ä»¤ã€‚</li>
</ol>
<p>æˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹è¯ä¹¦çš„ASN1ç»“æ„ï¼Œåˆ’çº¢çº¿çš„éƒ¨åˆ†éƒ½æ˜¯æˆ‘ä»¬éœ€è¦ä¿®æ”¹çš„éƒ¨åˆ†</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ openssl asn1parse -<span class="keyword">in</span> cert.der -inform DER -i</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/catbro666/catbro666.github.io/posts/83951100/asn1-structure-of-x509-before.png" alt="asn1-structure-of-x509-before" loading="lazy"></p>
<p>Primeã€Aã€Bã€Generatorçš„ç›®æ ‡å€¼ä¸Šé¢å·²ç»è¯´äº†ï¼Œç›¸å…³é•¿åº¦çš„ä¿®æ”¹å‰åçš„å€¼å·²ç»åˆ—åœ¨ä¸‹è¡¨ä¸­äº†ï¼š</p>
<table>
<thead>
<tr>
<th align="center">from(dec)</th>
<th align="center">from(hex)</th>
<th align="center">to(dec)</th>
<th align="center">to(hex)</th>
</tr>
</thead>
<tbody><tr>
<td align="center">549</td>
<td align="center">225</td>
<td align="center">488</td>
<td align="center">1e8</td>
</tr>
<tr>
<td align="center">460</td>
<td align="center">1cc</td>
<td align="center">399</td>
<td align="center">18f</td>
</tr>
<tr>
<td align="center">266</td>
<td align="center">10a</td>
<td align="center">205</td>
<td align="center">cd</td>
</tr>
<tr>
<td align="center">227</td>
<td align="center">e3</td>
<td align="center">166</td>
<td align="center">a6</td>
</tr>
<tr>
<td align="center">215</td>
<td align="center">d7</td>
<td align="center">154</td>
<td align="center">9a</td>
</tr>
<tr>
<td align="center">44</td>
<td align="center">2c</td>
<td align="center">13</td>
<td align="center">0d</td>
</tr>
<tr>
<td align="center">33 Prime</td>
<td align="center">21</td>
<td align="center">2</td>
<td align="center">02</td>
</tr>
<tr>
<td align="center">33 Generator</td>
<td align="center">21</td>
<td align="center">3</td>
<td align="center">03</td>
</tr>
</tbody></table>
<p>å…·ä½“çš„ä¿®æ”¹è¿‡ç¨‹å¦‚ä¸‹ï¼Œå…¶ä¸­ç¼–è¾‘æ–‡æœ¬çš„æ­¥éª¤å·²çœç•¥ï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cp cert.der cert.der.old</span><br><span class="line">$ xxd cert.der cert.der.hex</span><br><span class="line">$ cp cert.der.hex cert.der.hex.old</span><br><span class="line">$ vim cert.der.hex</span><br><span class="line"><span class="comment"># edit cert.der.hex</span></span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line"><span class="comment"># complete</span></span><br><span class="line">$ xxd -r cert.der.hex cert.der.new</span><br></pre></td></tr></table></figure>



<p>åˆ°è¿™é‡Œæˆ‘ä»¬çš„è¯ä¹¦å°±æ„é€ å¥½äº†ï¼Œç°åœ¨æ¥çœ‹çœ‹ä¿®æ”¹åçš„ASN1ç»“æ„ï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ openssl asn1parse -<span class="keyword">in</span> cert.der.new -inform DER -i</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/catbro666/catbro666.github.io/posts/83951100/asn1-structure-of-x509-after.png" alt="asn1-structure-of-x509-after" loading="lazy"></p>
<p>åˆ’çº¢çº¿çš„éƒ¨åˆ†éƒ½å·²ç»è¢«æˆ‘ä»¬ä¿®æ”¹äº†ï¼Œä¸”è¯ä¹¦çš„ASN1ç¼–ç æ˜¯æ­£å¸¸çš„ã€‚</p>
<h2 id="ä½¿ç”¨éæ³•è¯ä¹¦æµ‹è¯•"><a href="#ä½¿ç”¨éæ³•è¯ä¹¦æµ‹è¯•" class="headerlink" title="ä½¿ç”¨éæ³•è¯ä¹¦æµ‹è¯•"></a>ä½¿ç”¨éæ³•è¯ä¹¦æµ‹è¯•</h2><p>OKï¼Œç°åœ¨æˆ‘ä»¬æ¥è§£æè¿™ä¸ªæ„é€ çš„éæ³•è¯ä¹¦è¯•è¯•ï¼Œä¸å‡ºæ„å¤–çš„è¯å°±ä¼šè¿›å…¥æ— é™å¾ªç¯äº†ã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">openssl x509 -<span class="keyword">in</span> cert.der.new -inform DER -text -noout</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/catbro666/catbro666.github.io/posts/83951100/infinite-loop-when-parsing-invalid-cert.png" alt="infinite-loop-when-parsing-invalid-cert" loading="lazy"></p>
<p>å¯ä»¥çœ‹åˆ°opensslè¿›ç¨‹çš„CPUå ç”¨æ˜¯100%ï¼Œä¸”è°ƒç”¨æ ˆæ˜¯åœ¨<code>BN_mod_sqrt()</code>å‡½æ•°ä¹‹ä¸­ã€‚</p>
<p>å¦‚æœæ¶æ„æ”»å‡»æ–¹åœ¨ä¸æœåŠ¡å™¨è¿›è¡ŒSSLæ¡æ‰‹æ—¶ä½¿ç”¨ç±»ä¼¼è¿™ç§ç²¾å¿ƒæ„é€ çš„è¯ä¹¦çš„è¯ï¼ŒæœåŠ¡å™¨å°±ä¼šè¿›å…¥æ­»å¾ªç¯ï¼Œä»è€Œé€ æˆDoSæ”»å‡»ã€‚</p>
<p>æ„é€ çš„è¯ä¹¦ä»¥åŠä¸­é—´è¿‡ç¨‹äº§ç‰©å·²ç»ä¸Šä¼ Github[^3]ä»“åº“ï¼Œæœ‰éœ€è¦çš„å¯ä»¥è‡ªè¡Œè·å–ã€‚</p>
<h1 id="å‚è€ƒææ–™"><a href="#å‚è€ƒææ–™" class="headerlink" title="å‚è€ƒææ–™"></a>å‚è€ƒææ–™</h1><p>[^1]: <a href="https://www.cve.org/CVERecord?id=CVE-2022-0778">CVE-2022-0778 Detail</a><br>[^2]: <a href="https://github.com/openssl/openssl/commit/3118eb64934499d93db3230748a452351d1d9a65">Patch commit</a><br>[^3]: <a href="https://github.com/catbro666/CVE-2022-0778">catbro666&#x2F;CVE-2022-0778</a></p>
]]></content>
      <categories>
        <category>åŠ å¯†ä¸å®‰å…¨</category>
        <category>OpenSSL</category>
      </categories>
      <tags>
        <tag>OpenSSL</tag>
        <tag>CVE</tag>
        <tag>æ¼æ´å¤ç°</tag>
      </tags>
  </entry>
  <entry>
    <title>UNIXç¯å¢ƒé«˜çº§ç¼–ç¨‹APUEç»ƒä¹ 3.2-ä¸ç”¨fcntlå®ç°dup2çš„åŠŸèƒ½</title>
    <url>/posts/2485f370/</url>
    <content><![CDATA[<h2 id="é¢˜é¢"><a href="#é¢˜é¢" class="headerlink" title="é¢˜é¢"></a>é¢˜é¢</h2><p>ç¼–å†™ä¸<code>dup2</code>åŠŸèƒ½ç›¸åŒçš„å‡½æ•°ï¼Œè¦æ±‚ä¸è°ƒç”¨<code>fcntl</code>å‡½æ•°ï¼Œå¹¶ä¸”è¦æœ‰æ­£ç¡®çš„å‡ºé”™å¤„ç†ã€‚</p>
<h2 id="åŸºæœ¬æ€è·¯"><a href="#åŸºæœ¬æ€è·¯" class="headerlink" title="åŸºæœ¬æ€è·¯"></a>åŸºæœ¬æ€è·¯</h2><p>ä¸èƒ½ç”¨<code>fcntl</code>ï¼Œèƒ½å¤Ÿè¿”å›ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦çš„åªæœ‰<code>open</code>å’Œ<code>dup</code>ã€‚è€Œ<code>open</code>ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„æ–‡ä»¶è¡¨é¡¹ï¼Œè¿”å›çš„fdæŒ‡å‘æ–°çš„æ–‡ä»¶è¡¨é¡¹ï¼Œä¸<code>dup2</code>çš„è¡¨ç°ä¸ç¬¦ã€‚<code>dup</code>åŸºæœ¬èƒ½æ»¡è¶³è¦æ±‚ï¼Œä½†æ˜¯è¿”å›çš„æ˜¯æœ€å°çš„å¯ç”¨fdï¼Œéœ€è¦è¿›ä¸€æ­¥æ“ä½œæ»¡è¶³è¦æ±‚ã€‚å¦å¤–éœ€è¦è‡ªå·±æ·»åŠ é”™è¯¯å¤„ç†ï¼Œä»¥åŠå¤„ç†oldfdä¸newfdç›¸ç­‰çš„æƒ…å†µç­‰ã€‚å…·ä½“åœ°ï¼Œ</p>
<span id="more"></span>

<ol>
<li>å½“dupè¿”å›å‡ºé”™æ—¶ï¼Œç›´æ¥è¿”å›å‡ºé”™</li>
<li>å½“dupè¿”å›å€¼ç­‰äºnewfdæ—¶ï¼Œç›´æ¥è¿”å›</li>
<li>å½“dupè¿”å›å€¼å°äºnewfdæ—¶ï¼Œè®°å½•è¿”å›å€¼ï¼Œå¾ªç¯è°ƒç”¨dupç›´åˆ°è¿”å›å€¼ç­‰äºnewfdã€‚å…³é—­å‰é¢è®°å½•çš„æ‰€æœ‰fdï¼Œè¿”å›newfd</li>
<li>å½“dupè¿”å›å€¼å¤§äºnewfdæ—¶ï¼Œå…³é—­è¿”å›å€¼çš„fdã€‚å¦‚æœoldfdç­‰äºnewfdï¼Œç›´æ¥è¿”å›newfd;å¦‚æœä¸ç›¸ç­‰ï¼Œå…³æ‰newfdï¼Œç„¶åå†dupï¼ˆå› ä¸ºä¸æ˜¯åŸå­çš„ï¼Œè¿”å›å€¼éœ€è¦å†åˆ¤æ–­ï¼‰</li>
</ol>
<h2 id="å‡ºé”™å¤„ç†"><a href="#å‡ºé”™å¤„ç†" class="headerlink" title="å‡ºé”™å¤„ç†"></a>å‡ºé”™å¤„ç†</h2><ol>
<li>oldfdçš„å‡ºé”™å¤„ç†å¯ä»¥ç›´æ¥äº¤ç»™dup</li>
<li>newfdçš„å‡ºé”™å¤„ç†ï¼Œéœ€è¦åˆ¤æ–­æ˜¯å¦è¶…å‡ºæ–‡ä»¶æè¿°ç¬¦èŒƒå›´(<code>RLIMIT_NOFILE</code> in getrlimit)</li>
<li>å¯¹äºdupè¿”å›EMFILEçš„æƒ…å†µï¼Œnewfdå¦‚æœæ²¡è¶…è¿‡è¿›ç¨‹å¯æ‰“å¼€çš„æœ€å¤§æ–‡ä»¶æ•°ï¼Œåˆ™ä¸å½±å“</li>
<li>å¦å¤–è¿˜æœ‰ä¸€ä¸ªåˆ¤æ–­é¡ºåºé—®é¢˜ï¼Œæ˜¯å…ˆåˆ¤æ–­å‚æ•°æ˜¯å¦åˆæ³•è¿˜æ˜¯oldfd&#x3D;&#x3D;newfd, è¿™ä¸ªå¯ä»¥æ ¹æ®dup2å‡½æ•°å®æµ‹æ¥ç¡®å®š</li>
</ol>
<h2 id="4-æµ‹è¯•ç”¨ä¾‹"><a href="#4-æµ‹è¯•ç”¨ä¾‹" class="headerlink" title="4 æµ‹è¯•ç”¨ä¾‹"></a>4 æµ‹è¯•ç”¨ä¾‹</h2><h3 id="è¿›ç¨‹æ‰“å¼€çš„æ–‡ä»¶æ•°æ²¡æ»¡çš„æƒ…å†µä¸‹"><a href="#è¿›ç¨‹æ‰“å¼€çš„æ–‡ä»¶æ•°æ²¡æ»¡çš„æƒ…å†µä¸‹" class="headerlink" title="è¿›ç¨‹æ‰“å¼€çš„æ–‡ä»¶æ•°æ²¡æ»¡çš„æƒ…å†µä¸‹"></a>è¿›ç¨‹æ‰“å¼€çš„æ–‡ä»¶æ•°æ²¡æ»¡çš„æƒ…å†µä¸‹</h3><ol>
<li>éƒ½è¶…å‡ºèŒƒå›´ï¼Œç›¸åŒï¼ˆMAX+1ï¼ŒMAX+1ï¼‰</li>
<li>æœªæ‰“å¼€æè¿°ç¬¦ï¼Œç›¸åŒ (100, 100)</li>
<li>newfdè¶…å‡ºèŒƒå›´ (1, MAX+1)</li>
<li>newfdæ­£å¥½æ²¡è¶…å‡º (1, MAX)</li>
<li>oldfdå’Œnewfdç›¸åŒ (2, 2)</li>
</ol>
<h3 id="è¿›ç¨‹æ‰“å¼€çš„æ–‡ä»¶æ•°æ»¡çš„æƒ…å†µä¸‹"><a href="#è¿›ç¨‹æ‰“å¼€çš„æ–‡ä»¶æ•°æ»¡çš„æƒ…å†µä¸‹" class="headerlink" title="è¿›ç¨‹æ‰“å¼€çš„æ–‡ä»¶æ•°æ»¡çš„æƒ…å†µä¸‹"></a>è¿›ç¨‹æ‰“å¼€çš„æ–‡ä»¶æ•°æ»¡çš„æƒ…å†µä¸‹</h3><ol>
<li>newfdæ­£å¥½è¶…å‡ºèŒƒå›´ (1, MAX+1)</li>
<li>newfdæ­£å¥½æ²¡è¶…å‡º (1, MAX)</li>
<li>oldfdå’Œnewfdç›¸åŒ (2, 2)</li>
</ol>
<h2 id="5-å¼€å§‹æ’¸ç å®æµ‹"><a href="#5-å¼€å§‹æ’¸ç å®æµ‹" class="headerlink" title="5 å¼€å§‹æ’¸ç å®æµ‹"></a>5 å¼€å§‹æ’¸ç å®æµ‹</h2><h3 id="5-1-å…ˆéªŒè¯dup2çš„åˆ¤æ–­é¡ºåºé—®é¢˜"><a href="#5-1-å…ˆéªŒè¯dup2çš„åˆ¤æ–­é¡ºåºé—®é¢˜" class="headerlink" title="5.1 å…ˆéªŒè¯dup2çš„åˆ¤æ–­é¡ºåºé—®é¢˜"></a>5.1 å…ˆéªŒè¯dup2çš„åˆ¤æ–­é¡ºåºé—®é¢˜</h3><ul>
<li>æµ‹è¯•æºç </li>
</ul>
<div><div class="fold_hider"><div class="close hider_title">ç‚¹å‡»å±•å¼€ä»£ç </div></div><div class="fold">
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/resource.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> r;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rlimit</span> <span class="title">old_rlim</span>=</span>&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    getrlimit(RLIMIT_NOFILE, &amp;old_rlim);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;NOFILE limits: soft=%lld; hard=%lld\n&quot;</span>,</span><br><span class="line">                   (<span class="keyword">long</span> <span class="keyword">long</span>) old_rlim.rlim_cur, (<span class="keyword">long</span> <span class="keyword">long</span>) old_rlim.rlim_max);</span><br><span class="line"></span><br><span class="line">    r = dup2(<span class="number">10000</span>, <span class="number">10000</span>);</span><br><span class="line">    <span class="keyword">if</span>(r == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;dup2(10000, 10000) fail: &quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;dup2(10000, 10000) success return %d\n&quot;</span>, r);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    r = dup2(<span class="number">100</span>, <span class="number">100</span>);</span><br><span class="line">    <span class="keyword">if</span>(r == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;dup2(100, 100) fail: &quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;dup2(100, 100) success return %d\n&quot;</span>, r);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    r = dup2(<span class="number">1</span>, <span class="number">10000</span>);</span><br><span class="line">    <span class="keyword">if</span>(r == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;dup2(1, 10000) fail: &quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;dup2(1, 10000) success return %d\n&quot;</span>, r);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    r = dup2(<span class="number">1</span>, <span class="number">100</span>);</span><br><span class="line">    <span class="keyword">if</span>(r == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;dup2(1, 100) fail: &quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;dup2(1, 100) success return %d\n&quot;</span>, r);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</div></div>

<ul>
<li>MAC OSXä¸‹è¿è¡Œç»“æœ</li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">^_^$ ./a.out</span><br><span class="line">NOFILE limits: soft=7168; hard=9223372036854775807</span><br><span class="line">dup2(10000, 10000) fail: : Bad file descriptor</span><br><span class="line">dup2(100, 100) fail: : Bad file descriptor</span><br><span class="line">dup2(1, 10000) fail: : Bad file descriptor</span><br><span class="line">dup2(1, 100) success return 100</span><br></pre></td></tr></table></figure>

<p>å¯è§æ˜¯å‚æ•°å‡ºé”™åˆ¤æ–­æ˜¯å…ˆäºoldfd &#x3D;&#x3D; newfdåˆ¤æ–­çš„</p>
<h3 id="5-2-æµ‹è¯•è¿›ç¨‹æ‰“å¼€çš„æœ€å¤§æ–‡ä»¶æ•°åˆ°ä¸Šé™æ—¶ï¼Œdup2æ˜¯å¦èƒ½æˆåŠŸ"><a href="#5-2-æµ‹è¯•è¿›ç¨‹æ‰“å¼€çš„æœ€å¤§æ–‡ä»¶æ•°åˆ°ä¸Šé™æ—¶ï¼Œdup2æ˜¯å¦èƒ½æˆåŠŸ" class="headerlink" title="5.2 æµ‹è¯•è¿›ç¨‹æ‰“å¼€çš„æœ€å¤§æ–‡ä»¶æ•°åˆ°ä¸Šé™æ—¶ï¼Œdup2æ˜¯å¦èƒ½æˆåŠŸ"></a>5.2 æµ‹è¯•è¿›ç¨‹æ‰“å¼€çš„æœ€å¤§æ–‡ä»¶æ•°åˆ°ä¸Šé™æ—¶ï¼Œdup2æ˜¯å¦èƒ½æˆåŠŸ</h3><ul>
<li>æµ‹è¯•æºç </li>
</ul>
<div><div class="fold_hider"><div class="close hider_title">ç‚¹å‡»å±•å¼€ä»£ç </div></div><div class="fold">
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/resource.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> r;</span><br><span class="line">    <span class="keyword">int</span> max_fd = <span class="number">0</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rlimit</span> <span class="title">old_rlim</span>=</span>&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    getrlimit(RLIMIT_NOFILE, &amp;old_rlim);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;NOFILE limits: soft=%lld; hard=%lld\n&quot;</span>,</span><br><span class="line">                   (<span class="keyword">long</span> <span class="keyword">long</span>) old_rlim.rlim_cur, (<span class="keyword">long</span> <span class="keyword">long</span>) old_rlim.rlim_max);</span><br><span class="line">    <span class="keyword">while</span>((r = dup(<span class="number">0</span>))!= <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        max_fd = r;</span><br><span class="line">    &#125;</span><br><span class="line">    perror(<span class="literal">NULL</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;max fd is %d\n&quot;</span>, max_fd);</span><br><span class="line"></span><br><span class="line">    r = dup2(<span class="number">1</span>, <span class="number">10000</span>);</span><br><span class="line">    <span class="keyword">if</span>(r == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;dup2(1, 10000) fail: &quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;dup2(1, 10000) success return %d\n&quot;</span>, r);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    r = dup2(<span class="number">1</span>, <span class="number">100</span>);</span><br><span class="line">    <span class="keyword">if</span>(r == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;dup2(1, 100) fail: &quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;dup2(1, 100) success return %d\n&quot;</span>, r);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</div></div>

<ul>
<li>MAC OSXä¸‹è¿è¡Œç»“æœ</li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">^_^$ ./a.out</span><br><span class="line">NOFILE limits: soft=7168; hard=9223372036854775807</span><br><span class="line">Too many open files</span><br><span class="line">max fd is 7167</span><br><span class="line">dup2(1, 7168) fail: : Bad file descriptor</span><br><span class="line">dup2(1, 7167) success return 7167</span><br></pre></td></tr></table></figure>

<p>å¯è§åœ¨è¿›ç¨‹æ‰“å¼€æ–‡ä»¶æ•°è¾¾åˆ°ä¸Šé™æ—¶ï¼Œdup2æ›¿æ¢å·²ç»æ‰“å¼€çš„æ–‡ä»¶æ˜¯å¯ä»¥çš„</p>
<h3 id="5-3-å®ç°dup2çš„åŠŸèƒ½"><a href="#5-3-å®ç°dup2çš„åŠŸèƒ½" class="headerlink" title="5.3 å®ç°dup2çš„åŠŸèƒ½"></a>5.3 å®ç°dup2çš„åŠŸèƒ½</h3><ul>
<li>æºç </li>
</ul>
<div><div class="fold_hider"><div class="close hider_title">ç‚¹å‡»å±•å¼€ä»£ç </div></div><div class="fold">
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/resource.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/errno.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*dupå®ç°dup2çš„åŠŸèƒ½*/</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">dup2_</span><span class="params">(<span class="keyword">int</span> oldfd, <span class="keyword">int</span> newfd)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line">    <span class="keyword">int</span> <span class="built_in">stack</span>[<span class="number">7168</span>];</span><br><span class="line">    <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rlimit</span> <span class="title">old_rlim</span>=</span>&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    getrlimit(RLIMIT_NOFILE, &amp;old_rlim);</span><br><span class="line">    <span class="keyword">if</span> (newfd &lt; <span class="number">0</span> || newfd &gt; old_rlim.rlim_cur - <span class="number">1</span>) &#123;</span><br><span class="line">        errno = EBADF;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">        ret = dup(oldfd);</span><br><span class="line">        <span class="keyword">if</span>(ret == <span class="number">-1</span> &amp;&amp; errno != EMFILE) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(ret == <span class="number">-1</span> &amp;&amp; errno == EMFILE) &#123;</span><br><span class="line">            <span class="keyword">if</span>(oldfd == newfd) &#123;</span><br><span class="line">                <span class="keyword">return</span> newfd;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;close(newfd)\n&quot;</span>);</span><br><span class="line">            close(newfd);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span>(oldfd == newfd) &#123;</span><br><span class="line">                close(ret);</span><br><span class="line">                <span class="keyword">return</span> newfd;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(ret == newfd) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(ret &lt; newfd) &#123;</span><br><span class="line">                <span class="built_in">stack</span>[count++] = ret;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                close(ret);</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;close(newfd)\n&quot;</span>);</span><br><span class="line">                close(newfd);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span>(count) &#123;</span><br><span class="line">        close(<span class="built_in">stack</span>[--count]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> r, max_fd;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rlimit</span> <span class="title">old_rlim</span>=</span>&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    getrlimit(RLIMIT_NOFILE, &amp;old_rlim);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;NOFILE limits: soft=%lld; hard=%lld\n&quot;</span>,</span><br><span class="line">                   (<span class="keyword">long</span> <span class="keyword">long</span>) old_rlim.rlim_cur, (<span class="keyword">long</span> <span class="keyword">long</span>) old_rlim.rlim_max);</span><br><span class="line"></span><br><span class="line">    r = dup2_(<span class="number">7168</span>, <span class="number">7168</span>);</span><br><span class="line">    <span class="keyword">if</span>(r == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;dup2_(7168, 7168) fail: &quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;dup2_(7168, 7168) success return %d\n&quot;</span>, r);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    r = dup2_(<span class="number">100</span>, <span class="number">100</span>);</span><br><span class="line">    <span class="keyword">if</span>(r == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;dup2_(100, 100) fail: &quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;dup2_(100, 100) success return %d\n&quot;</span>, r);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    r = dup2_(<span class="number">1</span>, <span class="number">7168</span>);</span><br><span class="line">    <span class="keyword">if</span>(r == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;dup2_(1, 7168) fail: &quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;dup2_(1, 7168) success return %d\n&quot;</span>, r);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    r = dup2_(<span class="number">1</span>, <span class="number">7167</span>);</span><br><span class="line">    <span class="keyword">if</span>(r == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;dup2_(1, 7167) fail: &quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;dup2_(1, 7167) success return %d\n&quot;</span>, r);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    r = dup2_(<span class="number">2</span>, <span class="number">2</span>);</span><br><span class="line">    <span class="keyword">if</span>(r == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;dup2_(2, 2) fail: &quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;dup2_(2, 2) success return %d\n&quot;</span>, r);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span>((r = dup(<span class="number">0</span>))!= <span class="number">-1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        max_fd = r;</span><br><span class="line">    &#125;</span><br><span class="line">    perror(<span class="literal">NULL</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;max fd is %d\n&quot;</span>, max_fd);</span><br><span class="line"></span><br><span class="line">    r = dup2_(<span class="number">1</span>, <span class="number">7168</span>);</span><br><span class="line">    <span class="keyword">if</span>(r == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;dup2_(1, 7168) fail: &quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;dup2_(1, 7168) success return %d\n&quot;</span>, r);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    r = dup2_(<span class="number">1</span>, <span class="number">7167</span>);</span><br><span class="line">    <span class="keyword">if</span>(r == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;dup2_(1, 7167) fail: &quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;dup2_(1, 7167) success return %d\n&quot;</span>, r);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    r = dup2_(<span class="number">2</span>, <span class="number">2</span>);</span><br><span class="line">    <span class="keyword">if</span>(r == <span class="number">-1</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;dup2_(2, 2) fail: &quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;dup2_(2, 2) success return %d\n&quot;</span>, r);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</div></div>

<ul>
<li>MAC OSXä¸‹çš„è¿è¡Œç»“æœ</li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">NOFILE limits: soft=7168; hard=9223372036854775807</span><br><span class="line">dup2_(7168, 7168) fail: : Bad file descriptor</span><br><span class="line">dup2_(100, 100) fail: : Bad file descriptor</span><br><span class="line">dup2_(1, 7168) fail: : Bad file descriptor</span><br><span class="line">dup2_(1, 7167) success return 7167</span><br><span class="line">dup2_(2, 2) success return 2</span><br><span class="line">Too many open files</span><br><span class="line">max fd is 7167</span><br><span class="line">dup2_(1, 7168) fail: : Bad file descriptor</span><br><span class="line">close(newfd)</span><br><span class="line">dup2_(1, 7167) success return 7167</span><br><span class="line">close(newfd)</span><br><span class="line">dup2_(1, 100) success return 100</span><br><span class="line">dup2_(2, 2) success return 2</span><br></pre></td></tr></table></figure>

<p>ç»“æœéƒ½ç¬¦åˆé¢„æœŸ</p>
]]></content>
      <categories>
        <category>ç¼–ç¨‹å¼€å‘</category>
        <category>Unixç¯å¢ƒç¼–ç¨‹</category>
      </categories>
      <tags>
        <tag>Unix</tag>
        <tag>dup2</tag>
      </tags>
  </entry>
  <entry>
    <title>Hello World</title>
    <url>/posts/4a17b156/</url>
    <content><![CDATA[<p>Welcome to <a href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p>
<span id="more"></span>

<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo new <span class="string">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/writing.html">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/server.html">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/generating.html">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>

<p>More info: <a href="https://hexo.io/docs/deployment.html">Deployment</a></p>
]]></content>
  </entry>
  <entry>
    <title>Cè¯­è¨€ä¸­çš„å‡½æ•°è°ƒç”¨çº¦å®š</title>
    <url>/posts/657c24ad/</url>
    <content><![CDATA[<div class="note primary">
            <p>æœ¬æ–‡ä¸»è¦ä»‹ç»Cè¯­è¨€ä¸­çš„å‡½æ•°è°ƒç”¨çº¦å®šï¼Œé€šè¿‡æ±‡ç¼–ä»£ç ç»“åˆå®æ—¶è§‚å¯Ÿæ ˆçš„å˜åŒ–æƒ…å†µï¼Œç›´è§‚åœ°äº†è§£å‡½æ•°è°ƒç”¨çš„è¿‡ç¨‹ã€‚æœ¬æ–‡åªè®¨è®ºx86&#x2F;64æ¶æ„ã€Linux&#x2F;GCCç¯å¢ƒä¸‹çš„æƒ…å†µï¼Œä¸è¿‡å…¶ä»–ç¯å¢ƒåœ¨æ•´ä½“æ€æƒ³ä¸Šåº”è¯¥æ˜¯ç±»ä¼¼çš„ï¼Œéƒ½éœ€è¦å¤„ç†è¿™äº›é—®é¢˜ã€‚</p>
          </div>

<span id="more"></span>

<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>ä»€ä¹ˆæ˜¯è°ƒç”¨çº¦å®šï¼ˆCalling Conventionï¼‰ï¼Ÿ</p>
<p>å®ƒä¸»è¦æ˜¯ä¸ºäº†æ–¹ä¾¿ä»£ç çš„å…±äº«ä»¥åŠç®€åŒ–å­å‡½æ•°çš„ä½¿ç”¨æ–¹å¼ã€‚å‚æ•°å’Œè¿”å›å€¼å¦‚ä½•è¿›è¡Œä¼ é€’ã€æ ˆå¸§å¦‚ä½•å»ºç«‹å’Œé”€æ¯ã€è°ƒç”¨è€…å’Œè¢«è°ƒè€…åˆ†åˆ«è´Ÿè´£å“ªäº›äº‹æƒ…ï¼Ÿè°ƒç”¨çº¦å®šå¯¹è¿™äº›éƒ½ä½œå‡ºäº†è§„å®šï¼Œå‡½æ•°çš„å®šä¹‰è€…å’Œè°ƒç”¨è€…åªè¦éƒ½éµå¾ªè¿™ä¸ªçº¦å®šï¼Œé‚£ä¹ˆå°±å¯ä»¥æ— é”™åœ°è¿›è¡Œäº¤äº’ï¼›å¦åˆ™ï¼Œä¸ä¸€è‡´çš„çŠ¶æ€å¯èƒ½å¯¼è‡´ç¨‹åºçš„è‡´å‘½é”™è¯¯ã€‚</p>
<p>x86 Cç¼–è¯‘å™¨é»˜è®¤é€šå¸¸ä½¿ç”¨cdeclè°ƒç”¨çº¦å®šï¼Œè¿™ä¹Ÿæ˜¯Cè¯­è¨€äº‹å®ä¸Šçš„æ ‡å‡†ã€‚å½“ç„¶è¿˜æœ‰ä¸€äº›å…¶ä»–çš„è°ƒç”¨çº¦å®šï¼Œè¯»è€…å¯ä»¥é€šè¿‡æ–‡æœ«çš„å‚è€ƒèµ„æ–™è¿›è¡Œæ›´å¤šçš„äº†è§£ã€‚</p>
<h2 id="å…¸å‹çš„æ ˆå¸§ç»“æ„"><a href="#å…¸å‹çš„æ ˆå¸§ç»“æ„" class="headerlink" title="å…¸å‹çš„æ ˆå¸§ç»“æ„"></a>å…¸å‹çš„æ ˆå¸§ç»“æ„</h2><p><img src="https://cdn.jsdelivr.net/gh/catbro666/catbro666.github.io/posts/657c24ad/%E5%85%B8%E5%9E%8B%E7%9A%84%E6%A0%88%E5%B8%A7%E7%BB%93%E6%9E%84.jpeg" alt="å…¸å‹çš„æ ˆå¸§ç»“æ„" loading="lazy"></p>
<p>ä¸Šå›¾æ˜¯ä¸€ä¸ªå…¸å‹çš„è°ƒç”¨å­å‡½æ•°æœŸé—´çš„æ ˆå¸§ç»“æ„ã€‚æ ˆä»ä¸‹é¢é«˜åœ°å€å¾€ä¸Šç”Ÿé•¿ï¼Œæ¯åµŒå¥—ä¸€å±‚å‡½æ•°è°ƒç”¨ï¼Œå°±å¾€ä¸Šç”Ÿé•¿ä¸€ä¸ªæ ˆå¸§ã€‚å…¶ä¸­çš„è¿”å›åœ°å€å¯ä»¥çœ‹ä½œæ˜¯æ¯ä¸ªæ ˆå¸§çš„åˆ†ç•Œçº¿ï¼Œå®ƒä¸Šé¢çš„éƒ¨åˆ†å½’è¢«è°ƒè€…ç®¡ï¼Œå®ƒä¸‹é¢çš„éƒ¨åˆ†å½’è°ƒç”¨è€…ç®¡ã€‚</p>
<p>ESPå’ŒEBPåˆ†åˆ«æŒ‡ç¤ºå½“å‰æ ˆé¡¶ä½ç½®å’Œå½“å‰æ ˆå¸§çš„åŸºå€ã€‚é€šè¿‡EBPåŠ é€‚å½“çš„åç§»å¯ä»¥æ–¹ä¾¿åœ°è®¿é—®å‚æ•°ä»¥åŠå±€éƒ¨å˜é‡ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥å¿«é€Ÿåœ°è¿›è¡Œå…³å¸§çš„æ“ä½œã€‚</p>
<p>è°ƒç”¨çº¦å®šå¯ä»¥åˆ†æˆä¸¤ä¸ªéƒ¨åˆ†ï¼Œå³è§„å®šè°ƒç”¨è€…(caller)çš„éƒ¨åˆ†å’Œè§„å®šè¢«è°ƒè€…(callee)çš„éƒ¨åˆ†ã€‚ä¸‹é¢åˆ†åˆ«è¿›è¡Œä»‹ç»ã€‚</p>
<h2 id="è°ƒç”¨è€…è§„åˆ™"><a href="#è°ƒç”¨è€…è§„åˆ™" class="headerlink" title="è°ƒç”¨è€…è§„åˆ™"></a>è°ƒç”¨è€…è§„åˆ™</h2><p>åœ¨å‘èµ·ä¸€ä¸ªå­å‡½æ•°è°ƒç”¨æ—¶ï¼Œè°ƒç”¨è€…éœ€è¦ï¼š</p>
<ol>
<li>åœ¨è°ƒç”¨å­å‡½æ•°å‰ï¼Œé¦–å…ˆéœ€è¦ä¿å­˜æŸäº›å¯„å­˜å™¨çš„å€¼ã€‚è¿™äº›å¯„å­˜å™¨è®¾è®¡ä¸ºç”±è°ƒç”¨è€…ä¿å­˜ï¼Œæ‰€ä»¥è¢«è°ƒå‡½æ•°æ˜¯å…è®¸ä¿®æ”¹å®ƒä»¬çš„ã€‚å¦‚æœè°ƒç”¨è€…åœ¨å­å‡½æ•°è¿”å›åè¿˜ä¾èµ–è¿™äº›å¯„å­˜å™¨çš„å€¼ï¼Œå°±å¿…é¡»åœ¨è°ƒç”¨å­å‡½æ•°å‰å°†è¿™äº›å¯„å­˜å™¨çš„å€¼å‹æ ˆä¿å­˜ï¼Œåœ¨å­å‡½æ•°è¿”å›ä¹‹åå†å°†å…¶å‡ºæ ˆæ¢å¤ã€‚è°ƒç”¨è€…ä¿å­˜çš„å¯„å­˜å™¨æœ‰EAXã€ECXã€EDXã€‚</li>
<li>æ¥ç€ï¼Œè°ƒç”¨è€…éœ€è¦æŠŠè°ƒç”¨å­å‡½æ•°çš„å‚æ•°å‹æ ˆï¼Œå‹æ ˆé¡ºåºä¸ºä»å³å¾€å·¦ï¼Œæ‰€ä»¥ç¬¬ä¸€ä¸ªå‚æ•°åœ¨æ ˆçš„æœ€ä¸Šé¢ï¼ˆä½åœ°å€ï¼‰ã€‚</li>
<li>ä½¿ç”¨<code>call</code>æŒ‡ä»¤è°ƒç”¨å­å‡½æ•°ï¼Œè¿™ä¸ªæŒ‡ä»¤ä¼šå°†è¿”å›åœ°å€ï¼ˆä¹Ÿå³å½“å‰å‡½æ•°ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€ï¼‰å‹æ ˆï¼Œç„¶åè·³åˆ°å­å‡½æ•°å¤„å¼€å§‹æ‰§è¡Œã€‚</li>
</ol>
<p>è¢«è°ƒè€…è§„åˆ™æˆ‘ä»¬ç¨åå†çœ‹ï¼Œç°åœ¨å…ˆå‡è®¾å­å‡½æ•°å·²ç»è¿”å›ï¼Œæ‰€ä»¥æ­£å¸¸æƒ…å†µä¸‹æ ˆå·²ç»æ¢å¤åˆ°äº†è°ƒç”¨<code>call</code>æŒ‡ä»¤ä¹‹å‰çš„æƒ…å†µã€‚è°ƒç”¨è€…å¯ä»¥ä»EAXå¯„å­˜å™¨ä¸­è·å–å­å‡½æ•°çš„è¿”å›å€¼ã€‚è¦å®Œå…¨æ¢å¤å­å‡½æ•°è°ƒç”¨å‰çš„çŠ¶æ€ï¼Œè¿˜éœ€è¦ï¼š</p>
<ol>
<li>å°†æ ˆä¸Šçš„å‚æ•°ç§»å‡º</li>
<li>å°†ä¹‹å‰å‹æ ˆçš„è°ƒç”¨è€…ä¿å­˜çš„å¯„å­˜å™¨çš„å†…å®¹å‡ºæ ˆæ¢å¤ï¼ˆè·Ÿå…¥æ ˆæ—¶ç›¸åçš„é¡ºåºï¼‰ã€‚è°ƒç”¨è€…å¯ä»¥å‡è®¾å…¶ä»–å¯„å­˜å™¨æ²¡æœ‰è¢«å­å‡½æ•°ä¿®æ”¹ã€‚</li>
</ol>
<h2 id="è¢«è°ƒè€…è§„åˆ™"><a href="#è¢«è°ƒè€…è§„åˆ™" class="headerlink" title="è¢«è°ƒè€…è§„åˆ™"></a>è¢«è°ƒè€…è§„åˆ™</h2><p>å­å‡½æ•°åœ¨å¼€å¤´éœ€è¦ï¼š</p>
<ol>
<li>å°†EBPçš„å€¼å‹æ ˆï¼Œç„¶åå°†ESPçš„å€¼æ‹·è´åˆ°EBPä¸Šã€‚å¯ä»¥æŠŠè¿™ä¸ªå½“ä½œæ˜¯å¼€å¸§çš„æ“ä½œï¼Œé¦–å…ˆä¿å­˜ä¸Šä¸€ä¸ªæ ˆå¸§çš„åŸºå€ï¼Œç„¶åè®¾ç½®å½“å‰æ ˆå¸§çš„åŸºå€ï¼ˆå³å­å‡½æ•°åˆšå¼€å§‹æ‰§è¡Œæ—¶çš„æ ˆæŒ‡é’ˆçš„å€¼ï¼‰ï¼Œå‚æ•°å’Œå±€éƒ¨å˜é‡è·ŸEBPæœ‰ç€å›ºå®šçš„åç§»ï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡EBPè®¿é—®åˆ°ã€‚</li>
<li>æ¥ä¸‹æ¥ï¼Œåˆ†é…å±€éƒ¨å˜é‡çš„æ ˆç©ºé—´ï¼Œè¿™ä¸ªå¯ä»¥é€šè¿‡å‡å°ESPçš„å€¼æ¥å®ç°ã€‚</li>
<li>ç„¶åéœ€è¦å°†è¢«è°ƒè€…ä¿å­˜çš„å¯„å­˜å™¨çš„å€¼å…¥æ ˆï¼ˆå¦‚æœå­å‡½æ•°ä¸­ç”¨åˆ°äº†å®ƒä»¬çš„è¯ï¼‰ã€‚è¢«è°ƒè€…ä¿å­˜çš„å¯„å­˜å™¨åŒ…æ‹¬EBXã€EDIå’ŒESIã€‚</li>
</ol>
<p>æ‰§è¡Œå®Œè¿™3æ­¥æ“ä½œä¹‹åï¼Œå°±å¼€å§‹æ‰§è¡Œå®é™…çš„å‡½æ•°ä½“äº†ã€‚å½“å‡½æ•°ä½“æ‰§è¡Œç»“æŸå³å°†è¿”å›çš„æ—¶å€™ï¼Œå®ƒéœ€è¦ï¼š</p>
<ol>
<li>å°†è¿”å›å€¼æ”¾åœ¨EAXä¸­</li>
<li>å°†è¢«è°ƒè€…ä¿å­˜çš„å¯„å­˜å™¨çš„å€¼å…¥æ ˆï¼ˆè·Ÿå…¥æ ˆæ—¶ç›¸åçš„é¡ºåºï¼‰</li>
<li>é‡Šæ”¾å±€éƒ¨å˜é‡çš„æ ˆç©ºé—´ï¼Œè¿™ä¸ªå¯ä»¥é€šè¿‡å¢å¤§ESPçš„å€¼æ¥å®ç°ï¼Œæ›´å¥½çš„æ–¹æ³•æ˜¯å°†EBPçš„å€¼æ¢å¤åˆ°ESPã€‚</li>
<li>ç„¶åæ¢å¤ä¸Šä¸€ä¸ªæ ˆå¸§çš„EBPï¼Œå°†å…¶å‡ºæ ˆ</li>
<li>æœ€åï¼Œæ‰§è¡Œ<code>ret</code>æŒ‡ä»¤è¿”å›ã€‚è¯¥æŒ‡ä»¤ä¼šå°†ä¹‹å‰å…¥æ ˆçš„è¿”å›åœ°å€å‡ºæ ˆï¼Œç„¶åè·³è½¬åˆ°è¿™ä¸ªè¿”å›åœ°å€å¤„ç»§ç»­æ‰§è¡Œã€‚</li>
</ol>
<h2 id="Cè¯­è¨€å®ä¾‹"><a href="#Cè¯­è¨€å®ä¾‹" class="headerlink" title="Cè¯­è¨€å®ä¾‹"></a>Cè¯­è¨€å®ä¾‹</h2><p>å…‰è¯´ä¸ç»ƒå‡æŠŠå¼ï¼Œæˆ‘ä»¬é€šè¿‡å¦‚ä¸‹ä¸€ä¸ªç®€å•çš„ä¾‹å­æ¥å®é™…çœ‹ä¸€ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">foo</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> fa = <span class="number">0x10</span>;</span><br><span class="line">    <span class="keyword">int</span> fb = <span class="number">0x20</span>;</span><br><span class="line">    fa = a;</span><br><span class="line">    fb = b;</span><br><span class="line">    <span class="keyword">return</span> fa + fb;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ret = <span class="number">0</span>;</span><br><span class="line">    ret = foo(<span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å°†å…¶ç¼–è¯‘ä¹‹åï¼Œä½¿ç”¨objdumpè¿›è¡Œåæ±‡ç¼–ï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># å†…æ ¸ç‰ˆæœ¬ 2.6.8-2-686-smp</span></span><br><span class="line"><span class="comment"># gccç‰ˆæœ¬ 3.3.5</span></span><br><span class="line">$ gcc -g -O0 test.c</span><br><span class="line">$ objdump -Sd a.out &gt; a.s</span><br><span class="line"><span class="comment"># å¦‚æœåªæƒ³ç¼–è¯‘çš„è¯ï¼Œå¯ä»¥ç›´æ¥</span></span><br><span class="line"><span class="comment"># gcc -S test.c</span></span><br></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥æˆ‘ä»¬å°†ç»“åˆæ±‡ç¼–ä»£ç ä»¥åŠæ ˆçš„å®æ—¶æƒ…å†µï¼Œæ¥ç›´è§‚åœ°äº†è§£ä¸‹å‡½æ•°çš„è°ƒç”¨è¿‡ç¨‹ï¼Œå³ä¸Šé¢fooå‡½æ•°çš„è°ƒç”¨è¿‡ç¨‹ã€‚</p>
<h2 id="è°ƒç”¨è€…éƒ¨åˆ†"><a href="#è°ƒç”¨è€…éƒ¨åˆ†" class="headerlink" title="è°ƒç”¨è€…éƒ¨åˆ†"></a>è°ƒç”¨è€…éƒ¨åˆ†</h2><p>é¦–å…ˆæ¥çœ‹mainå‡½æ•°çš„å‰é¢éƒ¨åˆ†</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"> <span class="number">804837</span>c:   <span class="number">55</span>                      push   %ebp</span><br><span class="line"> <span class="number">804837</span>d:   <span class="number">89</span> e5                   mov    %esp,%ebp</span><br><span class="line"> <span class="number">804837f</span>:   <span class="number">83</span> ec <span class="number">18</span>                sub    $<span class="number">0x18</span>,%esp</span><br><span class="line"> <span class="number">8048382</span>:   <span class="number">83</span> e4 f0                <span class="keyword">and</span>    $<span class="number">0xfffffff0</span>,%esp</span><br><span class="line"> <span class="number">8048385</span>:   b8 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>          mov    $<span class="number">0x0</span>,%eax</span><br><span class="line"> <span class="number">804838</span>a:   <span class="number">29</span> c4                   sub    %eax,%esp</span><br></pre></td></tr></table></figure>

<ol>
<li><p>æœ€å‰é¢ä¸¤ä¸ªæŒ‡ä»¤æ˜¯mainå‡½æ•°çš„å¼€å¸§æ“ä½œ</p>
</li>
<li><p>æ¥ä¸‹æ¥çš„<code>sub $0x18, %esp</code>åˆ†é…æ ˆç©ºé—´ï¼Œè¿™é‡Œåˆ†é…äº†è¾ƒå¤šçš„ç©ºé—´ï¼ŒåŒ…æ‹¬äº†å±€éƒ¨å˜é‡ä»¥åŠè°ƒç”¨å­å‡½æ•°æ—¶å‚æ•°çš„ç©ºé—´ï¼Œè€Œä¸”è¿˜æœ‰ä½™é‡ã€‚</p>
</li>
<li><p>æ¥ä¸‹æ¥çš„<code>and $0xfffffff0,%esp</code>ï¼Œæ˜¯å°†esp 16å­—èŠ‚å¯¹é½ã€‚</p>
</li>
<li><p>æ¥ä¸‹æ¥çš„ä¸¤æ¡æŒ‡ä»¤æ²¡æœ‰ä»€ä¹ˆå®é™…çš„å½±å“ï¼Œä¸ç¡®å®šæ˜¯ä»€ä¹ˆç›®çš„ï¼Œä¼°è®¡ä¹Ÿæ˜¯æŸä¸ªç¼–è¯‘å™¨è¡Œä¸ºã€‚</p>
</li>
<li><p><code>movl   $0x0,0xfffffffc(%ebp)</code>å°†ç¬¬ä¸€ä¸ªå±€éƒ¨å˜é‡ï¼ˆå³retï¼‰èµ‹å€¼ä¸º0ã€‚</p>
</li>
</ol>
<p>æ¥ä¸‹æ¥çš„å°±æ˜¯è°ƒç”¨fooå‡½æ•°ç›¸å…³çš„éƒ¨åˆ†äº†ï¼Œæ­¤æ—¶æ ˆçš„æƒ…å†µå¦‚ä¸‹ï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/catbro666/catbro666.github.io/posts/657c24ad/C%E8%AF%AD%E8%A8%80%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A801.png" alt="Cè¯­è¨€å‡½æ•°è°ƒç”¨01" loading="lazy"></p>
<p>æ­¤æ—¶çš„EBPæŒ‡å‘mainå‡½æ•°æ ˆå¸§çš„åŸºå€ï¼ŒESPæŒ‡å‘æ ˆé¡¶ä½ç½®ã€‚å› ä¸ºæˆ‘ä»¬çš„ç¨‹åºéå¸¸ç®€å•ï¼Œåé¢ä¹Ÿæ²¡æœ‰ç”¨åˆ°è°ƒç”¨è€…ä¿å­˜çš„å¯„å­˜å™¨ï¼Œæ‰€ä»¥è¿™é‡Œçœç•¥äº†ä¿å­˜å¯„å­˜å™¨çš„æ­¥éª¤ã€‚åˆå› ä¸ºå‰é¢ä¸€å¼€å§‹å·²ç»åˆ†é…äº†å‚æ•°çš„æ ˆç©ºé—´ï¼Œæ‰€ä»¥æ¥ä¸‹æ¥ç›´æ¥å¯¹æ ˆä¸­å¯¹åº”ä½ç½®çš„å½¢å‚èµ‹å€¼å³å¯ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/catbro666/catbro666.github.io/posts/657c24ad/C%E8%AF%AD%E8%A8%80%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A802.png" alt="Cè¯­è¨€å‡½æ•°è°ƒç”¨02" loading="lazy"></p>
<p>å‚æ•°çš„ä¼ é€’æ˜¯ä»å³å¾€å·¦çš„é¡ºåºï¼Œæ‰€ä»¥å…ˆä¼ é€’ç¬¬äºŒä¸ªå‚æ•°ï¼ŒESP+4çš„ä½ç½®çš„å€¼è¢«èµ‹å€¼ä¸º2ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/catbro666/catbro666.github.io/posts/657c24ad/C%E8%AF%AD%E8%A8%80%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A803.png" alt="Cè¯­è¨€å‡½æ•°è°ƒç”¨03" loading="lazy"></p>
<p>æ¥ç€ä¼ é€’ç¬¬ä¸€ä¸ªå‚æ•°ï¼ŒESPä½ç½®çš„å€¼è¢«èµ‹å€¼ä¸º1ã€‚å‚æ•°ä¼ é€’å®Œæ¯•æ¥ä¸‹æ¥å°±æ‰§è¡Œ<code>call</code>æŒ‡ä»¤è¿›å…¥å­å‡½æ•°fooçš„èŒƒå›´äº†ã€‚</p>
<p>æˆ‘ä»¬æš‚ä¸”è·³è¿‡ï¼Œå‡è®¾ç°åœ¨fooå‡½æ•°å·²ç»è¿”å›ï¼Œæ¥çœ‹æœ€åå‡ æ¡æŒ‡ä»¤çš„æ“ä½œã€‚ç°åœ¨EAXä¸­å­˜æ”¾äº†è¿”å›å€¼ã€‚</p>
<ol>
<li><code>mov %eax,0xfffffffc(%ebp)</code>å°†è¿”å›å€¼èµ‹å€¼ç»™å±€éƒ¨å˜é‡ret</li>
<li>ç„¶åmainå‡½æ•°è¿”å›äº†ï¼Œæ‰€ä»¥è¦å°†è¿”å›å€¼æ”¾åˆ°EAXä¸­ã€‚ï¼ˆå› ä¸ºæˆ‘ä»¬ç¼–è¯‘æ—¶æ˜¯ç”¨çš„-O0ï¼Œæ‰€ä»¥è¿™ä¸€æ­¥æ˜¾å¾—æœ‰ç‚¹å¤šä½™ï¼‰</li>
<li>æ¥ä¸‹æ¥è¦å°†å‚æ•°å‡ºæ ˆï¼Œè¿™é‡Œå¹¶æ²¡æœ‰å•ç‹¬æ‰§è¡Œè¿™ä¸ªæ“ä½œï¼Œè€Œæ˜¯åˆå¹¶åˆ°<code>leave</code>æŒ‡ä»¤é‡Œäº†</li>
<li><code>leave</code>æŒ‡ä»¤ï¼Œç›¸å½“äº<code>mov esp,ebp; pop ebp </code>ã€‚ç›´æ¥å°†å…³é—­å½“å‰æ ˆå¸§ï¼Œå°†å‚æ•°ä»¥åŠå±€éƒ¨å˜é‡ç»Ÿç»Ÿæ¸…äº†ã€‚ä»è¿™ä¸ªä¾‹å­ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œç¼–è¯‘å™¨å¹¶æ²¡æœ‰å‚»ç“œå¼åœ°æ¯æ¬¡è°ƒç”¨å‡½æ•°éƒ½æ‰§è¡Œå‚æ•°çš„å…¥æ ˆå’Œå‡ºæ ˆæ“ä½œã€‚äº‹å®ä¸Šï¼Œå®ƒåšäº†ä¸€å®šçš„ä¼˜åŒ–ï¼Œåœ¨ä¸€å¼€å§‹å°±åˆ†é…äº†å……è¶³çš„æ ˆç©ºé—´ï¼Œè¶³å¤Ÿå­˜æ”¾å±€éƒ¨å˜é‡ä»¥åŠåé¢è¦è°ƒç”¨çš„å­å‡½æ•°çš„å‚æ•°ï¼Œæœ€ååœ¨å…³å¸§çš„ç»Ÿä¸€é‡Šæ”¾æ ˆç©ºé—´ã€‚</li>
<li>å¦‚æœå‰é¢æœ‰å°†è°ƒç”¨è€…ä¿å­˜çš„å¯„å­˜å™¨å…¥æ ˆçš„è¯ï¼Œè¿™é‡Œè¦æ‰§è¡Œç›¸åº”çš„å‡ºæ ˆæ“ä½œæ¢å¤ç›¸åº”çš„å¯„å­˜å™¨çš„å€¼ã€‚åœ¨æˆ‘ä»¬è¿™ä¸ªä¾‹å­ä¸­å¹¶æ²¡æœ‰ã€‚</li>
</ol>
<h2 id="è¢«è°ƒè€…éƒ¨åˆ†"><a href="#è¢«è°ƒè€…éƒ¨åˆ†" class="headerlink" title="è¢«è°ƒè€…éƒ¨åˆ†"></a>è¢«è°ƒè€…éƒ¨åˆ†</h2><p>ç°åœ¨æˆ‘ä»¬æ¥çœ‹è¢«è°ƒè€…fooå‡½æ•°ä¸­çš„éƒ¨åˆ†ï¼Œåœ¨mainå‡½æ•°ä¸­æ‰§è¡Œ<code>call</code>æŒ‡ä»¤ä¹‹åï¼Œæ ˆçš„æƒ…å†µå¦‚ä¸‹ï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/catbro666/catbro666.github.io/posts/657c24ad/C%E8%AF%AD%E8%A8%80%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A804.png" alt="Cè¯­è¨€å‡½æ•°è°ƒç”¨04" loading="lazy"></p>
<p>æ­¤æ—¶ï¼Œè¿”å›åœ°å€å·²ç»å…¥æ ˆï¼ŒEBPè¿˜æ˜¯ä¸Šä¸€ä¸ªmainå‡½æ•°çš„åŸºå€ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/catbro666/catbro666.github.io/posts/657c24ad/C%E8%AF%AD%E8%A8%80%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A805.png" alt="Cè¯­è¨€å‡½æ•°è°ƒç”¨05" loading="lazy"></p>
<p>é¦–å…ˆéœ€è¦åˆ›å»ºfooå‡½æ•°çš„æ ˆå¸§ï¼Œå°†EBPå…¥æ ˆï¼Œä¿å­˜mainå‡½æ•°æ ˆå¸§çš„åŸºå€ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/catbro666/catbro666.github.io/posts/657c24ad/C%E8%AF%AD%E8%A8%80%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A806.png" alt="Cè¯­è¨€å‡½æ•°è°ƒç”¨06" loading="lazy"></p>
<p>ç´§æ¥ç€è®©EBPæŒ‡å‘å½“å‰ESPçš„ä½ç½®ï¼Œæ­¤æ—¶EBPå˜æˆäº†fooå‡½æ•°æ ˆå¸§çš„åŸºå€ã€‚åç»­å°±å¯ä»¥é€šè¿‡EBPåŠ ä¸Šä¸€å®šçš„åç§»æ¥è®¿é—®å½¢å‚å’Œå±€éƒ¨å˜é‡äº†ã€‚<img src="https://cdn.jsdelivr.net/gh/catbro666/catbro666.github.io/posts/657c24ad/C%E8%AF%AD%E8%A8%80%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A807.png" alt="Cè¯­è¨€å‡½æ•°è°ƒç”¨07" loading="lazy"></p>
<p>æ¥ä¸‹æ¥ä¸€æ¡æŒ‡ä»¤åˆ†é…å±€éƒ¨å˜é‡çš„æ ˆç©ºé—´ï¼Œå› ä¸ºæœ‰ä¸¤ä¸ªintå‹å±€éƒ¨å˜é‡ï¼Œæ‰€ä»¥è¿™é‡Œå°†espå‡äº†8ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/catbro666/catbro666.github.io/posts/657c24ad/C%E8%AF%AD%E8%A8%80%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A808.png" alt="Cè¯­è¨€å‡½æ•°è°ƒç”¨08" loading="lazy"></p>
<p>æ­£å¸¸æƒ…å†µä¸‹ï¼Œå¦‚æœfooå‡½æ•°ç”¨åˆ°äº†è¢«è°ƒè€…ä¿å­˜çš„å¯„å­˜å™¨çš„è¯ï¼Œéœ€è¦ç°åœ¨è¿™é‡Œæ‰§è¡Œå…¥æ ˆçš„æ“ä½œï¼Œä¿å­˜ç›¸åº”å¯„å­˜å™¨çš„å€¼ã€‚å› ä¸ºæˆ‘ä»¬ç¨‹åºæ¯”è¾ƒç®€å•ï¼Œæ‰€ä»¥æ²¡æœ‰è¿™ä¸ªè¿‡ç¨‹ã€‚</p>
<p>æ¥ä¸‹æ¥å°†EBP-4çš„ä½ç½®èµ‹å€¼ä¸º0x10ï¼Œå¯¹åº”Cä»£ç ä¸­çš„<code>int fa = 0x10;</code></p>
<p><img src="https://cdn.jsdelivr.net/gh/catbro666/catbro666.github.io/posts/657c24ad/C%E8%AF%AD%E8%A8%80%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A809.png" alt="Cè¯­è¨€å‡½æ•°è°ƒç”¨09" loading="lazy"></p>
<p>åŒæ ·åœ°ï¼Œå°†EBP-8çš„ä½ç½®èµ‹å€¼ä¸º0x20ï¼Œå¯¹åº”Cä»£ç ä¸­çš„<code>int fb = 0x10;</code></p>
<p>æ¥ä¸‹æ¥æ‰§è¡Œå°†å½¢å‚açš„å€¼èµ‹å€¼ç»™faï¼Œé¦–å…ˆå°†EBP+8ä½ç½®çš„å½¢å‚aèµ‹å€¼åˆ°EAXå¯„å­˜å™¨ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/catbro666/catbro666.github.io/posts/657c24ad/C%E8%AF%AD%E8%A8%80%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A810.png" alt="Cè¯­è¨€å‡½æ•°è°ƒç”¨10" loading="lazy"></p>
<p>ç„¶åå†å°†EAXå¯„å­˜å™¨çš„å€¼èµ‹å€¼åˆ°EBP-4çš„ä½ç½®ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/catbro666/catbro666.github.io/posts/657c24ad/C%E8%AF%AD%E8%A8%80%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A811.png" alt="Cè¯­è¨€å‡½æ•°è°ƒç”¨11" loading="lazy"></p>
<p>æ¥ä¸‹æ¥æ˜¯å½¢å‚bçš„å€¼èµ‹å€¼ç»™fbï¼Œæ‰§è¡Œçš„æ“ä½œç±»ä¼¼ï¼Œé€šè¿‡å¯„å­˜å™¨EAXåšäº†ä¸€ä¸‹ä¸­è½¬ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/catbro666/catbro666.github.io/posts/657c24ad/C%E8%AF%AD%E8%A8%80%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A812.png" alt="Cè¯­è¨€å‡½æ•°è°ƒç”¨12" loading="lazy"></p>
<p><img src="https://cdn.jsdelivr.net/gh/catbro666/catbro666.github.io/posts/657c24ad/C%E8%AF%AD%E8%A8%80%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A813.png" alt="Cè¯­è¨€å‡½æ•°è°ƒç”¨13" loading="lazy"></p>
<p>æ¥ä¸‹æ¥æ‰§è¡Œfaå’Œfbç›¸åŠ çš„æ“ä½œï¼Œå…ˆå°†EBP-8çš„å€¼æ”¾åˆ°EAXä¸­ï¼Œå› ä¸º-O0çš„å…³ç³»è¿™ä¸€æ­¥åˆæ˜¾å¾—æœ‰äº›å¤šä½™ï¼Œç„¶åEBP-4çš„å€¼åŠ åˆ°EAXä¸­ï¼Œæ‰§è¡Œå®Œä¹‹åEAXå°±å˜æˆäº†3ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/catbro666/catbro666.github.io/posts/657c24ad/C%E8%AF%AD%E8%A8%80%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A814.png" alt="Cè¯­è¨€å‡½æ•°è°ƒç”¨14" loading="lazy"></p>
<p>åˆ°è¿™é‡Œå‡½æ•°ä½“å·²ç»æ‰§è¡Œå®Œæ¯•ï¼Œä½†æ˜¯è¿˜æœ‰ä¸€äº›å–„åå·¥ä½œéœ€è¦åšï¼š</p>
<ol>
<li>æ­¤æ—¶è¿”å›å€¼å·²ç»åœ¨EAXä¸­äº†ã€‚</li>
<li>å¦‚æœå‰é¢æœ‰è¢«è°ƒè€…ä¿å­˜çš„å¯„å­˜å™¨å…¥æ ˆçš„è¯ï¼Œè¿™é‡Œéœ€è¦æ‰§è¡Œç›¸åº”çš„å‡ºæ ˆæ“ä½œè¿›è¡Œæ¢å¤ã€‚</li>
<li>æ¥ä¸‹æ¥éœ€è¦é‡Šæ”¾å±€éƒ¨å˜é‡çš„æ ˆç©ºé—´ï¼Œç„¶åæ¢å¤ä¸Šä¸€ä¸ªæ ˆå¸§çš„EBPï¼Œå°†å…¶å‡ºæ ˆã€‚è¿™ä¸¤æ­¥åˆå¹¶åˆ°äº†<code>leave</code>æŒ‡ä»¤ä¸­ã€‚æ‰§è¡Œå®Œ<code>leave</code>ä¹‹åçš„æ ˆæƒ…å†µå¦‚ä¸‹ã€‚æ ˆé¡¶ä¸ºè¿”å›åœ°å€ï¼ŒEBPå·²ç»æ¢å¤ä¸ºmainå‡½æ•°çš„åŸºå€ã€‚</li>
</ol>
<p><img src="https://cdn.jsdelivr.net/gh/catbro666/catbro666.github.io/posts/657c24ad/C%E8%AF%AD%E8%A8%80%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A815.png" alt="Cè¯­è¨€å‡½æ•°è°ƒç”¨15" loading="lazy"></p>
<p>å½“æœ€åä¸€ä¸ª<code>ret</code>æŒ‡ä»¤æ‰§è¡Œä¹‹åï¼Œè¿”å›åœ°å€å‡ºæ ˆï¼Œæ ˆæ¢å¤åˆ°æ‰§è¡Œ<code>call</code>æŒ‡ä»¤å‰çš„æƒ…å†µï¼Œç¨‹åºè·³è½¬åˆ°è¿”å›åœ°å€ç»§ç»­æ‰§è¡Œmainå‡½æ•°åç»­çš„ä»£ç ã€‚</p>
<h2 id="x64ä¸Šçš„åŒºåˆ«"><a href="#x64ä¸Šçš„åŒºåˆ«" class="headerlink" title="x64ä¸Šçš„åŒºåˆ«"></a>x64ä¸Šçš„åŒºåˆ«</h2><p>åœ¨x64ä¸Šï¼Œä¸ä»…å¯„å­˜å™¨çš„ä½æ•°æ‰©å±•åˆ°äº†64ä½ï¼Œå¯ç”¨çš„å¯„å­˜å™¨ä¹Ÿæ›´å¤šäº†ã€‚Linuxåœ¨x64ä¸Šä½¿ç”¨System V AMD64 ABIè°ƒç”¨çº¦å®šï¼Œå…¶ä¸»è¦å†…å®¹å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">%rax     %eax    è¿”å›å€¼</span><br><span class="line">%rbx     %ebx    è¢«è°ƒç”¨è€…ä¿å­˜</span><br><span class="line">%rcx     %ecx    ç¬¬å››ä¸ªå‚æ•°</span><br><span class="line">%rdx     %edx    ç¬¬ä¸‰ä¸ªå‚æ•°ï¼Œ<span class="number">128</span>ä½è¿”å›å€¼</span><br><span class="line">%rsi     %esi    ç¬¬äºŒä¸ªå‚æ•°</span><br><span class="line">%rdi     %edi    ç¬¬ä¸€ä¸ªå‚æ•°</span><br><span class="line">%rbp     %ebp    åŸºå€æŒ‡é’ˆï¼Œè¢«è°ƒç”¨è€…ä¿å­˜</span><br><span class="line">%rsp     %esp    å †æ ˆæŒ‡é’ˆï¼Œè¢«è°ƒç”¨è€…ä¿å­˜</span><br><span class="line">%r8      %r8d    ç¬¬äº”ä¸ªå‚æ•°</span><br><span class="line">%r9      %r9d    ç¬¬å…­ä¸ªå‚æ•°</span><br><span class="line">%r10     %r10d   è°ƒç”¨è€…ä¿å­˜</span><br><span class="line">%r11     %r11d   è°ƒç”¨è€…ä¿å­˜</span><br><span class="line">%r12     %r12d   è¢«è°ƒç”¨è€…ä¿å­˜</span><br><span class="line">%r13     %r13d   è¢«è°ƒç”¨è€…ä¿å­˜</span><br><span class="line">%r14     %r14d   è¢«è°ƒç”¨è€…ä¿å­˜</span><br><span class="line">%r15     %r15d   è¢«è°ƒç”¨è€…ä¿å­˜</span><br><span class="line">xmm0<span class="number">-7</span>           å‰<span class="number">8</span>ä¸ªæµ®ç‚¹å‚æ•°</span><br><span class="line">xmm0<span class="number">-1</span>           æµ®ç‚¹è¿”å›å€¼</span><br></pre></td></tr></table></figure>

<p>RDI, RSI, RDX, RCX, R8, R9å¯„å­˜å™¨åˆ†åˆ«ä¼ é€’å‰6ä¸ªæ•´å‹æˆ–æŒ‡é’ˆå‚æ•°ï¼ŒXMM0-7ç”¨äºä¼ é€’å‰8ä¸ªæµ®ç‚¹å‚æ•°ã€‚å¦‚æœè¿˜æœ‰é¢å¤–çš„å‚æ•°ï¼Œé‚£ä¹ˆè¿˜æ˜¯é€šè¿‡æ ˆè¿›è¡Œä¼ é€’ã€‚</p>
<p>ä¸è¶…è¿‡64ä½çš„è¿”å›å€¼é€šè¿‡RAXä¼ é€’ï¼Œä¸è¶…è¿‡128ä½çš„è¿”å›å€¼é€šè¿‡RAXå’ŒRDXä¼ é€’ã€‚æµ®ç‚¹æ•°è¿”å›å€¼ä½¿ç”¨XMM0å’ŒXMM1ã€‚</p>
<p>å…¶ä¸­RBXã€RBPã€RSPã€R12-R15è¿™å‡ ä¸ªå¯„å­˜å™¨æ˜¯è¢«è°ƒç”¨è€…ä¿å­˜çš„ï¼Œå…¶ä½™çš„éƒ½æ˜¯è°ƒç”¨è€…ä¿å­˜ã€‚</p>
<p>å¦å¤–è¿˜æœ‰ä¸€ç‚¹å€¼å¾—æä¸€ä¸‹ï¼Œå¯¹äºå¶å­èŠ‚ç‚¹å‡½æ•°ï¼Œå‡½æ•°çš„æ ˆæŒ‡é’ˆä¸‹æ–¹ä¿ç•™äº†ä¸€ä¸ª128å­—èŠ‚çš„ç©ºé—´ï¼ˆred-zoneï¼‰ï¼Œç¼–è¯‘å™¨å¯ä»¥ä½¿ç”¨è¿™ä¸ªåŒºåŸŸä¿å­˜å±€éƒ¨å˜é‡ï¼Œè¿™æ ·å¯ä»¥çœå»å¼€å¤´çš„ä¸€äº›æŒ‡ä»¤ã€‚</p>
<p>æˆ‘ä»¬é‡æ–°åœ¨x64ç¯å¢ƒä¸‹ç¼–è¯‘å‰é¢çš„ç¤ºä¾‹ä»£ç ï¼Œçœ‹çœ‹æœ‰ä»€ä¹ˆåŒºåˆ«</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// å†…æ ¸ç‰ˆæœ¬ 5.4.0-91-generic</span></span><br><span class="line"><span class="comment">// gccç‰ˆæœ¬ 7.5.0</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"> <span class="number">628</span>:   <span class="number">55</span>                      push   %rbp</span><br><span class="line"> <span class="number">629</span>:   <span class="number">48</span> <span class="number">89</span> e5                mov    %rsp,%rbp</span><br><span class="line"> <span class="number">62</span>c:   <span class="number">48</span> <span class="number">83</span> ec <span class="number">10</span>             sub    $<span class="number">0x10</span>,%rsp</span><br><span class="line">    <span class="keyword">int</span> ret = <span class="number">0</span>;</span><br><span class="line"> <span class="number">630</span>:   c7 <span class="number">45</span> fc <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    movl   $<span class="number">0x0</span>,<span class="number">-0x4</span>(%rbp)</span><br><span class="line">    ret = foo(<span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line"> <span class="number">637</span>:   be <span class="number">02</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>          mov    $<span class="number">0x2</span>,%esi</span><br><span class="line"> <span class="number">63</span>c:   bf <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>          mov    $<span class="number">0x1</span>,%edi</span><br><span class="line"> <span class="number">641</span>:   e8 b4 ff ff ff          callq  <span class="number">5f</span>a &lt;foo&gt;</span><br><span class="line"> <span class="number">646</span>:   <span class="number">89</span> <span class="number">45</span> fc                mov    %eax,<span class="number">-0x4</span>(%rbp)</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line"> <span class="number">649</span>:   <span class="number">8b</span> <span class="number">45</span> fc                mov    <span class="number">-0x4</span>(%rbp),%eax</span><br><span class="line">&#125;</span><br><span class="line"> <span class="number">64</span>c:   c9                      leaveq</span><br><span class="line"> <span class="number">64</span>d:   c3                      retq</span><br><span class="line"> <span class="number">64</span>e:   <span class="number">66</span> <span class="number">90</span>                   xchg   %ax,%ax</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°ä¸¤ä¸ªå‚æ•°å¹¶æ²¡æœ‰é€šè¿‡æ ˆä¼ é€’ï¼Œè€Œæ˜¯åˆ†åˆ«é€šè¿‡ediå’Œesiå¯„å­˜å™¨ä¼ é€’ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">foo</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"> <span class="number">5f</span>a:   <span class="number">55</span>                      push   %rbp</span><br><span class="line"> <span class="number">5f</span>b:   <span class="number">48</span> <span class="number">89</span> e5                mov    %rsp,%rbp</span><br><span class="line"> <span class="number">5f</span>e:   <span class="number">89</span> <span class="number">7</span>d ec                mov    %edi,<span class="number">-0x14</span>(%rbp)</span><br><span class="line"> <span class="number">601</span>:   <span class="number">89</span> <span class="number">75</span> e8                mov    %esi,<span class="number">-0x18</span>(%rbp)</span><br><span class="line">    <span class="keyword">int</span> fa = <span class="number">0x10</span>;</span><br><span class="line"> <span class="number">604</span>:   c7 <span class="number">45</span> f8 <span class="number">10</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    movl   $<span class="number">0x10</span>,<span class="number">-0x8</span>(%rbp)</span><br><span class="line">    <span class="keyword">int</span> fb = <span class="number">0x20</span>;</span><br><span class="line"> <span class="number">60b</span>:   c7 <span class="number">45</span> fc <span class="number">20</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    movl   $<span class="number">0x20</span>,<span class="number">-0x4</span>(%rbp)</span><br><span class="line">    fa = a;</span><br><span class="line"> <span class="number">612</span>:   <span class="number">8b</span> <span class="number">45</span> ec                mov    <span class="number">-0x14</span>(%rbp),%eax</span><br><span class="line"> <span class="number">615</span>:   <span class="number">89</span> <span class="number">45</span> f8                mov    %eax,<span class="number">-0x8</span>(%rbp)</span><br><span class="line">    fb = b;</span><br><span class="line"> <span class="number">618</span>:   <span class="number">8b</span> <span class="number">45</span> e8                mov    <span class="number">-0x18</span>(%rbp),%eax</span><br><span class="line"> <span class="number">61b</span>:   <span class="number">89</span> <span class="number">45</span> fc                mov    %eax,<span class="number">-0x4</span>(%rbp)</span><br><span class="line">    <span class="keyword">return</span> fa + fb;</span><br><span class="line"> <span class="number">61</span>e:   <span class="number">8b</span> <span class="number">55</span> f8                mov    <span class="number">-0x8</span>(%rbp),%edx</span><br><span class="line"> <span class="number">621</span>:   <span class="number">8b</span> <span class="number">45</span> fc                mov    <span class="number">-0x4</span>(%rbp),%eax</span><br><span class="line"> <span class="number">624</span>:   <span class="number">01</span> d0                   add    %edx,%eax</span><br><span class="line">&#125;</span><br><span class="line"> <span class="number">626</span>:   <span class="number">5</span>d                      pop    %rbp</span><br><span class="line"> <span class="number">627</span>:   c3                      retq</span><br></pre></td></tr></table></figure>

<p>å†æ¥çœ‹çœ‹fooå‡½æ•°çš„æƒ…å†µï¼Œæ³¨æ„åˆ°å®ƒé‡Œé¢å¹¶æ²¡æœ‰ä¸ºå±€éƒ¨å˜é‡åˆ†é…æ ˆç©ºé—´ï¼Œè€Œæ˜¯ç›´æ¥é€šè¿‡rbpè¿›è¡Œèµ‹å€¼äº†ã€‚è¿™æ˜¯å› ä¸ºfooå‡½æ•°å°±æ˜¯æˆ‘ä»¬å‰é¢æåˆ°çš„å¶å­èŠ‚ç‚¹å‡½æ•°ï¼Œå®ƒæ²¡æœ‰å†è°ƒç”¨å…¶ä»–å‡½æ•°ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥ä½¿ç”¨red-zoneçš„ç©ºé—´ã€‚</p>
<h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ul>
<li><a href="https://www.cs.virginia.edu/~evans/cs216/guides/x86.html">x86æ±‡ç¼–æŒ‡å—</a></li>
<li><a href="https://en.wikipedia.org/wiki/Calling_convention">Calling_convention</a></li>
<li><a href="https://en.wikipedia.org/wiki/X86_calling_conventions">X86_calling_conventions</a></li>
<li><a href="https://zh.wikipedia.org/wiki/X86%E8%B0%83%E7%94%A8%E7%BA%A6%E5%AE%9A">x86è°ƒç”¨çº¦å®š</a></li>
<li><a href="https://www.jianshu.com/p/1782e14a0766">gccå†…è”æ±‡ç¼–åŸºç¡€</a></li>
</ul>
]]></content>
      <categories>
        <category>ç†è§£è®¡ç®—æœº</category>
      </categories>
      <tags>
        <tag>è°ƒç”¨çº¦å®š</tag>
        <tag>C/C++</tag>
      </tags>
  </entry>
  <entry>
    <title>Hexo-NexT Tag æ’ä»¶çš„ä½¿ç”¨</title>
    <url>/posts/29bfe8c9/</url>
    <content><![CDATA[<p><code>Tag Plugin</code> æ˜¯ä¸€ç§ä½¿ Hexo æ”¯æŒç‰¹æ®Šæ ·å¼å†…å®¹çš„æ–¹æ³•ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬æ— æ³•åœ¨æ ‡å‡† Markdown ä¸­æ˜¾ç¤ºå…·æœ‰è‡ªå®šä¹‰å°ºå¯¸çš„å›¾åƒã€‚ç„¶åæˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ ‡ç­¾æ’ä»¶æ¥è§£å†³å®ƒã€‚ Hexo æœ‰å¾ˆå¤šå¯ä»¥å¸®åŠ©ç”¨æˆ·çš„æ ‡ç­¾ã€‚ Hexo è¿˜å…·æœ‰ä¸»é¢˜æ¥å£ï¼Œä½¿ä¸»é¢˜èƒ½å¤Ÿåˆ›å»ºè‡ªå·±çš„æ ‡ç­¾ã€‚</p>
<span id="more"></span>

<h2 id="æ–‡æœ¬å±…ä¸­å¼•ç”¨-Centered-Quote"><a href="#æ–‡æœ¬å±…ä¸­å¼•ç”¨-Centered-Quote" class="headerlink" title="æ–‡æœ¬å±…ä¸­å¼•ç”¨ - Centered Quote"></a>æ–‡æœ¬å±…ä¸­å¼•ç”¨ - Centered Quote</h2><p>ä½¿ç”¨æ–¹å¼ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;% cq %&#125;å› ä¸ºæˆ‘æ¸ºå°çš„å¿ƒçµé‡Œï¼Œå®¹ä¸ä¸‹ä¸€ä¸ªè°œï¼Œä¸€ç‚¹æ‚¬è€Œæœªå†³çš„ä¸œè¥¿&#123;% endcq %&#125;</span><br></pre></td></tr></table></figure>

<p>æ•ˆæœå±•ç¤ºï¼š</p>
<blockquote class="blockquote-center">
            <i class="fa fa-quote-left"></i>
            <p>å› ä¸ºæˆ‘æ¸ºå°çš„å¿ƒçµé‡Œï¼Œå®¹ä¸ä¸‹ä¸€ä¸ªè°œï¼Œä¸€ç‚¹æ‚¬è€Œæœªå†³çš„ä¸œè¥¿</p>

            <i class="fa fa-quote-right"></i>
          </blockquote>



<h2 id="æç¤ºå—-Note"><a href="#æç¤ºå—-Note" class="headerlink" title="æç¤ºå— - Note"></a>æç¤ºå— - Note</h2><p>ä½¿ç”¨æ–¹å¼ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;% note default %&#125;</span><br><span class="line">default æç¤ºå—æ ‡ç­¾</span><br><span class="line">&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note primary %&#125;</span><br><span class="line">primary æç¤ºå—æ ‡ç­¾</span><br><span class="line">&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note success %&#125;</span><br><span class="line">success æç¤ºå—æ ‡ç­¾</span><br><span class="line">&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note info %&#125;</span><br><span class="line">info æç¤ºå—æ ‡ç­¾</span><br><span class="line">&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note warning %&#125;</span><br><span class="line">warning æç¤ºå—æ ‡ç­¾</span><br><span class="line">&#123;% endnote %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% note danger %&#125;</span><br><span class="line">danger æç¤ºå—æ ‡ç­¾</span><br><span class="line">&#123;% endnote %&#125;</span><br></pre></td></tr></table></figure>

<p>æ•ˆæœå±•ç¤ºï¼š</p>
<div class="note default">
            <p>default æç¤ºå—æ ‡ç­¾</p>
          </div>

<div class="note primary">
            <p>primary æç¤ºå—æ ‡ç­¾</p>
          </div>

<div class="note success">
            <p>success æç¤ºå—æ ‡ç­¾</p>
          </div>

<div class="note info">
            <p>info æç¤ºå—æ ‡ç­¾</p>
          </div>

<div class="note warning">
            <p>warning æç¤ºå—æ ‡ç­¾</p>
          </div>

<div class="note danger">
            <p>danger æç¤ºå—æ ‡ç­¾</p>
          </div>



<p>å¯åœ¨ä¸»é¢˜é…ç½®æ–‡ä»¶ä¸­ä¿®æ”¹é£æ ¼ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># Note tag (bs-callout)</span><br><span class="line">note:</span><br><span class="line">  # Note tag style values:</span><br><span class="line">  #  - simple    bs-callout old alert style. Default.</span><br><span class="line">  #  - modern    bs-callout new (v2-v3) alert style.</span><br><span class="line">  #  - flat      flat callout style with background, like on Mozilla or StackOverflow.</span><br><span class="line">  #  - disabled  disable all CSS styles import of note tag.</span><br><span class="line">  style: flat</span><br><span class="line">  icons: true</span><br><span class="line">  # åœ†è§’</span><br><span class="line">  border_radius: 3</span><br><span class="line">  # Offset lighter of background in % for modern and flat styles (modern: -12 | 12; flat: -18 | 6).</span><br><span class="line">  # Offset also applied to label tag variables. This option can work with disabled note tag.</span><br><span class="line">  light_bg_offset: 0</span><br></pre></td></tr></table></figure>



<h2 id="æ ‡ç­¾-Label"><a href="#æ ‡ç­¾-Label" class="headerlink" title="æ ‡ç­¾ - Label"></a>æ ‡ç­¾ - Label</h2><p>ä½¿ç”¨æ–¹å¼ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;% label default@é»˜è®¤ %&#125; &#123;% label primary@ä¸»è¦ %&#125; &#123;% label info@ä¿¡æ¯ %&#125; &#123;% label warning@è­¦å‘Š %&#125; &#123;% label danger@å±é™© %&#125; </span><br><span class="line">&#123;% label success@æˆåŠŸ%&#125;</span><br></pre></td></tr></table></figure>

<p>æ•ˆæœå±•ç¤ºï¼š</p>
<span class="label default">é»˜è®¤</span> <span class="label primary">ä¸»è¦</span> <span class="label info">ä¿¡æ¯</span> <span class="label warning">è­¦å‘Š</span> <span class="label danger">å±é™©</span> 
<span class="label success">æˆåŠŸ</span>

<h2 id="é€‰é¡¹å¡-Tabs"><a href="#é€‰é¡¹å¡-Tabs" class="headerlink" title="é€‰é¡¹å¡ - Tabs"></a>é€‰é¡¹å¡ - Tabs</h2><p>ä½¿ç”¨æ–¹å¼ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;% tabs tab, 2 %&#125; åå­—ä¸ºtabï¼Œé»˜è®¤æ˜¾ç¤ºç¬¬1ä¸ªé€‰é¡¹å¡ï¼Œå¦‚æœæ˜¯-1åˆ™éšè—</span><br><span class="line">&lt;!-- tab é­å›½--&gt;</span><br><span class="line">**æ›¹æ“**</span><br><span class="line"></span><br><span class="line">å¸é©¬æ‡¿ éƒ­å˜‰ è€å½§ è€æ”¸ ç¨‹æ˜± æ¨ä¿® </span><br><span class="line"></span><br><span class="line">å…¸éŸ¦ è®¸è¤š å¤ä¾¯æ¸Š å¤ä¾¯æƒ‡ æ›¹ä» äºç¦ å¼ è¾½ å¾æ™ƒ</span><br><span class="line"></span><br><span class="line">&lt;!-- endtab --&gt;</span><br><span class="line">&lt;!-- tab èœ€å›½--&gt;</span><br><span class="line">**åˆ˜å¤‡**</span><br><span class="line"></span><br><span class="line">è¯¸è‘›äº® åºç»Ÿ å¾åº¶ å§œç»´ æ³•æ­£ é©¬è‰¯</span><br><span class="line"></span><br><span class="line">å…³ç¾½ å¼ é£ èµµäº‘ é©¬è¶… é»„å¿  é­å»¶ å…³å…´ å¼ è‹</span><br><span class="line"></span><br><span class="line">&lt;!-- endtab --&gt;</span><br><span class="line">&lt;!-- tab å´å›½ --&gt;</span><br><span class="line">**å­™æƒ**</span><br><span class="line"></span><br><span class="line">å‘¨ç‘œ å¼ æ˜­ é²è‚ƒ è¯¸è‘›ç‘¾ é™†é€Š</span><br><span class="line"></span><br><span class="line">ç”˜å® å¤ªå²æ…ˆ å•è’™ éŸ©å½“ é»„ç›– ç¨‹æ™®  </span><br><span class="line"></span><br><span class="line">&lt;!-- endtab --&gt;</span><br><span class="line">&#123;% endtabs %&#125;</span><br></pre></td></tr></table></figure>

<p>æ•ˆæœå±•ç¤ºï¼š</p>
<div class="tabs" id="tab"><ul class="nav-tabs"><li class="tab"><a href="#tab-1">é­å›½</a></li><li class="tab active"><a href="#tab-2">èœ€å›½</a></li><li class="tab"><a href="#tab-3">å´å›½</a></li></ul><div class="tab-content"><div class="tab-pane" id="tab-1"><p><strong>æ›¹æ“</strong></p>
<p>å¸é©¬æ‡¿ éƒ­å˜‰ è€å½§ è€æ”¸ ç¨‹æ˜± æ¨ä¿® </p>
<p>å…¸éŸ¦ è®¸è¤š å¤ä¾¯æ¸Š å¤ä¾¯æƒ‡ æ›¹ä» äºç¦ å¼ è¾½ å¾æ™ƒ</p></div><div class="tab-pane active" id="tab-2"><p><strong>åˆ˜å¤‡</strong></p>
<p>è¯¸è‘›äº® åºç»Ÿ å¾åº¶ å§œç»´ æ³•æ­£ é©¬è‰¯</p>
<p>å…³ç¾½ å¼ é£ èµµäº‘ é©¬è¶… é»„å¿  é­å»¶ å…³å…´ å¼ è‹</p></div><div class="tab-pane" id="tab-3"><p><strong>å­™æƒ</strong></p>
<p>å‘¨ç‘œ å¼ æ˜­ é²è‚ƒ è¯¸è‘›ç‘¾ é™†é€Š</p>
<p>ç”˜å® å¤ªå²æ…ˆ å•è’™ éŸ©å½“ é»„ç›– ç¨‹æ™®  </p></div></div></div>



<p>å¯åœ¨ä¸»é¢˜é…ç½®æ–‡ä»¶ä¸­ä¿®æ”¹</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># Tabs tag</span><br><span class="line">tabs:</span><br><span class="line">  transition:</span><br><span class="line">    tabs: true</span><br><span class="line">    labels: true</span><br><span class="line">  border_radius: 3</span><br></pre></td></tr></table></figure>

<h2 id="æŒ‰é’®-Button"><a href="#æŒ‰é’®-Button" class="headerlink" title="æŒ‰é’® - Button"></a>æŒ‰é’® - Button</h2><p>ä½¿ç”¨æ–¹å¼ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;% button url, text, icon [class], [title] %&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>url</code>: æœ¬åœ°æˆ–å¤–éƒ¨url</li>
<li><code>text</code>: æ˜¾ç¤ºçš„æ–‡æœ¬ï¼Œæ–‡æœ¬å’Œå›¾æ ‡è‡³å°‘æŒ‡å®šä¸€ä¸ª</li>
<li><code>icon</code>: æ˜¾ç¤ºçš„å›¾æ ‡ï¼Œ FontAwesome å›¾æ ‡åç§°ï¼ˆå¼€å¤´æ²¡æœ‰â€™fa-â€˜ï¼‰</li>
<li><code>[class]</code>: FontAwesome ç±»ï¼Œå¯ä»¥å–å¦‚ä¸‹å€¼<code>fa-fw | fa-lg | fa-2x | fa-3x | fa-4x | fa-5X</code></li>
<li><code>title</code>: é¼ æ ‡æ‚¬åœæ—¶çš„æç¤ºä¿¡æ¯</li>
</ul>
<p>æ³¨æ„ï¼šæœ€å¥½æ·»åŠ  <code>&lt;div&gt;</code> æ ‡ç­¾ï¼Œæµ‹è¯•æ—¶æ²¡åŠ  divï¼Œä¸‹é¢æ˜¾ç¤ºä¸å®Œå…¨ï¼ŒåŠ ä¸Šéå¸¸ç¾è§‚ã€‚</p>
<p>ä¸€ä¸ªç¤ºä¾‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;div&gt;&#123;% button https://catbro666.github.io/ ,é¦–é¡µ,home fa-fw,è¿™æ˜¯æˆ‘çš„åšå®¢é¦–é¡µ%&#125;&lt;/div&gt;</span><br></pre></td></tr></table></figure>

<p>æ•ˆæœå±•ç¤ºï¼š</p>
<div><a class="btn" href="https://catbro666.github.io/ " title="è¿™æ˜¯æˆ‘çš„åšå®¢é¦–é¡µ">
            <i class="fa fa-home fa-fw"></i>é¦–é¡µ
          </a></div>

<p>å¤šä¸ªæŒ‰é’®çš„æ—¶å€™å¯ä»¥å¥—ä¸¤å±‚divã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;div class=&quot;text-center&quot;&gt;&lt;div&gt;&#123;% button https://catbro666.github.io/ ,é¦–é¡µ,home fa-fw,è¿™æ˜¯æˆ‘çš„åšå®¢é¦–é¡µ%&#125;&#123;% button https://catbro666.github.io/archives ,å½’æ¡£, archive fa-lg&#125;&lt;/div&gt;&lt;/div&gt;</span><br></pre></td></tr></table></figure>

<div class="text-center"><div><a class="btn" href="https://catbro666.github.io/ " title="è¿™æ˜¯æˆ‘çš„åšå®¢é¦–é¡µ">
            <i class="fa fa-home fa-fw"></i>é¦–é¡µ
          </a><a class="btn" href="https://catbro666.github.io/archives ">
            <i class="fa fa-archive fa-lg}</div></div>"></i>å½’æ¡£
          </a>]]></content>
      <categories>
        <category>å·¥å…·</category>
      </categories>
      <tags>
        <tag>Hexo</tag>
      </tags>
  </entry>
  <entry>
    <title>Linux TC æµé‡æ§åˆ¶ä»‹ç»</title>
    <url>/posts/357ad3ec/</url>
    <content><![CDATA[<div class="note primary">
            <p>å‰æ®µæ—¶é—´åœ¨åšä¸€äº›æµ‹è¯•çš„æ—¶å€™æ¥è§¦åˆ°äº†Linux tcï¼Œå› ä¸ºéœ€è¦å¯¹æ•°æ®åŒ…æ·»åŠ å»¶è¿Ÿï¼Œç”¨åˆ°äº†tcä¸­çš„netemã€‚æ·»åŠ ç®€å•çš„å»¶è¿Ÿéå¸¸ç®€å•ï¼Œåƒè¿™æ ·ä¸€æ¡å‘½ä»¤å°±æå®šäº†ï¼š<code>$ tc qdisc add dev eth0 root netem delay 1s</code>ï¼Œä½ ç”šè‡³ä¸éœ€è¦å®Œå…¨ç†è§£å‘½ä»¤ä¸­å‚æ•°çš„å«ä¹‰ã€‚ä½†æ˜¯å½“ä½ æƒ³åšä¸€äº›æ›´åŠ ç‰¹æ®Šçš„é™åˆ¶çš„æ—¶å€™ï¼Œï¼ˆæ¯”å¦‚åªå¯¹æŸä¸ªç‰¹å®šçš„ipç«¯å£æ·»åŠ å»¶è¿Ÿã€æˆ–è€…åªå¯¹å…¥ç«™çš„æµé‡æ·»åŠ å»¶è¿Ÿï¼‰ï¼Œäº‹æƒ…å°±å˜å¾—æœ‰äº›æ£˜æ‰‹äº†ï¼Œç®€å•çš„ç™¾åº¦è²Œä¼¼å·²ç»æ»¡è¶³ä¸äº†è¦æ±‚äº†ã€‚ä½ ä¸å¾—ä¸äº†è§£TCä¸­çš„ä¸€äº›åŸºæœ¬æ¦‚å¿µï¼Œä»¥åŠtc[2]å‘½ä»¤ä¸­ç›¸å…³å‚æ•°çš„å«ä¹‰ã€‚</p><p>æœ¬æ–‡æ­£æ˜¯å¸¦ä½ äº†è§£è¿™äº›TCä¸­çš„åŸºæœ¬æ¦‚å¿µï¼Œå¹¶é€šè¿‡ä¸€ä¸ªå®é™…ä¾‹å­ï¼Œå°†è¿™äº›æ¦‚å¿µä¸tcå‘½ä»¤è”ç³»èµ·æ¥ã€‚</p>
          </div>

<span id="more"></span>



<h2 id="ç¤ºä¾‹å‘½ä»¤"><a href="#ç¤ºä¾‹å‘½ä»¤" class="headerlink" title="ç¤ºä¾‹å‘½ä»¤"></a>ç¤ºä¾‹å‘½ä»¤</h2><p>è€ƒè™‘åˆ°è¿™æ˜¯ä¸€ä¸ªç§‘æ™®å‘çš„ä»‹ç»ï¼Œè¿™é‡Œåªä¸¾äº†ä¸€ä¸ªæœ€ç®€å•çš„ä¾‹å­ï¼Œä½†æ˜¯åŸºæœ¬ä¸ŠåŒ…å«äº†é‡è¦çš„æ¦‚å¿µã€‚æœ¬æ–‡çš„æœŸæœ›æ˜¯ï¼Œè®©è¯»è€…åœ¨é˜…è¯»åå¯ä»¥å®Œå…¨ç†è§£ä¸‹é¢çš„ä¾‹å­ï¼Œå¹¶ä¸”çŸ¥é“å¦‚ä½•æ ¹æ®è‡ªèº«çš„éœ€æ±‚ç¼–å†™è‡ªå·±çš„å‘½ä»¤ã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo tc qdisc add dev eth0 root handle 1: prio bands 4</span><br><span class="line">sudo tc qdisc add dev eth0 parent 1:4 handle 40: netem loss 10% delay 40ms</span><br><span class="line">sudo tc filter add dev eth0 protocol ip parent 1:0 prio 4 u32 match ip dst 192.168.190.7 match ip dport 36000 0xffff flowid 1:4</span><br></pre></td></tr></table></figure>



<h2 id="TCåŸºæœ¬æ¦‚å¿µ"><a href="#TCåŸºæœ¬æ¦‚å¿µ" class="headerlink" title="TCåŸºæœ¬æ¦‚å¿µ"></a>TCåŸºæœ¬æ¦‚å¿µ</h2><h3 id="QDISCS"><a href="#QDISCS" class="headerlink" title="QDISCS"></a>QDISCS</h3><p>å…¨ç§°æ˜¯queueing disciplineï¼Œæˆ‘ä»¬å§‘ä¸”ç§°å…¶ä¸ºæ’é˜Ÿè§„åˆ™å§ã€‚å®ƒæ˜¯åè®®æ ˆå’Œç½‘ç»œæ¥å£ä¹‹é—´çš„ä¸€ä¸ªç¼“å†²å±‚ã€‚ä½ å¯ä»¥åœ¨qdiscä¸Šå¯¹æ•°æ®åŒ…åšä¸€äº›ä½ æƒ³åšçš„æ“ä½œï¼Œæ¯”å¦‚åˆ†ç±»ã€æ•´å½¢ã€è°ƒåº¦ç­‰ã€‚</p>
<p>qdiscåˆ†ä¸ºæ— ç±»ï¼ˆclasslessï¼‰qdiscå’Œæœ‰ç±»ï¼ˆclassfulï¼‰qdiscã€‚æ— ç±»qdiscä¸å†å†…éƒ¨ç»†åˆ†ç±»ï¼Œæœ‰ç±»qdiscå¯è¿›ä¸€æ­¥åŒ…å«å¤šä¸ªåˆ†ç±»ï¼Œæ¯ä¸ªclassä¸Šå¯ä»¥è¿›ä¸€æ­¥åŒ…å«å­qdiscï¼Œå­qdiscä¹Ÿå¯ä»¥æ˜¯æœ‰ç±»qdiscï¼Œè¿™æ ·å°±å½¢æˆäº†æ ‘çŠ¶çš„åˆ†å±‚ç»“æ„ã€‚</p>
<h3 id="CLASSES"><a href="#CLASSES" class="headerlink" title="CLASSES"></a>CLASSES</h3><p>æœ‰ç±»qdiscå¯ä»¥æœ‰å¤šä¸ªå­ç±»ï¼ˆclassï¼‰ï¼Œæœ‰äº›qdiscé¢„å®šä¹‰äº†å­ç±»ï¼ˆå¦‚prioï¼‰ï¼Œæœ‰äº›åˆ™éœ€è¦ç”¨æˆ·æ·»åŠ ç±»ã€‚ä¸€ä¸ªç±»ä¸Šåˆå¯ä»¥é™„åŠ å…¶ä»–ç±»ã€‚æœ€æœ«ç«¯æ²¡æœ‰å­ç±»çš„ç±»ç§°ä¸ºå¶å­ç±»ï¼Œå®ƒä¸Šé¢é™„åŠ äº†ä¸€ä¸ªqdiscã€‚å½“åˆ›å»ºä¸€ä¸ªclassçš„æ—¶å€™ï¼Œé»˜è®¤ä¼šé™„åŠ ä¸€ä¸ªfifo qdiscï¼Œå®ƒåªæ˜¯ä¸€ä¸ªç®€å•çš„é˜Ÿåˆ—ï¼Œä¸å¯¹æ•°æ®åŒ…è¿›è¡Œä»»ä½•çš„æ“ä½œã€‚å½“åœ¨è¿™ä¸ªç±»ä¸Šå¢åŠ å­ç±»çš„æ—¶å€™ï¼Œè¿™ä¸ªé»˜è®¤çš„qdiscè¢«ç§»é™¤ã€‚ä½ å¯ä»¥å°†è¿™ä¸ªé»˜è®¤çš„fifo qdiscæ›¿æ¢æˆå…¶ä»–ä»»æ„ä½ æƒ³ç”¨çš„qdiscã€‚</p>
<h3 id="FILTERS"><a href="#FILTERS" class="headerlink" title="FILTERS"></a>FILTERS</h3><p>è¿‡æ»¤å™¨ï¼Œç”¨äºæœ‰ç±»qdiscä¸­ï¼Œå†³å®šå°†åŒ…å…¥é˜Ÿåˆ°å“ªä¸ªç±»ä¸­ã€‚æ¯å½“ä¸€ä¸ªåŒ…åˆ°è¾¾æœ‰å­ç±»çš„ç±»æ—¶ï¼Œå°±éœ€è¦è¿›è¡Œåˆ†ç±»ã€‚å…¶ä¸­ä¸€ç§åˆ†ç±»çš„æ–¹æ³•å°±æ˜¯ä½¿ç”¨è¿‡æ»¤å™¨ï¼ˆå¦å¤–ä¸¤ä¸ªæ˜¯ToSå’Œskb-&gt;priorityï¼‰ã€‚æ‰€æœ‰é™„åŠ åˆ°ç±»ä¸Šçš„è¿‡æ»¤å™¨ä¼šè¢«ä¾æ¬¡è°ƒç”¨ï¼Œç›´åˆ°å…¶ä¸­ä¸€ä¸ªè¿”å›è£å†³ã€‚ä¸€ä¸ªfilteråŒ…å«äº†ä¸€äº›æ¡ä»¶ï¼Œå½“ä¸€ä¸ªåŒ…åˆ°è¾¾è¯¥èŠ‚ç‚¹æ—¶ï¼Œä¼šæ ¹æ®åŒ…çš„ç‰¹å¾åˆ¤æ–­æ˜¯å¦åŒ¹é…ã€‚</p>
<p>ä»¥ä¸Š3ä¸ªæ˜¯TCä¸­æœ€åŸºæœ¬çš„3ä¸ªæ¦‚å¿µï¼Œä»»ä½•å¤æ‚çš„æµé‡æ§åˆ¶éƒ½æ˜¯é€šè¿‡è¿™ä¸ªä¸‰å…ƒç»„é€’å½’å®ç°çš„ã€‚</p>
<h2 id="å±‚çº§ç»“æ„"><a href="#å±‚çº§ç»“æ„" class="headerlink" title="å±‚çº§ç»“æ„"></a>å±‚çº§ç»“æ„</h2><p>æ¯ä¸ªæ¥å£æœ‰ä¸€ä¸ªegress â€˜root qdiscâ€™ï¼Œé»˜è®¤æ˜¯pfifo_fastã€‚æ¯ä¸ªqdiscå’Œclasséƒ½åˆ†é…ä¸€ä¸ªå¥æŸ„handleï¼Œå¥æŸ„ç”¨äºåœ¨åç»­çš„é…ç½®è¯­å¥ä¸­è¿›è¡Œå¼•ç”¨ã€‚é™¤äº†egress qdiscï¼Œä¸€ä¸ªæ¥å£ä¹Ÿå¯ä»¥æœ‰ä¸€ä¸ªingress qdiscï¼Œè´Ÿè´£ç®¡åˆ¶å…¥ç«™çš„æµé‡ã€‚ä½†æ˜¯ingress qdiscç›¸æ¯”classful qdiscå…¶å¯èƒ½æ€§æ˜¯éå¸¸æœ‰é™ã€‚ï¼ˆæ‰€ä»¥æ‰æœ‰æ‰€è°“çš„æ§å‘ä¸æ§æ”¶ï¼Œå¯¹å…¥ç«™æµé‡è¿›è¡Œæ§åˆ¶é€šå¸¸éœ€è¦å€ŸåŠ©ifb[6]æˆ–è€…imqï¼‰ã€‚</p>
<p>è¿™äº›qdiscçš„handlesæœ‰ä¸¤ä¸ªéƒ¨åˆ†ç»„æˆï¼Œä¸€ä¸ªmajoræ•°å’Œä¸€ä¸ªminoræ•°ï¼š<code>&lt;major&gt;:&lt;minor&gt;</code>ã€‚ä¹ æƒ¯ä¸Šå°†root qdiscå‘½åä¸º<code>1:</code>ï¼Œç­‰ä»·äº<code>1:0</code>ã€‚ä¸€ä¸ªqdiscçš„minoræ•°æ€»æ˜¯0ã€‚</p>
<p>å­ç±»éœ€è¦è·Ÿå®ƒä»¬çš„parentæœ‰ç›¸åŒçš„majoræ•°ã€‚majoræ•°åœ¨ä¸€ä¸ªegressæˆ–ingresså†…å¿…é¡»æ˜¯å”¯ä¸€çš„ï¼Œminoræ•°åœ¨ä¸€ä¸ªqdiscå’Œå®ƒçš„classä¸­å¿…é¡»æ˜¯å”¯ä¸€çš„ã€‚</p>
<p>ä¸€ä¸ªå…¸å‹çš„å±‚çº§ç»“æ„å¦‚ä¸‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">          1:   root qdisc</span><br><span class="line">           |</span><br><span class="line">          1:1    child class</span><br><span class="line">        /  |  \</span><br><span class="line">       /   |   \</span><br><span class="line">      /    |    \</span><br><span class="line">      /    |    \</span><br><span class="line">   1:10  1:11  1:12   child classes</span><br><span class="line">    |      |     | </span><br><span class="line">    |     11:    |    leaf class</span><br><span class="line">    |            | </span><br><span class="line">    10:         12:   qdisc</span><br><span class="line">   /   \       /   \</span><br><span class="line">10:1  10:2   12:1  12:2   leaf classes</span><br></pre></td></tr></table></figure>



<p>å†…æ ¸åªè·Ÿroot qdiscè¿›è¡Œé€šä¿¡ï¼Œæ¯å½“åŒ…éœ€è¦å…¥é˜Ÿæˆ–è€…å‡ºé˜Ÿçš„æ—¶å€™ï¼Œéƒ½éœ€è¦ä»rootèŠ‚ç‚¹å¼€å§‹ï¼Œæœ€ç»ˆåˆ°è¾¾å¶å­èŠ‚ç‚¹ï¼Œä»è€Œå†³å®šå…¥é˜Ÿåˆ°å“ªé‡Œï¼Œæˆ–è€…ä»å“ªé‡Œå‡ºé˜Ÿã€‚</p>
<p>æ¯”å¦‚å½“ä¸€ä¸ªåŒ…å…¥é˜Ÿæ—¶ï¼Œå®ƒå¯èƒ½ä¼šç»è¿‡å¦‚ä¸‹è·¯å¾„ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1: -&gt; 1:1 -&gt; 1:12 -&gt; 12: -&gt; 12:2</span><br></pre></td></tr></table></figure>

<p>å½“ç„¶ä¹Ÿå¯èƒ½ç›´æ¥èµ°å¦‚ä¸‹è·¯å¾„ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1: -&gt; 12:2</span><br></pre></td></tr></table></figure>

<p>è¿™ç§æƒ…å†µï¼Œå°±æ˜¯root qdiscä¸Šçš„è¿‡æ»¤å™¨å†³å®šæŠŠåŒ…ç›´æ¥é€åˆ°<code>12:2</code>ã€‚</p>
<span class="label warning">æ³¨æ„ï¼š</span>å…¥é˜Ÿå’Œå‡ºé˜Ÿæ—¶è™½ç„¶èŠ‚ç‚¹çš„æ‹“æ‰‘å›¾æ˜¯ä¸€æ ·çš„ï¼Œä½†æ˜¯æ¯ä¸ªèŠ‚ç‚¹è¡¨ç¤ºçš„å«ä¹‰å´æœ‰æ‰€ä¸åŒ[4]ã€‚å…¥é˜Ÿæ—¶æ˜¯æ ¹æ®è¿‡æ»¤å™¨å’ŒåŒ…çš„ç‰¹å¾å†³å®šèµ°å“ªæ¡è·¯å¾„ï¼Œè€Œå‡ºé˜Ÿæ—¶åˆ™å–å†³äºqdiscæœ¬èº«çš„è°ƒåº¦ç®—æ³•ï¼Œæ¯”å¦‚FIFOã€ä¼˜å…ˆçº§é˜Ÿåˆ—ã€SFQçš„é¡ºåºè°ƒåº¦ç­‰ã€‚



<h2 id="è¿‡æ»¤å™¨"><a href="#è¿‡æ»¤å™¨" class="headerlink" title="è¿‡æ»¤å™¨"></a>è¿‡æ»¤å™¨</h2><p>å‰é¢å·²ç»æåˆ°äº†è¿‡æ»¤å™¨ç”¨äºå°†åŒ…åˆ†ç±»åˆ°å­ç±»ï¼Œé‚£ä¹ˆå…·ä½“æ˜¯å¦‚ä½•å¯¹åŒ…è¿›è¡Œåˆ†ç±»çš„å‘¢ï¼Ÿtcæ”¯æŒå¾ˆå¤šç±»å‹çš„åˆ†ç±»å™¨ï¼Œå®ƒä»¬æ ¹æ®æ•°æ®åŒ…ç›¸å…³çš„ä¸åŒä¿¡æ¯æ¥ä½œå‡ºå†³ç­–ã€‚å…¶ä¸­æœ€å¸¸ç”¨çš„å°±æ˜¯<strong>u32åˆ†ç±»å™¨</strong>ï¼Œå®ƒæ ¹æ®æ•°æ®åŒ…ä¸­çš„å­—æ®µåšå‡ºå†³ç­–ï¼ˆä¾‹å¦‚æºIPåœ°å€ç­‰ï¼‰ã€‚è¿˜æœ‰æ¯”å¦‚<strong>fwåˆ†ç±»å™¨</strong>ï¼Œæ ¹æ®é˜²ç«å¢™å¦‚ä½•æ ‡è®°æ•°æ®åŒ…æ¥åšå‡ºå†³ç­–ï¼Œä½ å¯ä»¥ä½¿ç”¨iptablesæ ‡è®°ç›®æ ‡æ•°æ®åŒ…ï¼Œç„¶åé€šè¿‡fwåˆ†ç±»å™¨è¿›è¡Œè¿‡æ»¤ã€‚å¦å¤–è¿˜æœ‰è¯¸å¦‚<strong>routeåˆ†ç±»å™¨</strong>ã€<strong>cgroupåˆ†ç±»å™¨</strong>ã€<strong>bpfåˆ†ç±»å™¨</strong>ç­‰ï¼Œç¯‡å¹…åŸå› ä¸å†èµ˜è¿°ã€‚ä¸‹é¢ä»…ä»‹ç»æœ€å¸¸è§çš„u32åˆ†ç±»å™¨ã€‚</p>
<h3 id="å…¬å…±å‚æ•°"><a href="#å…¬å…±å‚æ•°" class="headerlink" title="å…¬å…±å‚æ•°"></a>å…¬å…±å‚æ•°</h3><p>åˆ†ç±»å™¨ä¸€èˆ¬æ¥æ”¶ä»¥ä¸‹å‡ ä¸ªå…¬å…±çš„å‚æ•°ï¼š</p>
<ul>
<li><p>protocol</p>
<p>åˆ†ç±»å™¨æ¥å—çš„åè®®ï¼Œé€šå¸¸ä½ åªæ¥å—IPæµé‡ã€‚å¿…é¡»ã€‚</p>
</li>
<li><p>parent</p>
<p>åˆ†ç±»å™¨é™„åŠ åˆ°å“ªä¸ªhandleä¸Šã€‚è¿™ä¸ªhandleå¿…é¡»æ˜¯ä¸€ä¸ªå·²ç»å­˜åœ¨çš„ç±»ã€‚å¿…é¡»ã€‚</p>
</li>
<li><p>prio|perf</p>
<p>åˆ†ç±»å™¨çš„ä¼˜å…ˆçº§ã€‚<strong>æ•°å­—è¶Šå°</strong>çš„è¶Šå…ˆè¿›è¡ŒåŒ¹é…å°è¯•ã€‚</p>
</li>
<li><p>handle</p>
<p>è¿™ä¸ªhandleå¯¹äºä¸åŒçš„è¿‡æ»¤å™¨è¡¨ç¤ºä¸åŒçš„å«ä¹‰ã€‚</p>
</li>
</ul>
<h3 id="u32åˆ†ç±»å™¨-3"><a href="#u32åˆ†ç±»å™¨-3" class="headerlink" title="u32åˆ†ç±»å™¨[3]"></a>u32åˆ†ç±»å™¨[3]</h3><p>u32è¿‡æ»¤å™¨æœ€ç®€å•çš„æ ¼å¼æ˜¯è®¾ç½®ä¸€ç»„é€‰æ‹©å™¨å¯¹åŒ…è¿›è¡ŒåŒ¹é…ï¼ŒåŒ¹é…çš„åŒ…åˆ†åˆ°ç‰¹å®šçš„å­ç±»ä¸­ï¼Œæˆ–è€…æ‰§è¡Œä¸€ä¸ªactionã€‚u32åˆ†ç±»å™¨æä¾›äº†å¤šç§ä¸åŒçš„é€‰æ‹©å™¨ï¼Œå¯ä»¥å¤§è‡´åˆ†æˆç‰¹æ®Šé€‰æ‹©å™¨å’Œé€šç”¨é€‰æ‹©å™¨ä¸¤ç±»ã€‚</p>
<h3 id="ç‰¹æ®Šé€‰æ‹©å™¨"><a href="#ç‰¹æ®Šé€‰æ‹©å™¨" class="headerlink" title="ç‰¹æ®Šé€‰æ‹©å™¨"></a>ç‰¹æ®Šé€‰æ‹©å™¨</h3><p>å¸¸ç”¨çš„æœ‰ipé€‰æ‹©å™¨å’Œtcpé€‰æ‹©å™¨ã€‚ç‰¹æ®Šé€‰æ‹©å™¨ç®€åŒ–äº†ä¸€äº›å¸¸ç”¨å­—æ®µçš„è®¾ç½®ï¼Œå¯ä»¥åŒ¹é…åŒ…å¤´ä¸­çš„å„ç§å­—æ®µï¼Œæ¯”å¦‚ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">tc filter add dev eth0 protocol ip parent 1:0 prio 10 u32 \</span><br><span class="line">	match ip src 192.168.8.0/24 flowid 1:4</span><br></pre></td></tr></table></figure>

<p>ä¸Šä¾‹åŒ¹é…ipæºåœ°å€åœ¨192.168.8.0&#x2F;24å­ç½‘çš„åŒ…ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">tc filter add dev eth0 protocol ip parent 1:0 prio 10 u32 \</span><br><span class="line">        match ip protocol 0x6 0xff \</span><br><span class="line">        match tcp dport 53 0xffff \</span><br><span class="line">        flowid 1:2</span><br></pre></td></tr></table></figure>

<p>ä¸Šä¾‹åŒ¹é…TCPåè®®ï¼ˆ0x6ï¼‰ã€ä¸”ç›®çš„ç«¯å£ä¸º53çš„åŒ…ã€‚</p>
<h3 id="é€šç”¨é€‰æ‹©å™¨"><a href="#é€šç”¨é€‰æ‹©å™¨" class="headerlink" title="é€šç”¨é€‰æ‹©å™¨"></a>é€šç”¨é€‰æ‹©å™¨</h3><p>ç‰¹æ®Šé€‰æ‹©å™¨æ€»æ˜¯å¯ä»¥æ”¹å†™æˆå¯¹åº”çš„é€šç”¨é€‰æ‹©å™¨ï¼Œé€šç”¨é€‰æ‹©å™¨å¯ä»¥åŒ¹é… IPï¼ˆæˆ–ä¸Šå±‚ï¼‰å¤´ä¸­çš„å‡ ä¹ä»»ä½•ä½ï¼Œä¸è¿‡ç›¸æ¯”ç‰¹æ®Šé€‰æ‹©å™¨è¾ƒéš¾ç¼–å†™å’Œé˜…è¯»ã€‚å…¶è¯­æ³•å¦‚ä¸‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">match [ u32 | u16 | u8 ] PATTERN MASK at [OFFSET | nexthdr+OFFSET]</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­u32|u16|u8æŒ‡å®špatternçš„é•¿åº¦ï¼Œåˆ†åˆ«ä¸º4ä¸ªå­—èŠ‚ã€2ä¸ªå­—èŠ‚ã€1ä¸ªå­—èŠ‚ã€‚PATTERNè¡¨ç¤ºåŒ¹é…çš„åŒ…çš„patternï¼ŒMASKå‘Šè¯‰è¿‡æ»¤å™¨åŒ¹é…å“ªäº›ä½ï¼Œatè¡¨ç¤ºä»åŒ…çš„æŒ‡å®šåç§»å¤„å¼€å§‹åŒ¹é…ã€‚</p>
<p>æ¥çœ‹ä¸€ä¸ªä¾‹å­ï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">tc filter add dev eth0 protocol ip parent 1:0 pref 10 u32 \</span><br><span class="line">	match u32 00100000 00ff0000 at 0 flowid 1:10</span><br></pre></td></tr></table></figure>

<p>é€‰æ‹©å™¨ä¼šåŒ¹é…IPå¤´ç¬¬äºŒä¸ªå­—èŠ‚ä¸º0x10çš„åŒ…ï¼Œ<code>at 0</code>è¡¨ç¤ºä»å¤´å¼€å§‹åŒ¹é…ï¼Œmaskä¸º<code>00ff0000</code>æ‰€ä»¥åªåŒ¹é…ç¬¬äºŒä¸ªå­—èŠ‚ï¼Œpatternä¸º<code>00100000</code>å³ç¬¬äºŒä¸ªå­—èŠ‚ä¸º0x10ã€‚</p>
<p>å†æ¥çœ‹å¦ä¸€ä¸ªä¾‹å­ï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">tc filter add dev eth0 protocol ip parent 1:0 pref 10 u32 \</span><br><span class="line">	match u32 00000016 0000ffff at nexthdr+0 flowid 1:10</span><br></pre></td></tr></table></figure>

<p><code>nexthdr</code>é€‰é¡¹è¡¨ç¤ºå°è£…åœ¨IPåŒ…é‡Œçš„ä¸‹ä¸€ä¸ªå¤´ï¼Œå³ä¸Šå±‚åè®®çš„å¤´ã€‚<code>at nexthdr+0</code>è¡¨ç¤ºä»ä¸‹ä¸€ä¸ªå¤´ç¬¬ä¸€ä¸ªå­—èŠ‚å¼€å§‹åŒ¹é…ã€‚å› ä¸ºmaskä¸º<code>0000ffff</code>ï¼Œæ‰€ä»¥åŒ¹é…å‘ç”Ÿåœ¨å¤´çš„ç¬¬ä¸‰å’Œç¬¬å››ä¸ªå­—èŠ‚ã€‚åœ¨TCPå’ŒUDPåè®®ä¸­è¿™ä¸¤ä¸ªå­—èŠ‚æ˜¯åŒ…çš„ç›®çš„ç«¯å£ã€‚æ•°å­—æ˜¯ç”±å¤§æ®µæ ¼å¼ç»™å‡ºçš„ï¼Œæ‰€ä»¥pattern <code>00000016</code>è½¬æ¢æˆåè¿›åˆ¶æ˜¯22ã€‚å³è¯¥é€‰æ‹©å™¨ä¼šåŒ¹é…ç›®çš„ç«¯å£ä¸º22çš„åŒ…ã€‚</p>
<h2 id="ç¤ºä¾‹è§£æ"><a href="#ç¤ºä¾‹è§£æ" class="headerlink" title="ç¤ºä¾‹è§£æ"></a>ç¤ºä¾‹è§£æ</h2><p>å¥½äº†ï¼Œç°åœ¨æˆ‘ä»¬å¯ä»¥å›è¿‡å¤´æ¥çœ‹æœ€åˆçš„é‚£ä¸ªç¤ºä¾‹äº†ï¼Œçœ‹çœ‹è¿™äº›å‘½ä»¤åˆ°åº•æ˜¯ä»€ä¹ˆæ„æ€ã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo tc qdisc add dev eth0 root handle 1: prio bands 4</span><br><span class="line">sudo tc qdisc add dev eth0 parent 1:4 handle 40: netem loss 10% delay 40ms</span><br><span class="line">sudo tc filter add dev eth0 protocol ip parent 1:0 prio 4 u32 match ip dst 192.168.190.7 match ip dport 36000 0xffff flowid 1:4</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬ä¸€è¡Œè¡Œæ¥çœ‹ï¼Œç¬¬ä¸€è¡Œåœ¨è®¾å¤‡eth0ä¸Šæ·»åŠ äº†ä¸€ä¸ªroot qdiscï¼Œå¥æŸ„ä¸º1:ï¼Œqdiscç±»å‹ä¸ºprioï¼Œbandsæ•°ä¸º4ã€‚</p>
<p>prioæ˜¯ä¸€ä¸ªæœ‰ç±»çš„qdiscã€‚å®ƒçš„ä½œç”¨è·Ÿé»˜è®¤çš„qdisc pfifo_fastç±»ä¼¼ã€‚pfifo_fastæœ‰ä¸‰ä¸ªæ‰€è°“çš„bandï¼Œä¸åŒbandçš„æµé‡å…·æœ‰ä¸åŒçš„ä¼˜å…ˆçº§ã€‚æ¯ä¸ªbandå†…ï¼Œåˆ™åº”ç”¨FIFOè§„åˆ™ã€‚</p>
<p>prio qdiscï¼Œé»˜è®¤ä¼šåˆ›å»º3ä¸ªå­ç±»ï¼ŒåŒ…å«çº¯FIFO qdiscï¼Œé»˜è®¤æ ¹æ®ToSä½è¿›è¡Œåˆ†ç±»ã€‚ä½ å¯ä»¥ä½¿ç”¨è¿‡æ»¤å™¨æ¥å¯¹æµé‡è¿›è¡Œåˆ†ç±»ï¼Œä½ ä¹Ÿå¯ä»¥åœ¨å­ç±»ä¸Šé™„åŠ å…¶ä»–qdiscæ›¿æ¢é»˜è®¤çš„FIFOã€‚</p>
<p>æ¥ä¸‹æ¥çœ‹ç¬¬äºŒä¸ªå‘½ä»¤ï¼Œ<code>parent 1:4</code>è¡¨ç¤ºåœ¨å­ç±»1:4ä¸Šï¼Œ<code>handle 40:</code>è¡¨ç¤ºå¥æŸ„ä¸º40:ï¼Œ<code>netem</code>è¡¨ç¤ºæ·»åŠ ä¸€ä¸ªnetem qdiscï¼Œ<code>loss 10% delay 40ms</code>åˆ™æ˜¯netemçš„å‚æ•°ï¼Œè¡¨ç¤ºä¸¢åŒ…10%ã€å»¶è¿Ÿ40msã€‚netem[5]æ˜¯ä¸€ä¸ªç”¨äºæä¾›ç½‘ç»œä»¿çœŸåŠŸèƒ½çš„æ— ç±»qdiscï¼Œå¯ä»¥æ¨¡æ‹Ÿå»¶è¿Ÿã€ä¸¢åŒ…ã€åŒ…é‡å¤ã€åŒ…å¤±åºç­‰å„ç§æƒ…å†µã€‚</p>
<p>ç¬¬ä¸‰ä¸ªå‘½ä»¤åˆ™æ˜¯æ·»åŠ äº†ä¸€ä¸ªè¿‡æ»¤å™¨ï¼Œ<code>parent 1:0</code>è¡¨ç¤ºåœ¨æ ¹èŠ‚ç‚¹ä¸Šæ·»åŠ è¯¥è¿‡æ»¤å™¨ï¼Œ<code>prio 4</code>æ˜¯è¿‡æ»¤å™¨çš„ä¼˜å…ˆçº§ï¼Œå¦‚æœæœ‰å¾ˆå¤šè¿‡æ»¤å™¨ä¼šæ ¹æ®ä¼˜å…ˆçº§çš„å€¼æŒ‰é¡ºåºè¿›è¡Œå°è¯•ã€‚<code>u32</code>è¡¨ç¤ºä½¿ç”¨u32åˆ†ç±»å™¨ã€‚<code>match ip dst 192.168.190.7</code>è¡¨ç¤ºåŒ¹é…ipåœ°å€ä¸º192.168.190.7çš„åŒ…ï¼Œ<code>match ip dport 36000 0xffff</code>è¡¨ç¤ºåŒ¹é…ç›®çš„ç«¯å£ä¸º36000çš„åŒ…ï¼Œå¤šä¸ªé€‰æ‹©å™¨ä¹‹é—´æ˜¯â€œä¸â€çš„å…³ç³»ï¼Œ<code>flowid 1:4</code>è¡¨ç¤ºå°†åŒ¹é…çš„åŒ…åˆ†ç±»åˆ°<code>1:4</code>å­ç±»ä¸­ã€‚</p>
<p>æ‰€ä»¥æœ€ç»ˆçš„æ•ˆæœæ˜¯ï¼Œå‘å¾€192.168.190.7ä¸”ç›®çš„ç«¯å£ä¸º36000çš„åŒ…ï¼Œä¼šåˆ†ç±»åˆ°1:4å­ç±»ï¼Œæ·»åŠ 40msçš„å»¶è¿Ÿï¼Œä¸”æœ‰10%çš„ä¸¢åŒ…ç‡ã€‚å…¶ä»–åŒ…åˆ™è¿˜æ˜¯é»˜è®¤çš„è¡Œä¸ºï¼Œå³æ ¹æ®ToSå­—æ®µåˆ†ç±»åˆ°1:1ã€1:2æˆ–1:3å­ç±»ä¸­ï¼Œç„¶åæ ¹æ®ä¼˜å…ˆçº§ä¾æ¬¡å‘é€ã€‚</p>
<p>ç”»å‡ºè¯¥ä¾‹å­çš„åˆ†å±‚ç»“æ„å›¾ï¼Œå¤§è‡´å¦‚ä¸‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">          1:     root qdisc (prio)</span><br><span class="line">         / | \ \</span><br><span class="line">       /   |  \  \</span><br><span class="line">       /   |   \   \</span><br><span class="line">     1:1  1:2  1:3  1:4      classes</span><br><span class="line">      |    |    |    |</span><br><span class="line">                     40:     qdiscs</span><br><span class="line">   pfifo pfifo pfifo netem</span><br><span class="line">band  0    1    2    3</span><br></pre></td></tr></table></figure>



<h2 id="åè®°"><a href="#åè®°" class="headerlink" title="åè®°"></a>åè®°</h2><p>æœ¬æ–‡åªä»‹ç»äº†tcçš„åŸºæœ¬æ¦‚å¿µå’Œç®€å•ç”¨æ³•ã€‚prio qdiscåªå¯¹åŒ…åšäº†ä¸€ä¸ªåˆ†ç±»ï¼Œå¹¶æ²¡æœ‰è¿›è¡Œæ•´å½¢ã€‚å®é™…ä¸Šï¼Œä½ ä¹Ÿå¯ä»¥ä½¿ç”¨æ›´å¤æ‚çš„å¸¦æ•´å½¢çš„qdiscï¼Œæ¯”å¦‚CBQã€HTBç­‰ï¼Œä¹Ÿå¯ä»¥å¢åŠ æ›´å¤šçš„å±‚çº§ã€‚ä½ è¿˜å¯ä»¥åœ¨å¶å­èŠ‚ç‚¹ä¸Šæ·»åŠ SFQ qdiscä»¥å®ç°ä¼šè¯çº§çš„å¸¦å®½å…¬å¹³æ€§ã€‚ç›¸ä¿¡ç†è§£äº†TCçš„è¿™äº›åŸºæœ¬æ¦‚å¿µï¼Œå†æ ¹æ®è‡ªèº«éœ€æ±‚ä½¿ç”¨å…¶ä»–qdiscä¹Ÿä¸æ˜¯ä»€ä¹ˆéš¾äº‹äº†ã€‚</p>
<h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ol>
<li><p><a href="https://lartc.org/howto/">lartc</a></p>
</li>
<li><p><a href="https://man7.org/linux/man-pages/man8/tc.8.html">tc(8)</a></p>
</li>
<li><p><a href="https://man7.org/linux/man-pages/man8/tc-u32.8.html">tc-u32(8)</a></p>
</li>
<li><p><a href="https://blog.csdn.net/dog250/article/details/40681809">æ•°æ®åŒ…çš„åˆ†ç±»å’Œè°ƒåº¦</a></p>
</li>
<li><p><a href="https://wiki.linuxfoundation.org/networking/netem">netem</a></p>
</li>
<li><p><a href="https://wiki.linuxfoundation.org/networking/ifb">ifb</a></p>
</li>
</ol>
]]></content>
      <categories>
        <category>æ“ä½œç³»ç»Ÿ</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>TC</tag>
        <tag>æµé‡æ§åˆ¶</tag>
      </tags>
  </entry>
  <entry>
    <title>Luaä¸­å¦‚ä½•å®ç°ç±»ä¼¼gdbçš„æ–­ç‚¹è°ƒè¯•--02é€šç”¨å˜é‡æ‰“å°</title>
    <url>/posts/f6e9079c/</url>
    <content><![CDATA[<div class="note primary">
            <p>åœ¨å‰ä¸€ç¯‡<a href="../f9a188a7/">01æœ€å°å®ç°</a>ä¸­ï¼Œæˆ‘ä»¬å®ç°äº†Luaæ–­ç‚¹è°ƒè¯•çš„çš„ä¸€ä¸ªæœ€å°å®ç°ã€‚æˆ‘ä»¬ç¼–å†™äº†ä¸€ä¸ªæ¨¡å—ï¼Œæä¾›äº†ä¸¤ä¸ªåŸºæœ¬çš„æ¥å£ï¼šè®¾ç½®æ–­ç‚¹å’Œåˆ é™¤æ–­ç‚¹ã€‚</p><p>è™½ç„¶æˆ‘ä»¬å·²ç»æ”¯æŒåœ¨æ–­ç‚¹è¿›è¡Œå˜é‡çš„æ‰“å°ï¼Œä½†æ˜¯éœ€è¦è‡ªå·±æŒ‡å®šå±‚æ•°ä»¥åŠå˜é‡ç´¢å¼•ï¼Œä½¿ç”¨èµ·æ¥ä¸æ˜¯å¾ˆæ–¹ä¾¿ã€‚è¦è¿›è¡Œupvalueæ‰“å°çš„è¯ï¼Œæ“ä½œä¼šæ›´åŠ éº»çƒ¦ã€‚ä¸ºäº†æå‡è°ƒè¯•çš„æ–¹ä¾¿æ€§ï¼Œæˆ‘ä»¬å†³å®šå°è£…ä¸€ä¸ªé€šç”¨çš„å˜é‡æ‰“å°å‡½æ•°ï¼Œå¯ä»¥é€šè¿‡å˜é‡åæŸ¥æ‰¾åˆ°å¯¹åº”å˜é‡çš„å€¼è¿›è¡Œæ‰“å°ã€‚æ”¯æŒå±€éƒ¨å˜é‡ã€upvalueä»¥åŠå…¨å±€çš„<code>_ENV</code>ä¸­çš„å˜é‡ã€‚</p><span id="more"></span><p>æœ¬æ–‡ä»£ç å·²å¼€æºè‡³<a href="https://github.com/catbro666/lua-debugger">Github</a>ï¼Œæ¬¢è¿watch&#x2F;starğŸ˜˜ã€‚</p>
          </div>

<h2 id="å±€éƒ¨å˜é‡ä¸­æŸ¥æ‰¾"><a href="#å±€éƒ¨å˜é‡ä¸­æŸ¥æ‰¾" class="headerlink" title="å±€éƒ¨å˜é‡ä¸­æŸ¥æ‰¾"></a>å±€éƒ¨å˜é‡ä¸­æŸ¥æ‰¾</h2><p>å› ä¸ºå‡½æ•°æ¯”è¾ƒé•¿ï¼Œæˆ‘ä»¬åˆ†å‡ éƒ¨åˆ†è¿›è¡Œè¯´æ˜ï¼Œè¯¥å‡½æ•°æœ‰ä¸‰ä¸ªå‚æ•°ï¼š<code>name</code>ä¸ºè¦æŸ¥æ‰¾çš„å˜é‡çš„åå­—ï¼Œ<code>level</code>æŒ‡ç¤ºåœ¨å“ªä¸ªå±‚çº§çš„å‡½æ•°ä¸­æŸ¥æ‰¾ï¼Œ<code>isenv</code>æ˜¯ä¸ªæ ‡è®°æˆ‘ä»¬ç¨åå†æã€‚å±‚çº§çš„é»˜è®¤å€¼ä¸º1ï¼Œ <span class="label warning">æ³¨æ„</span>å°†å±‚çº§åŠ ä¸Š1ï¼Œæ˜¯ä¸ºäº†å°†å±‚æ¬¡ä¿®æ­£ä¸ºåŒ…å«<code>_getvavalue</code>å‡½æ•°è‡ªå·±ã€‚</p>
<p>ç„¶åéå†å±€éƒ¨å˜é‡è¡¨ï¼Œæ¯”è¾ƒå˜é‡åå­—æ˜¯ä¸æ˜¯ç­‰äº<code>name</code>ï¼Œå¦‚æœåŒ¹é…çš„è¯è®°å½•å…¶å€¼ï¼Œå¹¶ä¸”æ ‡è®°ä¸€ä¸‹æˆ‘ä»¬å·²ç»æ‰¾åˆ°ã€‚<span class="label warning">æ³¨æ„</span>æˆ‘ä»¬æ‰¾åˆ°ä¹‹åå¹¶æ²¡æœ‰ç«‹é©¬è·³å‡ºå¾ªç¯ï¼Œå› ä¸ºå¯èƒ½å…·æœ‰å¤šä¸ªåŒåçš„å±€éƒ¨å˜é‡ï¼Œæˆ‘ä»¬åº”è¯¥è·å–ç´¢å¼•æœ€å¤§çš„é‚£ä¸ªã€‚</p>
<p>å¾ªç¯ç»“æŸä¹‹åï¼Œå¦‚æœå·²ç»åœ¨å±€éƒ¨å˜é‡ä¸­æ‰¾åˆ°äº†<code>name</code>ï¼Œå°±è¿”å›<code>&quot;local&quot;</code>å’Œå˜é‡çš„å€¼ã€‚</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">_getvarvalue</span> <span class="params">(name, level, isenv)</span></span></span><br><span class="line">    <span class="keyword">local</span> value</span><br><span class="line">    <span class="keyword">local</span> found = <span class="literal">false</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- åŠ 1å°†å±‚æ¬¡çº æ­£ä¸ºåŒ…æ‹¬_getvarvalueè‡ªå·±</span></span><br><span class="line">    level = (level <span class="keyword">or</span> <span class="number">1</span>) + <span class="number">1</span></span><br><span class="line">    <span class="comment">-- å°è¯•å±€éƒ¨å˜é‡</span></span><br><span class="line">    <span class="keyword">for</span> i = <span class="number">1</span>, <span class="built_in">math</span>.<span class="built_in">huge</span> <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">local</span> n, v = <span class="built_in">debug</span>.<span class="built_in">getlocal</span>(level, i)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> n <span class="keyword">then</span> <span class="keyword">break</span> <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">if</span> n == name <span class="keyword">then</span></span><br><span class="line">            value = v</span><br><span class="line">            found = <span class="literal">true</span></span><br><span class="line">            <span class="comment">-- è¿™é‡Œä¸è·³å‡ºï¼Œè·å–å…·æœ‰æœ€å¤§ç´¢å¼•çš„é‚£ä¸ªå±€éƒ¨å˜é‡</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">if</span> found <span class="keyword">then</span> <span class="keyword">return</span> <span class="string">&quot;local&quot;</span>, value <span class="keyword">end</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- çœç•¥</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h2 id="ä¸Šå€¼ä¸­æŸ¥æ‰¾"><a href="#ä¸Šå€¼ä¸­æŸ¥æ‰¾" class="headerlink" title="ä¸Šå€¼ä¸­æŸ¥æ‰¾"></a>ä¸Šå€¼ä¸­æŸ¥æ‰¾</h2><p>å¦‚æœåœ¨å±€éƒ¨å˜é‡ä¸­æ²¡æœ‰æ‰¾åˆ°ï¼Œæˆ‘ä»¬å†å°è¯•åˆ°upvalueä¸­è¿›è¡ŒæŸ¥æ‰¾ã€‚é¦–å…ˆé€šè¿‡<code>getbug.getinfo</code>è·å–åˆ°ç¬¬levelå±‚çš„å‡½æ•°ï¼Œç„¶åéå†å…¶ä¸Šå€¼ï¼Œå¦‚æœæ‰¾åˆ°åŒ¹é…çš„å˜é‡å°±è¿”å›<code>&quot;upvalue&quot;</code>å’Œå˜é‡å€¼ã€‚</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">_getvarvalue</span> <span class="params">(name, level, isenv)</span></span></span><br><span class="line">    <span class="comment">-- çœç•¥</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- å°è¯•éå±€éƒ¨å˜é‡</span></span><br><span class="line">    <span class="keyword">local</span> func = <span class="built_in">debug</span>.<span class="built_in">getinfo</span>(level, <span class="string">&quot;f&quot;</span>).func</span><br><span class="line">    <span class="keyword">for</span> i = <span class="number">1</span>, <span class="built_in">math</span>.<span class="built_in">huge</span> <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">local</span> n, v = <span class="built_in">debug</span>.<span class="built_in">getupvalue</span>(func, i)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> n <span class="keyword">then</span> <span class="keyword">break</span> <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">if</span> n == name <span class="keyword">then</span> <span class="keyword">return</span> <span class="string">&quot;upvalue&quot;</span>, v <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- çœç•¥</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h2 id="ENVè¡¨ä¸­æŸ¥æ‰¾"><a href="#ENVè¡¨ä¸­æŸ¥æ‰¾" class="headerlink" title="_ENVè¡¨ä¸­æŸ¥æ‰¾"></a>_ENVè¡¨ä¸­æŸ¥æ‰¾</h2><p>å¦‚æœåœ¨æ™®é€šçš„ä¸Šå€¼ä¸­è¿˜æ˜¯æ²¡æœ‰æ‰¾åˆ°ï¼Œæˆ‘ä»¬å°±å»<code>_ENV</code>è¡¨ä¸­æŸ¥æ‰¾ã€‚<code>isenv</code>æ ‡å¿—è¡¨ç¤ºå½“å‰<code>name</code>æ˜¯å¦å°±æ˜¯<code>&quot;_ENV&quot;</code>ï¼Œæ˜¯ç”¨æ¥é˜²æ­¢æ— é™å¾ªç¯è°ƒç”¨çš„ï¼Œç¬¬ä¸€æ¬¡è°ƒç”¨çš„æ—¶å€™è‚¯å®šä¸æ˜¯ã€‚ç„¶åå°†<code>&quot;_ENV&quot;</code>ä½œä¸º<code>name</code>é€’å½’è°ƒç”¨<code>_getvarvalue</code>ã€‚å› ä¸ºå¤šäº†ä¸€æ¬¡å‡½æ•°è°ƒç”¨ï¼Œç¬¬äºŒæ¬¡è°ƒç”¨çš„æ—¶å€™levelåˆä¼šè‡ªåŠ¨åŠ 1ã€‚æ¥ä¸‹æ¥è¿˜æ˜¯å…ˆååœ¨å±€éƒ¨å˜é‡å’Œä¸Šå€¼ä¸­æŸ¥æ‰¾ï¼Œæ‰¾åˆ°äº†å°±è¿”å›ç±»å‹å’Œå˜é‡å€¼ã€‚æ²¡æœ‰æ‰¾åˆ°çš„è¯ï¼Œè¿”å›<code>&quot;noenv&quot;</code>ã€‚</p>
<p>ç„¶åè¿”å›åˆ°å¤–å±‚çš„<code>_getvarvalue</code>ï¼Œåˆ¤æ–­ç¬¬äºŒä¸ªè¿”å›å€¼æ˜¯å¦ä¸ºçœŸï¼Œå¦‚æœæ˜¯è¯´æ˜æ‰¾åˆ°äº†<code>_ENV</code>è¡¨ï¼Œå°±ä»<code>_ENV</code>è¡¨ä¸­è·å–åä¸ºnameçš„å€¼ï¼Œå¦åˆ™ç›´æ¥è¿”å›<code>&quot;noenv&quot;</code>ã€‚</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">_getvarvalue</span> <span class="params">(name, level, isenv)</span></span></span><br><span class="line">	<span class="comment">-- çœç•¥</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> isenv <span class="keyword">then</span> <span class="keyword">return</span> <span class="string">&quot;noenv&quot;</span> <span class="keyword">end</span>	<span class="comment">-- é¿å…æ— é™å¾ªç¯</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- æ²¡æ‰¾åˆ°ï¼Œä»ç¯å¢ƒä¸­è·å–</span></span><br><span class="line">    <span class="keyword">local</span> _, env = _getvarvalue(<span class="string">&quot;_ENV&quot;</span>, level, <span class="literal">true</span>)</span><br><span class="line">    <span class="keyword">if</span> env <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;global&quot;</span>, env[name]</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;noenv&quot;</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h2 id="åŒ…è£…å‡½æ•°"><a href="#åŒ…è£…å‡½æ•°" class="headerlink" title="åŒ…è£…å‡½æ•°"></a>åŒ…è£…å‡½æ•°</h2><p><code>_getvarvalue</code>å‡½æ•°å·²ç»å®šä¹‰å¥½äº†ï¼Œæˆ‘ä»¬å†å®šä¹‰ä¸€ä¸ªåŒ…è£…å‡½æ•°<code>printvarvalue</code>ã€‚å¦‚æœç¬¬äºŒä¸ªè¿”å›å€¼ä¸ºçœŸï¼Œè¡¨ç¤ºæ‰¾åˆ°äº†å˜é‡ï¼Œå°±æ‰“å°å˜é‡ç±»å‹åŠç»“æœï¼Œå¦åˆ™æç¤ºæœªæ‰¾åˆ°ã€‚</p>
<span class="label warning">æ³¨æ„åˆ°</span>æˆ‘ä»¬è¿™é‡Œå°†`level`å±‚æ¬¡æ•°åŠ äº†4ï¼Œç›®çš„æ˜¯è·Ÿ`_getvarvalue`å‡½æ•°ä¸­ç±»ä¼¼ï¼Œä¹Ÿæ˜¯ä¸ºäº†ä¿®æ­£å±‚æ¬¡æ•°ä»¥åŒ…å«`printvarvalue`å‡½æ•°è‡ªèº«ä»¥åŠå…¶ä¸Šå±‚çš„`debug mainchunk`ã€`debug.debug`ä»¥åŠé’©å­å‡½æ•°ã€‚è¿™æ ·å½“`level`å‚æ•°ä¸º1æ—¶å°±è¡¨ç¤ºæ–­ç‚¹æ‰€åœ¨çš„å‡½æ•°ã€‚åŒæ ·åœ°ï¼Œå¦‚æœlevelä¸æŒ‡å®šé»˜è®¤ä¸º1ï¼Œå³æ–­ç‚¹æ‰€åœ¨å‡½æ•°ã€‚2è¡¨ç¤ºæ–­ç‚¹æ‰€åœ¨å‡½æ•°ä¸Šä¸€å±‚ï¼Œä»¥æ­¤ç±»æ¨ã€‚å½“ç„¶å¦‚æœä½ æœ‰ç‰¹æ®Šéœ€æ±‚ï¼Œä½ ä¹Ÿå¯ä»¥æŒ‡å®šå±‚æ¬¡ä¸º0ï¼ŒæŸ¥çœ‹hookå‡½æ•°çš„æƒ…å†µã€‚

<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- åŒ…è£… _getvarvalue, æ‰“å°ç»“æœ</span></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">printvarvalue</span> <span class="params">(name, level)</span></span></span><br><span class="line">    <span class="comment">-- levelé»˜è®¤å€¼1</span></span><br><span class="line">    <span class="comment">-- åŠ 4ï¼Œå°†å±‚æ¬¡çº æ­£ä¸ºåŒ…å« printvarvalue, debug mainchunk, debug.debugå’Œhook</span></span><br><span class="line">    level = (level <span class="keyword">or</span> <span class="number">1</span>) + <span class="number">4</span></span><br><span class="line">    <span class="keyword">local</span> where, value = _getvarvalue(name, level)</span><br><span class="line">    <span class="keyword">if</span> value <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">print</span>(where, value)</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">print</span>(name, <span class="string">&quot;not found&quot;</span>)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>æœ€åå°†<code>printvarvalue</code>å‡½æ•°ä½œä¸ºæ¨¡å—çš„å‡½æ•°è¾“å‡ºã€‚</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">return</span> &#123;</span><br><span class="line">    setbreakpoint = setbreakpoint,</span><br><span class="line">    removebreakpoint = removebreakpoint,</span><br><span class="line">    printvarvalue = printvarvalue,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="æµ‹è¯•è„šæœ¬"><a href="#æµ‹è¯•è„šæœ¬" class="headerlink" title="æµ‹è¯•è„šæœ¬"></a>æµ‹è¯•è„šæœ¬</h2><p>OKï¼Œè°ƒè¯•åº“æˆ‘ä»¬å·²ç»æ”¹å¥½äº†ï¼Œæ¥ä¸‹æ¥å°†æˆ‘ä»¬ä¹‹å‰çš„æµ‹è¯•è„šæœ¬<code>test.lua</code>ç¨åšä¿®æ”¹ã€‚åœ¨å¼€å¤´æ·»åŠ å¦‚ä¸‹ä¸€è¡Œï¼š</p>
<p><code>pv = luadebug.printvarvalue</code></p>
<p>ä¸ºäº†æ–¹ä¾¿åœ¨æ–­ç‚¹å†…éƒ¨è°ƒç”¨ï¼Œæˆ‘ä»¬å°†å…¶å†™åˆ°å…¨å±€å˜é‡é‡Œäº†ã€‚ç„¶åè°ƒæ•´ä¸‹æ–­ç‚¹çš„è¡Œå·ï¼Œæ¢ä¸€ä¸‹æ–­ç‚¹åˆ é™¤çš„é¡ºåºï¼Œå…¶ä»–å†…å®¹ä¿æŒä¸å˜ã€‚</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> luadebug = <span class="built_in">require</span> <span class="string">&quot;luadebug&quot;</span></span><br><span class="line"><span class="keyword">local</span> setbp = luadebug.setbreakpoint</span><br><span class="line"><span class="keyword">local</span> rmbp = luadebug.removebreakpoint</span><br><span class="line">pv = luadebug.printvarvalue		<span class="comment">-- å¢åŠ è¿™ä¸€è¡Œ</span></span><br><span class="line"></span><br><span class="line">g = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> u = <span class="number">2</span></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">foo</span> <span class="params">(n)</span></span></span><br><span class="line">    <span class="keyword">local</span> a = <span class="number">3</span></span><br><span class="line">    a = a + <span class="number">1</span></span><br><span class="line">    u = u + <span class="number">1</span></span><br><span class="line">    g = g + <span class="number">1</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">bar</span> <span class="params">(n)</span></span></span><br><span class="line">    n = n + <span class="number">1</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> id1 = setbp(foo, <span class="number">12</span>)		<span class="comment">-- è¡Œå·è°ƒæ•´</span></span><br><span class="line"><span class="keyword">local</span> id2 = setbp(bar, <span class="number">17</span>)		<span class="comment">-- è¡Œå·è°ƒæ•´</span></span><br><span class="line"></span><br><span class="line">foo(<span class="number">10</span>)</span><br><span class="line">bar(<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line">rmbp(id2)						<span class="comment">-- å…ˆåˆ é™¤æ–­ç‚¹2</span></span><br><span class="line"></span><br><span class="line">foo(<span class="number">20</span>)</span><br><span class="line">bar(<span class="number">20</span>)</span><br><span class="line"></span><br><span class="line">rmbp(id1)						<span class="comment">-- å†åˆ é™¤æ–­ç‚¹1</span></span><br><span class="line"></span><br><span class="line">foo(<span class="number">30</span>)</span><br><span class="line">bar(<span class="number">30</span>)</span><br></pre></td></tr></table></figure>

<h2 id="æµ‹è¯•éªŒè¯"><a href="#æµ‹è¯•éªŒè¯" class="headerlink" title="æµ‹è¯•éªŒè¯"></a>æµ‹è¯•éªŒè¯</h2><p>æ¥ä¸‹æ¥ï¼Œè®©æˆ‘ä»¬æ¥æµ‹è¯•ä¸€æŠŠã€‚å¯ä»¥çœ‹åˆ°æ— è®ºæ˜¯å±€éƒ¨å˜é‡ã€upvalueã€è¿˜æ˜¯å…¨å±€<code>_ENV</code>è¡¨ä¸­çš„å˜é‡ï¼Œéƒ½å¯ä»¥å¾ˆæ–¹ä¾¿åœ°è·å–å€¼ã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ lua test.lua</span><br><span class="line">(<span class="built_in">local</span>)foo test.lua:12</span><br><span class="line">lua_debug&gt; pv(<span class="string">&quot;a&quot;</span>)</span><br><span class="line"><span class="built_in">local</span>	4</span><br><span class="line">lua_debug&gt; pv(<span class="string">&quot;u&quot;</span>)</span><br><span class="line">upvalue	2</span><br><span class="line">lua_debug&gt; pv(<span class="string">&quot;g&quot;</span>)</span><br><span class="line">global	1</span><br><span class="line">lua_debug&gt; pv(<span class="string">&quot;x&quot;</span>)</span><br><span class="line">x	not found</span><br><span class="line">lua_debug&gt;</span><br></pre></td></tr></table></figure>

<p>ç¬¬äºŒæ¬¡åœåˆ°fooå‡½æ•°æ–­ç‚¹å¤„ï¼Œ<code>u</code>å’Œ<code>g</code>éƒ½å·²ç»åŠ 1ã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">lua_debug&gt; cont</span><br><span class="line">(<span class="built_in">local</span>)bar test.lua:17</span><br><span class="line">lua_debug&gt; cont</span><br><span class="line">(<span class="built_in">local</span>)foo test.lua:12</span><br><span class="line">lua_debug&gt; pv(<span class="string">&quot;a&quot;</span>)</span><br><span class="line"><span class="built_in">local</span>	4</span><br><span class="line">lua_debug&gt; pv(<span class="string">&quot;u&quot;</span>)</span><br><span class="line">upvalue	3</span><br><span class="line">lua_debug&gt; pv(<span class="string">&quot;g&quot;</span>)</span><br><span class="line">global	2</span><br><span class="line">lua_debug&gt;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å°è¯•æ˜¾å¼æŒ‡å®šå±‚æ•°ï¼Œç»“æœä¸€æ ·</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">lua_debug&gt; pv(<span class="string">&quot;a&quot;</span>, 1)</span><br><span class="line"><span class="built_in">local</span>	4</span><br><span class="line">lua_debug&gt; pv(<span class="string">&quot;u&quot;</span>, 1)</span><br><span class="line">upvalue	3</span><br><span class="line">lua_debug&gt; pv(<span class="string">&quot;g&quot;</span>, 1)</span><br><span class="line">global	2</span><br><span class="line">lua_debug&gt;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å†å°è¯•æ‰“å°ä¸Šä¸€å±‚çš„å˜é‡ï¼ˆå³main chunkï¼‰ï¼Œç»“æœéƒ½ç¬¦åˆé¢„æœŸã€‚å˜é‡aæ˜¯fooé‡Œçš„å±€éƒ¨å˜é‡åº”è¯¥æ‰¾ä¸åˆ°ï¼Œå˜é‡uåœ¨main chunkä¸­æ˜¯å±€éƒ¨å˜é‡ï¼Œå…¨å±€å˜é‡gåˆ™æ²¡å•¥åŒºåˆ«ã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">lua_debug&gt; pv(<span class="string">&quot;a&quot;</span>, 2)</span><br><span class="line">a	not found</span><br><span class="line">lua_debug&gt; pv(<span class="string">&quot;u&quot;</span>, 2)</span><br><span class="line"><span class="built_in">local</span>	3</span><br><span class="line">lua_debug&gt; pv(<span class="string">&quot;g&quot;</span>, 2)</span><br><span class="line">global	2</span><br></pre></td></tr></table></figure>

<p>OKï¼Œå¤§åŠŸå‘Šæˆï¼</p>
]]></content>
      <categories>
        <category>ç¼–ç¨‹å¼€å‘</category>
        <category>Lua</category>
      </categories>
      <tags>
        <tag>Lua</tag>
        <tag>è°ƒè¯•</tag>
      </tags>
  </entry>
  <entry>
    <title>Luaä¸­å¦‚ä½•å®ç°ç±»ä¼¼gdbçš„æ–­ç‚¹è°ƒè¯•--03é€šç”¨å˜é‡ä¿®æ”¹åŠè°ƒç”¨æ ˆå›æº¯</title>
    <url>/posts/a05a2f5f/</url>
    <content><![CDATA[<div class="note primary">
            <p>åœ¨å‰é¢ä¸¤ç¯‡<a href="../f9a188a7/">01æœ€å°å®ç°</a>åŠ<a href="../f6e9079c">02é€šç”¨å˜é‡æ‰“å°</a>ä¸­ï¼Œæˆ‘ä»¬å·²ç»å®ç°äº†è®¾ç½®æ–­ç‚¹ã€åˆ é™¤æ–­ç‚¹åŠé€šç”¨å˜é‡æ‰“å°æ¥å£ã€‚</p><p>æœ¬ç¯‡å°†ç»§ç»­æ–°å¢ä¸¤ä¸ªè¾…åŠ©çš„è°ƒè¯•æ¥å£ï¼šè°ƒç”¨æ ˆå›æº¯æ‰“å°æ¥å£ã€é€šç”¨å˜é‡è®¾ç½®æ¥å£ã€‚å‰è€…æ‰“å°è°ƒç”¨æ ˆçš„å›æº¯ä¿¡æ¯ï¼Œåè€…å¯ä»¥æ–¹ä¾¿åœ°ä¿®æ”¹å˜é‡çš„å€¼ï¼Œæ”¯æŒå±€éƒ¨å˜é‡ã€upvalueä»¥åŠå…¨å±€çš„<code>_ENV</code>ä¸­çš„å˜é‡ã€‚</p><span id="more"></span><p>æœ¬æ–‡ä»£ç å·²å¼€æºè‡³<a href="https://github.com/catbro666/lua-debugger">Github</a>ï¼Œæ¬¢è¿watch&#x2F;starğŸ˜˜ã€‚</p>
          </div>

<h2 id="è°ƒç”¨æ ˆæ‰“å°å‡½æ•°"><a href="#è°ƒç”¨æ ˆæ‰“å°å‡½æ•°" class="headerlink" title="è°ƒç”¨æ ˆæ‰“å°å‡½æ•°"></a>è°ƒç”¨æ ˆæ‰“å°å‡½æ•°</h2><p>æˆ‘ä»¬é¦–å…ˆæ¥å®ç°è°ƒç”¨æ ˆå›æº¯æ‰“å°æ¥å£<code>printtraceback()</code>ï¼Œè¿™ä¸ªæ¥å£æ¯”è¾ƒç®€å•ï¼Œåªæ˜¯ç®€å•åœ°åŒ…è£…äº†ä¸€ä¸‹<code>debug.traceback()</code>ï¼Œå¯¹å±‚çº§è¿›è¡Œäº†ä¸€ä¸ªä¿®æ­£ï¼Œå°±ä¸å¤šä»‹ç»äº†ã€‚</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- æ‰“å°è°ƒç”¨æ ˆçš„ä¸€ä¸ªå›æº¯</span></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">printtraceback</span><span class="params">(level)</span></span></span><br><span class="line">    <span class="comment">-- å±‚æ¬¡çš„é»˜è®¤å€¼ä¸º1</span></span><br><span class="line">    <span class="comment">-- åŠ ä¸Š4æ˜¯ä¸ºäº†ä¿®æ­£å±‚æ¬¡æ•°ä»¥åŒ…å«printtraceback, debug mainchunk, debug.debug, hook</span></span><br><span class="line">    level = (level <span class="keyword">or</span> <span class="number">1</span>) + <span class="number">4</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">debug</span>.<span class="built_in">traceback</span>(<span class="literal">nil</span>, level))</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h2 id="é€šç”¨å˜é‡å€¼ä¿®æ”¹å‡½æ•°"><a href="#é€šç”¨å˜é‡å€¼ä¿®æ”¹å‡½æ•°" class="headerlink" title="é€šç”¨å˜é‡å€¼ä¿®æ”¹å‡½æ•°"></a>é€šç”¨å˜é‡å€¼ä¿®æ”¹å‡½æ•°</h2><p>æ¥ç€æ¥å®ç°é€šç”¨çš„å˜é‡å€¼ä¿®æ”¹å‡½æ•°<code>_setvarvalue()</code>ï¼Œè¿™ä¸ªå‡½æ•°çš„ç»“æ„è·Ÿ<code>_getvarvalue()</code>ç±»ä¼¼ï¼Œä¾æ¬¡åœ¨å±€éƒ¨å˜é‡ã€ä¸Šå€¼å’Œ<code>_ENV</code>è¡¨ä¸­æŸ¥æ‰¾ï¼Œåªä¸è¿‡æ‰¾åˆ°ä¹‹åä¼šä¿®æ”¹ç›¸åº”çš„å€¼ã€‚å‡½æ•°æœ‰ä¸‰ä¸ªå‚æ•°ï¼Œ<code>name</code>ä¸ºè¦ä¿®æ”¹çš„å˜é‡çš„åå­—ï¼Œ<code>value</code>æ˜¯ä¿®æ”¹çš„ç›®æ ‡å€¼ï¼Œ<code>level</code>æŒ‡ç¤ºåœ¨å“ªä¸ªå±‚çº§çš„å‡½æ•°ä¸­æŸ¥æ‰¾ï¼Œæˆ‘ä»¬åŒæ ·åˆ†æˆå‡ éƒ¨åˆ†æ¥çœ‹ã€‚</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">_setvarvalue</span> <span class="params">(name, value, level)</span></span></span><br><span class="line">    <span class="comment">-- çœç•¥</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>



<h2 id="å±€éƒ¨å˜é‡ä¸­æŸ¥æ‰¾"><a href="#å±€éƒ¨å˜é‡ä¸­æŸ¥æ‰¾" class="headerlink" title="å±€éƒ¨å˜é‡ä¸­æŸ¥æ‰¾"></a>å±€éƒ¨å˜é‡ä¸­æŸ¥æ‰¾</h2><p>åŒæ ·åœ°ï¼Œå…ˆå¤„ç†å±‚çº§ï¼Œå±‚çº§çš„é»˜è®¤å€¼ä¸º1ï¼Œ å°†å±‚çº§åŠ ä¸Š1æ˜¯ä¸ºäº†å°†å±‚æ¬¡ä¿®æ­£ä¸ºåŒ…å«<code>_setvavalue</code>å‡½æ•°è‡ªå·±ã€‚</p>
<p>ç„¶åéå†å±€éƒ¨å˜é‡è¡¨ï¼ŒæŸ¥æ‰¾æ˜¯å¦æœ‰åå­—ä¸º<code>name</code>çš„å˜é‡ï¼Œå¦‚æœæ‰¾åˆ°çš„è¯è®°å½•å…¶ç´¢å¼•ã€‚<span class="label warning">æ³¨æ„</span>æˆ‘ä»¬æ‰¾åˆ°ä¹‹åå¹¶æ²¡æœ‰ç«‹é©¬è·³å‡ºå¾ªç¯ï¼Œå› ä¸ºå¯èƒ½å…·æœ‰å¤šä¸ªåŒåçš„å±€éƒ¨å˜é‡ï¼Œæˆ‘ä»¬åº”è¯¥è·å–ç´¢å¼•æœ€å¤§çš„é‚£ä¸ªã€‚</p>
<p>å¾ªç¯ç»“æŸä¹‹åï¼Œå¦‚æœå·²ç»åœ¨å±€éƒ¨å˜é‡ä¸­æ‰¾åˆ°äº†<code>name</code>ï¼Œå°±ä¿®æ”¹è¯¥å˜é‡çš„å€¼ä¸º<code>value</code>ï¼Œç„¶åè¿”å›<code>&quot;local&quot;</code>ï¼ŒæŒ‡ç¤ºä¿®æ”¹çš„æ˜¯å±€éƒ¨å˜é‡ã€‚</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">_setvarvalue</span> <span class="params">(name, value, level)</span></span></span><br><span class="line">    <span class="keyword">local</span> index</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- åŠ 1æ˜¯ä¸ºäº†å°†å±‚æ¬¡ä¿®æ­£äº†åŒ…å«_setvarvalueè‡ªèº«</span></span><br><span class="line">    level = (level <span class="keyword">or</span> <span class="number">1</span>) + <span class="number">1</span></span><br><span class="line">    <span class="comment">-- åœ¨å±€éƒ¨å˜é‡ä¸­æŸ¥æ‰¾</span></span><br><span class="line">    <span class="keyword">for</span> i = <span class="number">1</span>, <span class="built_in">math</span>.<span class="built_in">huge</span> <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">local</span> n, v = <span class="built_in">debug</span>.<span class="built_in">getlocal</span>(level, i)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> n <span class="keyword">then</span> <span class="keyword">break</span> <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">if</span> n == name <span class="keyword">then</span></span><br><span class="line">            index = i</span><br><span class="line">            <span class="comment">-- åªæ›´æ–°ç´¢å¼•å€¼ï¼Œå¹¶ä¸é€€å‡ºå¾ªç¯</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">if</span> index <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">debug</span>.<span class="built_in">setlocal</span>(level, index, value)</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;local&quot;</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="comment">-- çœç•¥</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>



<h2 id="ä¸Šå€¼ä¸­æŸ¥æ‰¾"><a href="#ä¸Šå€¼ä¸­æŸ¥æ‰¾" class="headerlink" title="ä¸Šå€¼ä¸­æŸ¥æ‰¾"></a>ä¸Šå€¼ä¸­æŸ¥æ‰¾</h2><p>å¦‚æœåœ¨å±€éƒ¨å˜é‡ä¸­æ²¡æœ‰æ‰¾åˆ°ï¼Œæˆ‘ä»¬å†å°è¯•åˆ°upvalueä¸­è¿›è¡ŒæŸ¥æ‰¾ã€‚é¦–å…ˆé€šè¿‡<code>getbug.getinfo</code>è·å–åˆ°ç¬¬levelå±‚çš„å‡½æ•°ï¼Œç„¶åéå†å…¶ä¸Šå€¼ï¼Œå¦‚æœæ‰¾åˆ°åŒ¹é…çš„å˜é‡å°±ä¿®æ”¹å…¶å€¼ä¸º<code>value</code>ï¼Œç„¶åè¿”å›<code>&quot;upvalue&quot;</code>ä»¥æŒ‡ç¤ºä¿®æ”¹çš„æ˜¯ä¸Šå€¼ã€‚</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">_setvarvalue</span> <span class="params">(name, value, level)</span></span></span><br><span class="line">    <span class="comment">-- çœç•¥</span></span><br><span class="line">    <span class="keyword">local</span> func = <span class="built_in">debug</span>.<span class="built_in">getinfo</span>(level, <span class="string">&quot;f&quot;</span>).func</span><br><span class="line">    <span class="keyword">for</span> i = <span class="number">1</span>, <span class="built_in">math</span>.<span class="built_in">huge</span> <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">local</span> n, v = <span class="built_in">debug</span>.<span class="built_in">getupvalue</span>(func, i)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> n <span class="keyword">then</span> <span class="keyword">break</span> <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">if</span> n == name <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">debug</span>.<span class="built_in">setupvalue</span>(func, i, value)</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;upvalue&quot;</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="comment">-- çœç•¥</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>



<h2 id="ENVè¡¨ä¸­æŸ¥æ‰¾"><a href="#ENVè¡¨ä¸­æŸ¥æ‰¾" class="headerlink" title="_ENVè¡¨ä¸­æŸ¥æ‰¾"></a>_ENVè¡¨ä¸­æŸ¥æ‰¾</h2><p>å¦‚æœåœ¨æ™®é€šçš„ä¸Šå€¼ä¸­è¿˜æ˜¯æ²¡æœ‰æ‰¾åˆ°ï¼Œæˆ‘ä»¬å°±å»<code>_ENV</code>è¡¨ä¸­æŸ¥æ‰¾ã€‚é¦–å…ˆè°ƒç”¨<code>_getvarvalue</code>è·å–åˆ°<code>_ENV</code>è¡¨ï¼Œæ³¨æ„è¿™é‡Œçš„<code>isenv</code>æ ‡å¿—ä¸º<code>true</code>ã€‚å¦‚æœå¦‚æœæ‰¾åˆ°äº†<code>_ENV</code>è¡¨ä¸”è¡¨ä¸­å­˜åœ¨åä¸º<code>name</code>çš„å˜é‡ï¼Œå°±ä¿®æ”¹å…¶å€¼ä¸º<code>value</code>ï¼Œç„¶åè¿”å›<code>&quot;global&quot;</code>ä»¥æŒ‡ç¤ºæ˜¯ä¿®æ”¹çš„<code>_ENV</code>è¡¨ä¸­çš„å€¼ã€‚å¦‚æœæ²¡æœ‰<code>_ENV</code>è¡¨æˆ–è¡¨ä¸­ä¸å­˜åœ¨è¦æ‰¾çš„å˜é‡ï¼Œå°±è¿”å›<code>nil</code>ã€‚</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">_setvarvalue</span> <span class="params">(name, value, level)</span></span></span><br><span class="line">    <span class="comment">-- çœç•¥</span></span><br><span class="line">    <span class="keyword">local</span> _, env = _getvarvalue(<span class="string">&quot;_ENV&quot;</span>, level, <span class="literal">true</span>)</span><br><span class="line">    <span class="keyword">if</span> env <span class="keyword">and</span> env[name] <span class="keyword">then</span></span><br><span class="line">        env[name] = value</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;global&quot;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>



<h2 id="åŒ…è£…å‡½æ•°"><a href="#åŒ…è£…å‡½æ•°" class="headerlink" title="åŒ…è£…å‡½æ•°"></a>åŒ…è£…å‡½æ•°</h2><p>æ¥ä¸‹æ¥æˆ‘ä»¬åŒæ ·å†å®šä¹‰ä¸€ä¸ªåŒ…è£…å‡½æ•°ï¼Œå¯¹å±‚æ¬¡æ•°<code>level</code>è¿›è¡Œä¿®æ­£ä»¥åŒ…å«<code>setvarvalue</code>å‡½æ•°è‡ªèº«ä»¥åŠå…¶ä¸Šå±‚çš„<code>debug mainchunk</code>ã€<code>debug.debug</code>ä»¥åŠé’©å­å‡½æ•°ã€‚</p>
<p>ç„¶åå¯¹è¿”å›å€¼è¿›è¡Œæ£€æŸ¥ï¼Œå¦‚æœè¿”å›å€¼ä¸ºçœŸï¼Œè¯´æ˜ä¿®æ”¹å˜é‡å€¼æˆåŠŸï¼Œå°±æ‰“å°å˜é‡ç±»å‹ï¼Œå¦åˆ™æç¤ºæœªæ‰¾åˆ°ã€‚</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">setvarvalue</span> <span class="params">(name, value, level)</span></span></span><br><span class="line">    <span class="comment">-- level é»˜è®¤å€¼ä¸º1</span></span><br><span class="line">    <span class="comment">-- åŠ 4æ˜¯ä¸ºäº†å°†å±‚æ¬¡çº æ­£ä¸ºåŒ…å« settvarvalue, debug mainchunk, debug.debugå’Œhook</span></span><br><span class="line">    level = (level <span class="keyword">or</span> <span class="number">1</span>) + <span class="number">4</span></span><br><span class="line">    <span class="keyword">local</span> where = _setvarvalue(name, value, level)</span><br><span class="line">    <span class="keyword">if</span> where <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">print</span>(where, name)</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">print</span>(name, <span class="string">&quot;not found&quot;</span>)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>æ¥å£å®šä¹‰å¥½äº†ï¼Œè®©æˆ‘ä»¬æŠŠè¿™ä¸¤ä¸ªæ¥å£ä¹Ÿæ·»åŠ åˆ°è¿”å›åˆ°è¡¨ä¸­ã€‚</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="comment">-- çœç•¥</span></span><br><span class="line">    printtraceback = printtraceback,</span><br><span class="line">    setvarvalue = setvarvalue,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="æµ‹è¯•è„šæœ¬"><a href="#æµ‹è¯•è„šæœ¬" class="headerlink" title="æµ‹è¯•è„šæœ¬"></a>æµ‹è¯•è„šæœ¬</h2><p>æ¥ä¸‹æ¥ç¼–å†™ä¸€ä¸ªæµ‹è¯•è„šæœ¬<code>test.lua</code>ä»¥å¯¹æˆ‘ä»¬æ–°æ·»åŠ çš„æ¥å£è¿›è¡Œæµ‹è¯•ã€‚è„šæœ¬å¾ˆç®€å•ï¼Œå°±ä¸å¤šåšè§£é‡Šäº†ã€‚</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> ldb = <span class="built_in">require</span> <span class="string">&quot;luadebug&quot;</span></span><br><span class="line"><span class="keyword">local</span> setbp = ldb.setbreakpoint</span><br><span class="line"><span class="keyword">local</span> rmbp = ldb.removebreakpoint</span><br><span class="line">pv = ldb.printvarvalue</span><br><span class="line">sv = ldb.setvarvalue</span><br><span class="line">ptb = ldb.printtraceback</span><br><span class="line"></span><br><span class="line">g = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> u = <span class="number">2</span></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">foo</span> <span class="params">(n)</span></span></span><br><span class="line">    <span class="keyword">local</span> a = <span class="number">3</span></span><br><span class="line">    u = u</span><br><span class="line">    g = g</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> id1 = setbp(foo, <span class="number">14</span>)</span><br><span class="line"></span><br><span class="line">foo(<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line">rmbp(id1)</span><br></pre></td></tr></table></figure>



<h2 id="æµ‹è¯•éªŒè¯"><a href="#æµ‹è¯•éªŒè¯" class="headerlink" title="æµ‹è¯•éªŒè¯"></a>æµ‹è¯•éªŒè¯</h2><p>æˆ‘ä»¬è¿è¡Œæµ‹è¯•è„šæœ¬ï¼Œé¦–å…ˆè°ƒç”¨å †æ ˆæ‰“å°å‡½æ•°ï¼Œé»˜è®¤æ˜¯æ‰“å°ä»æ–­ç‚¹æ‰€åœ¨å‡½æ•°å¼€å§‹çš„å †æ ˆã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ lua test.lua</span><br><span class="line">(<span class="built_in">local</span>)foo test.lua:14</span><br><span class="line">lua_debug&gt; ptb()</span><br><span class="line">stack traceback:</span><br><span class="line">	test.lua:14: <span class="keyword">in</span> <span class="built_in">local</span> <span class="string">&#x27;foo&#x27;</span></span><br><span class="line">	test.lua:21: <span class="keyword">in</span> main chunk</span><br><span class="line">	[C]: <span class="keyword">in</span> ?</span><br><span class="line">lua_debug&gt;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬æ˜¾å¼æŒ‡å®šå±‚æ•°è¯•ä¸€ä¸‹ã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">lua_debug&gt; ptb(2)</span><br><span class="line">stack traceback:</span><br><span class="line">	test.lua:21: <span class="keyword">in</span> main chunk</span><br><span class="line">	[C]: <span class="keyword">in</span> ?</span><br><span class="line">lua_debug&gt; ptb(0)</span><br><span class="line">stack traceback:</span><br><span class="line">	./luadebug.lua:20: <span class="keyword">in</span> hook <span class="string">&#x27;?&#x27;</span></span><br><span class="line">	test.lua:14: <span class="keyword">in</span> <span class="built_in">local</span> <span class="string">&#x27;foo&#x27;</span></span><br><span class="line">	test.lua:21: <span class="keyword">in</span> main chunk</span><br><span class="line">	[C]: <span class="keyword">in</span> ?</span><br><span class="line">lua_debug&gt;</span><br></pre></td></tr></table></figure>

<p>æ²¡æœ‰é—®é¢˜ï¼Œå±‚æ•°ä¸º2çš„æ—¶å€™å°‘æ‰“å°äº†ä¸€å±‚ï¼Œä¸º0çš„æ—¶å€™åˆ™å¤šæ‰“äº†ä¸€å±‚ã€‚</p>
<p>æˆ‘ä»¬å†æ¥æµ‹è¯•ä¸‹å˜é‡å€¼ä¿®æ”¹å‡½æ•°ï¼Œå…ˆçœ‹æ¥å˜é‡åŸæ¥çš„å€¼</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">lua_debug&gt; pv(<span class="string">&quot;a&quot;</span>)</span><br><span class="line"><span class="built_in">local</span>	3</span><br><span class="line">lua_debug&gt; pv(<span class="string">&quot;u&quot;</span>)</span><br><span class="line">upvalue	2</span><br><span class="line">lua_debug&gt; pv(<span class="string">&quot;g&quot;</span>)</span><br><span class="line">global	1</span><br><span class="line">lua_debug&gt;</span><br></pre></td></tr></table></figure>

<p>ç„¶åä¿®æ”¹å˜é‡çš„å€¼ï¼Œæˆ‘ä»¬æŠŠè¿™ä¸‰ä¸ªå˜é‡å€¼éƒ½æ”¹æˆäº†6</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">lua_debug&gt; sv(<span class="string">&quot;a&quot;</span>, 6)</span><br><span class="line"><span class="built_in">local</span>	a</span><br><span class="line">lua_debug&gt; sv(<span class="string">&quot;u&quot;</span>, 6)</span><br><span class="line">upvalue	u</span><br><span class="line">lua_debug&gt; sv(<span class="string">&quot;g&quot;</span>, 6)</span><br><span class="line">global	g</span><br><span class="line">lua_debug&gt;</span><br></pre></td></tr></table></figure>

<p>ç„¶åå†æ‰“å°ä¸‹å€¼æ£€æŸ¥ä¸‹ç»“æœï¼Œå¯ä»¥çœ‹åˆ°éƒ½ä¿®æ”¹æˆåŠŸäº†ã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">lua_debug&gt; pv(<span class="string">&quot;a&quot;</span>)</span><br><span class="line"><span class="built_in">local</span>	6</span><br><span class="line">lua_debug&gt; pv(<span class="string">&quot;u&quot;</span>)</span><br><span class="line">upvalue	6</span><br><span class="line">lua_debug&gt; pv(<span class="string">&quot;g&quot;</span>)</span><br><span class="line">global	6</span><br><span class="line">lua_debug&gt;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å†è¯•è¯•æ˜¾å¼æŒ‡å®šå±‚çº§ä¸º2ï¼Œå°†å˜é‡å€¼å†æ”¹ä¸º8</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">lua_debug&gt; sv(<span class="string">&quot;a&quot;</span>, 8, 2)</span><br><span class="line">a	not found</span><br><span class="line">lua_debug&gt; sv(<span class="string">&quot;u&quot;</span>, 8, 2)</span><br><span class="line"><span class="built_in">local</span>	u</span><br><span class="line">lua_debug&gt; sv(<span class="string">&quot;g&quot;</span>, 8, 2)</span><br><span class="line">global	g</span><br><span class="line">lua_debug&gt; pv(<span class="string">&quot;a&quot;</span>)</span><br><span class="line"><span class="built_in">local</span>	6</span><br><span class="line">lua_debug&gt; pv(<span class="string">&quot;u&quot;</span>)</span><br><span class="line">upvalue	8</span><br><span class="line">lua_debug&gt; pv(<span class="string">&quot;g&quot;</span>)</span><br><span class="line">global	8</span><br><span class="line">lua_debug&gt;</span><br></pre></td></tr></table></figure>

<p>å˜é‡aå› ä¸ºæ˜¯å‡½æ•°fooçš„å±€éƒ¨å˜é‡ï¼Œæ‰€ä»¥å¤–å±‚çœ‹ä¸åˆ°ã€‚å˜é‡uåœ¨main chunkä¸­æ˜¯å±äºå±€éƒ¨å˜é‡ï¼Œè€Œå˜é‡gåˆ™è¿˜æ˜¯å…¨å±€å˜é‡ã€‚ä¿®æ”¹ä¹‹åå˜é‡açš„ç»“æœæ²¡æœ‰å˜ï¼Œå…¶ä»–ä¸¤ä¸ªéƒ½æ”¹æˆäº†8ã€‚</p>
<p>Well doneï¼</p>
]]></content>
      <categories>
        <category>ç¼–ç¨‹å¼€å‘</category>
        <category>Lua</category>
      </categories>
      <tags>
        <tag>Lua</tag>
        <tag>è°ƒè¯•</tag>
      </tags>
  </entry>
  <entry>
    <title>Luaä¸­å¦‚ä½•å®ç°ç±»ä¼¼gdbçš„æ–­ç‚¹è°ƒè¯•--01æœ€å°å®ç°</title>
    <url>/posts/f9a188a7/</url>
    <content><![CDATA[<div class="note primary">
            <p>è¯´åˆ°Luaä»£ç è°ƒè¯•ï¼Œæœ€å¸¸ç”¨çš„æ–¹æ³•åº”è¯¥å°±æ˜¯åŠ ä¸€å †printè¿›è¡Œæ‰“å°ã€‚printå¤§æ³•è™½å¥½ï¼Œä½†å…¶ç¼ºç‚¹ä¹Ÿæ˜¯æ˜¾è€Œæ˜“è§çš„ã€‚æ¯”å¦‚æ•ˆç‡ä½ä¸‹ï¼Œéœ€è¦ä¿®æ”¹åŸæœ‰å‡½æ•°å†…éƒ¨ä»£ç ï¼Œåœ¨æ¯ä¸ªéœ€è¦çš„åœ°æ–¹æ·»åŠ printè¯­å¥ï¼Œè¿è¡Œä¸€æ¬¡åªèƒ½è·å–ä¸€æ¬¡ä¿¡æ¯ï¼Œä¸‹æ¬¡æ¢ä¸ªåœ°æ–¹åˆå¾—é‡æ–°æ·»åŠ printè¯­å¥ã€‚è€Œä¸”æœ‰æ—¶å€™ï¼Œäº‹å…ˆå¹¶ä¸çŸ¥é“è¯¥å»å“ªæ‰“å°ã€æˆ–è€…æ‰“å°ä»€ä¹ˆå†…å®¹ï¼Œéœ€è¦é€šè¿‡è¿è¡Œä¸­è·å–çš„ä¿¡æ¯æ‰èƒ½ç¡®å®šã€‚</p><p>å½“printå¤§æ³•æ— æ³•æ»¡è¶³æˆ‘ä»¬çš„éœ€æ±‚æ—¶ï¼Œå°±éœ€è¦ç±»ä¼¼æ–­ç‚¹è°ƒè¯•è¿™æ ·æ›´é«˜çº§çš„è°ƒè¯•åŠŸèƒ½ã€‚æœ¬æ–‡å°†ä»é›¶å¼€å§‹ç¼–å†™ä¸€ä¸ªLuaè°ƒè¯•å™¨ï¼Œå®ç°ç±»ä¼¼gdbçš„æ–­ç‚¹è°ƒè¯•åŠŸèƒ½ã€‚</p><p>æœ¬æ–‡ä»£ç å·²å¼€æºè‡³<a href="https://github.com/catbro666/lua-debugger">Github</a>ï¼Œæ¬¢è¿watch&#x2F;starğŸ˜˜ã€‚</p>
          </div>

<span id="more"></span>



<h2 id="å®šä¹‰æ¨¡å—åŠæ¥å£"><a href="#å®šä¹‰æ¨¡å—åŠæ¥å£" class="headerlink" title="å®šä¹‰æ¨¡å—åŠæ¥å£"></a>å®šä¹‰æ¨¡å—åŠæ¥å£</h2><p>é¦–å…ˆï¼Œæˆ‘ä»¬æ¥å®šä¹‰æ¨¡å—åŠæ¥å£ï¼Œåˆ›å»ºä¸€ä¸ªåä¸º<code>luadebug.lua</code>çš„æ¨¡å—ï¼Œè¯¥æ¨¡å—æ˜¯åŸºäºæ ‡å‡†åº“ä¸­çš„debugåº“ã€‚ä¸ºäº†å®ç°æœ€åŸºæœ¬çš„æ–­ç‚¹è°ƒè¯•åŠŸèƒ½ï¼Œæˆ‘ä»¬çš„æ¨¡å—æä¾›äº†ä¸¤ä¸ªæ¥å£<code>setbreakpoint</code>å’Œ<code>removebreakpoint</code>ï¼Œåˆ†åˆ«ç”¨äºè®¾ç½®æ–­ç‚¹å’Œåˆ é™¤æ–­ç‚¹ã€‚æ–­ç‚¹ä¿¡æ¯é€šè¿‡ä¸€ä¸ªå‡½æ•°å’Œä¸€ä¸ªè¡Œå·æŒ‡å®šï¼Œè¿”å›æ–­ç‚¹çš„idã€‚åç»­å¯ä»¥é€šè¿‡è¿™ä¸ªidæ¥åˆ é™¤ç›¸åº”æ–­ç‚¹ã€‚</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line">#!/usr/bin/env lua</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> <span class="built_in">debug</span> = <span class="built_in">require</span> <span class="string">&quot;debug&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- çœç•¥...</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">setbreakpoint</span><span class="params">(func, line)</span></span></span><br><span class="line">    <span class="comment">-- çœç•¥...</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">removebreakpoint</span><span class="params">(id)</span></span></span><br><span class="line">    <span class="comment">-- çœç•¥...</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> &#123;</span><br><span class="line">    setbreakpoint = setbreakpoint,</span><br><span class="line">    removebreakpoint = removebreakpoint,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="ç»´æŠ¤çŠ¶æ€çš„æ•°æ®ç»“æ„"><a href="#ç»´æŠ¤çŠ¶æ€çš„æ•°æ®ç»“æ„" class="headerlink" title="ç»´æŠ¤çŠ¶æ€çš„æ•°æ®ç»“æ„"></a>ç»´æŠ¤çŠ¶æ€çš„æ•°æ®ç»“æ„</h2><p>æ¥ç€ï¼Œæ¥å®šä¹‰ç»´æŠ¤çŠ¶æ€çš„æ•°æ®ç»“æ„ï¼Œè¡¨<code>status</code>ç»´æŠ¤äº†æ‰€æœ‰æ–­ç‚¹ç›¸å…³ä¿¡æ¯ï¼Œå…¶ä¸­çš„<code>bpnum</code>å…ƒç´ è¡¨ç¤ºå½“å‰æ€»å…±æœ‰å¤šå°‘æ–­ç‚¹ï¼Œ<code>bpid</code>è¡¨ç¤ºå½“å‰çš„æ–­ç‚¹idï¼Œè¿™ä¸ªå€¼æ˜¯ä¸æ–­é€’å¢çš„ï¼Œ<code>bptable</code>åˆ™æ˜¯ä¿å­˜æ‰€æœ‰æ–­ç‚¹ä¿¡æ¯çš„è¡¨ã€‚è¡¨<code>bptable</code>çš„é”®æ˜¯æ–­ç‚¹çš„idï¼Œå€¼ä¹Ÿæ˜¯ä¸€ä¸ªè¡¨ï¼Œä¿å­˜äº†æ–­ç‚¹çš„æ‰€åœ¨çš„å‡½æ•°å’Œè¡Œå·ã€‚</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- çœç•¥...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- è®°å½•æ–­ç‚¹çŠ¶æ€</span></span><br><span class="line"><span class="keyword">local</span> <span class="built_in">status</span> = &#123;&#125;</span><br><span class="line"><span class="built_in">status</span>.bpnum = <span class="number">0</span>        <span class="comment">-- å½“å‰æ€»æ–­ç‚¹æ•°</span></span><br><span class="line"><span class="built_in">status</span>.bpid = <span class="number">0</span>         <span class="comment">-- å½“å‰æ–­ç‚¹id</span></span><br><span class="line"><span class="built_in">status</span>.bptable = &#123;&#125;     <span class="comment">-- ä¿å­˜æ–­ç‚¹ä¿¡æ¯çš„è¡¨</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- çœç•¥...</span></span><br></pre></td></tr></table></figure>



<h2 id="è®¾ç½®æ–­ç‚¹æ¥å£"><a href="#è®¾ç½®æ–­ç‚¹æ¥å£" class="headerlink" title="è®¾ç½®æ–­ç‚¹æ¥å£"></a>è®¾ç½®æ–­ç‚¹æ¥å£</h2><p>æ¥ä¸‹æ¥æ¥å®šä¹‰æˆ‘ä»¬çš„<code>setbreakpoint</code>æ¥å£ã€‚è®¾ç½®æ–­ç‚¹æ—¶ï¼Œé¦–å…ˆæ£€æŸ¥å‚æ•°æœ‰æ•ˆæ€§ï¼Œå†æ›´æ–°æ–­ç‚¹idå’Œæ–­ç‚¹æ•°ï¼Œç„¶åå°†å‚æ•°ä¸­ä¼ å…¥çš„å‡½æ•°<code>func</code>å’Œè¡Œå·<code>line</code>ä¿å­˜åˆ°è¡¨<code>bptable</code>ä¸­ä¸‹ä¸€ä¸ªæ–­ç‚¹idçš„ä½ç½®ã€‚å¦‚æœåªæœ‰ä¸€ä¸ªæ–­ç‚¹ï¼ˆä»æ— åˆ°æœ‰ï¼‰ï¼Œé‚£ä¹ˆè¿˜éœ€è¦è°ƒç”¨<code>debug.sethook</code>è®¾ç½®é’©å­ã€‚è¿™æ˜¯å®ç°æ–­ç‚¹è°ƒè¯•çš„æ ¸å¿ƒå‡½æ•°ä¹‹ä¸€ï¼Œå®ƒä½¿å¾—æˆ‘ä»¬æœ‰æœºä¼šåœåœ¨æ–­ç‚¹å¤„ã€‚å› ä¸ºæ˜¯æœ€å°å®ç°ï¼Œç®€å•èµ·è§è¿™é‡Œåªè®¾ç½®äº†<code>line</code>äº‹ä»¶ã€‚</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- è®¾ç½®æ–­ç‚¹</span></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">setbreakpoint</span><span class="params">(func, line)</span></span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">type</span>(func) ~= <span class="string">&quot;function&quot;</span> <span class="keyword">or</span> <span class="built_in">type</span>(line) ~= <span class="string">&quot;number&quot;</span> <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>                      <span class="comment">--&gt; nilè¡¨ç¤ºæ— æ•ˆæ–­ç‚¹</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="built_in">status</span>.bpid = <span class="built_in">status</span>.bpid + <span class="number">1</span></span><br><span class="line">    <span class="built_in">status</span>.bpnum = <span class="built_in">status</span>.bpnum + <span class="number">1</span></span><br><span class="line">    <span class="built_in">status</span>.bptable[<span class="built_in">status</span>.bpid] = &#123;func = func, line = line&#125;</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">status</span>.bpnum == <span class="number">1</span> <span class="keyword">then</span>           <span class="comment">-- ç¬¬ä¸€ä¸ªæ–­ç‚¹</span></span><br><span class="line">        <span class="built_in">debug</span>.<span class="built_in">sethook</span>(linehook, <span class="string">&quot;l&quot;</span>)    <span class="comment">-- è®¾ç½®é’©å­</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">status</span>.bpid                  <span class="comment">--&gt; è¿”å›æ–­ç‚¹id</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>



<h2 id="é’©å­å‡½æ•°"><a href="#é’©å­å‡½æ•°" class="headerlink" title="é’©å­å‡½æ•°"></a>é’©å­å‡½æ•°</h2><p>åœ¨é’©å­å‡½æ•°ä¸­ï¼Œé€šè¿‡<code>debug.getinfo</code>è·å–åˆ°é—­åŒ…ä¿¡æ¯ï¼Œæ³¨æ„è¿™é‡Œçš„å±‚æ¬¡ä¸º2ï¼Œå› ä¸º<code>debug.getinfo()</code>å‡½æ•°æœ¬èº«çš„å±‚æ¬¡æ˜¯0ï¼Œé’©å­å‡½æ•°å±‚æ¬¡æ˜¯1ï¼Œæ–­ç‚¹æ‰€åœ¨çš„å‡½æ•°å±‚æ¬¡å³ä¸º2ã€‚ç„¶åéå†æ–­ç‚¹è¡¨ï¼Œä¸è·å–çš„é—­åŒ…ä¿¡æ¯è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœå‡½æ•°å’Œè¡Œå·éƒ½åŒ¹é…ï¼Œè¯´æ˜å‘½ä¸­æ–­ç‚¹ã€‚æˆ‘ä»¬æ‰“å°ä¸€è¡Œæç¤ºä¿¡æ¯ï¼Œç„¶åè°ƒç”¨<code>debug.debug()</code>è¿›å…¥äº¤äº’è°ƒè¯•æ¨¡å¼ï¼Œ<code>debug.debug</code>æ˜¯å®ç°æ–­ç‚¹è°ƒè¯•çš„å¦ä¸€ä¸ªæ ¸å¿ƒå‡½æ•°ï¼Œå®ƒä½¿å¾—æˆ‘ä»¬å¯ä»¥åœ¨æ–­ç‚¹å¤„è¾“å…¥ä»»æ„ä»£ç æ‰§è¡Œã€‚äº¤äº’è°ƒè¯•æ¨¡å¼ä¸€ç›´æŒç»­ï¼Œç›´åˆ°ç”¨æˆ·è¾“å…¥<code>cont</code>ä¸ºæ­¢ã€‚</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- é’©å­å‡½æ•°</span></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">linehook</span> <span class="params">(event, line)</span></span></span><br><span class="line">    <span class="keyword">local</span> info = <span class="built_in">debug</span>.<span class="built_in">getinfo</span>(<span class="number">2</span>, <span class="string">&quot;nfS&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> _, v <span class="keyword">in</span> <span class="built_in">pairs</span>(<span class="built_in">status</span>.bptable) <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">if</span> v.func == info.func <span class="keyword">and</span> v.line == line <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">local</span> prompt = <span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">&quot;(%s)%s %s:%d\n&quot;</span>,</span><br><span class="line">                info.namewhat, info.name, info.short_src, line)</span><br><span class="line">            <span class="built_in">io</span>.<span class="built_in">write</span>(prompt)</span><br><span class="line">            <span class="built_in">debug</span>.<span class="built_in">debug</span>()</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>



<h2 id="åˆ é™¤æ–­ç‚¹æ¥å£"><a href="#åˆ é™¤æ–­ç‚¹æ¥å£" class="headerlink" title="åˆ é™¤æ–­ç‚¹æ¥å£"></a>åˆ é™¤æ–­ç‚¹æ¥å£</h2><p>åˆ é™¤æ–­ç‚¹æ¯”è¾ƒç®€å•ï¼Œé¦–å…ˆæ£€æŸ¥idå‚æ•°æ˜¯å¦æœ‰æ•ˆï¼Œå¦‚æœæ— æ•ˆç›´æ¥è¿”å›ï¼Œå¦‚æœæœ‰æ•ˆåˆ™å°†æ–­ç‚¹è¡¨ä¸­ç›¸åº”idä½ç½®çš„å€¼ç½®ä¸ºnilå³å¯ï¼Œç„¶åæ›´æ–°æ–­ç‚¹æ•°ï¼Œå¦‚æœå·²ç»æ²¡æœ‰æ–­ç‚¹äº†ï¼Œåˆ™æ¸…é™¤é’©å­ã€‚</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- åˆ é™¤æ–­ç‚¹</span></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">removebreakpoint</span><span class="params">(id)</span></span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">status</span>.bptable[id] == <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="built_in">status</span>.bptable[id] = <span class="literal">nil</span></span><br><span class="line">    <span class="built_in">status</span>.bpnum = <span class="built_in">status</span>.bpnum - <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">status</span>.bpnum == <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">debug</span>.<span class="built_in">sethook</span>()                 <span class="comment">-- æ¸…é™¤é’©å­</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>è‡³æ­¤æˆ‘ä»¬çš„æ¨¡å—å°±ç¼–å†™å¥½äº†ï¼Œä¸‹é¢å¯¹è¿™ä¸ªæ¨¡å—è¿›è¡Œæµ‹è¯•ã€‚</p>
<h2 id="æµ‹è¯•è„šæœ¬"><a href="#æµ‹è¯•è„šæœ¬" class="headerlink" title="æµ‹è¯•è„šæœ¬"></a>æµ‹è¯•è„šæœ¬</h2><p>æˆ‘ä»¬ç¼–å†™ä¸€ä¸ªå¦‚ä¸‹çš„æµ‹è¯•è„šæœ¬<code>test.lua</code>ï¼Œå®šä¹‰äº†ä¸¤ä¸ªå‡½æ•°fooå’Œbarï¼Œç„¶ååˆ†åˆ«åœ¨ä¸¤ä¸ªå‡½æ•°ä¸­è®¾ç½®äº†ä¸€ä¸ªæ–­ç‚¹ï¼ˆæ³¨æ„ï¼šæ³¨é‡Šå’Œç©ºè¡Œä¸æ˜¯æœ‰æ•ˆçš„æ–­ç‚¹è¡Œï¼‰ï¼Œç„¶åå¤šæ¬¡è°ƒç”¨å‡½æ•°å¹¶å…ˆååˆ é™¤æ–­ç‚¹ï¼š</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> ldb = <span class="built_in">require</span> <span class="string">&quot;luadebug&quot;</span></span><br><span class="line"><span class="keyword">local</span> setbp = ldb.setbreakpoint</span><br><span class="line"><span class="keyword">local</span> rmbp = ldb.removebreakpoint</span><br><span class="line"></span><br><span class="line">g = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> u = <span class="number">2</span></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">foo</span> <span class="params">(n)</span></span></span><br><span class="line">    <span class="keyword">local</span> a = <span class="number">3</span></span><br><span class="line">    a = a + <span class="number">1</span></span><br><span class="line">    u = u + <span class="number">1</span></span><br><span class="line">    g = g + <span class="number">1</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">bar</span> <span class="params">(n)</span></span></span><br><span class="line">    n = n + <span class="number">1</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> id1 = setbp(foo, <span class="number">11</span>)      <span class="comment">-- è®¾ç½®æ–­ç‚¹1</span></span><br><span class="line"><span class="keyword">local</span> id2 = setbp(bar, <span class="number">16</span>)      <span class="comment">-- è®¾ç½®æ–­ç‚¹2</span></span><br><span class="line"></span><br><span class="line">foo(<span class="number">10</span>)</span><br><span class="line">bar(<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line">rmbp(id1)                       <span class="comment">-- åˆ é™¤æ–­ç‚¹1</span></span><br><span class="line"></span><br><span class="line">foo(<span class="number">20</span>)</span><br><span class="line">bar(<span class="number">20</span>)</span><br><span class="line"></span><br><span class="line">rmbp(id2)                       <span class="comment">-- åˆ é™¤æ–­ç‚¹2</span></span><br><span class="line"></span><br><span class="line">foo(<span class="number">30</span>)</span><br><span class="line">bar(<span class="number">30</span>)</span><br></pre></td></tr></table></figure>



<h2 id="æµ‹è¯•éªŒè¯"><a href="#æµ‹è¯•éªŒè¯" class="headerlink" title="æµ‹è¯•éªŒè¯"></a>æµ‹è¯•éªŒè¯</h2><p>ç„¶åæˆ‘ä»¬è¿è¡Œæµ‹è¯•è„šæœ¬ï¼Œå¯ä»¥çœ‹åˆ°ç¨‹åºåœåœ¨äº†fooå‡½æ•°çš„æ–­ç‚¹1å¤„ã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ lua test.lua</span><br><span class="line">(<span class="built_in">local</span>)foo test.lua:11</span><br><span class="line">lua_debug&gt; </span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å¯ä»¥åœ¨è¿™é‡Œæ‰“å°è°ƒç”¨æ ˆä¿¡æ¯</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ lua test.lua</span><br><span class="line">(<span class="built_in">local</span>)foo test.lua:11</span><br><span class="line">lua_debug&gt; <span class="built_in">print</span>(debug.traceback())</span><br><span class="line">stack traceback:</span><br><span class="line">	(debug <span class="built_in">command</span>):1: <span class="keyword">in</span> main chunk</span><br><span class="line">	[C]: <span class="keyword">in</span> <span class="keyword">function</span> <span class="string">&#x27;debug.debug&#x27;</span></span><br><span class="line">	./luadebug.lua:20: <span class="keyword">in</span> hook <span class="string">&#x27;?&#x27;</span></span><br><span class="line">	test.lua:11: <span class="keyword">in</span> <span class="built_in">local</span> <span class="string">&#x27;foo&#x27;</span></span><br><span class="line">	test.lua:22: <span class="keyword">in</span> main chunk</span><br><span class="line">	[C]: <span class="keyword">in</span> ?</span><br><span class="line">lua_debug&gt; </span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°fooå‡½æ•°åœ¨ç¬¬4å±‚ï¼ˆç¬¬1å±‚æ˜¯æ‰§è¡Œæˆ‘ä»¬è°ƒè¯•å‘½ä»¤çš„main chunkï¼Œç¬¬2å±‚æ˜¯<code>debug.debug</code>å‡½æ•°ï¼Œç¬¬3å±‚æ˜¯hookå‡½æ•°ï¼‰ã€‚æˆ‘ä»¬æ‰“å°fooå‡½æ•°ä¸­ç¬¬ä¸€ä¸ªå±€éƒ¨å˜é‡ï¼ˆå³å›ºå®šå‚æ•°nï¼‰çš„å€¼</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">lua_debug&gt; <span class="built_in">print</span>(debug.getlocal(4, 1))</span><br><span class="line">n	10</span><br><span class="line">lua_debug&gt;</span><br></pre></td></tr></table></figure>

<p>ç„¶åæ‰“å°ç¬¬äºŒä¸ªå±€éƒ¨å˜é‡ï¼ˆå³aï¼‰çš„å€¼</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">lua_debug&gt; <span class="built_in">print</span>(debug.getlocal(4, 2))</span><br><span class="line">a	4</span><br><span class="line">lua_debug&gt;</span><br></pre></td></tr></table></figure>

<p>ç„¶åæˆ‘ä»¬è¾“å…¥<code>cont</code>ç»§ç»­ä»£ç çš„æ‰§è¡Œï¼Œç¢°åˆ°äº†barå‡½æ•°çš„æ–­ç‚¹2</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">lua_debug&gt; cont</span><br><span class="line">(<span class="built_in">local</span>)bar test.lua:16</span><br><span class="line">lua_debug&gt;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬æ‰“å°barå‡½æ•°çš„å‚æ•°nçš„å€¼ï¼Œå¯ä»¥çœ‹åˆ°ä¹Ÿæ˜¯10</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">lua_debug&gt; <span class="built_in">print</span>(debug.getlocal(4, 1))</span><br><span class="line">n	10</span><br><span class="line">lua_debug&gt;</span><br></pre></td></tr></table></figure>

<p>ç„¶åæˆ‘ä»¬è¾“å…¥<code>cont</code>ç»§ç»­æ‰§è¡Œä»£ç ï¼Œå› ä¸ºæ–­ç‚¹1å·²ç»è¢«ç§»é™¤ï¼Œæ‰€ä»¥å†æ¬¡åœåœ¨äº†barå‡½æ•°çš„æ–­ç‚¹2å¤„</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">lua_debug&gt; cont</span><br><span class="line">(<span class="built_in">local</span>)bar test.lua:16</span><br><span class="line">lua_debug&gt;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å†æ¥æ‰“å°ä¸‹å‚æ•°nçš„å€¼ï¼Œæ­¤æ—¶å‚æ•°nçš„å€¼æ˜¯20</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">lua_debug&gt; <span class="built_in">print</span>(debug.getlocal(4, 1))</span><br><span class="line">n	20</span><br><span class="line">lua_debug&gt;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å†æ¬¡è¾“å…¥<code>cont</code>ï¼Œå› ä¸ºæ–­ç‚¹2ä¹Ÿè¢«ç§»é™¤äº†ï¼Œæ‰€ä»¥ç¬¬ä¸‰æ¬¡è°ƒç”¨<code>foo</code>å‡½æ•°å’Œ<code>bar</code>å‡½æ•°å°±æ²¡æœ‰å†ç¢°åˆ°æ–­ç‚¹ï¼Œç¨‹åºè¿è¡Œç»“æŸ</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">lua_debug&gt; cont</span><br><span class="line">$</span><br></pre></td></tr></table></figure>

<p>è¿™æ ·ä¸€ä¸ªæœ€ç®€å•çš„Luaæ–­ç‚¹è°ƒè¯•å™¨å°±å®Œæˆäº†ã€‚è™½ç„¶è¿˜æ¯”è¾ƒç®€é™‹ï¼Œä½†æ˜¯å·²ç»èƒ½å¤Ÿåº”ä»˜ä¸€äº›ç®€å•çš„è°ƒè¯•äº†ã€‚ğŸ‰</p>
]]></content>
      <categories>
        <category>ç¼–ç¨‹å¼€å‘</category>
        <category>Lua</category>
      </categories>
      <tags>
        <tag>Lua</tag>
        <tag>è°ƒè¯•</tag>
      </tags>
  </entry>
  <entry>
    <title>Luaä¸­å¦‚ä½•å®ç°ç±»ä¼¼gdbçš„æ–­ç‚¹è°ƒè¯•--04ä¼˜åŒ–é’©å­äº‹ä»¶å¤„ç†</title>
    <url>/posts/c1ecd715/</url>
    <content><![CDATA[<div class="note primary">
            <p>åœ¨ç¬¬ä¸€ç¯‡çš„<a href="../f9a188a7/">01æœ€å°å®ç°</a>ä¸­ï¼Œæˆ‘ä»¬å®ç°äº†ä¸€ä¸ªæ–­ç‚¹è°ƒè¯•çš„æœ€å°å®ç°ï¼Œåœ¨è®¾ç½®é’©å­å‡½æ•°æ—¶åªåŠ äº†lineäº‹ä»¶ï¼Œæ˜¾ç„¶è¿™ä¼šå¯¹æ€§èƒ½æœ‰å¾ˆå¤§çš„å½±å“ã€‚è€Œåæ¥ä¸¤ç¯‡<a href="../f6e9079c">02é€šç”¨å˜é‡æ‰“å°</a>å’Œ<a href="../a05a2f5f">03é€šç”¨å˜é‡ä¿®æ”¹åŠè°ƒç”¨æ ˆå›æº¯</a>åˆ™æ˜¯æä¾›äº†ä¸€äº›è¾…åŠ©çš„è°ƒè¯•æ¥å£ï¼Œå¹¶æ²¡æœ‰å¯¹é’©å­å‡½æ•°è¿›è¡Œä¿®æ”¹ã€‚</p><p>æˆ‘ä»¬æœ¬ç¯‡å°†åœ¨é’©å­ä¸­å¼•å…¥callå’Œreturnäº‹ä»¶çš„å¤„ç†ï¼Œå°è¯•å¯¹æ€§èƒ½è¿›è¡Œä¼˜åŒ–ã€‚</p><span id="more"></span><p>æºç å·²ç»ä¸Šä¼ <a href="https://github.com/catbro666/lua-debugger">Github</a>ï¼Œæ¬¢è¿watch&#x2F;starğŸ˜˜ã€‚</p>
          </div>



<h2 id="å®ç°åˆ†æ"><a href="#å®ç°åˆ†æ" class="headerlink" title="å®ç°åˆ†æ"></a>å®ç°åˆ†æ</h2><p>å½“å‰çš„å®ç°å› ä¸ºåªåŠ äº†lineäº‹ä»¶ï¼Œæ‰§è¡Œæ¯ä¸€è¡Œä»£ç éƒ½ä¼šæ‰§è¡Œé’©å­å‡½æ•°å»æŸ¥çœ‹æ˜¯å¦æœ‰æ–­ç‚¹ï¼Œè¿™æ˜¯æ²¡æœ‰å¿…è¦çš„ã€‚æˆ‘ä»¬å¯ä»¥åœ¨calläº‹ä»¶æ—¶æ£€æŸ¥å½“å‰å‡½æ•°æ˜¯å¦æœ‰æ–­ç‚¹ï¼Œåªæœ‰å½“æœ‰æ–­ç‚¹çš„æ—¶å€™æ‰åŠ å…¥lineäº‹ä»¶ã€‚é‚£æˆ‘ä»¬ä»€ä¹ˆæ—¶å€™å»æ‰lineäº‹ä»¶å‘¢ï¼Ÿæ˜¯ä¸æ˜¯é‡åˆ°returnäº‹ä»¶å°±å»æ‰å‘¢ï¼Ÿ</p>
<h3 id="è€ƒè™‘å¦‚ä¸‹åœºæ™¯"><a href="#è€ƒè™‘å¦‚ä¸‹åœºæ™¯" class="headerlink" title="è€ƒè™‘å¦‚ä¸‹åœºæ™¯"></a>è€ƒè™‘å¦‚ä¸‹åœºæ™¯</h3><p>è€ƒè™‘å¦‚ä¸‹åœºæ™¯ï¼šå‡è®¾f1è°ƒç”¨f2ï¼Œf2åˆè°ƒç”¨f3ã€‚f1ä¸­æœ‰æ–­ç‚¹ï¼Œf2æ²¡æœ‰æ–­ç‚¹ï¼Œf3æœ‰æ–­ç‚¹ã€‚å¦‚æœé‡åˆ°returnå°±å»æ‰lineäº‹ä»¶ï¼Œé‚£ä¹ˆä»f2è¿”å›åˆ°f1ä¹‹åï¼Œå°±æ— æ³•å†åœåˆ°f1åé¢çš„æ–­ç‚¹ä¸Šäº†ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">b             b</span><br><span class="line">f1 --&gt; f2 --&gt; f3</span><br><span class="line">   &lt;--    &lt;--</span><br></pre></td></tr></table></figure>

<h3 id="æ­£ç¡®çš„åšæ³•"><a href="#æ­£ç¡®çš„åšæ³•" class="headerlink" title="æ­£ç¡®çš„åšæ³•"></a>æ­£ç¡®çš„åšæ³•</h3><p>æ‰€ä»¥æ­£ç¡®çš„åšæ³•åº”è¯¥æ˜¯ï¼šcalläº‹ä»¶æ—¶ï¼Œæ ¹æ®è¢«è°ƒå‡½æ•°æ˜¯å¦æœ‰æ–­ç‚¹ï¼Œå†³å®šæ˜¯å¦åŠ lineäº‹ä»¶ï¼›returnäº‹ä»¶æ—¶ï¼Œåˆ™æ ¹æ®ä¸»è°ƒå‡½æ•°æ˜¯å¦æœ‰æ–­ç‚¹ï¼Œå†³å®šæ˜¯å¦åŠ lineäº‹ä»¶ã€‚é‚£ä¹ˆreturnæ—¶å¦‚ä½•è·å–åˆ°ä¸»è°ƒå‡½æ•°çš„ä¿¡æ¯å‘¢ï¼Ÿæˆ‘ä»¬å°±éœ€è¦åœ¨callçš„æ—¶å€™ä¿å­˜å‡½æ•°çš„ç›¸å…³ä¿¡æ¯ï¼Œç»„æˆä¸€ä¸ªé“¾è¡¨ã€‚callçš„æ—¶å€™åœ¨å°¾éƒ¨å¢åŠ ä¸€ä¸ªèŠ‚ç‚¹ï¼Œreturnçš„æ—¶å€™åˆ™å»æ‰ä¸€ä¸ªèŠ‚ç‚¹ã€‚</p>
<h2 id="æ•°æ®ç»“æ„"><a href="#æ•°æ®ç»“æ„" class="headerlink" title="æ•°æ®ç»“æ„"></a>æ•°æ®ç»“æ„</h2><p>é¦–å…ˆï¼Œåœ¨statusæ•°æ®ç»“æ„ä¸­å¢åŠ 3ä¸ªæˆå‘˜ï¼Œ<code>stackinfos</code>ç›¸å½“äºæˆ‘ä»¬å‰é¢æåˆ°çš„é“¾è¡¨ï¼ˆåªä¸è¿‡è¿™é‡Œä»¥æ•°ç»„çš„å½¢å¼å®ç°ï¼‰ï¼Œç»´æŠ¤äº†è°ƒç”¨æ ˆä¸­æ¯ä¸ªå‡½æ•°çš„ä¿¡æ¯ï¼Œè®°å½•å…¶ä¸­æ˜¯å¦æœ‰æ–­ç‚¹ï¼Œ<code>stackdepth</code>è®°å½•äº†é“¾è¡¨çš„é•¿åº¦ï¼Œæˆ–è€…è¯´æ ˆçš„æ·±åº¦ã€‚<code>funcinfos</code>ç”¨äºç¼“å­˜ä¸€äº›å‡½æ•°è°ƒè¯•ä¿¡æ¯ï¼Œä¸ç”¨æ¯æ¬¡éƒ½è°ƒç”¨<code>debug.getinfo</code>å»è·å–ã€‚</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="built_in">status</span>.stackinfos = &#123;&#125;  <span class="comment">-- table for saving stack infos</span></span><br><span class="line"><span class="built_in">status</span>.stackdepth = <span class="number">0</span>   <span class="comment">-- the depth of stack</span></span><br><span class="line"><span class="built_in">status</span>.funcinfos = &#123;&#125;   <span class="comment">-- table for caching func infos</span></span><br></pre></td></tr></table></figure>



<h2 id="é’©å­å‡½æ•°"><a href="#é’©å­å‡½æ•°" class="headerlink" title="é’©å­å‡½æ•°"></a>é’©å­å‡½æ•°</h2><p>æˆ‘ä»¬æœ¬ç¯‡æœ€ä¸»è¦çš„æ”¹åŠ¨æ˜¯é’©å­å‡½æ•°ï¼Œé™¤äº†lineäº‹ä»¶ï¼Œæˆ‘ä»¬è¿˜å¢åŠ äº†callï¼ˆæˆ–tail callï¼‰äº‹ä»¶å’Œreturnï¼ˆæˆ–tail returnï¼‰äº‹ä»¶çš„å¤„ç†ã€‚ä¸ºäº†ä»£ç çš„ç®€æ´ï¼Œç”¨å±€éƒ¨å˜é‡sæ¥è¡¨ç¤º<code>status</code>ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬åˆ†åˆ«æ¥çœ‹è¿™ä¸‰ä¸ªéƒ¨åˆ†ã€‚</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">hook</span> <span class="params">(event, line)</span></span></span><br><span class="line">    <span class="keyword">local</span> s = <span class="built_in">status</span></span><br><span class="line">    <span class="keyword">if</span> event == <span class="string">&quot;call&quot;</span> <span class="keyword">or</span> event == <span class="string">&quot;tail call&quot;</span> <span class="keyword">then</span></span><br><span class="line">        <span class="comment">-- çœç•¥</span></span><br><span class="line">    <span class="keyword">elseif</span> event == <span class="string">&quot;return&quot;</span> <span class="keyword">or</span> event == <span class="string">&quot;tail return&quot;</span> <span class="keyword">then</span></span><br><span class="line">        <span class="comment">-- çœç•¥</span></span><br><span class="line">    <span class="keyword">elseif</span> event == <span class="string">&quot;line&quot;</span> <span class="keyword">then</span></span><br><span class="line">        <span class="comment">-- çœç•¥</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>



<h2 id="calläº‹ä»¶"><a href="#calläº‹ä»¶" class="headerlink" title="calläº‹ä»¶"></a>calläº‹ä»¶</h2><p>å¦‚æœæ˜¯calläº‹ä»¶ï¼ˆæˆ–tail calläº‹ä»¶ï¼‰ï¼Œé‚£ä¹ˆå…ˆè·å–å½“å‰å‡½æ•°ï¼ŒæŸ¥çœ‹æ˜¯å¦åœ¨æ–­ç‚¹è¡¨ä¸­æœ‰æ–­ç‚¹ã€‚</p>
<p>å¦‚æœæœ‰åˆ™åœ¨<code>s.stackinfos</code>è¡¨å°¾éƒ¨æ’å…¥ä¸€ä¸ªå…ƒç´ ï¼Œå…¶ä¸­<code>hasbreak</code>å­—æ®µä¸º<code>true</code>æŒ‡ç¤ºè¯¥å‡½æ•°æœ‰æ–­ç‚¹ã€‚æ³¨æ„ï¼Œè¿™é‡Œæˆ‘ä»¬å¯¹<code>tail call</code>è¿›è¡Œäº†ä¸€ä¸ªä¼˜åŒ–ï¼Œç›´æ¥è¦†ç›–ä¸Šä¸€å±‚çš„èŠ‚ç‚¹ï¼Œåœ¨é€’å½’å°¾è°ƒç”¨æ—¶å¯ä»¥é˜²æ­¢ç©ºé—´æ— é™è†¨èƒ€ã€‚ï¼ˆLua5.1ä¸Šå› ä¸ºæ²¡æœ‰tail callå°±æ— èƒ½ä¸ºåŠ›äº†ï¼šï¼‰ã€‚ç„¶åé‡æ–°è®¾ç½®é’©å­å‡½æ•°çš„äº‹ä»¶ï¼Œå°†callã€returnå’Œlineäº‹ä»¶å…¨åŠ ä¸Šäº†ã€‚</p>
<p>å¦‚æœå½“å‰å‡½æ•°æ²¡æœ‰æ–­ç‚¹ï¼ŒåŒæ ·åœ¨<code>s.stackinfos</code>è¡¨å°¾éƒ¨æ’å…¥ä¸€ä¸ªèŠ‚ç‚¹ï¼Œä¸è¿‡å…¶ä¸­<code>hasbreak</code>å­—æ®µä¸º<code>false</code>æŒ‡ç¤ºè¯¥å±‚æ²¡æœ‰æ–­ç‚¹ã€‚åœ¨è®¾ç½®çš„é’©å­äº‹ä»¶ä¸­ï¼Œåˆ™åªä¿ç•™äº†<code>cr</code>ï¼Œå°†lineäº‹ä»¶ç§»é™¤äº†ã€‚è¿™æ ·å°±åªæœ‰æ–­ç‚¹æ‰€åœ¨çš„å‡½æ•°å†…æ‰ä¼šè§¦å‘lineäº‹ä»¶ï¼Œå¯ä»¥å¤§å¹…æå‡æ€§èƒ½ã€‚</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">hook</span> <span class="params">(event, line)</span></span></span><br><span class="line">    <span class="keyword">local</span> s = <span class="built_in">status</span></span><br><span class="line">    <span class="keyword">if</span> event == <span class="string">&quot;call&quot;</span> <span class="keyword">or</span> event == <span class="string">&quot;tail call&quot;</span> <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">local</span> func = <span class="built_in">debug</span>.<span class="built_in">getinfo</span>(<span class="number">2</span>, <span class="string">&quot;f&quot;</span>).func</span><br><span class="line">        <span class="keyword">for</span> _, v <span class="keyword">in</span> <span class="built_in">pairs</span>(s.bptable) <span class="keyword">do</span></span><br><span class="line">            <span class="comment">-- å½“å‰å‡½æ•°ä¸­æœ‰æ–­ç‚¹</span></span><br><span class="line">            <span class="keyword">if</span> v.func == func <span class="keyword">then</span></span><br><span class="line">                <span class="keyword">if</span> event == <span class="string">&quot;call&quot;</span> <span class="keyword">then</span></span><br><span class="line">                    s.stackdepth = s.stackdepth + <span class="number">1</span></span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">                s.stackinfos[s.stackdepth] =</span><br><span class="line">                    &#123;func = func, hasbreak = <span class="literal">true</span>&#125;</span><br><span class="line">                <span class="built_in">debug</span>.<span class="built_in">sethook</span>(hook, <span class="string">&quot;crl&quot;</span>)  <span class="comment">-- æ·»åŠ &quot;line&quot;äº‹ä»¶</span></span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="comment">-- å½“å‰å‡½æ•°ä¸­æ²¡æœ‰æ–­ç‚¹</span></span><br><span class="line">        <span class="keyword">if</span> event == <span class="string">&quot;call&quot;</span> <span class="keyword">then</span></span><br><span class="line">            s.stackdepth = s.stackdepth + <span class="number">1</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        s.stackinfos[s.stackdepth] = &#123;func = func, hasbreak = <span class="literal">false</span>&#125;</span><br><span class="line">        <span class="built_in">debug</span>.<span class="built_in">sethook</span>(hook, <span class="string">&quot;cr&quot;</span>)   <span class="comment">-- ç§»é™¤&quot;line&quot;äº‹ä»¶</span></span><br><span class="line">    <span class="keyword">elseif</span> event == <span class="string">&quot;return&quot;</span> <span class="keyword">or</span> event == <span class="string">&quot;tail return&quot;</span> <span class="keyword">then</span></span><br><span class="line">        <span class="comment">-- çœç•¥</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>



<h2 id="returnäº‹ä»¶"><a href="#returnäº‹ä»¶" class="headerlink" title="returnäº‹ä»¶"></a>returnäº‹ä»¶</h2><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥çœ‹returnäº‹ä»¶çš„å¤„ç†ã€‚å®ƒé¦–å…ˆåˆ é™¤<code>s.stackinfos</code>è¡¨å°¾éƒ¨çš„èŠ‚ç‚¹ï¼Œç„¶åæ£€æŸ¥å‰ä¸€ä¸ªèŠ‚ç‚¹çš„å‡½æ•°æ˜¯å¦æœ‰æ–­ç‚¹ï¼Œå¦‚æœæœ‰åˆ™æ¢å¤lineäº‹ä»¶ï¼Œå¦åˆ™ç§»é™¤lineäº‹ä»¶ã€‚</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">hook</span> <span class="params">(event, line)</span></span></span><br><span class="line">    <span class="keyword">local</span> s = <span class="built_in">status</span></span><br><span class="line">    <span class="keyword">if</span> event == <span class="string">&quot;call&quot;</span> <span class="keyword">or</span> event == <span class="string">&quot;tail call&quot;</span> <span class="keyword">then</span></span><br><span class="line">    	<span class="comment">-- çœç•¥</span></span><br><span class="line">    <span class="keyword">elseif</span> event == <span class="string">&quot;return&quot;</span> <span class="keyword">or</span> event == <span class="string">&quot;tail return&quot;</span> <span class="keyword">then</span></span><br><span class="line">        s.stackinfos[s.stackdepth] = <span class="literal">nil</span></span><br><span class="line">        s.stackdepth = s.stackdepth - <span class="number">1</span></span><br><span class="line">        <span class="comment">-- å¦‚æœä¸Šä¸€å±‚çš„å‡½æ•°æœ‰æ–­ç‚¹</span></span><br><span class="line">        <span class="keyword">if</span> s.stackdepth &gt; <span class="number">0</span> <span class="keyword">and</span> s.stackinfos[s.stackdepth].hasbreak <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">debug</span>.<span class="built_in">sethook</span>(hook, <span class="string">&quot;crl&quot;</span>)  <span class="comment">-- æ¢å¤&quot;line&quot;äº‹ä»¶</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="built_in">debug</span>.<span class="built_in">sethook</span>(hook, <span class="string">&quot;cr&quot;</span>)   <span class="comment">-- ç§»é™¤&quot;line&quot;äº‹ä»¶</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">elseif</span> event == <span class="string">&quot;line&quot;</span> <span class="keyword">then</span></span><br><span class="line">        <span class="comment">-- çœç•¥</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>



<h2 id="lineäº‹ä»¶"><a href="#lineäº‹ä»¶" class="headerlink" title="lineäº‹ä»¶"></a>lineäº‹ä»¶</h2><p>æœ€åä¸€éƒ¨åˆ†æ˜¯lineäº‹ä»¶çš„å¤„ç†ï¼Œè·Ÿä¹‹å‰æ²¡æœ‰å¤ªå¤§çš„å˜åŒ–ã€‚å®ƒéå†æ–­ç‚¹è¡¨ï¼Œå¦‚æœåŒ¹é…åˆ°æ–­ç‚¹åˆ™æ‰“å°æç¤ºä¿¡æ¯ï¼Œç„¶åè¿›å…¥ç”¨æˆ·äº¤äº’æ¨¡å¼ã€‚ä¸è¿‡è¿™é‡Œä¹Ÿåšäº†ä¸€ä¸ªå°ä¼˜åŒ–ï¼Œå°†<code>debug.getinfo</code>è·å–çš„å‡½æ•°ä¿¡æ¯ç¼“å­˜åˆ°äº†<code>status.funcinfos</code>ä¸­ï¼Œä¸‹ä¸€æ¬¡å°±å¯ä»¥ç›´æ¥ä»ç¼“å­˜ä¸­è·å–åˆ°è¯¥å‡½æ•°çš„ä¿¡æ¯ã€‚</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">hook</span> <span class="params">(event, line)</span></span></span><br><span class="line">    <span class="keyword">local</span> s = <span class="built_in">status</span></span><br><span class="line">    <span class="keyword">if</span> event == <span class="string">&quot;call&quot;</span> <span class="keyword">or</span> event == <span class="string">&quot;tail call&quot;</span> <span class="keyword">then</span></span><br><span class="line">    	<span class="comment">-- çœç•¥</span></span><br><span class="line">    <span class="keyword">elseif</span> event == <span class="string">&quot;line&quot;</span> <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">for</span> _, v <span class="keyword">in</span> <span class="built_in">pairs</span>(s.bptable) <span class="keyword">do</span></span><br><span class="line">            <span class="keyword">if</span> v.func == s.stackinfos[s.stackdepth].func</span><br><span class="line">                <span class="keyword">and</span> v.line == line <span class="keyword">then</span></span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> s.funcinfos[v.func] <span class="keyword">then</span></span><br><span class="line">                    s.funcinfos[v.func] = <span class="built_in">debug</span>.<span class="built_in">getinfo</span>(<span class="number">2</span>, <span class="string">&quot;nS&quot;</span>)</span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">                <span class="keyword">local</span> info = s.funcinfos[v.func]</span><br><span class="line">                <span class="keyword">local</span> prompt = <span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">&quot;%s (%s)%s %s:%d\n&quot;</span>,</span><br><span class="line">                    info.what, info.namewhat, info.name, info.short_src, line)</span><br><span class="line">                <span class="built_in">io</span>.<span class="built_in">write</span>(prompt)</span><br><span class="line">                <span class="built_in">debug</span>.<span class="built_in">debug</span>()</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>



<h2 id="åˆå§‹äº‹ä»¶è®¾ç½®"><a href="#åˆå§‹äº‹ä»¶è®¾ç½®" class="headerlink" title="åˆå§‹äº‹ä»¶è®¾ç½®"></a>åˆå§‹äº‹ä»¶è®¾ç½®</h2><p>hookå‡½æ•°å·²ç»ä¿®æ”¹å¥½äº†ï¼Œæˆ‘ä»¬å†è°ƒæ•´ä¸€ä¸‹<code>setbreakpoint</code>å‡½æ•°ä¸­ç¬¬ä¸€æ¬¡è®¾ç½®é’©å­æ—¶çš„è¡Œä¸ºã€‚åˆå§‹åªè®¾ç½®calläº‹ä»¶ã€‚</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">setbreakpoint</span><span class="params">(func, line)</span></span></span><br><span class="line">    <span class="comment">-- çœç•¥</span></span><br><span class="line">    <span class="keyword">if</span> s.bpnum == <span class="number">1</span> <span class="keyword">then</span>                <span class="comment">-- åªæœ‰ä¸€ä¸ªæ–­ç‚¹</span></span><br><span class="line">        <span class="built_in">debug</span>.<span class="built_in">sethook</span>(hook, <span class="string">&quot;c&quot;</span>)        <span class="comment">-- è®¾ç½®calläº‹ä»¶</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> s.bpid</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>



<h2 id="å¤æ‚åº¦åˆ†æ"><a href="#å¤æ‚åº¦åˆ†æ" class="headerlink" title="å¤æ‚åº¦åˆ†æ"></a>å¤æ‚åº¦åˆ†æ</h2><p>æˆ‘ä»¬å‡è®¾ä»£ç æ‰§è¡Œçš„æ€»è¡Œæ•°ä¸º<code>L</code>ï¼Œæ–­ç‚¹æ•°<code>N=n*b</code>ï¼Œå…¶ä¸­<code>n</code>ä¸ºæœ‰æ–­ç‚¹çš„å‡½æ•°ä¸ªæ•°ï¼Œ<code>b</code>ä¸ºå¹³å‡æ¯ä¸ªå‡½æ•°çš„æ–­ç‚¹æ•°ï¼Œæ–­ç‚¹æ‰€åœ¨å‡½æ•°å¹³å‡è¡Œæ•°ä¸º<code>l</code>ï¼Œæ–­ç‚¹æ‰€åœ¨å‡½æ•°å¹³å‡è°ƒç”¨æ¬¡æ•°ä¸º<code>c</code>ï¼Œæ€»çš„å‡½æ•°è°ƒç”¨æ¬¡æ•°<code>C</code>ã€‚</p>
<p>é‚£ä¹ˆä¼˜åŒ–å‰å¤æ‚åº¦ä¸º<code>O(L*N)</code>ï¼Œä¼˜åŒ–åçš„å¤æ‚åº¦ä¸º<code>O(C*N+c*l*N)</code></p>
<p>ä¸€èˆ¬æƒ…å†µä¸‹<code>(C+c*I) &lt;&lt; L</code>ï¼Œå› ä¸ºå³è¾¹<code>L</code>ä»£ç æ‰§è¡Œæ€»è¡Œæ•°å¯ä»¥åˆ†æˆæœ‰æ–­ç‚¹çš„å‡½æ•°æ‰§è¡Œæ€»è¡Œæ•°+æ²¡æœ‰æ–­ç‚¹çš„å‡½æ•°æ‰§è¡Œæ€»è¡Œæ•°ï¼Œè€Œå·¦è¾¹çš„<code>c*I</code>å°±æ˜¯æœ‰æ–­ç‚¹çš„å‡½æ•°æ‰§è¡Œæ€»è¡Œæ•°ï¼Œ<code>C</code>ä¸ºå‡½æ•°è°ƒç”¨æ€»æ¬¡æ•°ã€‚æ­£å¸¸æƒ…å†µä¸‹å‡½æ•°è°ƒç”¨æ€»æ¬¡æ•°è‚¯å®šæ˜¯è¿œè¿œå°äºæ²¡æœ‰æ–­ç‚¹çš„å‡½æ•°æ‰§è¡Œçš„æ€»è¡Œæ•°çš„ï¼Œæœ‰æ–­ç‚¹çš„å‡½æ•°æ‰§è¡Œæ€»è¡Œæ•°ä¹Ÿæ˜¯è¿œè¿œå°äºæ²¡æœ‰æ–­ç‚¹çš„å‡½æ•°æ‰§è¡Œæ€»è¡Œæ•°çš„ã€‚</p>
<h2 id="æµ‹è¯•æ–­ç‚¹æ˜¯å¦æ­£å¸¸"><a href="#æµ‹è¯•æ–­ç‚¹æ˜¯å¦æ­£å¸¸" class="headerlink" title="æµ‹è¯•æ–­ç‚¹æ˜¯å¦æ­£å¸¸"></a>æµ‹è¯•æ–­ç‚¹æ˜¯å¦æ­£å¸¸</h2><p>æˆ‘ä»¬ç¼–å†™å¦‚ä¸‹æµ‹è¯•è„šæœ¬ï¼Œæ¥æµ‹è¯•ä¸‹ä¹‹å‰æåˆ°çš„é‚£ç§åœºæ™¯ï¼šf1è°ƒç”¨f2ï¼Œf2åˆè°ƒç”¨f3ï¼Œf1ä¸­åŠ äº†ä¸¤ä¸ªæ–­ç‚¹ï¼Œåœ¨è°ƒç”¨f2å‰åå„æœ‰ä¸€ä¸ªï¼Œf2æ²¡æœ‰æ–­ç‚¹ï¼Œf3æœ‰æ–­ç‚¹ã€‚</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> ldb = <span class="built_in">require</span> <span class="string">&quot;luadebug&quot;</span></span><br><span class="line"><span class="keyword">local</span> setbp = ldb.setbreakpoint</span><br><span class="line"><span class="keyword">local</span> rmbp = ldb.removebreakpoint</span><br><span class="line">pv = ldb.printvarvalue</span><br><span class="line">sv = ldb.setvarvalue</span><br><span class="line">ptb = ldb.printtraceback</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">f3</span><span class="params">()</span></span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">f2</span><span class="params">()</span></span></span><br><span class="line">    f3()</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">f1</span><span class="params">()</span></span></span><br><span class="line">    f2()</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- f3ä¸­åŠ æ–­ç‚¹</span></span><br><span class="line"><span class="keyword">local</span> id1 = setbp(f3, <span class="number">9</span>)</span><br><span class="line"><span class="comment">-- f2ä¸åŠ æ–­ç‚¹</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- f1ä¸­åœ¨è°ƒç”¨f2å‰åå„åŠ ä¸€ä¸ªæ–­ç‚¹</span></span><br><span class="line"><span class="keyword">local</span> id2 = setbp(f1, <span class="number">16</span>)</span><br><span class="line"><span class="keyword">local</span> id3 = setbp(f1, <span class="number">17</span>)</span><br><span class="line"></span><br><span class="line">f1()</span><br><span class="line"></span><br><span class="line">rmbp(id1)</span><br><span class="line">rmbp(id2)</span><br><span class="line">rmbp(id3)</span><br></pre></td></tr></table></figure>

<p>ç„¶åæ¥è¿è¡Œæµ‹è¯•è„šæœ¬éªŒè¯ä¸€ä¸‹ã€‚é¦–å…ˆåœåœ¨äº†f1å‡½æ•°ç¬¬16è¡Œï¼ˆè°ƒç”¨f2ä¹‹å‰ï¼‰ï¼Œç„¶å<code>cont</code>ç»§ç»­æ‰§è¡Œï¼Œåœåœ¨äº†å‡½æ•°f3çš„æ–­ç‚¹å¤„ï¼Œå†æ¬¡<code>cont</code>ç»§ç»­ï¼Œå‡½æ•°åœåœ¨äº†f1å‡½æ•°ç¬¬17è¡Œï¼ˆè°ƒç”¨f2ä¹‹åï¼‰ã€‚å¯è§æ–­ç‚¹èƒ½æ­£å¸¸å·¥ä½œ</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ lua test.lua</span><br><span class="line">Lua (<span class="built_in">local</span>)f1 test.lua:16</span><br><span class="line">lua_debug&gt; cont</span><br><span class="line">Lua (upvalue)f3 test.lua:9</span><br><span class="line">lua_debug&gt; cont</span><br><span class="line">Lua (<span class="built_in">local</span>)f1 test.lua:17</span><br><span class="line">lua_debug&gt; cont</span><br></pre></td></tr></table></figure>



<h2 id="æµ‹è¯•tail-callä¼˜åŒ–"><a href="#æµ‹è¯•tail-callä¼˜åŒ–" class="headerlink" title="æµ‹è¯•tail callä¼˜åŒ–"></a>æµ‹è¯•tail callä¼˜åŒ–</h2><p>æˆ‘ä»¬å†æ¥æµ‹è¯•ä¸‹tail callçš„ä¼˜åŒ–ï¼Œç¼–å†™å¦‚ä¸‹æµ‹è¯•è„šæœ¬ã€‚æˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªå°¾è°ƒç”¨é€’å½’çš„å‡½æ•°fooï¼Œç„¶åå†å…¶ä»–å‡½æ•°ä¸Šéšä¾¿åŠ äº†ä¸€ä¸ªæ–­ç‚¹ï¼ˆä¸ºäº†è®¾ç½®hookï¼‰ã€‚ç„¶åæˆ‘ä»¬fooå‡½æ•°ä¸€ç›´é€’å½’è°ƒç”¨ã€‚</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> ldb = <span class="built_in">require</span> <span class="string">&quot;luadebug&quot;</span></span><br><span class="line"><span class="keyword">local</span> setbp = ldb.setbreakpoint</span><br><span class="line"><span class="keyword">local</span> rmbp = ldb.removebreakpoint</span><br><span class="line">pv = ldb.printvarvalue</span><br><span class="line">sv = ldb.setvarvalue</span><br><span class="line">ptb = ldb.printtraceback</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">foo</span><span class="params">(n)</span></span></span><br><span class="line">    <span class="keyword">if</span> n == <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> foo(n<span class="number">-1</span>)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">bar</span><span class="params">()</span></span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- add a break in bar</span></span><br><span class="line"><span class="keyword">local</span> id1 = setbp(bar, <span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">foo(<span class="number">100000000000</span>)</span><br><span class="line"></span><br><span class="line">rmbp(id1)</span><br></pre></td></tr></table></figure>

<h3 id="Lua5-1æµ‹è¯•"><a href="#Lua5-1æµ‹è¯•" class="headerlink" title="Lua5.1æµ‹è¯•"></a>Lua5.1æµ‹è¯•</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ lua5.1 test2.lua</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>ç”¨Lua5.1è¿è¡Œä¸Šé¢çš„æµ‹è¯•è„šæœ¬ï¼Œå†…å­˜å ç”¨ä¸€ç›´åœ¨é£™å‡ï¼Œæˆ‘åªæµ‹è¯•äº†ä¸€å°ä¼šï¼Œå°±å·²ç»é£™åˆ°8Gäº†ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/catbro666/catbro666.github.io/posts/c1ecd715/lua5.1-call.jpg" alt="lua5.1-call" loading="lazy"></p>
<h3 id="Lua5-3æµ‹è¯•"><a href="#Lua5-3æµ‹è¯•" class="headerlink" title="Lua5.3æµ‹è¯•"></a>Lua5.3æµ‹è¯•</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ lua5.3 test2.lua</span><br></pre></td></tr></table></figure>

<p>ç”¨Lua5.3è¿è¡Œä¸Šé¢çš„æµ‹è¯•è„šæœ¬ï¼Œå› ä¸ºæœ‰å°¾è°ƒç”¨çš„ä¼˜åŒ–ï¼Œå†…å­˜å ç”¨ä¸€ç›´ä¿æŒåœ¨720KBã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/catbro666/catbro666.github.io/posts/c1ecd715/lua5.3-tail-call.jpg" alt="lua5.3-tail-call" loading="lazy"></p>
<p>ç»†å¿ƒçš„åŒå­¦å¯èƒ½å·²ç»å‘ç°äº†ï¼Œæˆ‘ä»¬çš„hookå‡½æ•°ä¸­calläº‹ä»¶å’Œlineéƒ½éœ€è¦å¯¹æ•´ä¸ªæ–­ç‚¹è¡¨è¿›è¡Œéå†ï¼Œè¿™å…¶ä¸­å…¶å®æ˜¯å­˜åœ¨ç€ä¸€äº›å†—ä½™çš„ã€‚å› ä¸ºç¯‡å¹…åŸå› ï¼Œæˆ‘ä»¬æ”¾åˆ°ä¸‹å›åˆ†è§£ã€‚</p>
]]></content>
      <categories>
        <category>ç¼–ç¨‹å¼€å‘</category>
        <category>Lua</category>
      </categories>
      <tags>
        <tag>Lua</tag>
        <tag>è°ƒè¯•</tag>
      </tags>
  </entry>
  <entry>
    <title>Luaä¸­å¦‚ä½•å®ç°ç±»ä¼¼gdbçš„æ–­ç‚¹è°ƒè¯•--05ä¼˜åŒ–æ–­ç‚¹ä¿¡æ¯æ•°æ®ç»“æ„</title>
    <url>/posts/2e777dd3/</url>
    <content><![CDATA[<div class="note primary">
            <p>åœ¨ä¸Šä¸€ç¯‡<a href="../c1ecd715/">04ä¼˜åŒ–é’©å­äº‹ä»¶å¤„ç†</a>ä¸­ï¼Œæˆ‘ä»¬åœ¨é’©å­å‡½æ•°ä¸­å¼•å…¥äº†callå’Œreturnäº‹ä»¶çš„å¤„ç†ï¼Œå¯¹æ€§èƒ½è¿›è¡Œäº†ä¼˜åŒ–ã€‚</p><p>ç»†å¿ƒçš„åŒå­¦å¯èƒ½å·²ç»å‘ç°äº†ï¼Œæˆ‘ä»¬çš„hookå‡½æ•°ä¸­calläº‹ä»¶å’Œlineéƒ½éœ€è¦å¯¹æ•´ä¸ªæ–­ç‚¹è¡¨è¿›è¡Œéå†ï¼Œè¿™å…¶ä¸­å…¶å®æ˜¯å­˜åœ¨ç€ä¸€äº›å†—ä½™çš„ã€‚å› ä¸ºcalläº‹ä»¶åªå…³å¿ƒå‡½æ•°æ˜¯å¦æœ‰æ–­ç‚¹ï¼Œè€Œlineäº‹ä»¶åˆ™åªå…³å¿ƒæœ¬å‡½æ•°å†…æœ‰å“ªäº›æ–­ç‚¹ã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥æƒ³åŠæ³•ä¼˜åŒ–ä¸€ä¸‹æ–­ç‚¹ä¿¡æ¯çš„æ•°æ®ç»“æ„ï¼Œè¿›ä¸€æ­¥æå‡æ€§èƒ½ã€‚</p><span id="more"></span><p>æºç å·²ç»ä¸Šä¼ <a href="https://github.com/catbro666/lua-debugger">Github</a>ï¼Œæ¬¢è¿watch&#x2F;starğŸ˜˜ã€‚</p>
          </div>



<h2 id="å®ç°åˆ†æ"><a href="#å®ç°åˆ†æ" class="headerlink" title="å®ç°åˆ†æ"></a>å®ç°åˆ†æ</h2><p>åŸæ¥çš„æ–­ç‚¹è¡¨<code>status.bptable</code>æ˜¯ä»¥æ–­ç‚¹idä¸ºé”®çš„æ•°ç»„ï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡æ–­ç‚¹idæ¥å¿«é€Ÿåˆ é™¤æ–­ç‚¹ï¼Œæ‰€ä»¥<code>status.bptable</code>è¡¨è¿˜æ˜¯ä¿ç•™ã€‚</p>
<p>ä½†æ˜¯åœ¨é’©å­å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬å¹¶ä¸å…³å¿ƒæ–­ç‚¹çš„idï¼Œç›¸åæˆ‘ä»¬å…³å¿ƒæ–­ç‚¹å±äºå“ªä¸ªå‡½æ•°ã€‚åªæœ‰å½“ç¨‹åºæ‰§è¡Œåˆ°æœ‰æ–­ç‚¹çš„å‡½æ•°æ—¶ï¼Œæˆ‘ä»¬æ‰éœ€è¦å¤„ç†lineäº‹ä»¶ã€‚æ‰€ä»¥ï¼Œå¾ˆè‡ªç„¶åœ°å¯ä»¥æƒ³åˆ°ï¼Œæˆ‘ä»¬åº”è¯¥æ–°å¢ä¸€ä¸ªä»¥å‡½æ•°ä¸ºé”®çš„æ–­ç‚¹è¡¨ã€‚æˆ‘ä»¬æŠŠè¿™ä¸ªæ–°è¡¨å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="built_in">status</span>.funcbpt = &#123;&#125;     <span class="comment">-- ä»¥å‡½æ•°ä¸ºé”®çš„æ–­ç‚¹è¡¨</span></span><br></pre></td></tr></table></figure>

<p>é‚£ä¹ˆæ–°è¡¨çš„å€¼åº”è¯¥æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿå› ä¸ºä¸€ä¸ªå‡½æ•°ä¸­å¯èƒ½æœ‰å¤šä¸ªæ–­ç‚¹ï¼Œè€Œåœ¨lineäº‹ä»¶ä¸­æˆ‘ä»¬åˆéœ€è¦æ¯”è¾ƒå½“å‰è¡Œæ˜¯å¦æ˜¯æ–­ç‚¹è¡Œï¼Œæ‰€ä»¥æˆ‘ä»¬æŠŠæ–°è¡¨<code>status.funcbpt</code>çš„å€¼ä¹Ÿè®¾è®¡æˆä¸€ä¸ªè¡¨ï¼Œè¯¥è¡¨çš„é”®æ˜¯æ–­ç‚¹è¡Œå·ï¼Œå€¼ä¸ºæ–­ç‚¹idã€‚å› ä¸ºæ–­ç‚¹è¡Œå·å¹¶ä¸è¿ç»­ï¼Œæ‰€ä»¥<code>status.funcbpt[func]</code>è¡¨ä¸æ˜¯ä¸€ä¸ªåºåˆ—ï¼Œä¸ºäº†å¿«é€Ÿè·å–æ–­ç‚¹ä¸ªæ•°ï¼Œæˆ‘ä»¬åœ¨è¡¨ä¸­é¢å¤–åŠ äº†ä¸€ä¸ªç‰¹æ®Šçš„<code>num</code>å­—æ®µä¿å­˜è¯¥å‡½æ•°ä¸­çš„æ–­ç‚¹ä¸ªæ•°ã€‚</p>
<p>è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥åœ¨calläº‹ä»¶ä¸­å¿«é€Ÿåœ°åˆ¤æ–­å½“å‰å‡½æ•°æ˜¯å¦æœ‰æ–­ç‚¹ï¼Œåœ¨lineäº‹ä»¶ä¸­å¿«é€Ÿåœ°åˆ¤æ–­å½“å‰è¡Œæ˜¯å¦æ˜¯æ–­ç‚¹è¡Œã€‚</p>
<p>å¦å¤–ï¼Œä¹‹æ‰€ä»¥å°†æ–­ç‚¹idä½œä¸º<code>status.funcbpt[func]</code>è¡¨çš„å€¼ï¼Œåˆ™æ˜¯ä¸ºäº†ä¿ç•™ä»<code>status.funcbpt</code>è®¿é—®<code>status.bptable</code>ä¸­å¯¹åº”æ–­ç‚¹çš„èƒ½åŠ›ï¼ˆ<code>status.bptable</code>è¡¨ä¸­å…ƒç´ å› ä¸ºåŒ…å«äº†<code>func</code>å’Œ<code>line</code>å­—æ®µï¼Œæ‰€ä»¥ä¹Ÿå¯ä»¥è®¿é—®åˆ°<code>status.funcbpt</code>å¯¹åº”æ–­ç‚¹ï¼‰ã€‚</p>
<p>è¿™ä¹ˆè¯´å¯èƒ½ä¸ç›´è§‚ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸ªä¾‹å­ã€‚</p>
<p>å‡è®¾æˆ‘ä»¬çš„<code>bptable</code>è¡¨ä¸­funcå‡½æ•°æ·»åŠ äº†ä¸¤ä¸ªæ–­ç‚¹å¦‚ä¸‹ï¼š</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line">bptable[<span class="number">1</span>] = &#123;func = func, line = <span class="number">10</span>&#125;</span><br><span class="line">bptable[<span class="number">2</span>] = &#123;func = func, line = <span class="number">20</span>&#125;</span><br></pre></td></tr></table></figure>

<p>å¯¹åº”çš„åœ¨<code>funcbpt</code>è¡¨ä¸­çš„æ“ä½œå¦‚ä¸‹ï¼š</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line">funcbpt[func] = &#123;&#125;          <span class="comment">-- æ„é€ è¡¨</span></span><br><span class="line">funcbpt[func][<span class="number">10</span>] = <span class="number">1</span>	    <span class="comment">-- å‡½æ•°funcï¼Œè¡Œå·10ï¼Œæ–­ç‚¹idä¸º1</span></span><br><span class="line">funcbpt[func].num = <span class="number">1</span>       <span class="comment">-- è¯¥å‡½æ•°ç¬¬ä¸€ä¸ªæ–­ç‚¹</span></span><br><span class="line">funcbpt[func][<span class="number">20</span>] = <span class="number">2</span>       <span class="comment">-- å‡½æ•°funcï¼Œè¡Œå·20ï¼Œæ–­ç‚¹idä¸º2</span></span><br><span class="line">funcbpt[func].num = funcbpt[func].num + <span class="number">1</span>	<span class="comment">-- æ–­ç‚¹ä¸ªæ•°+1</span></span><br></pre></td></tr></table></figure>



<p>OKï¼Œç†æ¸…æ¥šäº†<code>status.funcbpt</code>çš„æ•°æ®ç»“æ„è®¾è®¡ï¼Œå®ç°èµ·æ¥å°±ç®€å•äº†ã€‚</p>
<h2 id="æ·»åŠ æ–­ç‚¹"><a href="#æ·»åŠ æ–­ç‚¹" class="headerlink" title="æ·»åŠ æ–­ç‚¹"></a>æ·»åŠ æ–­ç‚¹</h2><p>æˆ‘ä»¬å…ˆä»è®¾ç½®æ–­ç‚¹å‡½æ•°å…¥æ‰‹ä¿®æ”¹ä»£ç ã€‚æ–°å¢çš„ä»£ç å·²ç»ç”¨ä¸­æ‹¬å·æ‹¬èµ·æ¥äº†ï¼Œæœ‰ä¸¤ä¸ªéƒ¨åˆ†ã€‚å…¶ä¸­å‰é¢çš„éƒ¨åˆ†å…ˆæ ¹æ®å‡½æ•°å’Œè¡Œå·æ£€æŸ¥æ˜¯å¦å·²ç»è®¾ç½®è¿‡åŒä¸€ä¸ªæ–­ç‚¹äº†ï¼Œå¦‚æœæ˜¯çš„è¯ï¼Œç›´æ¥è¿”å›ä¹‹å‰è®¾ç½®çš„æ–­ç‚¹idã€‚</p>
<p>åé¢çš„éƒ¨åˆ†ï¼Œåœ¨æ–­ç‚¹ä¿å­˜åˆ°<code>s.bptable</code>è¡¨ä¹‹åï¼Œä¹Ÿè¦ä¿å­˜åˆ°æˆ‘ä»¬æ–°å¢çš„è¡¨<code>s.funcbpt</code>è¡¨ä¸­ï¼Œè¡Œå·lineä½œä¸ºé”®ï¼Œæ–°æ–­ç‚¹idä½œä¸ºå€¼ã€‚å¦‚æœè®¾ç½®çš„æ˜¯è¯¥å‡½æ•°çš„ç¬¬ä¸€ä¸ªæ–­ç‚¹ï¼Œéœ€è¦å…ˆè¿›è¡Œè¡¨çš„åˆå§‹åŒ–æ„é€ ï¼Œæ‰€ä»¥æ“ä½œç¨æœ‰ä¸åŒã€‚</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">setbreakpoint</span><span class="params">(func, line)</span></span></span><br><span class="line">    <span class="keyword">local</span> s = <span class="built_in">status</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">type</span>(func) ~= <span class="string">&quot;function&quot;</span> <span class="keyword">or</span> <span class="built_in">type</span>(line) ~= <span class="string">&quot;number&quot;</span> <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="string">[[ æ–°å¢ä»£ç å¼€å§‹ ]]</span></span><br><span class="line">    <span class="comment">-- å·²ç»è®¾ç½®äº†ç›¸åŒçš„æ–­ç‚¹</span></span><br><span class="line">    <span class="keyword">if</span> s.funcbpt[func] <span class="keyword">and</span> s.funcbpt[func][line] <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span> s.funcbpt[func][line]</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="string">[[ æ–°å¢ä»£ç ç»“æŸ ]]</span></span><br><span class="line">    s.bpid = s.bpid + <span class="number">1</span></span><br><span class="line">    s.bpnum = s.bpnum + <span class="number">1</span></span><br><span class="line">    s.bptable[s.bpid] = &#123;func = func, line = line&#125;</span><br><span class="line">    <span class="string">[[ æ–°å¢ä»£ç å¼€å§‹ ]]</span></span><br><span class="line">    <span class="keyword">if</span> s.funcbpt[func] <span class="keyword">then</span>             <span class="comment">-- è¯¥å‡½æ•°å·²ç»æœ‰æ–­ç‚¹äº†</span></span><br><span class="line">        s.funcbpt[func].num = s.funcbpt[func].num + <span class="number">1</span></span><br><span class="line">        s.funcbpt[func][line] = s.bpid</span><br><span class="line">    <span class="keyword">else</span>                                <span class="comment">-- è¯¥å‡½æ•°ç¬¬ä¸€ä¸ªæ–­ç‚¹</span></span><br><span class="line">        s.funcbpt[func] = &#123;&#125;</span><br><span class="line">        s.funcbpt[func].num = <span class="number">1</span></span><br><span class="line">        s.funcbpt[func][line] = s.bpid</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">     <span class="string">[[ æ–°å¢ä»£ç ç»“æŸ ]]</span></span><br><span class="line">    <span class="keyword">if</span> s.bpnum == <span class="number">1</span> <span class="keyword">then</span>                <span class="comment">-- å…¨å±€ç¬¬ä¸€ä¸ªæ–­ç‚¹</span></span><br><span class="line">        <span class="built_in">debug</span>.<span class="built_in">sethook</span>(hook, <span class="string">&quot;c&quot;</span>)        <span class="comment">-- è®¾ç½®é’©å­&quot;call&quot;äº‹ä»¶</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> s.bpid                       <span class="comment">--&gt; è¿”å›æ–­ç‚¹id</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>



<h2 id="åˆ é™¤æ–­ç‚¹"><a href="#åˆ é™¤æ–­ç‚¹" class="headerlink" title="åˆ é™¤æ–­ç‚¹"></a>åˆ é™¤æ–­ç‚¹</h2><p>ç›¸åº”åœ°ï¼Œåœ¨åˆ é™¤æ–­ç‚¹çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¹Ÿéœ€è¦æŠŠ<code>s.funcbpt</code>è¡¨ä¸­å¯¹åº”çš„æ–­ç‚¹åˆ é™¤ã€‚é¦–å…ˆæ ¹æ®æ–­ç‚¹idï¼Œä»<code>s.bptable</code>è¡¨ä¸­è·å–åˆ°æ–­ç‚¹çš„å‡½æ•°å’Œè¡Œå·ï¼Œä»è€Œæ‰¾åˆ°<code>s.funcbpt</code>è¡¨ä¸­å¯¹åº”çš„æ–­ç‚¹ã€‚ç°å°†æ–­ç‚¹ä¸ªæ•°å‡1ï¼Œç„¶åå°†å¯¹åº”æ–­ç‚¹åˆ é™¤ï¼ˆé˜²æ­¢åç»­lineäº‹ä»¶æ‰¾åˆ°è¯¥æ–­ç‚¹ï¼‰ã€‚å¦‚æœè¯¥å‡½æ•°å·²ç»æ²¡æœ‰æ–­ç‚¹äº†ï¼Œé‚£ä¹ˆå°†<code>s.funcbpt[func]</code>è¡¨æœ¬èº«ä¹Ÿåˆ é™¤ï¼ˆé˜²æ­¢åç»­calläº‹ä»¶ä»¥ä¸ºè¯¥å‡½æ•°è¿˜æœ‰æ–­ç‚¹ï¼‰ã€‚</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">removebreakpoint</span><span class="params">(id)</span></span></span><br><span class="line">    <span class="keyword">local</span> s = <span class="built_in">status</span></span><br><span class="line">    <span class="keyword">if</span> s.bptable[id] == <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="string">[[ æ–°å¢ä»£ç å¼€å§‹ ]]</span></span><br><span class="line">    <span class="keyword">local</span> func = s.bptable[id].func</span><br><span class="line">    <span class="keyword">local</span> line = s.bptable[id].line</span><br><span class="line">    s.funcbpt[func].num = s.funcbpt[func].num - <span class="number">1</span></span><br><span class="line">    s.funcbpt[func][line] = <span class="literal">nil</span></span><br><span class="line">    <span class="keyword">if</span> s.funcbpt[func].num == <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">        s.funcbpt[func] = <span class="literal">nil</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="string">[[ æ–°å¢ä»£ç ç»“æŸ ]]</span></span><br><span class="line">    s.bptable[id] = <span class="literal">nil</span></span><br><span class="line">    s.bpnum = s.bpnum - <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> s.bpnum == <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">debug</span>.<span class="built_in">sethook</span>()                 <span class="comment">-- ç§»é™¤é’©å­</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>



<h2 id="é’©å­å‡½æ•°"><a href="#é’©å­å‡½æ•°" class="headerlink" title="é’©å­å‡½æ•°"></a>é’©å­å‡½æ•°</h2><p>ç„¶åæ¥ä¿®æ”¹é’©å­å‡½æ•°çš„å¤„ç†ï¼Œé’©å­çš„å‡½æ•°çš„ä¿®æ”¹ä¸»è¦æœ‰ä¸¤å¤„ï¼Œåˆ†åˆ«æ˜¯calläº‹ä»¶å’Œlineäº‹ä»¶ã€‚æˆ‘ä»¬å…ˆæ¥çœ‹calläº‹ä»¶çš„ä¿®æ”¹ï¼š</p>
<figure class="highlight diff"><table><tr><td class="code"><pre><span class="line"> local function hook (event, line)</span><br><span class="line">     local s = status</span><br><span class="line">     if event == &quot;call&quot; or event == &quot;tail call&quot; then</span><br><span class="line">         local func = debug.getinfo(2, &quot;f&quot;).func</span><br><span class="line"><span class="deletion">-        for _, v in pairs(s.bptable) do</span></span><br><span class="line"><span class="deletion">-            -- found breakpoint in current function</span></span><br><span class="line"><span class="deletion">-            if v.func == func then</span></span><br><span class="line"><span class="deletion">-                if event == &quot;call&quot; then</span></span><br><span class="line"><span class="deletion">-                    s.stackdepth = s.stackdepth + 1</span></span><br><span class="line"><span class="deletion">-                end</span></span><br><span class="line"><span class="deletion">-                s.stackinfos[s.stackdepth] =</span></span><br><span class="line"><span class="deletion">-                    &#123;func = func, hasbreak = true&#125;</span></span><br><span class="line"><span class="deletion">-                debug.sethook(hook, &quot;crl&quot;)     -- æ·»åŠ &quot;line&quot;äº‹ä»¶</span></span><br><span class="line"><span class="deletion">-                return</span></span><br><span class="line"><span class="deletion">-            end</span></span><br><span class="line"><span class="deletion">-        end</span></span><br><span class="line"><span class="deletion">-        -- æ²¡æœ‰æ–­ç‚¹</span></span><br><span class="line"><span class="deletion">-        if event == &quot;call&quot; then</span></span><br><span class="line"><span class="addition">+        if event == &quot;call&quot; then     -- å¯¹äºå°¾è°ƒç”¨,ç›´æ¥è¦†ç›–</span></span><br><span class="line">             s.stackdepth = s.stackdepth + 1</span><br><span class="line">         end</span><br><span class="line"><span class="deletion">-        s.stackinfos[s.stackdepth] = &#123;func = func, hasbreak = false&#125;</span></span><br><span class="line"><span class="deletion">-        debug.sethook(hook, &quot;cr&quot;)   -- å»æ‰&quot;line&quot;äº‹ä»¶</span></span><br><span class="line"><span class="addition">+        -- found breakpoint in current function</span></span><br><span class="line"><span class="addition">+        if s.funcbpt[func] then</span></span><br><span class="line"><span class="addition">+            s.stackinfos[s.stackdepth] = &#123;func = func, hasbreak = true&#125;</span></span><br><span class="line"><span class="addition">+            debug.sethook(hook, &quot;crl&quot;) -- æ·»åŠ &quot;line&quot;äº‹ä»¶</span></span><br><span class="line"><span class="addition">+        else        -- no breakpoints found</span></span><br><span class="line"><span class="addition">+            s.stackinfos[s.stackdepth] = &#123;func = func, hasbreak = false&#125;</span></span><br><span class="line"><span class="addition">+            debug.sethook(hook, &quot;cr&quot;)   -- å»æ‰&quot;line&quot;äº‹ä»¶</span></span><br><span class="line"><span class="addition">+        end</span></span><br><span class="line">     elseif event == &quot;return&quot; or event == &quot;tail return&quot; then</span><br></pre></td></tr></table></figure>

<p>ä¸»è¦çš„æ”¹åŠ¨å°±æ˜¯ä»åŸæœ¬çš„éå†<code>s.bptable</code>è¡¨æ¥æŸ¥æ‰¾æ˜¯å¦æœ‰æ–­ç‚¹ï¼Œæ”¹æˆäº†ç›´æ¥é€šè¿‡æ£€æŸ¥<code>s.funcbpt[func]</code>æ˜¯å¦ä¸ä¸º<code>nil</code>æ¥åˆ¤æ–­æ˜¯å¦æœ‰æ–­ç‚¹ã€‚è¿™é‡Œç›´æ¥ä»éå†ä¸€ä¸ªè¡¨ï¼Œä¼˜åŒ–æˆäº†ä¸€ä¸ªæŸ¥è¡¨æ“ä½œã€‚</p>
<p>ç¬¬äºŒå¤„æ˜¯lineäº‹ä»¶çš„ä¿®æ”¹ï¼Œä¸‹é¢æ˜¯ä¿®æ”¹å‰çš„ä»£ç ï¼š</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line">   <span class="comment">-- çœç•¥</span></span><br><span class="line">   <span class="keyword">elseif</span> event == <span class="string">&quot;line&quot;</span> <span class="keyword">then</span></span><br><span class="line">       <span class="keyword">for</span> _, v <span class="keyword">in</span> <span class="built_in">pairs</span>(s.bptable) <span class="keyword">do</span></span><br><span class="line">           <span class="keyword">if</span> v.func == s.stackinfos[s.stackdepth].func</span><br><span class="line">               <span class="keyword">and</span> v.line == line <span class="keyword">then</span></span><br><span class="line">               <span class="keyword">if</span> <span class="keyword">not</span> s.funcinfos[v.func] <span class="keyword">then</span></span><br><span class="line">                   s.funcinfos[v.func] = <span class="built_in">debug</span>.<span class="built_in">getinfo</span>(<span class="number">2</span>, <span class="string">&quot;nS&quot;</span>)</span><br><span class="line">               <span class="keyword">end</span></span><br><span class="line">               <span class="keyword">local</span> info = s.funcinfos[v.func]</span><br><span class="line">               <span class="keyword">local</span> prompt = <span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">&quot;%s (%s)%s %s:%d\n&quot;</span>,</span><br><span class="line">                   info.what, info.namewhat, info.name, info.short_src, line)</span><br><span class="line">               <span class="built_in">io</span>.<span class="built_in">write</span>(prompt)</span><br><span class="line">               <span class="built_in">debug</span>.<span class="built_in">debug</span>()</span><br><span class="line">           <span class="keyword">end</span></span><br><span class="line">       <span class="keyword">end</span></span><br><span class="line">   <span class="keyword">end</span></span><br><span class="line"><span class="comment">-- çœç•¥</span></span><br></pre></td></tr></table></figure>

<p>ä¸‹é¢æ˜¯ä¿®æ”¹åçš„ä»£ç ï¼Œé™¤äº†å¢åŠ äº†ä¸€äº›å±€éƒ¨å˜é‡ç®€åŒ–ä»£ç ä¹‹å¤–ï¼Œä¹Ÿæ˜¯å°†åŸæœ¬çš„éå†<code>s.bptable</code>è¡¨æ¥åˆ¤æ–­å½“å‰è¡Œæ˜¯å¦æ˜¯æ–­ç‚¹è¡Œï¼Œæ”¹æˆäº†ç›´æ¥é€šè¿‡æ£€æŸ¥<code>s.funcbpt[curfunc][line]</code>æ˜¯å¦ä¸ä¸º<code>nil</code>æ¥åˆ¤æ–­å½“å‰è¡Œæ˜¯å¦æ˜¯æ–­ç‚¹è¡Œã€‚è¿™é‡Œä¹Ÿå°†éå†ä¸€ä¸ªè¡¨çš„åŠ¨ä½œï¼Œä¼˜åŒ–æˆäº†ä¸€ä¸ªæŸ¥è¡¨æ“ä½œã€‚</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">elseif</span> event == <span class="string">&quot;line&quot;</span> <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">local</span> curfunc = s.stackinfos[s.stackdepth].func</span><br><span class="line">    <span class="keyword">local</span> funcbp = s.funcbpt[curfunc]</span><br><span class="line">    <span class="built_in">assert</span>(funcbp)</span><br><span class="line">    <span class="keyword">if</span> funcbp[line] <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> s.funcinfos[curfunc] <span class="keyword">then</span></span><br><span class="line">            s.funcinfos[curfunc] = <span class="built_in">debug</span>.<span class="built_in">getinfo</span>(<span class="number">2</span>, <span class="string">&quot;nS&quot;</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">local</span> info = s.funcinfos[curfunc]</span><br><span class="line">        <span class="keyword">local</span> prompt = <span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">&quot;%s (%s)%s %s:%d\n&quot;</span>,</span><br><span class="line">            info.what, info.namewhat, info.name, info.short_src, line)</span><br><span class="line">        <span class="built_in">io</span>.<span class="built_in">write</span>(prompt)</span><br><span class="line">        <span class="built_in">debug</span>.<span class="built_in">debug</span>()</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>



<h2 id="å¤æ‚åº¦åˆ†æ"><a href="#å¤æ‚åº¦åˆ†æ" class="headerlink" title="å¤æ‚åº¦åˆ†æ"></a>å¤æ‚åº¦åˆ†æ</h2><p>æˆ‘ä»¬ä»ç„¶å‡è®¾ä»£ç æ‰§è¡Œçš„æ€»è¡Œæ•°ä¸º<code>L</code>ï¼Œæ–­ç‚¹æ•°<code>N=n*b</code>ï¼Œå…¶ä¸­<code>n</code>ä¸ºæœ‰æ–­ç‚¹çš„å‡½æ•°ä¸ªæ•°ï¼Œ<code>b</code>ä¸ºå¹³å‡æ¯ä¸ªå‡½æ•°çš„æ–­ç‚¹æ•°ï¼Œæ–­ç‚¹æ‰€åœ¨å‡½æ•°å¹³å‡è¡Œæ•°ä¸º<code>l</code>ï¼Œæ–­ç‚¹æ‰€åœ¨å‡½æ•°å¹³å‡è°ƒç”¨æ¬¡æ•°ä¸º<code>c</code>ï¼Œæ€»çš„å‡½æ•°è°ƒç”¨æ¬¡æ•°<code>C</code>ã€‚</p>
<p>å®Œå…¨æ²¡ä¼˜åŒ–å‰å¤æ‚åº¦ä¸º<code>O(L*N)</code>ï¼Œä¸Šä¸€ç¯‡çš„äº‹ä»¶å¤„ç†ä¼˜åŒ–åçš„å¤æ‚åº¦ä¸º<code>O(C*N+c*l*N)</code>ï¼Œè€Œæœ¬ç¯‡çš„æ•°æ®ç»“æ„ä¼˜åŒ–ä¹‹åå¤æ‚åº¦è¿›ä¸€æ­¥ç¼©å°ä¸º<code>O(C+c*l)</code>ã€‚</p>
<h2 id="æµ‹è¯•å¤šå‡½æ•°å¤šæ–­ç‚¹"><a href="#æµ‹è¯•å¤šå‡½æ•°å¤šæ–­ç‚¹" class="headerlink" title="æµ‹è¯•å¤šå‡½æ•°å¤šæ–­ç‚¹"></a>æµ‹è¯•å¤šå‡½æ•°å¤šæ–­ç‚¹</h2><p>å…ˆæ¥æµ‹è¯•ä¸€ä¸‹ä¿®æ”¹ä¹‹åæ–­ç‚¹åŠŸèƒ½æ˜¯å¦æ­£å¸¸ï¼Œç¼–å†™ä¸€ä¸ªæµ‹è¯•è„šæœ¬å¦‚ä¸‹ã€‚æˆ‘ä»¬å¯¹fooå‡½æ•°å’Œbarå‡½æ•°åˆ†åˆ«æ·»åŠ äº†ä¸¤ä¸ªæ–­ç‚¹ï¼Œå…¶ä¸­fooå‡½æ•°ç¬¬ä¸€ä¸ªæ–­ç‚¹æ·»åŠ äº†ä¸¤æ¬¡ç”¨äºæµ‹è¯•é‡å¤æ·»åŠ çš„æƒ…å†µã€‚</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> ldb = <span class="built_in">require</span> <span class="string">&quot;luadebug&quot;</span></span><br><span class="line"><span class="keyword">local</span> setbp = ldb.setbreakpoint</span><br><span class="line"><span class="keyword">local</span> rmbp = ldb.removebreakpoint</span><br><span class="line">pv = ldb.printvarvalue</span><br><span class="line">sv = ldb.setvarvalue</span><br><span class="line">ptb = ldb.printtraceback</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">foo</span> <span class="params">()</span></span></span><br><span class="line">    <span class="keyword">local</span> a = <span class="number">1</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">bar</span> <span class="params">()</span></span></span><br><span class="line">    <span class="keyword">local</span> b = <span class="number">1</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> id1 = setbp(foo, <span class="number">9</span>)</span><br><span class="line"><span class="built_in">assert</span>(id1 == <span class="number">1</span>)</span><br><span class="line"><span class="keyword">local</span> id1 = setbp(foo, <span class="number">9</span>)</span><br><span class="line"><span class="built_in">assert</span>(id1 == <span class="number">1</span>)</span><br><span class="line"><span class="keyword">local</span> id2 = setbp(foo, <span class="number">10</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> id3 = setbp(bar, <span class="number">13</span>)</span><br><span class="line"><span class="keyword">local</span> id4 = setbp(bar, <span class="number">14</span>)</span><br><span class="line"></span><br><span class="line">foo()</span><br><span class="line">bar()</span><br><span class="line"></span><br><span class="line">rmbp(id1)</span><br><span class="line">rmbp(id2)</span><br><span class="line">rmbp(id3)</span><br><span class="line">rmbp(id4)</span><br><span class="line"></span><br><span class="line">foo()</span><br><span class="line">bar()</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œè„šæœ¬ï¼Œ4ä¸ªæ–­ç‚¹æƒ…å†µéƒ½èƒ½æ­£å¸¸è·‘åˆ°ã€‚åˆ é™¤æ–­ç‚¹åå†è°ƒç”¨fooå’Œbarå‡½æ•°ï¼Œä¸å†ç¢°åˆ°æ–­ç‚¹ã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ lua test.lua</span><br><span class="line">Lua (<span class="built_in">local</span>)foo test.lua:9</span><br><span class="line">lua_debug&gt; cont</span><br><span class="line">Lua (<span class="built_in">local</span>)foo test.lua:10</span><br><span class="line">lua_debug&gt; cont</span><br><span class="line">Lua (<span class="built_in">local</span>)bar test.lua:13</span><br><span class="line">lua_debug&gt; cont</span><br><span class="line">Lua (<span class="built_in">local</span>)bar test.lua:14</span><br><span class="line">lua_debug&gt; cont</span><br><span class="line">$</span><br></pre></td></tr></table></figure>



<h2 id="æ€§èƒ½æ¯”å¯¹"><a href="#æ€§èƒ½æ¯”å¯¹" class="headerlink" title="æ€§èƒ½æ¯”å¯¹"></a>æ€§èƒ½æ¯”å¯¹</h2><p>æˆ‘ä»¬å†æ¥åšä¸ªç®€å•çš„æµ‹è¯•ï¼Œçœ‹çœ‹æˆ‘ä»¬ä¼˜åŒ–çš„æ•ˆæœã€‚ç¼–å†™å¦‚ä¸‹æµ‹è¯•è„šæœ¬ï¼Œfooå‡½æ•°æ¨¡æ‹Ÿè¾ƒé•¿çš„ç¨‹åºï¼Œç„¶ååœ¨å¦ä¸€ä¸ªå‡½æ•°ä¸ŠåŠ ä¸ªæ–­ç‚¹ï¼ˆä¸ºäº†è®¾ç½®hookï¼‰ã€‚æˆ‘ä»¬åˆ†åˆ«ä½¿ç”¨ä¼˜åŒ–å‰çš„<code>luadebug.lua</code>å’Œä¼˜åŒ–åçš„<code>luadebug.lua</code>è¿›è¡Œæµ‹è¯•ã€‚</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> ldb = <span class="built_in">require</span> <span class="string">&quot;luadebug&quot;</span></span><br><span class="line"><span class="keyword">local</span> setbp = ldb.setbreakpoint</span><br><span class="line"><span class="keyword">local</span> rmbp = ldb.removebreakpoint</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">foo</span> <span class="params">()</span></span></span><br><span class="line">    <span class="keyword">local</span> a = <span class="number">1</span></span><br><span class="line">    <span class="keyword">for</span> i = <span class="number">1</span>, <span class="number">10000000</span> <span class="keyword">do</span></span><br><span class="line">        a = a + <span class="number">1</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">bar</span> <span class="params">()</span></span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> id1 = setbp(bar, <span class="number">13</span>)</span><br><span class="line"></span><br><span class="line">foo()</span><br></pre></td></tr></table></figure>

<h3 id="ä¼˜åŒ–å‰"><a href="#ä¼˜åŒ–å‰" class="headerlink" title="ä¼˜åŒ–å‰"></a>ä¼˜åŒ–å‰</h3><p>ä½¿ç”¨ä¼˜åŒ–å‰çš„å®ç°ï¼Œè¿è¡Œè¿™ä¸ªè„šæœ¬ç”¨äº†40s</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ time lua test2.lua</span><br><span class="line">lua test2.lua  39.54s user 0.16s system 99% cpu 39.957 total</span><br></pre></td></tr></table></figure>

<h3 id="ä¼˜åŒ–å"><a href="#ä¼˜åŒ–å" class="headerlink" title="ä¼˜åŒ–å"></a>ä¼˜åŒ–å</h3><p>ä½¿ç”¨ä¼˜åŒ–åçš„å®ç°ï¼Œåˆ™åªèŠ±äº†0.109sï¼Œç›¸å·®äº†æ¥è¿‘400å€ï¼Œå¯è§æˆ‘ä»¬çš„ä¼˜åŒ–æ•ˆæœè¿˜æ˜¯å¾ˆæ˜æ˜¾çš„ã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ time lua test2.lua</span><br><span class="line">lua test2.lua  0.10s user 0.00s system 97% cpu 0.109 total</span><br></pre></td></tr></table></figure>





]]></content>
      <categories>
        <category>ç¼–ç¨‹å¼€å‘</category>
        <category>Lua</category>
      </categories>
      <tags>
        <tag>Lua</tag>
        <tag>è°ƒè¯•</tag>
      </tags>
  </entry>
  <entry>
    <title>Luaä¸­å¦‚ä½•å®ç°ç±»ä¼¼gdbçš„æ–­ç‚¹è°ƒè¯•â€”06æ–­ç‚¹è¡Œå·æ£€æŸ¥ä¸è‡ªåŠ¨ä¿®æ­£</title>
    <url>/posts/fa52978d/</url>
    <content><![CDATA[<div class="note primary">
            <p>å‰é¢ä¸¤ç¯‡æˆ‘ä»¬å¯¹æ€§èƒ½åšäº†ä¸€ä¸ªä¼˜åŒ–ï¼Œæ¥ä¸‹æ¥ç»§ç»­æ¥ä¸°å¯Œè°ƒè¯•å™¨çš„ç‰¹æ€§ã€‚</p><p>æˆ‘ä»¬å‰é¢æåˆ°è¿‡ï¼Œå‡½æ•°å†…å¹¶ä¸æ˜¯æ‰€æœ‰è¡Œéƒ½æ˜¯æœ‰æ•ˆè¡Œï¼Œç©ºè¡Œå’Œæ³¨é‡Šè¡Œå°±ä¸æ˜¯æœ‰æ•ˆè¡Œã€‚æˆ‘ä»¬ä¹‹å‰åœ¨æ·»åŠ æ–­ç‚¹çš„æ—¶å€™ï¼Œå¹¶æ²¡æœ‰å¯¹è¡Œå·è¿›è¡Œæ£€æŸ¥ï¼Œä»»ä½•è¡Œå·éƒ½èƒ½æˆåŠŸæ·»åŠ æ–­ç‚¹ã€‚æ‰€ä»¥å¦‚æœæ·»åŠ çš„æ–­ç‚¹è¡Œå·æ˜¯æ— æ•ˆçš„ï¼Œé‚£ä¹ˆæ°¸è¿œä¹Ÿä¸ä¼šæ–­åˆ°é‚£é‡Œã€‚ä½†æ˜¯é’©å­é‡Œå¹¶ä¸çŸ¥é“å®ƒæ˜¯æ— æ•ˆçš„ï¼Œcalläº‹ä»¶ä»ç„¶ä¼šä»¥ä¸ºå‡½æ•°æœ‰æ–­ç‚¹ä»è€Œå¯åŠ¨lineäº‹ä»¶ï¼Œé€ æˆCPUçš„æµªè´¹ã€‚</p><p>æ‰€ä»¥æœ¬ç¯‡ï¼Œæˆ‘ä»¬å°†å¯¹æ–­ç‚¹çš„è¡Œå·è¿›è¡Œæ£€æŸ¥ï¼Œå¯¹äºä¸åœ¨å‡½æ•°èŒƒå›´å†…çš„è¡Œå·ç›´æ¥æ·»åŠ æ–­ç‚¹å¤±è´¥ï¼›åœ¨å‡½æ•°èŒƒå›´å†…çš„è¡Œå·åˆ™è‡ªåŠ¨ä¿®æ­£ä¸ºä¸‹ä¸€ä¸ªæœ‰æ•ˆçš„è¡Œå·ï¼›å¦å¤–æ”¯æŒä¸æŒ‡å®šè¡Œå·ï¼Œé»˜è®¤ä¸ºå‡½æ•°çš„ç¬¬ä¸€ä¸ªæœ‰æ•ˆè¡Œã€‚</p><span id="more"></span><p>æºç å·²ç»ä¸Šä¼ <a href="https://github.com/catbro666/lua-debugger">Github</a>ï¼Œæ¬¢è¿watch&#x2F;starğŸ˜˜ã€‚</p>
          </div>



<h2 id="æ·»åŠ æ–­ç‚¹"><a href="#æ·»åŠ æ–­ç‚¹" class="headerlink" title="æ·»åŠ æ–­ç‚¹"></a>æ·»åŠ æ–­ç‚¹</h2><p>å› ä¸ºæ˜¯æ–­ç‚¹è¡Œå·ç›¸å…³çš„æ£€æŸ¥ï¼Œæ‰€ä»¥ä¿®æ”¹ä¸»è¦é›†ä¸­åœ¨æ·»åŠ æ–­ç‚¹çš„å‡½æ•°ä¸­ã€‚é¦–å…ˆå› ä¸ºæ”¯æŒäº†ä¸æŒ‡å®šè¡Œå·ï¼Œæ‰€ä»¥ä¿®æ”¹äº†å‚æ•°æ£€æŸ¥çš„åœ°æ–¹å…è®¸ä¸ºç©ºã€‚å…¶æ¬¡ï¼Œå› ä¸ºè¦æ£€æŸ¥è¡Œå·æ˜¯å¦æœ‰æ•ˆï¼Œæˆ‘ä»¬å°±éœ€è¦å…ˆè·å–åˆ°å‡½æ•°çš„ä¿¡æ¯ã€‚è€ƒè™‘åˆ°åœ¨é’©å­å‡½æ•°ä¸­ä¹Ÿéœ€è¦è·å–å‡½æ•°ä¿¡æ¯ï¼Œæˆ‘ä»¬å°±æŠŠç›¸å…³çš„æ“ä½œå°è£…æˆäº†ä¸€ä¸ªå•ç‹¬çš„å‡½æ•°<code>getfuncinfo()</code>ã€‚è·å–åˆ°å‡½æ•°ä¿¡æ¯ä¹‹åï¼Œå°±å¯ä»¥éªŒè¯è¡Œå·æ˜¯å¦æœ‰æ•ˆäº†ï¼ŒåŒæ ·æˆ‘ä»¬å°†è¿™ä¸ªéªŒè¯è¡Œå·çš„æ“ä½œä¹Ÿå°è£…æˆäº†ä¸€ä¸ªå•ç‹¬çš„å‡½æ•°<code>verifyfuncline</code>ã€‚</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">setbreakpoint</span><span class="params">(func, line)</span></span></span><br><span class="line">    <span class="keyword">local</span> s = <span class="built_in">status</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">type</span>(func) ~= <span class="string">&quot;function&quot;</span> <span class="keyword">or</span> ( line <span class="keyword">and</span> <span class="built_in">type</span>(line) ~= <span class="string">&quot;number&quot;</span>) <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">io</span>.<span class="built_in">write</span>(<span class="string">&quot;invalid parameter\n&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">-- get func info</span></span><br><span class="line">    <span class="keyword">local</span> info = getfuncinfo(func)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> info <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">io</span>.<span class="built_in">write</span>(<span class="string">&quot;unable to get func info\n&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">-- verify the line</span></span><br><span class="line">    line = verifyfuncline(info, line)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> line <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">io</span>.<span class="built_in">write</span>(<span class="string">&quot;invalid line\n&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- çœç•¥</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>



<h2 id="è·å–å‡½æ•°ä¿¡æ¯"><a href="#è·å–å‡½æ•°ä¿¡æ¯" class="headerlink" title="è·å–å‡½æ•°ä¿¡æ¯"></a>è·å–å‡½æ•°ä¿¡æ¯</h2><p><code>getfuncinfo</code>å‡½æ•°çš„ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">getfuncinfo</span> <span class="params">(func, level)</span></span></span><br><span class="line">    <span class="keyword">local</span> s = <span class="built_in">status</span></span><br><span class="line">    <span class="keyword">local</span> info = s.funcinfos[func]</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> info <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">if</span> level <span class="keyword">then</span></span><br><span class="line">            s.funcinfos[func] = <span class="built_in">debug</span>.<span class="built_in">getinfo</span>(level + <span class="number">1</span>, <span class="string">&quot;nSL&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            s.funcinfos[func] = <span class="built_in">debug</span>.<span class="built_in">getinfo</span>(func, <span class="string">&quot;SL&quot;</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        info = s.funcinfos[func]</span><br><span class="line">        info.sortedlines = &#123;&#125;</span><br><span class="line">        <span class="keyword">for</span> k, _ <span class="keyword">in</span> <span class="built_in">pairs</span>(info.activelines) <span class="keyword">do</span></span><br><span class="line">           <span class="built_in">table</span>.<span class="built_in">insert</span>(info.sortedlines, k)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="built_in">table</span>.<span class="built_in">sort</span>(info.sortedlines)</span><br><span class="line">    <span class="keyword">elseif</span> level <span class="keyword">then</span>	<span class="comment">-- nameå’Œnamewhatéœ€è¦å®æ—¶è·å–</span></span><br><span class="line">         <span class="keyword">local</span> nameinfo = <span class="built_in">debug</span>.<span class="built_in">getinfo</span>(level + <span class="number">1</span>, <span class="string">&quot;n&quot;</span>)</span><br><span class="line">         info.name = nameinfo.name</span><br><span class="line">         info.namewhat = nameinfo.namewhat</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> info</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>è¯¥å‡½æ•°æœ‰ä¸¤ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°å°±æ˜¯å‡½æ•°ï¼Œç¬¬äºŒä¸ªå¯é€‰çš„å‚æ•°levelç”¨äºæŒ‡å®šåœ¨è°ƒç”¨æ ˆä¸­çš„å±‚æ•°ï¼Œç¬¬äºŒä¸ªå‚æ•°åªæœ‰åœ¨é’©å­å‡½æ•°ä¸­æ—¶æ‰ä¼šæŒ‡å®šï¼Œè¿”å›å€¼å°±æ˜¯å‡½æ•°ä¿¡æ¯ã€‚å¦‚æœåœ¨è°ƒç”¨<code>debug.getinfo</code>çš„æ—¶å€™ä¼ é€’å‡½æ•°ä½œä¸ºå‚æ•°ï¼Œé‚£ä¹ˆæ˜¯è·å–ä¸åˆ°å‡½æ•°çš„åå­—ä¿¡æ¯çš„ï¼Œ<code>name</code>å’Œ<code>namewhat</code>å­—æ®µéƒ½ä¸ºç©ºã€‚å› ä¸ºå‡½æ•°å¯èƒ½æ˜¯ä»»æ„åå­—ï¼ŒLuaéœ€è¦é€šè¿‡æŸ¥æ‰¾è°ƒç”¨è¯¥å‡½æ•°çš„ä»£ç ï¼ŒçŸ¥é“å®ƒæ˜¯æ€ä¹ˆè¢«è°ƒç”¨çš„ï¼Œä»è€Œç¡®å®šå‡½æ•°çš„åå­—ã€‚æ‰€ä»¥åªæœ‰å½“æŒ‡å®šè°ƒç”¨æ ˆçš„å±‚æ•°æ—¶æ‰èƒ½è·å–åˆ°åå­—ä¿¡æ¯ã€‚</p>
<p>æˆ‘ä»¬æ¥ç€çœ‹ä»£ç çš„ä¸»ä½“éƒ¨åˆ†ï¼š</p>
<p>é¦–å…ˆå°è¯•å»<code>s.funcinfos</code>è¡¨ä¸­æŸ¥æ‰¾æ˜¯å¦æœ‰ç¼“å­˜çš„å‡½æ•°ä¿¡æ¯ã€‚å¦‚æœæ²¡æœ‰é‚£å°±åªèƒ½è°ƒç”¨<code>debug.getinfo</code>å»è·å–äº†ï¼Œè¿™é‡Œåˆ†ä¸ºä¸¤ç§æƒ…å†µï¼Œå¦‚æœæŒ‡å®šäº†<code>level</code>å‚æ•°ï¼Œé‚£ä¹ˆå°±ä»¥å±‚æ•°ï¼ˆè¿™é‡Œ+1åŒæ ·æ˜¯ä¸ºäº†ä¿®æ­£å±‚æ•°ï¼Œæˆ‘ä»¬åœ¨å‰é¢å¤šæ¬¡æåˆ°è¿‡ï¼‰ä½œä¸ºå‚æ•°è°ƒç”¨ï¼Œæ­¤æ—¶ç¬¬äºŒä¸ªå‚æ•°è®¾ç½®ä¸ºäº†<code>&quot;nSL&quot;</code>ï¼Œæ¯”ä¹‹å‰å¤šäº†<code>&quot;L&quot;</code>ç”¨äºè·å–æœ‰æ•ˆè¡Œå·ï¼›å¦‚æœæ²¡æœ‰æŒ‡å®š<code>level</code>å‚æ•°ï¼Œåˆ™ä»¥å‡½æ•°ä½œä¸ºå‚æ•°è°ƒç”¨ã€‚è·å–åˆ°å‡½æ•°ä¿¡æ¯ä¹‹åï¼Œä¸ºäº†æ–¹ä¾¿æˆ‘ä»¬åé¢çš„è¡Œå·æ£€æŸ¥ï¼Œæˆ‘ä»¬å¯¹æœ‰æ•ˆçš„è¡Œå·è¿›è¡Œäº†æ’åºï¼Œ<code>info.sortedlines</code>æ•°ç»„å°±æ˜¯æ’åºåçš„æœ‰æ•ˆè¡Œå·ï¼Œç„¶åå°±è¿”å›å‡½æ•°ä¿¡æ¯<code>info</code>äº†ã€‚</p>
<p>å¦‚æœç¼“å­˜ä¸­å·²ç»æœ‰å‡½æ•°ä¿¡æ¯äº†ï¼Œå¦‚æœæœ¬æ¬¡è°ƒç”¨åˆæŒ‡å®šäº†<code>level</code>å‚æ•°ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±æ›´æ–°ä¸‹nameä¿¡æ¯ã€‚è°ƒç”¨<code>debug.getinfo</code>è·å–åˆ°ä¿¡æ¯ä¹‹åè®¾ç½®åˆ°åŸæœ‰çš„<code>info</code>è¡¨ä¸­ã€‚å®Œæˆä¹‹ååŒæ ·æ˜¯è¿”å›å‡½æ•°ä¿¡æ¯<code>info</code>ã€‚</p>
<h2 id="æ£€æŸ¥åŠä¿®æ­£å‡½æ•°è¡Œå·"><a href="#æ£€æŸ¥åŠä¿®æ­£å‡½æ•°è¡Œå·" class="headerlink" title="æ£€æŸ¥åŠä¿®æ­£å‡½æ•°è¡Œå·"></a>æ£€æŸ¥åŠä¿®æ­£å‡½æ•°è¡Œå·</h2><p><code>verifyfuncline</code>å‡½æ•°çš„ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">verifyfuncline</span> <span class="params">(info, line)</span></span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> line <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span> info.sortedlines[<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">if</span> line &lt; info.linedefined <span class="keyword">or</span> line &gt; info.lastlinedefined <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">for</span> _, v <span class="keyword">in</span> <span class="built_in">ipairs</span>(info.sortedlines) <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">if</span> v &gt;= line <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">return</span> v</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="built_in">assert</span>(<span class="literal">false</span>)   <span class="comment">-- impossible to reach here</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>è¯¥å‡½æ•°æœ‰ä¸¤ä¸ªå‚æ•°ï¼Œå…¶ä¸­ç¬¬äºŒä¸ªè¡Œå·æ˜¯å¯é€‰çš„ã€‚å¦‚æœæ²¡æœ‰æŒ‡å®šè¡Œå·ï¼Œé‚£ä¹ˆç›´æ¥è¿”å›å‡½æ•°çš„ç¬¬ä¸€ä¸ªæœ‰æ•ˆè¡Œå·ã€‚å¦‚æœæŒ‡å®šäº†è¡Œå·ï¼Œä½†æ˜¯èŒƒå›´è¶…å‡ºäº†å‡½æ•°å®šä¹‰çš„èŒƒå›´ï¼Œé‚£ä¹ˆè¿”å›<code>nil</code>ã€‚å¦‚æœè¡Œå·è½åœ¨å‡½æ•°èŒƒå›´å†…ï¼Œé‚£ä¹ˆå°±éå†å·²ç»æ’å¥½åºçš„æœ‰æ•ˆè¡Œå·æ•°ç»„ï¼Œè¿”å›ç¢°åˆ°çš„ç¬¬ä¸€ä¸ªå¤§äºç­‰äºæŒ‡å®šè¡Œå·çš„å€¼ã€‚</p>
<h2 id="é’©å­å‡½æ•°"><a href="#é’©å­å‡½æ•°" class="headerlink" title="é’©å­å‡½æ•°"></a>é’©å­å‡½æ•°</h2><p>æ¥ä¸‹æ¥çœ‹ä¸‹é’©å­å‡½æ•°çš„ä¿®æ”¹ï¼Œå› ä¸ºæˆ‘ä»¬å·²ç»å°è£…äº†<code>getfuncinfo</code>å‡½æ•°ï¼Œæ‰€ä»¥é’©å­å‡½æ•°ä¸­ä¹Ÿæ”¹æˆç”¨å®ƒæ¥è·å–å‡½æ•°ä¿¡æ¯ã€‚ä¸è¿‡è¿™é‡Œåœ¨è°ƒç”¨çš„æ—¶å€™æŒ‡å®šäº†<code>level</code>ä»è€Œå¯ä»¥è·å–åˆ°å‡½æ•°åå­—ä¿¡æ¯ã€‚</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">hook</span> <span class="params">(event, line)</span></span></span><br><span class="line">    <span class="comment">-- çœç•¥</span></span><br><span class="line">    <span class="keyword">elseif</span> event == <span class="string">&quot;line&quot;</span> <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">local</span> curfunc = s.stackinfos[s.stackdepth].func</span><br><span class="line">        <span class="keyword">local</span> funcbp = s.funcbpt[curfunc]</span><br><span class="line">        <span class="built_in">assert</span>(funcbp)</span><br><span class="line">        <span class="keyword">if</span> funcbp[line] <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">local</span> info = getfuncinfo(curfunc, <span class="number">2</span>)</span><br><span class="line">            <span class="keyword">local</span> prompt = <span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">&quot;%s (%s)%s %s:%d\n&quot;</span>,</span><br><span class="line">                info.what, info.namewhat, info.name, info.short_src, line)</span><br><span class="line">            <span class="built_in">io</span>.<span class="built_in">write</span>(prompt)</span><br><span class="line">            <span class="built_in">debug</span>.<span class="built_in">debug</span>()</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span>    </span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>OKï¼Œä»£ç ä¿®æ”¹å®Œäº†ï¼Œæˆ‘ä»¬è¿›è¡Œæµ‹è¯•ã€‚</p>
<h2 id="æµ‹è¯•æœ‰æ•ˆè¡Œæ’åº"><a href="#æµ‹è¯•æœ‰æ•ˆè¡Œæ’åº" class="headerlink" title="æµ‹è¯•æœ‰æ•ˆè¡Œæ’åº"></a>æµ‹è¯•æœ‰æ•ˆè¡Œæ’åº</h2><p>é¦–å…ˆæµ‹è¯•ä¸€ä¸‹ï¼Œæœ‰æ•ˆè¡Œå·æ’åºé‚£å—çš„é€»è¾‘ã€‚æˆ‘ä»¬ç¼–å†™äº†ä¸€ä¸ªå¦‚ä¸‹çš„æµ‹è¯•è„šæœ¬ï¼š</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="built_in">debug</span> = <span class="built_in">require</span> <span class="string">&quot;debug&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">foo</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">local</span> a = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    a = a + <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    a = a + <span class="number">1</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">bar</span><span class="params">()</span></span> <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">sortlines</span><span class="params">(func)</span></span></span><br><span class="line">    <span class="keyword">local</span> info = <span class="built_in">debug</span>.<span class="built_in">getinfo</span>(func, <span class="string">&quot;nSL&quot;</span>)</span><br><span class="line">    info.sortedlines = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> k, v <span class="keyword">in</span> <span class="built_in">pairs</span>(info.activelines) <span class="keyword">do</span></span><br><span class="line">        <span class="built_in">print</span>(k, v)</span><br><span class="line">        <span class="built_in">table</span>.<span class="built_in">insert</span>(info.sortedlines, k)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">table</span>.<span class="built_in">sort</span>(info.sortedlines)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> k, v <span class="keyword">in</span> <span class="built_in">ipairs</span>(info.sortedlines) <span class="keyword">do</span></span><br><span class="line">        <span class="built_in">print</span>(k, v)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;foo&quot;</span>)</span><br><span class="line">sortlines(foo)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;bar&quot;</span>)</span><br><span class="line">sortlines(bar)</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å®šä¹‰äº†ä¸¤ä¸ªå‡½æ•°fooå’Œbarï¼Œå…¶ä¸­fooå‡½æ•°çš„èŒƒå›´ä¸ºç¬¬3è¡Œåˆ°ç¬¬9è¡Œï¼Œæœ‰4ä¸ªæœ‰æ•ˆè¡Œ4ã€6ã€8ã€9ã€‚è€Œbarå‡½æ•°åˆ™ä¸ºç‰¹æ®Šçš„å•è¡Œå‡½æ•°ã€‚</p>
<p>è¿è¡Œè„šæœ¬ï¼Œè¾“å‡ºå¦‚ä¸‹</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ lua sortlines.lua</span><br><span class="line">foo</span><br><span class="line">4	<span class="literal">true</span></span><br><span class="line">9	<span class="literal">true</span></span><br><span class="line">6	<span class="literal">true</span></span><br><span class="line">8	<span class="literal">true</span></span><br><span class="line">1	4</span><br><span class="line">2	6</span><br><span class="line">3	8</span><br><span class="line">4	9</span><br><span class="line">bar</span><br><span class="line">11	<span class="literal">true</span></span><br><span class="line">1	11</span><br></pre></td></tr></table></figure>

<p>fooå‡½æ•°4ä¸ªæœ‰æ•ˆè¡Œæ²¡æ’ä¹‹å‰æ˜¯4ã€9ã€6ã€8ï¼Œæ’åºä¹‹åå˜æˆ4ã€6ã€8ã€9ã€‚barå‡½æ•°å”¯ä¸€çš„æœ‰æ•ˆè¡Œå°±æ˜¯å®ƒå¼€å§‹å®šä¹‰çš„é‚£è¡Œã€‚</p>
<h2 id="æµ‹è¯•è¡Œå·æ£€æŸ¥å’Œè‡ªåŠ¨ä¿®æ­£"><a href="#æµ‹è¯•è¡Œå·æ£€æŸ¥å’Œè‡ªåŠ¨ä¿®æ­£" class="headerlink" title="æµ‹è¯•è¡Œå·æ£€æŸ¥å’Œè‡ªåŠ¨ä¿®æ­£"></a>æµ‹è¯•è¡Œå·æ£€æŸ¥å’Œè‡ªåŠ¨ä¿®æ­£</h2><p>ç¼–å†™æµ‹è¯•è„šæœ¬å¦‚ä¸‹ï¼š</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> ldb = <span class="built_in">require</span> <span class="string">&quot;luadebug&quot;</span></span><br><span class="line"><span class="keyword">local</span> setbp = ldb.setbreakpoint</span><br><span class="line"><span class="keyword">local</span> rmbp = ldb.removebreakpoint</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">foo</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">local</span> a = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    a = a + <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    a = a + <span class="number">1</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> id1 = setbp(foo)</span><br><span class="line"><span class="built_in">assert</span>(id1 == <span class="number">1</span>)</span><br><span class="line"><span class="keyword">local</span> id2 = setbp(foo, <span class="number">5</span>)</span><br><span class="line"><span class="built_in">assert</span>(id2 == id1)</span><br><span class="line"><span class="keyword">local</span> id3 = setbp(foo, <span class="number">6</span>)</span><br><span class="line"><span class="built_in">assert</span>(id3 == id1)</span><br><span class="line"><span class="keyword">local</span> id4 = setbp(foo, <span class="number">7</span>)</span><br><span class="line"><span class="built_in">assert</span>(id4 == <span class="number">2</span>)</span><br><span class="line"><span class="keyword">local</span> id5 = setbp(foo, <span class="number">8</span>)</span><br><span class="line"><span class="built_in">assert</span>(id5 == id4)</span><br><span class="line"><span class="keyword">local</span> id6 = setbp(foo, <span class="number">9</span>)</span><br><span class="line"><span class="built_in">assert</span>(id6 == <span class="number">3</span>)</span><br><span class="line"><span class="keyword">local</span> id7 = setbp(foo, <span class="number">100</span>)</span><br><span class="line"><span class="built_in">assert</span>(<span class="keyword">not</span> id7)</span><br><span class="line"></span><br><span class="line">foo()</span><br><span class="line"></span><br><span class="line">rmbp(id1)</span><br><span class="line">rmbp(id4)</span><br><span class="line"></span><br><span class="line">foo()</span><br><span class="line"></span><br><span class="line">rmbp(id6)</span><br><span class="line"></span><br><span class="line">foo()</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬åœ¨fooå‡½æ•°ä¸Šæ·»åŠ äº†å¥½å‡ ä¸ªæ–­ç‚¹ï¼Œç¬¬ä¸€ä¸ªæ–­ç‚¹è¡Œå·çœç•¥ï¼Œç¬¬äºŒä¸ªæ–­ç‚¹åŠ åœ¨äº†ç¬¬5è¡Œï¼Œä¹Ÿå°±æ˜¯å‡½æ•°å¼€å§‹å®šä¹‰çš„è¡Œï¼Œç¬¬ä¸‰ä¸ªæ–­ç‚¹åŠ åœ¨äº†ç¬¬6è¡Œï¼Œè¿™æ˜¯å‡½æ•°ç¬¬ä¸€ä¸ªæœ‰æ•ˆè¡Œã€‚é¢„æœŸå‰ä¸‰æ¬¡æ·»åŠ æ–­ç‚¹åº”è¯¥éƒ½è¿”å›åŒä¸€ä¸ªæ–­ç‚¹idï¼Œæ–­åœ¨ç¬¬6è¡Œã€‚æ¥ä¸‹æ¥æ·»åŠ çš„ä¸¤ä¸ªæ–­ç‚¹ï¼Œç¬¬7è¡Œä¸æ˜¯æœ‰æ•ˆè¡Œï¼Œç¬¬8è¡Œæ˜¯æœ‰æ•ˆè¡Œï¼Œé¢„æœŸè¿”å›åŒä¸€ä¸ªæ–­ç‚¹idï¼Œæ–­åœ¨ç¬¬8è¡Œã€‚ç„¶ååœ¨ç¬¬9è¡Œæ·»åŠ äº†ä¸€ä¸ªæ–­ç‚¹ï¼Œå› ä¸ºä¸æ˜¯æœ‰æ•ˆè¡Œï¼Œé¢„æœŸæ–­åœ¨ç¬¬10è¡Œã€‚æœ€åä¸€ä¸ªåœ¨ç¬¬100è¡Œè®¾ç½®äº†ä¸€ä¸ªæ–­ç‚¹ï¼Œå› ä¸ºè¶…å‡ºäº†å‡½æ•°çš„èŒƒå›´ï¼Œé¢„æœŸè®¾ç½®æ–­ç‚¹å¤±è´¥è¿”å›<code>nil</code>ã€‚</p>
<p>è®¾ç½®å¥½æ–­ç‚¹ï¼Œå…ˆè°ƒç”¨ä¸€æ¬¡fooå‡½æ•°ï¼Œç„¶ååˆ é™¤ä¸¤ä¸ªæ–­ç‚¹ï¼Œåœ¨è°ƒç”¨ä¸€æ¬¡fooå‡½æ•°ï¼Œæœ€åå°†å‰©ä½™é‚£ä¸ªæ–­ç‚¹åˆ é™¤ï¼Œå†è°ƒç”¨ä¸€æ¬¡fooå‡½æ•°ã€‚</p>
<p>æˆ‘ä»¬äº†è¿è¡Œä¸‹æµ‹è¯•è„šæœ¬</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ lua test.lua</span><br><span class="line">invalid line</span><br><span class="line">Lua (<span class="built_in">local</span>)foo test.lua:6</span><br><span class="line">lua_debug&gt; </span><br></pre></td></tr></table></figure>

<p>æ–­ç‚¹çš„è®¾ç½®éƒ½ç¬¦åˆé¢„æœŸï¼Œæœ€åä¸€ä¸ªå› ä¸ºè¡Œå·è¶…å‡ºäº†èŒƒå›´ï¼Œæ‰“äº†ä¸€è¡Œé”™è¯¯æ—¥å¿—<code>invalid line</code>ï¼Œç¨‹åºåœåœ¨äº†ç¬¬6è¡Œå¤„ã€‚ç„¶åæˆ‘ä»¬è¾“å…¥ä¸¤ä¸ª<code>cont</code>ï¼Œç¨‹åºåœåœ¨äº†æœ€åä¸€ä¸ªæ–­ç‚¹å¤„ã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Lua (<span class="built_in">local</span>)foo test.lua:6</span><br><span class="line">lua_debug&gt; cont</span><br><span class="line">Lua (<span class="built_in">local</span>)foo test.lua:8</span><br><span class="line">lua_debug&gt; cont</span><br><span class="line">Lua (<span class="built_in">local</span>)foo test.lua:10</span><br><span class="line">lua_debug&gt; </span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å†æ¬¡è¾“å…¥<code>cont</code>ï¼Œfooå‡½æ•°è¿è¡Œç»“æŸï¼Œæ­¤æ—¶å› ä¸ºå‰ä¸¤ä¸ªæ–­ç‚¹å·²ç»è¢«åˆ é™¤ï¼Œç¬¬äºŒæ¬¡è°ƒç”¨fooå‡½æ•°åº”è¯¥ç›´æ¥åœåœ¨æ–­ç‚¹3å¤„ï¼Œä¹Ÿå°±æ˜¯ç¬¬10è¡Œ</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Lua (<span class="built_in">local</span>)foo test.lua:6</span><br><span class="line">lua_debug&gt; cont</span><br><span class="line">Lua (<span class="built_in">local</span>)foo test.lua:8</span><br><span class="line">lua_debug&gt; cont</span><br><span class="line">Lua (<span class="built_in">local</span>)foo test.lua:10</span><br><span class="line">lua_debug&gt; cont</span><br><span class="line">Lua (<span class="built_in">local</span>)foo test.lua:10</span><br><span class="line">lua_debug&gt;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å†æ¬¡è¾“å…¥<code>cont</code>ï¼Œå› ä¸ºæœ€åä¸€ä¸ªæ–­ç‚¹ä¹Ÿè¢«åˆ é™¤äº†ï¼Œæ‰€ä»¥æœ€åä¸€ä¸ªæ‰§è¡Œfooå‡½æ•°æ²¡æœ‰å†ç¢°åˆ°æ–­ç‚¹ã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ lua test.lua</span><br><span class="line">invalid line</span><br><span class="line">Lua (<span class="built_in">local</span>)foo test.lua:6</span><br><span class="line">lua_debug&gt; cont</span><br><span class="line">Lua (<span class="built_in">local</span>)foo test.lua:8</span><br><span class="line">lua_debug&gt; cont</span><br><span class="line">Lua (<span class="built_in">local</span>)foo test.lua:10</span><br><span class="line">lua_debug&gt; cont</span><br><span class="line">Lua (<span class="built_in">local</span>)foo test.lua:10</span><br><span class="line">lua_debug&gt; cont</span><br><span class="line">$</span><br></pre></td></tr></table></figure>



]]></content>
      <categories>
        <category>ç¼–ç¨‹å¼€å‘</category>
        <category>Lua</category>
      </categories>
      <tags>
        <tag>Lua</tag>
        <tag>è°ƒè¯•</tag>
      </tags>
  </entry>
  <entry>
    <title>Luaä¸­å¦‚ä½•å®ç°ç±»ä¼¼gdbçš„æ–­ç‚¹è°ƒè¯•â€”07æ”¯æŒé€šè¿‡å‡½æ•°åç§°æ·»åŠ æ–­ç‚¹</title>
    <url>/posts/acdf52b7/</url>
    <content><![CDATA[<div class="note primary">
            <p>æˆ‘ä»¬ä¹‹å‰å·²ç»æ”¯æŒäº†é€šè¿‡å‡½æ•°æ¥æ·»åŠ æ–­ç‚¹ï¼Œå¹¶ä¸”å·²ç»æ”¯æŒäº†è¡Œå·çš„æ£€æŸ¥å’Œè‡ªåŠ¨ä¿®æ­£ã€‚ä½†æ˜¯é€šè¿‡å‡½æ•°æ¥æ·»åŠ æ–­ç‚¹æœ‰ä¸€äº›é™åˆ¶ï¼Œå¦‚æœåœ¨å½“å‰çš„ä½ç½®æ— æ³•è®¿é—®ç›®æ ‡å‡½æ•°ï¼Œé‚£æˆ‘ä»¬å°±æ— æ³•å¯¹å…¶æ·»åŠ æ–­ç‚¹ã€‚</p><p>äºæ˜¯ï¼Œæœ¬ç¯‡æˆ‘ä»¬å°†æ‰©å±•æ–­ç‚¹è®¾ç½®çš„æ¥å£ï¼Œæ”¯æŒé€šè¿‡å‡½æ•°åç§°æ·»åŠ æ–­ç‚¹ï¼Œä»¥çªç ´è¿™ä¸ªé™åˆ¶ã€‚</p><span id="more"></span><p>æºç å·²ç»ä¸Šä¼ <a href="https://github.com/catbro666/lua-debugger">Github</a>ï¼Œæ¬¢è¿watch&#x2F;starğŸ˜˜ã€‚</p>
          </div>



<h2 id="å®ç°åˆ†æ"><a href="#å®ç°åˆ†æ" class="headerlink" title="å®ç°åˆ†æ"></a>å®ç°åˆ†æ</h2><p>ç”±äºLuaæ˜¯åŠ¨æ€ç±»å‹è¯­è¨€ï¼Œå˜é‡å¯ä»¥æ˜¯ä»»ä½•å€¼ã€‚è€Œå‡½æ•°åœ¨Luaè¯­è¨€ä¸­åˆæ˜¯ç¬¬ä¸€ç±»å€¼ï¼Œä¸å…¶ä»–å€¼ä¸€æ ·ä½¿ç”¨ï¼Œå¯ä»¥è¢«å­˜æ”¾åœ¨å˜é‡ä¸­ã€ä½œä¸ºå‚æ•°æˆ–è¿”å›å€¼ä¼ é€’ã€‚æ‰€ä»¥ä¸€ä¸ªå‡½æ•°çš„åå­—æ˜¯ä¸ç¡®å®šçš„ï¼Œå®ƒå¯èƒ½æ˜¯ä»»æ„åå­—ï¼Œå–å†³äºå‡½æ•°è°ƒç”¨æ—¶å€™çš„å˜é‡çš„åç§°ã€‚</p>
<p>é€šè¿‡ä¸‹é¢è¿™ä¸ªç®€å•çš„ä¾‹å­ï¼Œå°±å¯ä»¥çœ‹å‡ºæ¥</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> ldb = <span class="built_in">require</span> <span class="string">&quot;luadebug&quot;</span></span><br><span class="line"><span class="keyword">local</span> setbp = ldb.setbreakpoint</span><br><span class="line"><span class="keyword">local</span> rmbp = ldb.removebreakpoint</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">foo</span><span class="params">()</span></span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">setbp(foo, <span class="number">6</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> bar = foo</span><br><span class="line"></span><br><span class="line">foo()</span><br><span class="line">bar()</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬åœ¨fooå‡½æ•°ä¸­æ·»åŠ äº†ä¸€ä¸ªæ–­ç‚¹ï¼Œå°†fooå‡½æ•°èµ‹å€¼ç»™å±€éƒ¨å˜é‡barï¼Œç„¶ååˆ†åˆ«ç”¨fooå’Œbarè°ƒç”¨å‡½æ•°ã€‚è¿è¡Œè¿™ä¸ªè„šæœ¬ç»“æœå¦‚ä¸‹ï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ lua namenotstable.lua</span><br><span class="line">Lua (<span class="built_in">local</span>)foo namenotstable.lua:6</span><br><span class="line">lua_debug&gt; cont</span><br><span class="line">Lua (<span class="built_in">local</span>)bar namenotstable.lua:6</span><br><span class="line">lua_debug&gt; cont</span><br></pre></td></tr></table></figure>

<p>è°ƒç”¨<code>foo()</code>å’Œ<code>bar()</code>éƒ½ä¼šç¢°åˆ°æ–­ç‚¹ï¼Œå‡½æ•°åç§°åˆ†åˆ«ä¸º<code>foo</code>å’Œ<code>bar</code>ã€‚</p>
<p>æ‰€ä»¥é€šè¿‡å‡½æ•°åç§°æ·»åŠ çš„æ–­ç‚¹å¹¶ä¸æ˜¯ç¡®å®šçš„ï¼Œå‡½æ•°åç§°å’Œå‡½æ•°ä¹‹é—´å¹¶ä¸æ˜¯ä¸€ä¸€æ˜ å°„çš„å…³ç³»ï¼Œè€Œå¯èƒ½æ˜¯må¯¹nçš„å…³ç³»ã€‚å°±ç®—å·²ç»åŒ¹é…åˆ°äº†ä¸€ä¸ªä¸æ–­ç‚¹è®¾ç½®çš„å‡½æ•°åç§°ä¸€è‡´çš„å‡½æ•°ï¼Œæˆ‘ä»¬ä¹Ÿä¸èƒ½ç®€å•åœ°å°†å‡½æ•°åç§°æ–­ç‚¹è½¬æ¢æˆç›¸åº”çš„å‡½æ•°æ–­ç‚¹ï¼Œè€Œæ˜¯ä»ç„¶éœ€è¦ç»´æŠ¤å‡½æ•°åç§°æ–­ç‚¹ã€‚</p>
<p>å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦å¢åŠ ä¸€ä¸ªç»´æŠ¤å‡½æ•°åç§°æ–­ç‚¹çš„æ•°æ®ç»“æ„â€”-æ–°çš„æ–­ç‚¹è¡¨<code>status.namebpt</code>ã€‚ç±»ä¼¼ä¹‹å‰åœ¨<a href="../2e777dd3/">05ä¼˜åŒ–æ–­ç‚¹ä¿¡æ¯æ•°æ®ç»“æ„</a>ä¸­æ·»åŠ çš„<code>status.funcbpt</code>è¡¨ï¼Œåªæ˜¯è¡¨çš„é”®ç”±ä¹‹å‰çš„å‡½æ•°å˜æˆäº†å‡½æ•°åç§°ã€‚<code>status.namebpt</code>è¡¨çš„å€¼åŒæ ·æ˜¯ä¸€ä¸ªè¡¨ï¼Œè¯¥è¡¨çš„é”®æ˜¯æ–­ç‚¹è¡Œå·ï¼Œå€¼ä¸ºæ–­ç‚¹idã€‚åŒæ ·åœ°ï¼Œä¸ºäº†å¿«é€Ÿè·å–æ–­ç‚¹ä¸ªæ•°ï¼Œæˆ‘ä»¬åœ¨è¡¨ä¸­é¢å¤–åŠ äº†ä¸€ä¸ªç‰¹æ®Šçš„<code>num</code>å­—æ®µä¿å­˜è¯¥å‡½æ•°åç§°ä¸­çš„æ–­ç‚¹ä¸ªæ•°ã€‚</p>
<p>é€šè¿‡ä¸‹é¢çš„ä¾‹å­æ¥ç›´è§‚åœ°çœ‹ä¸€ä¸‹ï¼Œå‡è®¾æˆ‘ä»¬çš„<code>bptable</code>è¡¨ä¸­æ·»åŠ äº†ä¸¤ä¸ªæ–­ç‚¹å¦‚ä¸‹ï¼ˆ<code>name</code>å­—æ®µç”¨æ¥ä¿å­˜å‡½æ•°åç§°ï¼‰ï¼š</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line">bptable[<span class="number">1</span>] = &#123;name = <span class="string">&quot;foo&quot;</span>, line = <span class="number">10</span>&#125;</span><br><span class="line">bptable[<span class="number">2</span>] = &#123;name = <span class="string">&quot;foo&quot;</span>, line = <span class="number">20</span>&#125;</span><br></pre></td></tr></table></figure>

<p>å¯¹åº”çš„åœ¨<code>namebpt</code>è¡¨ä¸­çš„æ“ä½œå¦‚ä¸‹ï¼š</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line">namebpt[<span class="string">&quot;foo&quot;</span>] = &#123;&#125;          <span class="comment">-- æ„é€ è¡¨</span></span><br><span class="line">namebpt[<span class="string">&quot;foo&quot;</span>][<span class="number">10</span>] = <span class="number">1</span>	     <span class="comment">-- å‡½æ•°åfooï¼Œè¡Œå·10ï¼Œæ–­ç‚¹idä¸º1</span></span><br><span class="line">namebpt[<span class="string">&quot;foo&quot;</span>].num = <span class="number">1</span>       <span class="comment">-- è¯¥å‡½æ•°ç¬¬ä¸€ä¸ªæ–­ç‚¹</span></span><br><span class="line">namebpt[<span class="string">&quot;foo&quot;</span>][<span class="number">20</span>] = <span class="number">2</span>       <span class="comment">-- å‡½æ•°åfooï¼Œè¡Œå·20ï¼Œæ–­ç‚¹idä¸º2</span></span><br><span class="line">namebpt[<span class="string">&quot;foo&quot;</span>].num = namebpt[<span class="string">&quot;foo&quot;</span>].num + <span class="number">1</span>	<span class="comment">-- æ–­ç‚¹ä¸ªæ•°+1</span></span><br></pre></td></tr></table></figure>

<p>OKï¼Œåˆ†æå®Œäº†ï¼Œæ¥ä¸‹æ¥å¼€å§‹ä¿®æ”¹ç›¸åº”çš„ä»£ç å®ç°ã€‚</p>
<h2 id="æ·»åŠ æ–­ç‚¹"><a href="#æ·»åŠ æ–­ç‚¹" class="headerlink" title="æ·»åŠ æ–­ç‚¹"></a>æ·»åŠ æ–­ç‚¹</h2><p>æŒ‰ç…§æƒ¯ä¾‹ï¼Œæˆ‘ä»¬å…ˆä¿®æ”¹è®¾ç½®æ–­ç‚¹å‡½æ•°ã€‚å› ä¸ºæ”¯æŒäº†é€šè¿‡å‡½æ•°åç§°è®¾ç½®æ–­ç‚¹ï¼Œç¬¬ä¸€ä¸ªå‚æ•°éœ€è¦æ”¯æŒstringç±»å‹ã€‚ä¸ºäº†ç®€æ´åŠä»£ç é‡ç”¨ï¼Œæˆ‘ä»¬å°†ä¹‹å‰é€šè¿‡å‡½æ•°è®¾ç½®æ–­ç‚¹çš„æ“ä½œå°è£…æˆäº†<code>setfuncbp</code>å‡½æ•°ï¼Œå¦å¤–å°†é€šè¿‡å‡½æ•°åç§°è®¾ç½®æ–­ç‚¹çš„æ“ä½œå°è£…æˆäº†<code>setnamebp</code>å‡½æ•°ã€‚</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">setbreakpoint</span><span class="params">(where, line)</span></span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">type</span>(where) ~= <span class="string">&quot;function&quot;</span> <span class="keyword">and</span> <span class="built_in">type</span>(where) ~= <span class="string">&quot;string&quot;</span>)</span><br><span class="line">        <span class="keyword">or</span> ( line <span class="keyword">and</span> <span class="built_in">type</span>(line) ~= <span class="string">&quot;number&quot;</span>) <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">io</span>.<span class="built_in">write</span>(<span class="string">&quot;invalid parameter\n&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">type</span>(where) == <span class="string">&quot;function&quot;</span> <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span> setfuncbp(where, line)</span><br><span class="line">    <span class="keyword">else</span>            <span class="comment">-- &quot;string&quot;</span></span><br><span class="line">        <span class="keyword">return</span> setnamebp(where, line)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥ï¼Œæ¥çœ‹ä¸‹<code>setnamebp</code>å‡½æ•°çš„å®ç°ï¼š</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">setnamebp</span><span class="params">(name, line)</span></span></span><br><span class="line">    <span class="keyword">local</span> s = <span class="built_in">status</span></span><br><span class="line">    <span class="keyword">local</span> namebp = s.namebpt[name]</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> line <span class="keyword">then</span>                    <span class="comment">-- å¦‚æœæ²¡æœ‰æŒ‡å®šè¡Œå·</span></span><br><span class="line">        line = <span class="number">0</span>                        <span class="comment">-- ç”¨ä¸€ä¸ªç‰¹æ®Šå€¼0æ¥è¡¨ç¤ºç¬¬ä¸€ä¸ªæœ‰æ•ˆè¡Œ</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="comment">-- æ˜¯å¦å·²ç»æ·»åŠ äº†ç›¸åŒçš„æ–­ç‚¹</span></span><br><span class="line">    <span class="keyword">if</span> namebp <span class="keyword">and</span> namebp[line] <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span> namebp[line]</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    s.bpid = s.bpid + <span class="number">1</span></span><br><span class="line">    s.bpnum = s.bpnum + <span class="number">1</span></span><br><span class="line">    s.bptable[s.bpid] = &#123;name = name, line = line&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> namebp <span class="keyword">then</span>                  <span class="comment">-- è¯¥å‡½æ•°åç§°çš„ç¬¬ä¸€ä¸ªæ–­ç‚¹</span></span><br><span class="line">        s.namebpt[name] = &#123;&#125;</span><br><span class="line">        namebp = s.namebpt[name]</span><br><span class="line">        namebp.num = <span class="number">0</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    namebp.num = namebp.num + <span class="number">1</span></span><br><span class="line">    namebp[line] = s.bpid</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> s.bpnum == <span class="number">1</span> <span class="keyword">then</span>                <span class="comment">-- ç¬¬ä¸€ä¸ªå…¨å±€æ–­ç‚¹</span></span><br><span class="line">        <span class="built_in">debug</span>.<span class="built_in">sethook</span>(hook, <span class="string">&quot;c&quot;</span>)        <span class="comment">-- è®¾ç½®é’©å­å‡½æ•°çš„&quot;call&quot;äº‹ä»¶</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> s.bpid                       <span class="comment">--&gt; è¿”å›æ–­ç‚¹id</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>å› ä¸ºæˆ‘ä»¬æ”¯æŒä¸æŒ‡å®šè¡Œå·ï¼Œä½†æˆ‘ä»¬å¹¶ä¸ç¡®å®šå‡½æ•°çš„ç¬¬ä¸€ä¸ªæœ‰æ•ˆè¡Œæ˜¯ä»€ä¹ˆã€‚ä¸ºäº†æ–¹ä¾¿åœ°è®°å½•æ–­ç‚¹ï¼Œåˆä¸è‡³äºä¸å®é™…çš„æ–­ç‚¹è¡Œå†²çªï¼Œæˆ‘ä»¬ç”¨äº†ä¸€ä¸ªç‰¹æ®Šå€¼0æ¥è¡¨ç¤ºè¿™ç§æƒ…å†µã€‚</p>
<p>åç»­çš„é€»è¾‘ä¸<code>setfuncbp</code>å‡½æ•°åŸºæœ¬ä¸€è‡´ï¼Œå¦‚æœå·²ç»æ·»åŠ äº†ç›¸åŒçš„æ–­ç‚¹ï¼Œåˆ™è¿”å›ä¹‹å‰çš„æ–­ç‚¹idã€‚ç„¶ååˆ†åˆ«åœ¨<code>bptable</code>è¡¨å’Œ<code>namebp</code>è¡¨ä¸­æ·»åŠ æ–­ç‚¹ã€‚è¿™é‡Œä¸å†èµ˜è¿°ã€‚</p>
<h2 id="åˆ é™¤æ–­ç‚¹"><a href="#åˆ é™¤æ–­ç‚¹" class="headerlink" title="åˆ é™¤æ–­ç‚¹"></a>åˆ é™¤æ–­ç‚¹</h2><p>åˆ é™¤æ–­ç‚¹å‡½æ•°çš„æ”¹åŠ¨ä¸å¤§ã€‚ä¸»è¦æ˜¯è¦åŒºåˆ†åˆ é™¤çš„æ˜¯å“ªç±»æ–­ç‚¹ï¼Œè¿™ä¸ªå¯ä»¥é€šè¿‡<code>s.bptable</code>è¡¨ä¸­<code>id</code>æ‰€å¯¹åº”çš„æ–­ç‚¹ä¿¡æ¯æ¥åˆ¤æ–­ã€‚å¦‚æœæœ‰funcåˆ™è¯´æ˜æ˜¯é€šè¿‡å‡½æ•°æ·»åŠ çš„æ–­ç‚¹ï¼Œå¦åˆ™åˆ™æ˜¯é€šè¿‡å‡½æ•°åç§°æ·»åŠ çš„æ–­ç‚¹ã€‚æ ¹æ®æƒ…å†µåˆ é™¤<code>s.funcbpt</code>æˆ–è€…<code>s.namebpt</code>è¡¨ä¸­çš„æ–­ç‚¹ï¼Œæœ€ååˆ é™¤<code>s.bptable</code>è¡¨ä¸­çš„æ–­ç‚¹ã€‚</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">removebreakpoint</span><span class="params">(id)</span></span></span><br><span class="line">    <span class="keyword">local</span> s = <span class="built_in">status</span></span><br><span class="line">    <span class="keyword">if</span> s.bptable[id] == <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">local</span> func = s.bptable[id].func</span><br><span class="line">    <span class="keyword">local</span> name = s.bptable[id].name</span><br><span class="line">    <span class="keyword">local</span> line = s.bptable[id].line</span><br><span class="line"></span><br><span class="line">    <span class="keyword">local</span> dstbp = <span class="literal">nil</span></span><br><span class="line">    <span class="keyword">if</span> func <span class="keyword">then</span></span><br><span class="line">        dstbp = s.funcbpt[func]</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        dstbp = s.namebpt[name]</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">if</span> dstbp <span class="keyword">and</span> dstbp[line] <span class="keyword">then</span></span><br><span class="line">        dstbp.num = dstbp.num - <span class="number">1</span></span><br><span class="line">        dstbp[line] = <span class="literal">nil</span></span><br><span class="line">        <span class="keyword">if</span> dstbp.num == <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">            dstbp = <span class="literal">nil</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    s.bptable[id] = <span class="literal">nil</span></span><br><span class="line">    s.bpnum = s.bpnum - <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> s.bpnum == <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">debug</span>.<span class="built_in">sethook</span>()                 <span class="comment">-- ç§»é™¤é’©å­</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>



<h2 id="è·å–å‡½æ•°ä¿¡æ¯"><a href="#è·å–å‡½æ•°ä¿¡æ¯" class="headerlink" title="è·å–å‡½æ•°ä¿¡æ¯"></a>è·å–å‡½æ•°ä¿¡æ¯</h2><p>æ­£å¦‚å‰é¢æåˆ°è¿‡çš„ï¼Œå› ä¸ºå‡½æ•°åç§°ä¿¡æ¯æ˜¯ä¸ç¡®å®šçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¿®æ”¹äº†<code>getfuncinfo</code>å‡½æ•°å®ç°ï¼Œä¸å†ç¼“å­˜å‡½æ•°åç§°ä¿¡æ¯ï¼Œè€Œåªç¼“å­˜ç¡®å®šçš„å‡½æ•°ä¿¡æ¯ã€‚</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">getfuncinfo</span> <span class="params">(func)</span></span></span><br><span class="line">    <span class="keyword">local</span> s = <span class="built_in">status</span></span><br><span class="line">    <span class="keyword">local</span> info = s.funcinfos[func]</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> info <span class="keyword">then</span></span><br><span class="line">        info = <span class="built_in">debug</span>.<span class="built_in">getinfo</span>(func, <span class="string">&quot;SL&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> (info.activelines) <span class="keyword">then</span></span><br><span class="line">            info.sortedlines = &#123;&#125;</span><br><span class="line">            <span class="keyword">for</span> k, _ <span class="keyword">in</span> <span class="built_in">pairs</span>(info.activelines) <span class="keyword">do</span></span><br><span class="line">               <span class="built_in">table</span>.<span class="built_in">insert</span>(info.sortedlines, k)</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            <span class="built_in">table</span>.<span class="built_in">sort</span>(info.sortedlines)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        s.funcinfos[func] = info</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> info</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>



<h2 id="é’©å­å‡½æ•°"><a href="#é’©å­å‡½æ•°" class="headerlink" title="é’©å­å‡½æ•°"></a>é’©å­å‡½æ•°</h2><p>é’©å­å‡½æ•°çš„æ”¹åŠ¨ä¸»è¦æ˜¯åœ¨calläº‹ä»¶ã€‚å‡½æ•°åç§°æ¯æ¬¡éƒ½æ ¹æ®è°ƒç”¨æ ˆå®æ—¶è·å–ã€‚é¦–å…ˆåœ¨å‡½æ•°æ–­ç‚¹è¡¨<code>s.funcbpt</code>ä¸­æŸ¥æ‰¾å½“å‰å‡½æ•°æ˜¯å¦æœ‰æ–­ç‚¹ï¼Œå¦‚æœæ²¡æœ‰åˆ™å†å»å‡½æ•°åç§°æ–­ç‚¹è¡¨<code>s.namebpt</code>ä¸­æŸ¥æ‰¾ã€‚éœ€è¦æ£€æŸ¥æ–­ç‚¹è¡Œå·æ˜¯å¦åœ¨å½“å‰å‡½æ•°çš„å®šä¹‰èŒƒå›´ä¹‹å†…ï¼Œåªæœ‰å½“è¡Œå·åœ¨èŒƒå›´ä¹‹å†…æ‰è®¤ä¸ºåŒ¹é…ã€‚å¦‚æœæ²¡æœ‰æŒ‡å®šè¡Œå·çš„è¯ï¼ˆé»˜è®¤ä¸ºç¬¬ä¸€ä¸ªæœ‰æ•ˆè¡Œï¼‰ï¼Œåˆ™æ€»æ˜¯è®¤ä¸ºåŒ¹é…ã€‚å¦å¤–ï¼Œåœ¨è°ƒç”¨æ ˆä¿¡æ¯è¡¨ä¸­ï¼Œåˆ†åˆ«å°†ç¡®å®šçš„å‡½æ•°ä¿¡æ¯<code>funcinfo</code>å’Œè°ƒç”¨æ ˆç›¸å…³ä¿¡æ¯<code>stackinfo</code>åˆ†åˆ«ä¿å­˜ï¼Œä»¥ä¾›returnäº‹ä»¶å’Œlineäº‹ä»¶æ—¶ä½¿ç”¨ã€‚</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">hook</span> <span class="params">(event, line)</span></span></span><br><span class="line">    <span class="keyword">local</span> s = <span class="built_in">status</span></span><br><span class="line">    <span class="keyword">if</span> event == <span class="string">&quot;call&quot;</span> <span class="keyword">or</span> event == <span class="string">&quot;tail call&quot;</span> <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">local</span> stackinfo = <span class="built_in">debug</span>.<span class="built_in">getinfo</span>(<span class="number">2</span>, <span class="string">&quot;nf&quot;</span>)</span><br><span class="line">        <span class="keyword">local</span> func = stackinfo.func</span><br><span class="line">        <span class="keyword">local</span> name = stackinfo.name</span><br><span class="line">        <span class="keyword">local</span> funcinfo = getfuncinfo(func)</span><br><span class="line">        <span class="keyword">local</span> hasbreak = <span class="literal">false</span></span><br><span class="line">        <span class="keyword">if</span> s.funcbpt[func] <span class="keyword">then</span></span><br><span class="line">            hasbreak = <span class="literal">true</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> hasbreak <span class="keyword">and</span> s.namebpt[name] <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">local</span> <span class="built_in">min</span> = funcinfo.linedefined</span><br><span class="line">            <span class="keyword">local</span> <span class="built_in">max</span> = funcinfo.lastlinedefined</span><br><span class="line">            <span class="keyword">for</span> k, _ <span class="keyword">in</span> <span class="built_in">pairs</span>(s.namebpt[name]) <span class="keyword">do</span></span><br><span class="line">                <span class="keyword">if</span> k ~= <span class="string">&quot;num&quot;</span> <span class="keyword">and</span> ((k &gt;= <span class="built_in">min</span> <span class="keyword">and</span> k &lt;= <span class="built_in">max</span>) <span class="keyword">or</span> k == <span class="number">0</span>) <span class="keyword">then</span></span><br><span class="line">                    hasbreak = <span class="literal">true</span></span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">if</span> event == <span class="string">&quot;call&quot;</span> <span class="keyword">then</span>     <span class="comment">-- for tail call, just overwrite</span></span><br><span class="line">            s.stackdepth = s.stackdepth + <span class="number">1</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        s.stackinfos[s.stackdepth] =</span><br><span class="line">            &#123;stackinfo = stackinfo, funcinfo = funcinfo, hasbreak = hasbreak&#125;</span><br><span class="line">        <span class="comment">-- found breakpoint in current function</span></span><br><span class="line">        <span class="keyword">if</span> hasbreak <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">debug</span>.<span class="built_in">sethook</span>(hook, <span class="string">&quot;crl&quot;</span>)	<span class="comment">-- add &quot;line&quot; event</span></span><br><span class="line">        <span class="keyword">else</span>        <span class="comment">-- no breakpoints found</span></span><br><span class="line">            <span class="built_in">debug</span>.<span class="built_in">sethook</span>(hook, <span class="string">&quot;cr&quot;</span>)   <span class="comment">-- remove &quot;line&quot; event temporarily</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">elseif</span> event == <span class="string">&quot;return&quot;</span> <span class="keyword">or</span> event == <span class="string">&quot;tail return&quot;</span> <span class="keyword">then</span></span><br><span class="line">            <span class="comment">-- çœç•¥</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>lineäº‹ä»¶ä¹Ÿéœ€è¦åšç›¸åº”çš„ä¿®æ”¹</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">hook</span> <span class="params">(event, line)</span></span></span><br><span class="line">    <span class="comment">-- çœç•¥</span></span><br><span class="line">    <span class="keyword">elseif</span> event == <span class="string">&quot;line&quot;</span> <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">local</span> sinfo = s.stackinfos[s.stackdepth].stackinfo</span><br><span class="line">        <span class="keyword">local</span> finfo = s.stackinfos[s.stackdepth].funcinfo</span><br><span class="line">        <span class="keyword">local</span> func = sinfo.func</span><br><span class="line">        <span class="keyword">local</span> name = sinfo.name</span><br><span class="line">        <span class="keyword">local</span> funcbp = s.funcbpt[func]</span><br><span class="line">        <span class="keyword">local</span> namebp = s.namebpt[name]</span><br><span class="line">        <span class="keyword">if</span> (funcbp <span class="keyword">and</span> funcbp[line]) <span class="keyword">or</span> (namebp <span class="keyword">and</span> namebp[line])</span><br><span class="line">            <span class="keyword">or</span> (namebp <span class="keyword">and</span> namebp[<span class="number">0</span>] <span class="keyword">and</span> line == finfo.sortedlines[<span class="number">1</span>]) <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">local</span> prompt = <span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">&quot;%s (%s)%s %s:%d\n&quot;</span>,</span><br><span class="line">                finfo.what, sinfo.namewhat, name, finfo.short_src, line)</span><br><span class="line">            <span class="built_in">io</span>.<span class="built_in">write</span>(prompt)</span><br><span class="line">            <span class="built_in">debug</span>.<span class="built_in">debug</span>()</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>åœ¨åˆ¤æ–­å½“å‰è¡Œæ˜¯å¦æœ‰æ–­ç‚¹æ—¶ï¼Œé™¤äº†æŸ¥çœ‹<code>funcbpt</code>è¡¨ï¼Œè¿˜éœ€è¦æŸ¥çœ‹<code>namebpt</code>è¡¨ï¼Œå¯¹äºå‡½æ•°åç§°æ–­ç‚¹æ²¡æœ‰æŒ‡å®šè¡Œå·çš„æƒ…å†µï¼Œåˆ¤æ–­å½“å‰è¡Œæ˜¯ä¸æ˜¯ç¬¬ä¸€ä¸ªæœ‰æ•ˆè¡Œã€‚æ‰“å°æç¤ºä¿¡æ¯æ—¶ï¼Œåˆ™ä»<code>stackinfos</code>è¡¨ä¸­ä¿å­˜çš„ä¿¡æ¯ä¸­è·å–ã€‚</p>
<h2 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h2><p>ä»£ç ä¿®æ”¹å¥½äº†ï¼Œæˆ‘ä»¬æ¥æµ‹è¯•ä¸‹é€šè¿‡å‡½æ•°åç§°æ·»åŠ æ–­ç‚¹çš„åŠŸèƒ½ã€‚ç¼–å†™å¦‚ä¸‹æµ‹è¯•è„šæœ¬ï¼š</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> ldb = <span class="built_in">require</span> <span class="string">&quot;luadebug&quot;</span></span><br><span class="line"><span class="keyword">local</span> setbp = ldb.setbreakpoint</span><br><span class="line"><span class="keyword">local</span> rmbp = ldb.removebreakpoint</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">foo</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">local</span> a = <span class="number">0</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">bar</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">local</span> a = <span class="number">0</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">pee</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">local</span> a = <span class="number">0</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> id1 = setbp(foo)</span><br><span class="line"><span class="keyword">local</span> id2 = setbp(foo, <span class="number">7</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> id3 = setbp(<span class="string">&quot;bar&quot;</span>)</span><br><span class="line"><span class="keyword">local</span> id4 = setbp(<span class="string">&quot;bar&quot;</span>, <span class="number">11</span>)</span><br><span class="line"><span class="keyword">local</span> id5 = setbp(<span class="string">&quot;bar&quot;</span>, <span class="number">100</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> id6 = setbp(pee)</span><br><span class="line"><span class="keyword">local</span> id7 = setbp(<span class="string">&quot;pee&quot;</span>, <span class="number">15</span>)</span><br><span class="line"></span><br><span class="line">foo()</span><br><span class="line">bar()</span><br><span class="line">pee()</span><br><span class="line"></span><br><span class="line">rmbp(id1)</span><br><span class="line">rmbp(id3)</span><br><span class="line">rmbp(id6)</span><br><span class="line"></span><br><span class="line">foo()</span><br><span class="line">bar()</span><br><span class="line">pee()</span><br><span class="line"></span><br><span class="line">rmbp(id2)</span><br><span class="line">rmbp(id4)</span><br><span class="line">rmbp(id7)</span><br><span class="line"></span><br><span class="line">foo()</span><br><span class="line">bar()</span><br><span class="line">pee()</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬æ·»åŠ äº†ä¸‰ä¸ªå‡½æ•°ï¼Œå…¶ä¸­fooå‡½æ•°ä»¥å‡½æ•°ä½œä¸ºå‚æ•°æ·»åŠ æ–­ç‚¹ï¼Œbarå‡½æ•°ä»¥å‡½æ•°åç§°ä½œä¸ºå‚æ•°æ·»åŠ æ–­ç‚¹ï¼Œpeeå‡½æ•°åˆ†åˆ«ç”¨å‡½æ•°å’Œå‡½æ•°åæ·»åŠ äº†ä¸€ä¸ªæ–­ç‚¹ã€‚æ·»åŠ å®Œæ–­ç‚¹ï¼Œå…ˆåˆ†åˆ«è°ƒç”¨ä¸€æ¬¡ï¼Œé¢„æœŸæ¯ä¸ªå‡½æ•°éƒ½ä¼šç¢°åˆ°ä¸¤ä¸ªæ–­ç‚¹ã€‚æ¥ç€ä¸‰ä¸ªå‡½æ•°å„åˆ é™¤ä¸€ä¸ªæ–­ç‚¹ï¼Œå†å„è°ƒç”¨ä¸€æ¬¡ï¼Œé¢„æœŸæ¯ä¸ªå‡½æ•°éƒ½ä¼šç¢°åˆ°ä¸€ä¸ªæ–­ç‚¹ã€‚æœ€åä¸‰ä¸ªå‡½æ•°å†å„åˆ é™¤ä¸€ä¸ªæ–­ç‚¹ï¼Œå†å„è°ƒç”¨ä¸€æ¬¡ï¼Œé¢„æœŸä¸ç¢°åˆ°æ–­ç‚¹ã€‚</p>
<p>è¿è¡Œæµ‹è¯•è„šæœ¬ï¼Œç»“æœç¬¦åˆé¢„æœŸã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ lua test.lua</span><br><span class="line">Lua (<span class="built_in">local</span>)foo test.lua:6</span><br><span class="line">lua_debug&gt; cont</span><br><span class="line">Lua (<span class="built_in">local</span>)foo test.lua:7</span><br><span class="line">lua_debug&gt; cont</span><br><span class="line">Lua (<span class="built_in">local</span>)bar test.lua:10</span><br><span class="line">lua_debug&gt; cont</span><br><span class="line">Lua (<span class="built_in">local</span>)bar test.lua:11</span><br><span class="line">lua_debug&gt; cont</span><br><span class="line">Lua (<span class="built_in">local</span>)pee test.lua:14</span><br><span class="line">lua_debug&gt; cont</span><br><span class="line">Lua (<span class="built_in">local</span>)pee test.lua:15		<span class="comment"># ç¬¬ä¸€æ¬¡è°ƒç”¨ï¼Œæ¯ä¸ªå‡½æ•°ç¢°åˆ°ä¸¤ä¸ªæ–­ç‚¹</span></span><br><span class="line">lua_debug&gt; cont					</span><br><span class="line">Lua (<span class="built_in">local</span>)foo test.lua:7</span><br><span class="line">lua_debug&gt; cont</span><br><span class="line">Lua (<span class="built_in">local</span>)bar test.lua:11</span><br><span class="line">lua_debug&gt; cont</span><br><span class="line">Lua (<span class="built_in">local</span>)pee test.lua:15		<span class="comment"># ç¬¬äºŒæ¬¡è°ƒç”¨ï¼Œæ¯ä¸ªå‡½æ•°ç¢°åˆ°ä¸€ä¸ªæ–­ç‚¹</span></span><br><span class="line">lua_debug&gt; cont</span><br><span class="line">$								<span class="comment"># ç¬¬ä¸‰æ¬¡è°ƒç”¨ï¼Œä¸å†ç¢°åˆ°æ–­ç‚¹</span></span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>ç¼–ç¨‹å¼€å‘</category>
        <category>Lua</category>
      </categories>
      <tags>
        <tag>Lua</tag>
        <tag>è°ƒè¯•</tag>
      </tags>
  </entry>
  <entry>
    <title>SSLåŠGMVPNæ¡æ‰‹åè®®è¯¦è§£</title>
    <url>/posts/59c71edb/</url>
    <content><![CDATA[<div class="note primary">
            <p>ä¹‹å‰å†™è¿‡ä¸€ç¯‡å…³äº<a href="../e92ef4b4">SSLåè®®çš„æ–‡ç« </a>ï¼Œä¸»è¦ä»‹ç»äº†åŠ å¯†å­¦çš„åŸºç¡€ï¼Œå¹¶ä»æ•´ä½“ä¸Šå¯¹SSLåè®®åšäº†ä»‹ç»ã€‚ç”±äºç¯‡å¹…åŸå› ï¼ŒSSLæ¡æ‰‹çš„è¯¦ç»†æµç¨‹æ²¡æœ‰æ·±å…¥ä»‹ç»ã€‚æœ¬æ–‡å°†æ‹†è§£æ¡æ‰‹æµç¨‹ï¼Œåœ¨æ¶ˆæ¯çº§åˆ«å¯¹æ¡æ‰‹è¿›è¡Œè¯¦ç»†åœ°ä»‹ç»ã€‚è¿˜æ²¡æœ‰åŠ å¯†å­¦åŸºæœ¬æ¦‚å¿µçš„ã€æˆ–è€…ä¸æ¸…æ¥šSSLåè®®çš„åŸºæœ¬æƒ…å†µçš„å»ºè®®å…ˆçœ‹ä¸€ä¸‹å‰é¢ä¸€ç¯‡çš„å†…å®¹ã€‚å¦å¤–ï¼Œæœ¬æ–‡ä¸»è¦æ˜¯é’ˆå¯¹TLSv1.2å’ŒGMVPNçš„æƒ…å†µï¼Œå¯¹äºTLSv1.3æš‚ä¸æ¶‰åŠã€‚</p>
          </div>

<span id="more"></span>



<h2 id="æ¦‚è§ˆ"><a href="#æ¦‚è§ˆ" class="headerlink" title="æ¦‚è§ˆ"></a>æ¦‚è§ˆ</h2><p>æœ¬æ–‡å°†åˆ†å¦‚ä¸‹å‡ ä¸ªéƒ¨åˆ†å±•å¼€ï¼Œå…¶ä¸­å¯†é’¥äº¤æ¢å’Œèº«ä»½è®¤è¯éƒ¨åˆ†ä¼šç€é‡è¿›è¡Œè®²è§£ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/catbro666/catbro666.github.io/posts/59c71edb/SSL%E6%8F%A1%E6%89%8B%E9%80%BB%E8%BE%91%E5%9B%BE-%E6%A1%86%E6%9E%B6.png" alt="SSLæ¡æ‰‹é€»è¾‘å›¾-æ¡†æ¶" loading="lazy"></p>
<p>æˆ‘ä»¬éƒ½çŸ¥é“SSLåè®®æœ€ä¸»è¦çš„ä½œç”¨å°±æ˜¯ç”¨æ¥åå•†é€šä¿¡åŒæ–¹çš„å®‰å…¨å‚æ•°ï¼Œç„¶ååŸºäºåå•†çš„å®‰å…¨å‚æ•°è¿›è¡Œå®‰å…¨é€šä¿¡ã€‚æ‰€ä»¥é¦–å½“å…¶å†²åœ°ï¼Œç¬¬ä¸€ä¸ªè¦è§£å†³çš„é—®é¢˜å°±æ˜¯å¦‚ä½•è¿›è¡Œå¯†é’¥äº¤æ¢ã€‚è€ƒè™‘åˆ°å¯¹ç§°å¯†ç å’Œéå¯¹ç§°å¯†ç çš„æ€§èƒ½å·®å¼‚æ˜¾è‘—ï¼Œåœ¨å®é™…ä½¿ç”¨ä¸­å¾€å¾€ä½¿ç”¨å¯¹ç§°å¯†ç å¯¹æ•°æ®è¿›è¡ŒåŠ å¯†ï¼Œè€Œä½¿ç”¨éå¯¹ç§°å¯†ç æ¥å®Œæˆé‡è¦çš„å¯†é’¥äº¤æ¢å’Œèº«ä»½è®¤è¯ã€‚</p>
<h3 id="åŸºæœ¬æ¡æ‰‹æµç¨‹"><a href="#åŸºæœ¬æ¡æ‰‹æµç¨‹" class="headerlink" title="åŸºæœ¬æ¡æ‰‹æµç¨‹"></a>åŸºæœ¬æ¡æ‰‹æµç¨‹</h3><p>ä¸‹å›¾æ˜¯ä¸€ä¸ªæˆ‘ä»¬é€šå¸¸çœ‹åˆ°çš„SSLæ¡æ‰‹æµç¨‹å›¾ï¼ŒSSLåè®®åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼šæ¡æ‰‹é˜¶æ®µå’Œåº”ç”¨é˜¶æ®µã€‚æ¡æ‰‹é˜¶æ®µä¸»è¦è´Ÿè´£åå•†å®‰å…¨å‚æ•°ï¼Œåº”ç”¨é˜¶æ®µåˆ™åŸºäºå‰é¢åå•†çš„å®‰å…¨å‚æ•°è¿›è¡Œæ•°æ®é€šä¿¡ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/catbro666/catbro666.github.io/posts/59c71edb/SSL%E5%8D%8F%E8%AE%AE%E6%B5%81%E7%A8%8B%E5%9B%BE%E6%96%B0-%E5%9F%BA%E6%9C%AC.png" alt="SSLåè®®æµç¨‹å›¾æ–°-åŸºæœ¬" loading="lazy"></p>
<p>è¿™é‡Œå…ˆä¸å¯¹æ¯ä¸ªæ¶ˆæ¯è¿›è¡Œè¯¦ç»†çš„ä»‹ç»ï¼Œåé¢çš„å†…å®¹ä¸­ä¼šé™†ç»­æ¶‰åŠåˆ°ã€‚å…¶ä¸­å¸¦*å·çš„è¡¨ç¤ºå¯é€‰æ¶ˆæ¯æˆ–è€…æ ¹æ®å‰é¢æ¶ˆæ¯çš„æƒ…å†µè€Œå®šã€‚ChangeCipherSpecä½œä¸ºå•ç‹¬çš„ä¸€ç±»æ¶ˆæ¯åªæ˜¯è¡¨æ˜æ¡æ‰‹åè®®å·²ç»å®Œæˆï¼Œåç»­ä½¿ç”¨åå•†çš„åŠ å¯†å‚æ•°è¿›è¡Œé€šä¿¡ã€‚Finishedæ¶ˆæ¯å°±æ˜¯ç¬¬ä¸€ä¸ªåŠ å¯†çš„æ¶ˆæ¯ï¼Œç”¨äºéªŒè¯æ¡æ‰‹å·²ç»é¡ºåˆ©å®Œæˆã€‚è¿™é‡Œç¨å¾®æä¸€ä¸‹ServerHelloDoneè¿™ä¸ªæ¶ˆæ¯ï¼Œè¿™ä¸ªæ¶ˆæ¯å¹¶æ²¡æœ‰ä»€ä¹ˆå®é™…çš„å†…å®¹ï¼Œå®ƒå­˜åœ¨çš„ä¸»è¦åŸå› å°±æ˜¯å› ä¸ºå‰é¢çš„æ¶ˆæ¯CertificateRequestæ˜¯å¯é€‰çš„ï¼Œæ‰€ä»¥éœ€è¦æ˜ç¡®åœ°å‘Šè¯‰å®¢æˆ·ç«¯æœåŠ¡ç«¯è¿™è¾¹çš„æ¶ˆæ¯å‘å®Œäº†ï¼Œå¦åˆ™å®¢æˆ·ç«¯æ— ä»çŸ¥é“æ˜¯å¦è¯¥ç­‰å¾…CertificateRequestæ¶ˆæ¯ã€‚</p>
<h2 id="å¦‚ä½•è¿›è¡Œå¯†é’¥äº¤æ¢"><a href="#å¦‚ä½•è¿›è¡Œå¯†é’¥äº¤æ¢" class="headerlink" title="å¦‚ä½•è¿›è¡Œå¯†é’¥äº¤æ¢"></a>å¦‚ä½•è¿›è¡Œå¯†é’¥äº¤æ¢</h2><p>å¯†é’¥äº¤æ¢çš„æ–¹æ³•å¯ä»¥åˆ†æˆä¸¤å¤§ç±»ï¼šä¸€ç±»æ˜¯åŸºäºåŠ å¯†ã€ä¸€ç±»æ˜¯åŸºäºDHã€‚å‰è€…æœ‰RSAç®—æ³•ã€GMçš„ECCç®—æ³•ï¼›åè€…åˆ™æœ‰ECDHEã€GMçš„ECDHEã€‚</p>
<p>è™½ç„¶å‰é¢ä¸€ç¯‡å·²ç»è®²è¿‡äº†ï¼Œè¿™é‡Œè¿˜æ˜¯ç¨å¾®å¸¦ä¸€ä¸‹è¿™ä¸¤è€…çš„åŸºæœ¬åŸç†ï¼Œä»¥æ–¹ä¾¿åœ¨åé¢å®é™…çš„æ¡æ‰‹æµç¨‹ä¸­è¿›è¡Œå¯¹ç…§ã€‚</p>
<h3 id="å¯†é’¥äº¤æ¢åŸç†"><a href="#å¯†é’¥äº¤æ¢åŸç†" class="headerlink" title="å¯†é’¥äº¤æ¢åŸç†"></a>å¯†é’¥äº¤æ¢åŸç†</h3><p>å…¬é’¥åŠ å¯†çš„åŸºæœ¬åŸç†å¦‚ä¸‹ï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/catbro666/catbro666.github.io/posts/e92ef4b4/Public_key_encryption.svg" alt="Public_key_encryption" loading="lazy"></p>
<p>å…¬é’¥å¯†ç æœ‰ä¸¤ä¸ªå¯†é’¥ï¼Œå…¶ä¸­ä¸€ä¸ªæ˜¯å…¬å¼€å¯†é’¥ï¼Œå…¬å¼€å¯†é’¥å¯ä»¥éšæ„ä¼ æ’­ï¼Œå¦ä¸€ä¸ªæ˜¯ç§æœ‰å¯†é’¥ï¼Œéœ€è¦è‡ªå·±ä¸¥å¯†ä¿ç®¡ã€‚æ¯”å¦‚Bobè¦å‘æ¶ˆæ¯ç»™Aliceï¼ŒBobç”¨Aliceçš„å…¬é’¥å¯¹æ¶ˆæ¯è¿›è¡ŒåŠ å¯†ï¼Œç„¶åå‘é€ç»™Aliceï¼ŒAliceåˆ™ç”¨è‡ªå·±çš„ç§é’¥è¿›è¡Œè§£å¯†ã€‚</p>
<p>DHç±»ç®—æ³•çš„åŸç†å¯ä»¥ç”¨ä¸‹å›¾æ¥å½¢è±¡åœ°è§£é‡Šï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/catbro666/catbro666.github.io/posts/e92ef4b4/Diffie-Hellman_Key_Exchange.svg" alt="Diffie-Hellman_Key_Exchange" loading="lazy"></p>
<p>é¦–å…ˆåŒæ–¹åå•†ä¸€ä¸ªç›¸åŒçš„åº•è‰²ï¼ˆç®—æ³•å‚æ•°ï¼‰ï¼Œç„¶åå„è‡ªç”Ÿæˆè‡ªå·±ç§æœ‰çš„é¢œè‰²ï¼ˆç›¸å½“äºç§é’¥ï¼‰ï¼Œå¹¶é€šè¿‡æ··åˆå¾—åˆ°å¯¹åº”çš„å…¬æœ‰é¢œè‰²ï¼ˆç›¸å½“äºå…¬é’¥ï¼‰ã€‚éšååŒæ–¹äº¤æ¢å„è‡ªçš„å…¬æœ‰é¢œè‰²ï¼Œå¹¶ä¸è‡ªå·±çš„ç§é’¥é¢œè‰²æ··åˆï¼Œæœ€ç»ˆåå•†å‡ºä¸€ä¸ªç›¸åŒçš„é¢œè‰²ï¼ˆå³äº¤æ¢çš„å¯†é’¥ï¼‰ã€‚çªƒå¬è€…å°±ç®—å¾—åˆ°äº†åŒæ–¹äº¤æ¢çš„è¿™äº›ä¿¡æ¯ï¼Œä¹Ÿæ— æ³•ç”Ÿæˆç›¸åŒçš„å¯†é’¥ï¼Œ<strong>æ±‚è§£ç¦»æ•£å¯¹è±¡é—®é¢˜çš„å›°éš¾åº¦</strong>ä¿è¯äº†DHç®—æ³•çš„å®‰å…¨æ€§ã€‚</p>
<h3 id="TLS-RSAå¯†é’¥äº¤æ¢"><a href="#TLS-RSAå¯†é’¥äº¤æ¢" class="headerlink" title="TLS RSAå¯†é’¥äº¤æ¢"></a>TLS RSAå¯†é’¥äº¤æ¢</h3><p>è¿™ç§æƒ…å†µçš„å…¸å‹ç®—æ³•å¥—ä»¶æ˜¯AES256-SHAã€‚ï¼ˆç›¸å…³çš„æ¶ˆæ¯éƒ½å·²ç»æ ‡æˆè“è‰²äº†ï¼Œè¿åˆ°æ¶ˆæ¯å—ä¸Šçš„å®çº¿ç®­å¤´è¡¨ç¤ºè¯¥æ¶ˆæ¯ä¸­å¸¦äº†ç›¸åº”çš„å†…å®¹ã€‚ï¼‰</p>
<p><img src="https://cdn.jsdelivr.net/gh/catbro666/catbro666.github.io/posts/59c71edb/SSL%E5%8D%8F%E8%AE%AE%E6%B5%81%E7%A8%8B%E5%9B%BE%E6%96%B0-RSA%E5%AF%86%E9%92%A5%E4%BA%A4%E6%8D%A2.png" alt="SSLåè®®æµç¨‹å›¾æ–°-RSAå¯†é’¥äº¤æ¢" loading="lazy"></p>
<p>è¿™ç§æƒ…å†µæ¯”è¾ƒç®€å•ï¼Œé¦–å…ˆå®¢æˆ·ç«¯ç”Ÿæˆä¸€ä¸ªéšæœºæ•°åœ¨ClientHelloæ¶ˆæ¯ä¸­å¸¦è¿‡å»ï¼ŒæœåŠ¡ç«¯åŒæ ·ä¹Ÿç”Ÿæˆä¸€ä¸ªéšæœºæ•°åœ¨ServerHelloæ¶ˆæ¯ä¸­å¸¦è¿‡å»ã€‚ç„¶åæœåŠ¡ç«¯åœ¨Certificateæ¶ˆæ¯ä¸­å°†å®ƒçš„è¯ä¹¦å‘é€ç»™å®¢æˆ·ç«¯ï¼Œè¯ä¹¦ä¸­åŒ…å«äº†å®ƒçš„å…¬é’¥ã€‚å®¢æˆ·ç«¯æ”¶åˆ°ä¹‹åå°±ç”¨æœåŠ¡ç«¯çš„å…¬é’¥åŠ å¯†ä¸€ä¸ªéšæœºç”Ÿæˆçš„é¢„ä¸»å¯†é’¥ï¼Œé€šè¿‡ClientKeyExchangeæ¶ˆæ¯å‘é€ç»™æœåŠ¡ç«¯ï¼ŒæœåŠ¡ç«¯åˆ™ç”¨è‡ªå·±çš„ç§é’¥è¿›è¡Œè§£å¯†å¾—åˆ°é¢„ä¸»å¯†é’¥ã€‚è¿™é‡Œå°±æ˜¯åº”ç”¨äº†å‰é¢æåˆ°çš„å…¬é’¥åŠ å¯†çš„åŸç†ã€‚</p>
<p>é€šè¿‡å¯†é’¥äº¤æ¢ä¹‹åï¼ŒåŒæ–¹éƒ½å¾—åˆ°äº†é¢„ä¸»å¯†é’¥ï¼Œå†åŠ ä¸Šå‰é¢äº¤æ¢çš„ä¸¤ä¸ªéšæœºæ•°ï¼Œè¿™3ä¸ªææ–™ä¸€èµ·è¿›è¡Œå¯†é’¥æ´¾ç”Ÿå¾—åˆ°ä¸»å¯†é’¥ã€‚ä¸»å¯†é’¥å†ç»“åˆä¸¤ä¸ªéšæœºæ•°æ´¾ç”Ÿå‡ºæœ€ç»ˆçš„ä¼šè¯å¯†é’¥ã€‚</p>
<p>è¿™é‡Œå…ˆæŠ›å‡ºå‡ ä¸ªé—®é¢˜ä¾›å¤§å®¶æ€è€ƒã€‚ä¸ºä»€ä¹ˆä¸ç›´æ¥ç”¨é¢„ä¸»å¯†é’¥ï¼Œè€Œæ˜¯è¦è·Ÿä¸¤ä¸ªéšæœºæ•°æ´¾ç”Ÿå‡ºä¸»å¯†é’¥ï¼Ÿä¸ºä»€ä¹ˆä¸ç›´æ¥ç”¨ä¸»å¯†é’¥ï¼Œè€Œæ˜¯å†è·Ÿä¸¤ä¸ªéšæœºæ•°æ´¾ç”Ÿå‡ºä¼šè¯å¯†é’¥ï¼Ÿæˆ‘æš‚æ—¶ä¸åšè§£ç­”ï¼Œç•™åˆ°åé¢åˆ†è§£ã€‚</p>
<h3 id="TLS-ECDHEå¯†é’¥äº¤æ¢"><a href="#TLS-ECDHEå¯†é’¥äº¤æ¢" class="headerlink" title="TLS ECDHEå¯†é’¥äº¤æ¢"></a>TLS ECDHEå¯†é’¥äº¤æ¢</h3><p>è¿™ä¸ªæƒ…å†µçš„å…¸å‹ç®—æ³•å¥—ä»¶å¦‚ECDHE-RSA-AES256-GCM-SHA384ã€ECDHE-ECDSA-AES256-GCM-SHA384ã€‚è¿™é‡Œçš„ECè¡¨ç¤ºæ¤­åœ†æ›²çº¿ï¼ŒDHè¡¨ç¤ºåŸºäºDHç®—æ³•ï¼Œæœ€åä¸€ä¸ªEåˆ™è¡¨ç¤ºä½¿ç”¨ä¸´æ—¶å¯†é’¥è¿›è¡Œå¯†é’¥äº¤æ¢ï¼Œè€Œä¸æ˜¯è¯ä¹¦ç›¸å…³çš„éä¸´æ—¶å¯†é’¥ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/catbro666/catbro666.github.io/posts/59c71edb/SSL%E5%8D%8F%E8%AE%AE%E6%B5%81%E7%A8%8B%E5%9B%BE%E6%96%B0-ECDHE%E5%AF%86%E9%92%A5%E4%BA%A4%E6%8D%A2.png" alt="SSLåè®®æµç¨‹å›¾æ–°-ECDHEå¯†é’¥äº¤æ¢" loading="lazy"></p>
<p>æˆ‘ä»¬æ¥æ¯”è¾ƒä¸‹è·Ÿå‰ä¸€ç§æƒ…å†µçš„åŒºåˆ«ï¼Œé¦–å…ˆClientHelloå’ŒServerHelloæ¶ˆæ¯æ˜¯ä¸€æ ·çš„ï¼Œéƒ½å¸¦äº†ä¸€ä¸ªéšæœºæ•°ã€‚åŒºåˆ«åœ¨äºæœåŠ¡ç«¯æ˜¯é€šè¿‡ServerKeyExchangeæ¶ˆæ¯å‘é€äº†ä¸€ä¸ªä¸´æ—¶DHå‚æ•°ç»™å¯¹æ–¹ï¼ˆä¹Ÿå°±æ˜¯å‰é¢å°†DHåŸç†æ—¶çš„å…¬æœ‰é¢œè‰²ï¼‰ï¼Œç±»ä¼¼åœ°å®¢æˆ·ç«¯ä¹Ÿé€šè¿‡ClientKeyExchangeæ¶ˆæ¯æŠŠå®ƒçš„ä¸´æ—¶DHå‚æ•°å‘é€ç»™æœåŠ¡ç«¯ã€‚è¿™æ ·åŒæ–¹å°±äº¤æ¢äº†å½¼æ­¤çš„ä¸´æ—¶DHå…¬é’¥ï¼Œç„¶åä»–ä»¬å„è‡ªåˆ©ç”¨è‡ªå·±çš„ä¸´æ—¶ç§é’¥å’Œå¯¹æ–¹çš„ä¸´æ—¶å…¬é’¥è®¡ç®—å‡ºé¢„ä¸»å¯†é’¥ã€‚ä¸å‰ä¸€ç§æƒ…å†µçš„æœ€å¤§åŒºåˆ«å°±åœ¨äºæ­¤ï¼Œå‰è€…æ˜¯å®¢æˆ·ç«¯åŠ å¯†é¢„ä¸»å¯†é’¥å‘é€ç»™æœåŠ¡ç«¯ï¼Œåè€…æ˜¯åŒæ–¹äº¤æ¢ä¸´æ—¶DHå…¬é’¥ï¼Œç„¶åå„è‡ªè®¡ç®—å‡ºé¢„ä¸»å¯†é’¥ã€‚</p>
<p>å¾—åˆ°é¢„ä¸»å¯†é’¥åï¼Œåç»­çš„æµç¨‹å°±ä¸€æ ·äº†ã€‚ç»“åˆä¸¤ä¸ªéšæœºæ•°æ´¾ç”Ÿå‡ºä¸»å¯†é’¥ï¼Œç„¶åå†æ´¾ç”Ÿå‡ºä¼šè¯å¯†é’¥ã€‚</p>
<h3 id="GM-ECCå¯†é’¥äº¤æ¢"><a href="#GM-ECCå¯†é’¥äº¤æ¢" class="headerlink" title="GM ECCå¯†é’¥äº¤æ¢"></a>GM ECCå¯†é’¥äº¤æ¢</h3><p>æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹GM ECCå¯†é’¥äº¤æ¢çš„æƒ…å†µï¼Œè¿™ç§æƒ…å†µçš„å…¸å‹ç®—æ³•å¥—ä»¶ä¸ºECC-SM4-SM3ã€‚GMVPNåè®®ä¸€ä¸ªæœ€å¤§çš„åŒºåˆ«å°±æ˜¯å®ƒå¼•å…¥äº†åŒè¯ä¹¦ä½“ç³»ï¼Œæ¯ä¸€æ–¹éƒ½æœ‰ä¸¤ä¸ªè¯ä¹¦ï¼ˆå¯¹åº”åœ°å°±æœ‰ä¸¤ä¸ªç§é’¥ï¼‰ï¼Œä¸€ä¸ªåŠ å¯†è¯ä¹¦è´Ÿè´£è¿›è¡Œå¯†é’¥äº¤æ¢ï¼Œä¸€ä¸ªç­¾åè¯ä¹¦è´Ÿè´£è¿›è¡Œèº«ä»½è®¤è¯ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/catbro666/catbro666.github.io/posts/59c71edb/SSL%E5%8D%8F%E8%AE%AE%E6%B5%81%E7%A8%8B%E5%9B%BE%E6%96%B0-%E5%9B%BD%E5%AF%86ECC%E5%AF%86%E9%92%A5%E4%BA%A4%E6%8D%A2.png" alt="SSLåè®®æµç¨‹å›¾æ–°-å›½å¯†ECCå¯†é’¥äº¤æ¢" loading="lazy"></p>
<p>è·ŸTLS RSAå¯†é’¥äº¤æ¢çš„ä¸»è¦åŒºåˆ«æ˜¯ï¼Œè¿™ç§æƒ…å†µçš„è¯ä¹¦æ¶ˆæ¯ä¸­åŒ…å«äº†åŒè¯ä¹¦ï¼Œå®¢æˆ·ç«¯åœ¨åŠ å¯†é¢„ä¸»å¯†é’¥æ—¶æ˜¯ç”¨æœåŠ¡ç«¯åŠ å¯†è¯ä¹¦ä¸­çš„å…¬é’¥ã€‚ç›¸åº”åœ°ï¼ŒæœåŠ¡ç«¯åœ¨è§£å¯†æ—¶åˆ™ç”¨è‡ªå·±çš„åŠ å¯†ç§é’¥ã€‚åç»­çš„å¯†é’¥æ´¾ç”Ÿæµç¨‹éƒ½æ˜¯ä¸€æ ·çš„ï¼Œè¿™é‡Œå°±ä¸å†èµ˜è¿°äº†ã€‚</p>
<p>è‡³äºGMä¸ºä»€ä¹ˆè¦å¼•å…¥åŒè¯ä¹¦ï¼Œæ˜¯å› ä¸ºè¿™æ ·ä½ çš„åŠ å¯†ç§é’¥å°±åœ¨CAé‚£é‡Œæœ‰ç•™æ¡£ï¼Œå¿…è¦æ—¶å®ƒå°±å¯ä»¥è§£å¯†ä½ çš„æ¶ˆæ¯ã€‚Big brother is watching you!</p>
<h3 id="GM-ECDHEå¯†é’¥äº¤æ¢"><a href="#GM-ECDHEå¯†é’¥äº¤æ¢" class="headerlink" title="GM ECDHEå¯†é’¥äº¤æ¢"></a>GM ECDHEå¯†é’¥äº¤æ¢</h3><p>è¿™ç§æƒ…å†µçš„å…¸å‹ç®—æ³•å¥—ä»¶ä¸ºECDHE-SM4-SM3ã€‚åŒæ ·æ˜¯åŒè¯ä¹¦ï¼ŒServerKeyExchangeæ¶ˆæ¯ä¸­å¸¦äº†æœåŠ¡ç«¯çš„ä¸´æ—¶DHå‚æ•°ï¼Œå®¢æˆ·ç«¯ä¹Ÿå°†åŒè¯ä¹¦ä»¥åŠå®ƒçš„ä¸´æ—¶DHå‚æ•°å‘é€ç»™æœåŠ¡ç«¯ã€‚æ³¨æ„åˆ°åœ¨è®¡ç®—é¢„ä¸»å¯†é’¥æ—¶ï¼Œæœ‰4ä¸ªææ–™å‚ä¸äº†è¿ç®—ï¼Œå¯¹æ–¹åŠ å¯†è¯ä¹¦ä¸­çš„å…¬é’¥ä»¥åŠä¸´æ—¶å…¬é’¥ï¼Œè‡ªå·±çš„åŠ å¯†ç§é’¥ä»¥åŠä¸´æ—¶ç§é’¥ï¼Œç”±è¿™4ä¸ªææ–™ä¸€èµ·è®¡ç®—å‡ºé¢„ä¸»å¯†é’¥ã€‚ä½œä¸ºå¯¹æ¯”ï¼Œæ™®é€šTLSçš„ECDHEåªæœ‰è‡ªå·±çš„ä¸´æ—¶ç§é’¥å’Œå¯¹æ–¹çš„ä¸´æ—¶å…¬é’¥å‚ä¸è®¡ç®—ã€‚</p>
<p>GM ECDHEæœ€å¤§çš„åŒºåˆ«å°±åœ¨äºæ­¤ï¼Œæ‰€ä»¥GM ECDHEçš„ç®—æ³•å¥—ä»¶å¿…é¡»æ˜¯åŒå‘è®¤è¯çš„ï¼Œå› ä¸ºåœ¨å¯†é’¥äº¤æ¢æ—¶ä¹Ÿéœ€è¦å®¢æˆ·ç«¯çš„åŠ å¯†è¯ä¹¦å‚ä¸ã€‚ä»è¿™é‡Œä¹Ÿå¯ä»¥çœ‹å‡ºGMåè®®åœ¨è®¾è®¡ä¸Šçš„ä¸ä¸¥è°¨ï¼Œå“ªæœ‰ç®—æ³•å¥—ä»¶åªå…è®¸åŒå‘è®¤è¯çš„ã€‚è€Œä¸”GM ECDHEå› ä¸ºä¹Ÿæœ‰ä¸´æ—¶å¯†é’¥å‚ä¸è®¡ç®—é¢„ä¸»å¯†é’¥ï¼Œæ‰€ä»¥å°±ç®—CAæœ‰åŠ å¯†ç§é’¥ä¹Ÿæ˜¯æ— æ³•è§£å¯†çš„ï¼Œè¿™åˆä¸åŒè¯ä¹¦çš„æœ€åˆç›®çš„ç›¸æ‚–ã€‚ã€‚ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/catbro666/catbro666.github.io/posts/59c71edb/SSL%E5%8D%8F%E8%AE%AE%E6%B5%81%E7%A8%8B%E5%9B%BE%E6%96%B0-%E5%9B%BD%E5%AF%86ECDHE%E5%AF%86%E9%92%A5%E4%BA%A4%E6%8D%A2-5776669.png" alt="SSLåè®®æµç¨‹å›¾æ–°-å›½å¯†ECDHEå¯†é’¥äº¤æ¢" loading="lazy"></p>
<h3 id="TLS1-2-å¯†é’¥æ´¾ç”Ÿæµç¨‹"><a href="#TLS1-2-å¯†é’¥æ´¾ç”Ÿæµç¨‹" class="headerlink" title="TLS1.2 å¯†é’¥æ´¾ç”Ÿæµç¨‹"></a>TLS1.2 å¯†é’¥æ´¾ç”Ÿæµç¨‹</h3><p><img src="https://cdn.jsdelivr.net/gh/catbro666/catbro666.github.io/posts/59c71edb/TLS1.2_KeyCalculation.png" alt="TLS1.2_KeyCalculation" loading="lazy"></p>
<p>å¯†é’¥æ´¾ç”Ÿçš„æµç¨‹å‰é¢å…¶å®å·²ç»ç”»å‡ºæ¥äº†ï¼ŒåŸºäºåŠ å¯†æˆ–è€…DHåŒæ–¹äº¤æ¢å¾—åˆ°é¢„ä¸»å¯†é’¥ï¼Œé¢„ä¸»å¯†é’¥ç»“åˆä¸¤ä¸ªéšæœºæ•°æ´¾ç”Ÿå¾—åˆ°ä¸»å¯†é’¥ï¼ŒTLS1.2ä¸­æ´¾ç”Ÿæ˜¯é€šè¿‡PRFè¿›è¡Œçš„ï¼Œå…¶ä¸­secretå°±æ˜¯é¢„ä¸»å¯†é’¥ï¼Œlabelæ˜¯ä¸€ä¸ªç‰¹å®šçš„å­—ç¬¦ä¸²ï¼Œseedæ˜¯å‰é¢çš„ä¸¤ä¸ªéšæœºæ•°ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">master_secret = PRF(pre_master_secret, &quot;master secret&quot;,</span><br><span class="line">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â ClientHello.random + ServerHello.random)</span><br><span class="line">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â [0..47];</span><br></pre></td></tr></table></figure>

<p>å¾—åˆ°ä¸»å¯†é’¥ä¹‹ååœ¨ç»“åˆä¸¤ä¸ªéšæœºæ•°æ´¾ç”Ÿå‡ºä¼šè¯å¯†é’¥ï¼ŒåŒæ ·ä½¿ç”¨PRFï¼Œä¸è¿‡æ­¤æ—¶secretæ˜¯ä¸»å¯†é’¥ï¼Œlabelå­—ç¬¦ä¸²ä¸åŒï¼Œseedè¿˜æ˜¯ä¸¤ä¸ªéšæœºæ•°ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">key_block = PRF(SecurityParameters.master_secret,</span><br><span class="line">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â &quot;key expansion&quot;,</span><br><span class="line">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â SecurityParameters.server_random +</span><br><span class="line">Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â SecurityParameters.client_random);</span><br></pre></td></tr></table></figure>

<p>å¾—åˆ°ä¼šè¯å¯†é’¥ä¹‹åï¼Œå†æŒ‰ç…§éœ€è¦åˆ‡åˆ†æˆMAC keyå’Œå¯¹ç§°åŠ å¯†çš„keyã€‚å›¾ä¸­æŠŠIVç”»æˆäº†è™šçº¿ï¼Œå› ä¸ºTLS1.2ä¸­ä¸€èˆ¬ä¸éœ€è¦è¿™ä¸ªã€‚å› ä¸ºè‡ªä»TLS1.1æ”¹æˆæ˜¾å¼IVä¹‹åï¼ˆä¸ºäº†é˜²æ­¢CBCæ˜æ–‡é€‰æ‹©æ”»å‡»ï¼‰ï¼Œivéƒ½æ˜¯åœ¨è®°å½•ä¸­æ˜¾å¼å¸¦è¿‡å»çš„ï¼Œåªæœ‰å½“ä½¿ç”¨AEADç®—æ³•ï¼Œéœ€è¦éšå¼nonceæ—¶è¿˜éœ€éœ€è¦è¿™ä¸ªã€‚</p>
<p>è‡³äºå‰é¢æŠ›å‡ºçš„ä¸¤ä¸ªé—®é¢˜ï¼Œä¸ºä»€ä¹ˆä¸ç›´æ¥ç”¨é¢„ä¸»å¯†é’¥ï¼Ÿä¸€æ–¹é¢æ˜¯ä¸ºäº†ç»Ÿä¸€é•¿åº¦ï¼Œå› ä¸ºåŸºäºåŠ å¯†çš„å¯†é’¥äº¤æ¢é¢„ä¸»å¯†é’¥æ—¶48å­—èŠ‚ï¼Œè€ŒåŸºäºDHçš„å¯†é’¥äº¤æ¢é¢„ä¸»å¯†é’¥é•¿åº¦å–å†³äºå…·ä½“çš„ç®—æ³•ã€‚æ›´é‡è¦çš„ä¸€ç‚¹ï¼ŒåŒæ–¹çš„éšæœºæ•°åŠ å…¥è®¡ç®—ï¼Œå¯ä»¥é˜²é‡æ”¾æ”»å‡»ï¼Œè¿˜å¯ä»¥å¢åŠ éšæœºæ•°çš„ç†µæºï¼Œå¢åŠ å®‰å…¨æ€§ã€‚</p>
<p>é‚£ä¹ˆä¸ºä»€ä¹ˆä¸ç›´æ¥ç”¨ä¸»å¯†é’¥ï¼Œè¿˜è¦å†æ¬¡æ´¾ç”Ÿå‡ºä¼šè¯å¯†é’¥å‘¢ï¼Ÿè¿™ä¸ªä¸»è¦æ˜¯ç”Ÿå‘½å‘¨æœŸçš„è€ƒè™‘ï¼Œä¸¤è€…æœ‰ä¸åŒç”Ÿå‘½å‘¨æœŸï¼Œä¸»å¯†é’¥çš„ç”Ÿå‘½å‘¨æœŸè¾ƒé•¿ï¼Œä¼šè¯å¯†é’¥åˆ™è¾ƒçŸ­ï¼Œåªåœ¨å½“å‰ä¼šè¯æœ‰æ•ˆã€‚åé¢åœ¨è®²sessioné‡ç”¨æ—¶å°±å¯ä»¥çœ‹å‡ºå…¶åŒºåˆ«ã€‚</p>
<h2 id="å¦‚ä½•è¿›è¡Œèº«ä»½è®¤è¯"><a href="#å¦‚ä½•è¿›è¡Œèº«ä»½è®¤è¯" class="headerlink" title="å¦‚ä½•è¿›è¡Œèº«ä»½è®¤è¯"></a>å¦‚ä½•è¿›è¡Œèº«ä»½è®¤è¯</h2><p>å‰é¢è®¨è®ºäº†å¦‚ä½•è¿›è¡Œå¯†é’¥äº¤æ¢ï¼Œä½†æ˜¯å¯†é’¥äº¤æ¢åªç®¡åå•†å‡ºå¯†é’¥ï¼Œå¹¶ä¸è€ƒè™‘å¯¹æ–¹æ˜¯è°ï¼Ÿä½ å¦‚ä½•ç¡®è®¤å¯¹æ–¹çš„èº«ä»½ï¼Œé˜²æ­¢è¢«ä¸­é—´äººæ”»å‡»å‘¢ï¼Ÿæ‰€ä»¥å°±å¼•å…¥äº†èº«ä»½è®¤è¯ã€‚</p>
<p>èº«ä»½è®¤è¯éœ€è¦è§£å†³ä¸¤ä¸ªé—®é¢˜ï¼š</p>
<ul>
<li>ç¡®è®¤å¯¹æ–¹æ‹¥æœ‰å…¬é’¥å¯¹åº”çš„ç§é’¥</li>
<li>ç¡®è®¤å¯¹æ–¹çš„èº«ä»½</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/catbro666/catbro666.github.io/posts/59c71edb/SSL%E6%8F%A1%E6%89%8B%E9%80%BB%E8%BE%91%E5%9B%BE-%E8%BA%AB%E4%BB%BD%E8%AE%A4%E8%AF%81.png" alt="SSLæ¡æ‰‹é€»è¾‘å›¾-èº«ä»½è®¤è¯" loading="lazy"></p>
<p>ç¬¬ä¸€ä¸ªé—®é¢˜ï¼Œä½¿ç”¨å•çº¯çš„æ•°å­—ç­¾åå°±å¯ä»¥è§£å†³ã€‚é€šè¿‡éªŒè¯å¯¹æ–¹çš„æ•°å­—ç­¾åï¼Œå¯ä»¥ç¡®è®¤å¯¹æ–¹æ‹¥æœ‰ç›¸åº”çš„ç§é’¥ã€‚</p>
<p>è€Œç¬¬äºŒä¸ªé—®é¢˜ï¼Œåˆ™éœ€è¦å¼•å…¥æ•°å­—è¯ä¹¦å’ŒPKIäº†ã€‚æ•°å­—è¯ä¹¦ï¼Œè¯´ç™½äº†å°±æ˜¯å°†ä¸€ä¸ªå…¬é’¥è·Ÿèº«ä»½ä¿¡æ¯è¿›è¡Œç»‘å®šï¼Œç„¶åç”±ç¬¬ä¸‰æ–¹å¯ä¿¡æœºæ„ï¼ˆCAï¼‰ç»™ä½ åšä¸ªè¯æ˜ï¼ˆé€šè¿‡CAç­¾åï¼‰ã€‚é‚£ä¹ˆCAæœ¬èº«çš„èº«ä»½åˆç”±è°æ¥è¯æ˜å‘¢ï¼Œå†é€šè¿‡æ›´ä¸Šçº§çš„CAè¿›è¡Œè¯æ˜ã€‚æœ€ç»ˆçš„æ ¹CAåªèƒ½é€šè¿‡å…¶ä»–æ‰‹æ®µè¿›è¡Œè®¤è¯ï¼Œå¦åˆ™å°±æ— é™å¾ªç¯äº†ã€‚</p>
<h3 id="æ•°å­—ç­¾ååŸç†"><a href="#æ•°å­—ç­¾ååŸç†" class="headerlink" title="æ•°å­—ç­¾ååŸç†"></a>æ•°å­—ç­¾ååŸç†</h3><p><img src="https://cdn.jsdelivr.net/gh/catbro666/catbro666.github.io/posts/e92ef4b4/Private_key_signing.svg" alt="Private_key_signing" loading="lazy"></p>
<p>æ•°å­—ç­¾åçš„åŸºæœ¬åŸç†ä¹Ÿå¾ˆç®€å•ï¼Œä¸å‰é¢çš„å…¬é’¥åŠ å¯†ç›¸å¯¹ï¼Œè¿™é‡Œæ˜¯ä½¿ç”¨ç§é’¥å¯¹æ•°æ®è¿›è¡Œç­¾åï¼Œå¯¹æ–¹åˆ™ç”¨å…¬é’¥å¯¹ç­¾åæ•°æ®è¿›è¡ŒéªŒç­¾ã€‚</p>
<h3 id="TLS-RSAå¯†é’¥äº¤æ¢æ—¶çš„RSAè®¤è¯"><a href="#TLS-RSAå¯†é’¥äº¤æ¢æ—¶çš„RSAè®¤è¯" class="headerlink" title="TLS RSAå¯†é’¥äº¤æ¢æ—¶çš„RSAè®¤è¯"></a>TLS RSAå¯†é’¥äº¤æ¢æ—¶çš„RSAè®¤è¯</h3><p>å…¸å‹ç®—æ³•å¥—ä»¶ä»ç„¶æ˜¯AES256-SHAã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/catbro666/catbro666.github.io/posts/59c71edb/SSL%E5%8D%8F%E8%AE%AE%E6%B5%81%E7%A8%8B%E5%9B%BE%E6%96%B0-RSA%E5%AF%86%E9%92%A5%E4%BA%A4%E6%8D%A2RSA%E8%AE%A4%E8%AF%81.png" alt="SSLåè®®æµç¨‹å›¾æ–°-RSAå¯†é’¥äº¤æ¢RSAè®¤è¯" loading="lazy"></p>
<p>æœåŠ¡ç«¯çš„è®¤è¯åªæ¶‰åŠCertificateæ¶ˆæ¯ï¼ŒæœåŠ¡ç«¯æŠŠè¯ä¹¦å’ŒCAè¯ä¹¦é“¾å‘é€ç»™å®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯åªéœ€è¦å¯¹è¯ä¹¦å’Œè¯ä¹¦é“¾è¿›è¡ŒéªŒè¯ã€‚æœ€ç»ˆçš„Root CAéœ€è¦æ˜¯æœ¬æœºä¿¡ä»»çš„ï¼Œå¦åˆ™å°±å­˜åœ¨å®‰å…¨é£é™©ï¼Œå¯èƒ½å—åˆ°ä¸­é—´äººæ”»å‡»ã€‚</p>
<p>å¦‚æœéœ€è¦åŒå‘è®¤è¯ï¼Œå³æœåŠ¡ç«¯ä¹Ÿéœ€è¦è®¤è¯å®¢æˆ·ç«¯ï¼Œè¿˜æ¶‰åŠå›¾ä¸­æ©™è‰²çš„3ä¸ªæ¶ˆæ¯ã€‚æœåŠ¡ç«¯ä¼šå‘é€CertificateRequestæ¶ˆæ¯ï¼Œå‘Šè¯‰å®¢æˆ·ç«¯æ”¯æŒçš„è¯ä¹¦ç±»å‹ã€ç­¾åå“ˆå¸Œç®—æ³•ã€ä»¥åŠCAçš„DNé¡¹ã€‚å®¢æˆ·ç«¯æ ¹æ®è¿™äº›ä¿¡æ¯é€‰æ‹©é€‚åˆçš„å®¢æˆ·ç«¯è¯ä¹¦ï¼Œç„¶ååœ¨Certificateæ¶ˆæ¯ä¸­å°†è¯ä¹¦å’ŒCAè¯ä¹¦é“¾å‘é€ç»™æœåŠ¡ç«¯ï¼Œå¦å¤–è¿˜éœ€è¦ç”¨è‡ªå·±çš„ç§é’¥åšä¸€ä¸ªç­¾åï¼Œä»¥è¯æ˜è‡ªå·±æ‹¥æœ‰è¯ä¹¦å¯¹åº”çš„ç§é’¥ã€‚è¿™é‡Œç­¾åçš„å†…å®¹æ˜¯å‰é¢æ‰€æœ‰çš„æ¡æ‰‹æ¶ˆæ¯ï¼ˆä»ClientHelloå¼€å§‹åˆ°å½“å‰æ¶ˆæ¯ä¹‹å‰çš„æ‰€æœ‰æ¶ˆæ¯ï¼‰ã€‚ç„¶åæœåŠ¡ç«¯å¯¹å®¢æˆ·ç«¯çš„è¯ä¹¦é“¾ä»¥åŠç­¾åè¿›è¡ŒéªŒè¯ã€‚</p>
<h3 id="TLS-ECDHEå¯†é’¥äº¤æ¢æ—¶çš„è®¤è¯"><a href="#TLS-ECDHEå¯†é’¥äº¤æ¢æ—¶çš„è®¤è¯" class="headerlink" title="TLS ECDHEå¯†é’¥äº¤æ¢æ—¶çš„è®¤è¯"></a>TLS ECDHEå¯†é’¥äº¤æ¢æ—¶çš„è®¤è¯</h3><p>å…¸å‹ç®—æ³•å¥—ä»¶å¦‚ECDHE-RSA-AES256-GCM-SHA384ã€ECDHE-ECDSA-AES256-GCM-SHA384ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/catbro666/catbro666.github.io/posts/59c71edb/SSL%E5%8D%8F%E8%AE%AE%E6%B5%81%E7%A8%8B%E5%9B%BE%E6%96%B0-ECDHE%E5%AF%86%E9%92%A5%E4%BA%A4%E6%8D%A2%E7%9A%84%E8%AE%A4%E8%AF%81.png" alt="SSLåè®®æµç¨‹å›¾æ–°-ECDHEå¯†é’¥äº¤æ¢çš„è®¤è¯" loading="lazy"></p>
<p>è·Ÿå‰ä¸€ç§æƒ…å†µä¸‹æ¯”ï¼ŒæœåŠ¡ç«¯å¤šäº†ä¸€ä¸ªç­¾åã€‚å› ä¸ºè¿™ç§æƒ…å†µå¯†é’¥äº¤æ¢æ˜¯é€šè¿‡ä¸´æ—¶DHå‚æ•°å®Œæˆçš„ï¼Œå¹¶æ²¡æœ‰æœåŠ¡ç«¯è¯ä¹¦å¯¹åº”çš„ç§é’¥å‚ä¸ï¼Œæ‰€ä»¥éœ€è¦ç”¨è¯ä¹¦å¯¹åº”çš„ç§é’¥é¢å¤–åšä¸€ä¸ªç­¾åï¼Œä»¥è¯æ˜è‡ªå·±ç¡®å®æ‹¥æœ‰è¯ä¹¦å¯¹åº”ç§é’¥ã€‚è¿™é‡Œç­¾åçš„å†…å®¹æ˜¯ä¸¤ä¸ªhelloéšæœºæ•°ä»¥åŠæœåŠ¡ç«¯çš„ä¸´æ—¶DHå‚æ•°ï¼Œå…¶å®å°±æ˜¯å‚ä¸è®¡ç®—é¢„ä¸»å¯†é’¥çš„ä¸‰ä¸ªææ–™ã€‚</p>
<p>å®¢æˆ·ç«¯é™¤äº†éªŒè¯è¯ä¹¦é“¾ä¹‹å¤–ï¼Œè¿˜éœ€è¦å¯¹è¿™ä¸ªç­¾åè¿›è¡ŒéªŒè¯ã€‚</p>
<p>å®¢æˆ·ç«¯è®¤è¯çš„éƒ¨åˆ†è·Ÿå‰ä¸€ç§æƒ…å†µå®Œå…¨ä¸€æ ·ï¼Œä¸å†è¿›è¡Œèµ˜è¿°ã€‚</p>
<h3 id="GM-ECCå¯†é’¥äº¤æ¢æ—¶çš„è®¤è¯"><a href="#GM-ECCå¯†é’¥äº¤æ¢æ—¶çš„è®¤è¯" class="headerlink" title="GM ECCå¯†é’¥äº¤æ¢æ—¶çš„è®¤è¯"></a>GM ECCå¯†é’¥äº¤æ¢æ—¶çš„è®¤è¯</h3><p>å…¸å‹ç®—æ³•å¥—ä»¶è¿˜æ˜¯ECC-SM4-SM3ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/catbro666/catbro666.github.io/posts/59c71edb/SSL%E5%8D%8F%E8%AE%AE%E6%B5%81%E7%A8%8B%E5%9B%BE%E6%96%B0-%E5%9B%BD%E5%AF%86ECC%E8%AE%A4%E8%AF%81.png" alt="SSLåè®®æµç¨‹å›¾æ–°-å›½å¯†ECCè®¤è¯" loading="lazy"></p>
<p>å‰é¢TLS RSAçš„æƒ…å†µï¼ŒæœåŠ¡ç«¯ä¸éœ€è¦åšä¸€ä¸ªé¢å¤–çš„ç­¾åã€‚å› ä¸ºå¯†é’¥äº¤æ¢å’Œèº«ä»½è®¤è¯éƒ½æ˜¯é€šè¿‡åŒä¸€ä¸ªè¯ä¹¦æ¥è¿›è¡Œçš„ï¼ŒæœåŠ¡ç«¯èƒ½å¤Ÿå®Œæˆå¯†é’¥äº¤æ¢ï¼ˆè§£å¯†å‡ºé¢„ä¸»å¯†é’¥ï¼‰å°±å·²ç»è¯´æ˜äº†å®ƒæœ‰å¯¹åº”çš„ç§é’¥ã€‚</p>
<p>è€ŒGM ECCåˆ™åˆ™ä¸ç„¶ï¼Œå› ä¸ºåŒè¯ä¹¦çš„å…³ç³»ï¼Œå¯†é’¥äº¤æ¢å’Œèº«ä»½è®¤è¯æ˜¯é€šè¿‡ä¸åŒè¯ä¹¦è¿›è¡Œçš„ã€‚æ‰€ä»¥æœåŠ¡ç«¯ä»ç„¶éœ€è¦åšä¸€ä¸ªç­¾åè¯æ˜å…¶ç§é’¥æŒæœ‰æ€§ã€‚ç­¾åæ˜¯é€šè¿‡ç­¾åç§é’¥æ¥è¿›è¡Œçš„ï¼Œç­¾åçš„å†…å®¹æœ‰æ‰€æ”¹å˜ï¼Œæ˜¯ä¸¤ä¸ªhelloéšæœºæ•°å’ŒæœåŠ¡ç«¯çš„åŠ å¯†è¯ä¹¦ã€‚å®¢æˆ·ç«¯é™¤äº†éªŒè¯è¯ä¹¦é“¾ï¼Œè¿˜éœ€è¦ç”¨æœåŠ¡ç«¯çš„ç­¾åè¯ä¹¦å¯¹ç­¾åè¿›è¡ŒéªŒè¯ã€‚</p>
<p>å®¢æˆ·ç«¯è®¤è¯çš„æµç¨‹è¿˜æ˜¯ç±»ä¼¼ï¼Œåªä¸è¿‡å‘é€çš„ä¹Ÿæ˜¯åŒè¯ä¹¦ï¼Œç„¶ååœ¨ç­¾åæ—¶ä¹Ÿæ˜¯ç”¨çš„ç­¾åç§é’¥ã€‚æœåŠ¡ç«¯é™¤äº†éªŒè¯è¯ä¹¦é“¾ï¼Œè¿˜éœ€è¦ç”¨å®¢æˆ·ç«¯çš„ç­¾åè¯ä¹¦å¯¹ç­¾åè¿›è¡ŒéªŒè¯ã€‚</p>
<h3 id="GM-ECDHEå¯†é’¥äº¤æ¢æ—¶çš„è®¤è¯"><a href="#GM-ECDHEå¯†é’¥äº¤æ¢æ—¶çš„è®¤è¯" class="headerlink" title="GM ECDHEå¯†é’¥äº¤æ¢æ—¶çš„è®¤è¯"></a>GM ECDHEå¯†é’¥äº¤æ¢æ—¶çš„è®¤è¯</h3><p>å…¸å‹ç®—æ³•å¥—ä»¶è¿˜æ˜¯ECDHE-SM4-SM3ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/catbro666/catbro666.github.io/posts/59c71edb/SSL%E5%8D%8F%E8%AE%AE%E6%B5%81%E7%A8%8B%E5%9B%BE%E6%96%B0-%E5%9B%BD%E5%AF%86ECDHE%E8%AE%A4%E8%AF%81.png" alt="SSLåè®®æµç¨‹å›¾æ–°-å›½å¯†ECDHEè®¤è¯" loading="lazy"></p>
<p>è·Ÿå‰ä¸€ç§æƒ…å†µç›¸æ¯”ï¼Œä¸»è¦æ˜¯æœåŠ¡ç«¯çš„ç­¾åå†…å®¹æœ‰ä¸€ç‚¹åŒºåˆ«ï¼Œæ˜¯ä¸¤ä¸ªhelloéšæœºæ•°+æœåŠ¡ç«¯çš„ä¸´æ—¶DHå‚æ•°ã€‚æˆ‘ä»¬æ³¨æ„åˆ°å‰é¢å‡ ç§æƒ…å†µï¼ŒæœåŠ¡ç«¯ç­¾åçš„å†…å®¹éƒ½æ˜¯å‚ä¸è®¡ç®—é¢„ä¸»å¯†é’¥çš„ææ–™ã€‚ä»è¿™ä¸ªé€»è¾‘ä¸Šæ¥è¯´ï¼Œè¿™è¾¹åœ¨åè®®è®¾è®¡ä¸Šä¹Ÿæœ‰äº›é—®é¢˜ï¼Œå› ä¸ºæœåŠ¡ç«¯çš„åŠ å¯†è¯ä¹¦å®é™…ä¸Šä¹Ÿå‚ä¸äº†å¯†é’¥äº¤æ¢ï¼ŒæŒ‰ç…§åè®®è®¾è®¡ä¸€è‡´æ€§ä¹Ÿåº”è¯¥åŒ…å«åˆ°ç­¾åå†…å®¹ä¸­ã€‚</p>
<p>å…¶ä»–éƒ¨åˆ†è·Ÿå‰ä¸€ç§æƒ…å†µå®Œå…¨ä¸€æ ·ï¼Œä¸å†è¿›è¡Œèµ˜è¿°ã€‚</p>
<h2 id="å¦‚ä½•åå•†åè®®ç®—æ³•"><a href="#å¦‚ä½•åå•†åè®®ç®—æ³•" class="headerlink" title="å¦‚ä½•åå•†åè®®ç®—æ³•"></a>å¦‚ä½•åå•†åè®®ç®—æ³•</h2><p>å‰é¢è®¨è®ºäº†å‡ ç§ä¸åŒçš„æƒ…å†µï¼Œå¯ä»¥çœ‹åˆ°ä¸åŒçš„åè®®ç‰ˆæœ¬ã€ä¸åŒçš„ç®—æ³•å¥—ä»¶ï¼Œå®ƒä»¬åœ¨æ¡æ‰‹çš„å¤„ç†æµç¨‹ä¸Šæ˜¯ä¸ä¸€æ ·çš„ï¼Œé‚£ä¹ˆåŒæ–¹å¦‚ä½•å¯¹æ­¤è¾¾æˆä¸€è‡´å‘¢ï¼Ÿ</p>
<p>äºæ˜¯å°±éœ€è¦å¼•å…¥ä¸€æ¬¡Helloäº¤äº’äº†ã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆå®Œæ•´çš„SSLæ¡æ‰‹éœ€è¦ä¸¤æ¬¡äº¤äº’çš„ä¸»è¦åŸå› ã€‚é€šè¿‡è¿™æ¬¡Helloäº¤äº’å¯¹ä½¿ç”¨çš„åè®®ç‰ˆæœ¬å’Œç®—æ³•å¥—ä»¶è¾¾æˆä¸€è‡´ã€‚å¦å¤–å¾—ç›ŠäºSSLåè®®å¼•å…¥çš„æ‰©å±•æœºåˆ¶ï¼Œä¸ä»…ä»…æ˜¯åè®®ç‰ˆæœ¬ç®—æ³•å¥—ä»¶ï¼ŒåŒæ–¹è¿˜å¯ä»¥åå•†é™¤æ­¤ä¹‹å¤–çš„å¾ˆå¤šä¸œè¥¿ï¼Œç”šè‡³æ˜¯ç”¨æˆ·è‡ªå®šä¹‰çš„æ‰©å±•é¡¹ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/catbro666/catbro666.github.io/posts/59c71edb/SSL%E5%8D%8F%E8%AE%AE%E6%B5%81%E7%A8%8B%E5%9B%BE%E6%96%B0-%E5%8D%8F%E5%95%86%E5%8D%8F%E8%AE%AE%E7%AE%97%E6%B3%95.png" alt="SSLåè®®æµç¨‹å›¾æ–°-åå•†åè®®ç®—æ³•" loading="lazy"></p>
<p>ä¸è¿‡æœ€åŸºæœ¬çš„è¿˜æ˜¯åè®®ç‰ˆæœ¬ã€ç®—æ³•å¥—ä»¶ä¹‹ç±»çš„ã€‚å®¢æˆ·ç«¯å‘é€å®ƒæ”¯æŒçš„ç‰ˆæœ¬ã€ç®—æ³•å¥—ä»¶åˆ—è¡¨ã€å¦‚æœæ˜¯æ¤­åœ†æ›²çº¿è¿˜ä¼šæŒ‡å®šæ”¯æŒçš„æ›²çº¿åˆ—è¡¨ã€ç­¾åç®—æ³•ç­‰ï¼ŒæœåŠ¡ç«¯åŸºäºå®¢æˆ·ç«¯çš„ä¿¡æ¯ï¼Œé€‰æ‹©æœ€ç»ˆä½¿ç”¨çš„åè®®ç‰ˆæœ¬ã€ç®—æ³•å¥—ä»¶ã€ECç‚¹æ ¼å¼ç­‰ã€‚</p>
<h2 id="å¦‚ä½•æå‡æ€§èƒ½"><a href="#å¦‚ä½•æå‡æ€§èƒ½" class="headerlink" title="å¦‚ä½•æå‡æ€§èƒ½"></a>å¦‚ä½•æå‡æ€§èƒ½</h2><p>å®Œæ•´çš„SSLæ¡æ‰‹éœ€è¦ä¸¤ä¸ªRTTï¼Œè€Œä¸”è¿˜éœ€è¦è€—æ—¶çš„éå¯¹ç§°è¿ç®—ã€‚åè®®åœ¨è®¾è®¡ä¸Šä¹Ÿè€ƒè™‘äº†å¦‚ä½•æå‡æ€§èƒ½çš„é—®é¢˜ã€‚åœ¨æ¡æ‰‹æµç¨‹ä¼˜åŒ–æ–¹é¢ï¼Œä¸»è¦å°±æ˜¯é€šè¿‡ä¼šè¯é‡ç”¨æ¥ç®€åŒ–æ¡æ‰‹æµç¨‹ã€‚ï¼ˆå¯¹äºTLSv1.3åˆ™æœ‰PSKã€1-RTTå’Œ0-RTTï¼Œä¸è¿‡æœ¬æ–‡å°†ä¸æ¶‰åŠTLS1.3ï¼Œï¼‰è¿™é‡Œä¸»è¦ä»‹ç»ä¸‹ä¼šè¯é‡ç”¨çš„æƒ…å†µã€‚</p>
<h3 id="ä¼šè¯é‡ç”¨åŸºæœ¬æµç¨‹"><a href="#ä¼šè¯é‡ç”¨åŸºæœ¬æµç¨‹" class="headerlink" title="ä¼šè¯é‡ç”¨åŸºæœ¬æµç¨‹"></a>ä¼šè¯é‡ç”¨åŸºæœ¬æµç¨‹</h3><p><img src="https://cdn.jsdelivr.net/gh/catbro666/catbro666.github.io/posts/59c71edb/SSL%E5%8D%8F%E8%AE%AE%E6%B5%81%E7%A8%8B%E5%9B%BE%E6%96%B0-%E4%BC%9A%E8%AF%9D%E9%87%8D%E7%94%A8%E5%9F%BA%E6%9C%AC.png" alt="SSLåè®®æµç¨‹å›¾æ–°-ä¼šè¯é‡ç”¨åŸºæœ¬" loading="lazy"></p>
<p>ä¼šè¯é‡ç”¨çš„åŸºæœ¬æµç¨‹å¦‚ä¸Šæ‰€ç¤ºã€‚é¦–å…ˆæ˜¯ä¸€ä¸ªå®Œæ•´çš„æ¡æ‰‹ï¼Œç„¶åå®¢æˆ·ç«¯å¦‚æœæƒ³é‡ç”¨å‰é¢çš„ä¼šè¯ï¼Œåœ¨ClientHelloè¿›è¡Œç›¸åº”çš„æŒ‡ç¤ºå‘Šè¯‰æœåŠ¡ç«¯ï¼ŒæœåŠ¡ç«¯å¦‚æœåŒæ„åœ¨ServerHelloä¸­è¿›è¡Œç­”å¤ï¼Œç„¶åå°±ç›´æ¥è¿›è¡Œç®€åŒ–çš„æ¡æ‰‹ï¼Œä¸éœ€è¦å†è¿›è¡Œå¯†é’¥äº¤æ¢å’Œèº«ä»½è®¤è¯ã€‚ä¸ä½†çœäº†ä¸€æ¬¡äº¤äº’ï¼Œä¹Ÿçœå»äº†è´¹æ—¶çš„éå¯¹ç§°è¿ç®—ã€‚</p>
<h3 id="Session-ID"><a href="#Session-ID" class="headerlink" title="Session ID"></a>Session ID</h3><p>ä¼šè¯é‡ç”¨æœ‰ä¸¤ç§æ–¹å¼ï¼Œé¦–å…ˆæ¥çœ‹ä¸‹Session IDçš„æµç¨‹ï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/catbro666/catbro666.github.io/posts/59c71edb/SSL%E5%8D%8F%E8%AE%AE%E6%B5%81%E7%A8%8B%E5%9B%BE%E6%96%B0-%E4%BC%9A%E8%AF%9D%E9%87%8D%E7%94%A8SessionID.png" alt="SSLåè®®æµç¨‹å›¾æ–°-ä¼šè¯é‡ç”¨SessionID" loading="lazy"></p>
<p>å‰ä¸€æ¬¡æ¡æ‰‹ä¸­ï¼ŒæœåŠ¡ç«¯åœ¨ServerHelloæ¶ˆæ¯ä¸­å°†Session IDå‘Šè¯‰å®¢æˆ·ç«¯ï¼Œæ¡æ‰‹æ­£å¸¸å®Œæˆä¹‹åï¼ŒæœåŠ¡ç«¯ä¼šå°†å¯¹åº”çš„Sessionä¿å­˜ï¼Œå…¶ä¸­å°±åŒ…å«äº†ä¸»å¯†é’¥ã€‚</p>
<p>åç»­å®¢æˆ·ç«¯æƒ³è¦é‡ç”¨ä¹‹å‰é‚£ä¸ªSessionï¼Œå¯ä»¥åœ¨ClientHelloä¸­å¸¦ä¸Šä¹‹å‰çš„Session IDï¼ŒæœåŠ¡ç«¯æ”¶åˆ°ä¹‹åä¼šæ ¹æ®Session IDè¿›è¡ŒæŸ¥æ‰¾ï¼Œå¦‚æœæ‰¾åˆ°äº†ä¸”æœªè¿‡æœŸï¼Œé‚£ä¹ˆè¿›è¡Œä¼šè¯é‡ç”¨ï¼ŒæœåŠ¡ç«¯å°†Session IDå†åŸæ ·å‘é€ç»™å®¢æˆ·ç«¯ï¼Œè¿›å…¥ç®€åŒ–çš„æ¡æ‰‹æµç¨‹ï¼›å¦åˆ™ï¼ŒæœåŠ¡ç«¯è¿˜æ˜¯éšæœºç”Ÿæˆæ–°çš„Session IDå‘é€ç»™å®¢æˆ·ç«¯ï¼Œå›é€€åˆ°å®Œæ•´çš„æ¡æ‰‹æµç¨‹ã€‚</p>
<p>ä¼šè¯é‡ç”¨æ—¶ï¼Œä½¿ç”¨ä¹‹å‰Sessionçš„ä¸»å¯†é’¥æ¥æ¨å¯¼ä¼šè¯å¯†é’¥ã€‚è¿™é‡Œå°±å¯ä»¥çœ‹å‡ºå…¶ç”Ÿå‘½å‘¨æœŸçš„ä¸åŒäº†ï¼Œä¼šè¯é‡ç”¨æ—¶ä¸»å¯†é’¥æ˜¯ç”¨çš„åŒä¸€ä¸ªï¼Œä½†æ˜¯ä¼šè¯å¯†é’¥æ¯æ¬¡éƒ½æ˜¯é‡æ–°ç”Ÿæˆçš„ã€‚è€Œä¸”æ³¨æ„åˆ°ï¼Œè¿™æ—¶ä¹Ÿæ˜¯æœ‰ä¸¤ä¸ªéšæœºæ•°å‚ä¸å¯†é’¥æ´¾ç”Ÿçš„ï¼ŒåŒæ ·ä¹Ÿæ˜¯å‡ºäºé˜²é‡æ”¾çš„è€ƒè™‘ã€‚</p>
<h3 id="Session-Ticket"><a href="#Session-Ticket" class="headerlink" title="Session Ticket"></a>Session Ticket</h3><p>å‰ä¸€ç§æƒ…å†µæœåŠ¡ç«¯éœ€è¦ä¿å­˜ session cacheï¼Œä¼šæ¶ˆè€—å†…å­˜èµ„æºï¼Œå¦‚æœæ˜¯é›†ç¾¤çš„è¯è¿˜ä¼šå¸¦æ¥cacheåŒæ­¥çš„é—®é¢˜ã€‚è€Œsession ticketçš„å‡ºç°æ­£æ˜¯ä¸ºäº†è§£å†³è¿™äº›é—®é¢˜ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/catbro666/catbro666.github.io/posts/59c71edb/SSL%E5%8D%8F%E8%AE%AE%E6%B5%81%E7%A8%8B%E5%9B%BE%E6%96%B0-%E4%BC%9A%E8%AF%9D%E9%87%8D%E7%94%A8SessionTicket.png" alt="SSLåè®®æµç¨‹å›¾æ–°-ä¼šè¯é‡ç”¨SessionTicket" loading="lazy"></p>
<p>æˆ‘ä»¬æ¥çœ‹ä¸‹å®ƒçš„æµç¨‹ï¼Œé¦–å…ˆå®¢æˆ·ç«¯åœ¨ClientHelloçš„æ‰©å±•ä¸­å¸¦ä¸Šsession_ticketæ‰©å±•è¡¨ç¤ºå®ƒæƒ³ä½¿ç”¨session_ticketåŠŸèƒ½ï¼ŒæœåŠ¡ç«¯å¦‚æœåŒæ„åˆ™åœ¨ServerHelloä¸­å›å¤session_ticketæ‰©å±•é¡¹ã€‚æœåŠ¡ç«¯ä¸ç”¨ä¿å­˜sessionï¼Œè€Œæ˜¯åŠ å¯†ä¹‹åé€šè¿‡NewSessionTicketæ¶ˆæ¯å‘é€ç»™å®¢æˆ·ç«¯ã€‚è¿™é‡Œsession ticket keyå®é™…ä¸Šæ˜¯ä¸ªå¯¹ç§°å¯†é’¥ï¼Œå®ƒåªæœ‰æœåŠ¡ç«¯è‡ªå·±çŸ¥é“ã€‚</p>
<p>åç»­å®¢æˆ·ç«¯æƒ³è¦é‡ç”¨è¯¥Sessionï¼Œåœ¨ClientHelloæ‰©å±•ä¸­æŠŠä¹‹å‰é‚£ä¸ªsession_ticketå¡è¿›å»ï¼ŒæœåŠ¡ç«¯æˆåŠŸè§£å¯†ä¸”éªŒè¯é€šè¿‡ä¹‹åå°±è¿›è¡Œä¼šè¯é‡ç”¨ï¼Œå¦åˆ™å›é€€åˆ°å®Œæ•´çš„æ¡æ‰‹ã€‚ç„¶åè¿˜æ˜¯åŒæ ·åœ°æ ¹æ®ä¸»å¯†é’¥é‡æ–°æ´¾ç”Ÿå‡ºä¼šè¯å¯†é’¥ã€‚</p>
<p>è¿™æ ·æœåŠ¡ç«¯æ²¡æœ‰äº†ä¿å­˜sessionçš„è´Ÿæ‹…ï¼Œä½†æ˜¯å¤©ä¸‹æ²¡æœ‰å…è´¹çš„åˆé¤ï¼Œsession ticketå¯¹å‰å‘å®‰å…¨æ€§ä¼šå¸¦æ¥ä¸€å®šçš„æŸå®³ã€‚å› ä¸ºsession ticketåªæ˜¯å•çº¯ä½¿ç”¨session ticket keyè¿›è¡ŒåŠ å¯†çš„ï¼Œå¦‚æœsession ticket keyæ³„æ¼äº†ï¼Œé‚£ä¹ˆä¹‹å‰åŸºäºä¼šè¯é‡ç”¨çš„æ¡æ‰‹å°±éƒ½å¯ä»¥è¢«ç ´è§£äº†ã€‚</p>
<p>æ‰€ä»¥åœ¨å®é™…ä½¿ç”¨æ—¶ï¼Œsession ticket keyåº”è¯¥ç»å¸¸æ›´æ¢ï¼Œå‡å°å‰å‘å®‰å…¨æ€§æ–¹é¢çš„é£é™©ã€‚</p>
<h2 id="å¦‚ä½•ä¿è¯å®‰å…¨æ€§"><a href="#å¦‚ä½•ä¿è¯å®‰å…¨æ€§" class="headerlink" title="å¦‚ä½•ä¿è¯å®‰å…¨æ€§"></a>å¦‚ä½•ä¿è¯å®‰å…¨æ€§</h2><p>ç®€å•å›é¡¾æ¥æ¡æ‰‹ä¸­æ˜¯å¦‚ä½•ä¿è¯å®‰å…¨æ€§çš„ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/catbro666/catbro666.github.io/posts/59c71edb/SSL%E6%8F%A1%E6%89%8B%E9%80%BB%E8%BE%91%E5%9B%BE-%E4%BF%9D%E8%AF%81%E5%AE%89%E5%85%A8%E6%80%A7.png" alt="SSLæ¡æ‰‹é€»è¾‘å›¾-ä¿è¯å®‰å…¨æ€§" loading="lazy"></p>
<p>é¦–å…ˆé€šè¿‡ä¸¤ä¸ªhelloéšæœºæ•°æ¥å®ç°é˜²é‡æ”¾ã€‚é˜²æ­¢ä¸­é—´äººæ”»å‡»æ˜¯é€šè¿‡å¯¹æœåŠ¡ç«¯çš„è®¤è¯äº†å®Œæˆçš„ã€‚é˜²ç¯¡æ”¹æ˜¯é€šè¿‡æœ€åçš„Finishedæ¥å®Œæˆçš„ï¼ŒFinishedæ¶ˆæ¯ä¸­åŒ…å«äº†ä¸€ä¸ªverify_dataï¼Œå®ƒä¹Ÿæ˜¯ç”±PRFè®¡ç®—å¾—åˆ°çš„ï¼Œå…¶ä¸­çš„seedæ˜¯å‰é¢æ‰€æœ‰æ¡æ‰‹æ¶ˆæ¯ï¼ˆClientHelloå¼€å§‹ï¼Œåˆ°å½“å‰Finishedæ¶ˆæ¯å‰ï¼‰çš„æ‘˜è¦å€¼ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">verify_data: </span><br><span class="line">PRF(master_secret, finished_label, </span><br><span class="line">    Hash(handshake_messages))</span><br><span class="line">            [0..verify_data_length-1];</span><br></pre></td></tr></table></figure>

<p>å‰å‘å®‰å…¨æ€§ä¹Ÿæ˜¯éœ€è¦ç‰¹åˆ«æ³¨æ„çš„ç‚¹ï¼Œäº‹å®ä¸ŠTLS1.3ä¸­ç æ‰äº†æ‰€æœ‰æ²¡æœ‰å‰å‘å®‰å…¨æ€§çš„ç®—æ³•å¥—ä»¶ï¼Œåªç•™ä¸‹äº†DHEæˆ–ECDHEçš„ç®—æ³•å¥—ä»¶ã€‚å¦å¤–å‰é¢ä¹Ÿæåˆ°äº†session ticketä¹Ÿä¼šå¯¹å‰å‘å®‰å…¨æ€§æœ‰ä¸€å®šçš„æŸå®³ã€‚</p>
<p>æœ€åï¼Œè¦ç‰¹åˆ«å¼ºè°ƒä¸‹éšæœºæ•°çš„é‡è¦æ€§ã€‚ä¸€ä¸ªå¥½çš„åŠ å¯†ç®—æ³•ï¼Œå…¶å®‰å…¨æ€§å®Œå…¨æ˜¯åŸºäºå¯†é’¥çš„å®‰å…¨æ€§ï¼Œå¦‚æœéšæœºæ•°æœ¬èº«è´¨é‡ä¸è¿‡å…³ï¼Œæ¯”å¦‚å¯ä»¥è¢«é¢„æµ‹ï¼Œé‚£ä¹ˆå‰é¢æ‰€æœ‰çš„ä¸€åˆ‡éƒ½æ˜¯ç™½å¿™æ´»ã€‚éšæœºæ•°å¯ä»¥è¯´æ˜¯æ‰€æœ‰è¿™äº›çš„åŸºçŸ³ã€‚</p>
<p>æœ€åçš„æœ€åï¼Œå®‰å…¨é¢†åŸŸå…¶å®ä¹Ÿé€‚ç”¨æœ¨æ¡¶ç†è®ºï¼Œä¸€ä¸ªé€šä¿¡çš„å®‰å…¨æ€§å–å†³äºå…¶æœ€è–„å¼±çš„ç¯èŠ‚ã€‚æ— è®ºæ˜¯åè®®è®¾è®¡ã€ä»£ç å®ç°è¿˜æ˜¯åœ¨ç”¨æˆ·ä½¿ç”¨ä¸Šï¼Œä»»ä½•ä¸€å¤„çº°æ¼éƒ½å¯èƒ½å¯¼è‡´å·¨å¤§çš„å®‰å…¨é—®é¢˜ã€‚</p>
]]></content>
      <categories>
        <category>åŠ å¯†ä¸å®‰å…¨</category>
      </categories>
      <tags>
        <tag>SSL/TLS</tag>
      </tags>
  </entry>
  <entry>
    <title>UNIXç¯å¢ƒé«˜çº§ç¼–ç¨‹APUEç»ƒä¹ 4.6-å®ç°ç±»ä¼¼cp(1)çš„ç¨‹åºï¼Œä¿ç•™æ–‡ä»¶ä¸­çš„ç©ºæ´</title>
    <url>/posts/aa99fc97/</url>
    <content><![CDATA[<h2 id="1-é¢˜é¢"><a href="#1-é¢˜é¢" class="headerlink" title="1 é¢˜é¢"></a>1 é¢˜é¢</h2><p>ç¼–å†™ç±»ä¼¼<code>cp(1)</code>çš„ç¨‹åºï¼Œå®ƒå¤åˆ¶åŒ…å«ç©ºæ´çš„æ–‡ä»¶ï¼Œä½†æ˜¯ä¸å°†å­—èŠ‚0å†™åˆ°è¾“å‡ºæ–‡ä»¶ä¸­å»ã€‚</p>
<h2 id="2-åŸºæœ¬æ€è·¯"><a href="#2-åŸºæœ¬æ€è·¯" class="headerlink" title="2 åŸºæœ¬æ€è·¯"></a>2 åŸºæœ¬æ€è·¯</h2><ul>
<li>é¦–å…ˆè¦ææ¸…æ¥šç©ºæ´çš„æ€§è´¨ä»¥åˆ¤æ–­ä¸€ä¸ªæ–‡ä»¶æ˜¯å¦æœ‰ç©ºæ´ï¼Œä»¥åŠç©ºæ´çš„ä½ç½®</li>
<li>çŸ¥é“äº†ç©ºæ´çš„ä½ç½®ä¹‹åï¼Œè¯»åˆ°æºæ–‡ä»¶ä¸­çš„ç©ºæ´éƒ¨åˆ†æ—¶ï¼Œåœ¨ç›®æ ‡æ–‡ä»¶ä¸­<code>lseek</code>ç›¸åº”çš„é•¿åº¦</li>
</ul>
<span id="more"></span>

<h2 id="3-åˆ›å»ºç©ºæ´æ–‡ä»¶ï¼ŒåŒæ—¶æ¢ç´¢ç©ºæ´æ€§è´¨"><a href="#3-åˆ›å»ºç©ºæ´æ–‡ä»¶ï¼ŒåŒæ—¶æ¢ç´¢ç©ºæ´æ€§è´¨" class="headerlink" title="3 åˆ›å»ºç©ºæ´æ–‡ä»¶ï¼ŒåŒæ—¶æ¢ç´¢ç©ºæ´æ€§è´¨"></a>3 åˆ›å»ºç©ºæ´æ–‡ä»¶ï¼ŒåŒæ—¶æ¢ç´¢ç©ºæ´æ€§è´¨</h2><p>äº¤æ›¿<code>lseek</code>å’Œ<code>write</code>ï¼Œé€æ¸å¢å¤§é—´éš”é•¿åº¦ã€‚æ¯”è¾ƒæ–‡ä»¶çš„å¤§å°å’Œå®é™…å ç”¨çš„blockæ•°ç›®</p>
<ul>
<li>æµ‹è¯•æºç </li>
</ul>
<div><div class="fold_hider"><div class="close hider_title">ç‚¹å‡»å±•å¼€ä»£ç </div></div><div class="fold">
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> holesize[]=&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">4</span>, <span class="number">8</span>, <span class="number">16</span>, <span class="number">32</span>, <span class="number">64</span>, <span class="number">128</span>, <span class="number">256</span>, <span class="number">512</span>, <span class="number">1024</span>, <span class="number">2048</span>, <span class="number">4096</span>, <span class="number">8192</span>, <span class="number">16384</span>, <span class="number">32</span>*<span class="number">1024</span>&#125;;</span><br><span class="line"><span class="keyword">int</span> filesize = <span class="number">64</span>*<span class="number">1024</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> ret = <span class="number">0</span>, fd = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">char</span> filename[<span class="number">32</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> buf[<span class="number">32</span>*<span class="number">1024</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="built_in">memset</span>(buf, <span class="number">1</span>, <span class="number">32</span>*<span class="number">1024</span>);</span><br><span class="line">    <span class="keyword">for</span> (; i&lt; <span class="keyword">sizeof</span>(holesize)/ <span class="keyword">sizeof</span>(<span class="keyword">int</span>); ++i) &#123;</span><br><span class="line">        count = <span class="number">0</span>;</span><br><span class="line">        <span class="built_in">memset</span>(filename, <span class="number">0</span>, <span class="number">32</span>);</span><br><span class="line">        <span class="built_in">sprintf</span>(filename, <span class="string">&quot;%s%d&quot;</span>, <span class="string">&quot;holesize&quot;</span>, holesize[i]);</span><br><span class="line">        fd = open(filename, O_WRONLY | O_CREAT | O_TRUNC, S_IRUSR|S_IWUSR|S_IRGRP|S_IROTH);</span><br><span class="line">        <span class="keyword">if</span>(fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;open file fail\n&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span>(count &lt; filesize) &#123;</span><br><span class="line">            ret = lseek(fd, holesize[i], SEEK_CUR);</span><br><span class="line">            <span class="keyword">if</span>(ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;lseek fail\n&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">int</span> remain = holesize[i];</span><br><span class="line">            <span class="keyword">while</span>(remain) &#123;</span><br><span class="line">                ret = write(fd, buf, remain);</span><br><span class="line">                <span class="keyword">if</span>(ret &lt; <span class="number">0</span> ) &#123;</span><br><span class="line">                    perror(<span class="string">&quot;write fail\n&quot;</span>);</span><br><span class="line">                    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                remain -= ret;</span><br><span class="line">            &#125;</span><br><span class="line">            count += holesize[i] * <span class="number">2</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        close(fd);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</div></div>

<ul>
<li>MAC OSX 10.1.4.6æµ‹è¯•ç»“æœ</li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">^_^$ ll -s</span><br><span class="line">128 -rw-r--r--   1 chenzf  staff  65536 12 28 20:08 holesize1</span><br><span class="line">128 -rw-r--r--   1 chenzf  staff  65536 12 28 20:08 holesize1024</span><br><span class="line">128 -rw-r--r--   1 chenzf  staff  65536 12 28 20:08 holesize128</span><br><span class="line">128 -rw-r--r--   1 chenzf  staff  65536 12 28 20:08 holesize16</span><br><span class="line">128 -rw-r--r--   1 chenzf  staff  65536 12 28 20:08 holesize16384</span><br><span class="line">128 -rw-r--r--   1 chenzf  staff  65536 12 28 20:08 holesize2</span><br><span class="line">128 -rw-r--r--   1 chenzf  staff  65536 12 28 20:08 holesize2048</span><br><span class="line">128 -rw-r--r--   1 chenzf  staff  65536 12 28 20:08 holesize256</span><br><span class="line">128 -rw-r--r--   1 chenzf  staff  65536 12 28 20:08 holesize32</span><br><span class="line">128 -rw-r--r--   1 chenzf  staff  65536 12 28 20:08 holesize32768</span><br><span class="line">128 -rw-r--r--   1 chenzf  staff  65536 12 28 20:08 holesize4</span><br><span class="line">128 -rw-r--r--   1 chenzf  staff  65536 12 28 20:08 holesize4096</span><br><span class="line">128 -rw-r--r--   1 chenzf  staff  65536 12 28 20:08 holesize512</span><br><span class="line">128 -rw-r--r--   1 chenzf  staff  65536 12 28 20:08 holesize64</span><br><span class="line">128 -rw-r--r--   1 chenzf  staff  65536 12 28 20:08 holesize8</span><br><span class="line">128 -rw-r--r--   1 chenzf  staff  65536 12 28 20:08 holesize8192</span><br></pre></td></tr></table></figure>

<p>Mac OSXä¸Šåˆ›å»ºä¸äº†ç©ºæ´æ–‡ä»¶ï¼Œå› ä¸ºé»˜è®¤çš„æ–‡ä»¶ç³»ç»Ÿæ˜¯HFS +ï¼Œä¸æ”¯æŒç¨€ç–æ–‡ä»¶</p>
<ul>
<li>Ubuntu18 4.15.0-60-genericæµ‹è¯•ç»“æœ</li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">^_^$ ll -s</span><br><span class="line">64 -rw-r--r-- 1 chen chen 65536 12æœˆ 25 00:08 holesize1</span><br><span class="line">64 -rw-r--r-- 1 chen chen 65536 12æœˆ 25 00:08 holesize1024</span><br><span class="line">64 -rw-r--r-- 1 chen chen 65536 12æœˆ 25 00:08 holesize128</span><br><span class="line">64 -rw-r--r-- 1 chen chen 65536 12æœˆ 25 00:08 holesize16</span><br><span class="line">32 -rw-r--r-- 1 chen chen 65536 12æœˆ 25 00:08 holesize16384</span><br><span class="line">64 -rw-r--r-- 1 chen chen 65536 12æœˆ 25 00:08 holesize2</span><br><span class="line">64 -rw-r--r-- 1 chen chen 65536 12æœˆ 25 00:08 holesize2048</span><br><span class="line">64 -rw-r--r-- 1 chen chen 65536 12æœˆ 25 00:08 holesize256</span><br><span class="line">64 -rw-r--r-- 1 chen chen 65536 12æœˆ 25 00:08 holesize32</span><br><span class="line">32 -rw-r--r-- 1 chen chen 65536 12æœˆ 25 00:08 holesize32768</span><br><span class="line">64 -rw-r--r-- 1 chen chen 65536 12æœˆ 25 00:08 holesize4</span><br><span class="line">32 -rw-r--r-- 1 chen chen 65536 12æœˆ 25 00:08 holesize4096</span><br><span class="line">64 -rw-r--r-- 1 chen chen 65536 12æœˆ 25 00:08 holesize512</span><br><span class="line">64 -rw-r--r-- 1 chen chen 65536 12æœˆ 25 00:08 holesize64</span><br><span class="line">64 -rw-r--r-- 1 chen chen 65536 12æœˆ 25 00:08 holesize8</span><br><span class="line">32 -rw-r--r-- 1 chen chen 65536 12æœˆ 25 00:08 holesize8192</span><br></pre></td></tr></table></figure>

<p>4KBä»¥ä¸Šæ‰å®é™…åˆ›å»ºç©ºæ´ã€‚<br>å› ä¸ºåœ¨linuxçš„æ–‡ä»¶ç³»ç»Ÿä¸­ï¼Œç£ç›˜åˆ†é…çš„æœ€å°ç‰©ç†å•å…ƒä¸ºç°‡ã€‚(å³ä½¿æ–‡ä»¶å¤§å°ä¸è¶³ä»¥å ç”¨æ»¡ä¸€ç°‡ï¼Œè¯¥ç°‡ç©ºä½™çš„ç£ç›˜å­˜å‚¨ä»æ—§æ˜¯è¯¥æ–‡ä»¶çš„)</p>
<p>æ‰€ä»¥å¯ä»¥æ ¹æ®è¿™ä¸ªæ€§è´¨ï¼Œåˆ¤æ–­æ–‡ä»¶æ˜¯å¦æ˜¯ç©ºæ´æ–‡ä»¶ã€‚æœ‰ç©ºæ´çš„æ–‡ä»¶ï¼Œç”¨æ–‡ä»¶å¤§å°è®¡ç®—çš„blockæ•°è‡³å°‘æ¯”å®é™…å ç”¨çš„blockæ•°å¤§1ä¸ªç°‡çš„blockæ•°</p>
<h2 id="å¦‚ä½•å¯ç§»æ¤åœ°è·å–ç°‡çš„å¤§å°"><a href="#å¦‚ä½•å¯ç§»æ¤åœ°è·å–ç°‡çš„å¤§å°" class="headerlink" title="å¦‚ä½•å¯ç§»æ¤åœ°è·å–ç°‡çš„å¤§å°"></a>å¦‚ä½•å¯ç§»æ¤åœ°è·å–ç°‡çš„å¤§å°</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">pagesize = sysconf(_SC_PAGESIZE);</span><br></pre></td></tr></table></figure>

<h2 id="åˆæ­¥å®ç°åŠŸèƒ½"><a href="#åˆæ­¥å®ç°åŠŸèƒ½" class="headerlink" title="åˆæ­¥å®ç°åŠŸèƒ½"></a>åˆæ­¥å®ç°åŠŸèƒ½</h2><ul>
<li>æºç </li>
</ul>
<div><div class="fold_hider"><div class="close hider_title">ç‚¹å‡»å±•å¼€ä»£ç </div></div><div class="fold">
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/errno.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">my_cp</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *from, <span class="keyword">const</span> <span class="keyword">char</span> *to)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> fd1 = <span class="number">-1</span>, fd2 = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">int</span> rev = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> *buffer = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> *start_pos = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">long</span> pagesize = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">long</span> blocks, blksize, size;</span><br><span class="line">    <span class="keyword">int</span> read_num, write_num, remain_num, current_pos = <span class="number">0</span>, last_zero = <span class="number">-1</span>, last_nonzero = <span class="number">-1</span>, have_holes = <span class="number">0</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">st</span>;</span></span><br><span class="line"></span><br><span class="line">    fd1 = open(from, O_RDONLY);</span><br><span class="line">    <span class="keyword">if</span>(<span class="number">-1</span> == fd1)&#123;</span><br><span class="line">        perror(<span class="string">&quot;open file1 faild&quot;</span>);</span><br><span class="line">        <span class="keyword">goto</span> err;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(fstat(fd1, &amp;st) !=<span class="number">0</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;fstat: &quot;</span>);</span><br><span class="line">        <span class="keyword">goto</span> err;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _SC_PAGESIZE</span></span><br><span class="line">        pagesize = sysconf(_SC_PAGESIZE);</span><br><span class="line">        <span class="keyword">if</span> (pagesize &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (errno != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (errno == EINVAL) &#123;</span><br><span class="line">                    <span class="built_in">fputs</span>(<span class="string">&quot; (not supported)\n&quot;</span>, <span class="built_in">stdout</span>);</span><br><span class="line">                    pagesize = st.st_blksize;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    perror(<span class="string">&quot;sysconf error&quot;</span>);</span><br><span class="line">                    <span class="keyword">goto</span> err;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">fputs</span>(<span class="string">&quot; (no limit)\n&quot;</span>, <span class="built_in">stdout</span>);</span><br><span class="line">                pagesize = st.st_blksize;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;pagesize: %ld\n&quot;</span>, pagesize);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">        pagesize = st.st_blksize;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">        blocks = st.st_blocks;</span><br><span class="line">        blksize = st.st_blksize;</span><br><span class="line">        size = st.st_size;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;st.st_blocks: %lld\n&quot;</span>, blocks);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;st.st_blksize: %lld\n&quot;</span>, blksize);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;st.st_size: %lld\n&quot;</span>, size);</span><br><span class="line">        <span class="comment">/*å—å¤§å°512ï¼Œåœ¨ä¸åŒå¹³å°ä¸Šå¯èƒ½ä¸å…¼å®¹*/</span></span><br><span class="line">        <span class="keyword">if</span>(S_ISREG(st.st_mode) &amp;&amp; (size / pagesize + (size%pagesize?<span class="number">1</span>:<span class="number">0</span>)) * pagesize &gt; <span class="number">512</span> * blocks) &#123;</span><br><span class="line">            have_holes = <span class="number">1</span>;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%s is a sparse-block file!\n&quot;</span>, from);</span><br><span class="line">        &#125; <span class="keyword">else</span>&#123;</span><br><span class="line">            have_holes = <span class="number">0</span>;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%s is not a sparse-block file!\n&quot;</span>, from);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    fd2 = open(to, O_WRONLY | O_CREAT | O_TRUNC, S_IRUSR|S_IWUSR|S_IRGRP|S_IROTH);</span><br><span class="line">    <span class="keyword">if</span> ( <span class="number">-1</span> == fd2) &#123;</span><br><span class="line">        perror (<span class="string">&quot;open file2 faild&quot;</span>);</span><br><span class="line">        <span class="keyword">goto</span> err;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    buffer = <span class="built_in">malloc</span>(pagesize);</span><br><span class="line">    <span class="keyword">if</span>(buffer == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        perror (<span class="string">&quot;malloc fail&quot;</span>);</span><br><span class="line">        <span class="keyword">goto</span> err;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">memset</span>(buffer, <span class="string">&#x27;\0&#x27;</span>, pagesize);</span><br><span class="line">    <span class="keyword">while</span>((read_num = read(fd1, buffer, pagesize)) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">/* æºæ–‡ä»¶æœ‰ç©ºæ´ */</span></span><br><span class="line">        <span class="keyword">if</span>(have_holes)&#123;</span><br><span class="line">            last_zero = <span class="number">-1</span>;</span><br><span class="line">            last_nonzero = <span class="number">-1</span>;</span><br><span class="line">            <span class="keyword">for</span>(current_pos = <span class="number">0</span>; current_pos &lt; read_num; current_pos++)&#123;</span><br><span class="line">                <span class="comment">/* é€å­—èŠ‚åˆ¤æ–­ï¼Œæ•ˆç‡è¾ƒä½*/</span></span><br><span class="line">                <span class="keyword">if</span>(buffer[current_pos] == <span class="number">0</span>)&#123;</span><br><span class="line">                    <span class="keyword">if</span>(last_nonzero &gt; last_zero)&#123;</span><br><span class="line">                        remain_num = last_nonzero - last_zero;</span><br><span class="line">                        start_pos = buffer + last_zero + <span class="number">1</span>;</span><br><span class="line">                        <span class="keyword">while</span>(remain_num)&#123;</span><br><span class="line">                            write_num = write(fd2, start_pos, remain_num);</span><br><span class="line">                            <span class="keyword">if</span> ( <span class="number">-1</span> == write_num)&#123;</span><br><span class="line">                                perror( <span class="string">&quot;write file2 error&quot;</span>);</span><br><span class="line">                                <span class="keyword">goto</span> err;</span><br><span class="line">                            &#125;</span><br><span class="line">                            remain_num -= write_num;</span><br><span class="line">                            start_pos += write_num;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    last_zero = current_pos;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span>&#123;</span><br><span class="line">                    <span class="keyword">if</span>(last_zero &gt; last_nonzero)&#123;</span><br><span class="line">                        remain_num = last_zero - last_nonzero;</span><br><span class="line">                        <span class="keyword">if</span>(<span class="number">-1</span> == lseek(fd2, remain_num, SEEK_CUR))&#123;</span><br><span class="line">                            perror(<span class="string">&quot;lseek file2 fail&quot;</span>);</span><br><span class="line">                            <span class="keyword">goto</span> err;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    last_nonzero = current_pos;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">/* å¤„ç†æœ€åå‰©ä½™æ•°æ®*/</span></span><br><span class="line">            remain_num = (last_nonzero &gt; last_zero)?(last_nonzero - last_zero):(last_zero - last_nonzero);</span><br><span class="line">            start_pos = buffer + current_pos - remain_num;</span><br><span class="line">            <span class="keyword">if</span>(last_nonzero &gt; last_zero)&#123;</span><br><span class="line">                <span class="keyword">while</span>(remain_num)&#123;</span><br><span class="line">                    write_num = write(fd2, start_pos, remain_num);</span><br><span class="line">                    <span class="keyword">if</span> ( <span class="number">-1</span> == write_num)&#123;</span><br><span class="line">                        perror( <span class="string">&quot;write file2 error&quot;</span>);</span><br><span class="line">                        <span class="keyword">goto</span> err;</span><br><span class="line">                    &#125;</span><br><span class="line">                        remain_num -= write_num;</span><br><span class="line">                        start_pos += write_num;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            <span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="keyword">if</span>(<span class="number">-1</span> == lseek(fd2, remain_num, SEEK_CUR))&#123;</span><br><span class="line">                    perror(<span class="string">&quot;lseek file2 fail&quot;</span>);</span><br><span class="line">                    <span class="keyword">goto</span> err;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/* æºæ–‡ä»¶æ— ç©ºæ´ */</span></span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            remain_num = read_num;</span><br><span class="line">            start_pos = buffer;</span><br><span class="line">            <span class="keyword">while</span>(remain_num)&#123;</span><br><span class="line">                write_num = write(fd2, start_pos, remain_num);</span><br><span class="line">                <span class="keyword">if</span> ( <span class="number">-1</span> == write_num)&#123;</span><br><span class="line">                    perror( <span class="string">&quot;write file2 error&quot;</span>);</span><br><span class="line">                    <span class="keyword">goto</span> err;</span><br><span class="line">                &#125;</span><br><span class="line">                remain_num -= write_num;</span><br><span class="line">                start_pos += write_num;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(<span class="number">-1</span> == read_num) &#123;</span><br><span class="line">        perror(<span class="string">&quot;read file1 error&quot;</span>);</span><br><span class="line">        <span class="keyword">goto</span> err;</span><br><span class="line">    &#125;</span><br><span class="line">    rev = <span class="number">0</span>;</span><br><span class="line">err:</span><br><span class="line">    <span class="keyword">if</span>(buffer) <span class="built_in">free</span>(buffer);</span><br><span class="line">    close(fd1);</span><br><span class="line">    close(fd2);</span><br><span class="line">    <span class="keyword">return</span> rev;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(argc &lt; <span class="number">3</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Usage: %s file1 file2\n&quot;</span>, argv[<span class="number">0</span>]);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    my_cp(argv[<span class="number">1</span>], argv[<span class="number">2</span>]);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</div></div>

<ul>
<li>æµ‹è¯•ç»“æœ</li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">^_^$ ./my_cp holesize2048 holesize2048.cp</span><br><span class="line">pagesize: 4096</span><br><span class="line">st.st_blocks: 128</span><br><span class="line">st.st_blksize: 4096</span><br><span class="line">st.st_size: 65536</span><br><span class="line">holesize2048 is not a sparse-block file!</span><br><span class="line">chen@ubuntu18:~/study/apue.3e/exercises/4</span><br><span class="line">^_^$ ./my_cp holesize4096 holesize4096.cp</span><br><span class="line">pagesize: 4096</span><br><span class="line">st.st_blocks: 72</span><br><span class="line">st.st_blksize: 4096</span><br><span class="line">st.st_size: 65536</span><br><span class="line">holesize4096 is a sparse-block file!</span><br><span class="line"></span><br><span class="line">^_^$ ll -s</span><br><span class="line">total 1708</span><br><span class="line">64 -rw-r--r-- 1 chen chen  65536 1æœˆ   6 17:27 holesize2048</span><br><span class="line">64 -rw-r--r-- 1 chen chen  65536 1æœˆ   6 17:27 holesize2048.cp</span><br><span class="line">36 -rw-r--r-- 1 chen chen  65536 1æœˆ   6 17:27 holesize4096</span><br><span class="line">32 -rw-r--r-- 1 chen chen  65536 1æœˆ   6 17:27 holesize4096.cp</span><br></pre></td></tr></table></figure>

<p>ç©ºæ´æ–‡ä»¶å¯ä»¥æ­£å¸¸æ‹·è´</p>
<h2 id="å°è¯•ä¼˜åŒ–ç¨‹åº"><a href="#å°è¯•ä¼˜åŒ–ç¨‹åº" class="headerlink" title="å°è¯•ä¼˜åŒ–ç¨‹åº"></a>å°è¯•ä¼˜åŒ–ç¨‹åº</h2><p>ä¸Šé¢çš„ç¨‹åºä»…åœ¨åˆ¤æ–­æ–‡ä»¶æ˜¯å¦å«æœ‰ç©ºæ´æ—¶åˆ©ç”¨çš„ç©ºæ´çš„æœ€å°é™åˆ¶ã€‚è€Œåœ¨å®é™…è¯»å†™æ—¶å¹¶æ²¡æœ‰åˆ©ç”¨è¯¥æ€§è´¨ã€‚</p>
<p>è¿™æ ·è¾ƒçŸ­çš„0å­—èŠ‚ä¹Ÿä¼šå½“æˆæ˜¯ç©ºæ´ï¼Œå¯¼è‡´ç³»ç»Ÿè°ƒç”¨æ¬¡æ•°çš„å¢åŠ ï¼Œæ€§èƒ½çš„é™ä½</p>
<p>è¦ä¼˜åŒ–æ€§èƒ½ï¼Œå¿…é¡»è¿›ä¸€æ­¥æ¢ç©¶ç©ºæ´çš„æ€§è´¨ã€‚åœ¨ä»€ä¹ˆæ ·çš„æƒ…å†µä¸‹æ‰åˆ›å»ºç©ºæ´(ä¸å®é™…å ç”¨ç£ç›˜ç©ºé—´çš„å—)ï¼Ÿ</p>
<ul>
<li>æµ‹è¯•ç¨‹åºæºç </li>
</ul>
<p>æ­¤ç¨‹åºåˆ›å»ºäº†3ä¸ªæ–‡ä»¶ï¼š</p>
<pre><code>- æ–‡ä»¶1å…ˆ`write`äº†1Kçš„éé›¶æ•°æ®ï¼Œç„¶å`lseek` 7K-1å­—èŠ‚ã€‚å¾ªç¯2æ¬¡ã€‚
- æ–‡ä»¶2å…ˆ`write`äº†1Kçš„éé›¶æ•°æ®ï¼Œç„¶å`lseek` 7Kå­—èŠ‚ã€‚å¾ªç¯2æ¬¡
- æ–‡ä»¶3å…ˆ`write`äº†1Kçš„éé›¶æ•°æ®ï¼Œç„¶å`lseek` 7K+1å­—èŠ‚ã€‚å¾ªç¯2æ¬¡
</code></pre>
<div><div class="fold_hider"><div class="close hider_title">ç‚¹å‡»å±•å¼€ä»£ç </div></div><div class="fold">
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> holesize[]=&#123;<span class="number">4096</span>&#125;;</span><br><span class="line"><span class="keyword">int</span> filesize = <span class="number">64</span>*<span class="number">1024</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> ret = <span class="number">0</span>, fd1 = <span class="number">0</span>, fd2 = <span class="number">0</span>, fd3 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">char</span> filename1[<span class="number">32</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">char</span> filename2[<span class="number">32</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">char</span> filename3[<span class="number">32</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> buf[<span class="number">32</span>*<span class="number">1024</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="built_in">memset</span>(buf, <span class="number">1</span>, <span class="number">32</span>*<span class="number">1024</span>);</span><br><span class="line">    <span class="keyword">for</span> (; i&lt; <span class="keyword">sizeof</span>(holesize)/ <span class="keyword">sizeof</span>(<span class="keyword">int</span>); ++i) &#123;</span><br><span class="line">        count = <span class="number">0</span>;</span><br><span class="line">        <span class="built_in">memset</span>(filename1, <span class="number">0</span>, <span class="number">32</span>);</span><br><span class="line">        <span class="built_in">memset</span>(filename2, <span class="number">0</span>, <span class="number">32</span>);</span><br><span class="line">        <span class="built_in">memset</span>(filename3, <span class="number">0</span>, <span class="number">32</span>);</span><br><span class="line">        <span class="built_in">sprintf</span>(filename1, <span class="string">&quot;%s%d-1&quot;</span>, <span class="string">&quot;holesize&quot;</span>, holesize[i]);</span><br><span class="line">        <span class="built_in">sprintf</span>(filename2, <span class="string">&quot;%s%d-2&quot;</span>, <span class="string">&quot;holesize&quot;</span>, holesize[i]);</span><br><span class="line">        <span class="built_in">sprintf</span>(filename3, <span class="string">&quot;%s%d-3&quot;</span>, <span class="string">&quot;holesize&quot;</span>, holesize[i]);</span><br><span class="line">        fd1 = open(filename1, O_WRONLY | O_CREAT | O_TRUNC, S_IRUSR|S_IWUSR|S_IRGRP|S_IROTH);</span><br><span class="line">        fd2 = open(filename2, O_WRONLY | O_CREAT | O_TRUNC, S_IRUSR|S_IWUSR|S_IRGRP|S_IROTH);</span><br><span class="line">        fd3 = open(filename3, O_WRONLY | O_CREAT | O_TRUNC, S_IRUSR|S_IWUSR|S_IRGRP|S_IROTH);</span><br><span class="line">        <span class="keyword">if</span>(fd1 &lt; <span class="number">0</span> || fd2 &lt; <span class="number">0</span> || fd3 &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;open file fail\n&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        count = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span>(count &lt; <span class="number">2</span>) &#123;</span><br><span class="line">            <span class="keyword">int</span> remain = holesize[i] * <span class="number">1</span> / <span class="number">4</span>;</span><br><span class="line">            <span class="keyword">while</span>(remain) &#123;</span><br><span class="line">                ret = write(fd1, buf, remain);</span><br><span class="line">                <span class="keyword">if</span>(ret &lt; <span class="number">0</span> ) &#123;</span><br><span class="line">                    perror(<span class="string">&quot;write fail\n&quot;</span>);</span><br><span class="line">                    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                remain -= ret;</span><br><span class="line">            &#125;</span><br><span class="line">            ret = lseek(fd1, holesize[i] * <span class="number">7</span> / <span class="number">4</span> - <span class="number">1</span>, SEEK_CUR);</span><br><span class="line">            <span class="keyword">if</span>(ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;lseek fail\n&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            ++count;</span><br><span class="line">        &#125;</span><br><span class="line">        count = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span>(count &lt; <span class="number">2</span>) &#123;</span><br><span class="line">            <span class="keyword">int</span> remain = holesize[i] * <span class="number">1</span> / <span class="number">4</span>;</span><br><span class="line">            <span class="keyword">while</span>(remain) &#123;</span><br><span class="line">                ret = write(fd2, buf, remain);</span><br><span class="line">                <span class="keyword">if</span>(ret &lt; <span class="number">0</span> ) &#123;</span><br><span class="line">                    perror(<span class="string">&quot;write fail\n&quot;</span>);</span><br><span class="line">                    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                remain -= ret;</span><br><span class="line">            &#125;</span><br><span class="line">            ret = lseek(fd2, holesize[i] * <span class="number">7</span> / <span class="number">4</span>, SEEK_CUR);</span><br><span class="line">            <span class="keyword">if</span>(ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;lseek fail\n&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            ++count;</span><br><span class="line">        &#125;</span><br><span class="line">        count = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span>(count &lt; <span class="number">2</span>) &#123;</span><br><span class="line">            <span class="keyword">int</span> remain = holesize[i] * <span class="number">1</span> / <span class="number">4</span>;</span><br><span class="line">            <span class="keyword">while</span>(remain) &#123;</span><br><span class="line">                ret = write(fd3, buf, remain);</span><br><span class="line">                <span class="keyword">if</span>(ret &lt; <span class="number">0</span> ) &#123;</span><br><span class="line">                    perror(<span class="string">&quot;write fail\n&quot;</span>);</span><br><span class="line">                    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                remain -= ret;</span><br><span class="line">            &#125;</span><br><span class="line">            ret = lseek(fd3, holesize[i] * <span class="number">7</span> / <span class="number">4</span> + <span class="number">1</span>, SEEK_CUR);</span><br><span class="line">            <span class="keyword">if</span>(ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;lseek fail\n&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            ++count;</span><br><span class="line">        &#125;</span><br><span class="line">        close(fd1);</span><br><span class="line">        close(fd2);</span><br><span class="line">        close(fd3);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</div></div>

<ul>
<li>æµ‹è¯•ç»“æœ</li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">^_^$ ll -s</span><br><span class="line">12 -rw-r--r-- 1 chen chen  9215 1æœˆ   6 15:07 holesize4096-1</span><br><span class="line"> 8 -rw-r--r-- 1 chen chen  9216 1æœˆ   6 15:07 holesize4096-2</span><br><span class="line"> 8 -rw-r--r-- 1 chen chen  9217 1æœˆ   6 15:07 holesize4096-3</span><br></pre></td></tr></table></figure>

<p>å¯è§ç©ºæ´å¿…é¡»ä»ä¸€é¡µçš„èµ·å§‹ä½ç½®å¼€å§‹è®¡ç®—,å¹¶ä¸”ç­‰äºæˆ–è¶…è¿‡pagesizeï¼Œæ‰ä¸å ç”¨å®é™…ç£ç›˜ç©ºé—´</p>
<h2 id="ä¼˜åŒ–åç¨‹åº"><a href="#ä¼˜åŒ–åç¨‹åº" class="headerlink" title="ä¼˜åŒ–åç¨‹åº"></a>ä¼˜åŒ–åç¨‹åº</h2><ul>
<li>æºç </li>
</ul>
<div><div class="fold_hider"><div class="close hider_title">ç‚¹å‡»å±•å¼€ä»£ç </div></div><div class="fold">
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/errno.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">read_ex</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> nbyte)</span></span>&#123;</span><br><span class="line">    <span class="keyword">size_t</span> read_remain = nbyte;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> *read_start = (<span class="keyword">unsigned</span> <span class="keyword">char</span>*)buf;</span><br><span class="line">    <span class="keyword">ssize_t</span> read_num = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">ssize_t</span> total_num = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>(read_remain) &#123;</span><br><span class="line">        read_num = read(fd, read_start, read_remain);</span><br><span class="line">        <span class="keyword">if</span>(<span class="number">-1</span> == read_num)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(<span class="number">0</span> == read_num)&#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            read_remain -= read_num;</span><br><span class="line">            read_start += read_num;</span><br><span class="line">            total_num += read_num;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> total_num;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">write_ex</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">const</span> <span class="keyword">void</span> *buf, <span class="keyword">size_t</span> nbyte)</span></span>&#123;</span><br><span class="line">    <span class="keyword">size_t</span> write_remain = nbyte;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> *write_start = (<span class="keyword">unsigned</span> <span class="keyword">char</span>*)buf;</span><br><span class="line">    <span class="keyword">ssize_t</span> write_num = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">ssize_t</span> total_num = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>(write_remain) &#123;</span><br><span class="line">        write_num = write(fd, write_start, write_remain);</span><br><span class="line">        <span class="keyword">if</span>(<span class="number">-1</span> == write_num)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            write_remain -= write_num;</span><br><span class="line">            write_start += write_num;</span><br><span class="line">            total_num += write_num;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> total_num;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">my_cp</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *from, <span class="keyword">const</span> <span class="keyword">char</span> *to)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> fd1 = <span class="number">-1</span>, fd2 = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">int</span> rev = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> *buffer = <span class="literal">NULL</span>, *buffer_zero = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">long</span> pagesize = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">long</span> <span class="keyword">long</span> blocks, blksize, size;</span><br><span class="line">    <span class="keyword">int</span> read_num, write_num, write_remain, have_holes = <span class="number">0</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">st</span>;</span></span><br><span class="line"></span><br><span class="line">    fd1 = open(from, O_RDONLY);</span><br><span class="line">    <span class="keyword">if</span>(<span class="number">-1</span> == fd1)&#123;</span><br><span class="line">        perror(<span class="string">&quot;open file1 faild&quot;</span>);</span><br><span class="line">        <span class="keyword">goto</span> err;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(fstat(fd1, &amp;st) !=<span class="number">0</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;fstat: &quot;</span>);</span><br><span class="line">        <span class="keyword">goto</span> err;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _SC_PAGESIZE</span></span><br><span class="line">        pagesize = sysconf(_SC_PAGESIZE);</span><br><span class="line">        <span class="keyword">if</span> (pagesize &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (errno != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (errno == EINVAL) &#123;</span><br><span class="line">                    <span class="built_in">fputs</span>(<span class="string">&quot; (not supported)\n&quot;</span>, <span class="built_in">stdout</span>);</span><br><span class="line">                    pagesize = st.st_blksize;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    perror(<span class="string">&quot;sysconf error&quot;</span>);</span><br><span class="line">                    <span class="keyword">goto</span> err;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">fputs</span>(<span class="string">&quot; (no limit)\n&quot;</span>, <span class="built_in">stdout</span>);</span><br><span class="line">                pagesize = st.st_blksize;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;pagesize: %ld\n&quot;</span>, pagesize);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">        pagesize = st.st_blksize;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">        blocks = st.st_blocks;</span><br><span class="line">        blksize = st.st_blksize;</span><br><span class="line">        size = st.st_size;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;st.st_blocks: %lld\n&quot;</span>, blocks);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;st.st_blksize: %lld\n&quot;</span>, blksize);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;st.st_size: %lld\n&quot;</span>, size);</span><br><span class="line">        <span class="comment">/*å—å¤§å°512ï¼Œåœ¨ä¸åŒå¹³å°ä¸Šå¯èƒ½ä¸å…¼å®¹*/</span></span><br><span class="line">        <span class="keyword">if</span>(S_ISREG(st.st_mode) &amp;&amp; (size / pagesize + (size%pagesize?<span class="number">1</span>:<span class="number">0</span>)) * pagesize &gt; <span class="number">512</span> * blocks) &#123;</span><br><span class="line">            have_holes = <span class="number">1</span>;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%s is a sparse-block file!\n&quot;</span>, from);</span><br><span class="line">        &#125; <span class="keyword">else</span>&#123;</span><br><span class="line">            have_holes = <span class="number">0</span>;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%s is not a sparse-block file!\n&quot;</span>, from);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    buffer = <span class="built_in">malloc</span>(pagesize);</span><br><span class="line">    buffer_zero = <span class="built_in">malloc</span>(pagesize);</span><br><span class="line">    <span class="keyword">if</span>(buffer == <span class="literal">NULL</span> || buffer_zero == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        perror (<span class="string">&quot;malloc fail&quot;</span>);</span><br><span class="line">        <span class="keyword">goto</span> err;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">memset</span>(buffer, <span class="string">&#x27;\0&#x27;</span>, pagesize);</span><br><span class="line">    <span class="built_in">memset</span>(buffer_zero, <span class="string">&#x27;\0&#x27;</span>, pagesize);</span><br><span class="line"></span><br><span class="line">    fd2 = open(to, O_WRONLY | O_CREAT | O_TRUNC, S_IRUSR|S_IWUSR|S_IRGRP|S_IROTH);</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">-1</span> == fd2) &#123;</span><br><span class="line">        perror (<span class="string">&quot;open file2 faild&quot;</span>);</span><br><span class="line">        <span class="keyword">goto</span> err;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>((read_num = read_ex(fd1, buffer, pagesize)) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">/* è¯»å–åˆ°ç©ºæ´ */</span></span><br><span class="line">        <span class="keyword">if</span>(have_holes &amp;&amp; !<span class="built_in">memcmp</span>(buffer_zero, buffer, read_num))&#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="number">-1</span> == lseek(fd2, read_num, SEEK_CUR))&#123;</span><br><span class="line">                perror(<span class="string">&quot;lseek file2 fail&quot;</span>);</span><br><span class="line">                <span class="keyword">goto</span> err;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/* éç©ºæ´ */</span></span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            write_num = write_ex(fd2, buffer, read_num);</span><br><span class="line">            <span class="keyword">if</span> (<span class="number">-1</span> == write_num)&#123;</span><br><span class="line">                perror( <span class="string">&quot;write file2 error&quot;</span>);</span><br><span class="line">                <span class="keyword">goto</span> err;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(<span class="number">-1</span> == read_num)&#123;</span><br><span class="line">        perror(<span class="string">&quot;read file1 error&quot;</span>);</span><br><span class="line">        <span class="keyword">goto</span> err;</span><br><span class="line">    &#125;</span><br><span class="line">    rev = <span class="number">0</span>;</span><br><span class="line">err:</span><br><span class="line">    <span class="keyword">if</span>(buffer) <span class="built_in">free</span>(buffer);</span><br><span class="line">    <span class="keyword">if</span>(buffer_zero) <span class="built_in">free</span>(buffer_zero);</span><br><span class="line">    close(fd1);</span><br><span class="line">    close(fd2);</span><br><span class="line">    <span class="keyword">return</span> rev;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(argc &lt; <span class="number">3</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Usage: %s file1 file2\n&quot;</span>, argv[<span class="number">0</span>]);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    my_cp(argv[<span class="number">1</span>], argv[<span class="number">2</span>]);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</div></div>

<ul>
<li>å¯¹æ¯”æµ‹è¯•</li>
</ul>
<p>æ„é€ ä¸€ä¸ªæ–‡ä»¶ï¼Œé™¤äº†å¼€å¤´ä¸€ä¸ªç©ºæ´ï¼Œå…¶ä½™æ•°æ®ä¸º0x00,0x01çš„100000æ¬¡é‡å¤</p>
<p>ç”¨ä¼˜åŒ–å‰çš„ç¨‹åºæ‹·è´è¯¥æ–‡ä»¶10000æ¬¡ï¼Œå¤§çº¦2000s</p>
<p>ç”¨ä¼˜åŒ–åçš„ç¨‹åºæ‹·è´è¯¥æ–‡ä»¶10000æ¬¡ï¼Œå¤§çº¦30s</p>
]]></content>
      <categories>
        <category>ç¼–ç¨‹å¼€å‘</category>
        <category>Unixç¯å¢ƒç¼–ç¨‹</category>
      </categories>
      <tags>
        <tag>Unix</tag>
        <tag>cp</tag>
      </tags>
  </entry>
  <entry>
    <title>è‡ªå·±åŠ¨æ‰‹å®ç°Lua--å®ç°TAILCALLæŒ‡ä»¤</title>
    <url>/posts/74970c0e/</url>
    <content><![CDATA[<div class="note primary">
            <p>æœ€è¿‘åœ¨çœ‹ã€Šè‡ªå·±åŠ¨æ‰‹å®ç°Luaâ€”è™šæ‹Ÿæœºã€ç¼–è¯‘å™¨å’Œæ ‡å‡†åº“ã€‹ã€‚è¿™æ˜¯æœ¬æŒºä¸é”™çš„ä¹¦ï¼Œé€šè¿‡å­¦ä¹ æ­¤ä¹¦èƒ½å¤Ÿå¯¹Luaè¯­è¨€æœ‰æ¯”è¾ƒæ·±åˆ»çš„ç†è§£ï¼Œæ­¤å¤–è¿˜å¯ä»¥å¯¹å¦‚ä½•è‡ªå·±å®ç°ä¸€é—¨è„šæœ¬è¯­è¨€æœ‰ç›´è§‚çš„è®¤è¯†ã€‚å¯¹äºæƒ³å­¦ä¹ Luaçš„åŒå­¦ï¼Œå®‰åˆ©ä¸€ä¸‹è¿™æœ¬ä¹¦ã€‚</p><p>åºŸè¯ä¸å¤šè¯´ï¼Œä¹¦ä¸­ç•™äº†ä¸€ä¸ªä½œä¸šï¼Œè®©è¯»è€…è‡ªå·±å®ç°<code>TAILCALL</code>æŒ‡ä»¤ï¼Œå®ç°å°¾è°ƒç”¨çš„ä¼˜åŒ–ã€‚æœ¬æ–‡å°±ç®—æ˜¯äº¤ä½œä¸šå§ã€‚</p>
          </div>

<span id="more"></span>

<h1 id="å°¾è°ƒç”¨"><a href="#å°¾è°ƒç”¨" class="headerlink" title="å°¾è°ƒç”¨"></a>å°¾è°ƒç”¨</h1><p>å°¾è°ƒç”¨ï¼Œè¢«è°ƒå‡½æ•°å¯ä»¥é‡ç”¨ä¸»è°ƒå‡½æ•°çš„è°ƒç”¨å¸§ï¼Œå¯ä»¥æœ‰æ•ˆç¼“è§£è°ƒç”¨æ ˆæº¢å‡ºã€‚</p>
<p>ä¸è¿‡å°¾è°ƒç”¨çš„æ¡ä»¶éå¸¸è‹›åˆ»ï¼Œå¿…é¡»æ˜¯ç›´æ¥è¿”å›å‡½æ•°è°ƒç”¨ã€‚ä¸‹é¢çš„æ˜¯ä¸€ä¸ªå°¾è°ƒç”¨çš„ä¾‹å­ï¼Œ<code>TAILCALL</code>æŒ‡ä»¤åé¢è‚¯å®šç´§è·Ÿç€<code>RETURN</code>æŒ‡ä»¤ï¼Œå¹¶ä¸”<code>RETURN</code>æŒ‡ä»¤çš„æ“ä½œæ•°Aè·Ÿ<code>TAILCALL</code>ç›¸åŒï¼Œ<code>RETURN</code>æŒ‡ä»¤çš„æ“ä½œæ•°Bè‚¯å®šæ˜¯0ã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ luac -l -</span><br><span class="line"><span class="built_in">return</span> f(a)</span><br><span class="line">^D</span><br><span class="line">main &lt;stdin:0,0&gt; (5 instructions at 0x7fa2b9d00070)</span><br><span class="line">0+ params, 2 slots, 1 upvalue, 0 locals, 2 constants, 0 <span class="built_in">functions</span></span><br><span class="line">	1	[1]	GETTABUP 	0 0 -1	; _ENV <span class="string">&quot;f&quot;</span></span><br><span class="line">	2	[1]	GETTABUP 	1 0 -2	; _ENV <span class="string">&quot;a&quot;</span></span><br><span class="line">	3	[1]	TAILCALL 	0 2 0</span><br><span class="line">	4	[1]	RETURN   	0 0</span><br><span class="line">	5	[1]	RETURN   	0 1</span><br></pre></td></tr></table></figure>



<p>ä¸‹é¢å‡ ä¸ªä¾‹å­ï¼Œéƒ½ä¸æ˜¯å°¾è°ƒç”¨ã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ luac -l -</span><br><span class="line"><span class="built_in">return</span> (f(a))</span><br><span class="line">^D</span><br><span class="line">main &lt;stdin:0,0&gt; (5 instructions at 0x7fb5a34035e0)</span><br><span class="line">0+ params, 2 slots, 1 upvalue, 0 locals, 2 constants, 0 <span class="built_in">functions</span></span><br><span class="line">	1	[1]	GETTABUP 	0 0 -1	; _ENV <span class="string">&quot;f&quot;</span></span><br><span class="line">	2	[1]	GETTABUP 	1 0 -2	; _ENV <span class="string">&quot;a&quot;</span></span><br><span class="line">	3	[1]	CALL     	0 2 2</span><br><span class="line">	4	[1]	RETURN   	0 2</span><br><span class="line">	5	[1]	RETURN   	0 1</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ luac -l -</span><br><span class="line"><span class="built_in">return</span> f(a)+1</span><br><span class="line">^D</span><br><span class="line">main &lt;stdin:0,0&gt; (6 instructions at 0x7f98c3d00070)</span><br><span class="line">0+ params, 2 slots, 1 upvalue, 0 locals, 3 constants, 0 <span class="built_in">functions</span></span><br><span class="line">	1	[1]	GETTABUP 	0 0 -1	; _ENV <span class="string">&quot;f&quot;</span></span><br><span class="line">	2	[1]	GETTABUP 	1 0 -2	; _ENV <span class="string">&quot;a&quot;</span></span><br><span class="line">	3	[1]	CALL     	0 2 2</span><br><span class="line">	4	[1]	ADD      	0 0 -3	; - 1</span><br><span class="line">	5	[1]	RETURN   	0 2</span><br><span class="line">	6	[1]	RETURN   	0 1</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ luac -l -</span><br><span class="line"><span class="built_in">return</span> &#123;f(a)&#125;</span><br><span class="line">^D</span><br><span class="line">main &lt;stdin:0,0&gt; (7 instructions at 0x7fb1b95006f0)</span><br><span class="line">0+ params, 3 slots, 1 upvalue, 0 locals, 2 constants, 0 <span class="built_in">functions</span></span><br><span class="line">	1	[1]	NEWTABLE 	0 0 0</span><br><span class="line">	2	[1]	GETTABUP 	1 0 -1	; _ENV <span class="string">&quot;f&quot;</span></span><br><span class="line">	3	[1]	GETTABUP 	2 0 -2	; _ENV <span class="string">&quot;a&quot;</span></span><br><span class="line">	4	[1]	CALL     	1 2 0</span><br><span class="line">	5	[1]	SETLIST  	0 0 1	; 1</span><br><span class="line">	6	[1]	RETURN   	0 2</span><br><span class="line">	7	[1]	RETURN   	0 1</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ luac -l -</span><br><span class="line"><span class="built_in">return</span> 1, f(a)</span><br><span class="line">^D</span><br><span class="line">main &lt;stdin:0,0&gt; (6 instructions at 0x7f8f9c500070)</span><br><span class="line">0+ params, 3 slots, 1 upvalue, 0 locals, 3 constants, 0 <span class="built_in">functions</span></span><br><span class="line">	1	[1]	LOADK    	0 -1	; 1</span><br><span class="line">	2	[1]	GETTABUP 	1 0 -2	; _ENV <span class="string">&quot;f&quot;</span></span><br><span class="line">	3	[1]	GETTABUP 	2 0 -3	; _ENV <span class="string">&quot;a&quot;</span></span><br><span class="line">	4	[1]	CALL     	1 2 0</span><br><span class="line">	5	[1]	RETURN   	0 0</span><br><span class="line">	6	[1]	RETURN   	0 1</span><br></pre></td></tr></table></figure>



<h1 id="CALLæŒ‡ä»¤"><a href="#CALLæŒ‡ä»¤" class="headerlink" title="CALLæŒ‡ä»¤"></a>CALLæŒ‡ä»¤</h1><p>æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹æ™®é€šçš„<code>CALL</code>æŒ‡ä»¤çš„æ“ä½œæµç¨‹ï¼š</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// R(A), ... ,R(A+C-2) := R(A)(R(A+1), ... ,R(A+B-1))</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">call</span><span class="params">(i Instruction, vm LuaVM)</span></span> &#123;</span><br><span class="line">    a, b, c := i.ABC()</span><br><span class="line">    a += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// println(&quot;:::&quot;+ vm.StackToString())</span></span><br><span class="line">    nArgs := _pushFuncAndArgs(a, b, vm)</span><br><span class="line">    vm.Call(nArgs, c<span class="number">-1</span>)</span><br><span class="line">    _popResults(a, c, vm)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é¦–å…ˆå°†ä½äºå¯„å­˜å™¨ä¸­çš„å‡½æ•°å’Œå‚æ•°æ¨å…¥æ ˆé¡¶ï¼Œç„¶åè°ƒç”¨<code>Call()</code>æ–¹æ³•æ‰§è¡Œå‡½æ•°ï¼Œæœ€åå°†æ ˆä¸Šçš„è¿”å›å€¼å‡ºæ ˆå¹¶æ”¾å…¥æŒ‡å®šå¯„å­˜å™¨ä¸­ã€‚</p>
<p><code>_pushFuncAndArgs()</code>å’Œ<code>_popResults()</code>åˆ†åˆ«è¦å¤„ç†æ“ä½œæ•°Bå’Œæ“ä½œæ•°Cä¸º0çš„ç‰¹æ®Šæƒ…å†µã€‚æ“ä½œæ•°Bä¸º0çš„æƒ…å†µï¼Œéƒ¨åˆ†å‚æ•°å·²ç»åœ¨æ ˆä¸Šäº†ï¼ˆç”±å‰é¢çš„<code>CALL</code>æŒ‡ä»¤æˆ–<code>VARARG</code>æŒ‡ä»¤ç•™åœ¨æ ˆä¸Šï¼‰ã€‚</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> _<span class="title">pushFuncAndArgs</span><span class="params">(a, b <span class="keyword">int</span>, vm LuaVM)</span> <span class="params">(nArgs <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> b &gt;= <span class="number">1</span> &#123;</span><br><span class="line">        vm.CheckStack(b)</span><br><span class="line">        <span class="keyword">for</span> i := a; i &lt; a+b; i++ &#123;</span><br><span class="line">            vm.PushValue(i)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> b - <span class="number">1</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        _fixStack(a, vm)</span><br><span class="line">        <span class="keyword">return</span> vm.GetTop() - vm.RegisterCount() - <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è€Œæ“ä½œæ•°Cä¸º0çš„æƒ…å†µï¼Œåˆ™ä¸éœ€è¦å°†è¿”å›å€¼ä»æ ˆä¸Šå¼¹å‡ºã€‚ç›´æ¥å°†è¿”å›å€¼ç•™åœ¨æ ˆä¸Šï¼Œä¾›åé¢çš„æŒ‡ä»¤ä½¿ç”¨ã€‚</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> _<span class="title">popResults</span><span class="params">(a, c <span class="keyword">int</span>, vm LuaVM)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> c == <span class="number">1</span> &#123;</span><br><span class="line">        <span class="comment">// no results</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> c &gt; <span class="number">1</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> i := a + c - <span class="number">2</span>; i &gt;= a; i-- &#123;</span><br><span class="line">            vm.Replace(i)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// leave results on stack</span></span><br><span class="line">        vm.CheckStack(<span class="number">1</span>)</span><br><span class="line">        vm.PushInteger(<span class="keyword">int64</span>(a))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç„¶åæˆ‘ä»¬æ¥çœ‹ä¸‹<code>Call()</code>æ–¹æ³•åšäº†ä»€ä¹ˆã€‚å®ƒé¦–å…ˆæ ¹æ®ç´¢å¼•æ‰¾åˆ°è¦è°ƒç”¨çš„å‡½æ•°çš„å€¼ï¼Œæ£€æŸ¥å®ƒæ˜¯å¦æ˜¯é—­åŒ…ç±»å‹ï¼Œå¦‚æœä¸æ˜¯ç›´æ¥æŠ¥é”™ã€‚ç„¶åé€šè¿‡<code>callLuaClosure()</code>è°ƒç”¨è¯¥å‡½æ•°ã€‚</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// [-(nargs+1), +nresults, e]</span></span><br><span class="line"><span class="comment">// http://www.lua.org/manual/5.3/manual.html#lua_call</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(self *luaState)</span> <span class="title">Call</span><span class="params">(nArgs, nResults <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">    val := self.stack.get(-(nArgs + <span class="number">1</span>))</span><br><span class="line">    <span class="keyword">if</span> c, ok := val.(*closure); ok &#123;</span><br><span class="line">        fmt.Printf(<span class="string">&quot;call %s&lt;%d,%d&gt;\n&quot;</span>, c.proto.Source,</span><br><span class="line">            c.proto.LineDefined, c.proto.LastLineDefined)</span><br><span class="line">        self.callLuaClosure(nArgs, nResults, c)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(<span class="string">&quot;not function!&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>callLuaClosure()</code>ç¨å¾®æœ‰ç‚¹å¤æ‚ï¼Œæ¥çœ‹ä¸‹ä»£ç ã€‚é¦–å…ˆä»é—­åŒ…çš„å‡½æ•°åŸå‹ä¸­è·å–åˆ°å„ç§ä¿¡æ¯ï¼Œå¦‚å¯„å­˜å™¨ä¸ªæ•°ã€å›ºå®šå‚æ•°ä¸ªæ•°ã€æ˜¯å¦æ˜¯varargã€‚æ¥ç€åˆ›å»ºä¸€ä¸ªæ–°çš„è°ƒç”¨å¸§ï¼Œå¹¶å°†é—­åŒ…ä¸è°ƒç”¨å¸§å…³è”ã€‚ç„¶åå°†å‡½æ•°å’Œå‚æ•°å€¼å…¨éƒ¨ä»ä¸»è°ƒå¸§æ ˆé¡¶å¼¹å‡ºï¼Œå¹¶å°†å›ºå®šå‚æ•°å‹å…¥è¢«è°ƒå¸§æ ˆé¡¶ï¼Œå¦‚æœæ˜¯varargä¸”å‚æ•°ä¸ªæ•°å¤§äºå›ºå®šå‚æ•°ä¸ªæ•°ï¼Œè¿˜è¦å°†varargå‚æ•°è®°å½•ä¸‹æ¥ã€‚</p>
<p>åˆ°è¿™æ–°å¸§å°±å‡†å¤‡å°±ç»ªäº†ï¼Œå°†æ–°å¸§æ¨å…¥è°ƒç”¨æ ˆé¡¶ï¼Œç„¶åè°ƒç”¨<code>runLuaClosure()</code>å¼€å§‹æ‰§è¡Œè¢«è°ƒå‡½æ•°çš„æŒ‡ä»¤ã€‚æ‰§è¡Œç»“æŸä¹‹åï¼Œè¢«è°ƒå¸§çš„ä»»åŠ¡ç»“æŸï¼Œå°†å…¶å¼¹å‡ºè°ƒç”¨æ ˆé¡¶ã€‚</p>
<p>æ­¤æ—¶ï¼Œè¿”å›å€¼è¿˜ç•™åœ¨è¢«è°ƒå¸§çš„æ ˆé¡¶ï¼Œéœ€è¦ç§»åˆ°ä¸»è°ƒå¸§æ ˆé¡¶ã€‚</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(self *luaState)</span> <span class="title">callLuaClosure</span><span class="params">(nArgs, nResults <span class="keyword">int</span>, c *closure)</span></span> &#123;</span><br><span class="line">    nRegs := <span class="keyword">int</span>(c.proto.MaxStackSize)</span><br><span class="line">    nParams := <span class="keyword">int</span>(c.proto.NumParams)</span><br><span class="line">    isVararg := c.proto.IsVararg == <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// create new lua stack</span></span><br><span class="line">    newStack := newLuaStack(nRegs + <span class="number">20</span>)</span><br><span class="line">    newStack.closure = c</span><br><span class="line"></span><br><span class="line">    <span class="comment">// pass args, pop func</span></span><br><span class="line">    funcAndArgs := self.stack.popN(nArgs + <span class="number">1</span>)</span><br><span class="line">    newStack.pushN(funcAndArgs[<span class="number">1</span>:], nParams)</span><br><span class="line">    newStack.top = nRegs</span><br><span class="line">    <span class="keyword">if</span> nArgs &gt; nParams &amp;&amp; isVararg &#123;</span><br><span class="line">        newStack.varargs = funcAndArgs[nParams+<span class="number">1</span>:]</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// run closure</span></span><br><span class="line">    self.pushLuaStack(newStack)</span><br><span class="line">    self.runLuaClosure()</span><br><span class="line">    self.popLuaStack()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// return results, nResults == c - 1</span></span><br><span class="line">    <span class="keyword">if</span> nResults != <span class="number">0</span> &#123;</span><br><span class="line">        results := newStack.popN(newStack.top - nRegs)</span><br><span class="line">        self.stack.check(<span class="built_in">len</span>(results))</span><br><span class="line">        self.stack.pushN(results, nResults)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="å®ç°TAILCALLæŒ‡ä»¤"><a href="#å®ç°TAILCALLæŒ‡ä»¤" class="headerlink" title="å®ç°TAILCALLæŒ‡ä»¤"></a>å®ç°TAILCALLæŒ‡ä»¤</h1><p>çŸ¥é“äº†<code>CALL</code>æŒ‡ä»¤çš„æµç¨‹ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç€æ‰‹å®ç°<code>TAILCALL</code>æŒ‡ä»¤äº†ã€‚å…¶æ“ä½œæ•°Aå’Œæ“ä½œæ•°Bçš„å«ä¹‰è·Ÿ<code>CALL</code>æŒ‡ä»¤å®Œå…¨ä¸€è‡´ï¼Œæ“ä½œæ•°Cæ²¡ç”¨ï¼Œç›¸å½“äºå›ºå®šä¸º0ã€‚æ‰€ä»¥<code>_pushFuncAndArgs()</code>å’Œ<code>_popResults()</code>å‡½æ•°å¯ä»¥é‡ç”¨ï¼Œä¸»è¦æ˜¯ä¿®æ”¹ä¸­é—´çš„è°ƒç”¨æµç¨‹ã€‚æˆ‘ä»¬é¦–å…ˆç»™LuaVMæ–°å¢ä¸€ä¸ªæ¥å£<code>TailCall()</code>ã€‚</p>
<p>åœ¨<code>api/lua_vm.go</code>æ–‡ä»¶ä¸­æ·»åŠ å¦‚ä¸‹ä»£ç ï¼š</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="keyword">type</span> LuaVM <span class="keyword">interface</span> &#123;</span><br><span class="line">	...</span><br><span class="line">    TailCall(nArgs <span class="keyword">int</span>)	<span class="comment">// add this</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>å› ä¸º<code>TAILCALL</code>æŒ‡ä»¤åé¢ç´§è·Ÿç€<code>RETURN</code>æŒ‡ä»¤ï¼Œä¸”<code>RETURN</code>æŒ‡ä»¤çš„æ“ä½œæ•°Bä¸º0ï¼Œæ“ä½œæ•°Aè·Ÿ<code>TAILCALL</code>æŒ‡ä»¤ä¸€æ ·ã€‚æ‰€ä»¥<code>_popResults()</code>ä¹‹åï¼Œæˆ‘ä»¬å•¥éƒ½ä¸ç”¨å¹²ï¼Œç›´æ¥æŠŠè¿”å›å€¼ä¿ç•™åœ¨æ ˆä¸Šå³å¯ã€‚</p>
<p>åœ¨<code>vm/inst_call.go</code>æ–‡ä»¶ä¸­ä¿®æ”¹<code>tailCall()</code>å¦‚ä¸‹ï¼š</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// return R(A)(R(A+1), ... ,R(A+B-1))</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">tailCall</span><span class="params">(i Instruction, vm LuaVM)</span></span> &#123;</span><br><span class="line">    a, b, _ := i.ABC()</span><br><span class="line">    a += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    nArgs := _pushFuncAndArgs(a, b, vm)</span><br><span class="line">    vm.TailCall(nArgs)</span><br><span class="line">    _popResults(a, <span class="number">0</span>, vm)</span><br><span class="line">    <span class="comment">// no need to _return() as â€˜bâ€™ of the following â€˜RETURNâ€™ is 0, </span></span><br><span class="line">    <span class="comment">// â€˜aâ€™ of â€˜RETURNâ€™ is same â€˜asâ€™ a of â€˜TAILCALLâ€™</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨<code>state/api_call.go</code>æ–‡ä»¶ä¸­æ·»åŠ <code>TailCall()</code>ä»£ç å¦‚ä¸‹</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// [-(nargs+1), +nresults, e]</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(self *luaState)</span> <span class="title">TailCall</span><span class="params">(nArgs <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">    val := self.stack.get(-(nArgs + <span class="number">1</span>))</span><br><span class="line">    <span class="keyword">if</span> c, ok := val.(*closure); ok &#123;</span><br><span class="line">        fmt.Printf(<span class="string">&quot;tailcall %s&lt;%d,%d&gt;\n&quot;</span>, c.proto.Source,</span><br><span class="line">            c.proto.LineDefined, c.proto.LastLineDefined)</span><br><span class="line">        self.tailCallLuaClosure(nArgs, c)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(<span class="string">&quot;not function!&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç„¶ååœ¨<code>tailCallLuaClosure()</code>ä¸­å®ç°ä¸»è¦é€»è¾‘ã€‚åœ¨<code>state/api_call.go</code>æ–‡ä»¶ä¸­æ·»åŠ <code>tailCallLuaClosure()</code>ä»£ç å¦‚ä¸‹ã€‚</p>
<p>é¦–å…ˆåŒæ ·æ˜¯ä»é—­åŒ…ä¸­è·å–å‡½æ•°åŸå‹çš„ä¿¡æ¯ã€‚å› ä¸ºå½“å‰å¸§åœ¨<code>TAILCALL</code>ä¹‹åè‚¯å®šè·Ÿç€<code>RETURN</code>ï¼Œæ‰€ä»¥ä¿å­˜å‚æ•°ä¹‹åå¯ä»¥ç›´æ¥æ¸…ç†æ‰å½“å‰å¸§çš„æ ˆï¼Œç„¶åç›´æ¥ç»™è¢«è°ƒå‡½æ•°é‡ç”¨ã€‚å°†è¢«è°ƒå‡½æ•°çš„ä¿¡æ¯è®¾ç½®åˆ°å½“å‰å¸§ï¼Œå…ˆæ£€æŸ¥æ ˆç©ºé—´æ˜¯å¦å¤Ÿï¼Œç„¶åå°†å½“å‰å¸§å…³è”åˆ°æ–°çš„é—­åŒ…ï¼Œç„¶åå°†å›ºå®šå‚æ•°æ¨å…¥æ ˆé¡¶ï¼Œä¿®æ”¹æ ˆé¡¶æŒ‡é’ˆæŒ‡å‘æœ€åä¸€ä¸ªå¯„å­˜å™¨ã€‚å¦‚æœæ˜¯varargä¸”å‚æ•°ä¸ªæ•°å¤§äºå›ºå®šå‚æ•°ä¸ªæ•°ï¼Œè¿˜è¦å°†varargå‚æ•°è®°å½•ä¸‹æ¥ã€‚</p>
<p>ä¸€åˆ‡å°±ç»ªä¹‹åï¼Œå°±å¯ä»¥è°ƒç”¨<code>runLuaClosure()</code>å¼€å§‹æ‰§è¡Œé—­åŒ…çš„æŒ‡ä»¤äº†ã€‚æ‰§è¡Œå®Œæ¯•åè¿”å›å€¼ä¿ç•™åœ¨æ ˆé¡¶ã€‚</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(self *luaState)</span> <span class="title">tailCallLuaClosure</span><span class="params">(nArgs <span class="keyword">int</span>, c *closure)</span></span> &#123;</span><br><span class="line">    nRegs := <span class="keyword">int</span>(c.proto.MaxStackSize)</span><br><span class="line">    nParams := <span class="keyword">int</span>(c.proto.NumParams)</span><br><span class="line">    isVararg := c.proto.IsVararg == <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// store args</span></span><br><span class="line">    args := self.stack.popN(nArgs)</span><br><span class="line">    <span class="comment">// clean the stack</span></span><br><span class="line">    self.SetTop(<span class="number">0</span>)    </span><br><span class="line">    <span class="comment">// check if stack space is enough</span></span><br><span class="line">    self.stack.check(nRegs + <span class="number">20</span>)</span><br><span class="line">    <span class="comment">// substitue the closure to new one</span></span><br><span class="line">    self.stack.closure = c</span><br><span class="line">    <span class="comment">// push fixed args</span></span><br><span class="line">    self.stack.pushN(args[<span class="number">1</span>:], nParams)</span><br><span class="line">    self.stack.top = nRegs</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// store varargs</span></span><br><span class="line">    <span class="keyword">if</span> nArgs &gt; nParams &amp;&amp; isVararg &#123;</span><br><span class="line">        self.stack.varargs = args[nParams+<span class="number">1</span>:]</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// run closure</span></span><br><span class="line">    self.runLuaClosure()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="æµ‹è¯•ä»£ç "><a href="#æµ‹è¯•ä»£ç " class="headerlink" title="æµ‹è¯•ä»£ç "></a>æµ‹è¯•ä»£ç </h1><p>æˆ‘ä»¬é‡æ–°ç¼–è¯‘Goä»£ç </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> <span class="variable">$LUAGO</span>/go</span><br><span class="line"><span class="built_in">export</span> GOPATH=<span class="variable">$PWD</span>/ch08</span><br><span class="line"><span class="built_in">export</span> GOBIN=<span class="variable">$PWD</span>/ch08/bin</span><br><span class="line">go install luago</span><br></pre></td></tr></table></figure>

<p>ç„¶åæ¥ç¼–å†™Luaè„šæœ¬ï¼Œæˆ‘ä»¬ç¼–å†™äº†ä¸€ä¸ªæ±‚å’Œçš„å‡½æ•°</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">sum</span><span class="params">(n, s, fun)</span></span></span><br><span class="line">    <span class="keyword">if</span> n == <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span> s</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    s = s + n</span><br><span class="line">    <span class="keyword">return</span> fun(n<span class="number">-1</span>, s, fun)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">assert</span><span class="params">(v)</span></span></span><br><span class="line">  <span class="keyword">if</span> <span class="keyword">not</span> v <span class="keyword">then</span> fail() <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> v1 = sum(<span class="number">0</span>, <span class="number">0</span>, sum)</span><br><span class="line"><span class="built_in">assert</span>(v1 == <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> v2 = sum(<span class="number">1</span>, <span class="number">0</span>, sum)</span><br><span class="line"><span class="built_in">assert</span>(v2 == <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> v3 = sum(<span class="number">3</span>, <span class="number">0</span>, sum)</span><br><span class="line"><span class="built_in">assert</span>(v3 == <span class="number">6</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> v4 = sum(<span class="number">10</span>, <span class="number">0</span>, sum)</span><br><span class="line"><span class="built_in">assert</span>(v4 == <span class="number">55</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> v5 = sum(<span class="number">10000</span>, <span class="number">0</span>, sum)</span><br><span class="line"><span class="built_in">assert</span>(v5 == <span class="number">50005000</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> v6 = sum(<span class="number">1000000</span>, <span class="number">0</span>, sum)</span><br><span class="line"><span class="built_in">assert</span>(v6 == <span class="number">500000500000</span>)</span><br></pre></td></tr></table></figure>

<p>å…ˆæ¥çœ‹çœ‹<code>sum()</code>å‡½æ•°ä¼šè¢«ç¼–è¯‘æˆä»€ä¹ˆæŒ‡ä»¤ã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ luac -l -</span><br><span class="line"><span class="built_in">local</span> <span class="keyword">function</span> sum(n, s, fun)</span><br><span class="line">    <span class="keyword">if</span> n == 0 <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">return</span> s</span><br><span class="line">    end</span><br><span class="line">    s = s + n</span><br><span class="line">    <span class="built_in">return</span> fun(n-1, s, fun)</span><br><span class="line">end</span><br><span class="line">^D</span><br><span class="line">main &lt;stdin:0,0&gt; (2 instructions at 0x7fe071d00070)</span><br><span class="line">0+ params, 2 slots, 1 upvalue, 1 <span class="built_in">local</span>, 0 constants, 1 <span class="keyword">function</span></span><br><span class="line">	1	[7]	CLOSURE  	0 0	; 0x7fe071e00110</span><br><span class="line">	2	[7]	RETURN   	0 1</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> &lt;stdin:1,7&gt; (11 instructions at 0x7fe071e00110)</span><br><span class="line">3 params, 7 slots, 0 upvalues, 3 locals, 2 constants, 0 <span class="built_in">functions</span></span><br><span class="line">	1	[2]	EQ       	0 0 -1	; - 0</span><br><span class="line">	2	[2]	JMP      	0 1	; to 4</span><br><span class="line">	3	[3]	RETURN   	1 2</span><br><span class="line">	4	[5]	ADD      	1 1 0</span><br><span class="line">	5	[6]	MOVE     	3 2</span><br><span class="line">	6	[6]	SUB      	4 0 -2	; - 1</span><br><span class="line">	7	[6]	MOVE     	5 1</span><br><span class="line">	8	[6]	MOVE     	6 2</span><br><span class="line">	9	[6]	TAILCALL 	3 4 0</span><br><span class="line">	10	[6]	RETURN   	3 0</span><br><span class="line">	11	[7]	RETURN   	0 1</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°çš„ç¡®æ˜¯è¢«ç¼–è¯‘æˆäº†<code>TAILCALL</code>ï¼Œåé¢ç´§è·Ÿ<code>RETURN</code>æŒ‡ä»¤ï¼Œä¸”<code>RETURN</code>æŒ‡ä»¤çš„æ“ä½œæ•°Aä¸<code>TAILCALL</code>ç›¸åŒï¼Œæ“ä½œæ•°Bä¸º0ã€‚</p>
<p>æˆ‘ä»¬ç¼–è¯‘Luaè„šæœ¬ï¼Œç„¶åç”¨æˆ‘ä»¬çš„è™šæ‹Ÿæœºè¿›è¡Œæ‰§è¡Œã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">luac ../lua/ch08/tailcall.lua</span><br><span class="line">./ch08/bin/luago  luac.out</span><br><span class="line">call @../lua/ch08/tailcall.lua&lt;0,0&gt;</span><br><span class="line">call @../lua/ch08/tailcall.lua&lt;1,7&gt;</span><br><span class="line">call @../lua/ch08/tailcall.lua&lt;9,11&gt;</span><br><span class="line">call @../lua/ch08/tailcall.lua&lt;1,7&gt;</span><br><span class="line">call @../lua/ch08/tailcall.lua&lt;9,11&gt;</span><br><span class="line">panic: GETTABUP</span><br></pre></td></tr></table></figure>

<p>å“¦å“¦ï¼Œæ‰§è¡Œå¤±è´¥äº†ï¼Œæ®‹å¿µï¼</p>
<p>äºæ˜¯åŠ æ—¥å¿—è¿›è¡Œé—®é¢˜æ’æŸ¥ï¼ŒæŠŠæŒ‡ä»¤æ‰§è¡Œæ—¶çš„æ ˆæ‰“å‡ºæ¥</p>
<div><div class="fold_hider"><div class="close hider_title">ç‚¹å‡»å±•å¼€</div></div><div class="fold">
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">call @../lua/ch08/tailcall.lua&lt;0,0&gt;</span><br><span class="line">CLOSURE  	0 0	[nil][nil][nil][nil][nil][nil][nil]</span><br><span class="line"></span><br><span class="line">CLOSURE  	1 1	[<span class="keyword">function</span>][nil][nil][nil][nil][nil][nil]</span><br><span class="line"></span><br><span class="line">MOVE     	2 0	[<span class="keyword">function</span>][<span class="keyword">function</span>][nil][nil][nil][nil][nil]</span><br><span class="line"></span><br><span class="line">LOADK    	3 -1	[<span class="keyword">function</span>][<span class="keyword">function</span>][<span class="keyword">function</span>][nil][nil][nil][nil]</span><br><span class="line"></span><br><span class="line">LOADK    	4 -1	[<span class="keyword">function</span>][<span class="keyword">function</span>][<span class="keyword">function</span>][0][nil][nil][nil]</span><br><span class="line"></span><br><span class="line">MOVE     	5 0	[<span class="keyword">function</span>][<span class="keyword">function</span>][<span class="keyword">function</span>][0][0][nil][nil]</span><br><span class="line"></span><br><span class="line">CALL     	2 4 2	[<span class="keyword">function</span>][<span class="keyword">function</span>][<span class="keyword">function</span>][0][0][<span class="keyword">function</span>][nil]</span><br><span class="line"></span><br><span class="line">call @../lua/ch08/tailcall.lua&lt;1,7&gt;</span><br><span class="line">EQ       	0 0 -1	[0][0][<span class="keyword">function</span>][nil][nil][nil][nil]</span><br><span class="line"></span><br><span class="line">RETURN   	1 2	[0][0][<span class="keyword">function</span>][nil][nil][nil][nil]</span><br><span class="line"></span><br><span class="line">RETURN   	after 	[0][0][<span class="keyword">function</span>][nil][nil][nil][nil][0]</span><br><span class="line"></span><br><span class="line">CALL     	after 	[<span class="keyword">function</span>][<span class="keyword">function</span>][0][0][0][<span class="keyword">function</span>][nil]</span><br><span class="line"></span><br><span class="line">MOVE     	3 1	[<span class="keyword">function</span>][<span class="keyword">function</span>][0][0][0][<span class="keyword">function</span>][nil]</span><br><span class="line"></span><br><span class="line">EQ       	1 2 -1	[<span class="keyword">function</span>][<span class="keyword">function</span>][0][<span class="keyword">function</span>][0][<span class="keyword">function</span>][nil]</span><br><span class="line"></span><br><span class="line">JMP      	0 1	[<span class="keyword">function</span>][<span class="keyword">function</span>][0][<span class="keyword">function</span>][0][<span class="keyword">function</span>][nil]</span><br><span class="line"></span><br><span class="line">LOADBOOL 	4 1 0	[<span class="keyword">function</span>][<span class="keyword">function</span>][0][<span class="keyword">function</span>][0][<span class="keyword">function</span>][nil]</span><br><span class="line"></span><br><span class="line">CALL     	3 2 1	[<span class="keyword">function</span>][<span class="keyword">function</span>][0][<span class="keyword">function</span>][<span class="literal">true</span>][<span class="keyword">function</span>][nil]</span><br><span class="line"></span><br><span class="line">call @../lua/ch08/tailcall.lua&lt;9,11&gt;</span><br><span class="line">TEST     	0 1	[<span class="literal">true</span>][nil]</span><br><span class="line"></span><br><span class="line">JMP      	0 2	[<span class="literal">true</span>][nil]</span><br><span class="line"></span><br><span class="line">RETURN   	0 1	[<span class="literal">true</span>][nil]</span><br><span class="line"></span><br><span class="line">RETURN   	after 	[<span class="literal">true</span>][nil]</span><br><span class="line"></span><br><span class="line">CALL     	after 	[<span class="keyword">function</span>][<span class="keyword">function</span>][0][<span class="keyword">function</span>][<span class="literal">true</span>][<span class="keyword">function</span>][nil]</span><br><span class="line"></span><br><span class="line">MOVE     	3 0	[<span class="keyword">function</span>][<span class="keyword">function</span>][0][<span class="keyword">function</span>][<span class="literal">true</span>][<span class="keyword">function</span>][nil]</span><br><span class="line"></span><br><span class="line">LOADK    	4 -2	[<span class="keyword">function</span>][<span class="keyword">function</span>][0][<span class="keyword">function</span>][<span class="literal">true</span>][<span class="keyword">function</span>][nil]</span><br><span class="line"></span><br><span class="line">LOADK    	5 -1	[<span class="keyword">function</span>][<span class="keyword">function</span>][0][<span class="keyword">function</span>][1][<span class="keyword">function</span>][nil]</span><br><span class="line"></span><br><span class="line">MOVE     	6 0	[<span class="keyword">function</span>][<span class="keyword">function</span>][0][<span class="keyword">function</span>][1][0][nil]</span><br><span class="line"></span><br><span class="line">CALL     	3 4 2	[<span class="keyword">function</span>][<span class="keyword">function</span>][0][<span class="keyword">function</span>][1][0][<span class="keyword">function</span>]</span><br><span class="line"></span><br><span class="line">call @../lua/ch08/tailcall.lua&lt;1,7&gt;</span><br><span class="line">EQ       	0 0 -1	[1][0][<span class="keyword">function</span>][nil][nil][nil][nil]</span><br><span class="line"></span><br><span class="line">JMP      	0 1	[1][0][<span class="keyword">function</span>][nil][nil][nil][nil]</span><br><span class="line"></span><br><span class="line">ADD      	1 1 0	[1][0][<span class="keyword">function</span>][nil][nil][nil][nil]</span><br><span class="line"></span><br><span class="line">MOVE     	3 2	[1][1][<span class="keyword">function</span>][nil][nil][nil][nil]</span><br><span class="line"></span><br><span class="line">SUB      	4 0 -2	[1][1][<span class="keyword">function</span>][<span class="keyword">function</span>][nil][nil][nil]</span><br><span class="line"></span><br><span class="line">MOVE     	5 1	[1][1][<span class="keyword">function</span>][<span class="keyword">function</span>][0][nil][nil]</span><br><span class="line"></span><br><span class="line">MOVE     	6 2	[1][1][<span class="keyword">function</span>][<span class="keyword">function</span>][0][1][nil]</span><br><span class="line"></span><br><span class="line">TAILCALL 	3 4 0	[1][1][<span class="keyword">function</span>][<span class="keyword">function</span>][0][1][<span class="keyword">function</span>]</span><br><span class="line"></span><br><span class="line">RETURN   	3 0	[1][<span class="keyword">function</span>][nil][nil][nil][nil][nil]</span><br><span class="line"></span><br><span class="line">RETURN   	after 	[1][<span class="keyword">function</span>][nil][nil][nil][nil]</span><br><span class="line"></span><br><span class="line">TAILCALL 	after 	[1][<span class="keyword">function</span>][nil][nil][nil][nil][4]</span><br><span class="line"></span><br><span class="line">RETURN   	0 1	[1][<span class="keyword">function</span>][nil][nil][nil][nil][4]</span><br><span class="line"></span><br><span class="line">RETURN   	after 	[1][<span class="keyword">function</span>][nil][nil][nil][nil][4]</span><br><span class="line"></span><br><span class="line">CALL     	after 	[<span class="keyword">function</span>][<span class="keyword">function</span>][0][nil][1][0][<span class="keyword">function</span>]</span><br><span class="line"></span><br><span class="line">MOVE     	4 1	[<span class="keyword">function</span>][<span class="keyword">function</span>][0][nil][1][0][<span class="keyword">function</span>]</span><br><span class="line"></span><br><span class="line">EQ       	1 3 -2	[<span class="keyword">function</span>][<span class="keyword">function</span>][0][nil][<span class="keyword">function</span>][0][<span class="keyword">function</span>]</span><br><span class="line"></span><br><span class="line">LOADBOOL 	5 0 1	[<span class="keyword">function</span>][<span class="keyword">function</span>][0][nil][<span class="keyword">function</span>][0][<span class="keyword">function</span>]</span><br><span class="line"></span><br><span class="line">CALL     	4 2 1	[<span class="keyword">function</span>][<span class="keyword">function</span>][0][nil][<span class="keyword">function</span>][<span class="literal">false</span>][<span class="keyword">function</span>]</span><br><span class="line"></span><br><span class="line">call @../lua/ch08/tailcall.lua&lt;9,11&gt;</span><br><span class="line">TEST     	0 1	[<span class="literal">false</span>][nil]</span><br><span class="line"></span><br><span class="line">GETTABUP 	1 0 -1	[<span class="literal">false</span>][nil]</span><br><span class="line"></span><br><span class="line">panic: GETTABUP</span><br></pre></td></tr></table></figure>

</div></div>

<p>æˆ‘ä»¬å‘ç°åœ¨<code>TAILCALL</code>å¼€å§‹æ‰§è¡Œä¹‹åç«‹é©¬è°ƒç”¨äº†<code>RETURN</code>ï¼Œé—®é¢˜å°±æ˜¯å‡ºåœ¨è¿™é‡Œï¼Œæˆ‘ä»¬è™½ç„¶æ›¿æ¢äº†å½“å‰å¸§çš„é—­åŒ…ä¸ºè¢«è°ƒå‡½æ•°çš„é—­åŒ…ï¼Œä½†æ˜¯å¿˜äº†æ›´æ–°pcã€‚äºæ˜¯ä¿®æ”¹<code>tailCallLuaClosure()</code>åˆå§‹åŒ–pcä¸º0ã€‚</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(self *luaState)</span> <span class="title">tailCallLuaClosure</span><span class="params">(nArgs <span class="keyword">int</span>, c *closure)</span></span> &#123;</span><br><span class="line">    <span class="comment">// substitue the closure to new one</span></span><br><span class="line">    self.stack.closure = c</span><br><span class="line">    self.stack.pc = <span class="number">0</span> <span class="comment">// add this</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é‡æ–°ç¼–è¯‘ä¹‹åæµ‹è¯•</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ go install luago</span><br><span class="line">$ ./ch08/bin/luago  luac.out</span><br><span class="line">...	<span class="comment"># çœç•¥å‰é¢çš„æ—¥å¿—</span></span><br><span class="line">call @../lua/ch08/tailcall.lua&lt;1,7&gt;</span><br><span class="line">EQ       	0 0 -1	[1][0][<span class="keyword">function</span>][nil][nil][nil][nil]</span><br><span class="line"></span><br><span class="line">JMP      	0 1	[1][0][<span class="keyword">function</span>][nil][nil][nil][nil]</span><br><span class="line"></span><br><span class="line">ADD      	1 1 0	[1][0][<span class="keyword">function</span>][nil][nil][nil][nil]</span><br><span class="line"></span><br><span class="line">MOVE     	3 2	[1][1][<span class="keyword">function</span>][nil][nil][nil][nil]</span><br><span class="line"></span><br><span class="line">SUB      	4 0 -2	[1][1][<span class="keyword">function</span>][<span class="keyword">function</span>][nil][nil][nil]</span><br><span class="line"></span><br><span class="line">MOVE     	5 1	[1][1][<span class="keyword">function</span>][<span class="keyword">function</span>][0][nil][nil]</span><br><span class="line"></span><br><span class="line">MOVE     	6 2	[1][1][<span class="keyword">function</span>][<span class="keyword">function</span>][0][1][nil]</span><br><span class="line"></span><br><span class="line">TAILCALL 	3 4 0	[1][1][<span class="keyword">function</span>][<span class="keyword">function</span>][0][1][<span class="keyword">function</span>]</span><br><span class="line"></span><br><span class="line">EQ       	0 0 -1	[1][<span class="keyword">function</span>][nil][nil][nil][nil][nil]</span><br><span class="line"></span><br><span class="line">JMP      	0 1	[1][<span class="keyword">function</span>][nil][nil][nil][nil][nil]</span><br><span class="line"></span><br><span class="line">ADD      	1 1 0	[1][<span class="keyword">function</span>][nil][nil][nil][nil][nil]</span><br><span class="line"></span><br><span class="line">panic: arithmetic error!</span><br></pre></td></tr></table></figure>

<p>å“¦å“¦ï¼Œåˆæ‰§è¡Œå¤±è´¥äº†ğŸ¤·â€â™‚ï¸ï¼æŸ¥çœ‹æ‰“å°çš„æ ˆä¿¡æ¯ï¼Œ<code>TAILCALL</code>æŒ‡ä»¤æ‰§è¡Œä¹‹å‰æ ˆçš„æƒ…å†µæ˜¯æ­£å¸¸çš„ï¼Œä¸‰ä¸ªå‚æ•°éƒ½å·²ç»æ¨å…¥æ ˆé¡¶<code>[0][1][function]</code>ï¼Œä½†æ˜¯æ‰§è¡Œ<code>EQ</code>æŒ‡ä»¤å‰æ ˆä¸­å´å°‘äº†ä¸€ä¸ªå‚æ•°ï¼Œåªæœ‰<code>[1][function]</code>ã€‚äºæ˜¯æ£€æŸ¥ä»£ç ï¼ŒåŸæ¥æ˜¯æ•°ç»„ç´¢å¼•æé”™äº†ï¼ŒGoçš„èµ·å§‹ç´¢å¼•æ˜¯0ï¼Œè·ŸLuaææ··äº†ğŸ¤·â€â™‚ï¸ã€‚ã€‚ã€‚</p>
<p>ä¿®æ”¹<code>tailCallLuaClosure()</code>å¦‚ä¸‹ä¹‹å</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(self *luaState)</span> <span class="title">tailCallLuaClosure</span><span class="params">(nArgs <span class="keyword">int</span>, c *closure)</span></span> &#123;</span><br><span class="line">    nRegs := <span class="keyword">int</span>(c.proto.MaxStackSize)</span><br><span class="line">    nParams := <span class="keyword">int</span>(c.proto.NumParams)</span><br><span class="line">    isVararg := c.proto.IsVararg == <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// store args</span></span><br><span class="line">    args := self.stack.popN(nArgs)</span><br><span class="line">    <span class="comment">// clean the stack</span></span><br><span class="line">    self.SetTop(<span class="number">0</span>)</span><br><span class="line">    <span class="comment">// check if stack space is enough</span></span><br><span class="line">    self.stack.check(nRegs + <span class="number">20</span>)</span><br><span class="line">    <span class="comment">// substitue the closure to new one</span></span><br><span class="line">    self.stack.closure = c</span><br><span class="line">    self.stack.pc = <span class="number">0</span></span><br><span class="line">    <span class="comment">// push fixed args</span></span><br><span class="line">    self.stack.pushN(args, nParams)</span><br><span class="line">    self.stack.top = nRegs</span><br><span class="line"></span><br><span class="line">    <span class="comment">// store varargs</span></span><br><span class="line">    <span class="keyword">if</span> nArgs &gt; nParams &amp;&amp; isVararg &#123;</span><br><span class="line">        self.stack.varargs = args[nParams:]</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// run closure</span></span><br><span class="line">    self.runLuaClosure()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é‡æ–°ç¼–è¯‘ï¼Œç„¶åç»§ç»­æ‰§è¡Œï¼Œç¨‹åºè¿›å…¥äº†æ­»å¾ªç¯ã€‚ã€‚ã€‚</p>
<div><div class="fold_hider"><div class="close hider_title">ç‚¹å‡»å±•å¼€</div></div><div class="fold">
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ go install luago</span><br><span class="line">$ ./ch08/bin/luago  luac.out</span><br><span class="line">...	<span class="comment"># ç¨‹åºåœä¸ä¸‹æ¥äº†ã€‚ã€‚ã€‚</span></span><br><span class="line">call @../lua/ch08/tailcall.lua&lt;1,7&gt;</span><br><span class="line">EQ          0 0 -1  [1][0][<span class="keyword">function</span>][nil][nil][nil][nil]</span><br><span class="line"></span><br><span class="line">JMP         0 1 [1][0][<span class="keyword">function</span>][nil][nil][nil][nil]</span><br><span class="line"></span><br><span class="line">ADD         1 1 0   [1][0][<span class="keyword">function</span>][nil][nil][nil][nil]</span><br><span class="line"></span><br><span class="line">MOVE        3 2 [1][1][<span class="keyword">function</span>][nil][nil][nil][nil]</span><br><span class="line"></span><br><span class="line">SUB         4 0 -2  [1][1][<span class="keyword">function</span>][<span class="keyword">function</span>][nil][nil][nil]</span><br><span class="line"></span><br><span class="line">MOVE        5 1 [1][1][<span class="keyword">function</span>][<span class="keyword">function</span>][0][nil][nil]</span><br><span class="line"></span><br><span class="line">MOVE        6 2 [1][1][<span class="keyword">function</span>][<span class="keyword">function</span>][0][1][nil]</span><br><span class="line"></span><br><span class="line">TAILCALL    3 4 0   [1][1][<span class="keyword">function</span>][<span class="keyword">function</span>][0][1][<span class="keyword">function</span>]</span><br><span class="line"></span><br><span class="line">EQ          0 0 -1  [0][1][<span class="keyword">function</span>][nil][nil][nil][nil]</span><br><span class="line"></span><br><span class="line">RETURN      1 2 [0][1][<span class="keyword">function</span>][nil][nil][nil][nil]</span><br><span class="line"></span><br><span class="line">RETURN      after   [0][1][<span class="keyword">function</span>][nil][nil][nil][nil][1]</span><br><span class="line"></span><br><span class="line">TAILCALL    after   [0][1][<span class="keyword">function</span>][nil][nil][nil][nil][1][4]</span><br><span class="line"></span><br><span class="line">ADD         1 1 0   [0][1][<span class="keyword">function</span>][nil][nil][nil][nil][1][4]</span><br><span class="line"></span><br><span class="line">MOVE        3 2 [0][1][<span class="keyword">function</span>][nil][nil][nil][nil][1][4]</span><br><span class="line"></span><br><span class="line">SUB         4 0 -2  [0][1][<span class="keyword">function</span>][<span class="keyword">function</span>][nil][nil][nil][1][4]</span><br><span class="line"></span><br><span class="line">MOVE        5 1 [0][1][<span class="keyword">function</span>][<span class="keyword">function</span>][-1][nil][nil][1][4]</span><br><span class="line"></span><br><span class="line">MOVE        6 2 [0][1][<span class="keyword">function</span>][<span class="keyword">function</span>][-1][1][nil][1][4]</span><br><span class="line"></span><br><span class="line">TAILCALL    3 4 0   [0][1][<span class="keyword">function</span>][<span class="keyword">function</span>][-1][1][<span class="keyword">function</span>][1][4]</span><br><span class="line">EQ          0 0 -1  [-1][1][<span class="keyword">function</span>][nil][nil][nil][nil]</span><br><span class="line"></span><br><span class="line">JMP         0 1 [-1][1][<span class="keyword">function</span>][nil][nil][nil][nil]</span><br><span class="line"></span><br><span class="line">ADD         1 1 0   [-1][1][<span class="keyword">function</span>][nil][nil][nil][nil]</span><br><span class="line"></span><br><span class="line">MOVE        3 2 [-1][0][<span class="keyword">function</span>][nil][nil][nil][nil]</span><br><span class="line"></span><br><span class="line">SUB         4 0 -2  [-1][0][<span class="keyword">function</span>][<span class="keyword">function</span>][nil][nil][nil]</span><br><span class="line"></span><br><span class="line">MOVE        5 1 [-1][0][<span class="keyword">function</span>][<span class="keyword">function</span>][-2][nil][nil]</span><br><span class="line"></span><br><span class="line">MOVE        6 2 [-1][0][<span class="keyword">function</span>][<span class="keyword">function</span>][-2][0][nil]</span><br><span class="line"></span><br><span class="line">TAILCALL    3 4 0   [-1][0][<span class="keyword">function</span>][<span class="keyword">function</span>][-2][0][<span class="keyword">function</span>]</span><br><span class="line"></span><br><span class="line">EQ          0 0 -1  [-2][0][<span class="keyword">function</span>][nil][nil][nil][nil]</span><br><span class="line"></span><br><span class="line">JMP         0 1 [-2][0][<span class="keyword">function</span>][nil][nil][nil][nil]</span><br><span class="line"></span><br><span class="line">ADD         1 1 0   [-2][0][<span class="keyword">function</span>][nil][nil][nil][nil]</span><br><span class="line"></span><br><span class="line">MOVE        3 2 [-2][-2][<span class="keyword">function</span>][nil][nil][nil][nil]</span><br><span class="line"></span><br><span class="line">SUB         4 0 -2  [-2][-2][<span class="keyword">function</span>][<span class="keyword">function</span>][nil][nil][nil]</span><br><span class="line"></span><br><span class="line">MOVE        5 1 [-2][-2][<span class="keyword">function</span>][<span class="keyword">function</span>][-3][nil][nil]</span><br><span class="line"></span><br><span class="line">MOVE        6 2 [-2][-2][<span class="keyword">function</span>][<span class="keyword">function</span>][-3][-2][nil]</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

</div></div>

<p>è§‚å¯Ÿåˆ°åœ¨<code>TAILCALL</code>ç»“æŸä¹‹åï¼Œåˆç»§ç»­æ‰§è¡Œ<code>RETURN</code>æŒ‡ä»¤åé¢çš„<code>ADD</code>æŒ‡ä»¤äº†ã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">TAILCALL    3 4 0   [1][1][<span class="keyword">function</span>][<span class="keyword">function</span>][0][1][<span class="keyword">function</span>]</span><br><span class="line"></span><br><span class="line">EQ          0 0 -1  [0][1][<span class="keyword">function</span>][nil][nil][nil][nil]</span><br><span class="line"></span><br><span class="line">RETURN      1 2 [0][1][<span class="keyword">function</span>][nil][nil][nil][nil]</span><br><span class="line"></span><br><span class="line">RETURN      after   [0][1][<span class="keyword">function</span>][nil][nil][nil][nil][1]</span><br><span class="line"></span><br><span class="line">TAILCALL    after   [0][1][<span class="keyword">function</span>][nil][nil][nil][nil][1][4]</span><br><span class="line"></span><br><span class="line">ADD         1 1 0   [0][1][<span class="keyword">function</span>][nil][nil][nil][nil][1][4]</span><br></pre></td></tr></table></figure>

<p>æ­£å¸¸åœ¨æ‰§è¡Œç¬¬3æ¡æŒ‡ä»¤<code>RETURN</code>ä¹‹åå°±åº”è¯¥è¿”å›ä¸Šå±‚äº†</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> &lt;../lua/ch08/tailcall.lua:1,7&gt; (11 instructions at 0x7fd783c03070)</span><br><span class="line">3 params, 7 slots, 0 upvalues, 3 locals, 2 constants, 0 <span class="built_in">functions</span></span><br><span class="line">	1	[2]	EQ       	0 0 -1	; - 0</span><br><span class="line">	2	[2]	JMP      	0 1	; to 4</span><br><span class="line">	3	[3]	RETURN   	1 2</span><br><span class="line">	4	[5]	ADD      	1 1 0</span><br><span class="line">	5	[6]	MOVE     	3 2</span><br><span class="line">	6	[6]	SUB      	4 0 -2	; - 1</span><br><span class="line">	7	[6]	MOVE     	5 1</span><br><span class="line">	8	[6]	MOVE     	6 2</span><br><span class="line">	9	[6]	TAILCALL 	3 4 0</span><br><span class="line">	10	[6]	RETURN   	3 0</span><br><span class="line">	11	[7]	RETURN   	0 1</span><br></pre></td></tr></table></figure>



<p>çŒ›ç„¶æƒ³åˆ°ï¼Œä¹‹å‰æŠŠ<code>RETURN</code>è¯­å¥ç»™ç•¥è¿‡äº†ï¼Œè™½ç„¶åœ¨è¿”å›å€¼çš„å¤„ç†ä¸Šæ˜¯æ²¡æœ‰é—®é¢˜ï¼Œä½†æ˜¯å¤–å±‚å¸§ä¾èµ–<code>RETURN</code>æŒ‡ä»¤æ¥ç»“æŸ</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(self *luaState)</span> <span class="title">runLuaClosure</span><span class="params">()</span></span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> inst.Opcode() == vm.OP_RETURN &#123;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ‰€ä»¥æˆ‘ä»¬ä¿®æ”¹<code>runLuaClosure()</code>ï¼Œä½¿<code>TAILCALL</code>æŒ‡ä»¤æ‰§è¡Œä¹‹åä¹Ÿç»“æŸã€‚</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(self *luaState)</span> <span class="title">runLuaClosure</span><span class="params">()</span></span> &#123;</span><br><span class="line">    ...</span><br><span class="line">	<span class="keyword">if</span> inst.Opcode() == vm.OP_RETURN || inst.Opcode() == vm.OP_TAILCALL &#123;</span><br><span class="line">    	<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿˜æœ‰ä¸€ä¸ªåœ°æ–¹éœ€è¦ä¿®æ”¹ï¼Œå› ä¸ºæˆ‘ä»¬çœç•¥äº†<code>RETURN</code>æŒ‡ä»¤ï¼Œæ‰€ä»¥<code>tailCall()</code>é‡Œçš„<code>_popResults()</code>ä¹Ÿå°±ä¸éœ€è¦äº†ï¼Œå¦åˆ™æ ˆä¸Šä¼šå¤šå‡ºä¸€ä¸ªå€¼ã€‚<code>_popResults()</code>ä¼šæ¨ä¸€ä¸ªæ•´æ•°å€¼ï¼ˆå³aï¼‰åˆ°æ ˆé¡¶æŒ‡ç¤ºè¿”å›å€¼èµ·å§‹çš„å¯„å­˜å™¨ä½ç½®ï¼Œç›¸åº”çš„åœ¨<code>RETURN</code>æŒ‡ä»¤çš„æ—¶å€™ä¼šæŠŠè¿™ä¸ªæ•´æ•°å€¼å¼¹å‡ºã€‚</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// return R(A)(R(A+1), ... ,R(A+B-1))</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">tailCall</span><span class="params">(i Instruction, vm LuaVM)</span></span> &#123;</span><br><span class="line">    a, b, _ := i.ABC()</span><br><span class="line">    a += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// todo: optimize tail call!</span></span><br><span class="line">    nArgs := _pushFuncAndArgs(a, b, vm)</span><br><span class="line">    vm.TailCall(nArgs)</span><br><span class="line">    <span class="comment">// _popResults(a, 0, vm)</span></span><br><span class="line">    <span class="comment">// no need to _return() as â€˜bâ€™ of the following â€˜RETURNâ€™ is 0, </span></span><br><span class="line">    <span class="comment">// â€˜aâ€™ of â€˜RETURNâ€™ is same â€˜asâ€™ a of â€˜TAILCALLâ€™</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>é‡æ–°ç¼–è¯‘æ‰§è¡Œï¼Œè¿™å›ç»ˆäºå¤§åŠŸå‘Šæˆäº†ï¼</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ go install luago</span><br><span class="line">$ ./ch08/bin/luago  luac.out</span><br><span class="line">call @../lua/ch08/tailcall.lua&lt;0,0&gt;</span><br><span class="line">call @../lua/ch08/tailcall.lua&lt;1,7&gt;</span><br><span class="line">call @../lua/ch08/tailcall.lua&lt;9,11&gt;</span><br><span class="line">call @../lua/ch08/tailcall.lua&lt;1,7&gt;</span><br><span class="line">call @../lua/ch08/tailcall.lua&lt;9,11&gt;</span><br><span class="line">call @../lua/ch08/tailcall.lua&lt;1,7&gt;</span><br><span class="line">call @../lua/ch08/tailcall.lua&lt;9,11&gt;</span><br><span class="line">call @../lua/ch08/tailcall.lua&lt;1,7&gt;</span><br><span class="line">call @../lua/ch08/tailcall.lua&lt;9,11&gt;</span><br><span class="line">call @../lua/ch08/tailcall.lua&lt;1,7&gt;</span><br><span class="line">call @../lua/ch08/tailcall.lua&lt;9,11&gt;</span><br><span class="line">call @../lua/ch08/tailcall.lua&lt;1,7&gt;</span><br><span class="line">call @../lua/ch08/tailcall.lua&lt;9,11&gt;</span><br></pre></td></tr></table></figure>



<p>æˆ‘ä»¬å†æ¥è¯•è¯•å¯å˜å‚æ•°çš„æƒ…å†µï¼Œä¿®æ”¹Luaè„šæœ¬å¦‚ä¸‹</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">sum</span><span class="params">(n, s, fun, ...)</span></span></span><br><span class="line">    <span class="keyword">if</span> n == <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span> s</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">local</span> args = &#123;...&#125;</span><br><span class="line">    <span class="keyword">if</span> args[n] <span class="keyword">then</span></span><br><span class="line">        s = s + args[n]</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> fun(n<span class="number">-1</span>, s, fun, ...)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">assert</span><span class="params">(v)</span></span></span><br><span class="line">  <span class="keyword">if</span> <span class="keyword">not</span> v <span class="keyword">then</span> fail() <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> v1 = sum(<span class="number">0</span>, <span class="number">0</span>, sum)</span><br><span class="line"><span class="built_in">assert</span>(v1 == <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> v2 = sum(<span class="number">1</span>, <span class="number">0</span>, sum, <span class="number">1</span>)</span><br><span class="line"><span class="built_in">assert</span>(v2 == <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> v3 = sum(<span class="number">3</span>, <span class="number">0</span>, sum, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>)</span><br><span class="line"><span class="built_in">assert</span>(v3 == <span class="number">6</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> v4 = sum(<span class="number">3</span>, <span class="number">0</span>, sum, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>)</span><br><span class="line"><span class="built_in">assert</span>(v4 == <span class="number">6</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> v3 = sum(<span class="number">3</span>, <span class="number">0</span>, sum, <span class="number">1</span>, <span class="number">2</span>)</span><br><span class="line"><span class="built_in">assert</span>(v3 == <span class="number">3</span>)</span><br></pre></td></tr></table></figure>

<p>ç¼–è¯‘Luaè„šæœ¬ï¼Œæ‰§è¡Œæµ‹è¯•ã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ luac ../lua/ch08/tailcall2.lua</span><br><span class="line">$ ./ch08/bin/luago  luac.out</span><br><span class="line">call @../lua/ch08/tailcall2.lua&lt;0,0&gt;</span><br><span class="line">call @../lua/ch08/tailcall2.lua&lt;1,10&gt;</span><br><span class="line">call @../lua/ch08/tailcall2.lua&lt;12,14&gt;</span><br><span class="line">call @../lua/ch08/tailcall2.lua&lt;1,10&gt;</span><br><span class="line">call @../lua/ch08/tailcall2.lua&lt;12,14&gt;</span><br><span class="line">call @../lua/ch08/tailcall2.lua&lt;1,10&gt;</span><br><span class="line">call @../lua/ch08/tailcall2.lua&lt;12,14&gt;</span><br><span class="line">call @../lua/ch08/tailcall2.lua&lt;1,10&gt;</span><br><span class="line">call @../lua/ch08/tailcall2.lua&lt;12,14&gt;</span><br><span class="line">call @../lua/ch08/tailcall2.lua&lt;1,10&gt;</span><br><span class="line">call @../lua/ch08/tailcall2.lua&lt;12,14&gt;</span><br></pre></td></tr></table></figure>

<p>ä¹Ÿæ²¡æœ‰é—®é¢˜âœŒï¸</p>
]]></content>
      <categories>
        <category>ç¼–ç¨‹å¼€å‘</category>
        <category>Lua</category>
      </categories>
      <tags>
        <tag>Lua</tag>
        <tag>TAILCALL</tag>
      </tags>
  </entry>
  <entry>
    <title>Linuxå†…æ ¸æ˜¯å¦‚ä½•å¯åŠ¨çš„</title>
    <url>/posts/615fc0b5/</url>
    <content><![CDATA[<div class="note primary">
            <p>æœ¬æ–‡ä»‹ç»Linuxå†…æ ¸çš„å¼•å¯¼å¯åŠ¨ä»¥åŠåˆå§‹åŒ–æµç¨‹ï¼Œä»ä½ æŒ‰ä¸‹ç”µæºå¼€å§‹åˆ°ä½ æœ€ç»ˆè¿›è¡Œç»ˆç«¯ç™»å½•ï¼Œè¿™æœŸé—´åˆ°åº•å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ</p>
          </div>

<span id="more"></span>

<div class="note default no-icon">
            <p>æ³¨ï¼šæœ¬æ–‡è®²è¿°çš„å†…å®¹åŸºäºLinux 0.11ï¼Œç›¸å…³å†…æ ¸æºç å¯ä»¥ä»<a href="(http://oldlinux.org)">è¿™é‡Œ</a>ä¸‹è½½ã€‚0.11ç‰ˆæœ¬ä»£ç è¶³å¤Ÿç®€æ´ï¼Œä½†æ˜¯å†…æ ¸åŸºæœ¬åŠŸèƒ½å·²ç»ä¸ç›®å‰ç‰ˆæœ¬è¾ƒä¸ºæ¥è¿‘ï¼Œæ˜¯å­¦ä¹ å†…æ ¸æ•´ä½“è¿ä½œè¿‡ç¨‹çš„ä¸é”™é€‰æ‹©ã€‚</p>
          </div>





<h1 id="å‰ç½®çŸ¥è¯†"><a href="#å‰ç½®çŸ¥è¯†" class="headerlink" title="å‰ç½®çŸ¥è¯†"></a>å‰ç½®çŸ¥è¯†</h1><p>åœ¨é˜…è¯»æœ¬æ–‡ä¹‹å‰ï¼Œå»ºè®®å…ˆå¯¹CPUä¿æŠ¤æ¨¡å¼ã€åˆ†æ®µåˆ†é¡µæœºåˆ¶ã€GDT&#x2F;LDT&#x2F;IDTç­‰æ¦‚å¿µæœ‰æœ€åŸºæœ¬çš„äº†è§£ã€‚è¿™é‡Œä»…åšç®€å•ä»‹ç»ï¼š</p>
<ul>
<li>32ä½<a href="https://in1t.top/2020/03/15/%E4%BF%9D%E6%8A%A4%E6%A8%A1%E5%BC%8F/">ä¿æŠ¤æ¨¡å¼</a>ï¼šæ”¯æŒå¤šä»»åŠ¡ã€æ”¯æŒ4GBç‰©ç†å†…å­˜ã€æ”¯æŒè™šæ‹Ÿå†…å­˜ã€æ”¯æŒåˆ†æ®µå’Œåˆ†é¡µæœºåˆ¶ã€æ”¯æŒç‰¹æƒçº§ã€‚å…·ä½“æä¾›äº†å“ªäº›ä¿æŠ¤æœºåˆ¶å¯ä»¥å‚è€ƒ<a href="https://pdos.csail.mit.edu/6.828/2004/readings/i386/s06_02.htm">80386 Protection Mechanisms</a></li>
<li>åˆ†æ®µåˆ†é¡µæœºåˆ¶ï¼šä¿æŠ¤æ¨¡å¼ä¸‹æä¾›äº†è™šæ‹Ÿå†…å­˜æœºåˆ¶ï¼Œæè¿°ç¬¦ä¸­ä¿å­˜äº†æ®µçš„åŸºå€¼ã€é™é•¿ä»¥åŠä¸€äº›å…¶ä»–çš„ä¿æŠ¤å‚æ•°ã€‚æ¯ä¸ªè¿›ç¨‹éƒ½ä½¿ç”¨ç‹¬ç«‹çš„è™šæ‹Ÿåœ°å€ï¼Œé€šè¿‡æ®µæè¿°ç¬¦çš„åŸºå€å¯ä»¥å¾—åˆ°çº¿æ€§åœ°å€ï¼Œå†æ ¹æ®åˆ†é¡µæœºåˆ¶çš„é¡µç›®å½•ã€é¡µè¡¨å¯ä»¥è½¬åŒ–ä¸ºå®é™…çš„ç‰©ç†åœ°å€ã€‚</li>
<li>GDTï¼šå…¨å±€æè¿°ç¬¦è¡¨ï¼Œå­˜æ”¾å†…æ ¸çš„æ•°æ®æ®µã€ä»£ç æ®µæè¿°ç¬¦ä»¥åŠå„ä¸ªä»»åŠ¡çš„å±€éƒ¨è¡¨å’ŒçŠ¶æ€æ®µæè¿°ç¬¦ã€‚GDTåœ°å€å¯ä»¥é€šè¿‡gdtrå¯„å­˜å™¨å®šä½ã€‚</li>
<li>IDTï¼šä¸­æ–­æè¿°ç¬¦è¡¨ï¼ŒæŒ‡å‡ºå‘ç”Ÿä¸­æ–­æ—¶éœ€è¦è°ƒç”¨çš„ä»£ç ä¿¡æ¯ï¼Œè·Ÿä¸­æ–­å‘é‡è¡¨æœ‰äº›ç±»ä¼¼ï¼Œä½†æ˜¯åŒ…å«æ›´å¤šçš„ä¿¡æ¯ã€‚IDTåœ°å€å¯ä»¥é€šè¿‡idtrå¯„å­˜å™¨å®šä½ã€‚</li>
<li>LDTï¼šä»»åŠ¡çš„å±€éƒ¨æè¿°ç¬¦è¡¨ï¼Œç¬¬0é¡¹ä¸ç”¨ã€ç¬¬1ç¬¬2é¡¹åˆ†åˆ«ä¸ºä»»åŠ¡çš„ä»£ç æ®µå’Œæ•°æ®å †æ ˆæ®µæè¿°ç¬¦ã€‚LDTåœ°å€å¯ä»¥é€šè¿‡ldtrå¯„å­˜å™¨å®šä½ã€‚</li>
<li>TSSï¼šä»»åŠ¡çŠ¶æ€æ®µï¼Œä¸»è¦ä¿å­˜ä¸¤ç±»ä¿¡æ¯ã€‚ä¸€ç±»æ˜¯ä»»åŠ¡åˆ‡æ¢æ—¶æ›´æ–°çš„åŠ¨æ€ä¿¡æ¯ï¼šå¦‚é€šç”¨å¯„å­˜å™¨ã€æ®µå¯„å­˜å™¨ã€EFLAGSã€EIPã€å‰ä¸€ä¸ªæ‰§è¡Œä»»åŠ¡çš„TSSé€‰æ‹©ç¬¦ã€‚ä¸€ç±»æ˜¯é™æ€ä¿¡æ¯çº§ï¼šä»»åŠ¡çš„LDTé€‰æ‹©ç¬¦ã€é¡µç›®å½•åŸºåœ°å€å¯„å­˜å™¨CR3ï¼ˆPDBRï¼‰ã€0ï½2ç‰¹æƒçº§çš„å †æ ˆæŒ‡é’ˆã€è°ƒè¯•è·Ÿè¸ªä½ã€I&#x2F;Oæ¯”ç‰¹ä½å›¾åŸºåœ°å€ã€‚TSSåœ°å€å¯ä»¥é€šè¿‡trå¯„å­˜å™¨å®šä½ã€‚</li>
<li>æè¿°ç¬¦è¡¨é¡¹ï¼š8ä¸ªå­—èŠ‚ï¼ŒåŒ…æ‹¬æ®µçš„æœ€å¤§é•¿åº¦é™åˆ¶ï¼ˆ16ä½ï¼‰ã€æ®µçš„çº¿å½¢åŸºå€ï¼ˆ32ä½ï¼‰ã€æ®µçš„ç‰¹æƒçº§ã€æ®µæ˜¯å¦åœ¨å†…å­˜ã€è¯»å†™æƒé™ä»¥åŠå…¶ä»–ä¸€äº›ä¿æŠ¤æ¨¡å¼è¿è¡Œçš„æ ‡å¿—ã€‚</li>
<li>æ®µé€‰æ‹©ç¬¦ï¼š2ä¸ªå­—èŠ‚ï¼Œä½0ï½1è¡¨ç¤ºè¯·æ±‚çš„ç‰¹æƒçº§ï¼ŒLinuxåªç”¨äº†ä¸¤çº§ï¼Œ0è¡¨ç¤ºç³»ç»Ÿçº§3è¡¨ç¤ºç”¨æˆ·çº§ï¼Œä½2ç”¨äºå…¨å±€(0)æˆ–å±€éƒ¨(1)æè¿°ç¬¦è¡¨ï¼Œä½3ï½15æ˜¯æè¿°ç¬¦è¡¨é¡¹çš„ç´¢å¼•ã€‚</li>
<li>ä¸­æ–­æè¿°ç¬¦è¡¨é¡¹ï¼š8ä¸ªå­—èŠ‚ï¼Œç§°ä¸ºé—¨æè¿°ç¬¦ï¼Œ0ï½1å’Œ6ï½7å­—èŠ‚æ˜¯å¤„ç†ç¨‹åºæ‰€åœ¨æ®µçš„æ®µå†…åç§»é‡ï¼Œ2ï½3å­—èŠ‚æ˜¯å¤„ç†ç¨‹åºæ‰€åœ¨æ®µçš„æ®µé€‰æ‹©ç¬¦ï¼Œ4ï½5Bæ˜¯ä¸€äº›æ ‡å¿—ã€‚åŒ…å«3ç§é—¨æè¿°ç¬¦ï¼šä¸­æ–­é—¨DPLç‰¹æƒçº§ä¸º0ã€å…³ä¸­æ–­ï¼Œé™·é˜±é—¨DPLä¸º0ã€å¼€ä¸­æ–­ï¼Œç³»ç»Ÿé—¨(å…¶å®ä¹Ÿæ˜¯é™·é˜±é—¨)ä¸è¿‡DPLä¸º3ã€å¼€ä¸­æ–­ï¼Œæ‰€ä»¥å¯ä»¥ä»ç”¨æˆ·æ€è°ƒç”¨ã€‚</li>
<li>é¡µè¡¨é¡¹ï¼š4ä¸ªå­—èŠ‚ï¼Œä½0ï½11ä½å­˜æ”¾ä¸€äº›æ ‡å¿—ï¼Œå¦‚ä½0æ˜¯å¦åœ¨å†…å­˜ä¸­ã€ä½1è¯»å†™æ ‡å¿—ä½ã€ä½2æ™®é€šç”¨æˆ·è¿˜æ˜¯è¶…çº§ç”¨æˆ·ã€ä½6æ˜¯å¦è„é¡µï¼Œé«˜12ï½31ä½æ˜¯é¡µæ¡†åœ°å€ã€‚</li>
</ul>
<h1 id="ç£ç›˜å¼•å¯¼-bootsect-s"><a href="#ç£ç›˜å¼•å¯¼-bootsect-s" class="headerlink" title="ç£ç›˜å¼•å¯¼(bootsect.s)"></a>ç£ç›˜å¼•å¯¼(bootsect.s)</h1><ol>
<li><p>å½“è®¡ç®—æœºä¸Šç”µå¯åŠ¨åï¼Œx86çš„CPUå°†è‡ªåŠ¨<strong>è¿›å…¥å®æ¨¡å¼</strong>ï¼Œå¹¶ä»0xffff0åœ°å€å¤„å¼€å§‹æ‰§è¡Œç¨‹åºï¼Œè¿™é‡Œé€šå¸¸æ˜¯ROM-BIOSçš„åœ°å€ï¼ŒBIOSå°†æ‰§è¡Œç¡¬ä»¶ç³»ç»Ÿæ£€æµ‹ï¼Œå¹¶åœ¨ç‰©ç†åœ°å€0å¤„å»ºç«‹ä¸­æ–­å‘é‡è¡¨ï¼Œå³å°†BIOSæä¾›çš„ä¸­æ–­ä¾‹ç¨‹çš„å…¥å£åœ°å€ç™»è®°åœ¨ä¸­æ–­å‘é‡è¡¨ä¸­ã€‚</p>
<p>8086CPUçš„å†…å­˜åœ°å€ç©ºé—´åˆ†é…</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">0x0</span>                    <span class="number">0x9ffff</span> <span class="number">0xa0000</span>     <span class="number">0xbffff</span> <span class="number">0xc0000</span>  <span class="number">0xfffff</span></span><br><span class="line">|ä¸­æ–­å‘é‡è¡¨ ä¸»å‚¨å­˜å™¨åœ°å€ç©ºé—´RAM   |     æ˜¾å­˜åœ°å€ç©ºé—´     | å„ç±»ROMåœ°å€ç©ºé—´ |</span><br></pre></td></tr></table></figure>


</li>
<li><p>éšåBIOSå°†å¯åŠ¨ç›˜çš„ç¬¬ä¸€ä¸ªæ‰‡åŒºï¼ˆå¼•å¯¼å—ï¼ŒLinux0.11å¯¹åº”bootsect.sä»£ç ï¼‰è¯»å…¥å†…å­˜0x7c00å¤„ï¼Œç„¶åè·³è½¬åˆ°é‚£é‡Œç»§ç»­æ‰§è¡Œ</p>
</li>
<li><p>ä»è¿™é‡Œèµ·ï¼Œå†…æ ¸ä¾¿å¼€å§‹æ¥æ‰‹CPUçš„æ§åˆ¶æƒäº†ã€‚å¼•å¯¼å—çš„å¤§å°æ¯•ç«Ÿæœ‰é™ï¼Œæ‰€ä»¥å®ƒå¹²çš„äº‹æƒ…å¾ˆç®€å•ï¼Œå°±æ˜¯å°†å¼•å¯¼å—è‡ªå·±ç§»åˆ°å†…å­˜0x90000å¤„ï¼Œç„¶åå°†å†…æ ¸ç¨‹åºå‰©ä½™çš„éƒ¨åˆ†è¯»åˆ°å†…å­˜ä¸­ã€‚å…¶ä¸­setup.så¯¹åº”çš„4ä¸ªæ‰‡åŒºè¯»åˆ°äº†0x90200å¤„ï¼Œå³ç´§è·Ÿåœ¨å¼•å¯¼å—ä¹‹åã€‚å†…æ ¸ä¸»ä½“éƒ¨åˆ†systemåˆ™è¯»åˆ°0x10000å¤„ï¼Œæ­¤æ—¶å†…å­˜çš„å¸ƒå±€å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">0x0</span>         <span class="number">0x7c00</span>      <span class="number">0x10000</span>            <span class="number">0x90000</span> <span class="number">0x90200</span>      <span class="number">0xa0000</span></span><br><span class="line">|ä¸­æ–­å‘é‡è¡¨| |å¼•å¯¼å—|     |system        |    |å¼•å¯¼å—  |setup.s|   ï½œ    </span><br></pre></td></tr></table></figure>
</li>
<li><p>è¯»å®Œä¹‹åï¼Œä¾¿æ®µé—´è·³è½¬åˆ°0x90200å¤„ï¼Œå¼€å§‹æ‰§è¡Œsetup.sçš„ä»£ç </p>
</li>
</ol>
<h1 id="ç³»ç»Ÿè®¾ç½®-setup-s"><a href="#ç³»ç»Ÿè®¾ç½®-setup-s" class="headerlink" title="ç³»ç»Ÿè®¾ç½®(setup.s)"></a>ç³»ç»Ÿè®¾ç½®(setup.s)</h1><ol>
<li><p>setup.sç¨‹åºçš„ä¸»è¦ä»»åŠ¡æ˜¯åˆ©ç”¨ROM BIOSä¸­æ–­è·å–ç³»ç»Ÿçš„ä¿¡æ¯ï¼Œæ”¾åˆ°å†…å­˜ä¸­åˆé€‚çš„ä½ç½®ï¼ˆ0x90000å¼€å§‹ï¼‰ï¼Œä»¥æä¾›åé¢çš„ä¿æŠ¤æ¨¡å¼ä¸‹çš„æ“ä½œç³»ç»Ÿä½¿ç”¨ã€‚å› ä¸ºä¿æŠ¤æ¨¡å¼ä¸‹ï¼Œæ“ä½œç³»ç»Ÿå°†è‡ªå·±è®¾ç½®ä¸­æ–­æè¿°ç¬¦è¡¨ä»¥å¤„ç†ä¸­æ–­ï¼Œè€Œä¸å†ä½¿ç”¨å®æ¨¡å¼ä¸‹çš„ä¸­æ–­å‘é‡è¡¨ã€‚</p>
</li>
<li><p>è¯»å–çš„ç³»ç»Ÿä¿¡æ¯åŒ…æ‹¬æ˜¾ç¤ºç›¸å…³çš„ã€å†…å­˜ä¿¡æ¯ã€ç¡¬ç›˜ä¿¡æ¯ã€æ ¹æ–‡ä»¶ç³»ç»Ÿè®¾å¤‡å·ç­‰ã€‚è¿™äº›ä¿¡æ¯å°†è¢«å†…æ ¸ç›¸å…³ç¨‹åºä½¿ç”¨ã€‚</p>
</li>
<li><p>æ¥ä¸‹æ¥å°±è¦ä¸ºè¿›å…¥ä¿æŠ¤æ¨¡å¼åšå‡†å¤‡äº†ã€‚<strong>å…³ä¸­æ–­</strong>åï¼Œå°†systemæ¨¡å—ä»0x10000ï½0x8ffffï¼ˆ512KBï¼‰æ•´ä½“ç§»åˆ°0x00000å¤„ã€‚</p>
<p>è¿™é‡Œæœ‰<span class="label primary">ä¸¤ä¸ªé—®é¢˜å€¼å¾—æ€è€ƒ</span>ï¼šä¸ºä»€ä¹ˆå‰é¢bootsect.sä¸­ä¸ç›´æ¥å°†systemè¯»åˆ°0x00000å¤„ï¼Ÿä¸ºä»€ä¹ˆè¿™é‡Œè¦å…³ä¸­æ–­ï¼Ÿ</p>
<p>ç¬¬ä¸€ä¸ªé—®é¢˜æ˜¯å› ä¸ºæˆ‘ä»¬ä»ç£ç›˜è¯»systemæ¨¡å—çš„æ—¶å€™è¿˜æ˜¯éœ€è¦ç”¨åˆ°BIOSçš„ä¸­æ–­ï¼Œæ‰€ä»¥ä¸èƒ½è¦†ç›–ä½äº0x0çš„ä¸­æ–­å‘é‡è¡¨ã€‚</p>
<p>ç¬¬äºŒä¸ªé—®é¢˜åˆ™æ˜¯ç”±äºæˆ‘ä»¬çš„systemæ¨¡å—å³å°†è¦†ç›–ä¸­æ–­å‘é‡è¡¨ï¼Œæ‰€ä»¥å¦‚æœå®æ¨¡å¼å‘ç”Ÿäº†ä¸­æ–­çš„è¯ï¼Œå¾—åˆ°çš„å°†æ˜¯æ— æ•ˆçš„ä¸­æ–­å‘é‡ï¼Œç³»ç»Ÿä¼šå´©æºƒã€‚åŒæ ·åœ°ï¼Œè¿›å…¥ä¿æŠ¤æ¨¡å¼ä¹‹åï¼Œåœ¨æ²¡æœ‰å®Œæˆåˆå§‹åŒ–ä¹‹å‰ï¼Œä¸­æ–­æè¿°ç¬¦é¡¹å¯èƒ½æ˜¯æ— æ•ˆçš„ã€‚</p>
</li>
<li><p>ç„¶åå°±æ˜¯åŠ è½½ä¸­æ–­æè¿°ç¬¦è¡¨å¯„å­˜å™¨(idtr)å’Œå…¨å±€æè¿°ç¬¦è¡¨å¯„å­˜å™¨(gdtr)ï¼Œç„¶åå¼€å¯A20åœ°å€çº¿ï¼Œå¯¹ä¸¤ä¸ªä¸­æ–­æ§åˆ¶èŠ¯ç‰‡8259Aè¿›è¡Œç¼–ç¨‹ï¼Œè®¾ç½®å…¶ä¸­æ–­å·ä¸º0x20-0x2fã€‚</p>
<p>ä¸´æ—¶idtè¡¨åŸºå€0ï¼Œé™é•¿0ï¼Œä¸´æ—¶gdtè¡¨åŸºå€512+gdtï¼Œé™é•¿2048ï¼Œå³256é¡¹ã€‚</p>
</li>
<li><p>æœ€åé€šè¿‡<code>lmsw</code>æŒ‡ä»¤è®¾ç½®CPUçš„æœºå™¨çŠ¶æ€å­—ï¼ˆä¹Ÿç§°æ§åˆ¶å¯„å­˜å™¨CR0ï¼‰ï¼Œä»è€Œ<strong>è¿›å…¥åˆ°ä¿æŠ¤æ¨¡å¼</strong>ï¼Œå¹¶è·³è½¬åˆ°ä»£ç æ®µå¼€å¤´å³systemæ¨¡å—æœ€å¼€å¤´çš„head.sç»§ç»­æ‰§è¡Œã€‚ï¼ˆä¿æŠ¤æ¨¡å¼ä¸‹æ®µå¯„å­˜å™¨çš„å€¼ä¸å†è¡¨ç¤ºæ®µçš„åŸºå€ï¼Œè€Œæ˜¯è¡¨ç¤ºæ®µé€‰æ‹©ç¬¦ã€‚ï¼‰</p>
</li>
</ol>
<p>æ­¤æ—¶å†…å­˜çš„å¸ƒå±€å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">0x0</span>                             <span class="number">0x90000</span> <span class="number">0x90200</span></span><br><span class="line">|head.s|main.c|kernel|mm|lib|...|ç³»ç»Ÿå‚æ•°ï½œsetup.s|ä¸´æ—¶gdt|...|</span><br><span class="line">\----------system-----------/</span><br></pre></td></tr></table></figure>

<p>systemè¢«ç§»åˆ°äº†0x0å¼€å§‹å¤„ï¼Œ0x90000å¤„åˆ™å­˜æ”¾äº†ç³»ç»Ÿä¿¡æ¯(ä¹‹å‰çš„å¼•å¯¼å—bootsect.så·²ç»è¢«è¦†ç›–)ã€‚ä¸´æ—¶gdtä¸­ç¬¬0é¡¹ä¸ç”¨ï¼Œç¬¬1é¡¹æ˜¯ç³»ç»Ÿä»£ç æ®µæè¿°ç¬¦ã€ç¬¬2é¡¹æ˜¯ç³»ç»Ÿæ•°æ®æ®µæè¿°ç¬¦ï¼Œä¸¤è€…çš„åŸºå€éƒ½æ˜¯0ã€‚</p>
<h1 id="å¯åŠ¨ç¨‹åº-head-s"><a href="#å¯åŠ¨ç¨‹åº-head-s" class="headerlink" title="å¯åŠ¨ç¨‹åº(head.s)"></a>å¯åŠ¨ç¨‹åº(head.s)</h1><p>ä»head.så¼€å§‹ï¼Œå†…æ ¸å·²ç»å®Œå…¨å¤„äºä¿æŠ¤æ¨¡å¼ä¸‹è¿è¡Œäº†ã€‚ä¸è¿‡åœ¨å¼€å§‹æ‰§è¡ŒCä»£ç å‰ï¼Œè¿˜éœ€è¦ç”¨æ±‡ç¼–å®Œæˆä¸€äº›ä»»åŠ¡ï¼Œä¸»è¦åŒ…æ‹¬ï¼š</p>
<ol>
<li>é‡æ–°è®¾ç½®å„ä¸ªæ®µå¯„å­˜å™¨ä¸ºå¯¹åº”çš„æ®µé€‰æ‹©ç¬¦ï¼ˆä»£ç æ®µ0x08ï¼Œæ•°æ®æ®µ0x10ï¼‰</li>
<li>è®¾ç½®æ­£å¼ä¸­æ–­æè¿°ç¬¦è¡¨idtï¼Œ256é¡¹ï¼Œåˆå§‹åŒ–æ¯ä¸ªé—¨æè¿°ç¬¦éƒ½æŒ‡å‘ä¸€ä¸ªåªæŠ¥é”™è¯¯çš„å“‘ä¸­æ–­ç¨‹åº</li>
<li>è®¾ç½®æ­£å¼å…¨å±€æè¿°ç¬¦è¡¨gdtï¼Œ256é¡¹ã€‚å…¨å±€è¡¨ç¬¬0é¡¹NULLï¼Œç¬¬1é¡¹ç³»ç»Ÿä»£ç æ®µæè¿°ç¬¦ã€ç¬¬2é¡¹æ˜¯ç³»ç»Ÿæ•°æ®æ®µæè¿°ç¬¦ã€ç¬¬3é¡¹ç³»ç»Ÿæ®µä¸ç”¨ï¼Œåé¢æ˜¯ç•™ç»™å„ä¸ªä»»åŠ¡çš„TSSæè¿°ç¬¦å’ŒLDTæè¿°ç¬¦ã€‚æ¯ä¸ªå±€éƒ¨æè¿°ç¬¦è¡¨LDTå«æœ‰ä¸‰ä¸ªæè¿°ç¬¦ï¼Œç¬¬0ä¸ªä¸ç”¨ã€ç¬¬1ä¸ªæ˜¯ä»»åŠ¡ä»£ç æ®µã€ç¬¬2ä¸ªæ˜¯ä»»åŠ¡æ•°æ®&#x2F;å †æ ˆæ®µã€‚</li>
<li>ç„¶åè®¾ç½®å †æ ˆæ®µä½å†…æ ¸æ•°æ®æ®µ(0x10)ï¼Œå †æ ˆæŒ‡é’ˆespæŒ‡å‘<code>user_stack</code>æ•°ç»„å°¾éƒ¨ï¼Œä¿ç•™äº†4KBç©ºé—´ä½œä¸ºå †æ ˆä½¿ç”¨ã€‚ï¼ˆæ­¤å‰bootsect.sä¸­ä¸´æ—¶ä½¿ç”¨çš„æ ˆé¡¶ä½ç½®åœ¨0x9000:0xff00ã€‚ï¼‰</li>
<li>æ£€æŸ¥A20åœ°å€çº¿æ˜¯å¦çœŸçš„å¼€å¯</li>
<li>æµ‹è¯•æœºå™¨æ˜¯å¦å«æœ‰æ•°å­¦åå¤„ç†å™¨èŠ¯ç‰‡ï¼Œå¹¶è®¾ç½®æ§åˆ¶å¯„å­˜å™¨CR0ä¸­ç›¸åº”æ ‡å¿—ä½ã€‚</li>
<li>æ¥ä¸‹æ¥æ˜¯åˆ†é¡µæœºåˆ¶çš„ç›¸å…³è®¾ç½®ï¼Œå°†ä»0x0å¼€å§‹çš„å‰5é¡µå†…å­˜æ¸…é›¶ï¼Œè®¾ç½®ç¬¬ä¸€é¡µä¸ºé¡µç›®å½•ï¼Œå…¶ä½™4é¡µä¸ºé¡µè¡¨ï¼Œç„¶åå°†é¡µç›®å½•ä¸­çš„å‰4é¡¹ä»¥åŠæ‰€æœ‰é¡µè¡¨é¡¹æŒ‡å‘å¯¹åº”çš„ç‰©ç†å†…å­˜åœ°å€ï¼Œç½®æœ€å3ä½æ ‡å¿—ï¼Œè¡¨ç¤º<strong>è¯¥é¡µå­˜åœ¨ä¸”ç”¨æˆ·å¯è¯»å†™</strong>ã€‚</li>
<li>è®¾ç½®é¡µç›®å½•åŸºå€å¯„å­˜å™¨cr3çš„å€¼ï¼ŒæŒ‡å‘é¡µç›®å½•è¡¨</li>
<li>ç°åœ¨å¯ä»¥å¯åŠ¨åˆ†é¡µæœºåˆ¶äº†ï¼Œæ–¹æ³•å°±æ˜¯é€šè¿‡ç½®æ§åˆ¶å¯„å­˜å™¨cr0çš„ç¬¬31ä½ã€‚</li>
<li>æœ€åé€šè¿‡<code>ret</code>æŒ‡ä»¤å°†äº‹å…ˆå‹æ ˆçš„mainå‡½æ•°å…¥å£åœ°å€å¼¹å‡ºï¼Œå¼€å§‹è¿è¡Œmainå‡½æ•°ã€‚</li>
</ol>
<div class="note default no-icon">
            <p>æ³¨ï¼šLinux 0.11ä¸­ï¼Œæ‰€ä»¥è¿›ç¨‹éƒ½ä½¿ç”¨åŒä¸€ä¸ªé¡µç›®å½•è¡¨ï¼Œä½†éƒ½æœ‰è‡ªå·±çš„é¡µè¡¨ã€‚æœ€å¤šæ”¯æŒ64ä¸ªè¿›ç¨‹ï¼Œæ¯ä¸ªè¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´èŒƒå›´64MBï¼Œé€»è¾‘åœ°å€ä¹˜ä»¥ä»»åŠ¡å·å³å¯è½¬æ¢å¾—åˆ°çº¿æ€§åœ°å€ï¼Œåˆåœ¨ä¸€èµ·æ­£å¥½æ˜¯4GBã€‚ä¸è¿‡åœ¨Linux 0.99ç‰ˆä¹‹åï¼Œæ¯ä¸ªè¿›ç¨‹éƒ½æœ‰è‡ªå·±çš„é¡µç›®å½•ï¼Œå¯ä»¥å•ç‹¬äº«ç”¨4GBçš„è™šæ‹Ÿåœ°å€äº†ã€‚</p>
          </div>

<p>æ­¤æ—¶å†…å­˜å¸ƒå±€å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">0x0</span>                       <span class="number">0x5000</span></span><br><span class="line">|é¡µç›®å½•(<span class="number">4</span>K)|pg0|pg1|pg2|pg3|è½¯ç›˜ç¼“å†²åŒº(<span class="number">1</span>K)|head.séƒ¨åˆ†|idt(<span class="number">2</span>K)|gdt(<span class="number">2</span>K)|main.c|</span><br></pre></td></tr></table></figure>



<h1 id="å†…æ ¸åˆå§‹åŒ–-main-c"><a href="#å†…æ ¸åˆå§‹åŒ–-main-c" class="headerlink" title="å†…æ ¸åˆå§‹åŒ–(main.c)"></a>å†…æ ¸åˆå§‹åŒ–(main.c)</h1><p>è¯¥ç¨‹åºä»£ç ä¸é•¿ï¼Œä½†åŒ…æ‹¬äº†å†…æ ¸åˆå§‹åŒ–çš„æ‰€æœ‰å·¥ä½œï¼Œä¸»è¦çš„åˆå§‹åŒ–æµç¨‹å¦‚ä¸‹ï¼ˆæ­¤æ—¶è¿˜å¤„äºå…³ä¸­æ–­çš„çŠ¶æ€ï¼‰ï¼š</p>
<ol>
<li><p>é¦–å…ˆè®¾ç½®æ ¹æ–‡ä»¶ç³»ç»Ÿè®¾å¤‡å·åŠå†…å­˜å…¨å±€å˜é‡</p>
<p>åˆ©ç”¨setup.sç¨‹åºè·å–çš„ç³»ç»Ÿå‚æ•°è®¾ç½®ç³»ç»Ÿçš„æ ¹æ–‡ä»¶ç³»ç»Ÿè®¾å¤‡å·ä»¥åŠä¸€äº›å†…å­˜å…¨å±€å˜é‡ã€‚è¿™äº›å†…å­˜å…¨å±€å˜é‡æŒ‡æ˜äº†ä¸»å†…å­˜çš„å¼€å§‹åœ°å€ã€ç³»ç»Ÿçš„å†…å­˜å®¹é‡å’Œä½œä¸ºé«˜é€Ÿç¼“å†²åŒºå†…å­˜çš„æœ«ç«¯åœ°å€ã€‚</p>
<p>Linux 0.11å†…æ ¸é»˜è®¤æœ€å¤šæ”¯æŒ16MBç‰©ç†å†…å­˜ï¼Œå…¶åˆ†å¸ƒå¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">  å†…æ ¸æ¨¡å— /    é«˜é€Ÿç¼“å†²åŒº          \ è™šæ‹Ÿç›˜        ä¸»å†…å­˜åŒº</span><br><span class="line">|        |    ï½œæ˜¾å­˜å’ŒBIOS ROM|    |      |                      |</span><br><span class="line"><span class="number">0</span>        end   <span class="number">640</span>K          <span class="number">1</span>MB  <span class="number">4</span>MB    <span class="number">4.5</span>MB                  <span class="number">16</span>MB</span><br></pre></td></tr></table></figure>

<p>é«˜é€Ÿç¼“å†²åŒºè¦æ‰£é™¤æ˜¾å­˜å’ŒBIOS ROMéƒ¨åˆ†ï¼Œå¦‚æœå®šä¹‰äº†è™šæ‹Ÿç›˜(RAMDISK)ï¼Œåˆ™ä¸»å†…å­˜é€‚å½“å‡å°‘ã€‚å†…æ ¸ç¨‹åºå¯ä»¥è‡ªç”±è®¿é—®é«˜é€Ÿç¼“å†²åŒºä¸­çš„æ•°æ®ï¼Œè€Œä¸»å†…å­˜åˆ™ç”±mmæ¨¡å—é€šè¿‡åˆ†é¡µæœºåˆ¶è¿›è¡Œç®¡ç†åˆ†é…ã€‚</p>
</li>
<li><p>æ¥ç€æ˜¯ç³»ç»Ÿå„ä¸ªéƒ¨åˆ†çš„åˆå§‹åŒ–ï¼š</p>
<p>å†…å­˜ã€é™·é˜±é—¨ã€å—è®¾å¤‡ã€å­—ç¬¦è®¾å¤‡ã€ttyã€å¼€æœºå¯åŠ¨æ—¶é—´ã€è°ƒåº¦ç¨‹åºï¼ˆåŠ è½½äº†ä»»åŠ¡0çš„trå’Œldtrã€æ—¶é’Ÿä¸­æ–­é—¨å’Œç³»ç»Ÿè°ƒç”¨ç³»ç»Ÿé—¨ï¼‰ã€ç¼“å†²åŒºã€ç¡¬ç›˜ã€è½¯é©±ã€‚</p>
<ul>
<li>ramdiskè™šæ‹Ÿç›˜ï¼šç¡®å®šrdå¤„ç†å‡½æ•°ã€å†…å­˜èµ·å§‹åœ°å€å’Œé•¿åº¦ï¼Œå¯¹æ•´ä¸ªè™šæ‹Ÿç›˜æ¸…é›¶ã€‚</li>
<li>memå†…å­˜ï¼šåˆå§‹åŒ–mem_mapï¼Œä¸»å†…å­˜é¡µä¸º0ï¼Œå…¶ä½™ä¸ºUSEDã€‚</li>
<li>trapé™·é˜±é—¨ï¼šè®¾ç½®é™·é˜±é—¨å’Œç³»ç»Ÿé—¨ã€‚ï¼ˆé€‰æ‹©ç¬¦0x0008è¡¨ç¤ºç³»ç»Ÿçº§ï¼Œå…¨å±€è¡¨ï¼Œç¬¬2é¡¹ï¼Œå³å†…æ ¸ä»£ç æ®µcsã€‚ï¼‰</li>
<li>blkå—è®¾å¤‡ï¼šåˆå§‹åŒ–è¯·æ±‚é˜Ÿåˆ—</li>
<li>ttyå­—ç¬¦è®¾å¤‡ï¼šåŒ…æ‹¬rs_initå’Œcon_initã€‚rs_initè®¾ç½®ä¸²å£rs1å’Œrs2ä¸­æ–­é—¨ï¼Œåˆå§‹åŒ–ä¸²å£rs1å’Œrs2ï¼ˆrs232ï¼‰ï¼Œå…è®¸ä¸»8259AèŠ¯ç‰‡çš„IRQ3å’ŒIRQ4ã€‚con_initåˆå§‹åŒ–æ§åˆ¶å°ä¸­æ–­ï¼Œè¯»å–setup.sä¿å­˜çš„ä¿¡æ¯ï¼Œç¡®å®šå½“å‰æ˜¾ç¤ºå™¨ç±»å‹å¹¶è®¾ç½®æ‰€æœ‰ç›¸å…³å‚æ•°ã€‚è®¾ç½®é”®ç›˜ä¸­æ–­é™·é˜±é—¨ï¼Œå¤ä½é”®ç›˜ã€‚</li>
<li>timeæ—¶é—´ï¼šä»CMOSè¯»å–æ—¶é—´ï¼Œåˆå§‹åŒ–å¯åŠ¨æ—¶é—´startup_time</li>
<li>schedè°ƒåº¦ï¼šè®¾ç½®GDTä¸­task0çš„tsså’Œldtæè¿°ç¬¦ï¼ˆinit_taskå·²ç»é™æ€è®¾ç½®å¥½ï¼‰ï¼Œæ¸…ä»»åŠ¡æ•°ç»„åŠå…¶åœ¨GDTä¸­çš„æè¿°ç¬¦è¡¨é¡¹ï¼Œæ¸…æ ‡å¿—å¯„å­˜å™¨NTä½ï¼ˆiretæ—¶ä¸è¿›è¡Œä»»åŠ¡åˆ‡æ¢ï¼‰ï¼Œå°†ä»»åŠ¡0çš„TSSåŠ è½½åˆ°ä»»åŠ¡å¯„å­˜å™¨trï¼Œå°†GDTä¸­ä»»åŠ¡0çš„ldtæè¿°ç¬¦çš„é€‰æ‹©ç¬¦åŠ è½½åˆ°ldtrï¼ˆä»…æ˜¾å¼åŠ è½½è¿™ä¸€æ¬¡ï¼Œåç»­ä»»åŠ¡CPUæ ¹æ®TSSä¸­çš„LDTé¡¹è‡ªåŠ¨åŠ è½½ï¼‰ã€‚åˆå§‹åŒ–8253å®šæ—¶å™¨ï¼Œè®¾ç½®å®šæ—¶å™¨ä¸­æ–­é—¨ï¼Œè®¾ç½®ç³»ç»Ÿè°ƒç”¨ç³»ç»Ÿé—¨ã€‚</li>
<li>bufferé«˜é€Ÿç¼“å†²åŒºï¼šåˆå§‹åŒ–é«˜é€Ÿç¼“å†²åŒºï¼Œå‰é¢ç¼“å†²åŒºä½ç«¯æ˜¯ç¼“å†²å¤´ç»“æ„ï¼Œé«˜ç«¯æ˜¯ç¼“å†²å—ï¼ˆæ¯ä¸ª1KBï¼‰ï¼Œç¬¬ä¸€ä¸ªç¼“å†²å¤´æŒ‡å‘æœ€åä¸€ä¸ªç¼“å†²å—ã€‚ç©ºé—²é“¾è¡¨å¤´æŒ‡å‘ç¬¬ä¸€ä¸ªç¼“å†²åŒºå¤´ï¼Œç¬¬ä¸€ä¸ªç¼“å†²åŒºå¤´å’Œæœ€åä¸€ä¸ªç›¸è¿å½¢æˆç¯é“¾ã€‚åˆå§‹åŒ–hashè¡¨ä¸ºç©ºã€‚</li>
<li>hdç¡¬ç›˜ï¼šè®¾ç½®ç¡¬ç›˜è¯·æ±‚å¤„ç†å‡½æ•°ã€ä¸­æ–­é—¨ï¼Œå…è®¸ç¡¬ç›˜æ§åˆ¶å™¨å‘é€ä¸­æ–­è¯·æ±‚ä¿¡å·ã€‚</li>
<li>floppyè½¯é©±ï¼šè®¾ç½®è½¯ç›˜è¯·æ±‚å¤„ç†å‡½æ•°ã€ä¸­æ–­é—¨ï¼Œå…è®¸è½¯ç›˜æ§åˆ¶å™¨å‘é€ä¸­æ–­è¯·æ±‚ä¿¡å·ã€‚</li>
</ul>
</li>
<li><p>OKï¼Œæ‰€æœ‰åˆå§‹åŒ–å·¥ä½œå®Œæ¯•ï¼Œ<strong>å¼€ä¸­æ–­</strong>ã€‚ï¼ˆä»setup.sä¸­ç§»åŠ¨systemæ¨¡å—å‰å¼€å§‹ä¸€ç›´åˆ°è¿™é‡Œä¸ºæ­¢éƒ½æ˜¯å…³ä¸­æ–­çš„ï¼‰</p>
</li>
<li><p>æ¥ä¸‹æ¥è¦å˜é­”æœ¯äº†ï¼Œ<code>move_to_user_mode()</code>å®Œæˆä¸¤ä¸ªé‡è¦çš„å†å²ä»»åŠ¡ï¼šä¸€æ˜¯<strong>å¯åŠ¨ç¬¬ä¸€ä¸ªä»»åŠ¡ï¼ˆè¿›ç¨‹0ï¼‰</strong>ï¼ŒäºŒæ˜¯<strong>å°†ç‰¹æƒçº§åˆ‡æ¢åˆ°ç”¨æˆ·æ€</strong>ï¼ˆæ­¤å‰ä¸€ç›´æ˜¯å·¥ä½œåœ¨å†…æ ¸æ€ï¼‰</p>
<p>æˆ‘ä»¬æ¥çœ‹ä¸‹è¿™æ®µå…³é”®çš„ä»£ç ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> move_to_user_mode() \</span></span><br><span class="line"><span class="meta">__asm__ (<span class="meta-string">&quot;movl %%esp,%%eax\n\t&quot;</span> \</span></span><br><span class="line"><span class="meta">    <span class="meta-string">&quot;pushl $0x17\n\t&quot;</span> \</span></span><br><span class="line"><span class="meta">    <span class="meta-string">&quot;pushl %%eax\n\t&quot;</span> \</span></span><br><span class="line"><span class="meta">    <span class="meta-string">&quot;pushfl\n\t&quot;</span> \</span></span><br><span class="line"><span class="meta">    <span class="meta-string">&quot;pushl $0x0f\n\t&quot;</span> \</span></span><br><span class="line"><span class="meta">    <span class="meta-string">&quot;pushl $1f\n\t&quot;</span> \</span></span><br><span class="line"><span class="meta">    <span class="meta-string">&quot;iret\n&quot;</span> \</span></span><br><span class="line"><span class="meta">    <span class="meta-string">&quot;1:\tmovl $0x17,%%eax\n\t&quot;</span> \</span></span><br><span class="line"><span class="meta">    <span class="meta-string">&quot;movw %%ax,%%ds\n\t&quot;</span> \</span></span><br><span class="line"><span class="meta">    <span class="meta-string">&quot;movw %%ax,%%es\n\t&quot;</span> \</span></span><br><span class="line"><span class="meta">    <span class="meta-string">&quot;movw %%ax,%%fs\n\t&quot;</span> \</span></span><br><span class="line"><span class="meta">    <span class="meta-string">&quot;movw %%ax,%%gs&quot;</span> \</span></span><br><span class="line"><span class="meta">    :::<span class="meta-string">&quot;ax&quot;</span>)</span></span><br></pre></td></tr></table></figure>

<p>å‰é¢å‡ æ¡æŒ‡ä»¤æ˜¯æ‰‹åŠ¨æ¨¡æ‹Ÿä¸­æ–­è¿‡ç¨‹çš„å †æ ˆæƒ…å†µï¼Œæˆ‘ä»¬æ¥é€æ¡è§£é‡Šä¸€ä¸‹ï¼š</p>
<ol>
<li>ä¿å­˜å †æ ˆæŒ‡é’ˆespåˆ°eax</li>
<li>å°†task0å †æ ˆæ®µé€‰æ‹©ç¬¦(0x17)å…¥æ ˆï¼ˆæ­¤å‰ssæ˜¯0x10ï¼‰</li>
<li>å°†eaxä¸­çš„å †æ ˆæŒ‡é’ˆå€¼å…¥æ ˆ</li>
<li>å°†æ ‡å¿—å¯„å­˜å™¨å…¥æ ˆ</li>
<li>å°†task0ä»£ç æ®µé€‰æ‹©ç¬¦(0x0f)å…¥æ ˆï¼ˆæ­¤å‰csæ˜¯0x08ï¼‰</li>
<li>å°†æ ‡å·1çš„åç§»åœ°å€å…¥æ ˆ</li>
<li>æ¥ä¸‹æ¥æ‰§è¡Œ<code>iret</code>ï¼Œè¿™æ˜¯ä¸€ä¸ªæ ‡å¿—æ€§çš„æ—¶åˆ»ã€‚åç§»åœ°å€ã€ä»£ç æ®µé€‰æ‹©ç¬¦ã€æ ‡å¿—å¯„å­˜å™¨å‡ºæ ˆï¼Œæ¥ä¸‹æ¥è·³åˆ°task0ä¸­æ‰§è¡Œäº†ã€‚ç”±äºä»»åŠ¡0çš„æè¿°ç¬¦ç‰¹æƒçº§æ˜¯3ï¼ˆå³ç”¨æˆ·æ€ï¼‰ï¼Œæ‰€ä»¥ä¹‹å‰å…¥æ ˆçš„å †æ ˆæŒ‡é’ˆå’Œå †æ ˆæ®µé€‰æ‹©ç¬¦ä¹Ÿè¢«å¼¹å‡ºï¼Œä¹Ÿå³æ¢å¤ä¹‹å‰å†…æ ¸å †æ ˆã€‚è¿™æ ·å°±å®Œæˆäº†ä»»åŠ¡0çš„äººå·¥å¯åŠ¨ï¼Œå®ƒæ˜¯æ‰€æœ‰è¿›ç¨‹çš„ç¥–å…ˆï¼Œä½†æ˜¯å®ƒæ¯”è¾ƒç‰¹æ®Šï¼Œå®ƒçš„æ•°æ®æ®µå’Œä»£ç æ®µç›´æ¥æ˜ å°„åˆ°å†…æ ¸ä»£ç å’Œæ•°æ®ç©ºé—´ï¼Œä¹Ÿå³ä»0å¼€å§‹ï¼Œé™é•¿640KBã€‚å…¶å†…æ ¸æ€å †æ ˆä½äºå…¶taskæ•°æ®ç»“æ„æ‰€åœ¨é¡µé¢çš„æœ«ç«¯ï¼Œå†…æ ¸æ€å †æ ˆæŒ‡é’ˆæ˜¯åœ¨å…¶åˆå§‹åŒ–ä»»åŠ¡æ•°æ®ç»“æ„ä¸­äººå·¥è®¾ç½®çš„ã€‚è€Œå®ƒçš„ç”¨æˆ·æ€å †æ ˆå°±æ˜¯æœ€å‰é¢ä¸¤æ¡æŒ‡ä»¤è®¾ç½®çš„ï¼Œespä»ç„¶æŒ‡å‘åŸæ¥çš„ä½ç½®ï¼Œä½†æ˜¯sså·²ç»å˜æˆ0x17ï¼Œå³ç”¨æˆ·æ€å±€éƒ¨è¡¨ä¸­çš„æ•°æ®æ®µã€‚</li>
<li>æ¥ä¸‹æ¥4ä¸ªæŒ‡ä»¤éƒ½æ˜¯è®¾ç½®æ®µå¯„å­˜å™¨ï¼ŒæŒ‡å‘å±€éƒ¨è¡¨çš„æ•°æ®æ®µã€‚å…¶ä¸­0x17æ˜¯task0çš„æ•°æ®&#x2F;å †æ ˆæ®µé€‰æ‹©ç¬¦ï¼Œ00010111æœ€åä¸¤ä½è¡¨ç¤ºç‰¹æƒçº§ä¸º3ï¼Œä½2è¡¨ç¤ºå±€éƒ¨è¡¨ï¼Œé«˜15ä½è¡¨ç¤ºç´¢å¼•ï¼Œå±€éƒ¨è¡¨çš„ç¬¬2é¡¹æ˜¯æ•°æ®æ®µå’Œå †æ ˆæ®µæè¿°ç¬¦ï¼ˆ0ä¸ç”¨ï¼Œ1æ˜¯ä»£ç æ®µï¼‰ã€‚ç±»ä¼¼åœ°ï¼Œ0x0fæ˜¯ä»£ç æ®µé€‰æ‹©ç¬¦ã€‚</li>
</ol>
</li>
<li><p>ä»»åŠ¡0è‡ªå·±çš„äº‹æƒ…å·²ç»å®‰é¡¿å¥½äº†ï¼Œæ¥ä¸‹æ¥è‡ªç„¶å°±æ˜¯å¼€å§‹é€ å­©å­äº†ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (!fork()) &#123;      <span class="comment">/* we count on this going ok */</span></span><br><span class="line">    init();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span>(;;) pause();</span><br></pre></td></tr></table></figure>

<p>è¿™æ˜¯mainå‡½æ•°çš„æœ€åå‡ è¡Œä»£ç ï¼Œforkäº†ä¸€ä¸ªå­è¿›ç¨‹ï¼ˆå³<strong>è¿›ç¨‹1</strong>ï¼‰æ‰§è¡Œ<code>init()</code>ï¼Œè¿›ç¨‹0åˆ™å¾ªç¯æ‰§è¡Œ<code>pause()</code>ã€‚æ¯å½“ç³»ç»Ÿæ²¡æœ‰å…¶ä»–å¯æ‰§è¡Œçš„è¿›ç¨‹æ—¶å°±ä¼šæ‰§è¡Œè¿›ç¨‹0ã€‚</p>
<span class="label primary">å€¼å¾—ä¸€æçš„æ˜¯</span>ï¼Œä¸ºäº†ç¡®ä¿forkåˆ›å»ºçš„æ–°è¿›ç¨‹æ²¡æœ‰è¿›ç¨‹0çš„å¤šä½™ä¿¡æ¯ï¼Œè¦æ±‚è¿›ç¨‹0åœ¨åˆ›å»ºç¬¬ä¸€ä¸ªæ–°è¿›ç¨‹ä¹‹å‰ä¸è¦ä½¿ç”¨ç”¨æˆ·æ€å †æ ˆï¼Œå³è¦æ±‚è¿›ç¨‹0ä¸èƒ½è°ƒç”¨å‡½æ•°ï¼Œæ‰€ä»¥è¿™é‡Œ`fork()`å’Œ`pause()`æ˜¯é‡‡ç”¨gccå‡½æ•°å†…åµŒçš„å½¢å¼æ¥æ‰§è¡Œçš„ã€‚
</li>
<li><p>æœ€åæˆ‘ä»¬æ¥çœ‹ä¸‹è¿›ç¨‹1æ‰§è¡Œçš„<code>init()</code>å‡½æ•°</p>
<ol>
<li>å®ƒé¦–å…ˆæ‰§è¡Œ<code>setup()</code>å‡½æ•°ï¼Œä¸»è¦æ˜¯åˆå§‹åŒ–ç¡¬ç›˜åˆ†åŒºï¼Œæœ€åæ‰§è¡Œ<code>mount_root()</code>å®‰è£…æ ¹æ–‡ä»¶ç³»ç»Ÿï¼šåˆå§‹åŒ–è¶…çº§å—æ•°ç»„ï¼Œè¯»å–æ ¹è®¾å¤‡ä¸Šçš„è¶…çº§å—å’Œæ ¹ièŠ‚ç‚¹ç»“æ„ä¿¡æ¯ï¼Œè®¾ç½®æ ¹ièŠ‚ç‚¹å¼•ç”¨æ¬¡æ•°ï¼Œå¹¶ä½œä¸ºè¿›ç¨‹1çš„å½“å‰å·¥ä½œç›®å½•pwdå’Œæ ¹ç›®å½•rootçš„ièŠ‚ç‚¹ã€‚æ ¹æ®é€»è¾‘å—ä½å›¾ç»Ÿè®¡ç©ºé—²å—æ•°å¹¶æ˜¾ç¤ºï¼Œæ ¹æ®ièŠ‚ç‚¹ä½å›¾ç»Ÿè®¡ç©ºé—²ièŠ‚ç‚¹æ•°å¹¶æ˜¾ç¤ºã€‚</li>
<li>è¯»å†™æ‰“å¼€ç»ˆç«¯æ§åˆ¶å°<code>/dev/tty0</code>ï¼Œæ–‡ä»¶å¥æŸ„ä¸º0ï¼Œå¹¶å¤åˆ¶äº§ç”Ÿå¥æŸ„1å’Œ2</li>
<li>æ¥ä¸‹æ¥forkå‡ºè¿›ç¨‹2ï¼Œç”¨<code>/bin/sh</code>ç¨‹åºæ‰§è¡Œ<code>/etc/rc</code>è„šæœ¬</li>
<li>å¦‚æœè¿›ç¨‹2æ‰§è¡Œå¤±è´¥æˆ–æ‰§è¡Œç»“æŸï¼Œåˆ™è¿›å…¥ä¸€ä¸ªå¤§çš„æ­»å¾ªç¯ï¼šåˆ›å»ºæ–°è¿›ç¨‹ã€å…³é—­é—ç•™å¥æŸ„ã€åˆ›å»ºä¸€ä¸ªä¼šè¯å¹¶è®¾ç½®è¿›ç¨‹ç»„å·ã€å¥æŸ„0&#x2F;1&#x2F;2éƒ½è¯»å†™æ‰“å¼€ç»ˆç«¯æ§åˆ¶å°<code>/dev/tty0</code>ã€æœ€å<code>execve()</code>æ‰§è¡Œ<code>/bin/sh</code>ç¨‹åºã€‚æ­¤æ—¶ç”¨æˆ·ä¾¿å¯ä»¥å¼€å§‹æ“ä½œç»ˆç«¯äº†ã€‚</li>
</ol>
</li>
</ol>
<h1 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h1><ul>
<li>ã€ŠLinux å†…æ ¸å®Œå…¨æ³¨é‡Šâ€” èµµç‚¯ã€‹</li>
<li>ã€Šæ±‡ç¼–è¯­è¨€â€”ç‹çˆ½ã€‹</li>
</ul>
]]></content>
      <categories>
        <category>æ“ä½œç³»ç»Ÿ</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>å†…æ ¸</tag>
      </tags>
  </entry>
  <entry>
    <title>Luaä¸­å¦‚ä½•å®ç°ç±»ä¼¼gdbçš„æ–­ç‚¹è°ƒè¯•â€”08æ”¯æŒé€šè¿‡åŒ…åç§°æ·»åŠ æ–­ç‚¹</title>
    <url>/posts/5c25711/</url>
    <content><![CDATA[<div class="note primary">
            <p>åœ¨å‰ä¸€ç¯‡ä¸­æˆ‘ä»¬æ”¯æŒäº†é€šè¿‡å‡½æ•°åç§°æ¥æ·»åŠ æ–­ç‚¹ï¼Œæˆ‘ä»¬åŒæ—¶ä¹Ÿæåˆ°äº†åœ¨Luaä¸­ä¸€ä¸ªå‡½æ•°çš„åç§°çš„å¹¶ä¸æ˜¯ç¡®å®šçš„ã€‚å‡†ç¡®çš„è¯´ï¼ŒLuaä¸­çš„å‡½æ•°å¹¶æ²¡æœ‰åç§°ï¼Œæ‰€è°“åç§°å…¶å®æ˜¯ä¿å­˜è¿™ä¸ªå‡½æ•°å€¼çš„å˜é‡çš„åç§°ã€‚</p><p>äºæ˜¯é€šè¿‡å‡½æ•°åç§°æ·»åŠ æ–­ç‚¹å°±é€ æˆäº†ä¸€å®šçš„ä¸ç¡®å®šæ€§ï¼Œå› ä¸ºå‡½æ•°è¢«è°ƒç”¨æ—¶å¹¶ä¸ä¸€å®šæ˜¯ä»¥è¿™ä¸ªåå­—è¢«è°ƒç”¨çš„ã€‚å¦å¤–ï¼Œå¤šä¸ªä¸åŒçš„å‡½æ•°ä¹Ÿå¯èƒ½ä»¥ç›¸åŒçš„åå­—è¿›è¡Œè°ƒç”¨ã€‚</p><p>æ‰€ä»¥ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæœ¬ç¯‡æˆ‘ä»¬å°†ç»§ç»­æ‰©å±•æ–­ç‚¹çš„è®¾ç½®æ¥å£ï¼Œæ”¯æŒé€šè¿‡åŒ…åæ¥æ·»åŠ æ–­ç‚¹ã€‚å› ä¸ºåŒ…åç›¸å¯¹æ›´å…·ç¡®å®šæ€§ï¼Œé…åˆè¡Œå·å¯ä»¥è¿›è¡Œç²¾ç¡®å®šä½ã€‚</p>
          </div>

<span id="more"></span>

<p>æºç å·²ç»ä¸Šä¼ <a href="https://github.com/catbro666/lua-debugger">Github</a>ï¼Œæ¬¢è¿watch&#x2F;starğŸ˜˜ã€‚</p>
<h2 id="å®ç°åˆ†æ"><a href="#å®ç°åˆ†æ" class="headerlink" title="å®ç°åˆ†æ"></a>å®ç°åˆ†æ</h2><h3 id="ä¸ºä½•é€‰ç”¨åŒ…åçš„æ–¹å¼"><a href="#ä¸ºä½•é€‰ç”¨åŒ…åçš„æ–¹å¼" class="headerlink" title="ä¸ºä½•é€‰ç”¨åŒ…åçš„æ–¹å¼"></a>ä¸ºä½•é€‰ç”¨åŒ…åçš„æ–¹å¼</h3><p>å…¶å®ä¸€å¼€å§‹çš„æƒ³æ³•å¹¶ä¸æ˜¯é€šè¿‡åŒ…åæ¥æ·»åŠ æ–­ç‚¹ï¼Œè€Œæ˜¯é€šè¿‡æºæ–‡ä»¶åã€‚ä½†æ˜¯æºæ–‡ä»¶ååŒæ ·å­˜åœ¨é‡å¤çš„å¯èƒ½ï¼Œæˆ‘ä»¬åªèƒ½è€ƒè™‘ä½¿ç”¨ç±»ä¼¼åç¼€åŒ¹é…è¿™ç§æ¨¡ç³Šçš„æ–¹å¼è¿›è¡ŒæŸ¥æ‰¾ã€‚è¿™æ ·çš„è¯ï¼Œæ¯ä¸ªcalläº‹ä»¶ä¸­éƒ½éœ€è¦å¯¹é€šè¿‡æºæ–‡ä»¶åè®¾ç½®çš„æ–­ç‚¹è¡¨è¿›è¡Œéå†ã€‚</p>
<p>ä½¿ç”¨ç»å¯¹è·¯å¾„è™½ç„¶å¯ä»¥è§£å†³é‡å¤çš„é—®é¢˜ï¼Œä½†æ˜¯ä½¿ç”¨ä¸Šä¸æ–¹ä¾¿ï¼Œåœ¨æ·»åŠ æ–­ç‚¹çš„æ—¶å€™ä¹Ÿä¸ä¸€å®šçŸ¥é“æºæ–‡ä»¶çš„å…·ä½“ä½ç½®ï¼Œå†µä¸”<code>short_src</code>ä¹Ÿä¸ä¸€å®šæ˜¯ç»å¯¹è·¯å¾„ã€‚</p>
<p>æ‰€ä»¥å‡ºäºæ€§èƒ½åŠæ˜“ç”¨æ€§çš„è€ƒè™‘ï¼Œé‡‡ç”¨äº†é€šè¿‡åŒ…åæ¥è®¾ç½®æ–­ç‚¹çš„æ–¹å¼ï¼Œè¿™æ ·å°±å¯ä»¥åˆ©ç”¨Luaæœ¬èº«çš„åŒ…åæœç´¢æœºåˆ¶ï¼Œä½¿ç”¨æœç´¢åŒ…è·¯å¾„çš„æ–¹æ³•<code>package.searchpackage()</code>å°†åŒ…åè½¬æˆè·¯å¾„ã€‚è€Œè¿™ä¸ªè·¯å¾„å°±æ˜¯<code>debug.getinfo</code>è·å–åˆ°çš„è°ƒè¯•ä¿¡æ¯ä¸­çš„<code>short_src</code>ã€‚</p>
<p>ä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­ï¼š</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="built_in">package</span>.searchpath( <span class="string">&quot;foo.bar.baz&quot;</span>, <span class="built_in">package</span>.<span class="built_in">path</span> )</span><br><span class="line"><span class="comment">--&gt; (e.g.) &quot;/usr/share/lua/5.3/foo/bar/baz.lua&quot;</span></span><br></pre></td></tr></table></figure>



<h3 id="æ–­ç‚¹çš„ä¿å­˜è§£æå’ŒæŸ¥æ‰¾"><a href="#æ–­ç‚¹çš„ä¿å­˜è§£æå’ŒæŸ¥æ‰¾" class="headerlink" title="æ–­ç‚¹çš„ä¿å­˜è§£æå’ŒæŸ¥æ‰¾"></a>æ–­ç‚¹çš„ä¿å­˜è§£æå’ŒæŸ¥æ‰¾</h3><p>è·Ÿä¸Šä¸€ç¯‡ä¸­é€šè¿‡å‡½æ•°åç§°æ·»åŠ çš„æ–­ç‚¹ä¸åŒçš„æ˜¯ï¼Œé€šè¿‡åŒ…åæ·»åŠ çš„æ–­ç‚¹éƒ½æ˜¯ç¡®å®šçš„ï¼Œæ‰€ä»¥æœ€ç»ˆéƒ½å¯ä»¥å°†å…¶è½¬æ¢ä¸ºå‡½æ•°çš„æ–­ç‚¹ã€‚ä½†æ˜¯åªæœ‰å½“æ‰§è¡Œè¿‡è¯¥å‡½æ•°ä¹‹åï¼Œæˆ‘ä»¬æ‰èƒ½è·å–åˆ°è¯¥å‡½æ•°çš„ç›¸å…³ä¿¡æ¯ï¼Œè¿›è¡Œæ–­ç‚¹çš„è½¬æ¢ï¼Œæ‰€ä»¥åœ¨æ­¤ä¹‹å‰æˆ‘ä»¬éœ€è¦å°†å®ƒä»¬ä¸´æ—¶å­˜æ”¾åœ¨ä¸€ä¸ªè¡¨ä¸­ï¼Œè·Ÿä¹‹å‰çš„<code>status.funcbpt</code>ã€<code>status.namebpt</code>ç±»ä¼¼ï¼Œæˆ‘ä»¬æŠŠè¿™ä¸ªè¡¨å®šä¹‰ä¸º<code>status.srcbpt</code>ã€‚</p>
<p>å½“æ‰§è¡Œåˆ°è¯¥å‡½æ•°ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥å°†<code>status.srcbpt</code>ä¸­å¯¹åº”çš„æ–­ç‚¹è½¬ç§»åˆ°<code>status.funcbpt</code>è¡¨ä¸­ï¼Œåç»­å°±å¯ä»¥é€šè¿‡æ™®é€šå‡½æ•°æ–­ç‚¹çš„æ–¹å¼è¿›è¡Œå¤„ç†äº†ã€‚</p>
<p>ä¸ºäº†æå‡æ€§èƒ½ï¼Œæˆ‘ä»¬å¯ä»¥å°†ä¹‹å‰æ‰§è¡Œè¿‡çš„å‡½æ•°çš„ä¿¡æ¯ä¿å­˜ä¸‹æ¥ï¼Œåç»­å†ï¼ˆé€šè¿‡åŒ…åæ–¹å¼ï¼‰åœ¨ç›¸åŒçš„å‡½æ•°ä¸­æ·»åŠ æ–­ç‚¹æ—¶ï¼Œå°±å¯ä»¥å¿«é€Ÿåœ°ç¡®å®šå…¶æ‰€åœ¨å‡½æ•°ï¼Œç›´æ¥åœ¨æ·»åŠ æ–­ç‚¹çš„æ—¶å€™å°±è½¬æ¢ä¸ºæ™®é€šå‡½æ•°æ–­ç‚¹äº†ï¼Œè€Œä¸éœ€è¦æ¨è¿Ÿåˆ°åé¢è¿›è¡ŒæŸ¥æ‰¾æ¯”å¯¹è½¬æ¢äº†ã€‚ä¹‹å‰æˆ‘ä»¬å·²ç»æœ‰äº†ä¸€ä¸ªä¿å­˜å‡½æ•°ä¿¡æ¯çš„è¡¨<code>status.funcinfos</code>ï¼Œä½†æ˜¯é‚£ä¸ªè¡¨æ˜¯ä»¥å‡½æ•°ä½œä¸ºé”®ï¼Œè€Œè¿™é‡Œæˆ‘ä»¬éœ€è¦é€šè¿‡æºæ–‡ä»¶è·¯å¾„è¿›è¡ŒæŸ¥æ‰¾ï¼Œæ‰€ä»¥éœ€è¦æ–°çš„æ•°æ®ç»“æ„ã€‚</p>
<h3 id="è§£å†³æ–­ç‚¹æ­§ä¹‰"><a href="#è§£å†³æ–­ç‚¹æ­§ä¹‰" class="headerlink" title="è§£å†³æ–­ç‚¹æ­§ä¹‰"></a>è§£å†³æ–­ç‚¹æ­§ä¹‰</h3><p>é€šè¿‡åŒ…åæ·»åŠ æ–­ç‚¹å­˜åœ¨ç€ä¸€ç§æ­§ä¹‰çš„æƒ…å†µï¼šå½“æ–­ç‚¹è½åœ¨å‡½æ•°å®šä¹‰çš„èŒƒå›´ä¹‹å†…æ—¶ï¼Œå®ƒæ˜¯è¡¨ç¤ºå¯¹mainchunkä¸­çš„å‡½æ•°å£°æ˜æ·»åŠ æ–­ç‚¹ï¼Œè¿˜æ˜¯è¡¨ç¤ºåœ¨è¯¥å­å‡½æ•°æ‰§è¡Œæ—¶æ·»åŠ æ–­ç‚¹ã€‚ï¼ˆæœ¬è´¨ä¸Šæ˜¯å› ä¸ºmainchunkçš„æœ‰æ•ˆè¡Œå’Œå­å‡½æ•°æœ‰æ•ˆè¡Œå­˜åœ¨é‡å ï¼‰</p>
<p>æ‰€ä»¥ä¸ºäº†ä¼˜é›…åœ°è§£å†³è¿™ä¸ªæ­§ä¹‰é—®é¢˜ï¼Œæˆ‘ä»¬ä½¿ç”¨è¡Œå·çš„æ­£è´Ÿè¡¨ç¤ºæ˜¯åœ¨mainchunkä¸­è¿˜æ˜¯åœ¨å­å‡½æ•°ä¸­æ·»åŠ æ–­ç‚¹ã€‚å¦‚æœè¡Œå·æ˜¯æ­£æ•°ï¼Œè¡¨ç¤ºå­å‡½æ•°ï¼Œè·Ÿå‰å‡ ç¯‡ä¸­çš„æƒ…å†µä¿æŒä¸€è‡´ï¼›å¦‚æœè¡Œå·æ˜¯è´Ÿæ•°ï¼Œåˆ™è¡¨ç¤ºåœ¨mainchunkä¸­æ·»åŠ æ–­ç‚¹ã€‚</p>
<p>å¥½äº†ï¼Œè§£å†³äº†æœ€å…³é”®çš„å‡ ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å°±å¯ä»¥å¼€å§‹ç€æ‰‹å†™ä»£ç äº†</p>
<h2 id="æ·»åŠ æ–­ç‚¹"><a href="#æ·»åŠ æ–­ç‚¹" class="headerlink" title="æ·»åŠ æ–­ç‚¹"></a>æ·»åŠ æ–­ç‚¹</h2><p>åŒæ ·ä¾ç…§æƒ¯ä¾‹ï¼Œæˆ‘ä»¬å…ˆä¿®æ”¹è®¾ç½®æ–­ç‚¹å‡½æ•°ã€‚å®ƒçš„æ”¹åŠ¨è¾ƒå¤§ï¼Œå› ä¸ºå‡½æ•°åç§°å’ŒåŒ…åç§°éƒ½æ˜¯é€šè¿‡å­—ç¬¦ä¸²å‚æ•°æŒ‡å®šï¼Œæ‰€ä»¥éœ€è¦ä¸€ä¸ªåŒºåˆ†æ‰‹æ®µï¼Œæˆ‘ä»¬è¿™é‡Œé‡‡ç”¨äº†ä¸€ä¸ªè·Ÿåœ¨åç§°åé¢çš„ç‰¹æ®Šå­—ç¬¦æ¥è¿›è¡ŒåŒºåˆ†ã€‚å¦‚æœåé¢è·Ÿçš„æ˜¯<code>@</code>ï¼Œè¡¨ç¤ºæ˜¯å‡½æ•°åç§°ï¼Œå¦‚æœåé¢è·Ÿçš„æ˜¯<code>:</code>ï¼Œè¡¨ç¤ºæ˜¯åŒ…åã€‚</p>
<p>å…ˆæ¥çœ‹é€šè¿‡åŒ…åæ·»åŠ æ–­ç‚¹çš„æƒ…å†µï¼Œé¦–å…ˆæŸ¥æ‰¾æ ‡è®°ç¬¦å·<code>:</code>ï¼Œå¦‚æœæ‰¾åˆ°åˆ™å‰é¢éƒ¨åˆ†è¡¨ç¤ºåŒ…åï¼Œåé¢éƒ¨åˆ†è¡¨ç¤ºè¡Œå·ã€‚åˆ‡åˆ†ä¹‹åï¼Œæ£€æŸ¥åŒ…åæ˜¯å¦ä¸ºç©ºï¼Œå†æ£€æŸ¥è¡Œå·æ˜¯å¦åˆæ³•ã€‚å¦‚æœæ²¡æœ‰æŒ‡å®šè¡Œå·ï¼Œé‚£ä¹ˆé»˜è®¤è®¾ç½®ä¸º-1ï¼Œä¹Ÿå°±æ˜¯mainchunkçš„ç¬¬ä¸€è¡Œã€‚æ¥ä¸‹æ¥è°ƒç”¨<code>package.searchpath()</code>å°†åŒ…åè½¬åŒ–ä¸ºè·¯å¾„ï¼Œå¦‚æœæ‰¾åˆ°äº†æŒ‡å®šçš„åŒ…ï¼Œå†é€šè¿‡<code>setsrcbp()</code>å‡½æ•°æ¥è®¾ç½®æ–­ç‚¹ã€‚<code>setsrcbp()</code>æˆ‘ä»¬ç¨åä»‹ç»ã€‚</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">setbreakpoint</span><span class="params">(where, line)</span></span></span><br><span class="line">    <span class="comment">-- çœç•¥</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">type</span>(where) == <span class="string">&quot;function&quot;</span> <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span> setfuncbp(where, line)</span><br><span class="line">    <span class="keyword">else</span>            <span class="comment">-- &quot;string&quot;</span></span><br><span class="line">        <span class="keyword">local</span> i = <span class="built_in">string</span>.<span class="built_in">find</span>(where, <span class="string">&quot;:&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> i <span class="keyword">then</span>   <span class="comment">-- package name</span></span><br><span class="line">            <span class="keyword">local</span> packname = <span class="built_in">string</span>.<span class="built_in">sub</span>(where, <span class="number">1</span>, i<span class="number">-1</span>)</span><br><span class="line">            <span class="keyword">local</span> line = <span class="built_in">string</span>.<span class="built_in">sub</span>(where, i+<span class="number">1</span>)</span><br><span class="line">            <span class="keyword">if</span> packname == <span class="string">&quot;&quot;</span> <span class="keyword">then</span></span><br><span class="line">                <span class="built_in">io</span>.<span class="built_in">write</span>(<span class="string">&quot;no package name specified!\n&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">if</span> line ~= <span class="string">&quot;&quot;</span> <span class="keyword">then</span></span><br><span class="line">                line = <span class="built_in">tonumber</span>(line)</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> line <span class="keyword">then</span></span><br><span class="line">                    <span class="built_in">io</span>.<span class="built_in">write</span>(<span class="string">&quot;no valid line number specified!\n&quot;</span>)</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                line = <span class="number">-1</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">local</span> <span class="built_in">path</span>, err = <span class="built_in">package</span>.searchpath(packname, <span class="built_in">package</span>.<span class="built_in">path</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">path</span> <span class="keyword">then</span></span><br><span class="line">                <span class="built_in">io</span>.<span class="built_in">write</span>(err)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">return</span> setsrcbp(<span class="built_in">path</span>, line)</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>é€šè¿‡å‡½æ•°åç§°æ·»åŠ æ–­ç‚¹çš„æƒ…å†µä¹Ÿæ˜¯ç±»ä¼¼ï¼Œä¸è¿‡çœäº†è·¯å¾„è½¬æ¢çš„æ­¥éª¤ã€‚é¦–å…ˆæŸ¥æ‰¾æ ‡è®°ç¬¦å·<code>@</code>ï¼Œç„¶ååˆ‡åˆ†å‡½æ•°åå’Œè¡Œå·ï¼Œæ£€æŸ¥å‡½æ•°åæ˜¯å¦ä¸ºç©ºï¼Œæ£€æŸ¥è¡Œå·æ˜¯å¦åˆæ³•ï¼Œéƒ½okä¹‹åå†äº¤ç»™<code>setnamebp()</code>è¿›è¡Œåé¢çš„å·¥ä½œã€‚<code>setnamebp()</code>å‡½æ•°æˆ‘ä»¬åœ¨ä¸Šä¸€ç¯‡å·²ç»ä»‹ç»è¿‡äº†ã€‚</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">setbreakpoint</span><span class="params">(where, line)</span></span></span><br><span class="line">    <span class="comment">-- çœç•¥</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">local</span> i = <span class="built_in">string</span>.<span class="built_in">find</span>(where, <span class="string">&quot;@&quot;</span>)</span><br><span class="line">            <span class="keyword">if</span> i <span class="keyword">then</span>   <span class="comment">-- function name</span></span><br><span class="line">                <span class="keyword">local</span> funcname = <span class="built_in">string</span>.<span class="built_in">sub</span>(where, <span class="number">1</span>, i<span class="number">-1</span>)</span><br><span class="line">                <span class="keyword">local</span> line = <span class="built_in">string</span>.<span class="built_in">sub</span>(where, i+<span class="number">1</span>)</span><br><span class="line">                <span class="keyword">if</span> funcname == <span class="string">&quot;&quot;</span> <span class="keyword">then</span></span><br><span class="line">                    <span class="built_in">io</span>.<span class="built_in">write</span>(<span class="string">&quot;no function name specified!\n&quot;</span>)</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">                <span class="keyword">if</span> line ~= <span class="string">&quot;&quot;</span> <span class="keyword">then</span></span><br><span class="line">                    line = <span class="built_in">tonumber</span>(line)</span><br><span class="line">                    <span class="keyword">if</span> <span class="keyword">not</span> line <span class="keyword">then</span></span><br><span class="line">                        <span class="built_in">io</span>.<span class="built_in">write</span>(<span class="string">&quot;no valid line number specified!\n&quot;</span>)</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">                    <span class="keyword">end</span></span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    line = <span class="literal">nil</span></span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">                <span class="keyword">return</span> setnamebp(funcname, line)</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>



<p>ä¸‹é¢æˆ‘ä»¬æ¥çœ‹<code>setsrcbp()</code>å‡½æ•°çš„å®ç°ï¼Œè¿™ä¸ªå‡½æ•°è·Ÿ<code>setnamebp()</code>å¤§ä½“ä¸Šç±»ä¼¼ï¼Œå¼€å¤´éƒ¨åˆ†ç¨æœ‰ä¸åŒã€‚é¦–å…ˆä¼šé€šè¿‡<code>lookforfunc()</code>æŸ¥çœ‹æ–­ç‚¹æ˜¯å¦ä½äºå·²çŸ¥å‡½æ•°ä¸­ï¼Œå¦‚æœæ˜¯çš„è¯è¿”å›è¯¥å‡½æ•°ï¼Œç„¶åç›´æ¥è°ƒç”¨<code>setfuncbp()</code>å‡½æ•°ä½œä¸ºå‡½æ•°æ–­ç‚¹å¤„ç†ã€‚<code>lookforfunc()</code>æˆ‘ä»¬ç¨æ™šä¸€ç‚¹å†ä»‹ç»ã€‚åé¢çš„æµç¨‹è·Ÿ<code>setnamebp()</code>å¹¶æ— äºŒè‡´å°±ä¸å†èµ˜è¿°ã€‚</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">setsrcbp</span><span class="params">(src, line)</span></span></span><br><span class="line">    <span class="keyword">local</span> s = <span class="built_in">status</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">-- æ£€æŸ¥æ–­ç‚¹æ˜¯å¦ä½äºå·²çŸ¥å‡½æ•°ä¸­</span></span><br><span class="line">    <span class="keyword">local</span> func = lookforfunc(src, line)</span><br><span class="line">    <span class="keyword">if</span> func <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span> setfuncbp(func, line)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">local</span> srcbp = s.srcbpt[src]</span><br><span class="line">    <span class="comment">-- æ£€æŸ¥ç›¸åŒçš„æ–­ç‚¹æ˜¯å¦å·²ç»è®¾ç½®</span></span><br><span class="line">    <span class="keyword">if</span> srcbp <span class="keyword">and</span> srcbp[line] <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span> srcbp[line]</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="comment">-- çœç•¥</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>



<h2 id="é’©å­å‡½æ•°"><a href="#é’©å­å‡½æ•°" class="headerlink" title="é’©å­å‡½æ•°"></a>é’©å­å‡½æ•°</h2><p>é’©å­å‡½æ•°çš„æ”¹åŠ¨éƒ½æ˜¯åœ¨calläº‹ä»¶ä¸­ã€‚é¦–å…ˆï¼Œåœ¨è·å–åˆ°å½“å‰å‡½æ•°åŠå…¶ä¿¡æ¯ä¹‹åï¼Œè°ƒç”¨<code>solvesrcbp()</code>å¤„ç†<code>status.srcbpt</code>è¡¨ä¸­è¿˜æœªè½¬æ¢çš„æ–­ç‚¹ï¼Œå¦‚æœå‘ç°æœ‰ä½äºå½“å‰å‡½æ•°ä¸­çš„æ–­ç‚¹ï¼Œé‚£ä¹ˆå°±è¿›è¡Œç›¸åº”çš„æ–­ç‚¹è½¬æ¢ã€‚æ¥ä¸‹æ¥ï¼Œå¦‚æœå½“å‰å‡½æ•°ä¸æ˜¯Cå‡½æ•°ï¼Œå°±è°ƒç”¨<code>setsrcfunc()</code>å‡½æ•°ä¿å­˜å‡½æ•°ä¿¡æ¯ã€‚</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">hook</span> <span class="params">(event, line)</span></span></span><br><span class="line">    <span class="keyword">local</span> s = <span class="built_in">status</span></span><br><span class="line">    <span class="keyword">if</span> event == <span class="string">&quot;call&quot;</span> <span class="keyword">or</span> event == <span class="string">&quot;tail call&quot;</span> <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">local</span> stackinfo = <span class="built_in">debug</span>.<span class="built_in">getinfo</span>(<span class="number">2</span>, <span class="string">&quot;nf&quot;</span>)</span><br><span class="line">        <span class="keyword">local</span> func = stackinfo.func</span><br><span class="line">        <span class="keyword">local</span> name = stackinfo.name</span><br><span class="line">        <span class="keyword">local</span> funcinfo = getfuncinfo(func)</span><br><span class="line">        <span class="keyword">local</span> hasbreak = <span class="literal">false</span></span><br><span class="line">        <span class="comment">-- å¤„ç†é€šè¿‡åŒ…åæ·»åŠ çš„è¿˜æœªè½¬æ¢çš„æ–­ç‚¹</span></span><br><span class="line">        solvesrcbp(funcinfo, func)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> funcinfo.what ~= <span class="string">&quot;C&quot;</span> <span class="keyword">then</span></span><br><span class="line">            setsrcfunc(funcinfo, func)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> s.funcbpt[func] <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">local</span> id = s.funcbpt[func]</span><br><span class="line">            <span class="keyword">if</span> s.bptable[id] <span class="keyword">and</span> <span class="keyword">not</span> s.bptable[id].src <span class="keyword">then</span></span><br><span class="line">                s.bptable[id].src = funcinfo.short_src</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            hasbreak = <span class="literal">true</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="comment">-- çœç•¥</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>



<h2 id="æ–­ç‚¹è½¬æ¢"><a href="#æ–­ç‚¹è½¬æ¢" class="headerlink" title="æ–­ç‚¹è½¬æ¢"></a>æ–­ç‚¹è½¬æ¢</h2><p>æ¥ä¸‹æ¥çœ‹ä¸‹<code>solvesrcbp()</code>å‡½æ•°çš„å®ç°ï¼Œå¦‚æœå½“å‰æºæ–‡ä»¶ä¸­å­˜åœ¨æœªè½¬æ¢çš„æ–­ç‚¹ï¼Œé‚£ä¹ˆéå†è¿™äº›æ–­ç‚¹ï¼Œè°ƒç”¨<code>verifyfuncline()</code>åˆ¤æ–­æ–­ç‚¹æ˜¯å¦åœ¨å½“å‰å‡½æ•°ä¸­ï¼Œå¦‚æœæ˜¯çš„è¯å°±è°ƒç”¨<code>modsrcbp()</code>å‡½æ•°è¿›è¡Œå®é™…çš„è½¬æ¢æ“ä½œã€‚</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">solvesrcbp</span> <span class="params">(info, func)</span></span></span><br><span class="line">    <span class="keyword">local</span> s = <span class="built_in">status</span></span><br><span class="line">    <span class="keyword">local</span> srcbp = s.srcbpt[info.short_src]</span><br><span class="line">    <span class="keyword">if</span> srcbp <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">for</span> k, v <span class="keyword">in</span> <span class="built_in">pairs</span>(srcbp) <span class="keyword">do</span></span><br><span class="line">            <span class="keyword">if</span> k ~= <span class="string">&quot;num&quot;</span> <span class="keyword">then</span></span><br><span class="line">                line = verifyfuncline(info, k)</span><br><span class="line">                <span class="keyword">if</span> line <span class="keyword">then</span></span><br><span class="line">                    modsrcbp(info.short_src, func, k, line)</span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>



<p><code>modsrcbp()</code>å‡½æ•°çš„å®ç°å¦‚ä¸‹ï¼Œå®ƒæœ‰4ä¸ªå‚æ•°ç¬¬ä¸€ä¸ª<code>src</code>æ˜¯æºæ–‡ä»¶è·¯å¾„ã€ç¬¬äºŒä¸ª<code>func</code>æ˜¯å‡½æ•°ã€ç¬¬ä¸‰ä¸ª<code>oline</code>æ˜¯è®¾ç½®æ–­ç‚¹æ—¶çš„è¡Œå·ã€ç¬¬å››ä¸ª<code>nline</code>æ˜¯<code>verifyfuncline()</code>è¿›è¡Œä¿®æ­£åçš„è¡Œå·ã€‚</p>
<p>è¯¥å‡½æ•°é¦–å…ˆä»¥<code>src</code>å’Œ<code>oline</code>ä¸ºç´¢å¼•å°†æ–­ç‚¹ä»<code>status.srcbpt</code>è¡¨ä¸­ç§»é™¤ï¼Œç„¶åè®¾ç½®åˆ°<code>status.funcbpt</code>è¡¨ä¸­ã€‚å¦‚æœåŒä¸€ä¸ªæ–­ç‚¹å·²ç»è®¾ç½®è¿‡äº†ï¼Œé‚£ä¹ˆå°†æ–°æ·»åŠ çš„æ–­ç‚¹åˆ é™¤ï¼Œç„¶åè¿”å›æ—§çš„æ–­ç‚¹idã€‚</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">modsrcbp</span><span class="params">(src, func, oline, nline)</span></span></span><br><span class="line">    <span class="keyword">local</span> s = <span class="built_in">status</span></span><br><span class="line">    <span class="keyword">local</span> srcbp = s.srcbpt[src]</span><br><span class="line">    <span class="keyword">local</span> id = srcbp[oline]</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- ä»srcbptä¸­ç§»é™¤</span></span><br><span class="line">    srcbp.num = srcbp.num - <span class="number">1</span></span><br><span class="line">    srcbp[oline] = <span class="literal">nil</span></span><br><span class="line">    <span class="keyword">if</span> srcbp.num == <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">        srcbp = <span class="literal">nil</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">-- è®¾ç½®funcbpt</span></span><br><span class="line">    <span class="keyword">local</span> funcbp = s.funcbpt[func]</span><br><span class="line">    <span class="comment">-- æ£€æŸ¥æ˜¯å¦å·²ç»è®¾ç½®äº†ç›¸åŒçš„æ–­ç‚¹</span></span><br><span class="line">    <span class="keyword">if</span> funcbp <span class="keyword">and</span> funcbp[nline] <span class="keyword">then</span></span><br><span class="line">        s.bptable[id] = <span class="literal">nil</span>      <span class="comment">-- å¦‚æœå·²ç»è®¾ç½®äº†ï¼Œåˆ é™¤æ–°åŠ çš„æ–­ç‚¹</span></span><br><span class="line">        s.bpnum = s.bpnum - <span class="number">1</span></span><br><span class="line">        <span class="built_in">assert</span>(s.bpnum &gt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> funcbp[nline]     <span class="comment">-- è¿”å›æ—§çš„æ–­ç‚¹id</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">-- çœç•¥</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>å¦‚æœè¿˜æœªæ·»åŠ è¿‡è¿™ä¸ªæ–­ç‚¹ï¼Œé‚£ä¹ˆå°±åœ¨<code>status.funcbpt</code>ä¸­æ·»åŠ è¯¥æ–­ç‚¹ï¼Œç„¶åå°†æ–­ç‚¹æ‰€åœ¨çš„å‡½æ•°å’Œä¿®æ­£åçš„è¡Œå·æ›´æ–°åˆ°<code>s.bptable</code>è¡¨ä¸­ã€‚</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">modsrcbp</span><span class="params">(src, func, oline, nline)</span></span></span><br><span class="line">    <span class="comment">-- çœç•¥</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> funcbp <span class="keyword">then</span>            <span class="comment">-- è¯¥å‡½æ•°çš„ç¬¬ä¸€ä¸ªæ–­ç‚¹</span></span><br><span class="line">        s.funcbpt[func] = &#123;&#125;</span><br><span class="line">        funcbp = s.funcbpt[func]</span><br><span class="line">        funcbp.num = <span class="number">0</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    funcbp.num = funcbp.num + <span class="number">1</span></span><br><span class="line">    funcbp[nline] = id</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- æ›´æ–°bptableä¸­å­—æ®µ</span></span><br><span class="line">    s.bptable[id].func = func</span><br><span class="line">    s.bptable[id].line = nline</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> id</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>



<h2 id="è¡Œå·æ‰©å±•"><a href="#è¡Œå·æ‰©å±•" class="headerlink" title="è¡Œå·æ‰©å±•"></a>è¡Œå·æ‰©å±•</h2><p>å› ä¸ºæˆ‘ä»¬å¯¹è¡Œå·è¿›è¡Œäº†æ‰©å±•äº†ï¼Œä½¿ç”¨è´Ÿæ•°æ¥è¡¨ç¤ºmainchunkä¸­çš„æ–­ç‚¹ï¼Œæ‰€ä»¥<code>verifyfuncline()</code>ä¹Ÿéœ€è¦è¿›è¡Œç›¸åº”çš„æ‰©å±•ã€‚å¯¹äºè¡Œå·æ˜¯è´Ÿæ•°çš„æƒ…å†µï¼Œå¦‚æœä¸æ˜¯mainchunkå‡½æ•°ï¼Œç›´æ¥è¿”å›nilï¼Œå¦åˆ™å¯¹è¡Œå·å–åè¿˜åŸä¸ºæ­£å¸¸çš„è¡Œå·ã€‚</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">verifyfuncline</span> <span class="params">(info, line)</span></span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> line <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span> info.sortedlines[<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">if</span> line &lt; <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">if</span> info.what ~= <span class="string">&quot;main&quot;</span> <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        line = -line</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">if</span> line &lt; info.linedefined <span class="keyword">or</span> line &gt; info.lastlinedefined <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">for</span> _, v <span class="keyword">in</span> <span class="built_in">ipairs</span>(info.sortedlines) <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">if</span> v &gt;= line <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">return</span> v</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="built_in">assert</span>(<span class="literal">false</span>)   <span class="comment">-- impossible to reach here</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>



<p>è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œé€šè¿‡<code>debug.getinfo()</code>å‡½æ•°è·å–åˆ°çš„å‡½æ•°ä¿¡æ¯ä¸­ï¼Œå¯¹äºmainchunkçš„æƒ…å†µï¼Œ<code>linedefined</code>å’Œ<code>lastlinedefined</code>å­—æ®µçš„å€¼éƒ½æ˜¯0ï¼Œäºæ˜¯æˆ‘ä»¬çš„<code>getfuncinfo()</code>å‡½æ•°ä¹Ÿè¦è¿›è¡Œç›¸åº”çš„è°ƒæ•´ï¼š</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">getfuncinfo</span> <span class="params">(func)</span></span></span><br><span class="line">    <span class="keyword">local</span> s = <span class="built_in">status</span></span><br><span class="line">    <span class="keyword">local</span> info = s.funcinfos[func]</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> info <span class="keyword">then</span></span><br><span class="line">        info = <span class="built_in">debug</span>.<span class="built_in">getinfo</span>(func, <span class="string">&quot;SL&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> (info.activelines) <span class="keyword">then</span></span><br><span class="line">            info.sortedlines = &#123;&#125;</span><br><span class="line">            <span class="keyword">for</span> k, _ <span class="keyword">in</span> <span class="built_in">pairs</span>(info.activelines) <span class="keyword">do</span></span><br><span class="line">               <span class="built_in">table</span>.<span class="built_in">insert</span>(info.sortedlines, k)</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            <span class="built_in">table</span>.<span class="built_in">sort</span>(info.sortedlines)</span><br><span class="line">            <span class="comment">-- mainchunkéœ€è¦ç‰¹æ®Šå¤„ç†ä»¥ä½¿`verifyfuncline`èƒ½å¤Ÿæ­£å¸¸å·¥ä½œ</span></span><br><span class="line">            <span class="keyword">if</span> info.what == <span class="string">&quot;main&quot;</span> <span class="keyword">then</span></span><br><span class="line">                info.linedefined = <span class="number">1</span></span><br><span class="line">                info.lastlinedefined = info.sortedlines[#info.sortedlines]</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        s.funcinfos[func] = info</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> info</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>å¯¹äºmainchunkå‡½æ•°è¿›è¡Œç‰¹æ®Šå¤„ç†ï¼Œå°†<code>linedefined</code>è®¾ç½®ä¸º1ï¼Œå°†<code>lastlinedefined</code>è®¾ç½®ä¸ºæœ€åä¸€ä¸ªæœ‰æ•ˆè¡Œçš„è¡Œå·ã€‚</p>
<h2 id="ç¼“å­˜åŠæŸ¥æ‰¾æºæ–‡ä»¶çš„å‡½æ•°"><a href="#ç¼“å­˜åŠæŸ¥æ‰¾æºæ–‡ä»¶çš„å‡½æ•°" class="headerlink" title="ç¼“å­˜åŠæŸ¥æ‰¾æºæ–‡ä»¶çš„å‡½æ•°"></a>ç¼“å­˜åŠæŸ¥æ‰¾æºæ–‡ä»¶çš„å‡½æ•°</h2><p>æˆ‘ä»¬åœ¨é’©å­å‡½æ•°ä¸­è°ƒç”¨<code>setsrcfunc()</code>ä¿å­˜å‡½æ•°ä¿¡æ¯ï¼Œå°†å‡½æ•°ä¸æºæ–‡ä»¶å…³è”ã€‚åœ¨<code>setsrcbp()</code>ä¸­è°ƒç”¨<code>lookforfunc()</code>é€šè¿‡æºæ–‡ä»¶å’Œè¡Œå·æŸ¥æ‰¾å¯¹åº”çš„å‡½æ•°ã€‚å…ˆæ¥çœ‹<code>setsrcfunc()</code>å‡½æ•°å®ç°ï¼š</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">setsrcfunc</span> <span class="params">(info, func)</span></span></span><br><span class="line">    <span class="keyword">local</span> s = <span class="built_in">status</span></span><br><span class="line">    <span class="keyword">local</span> srcfunc = s.srcfuncmap[info.short_src]</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> srcfunc <span class="keyword">then</span></span><br><span class="line">        srcfunc = &#123;&#125;</span><br><span class="line">        s.srcfuncmap[info.short_src] = srcfunc</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> srcfunc[func] <span class="keyword">then</span></span><br><span class="line">        srcfunc[func] = info</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­<code>status.srcfuncmap</code>å°±æ˜¯æˆ‘ä»¬æ–°å¢çš„æ•°æ®ç»“æ„ï¼Œå®ƒæ˜¯ä¸€ä¸ªä»¥æºæ–‡ä»¶è·¯å¾„ä¸ºé”®çš„è¡¨ï¼Œå…¶å€¼ä¹Ÿæ˜¯ä¸€ä¸ªè¡¨ï¼Œä¿å­˜ä½äºè¯¥æºæ–‡ä»¶ä¸­çš„å‡½æ•°ä¿¡æ¯ï¼Œä»¥å‡½æ•°ä¸ºé”®ï¼Œä»¥å‡½æ•°ä¿¡æ¯ä¸ºå€¼ã€‚</p>
<p>å†æ¥çœ‹<code>lookforfunc()</code>å‡½æ•°çš„å®ç°ï¼š</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">lookforfunc</span> <span class="params">(src, line)</span></span></span><br><span class="line">    <span class="built_in">assert</span>(line)</span><br><span class="line">    <span class="keyword">local</span> srcfunc = <span class="built_in">status</span>.srcfuncmap[src]</span><br><span class="line">    <span class="keyword">if</span> srcfunc <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">for</span> func, info <span class="keyword">in</span> <span class="built_in">pairs</span>(srcfunc) <span class="keyword">do</span></span><br><span class="line">            <span class="keyword">if</span> info.what == <span class="string">&quot;main&quot;</span> <span class="keyword">then</span></span><br><span class="line">                <span class="keyword">if</span> line &lt; <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">                    <span class="keyword">return</span> func</span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">elseif</span> line &gt;= info.linedefined</span><br><span class="line">                <span class="keyword">and</span> line &lt;= info.lastlinedefined <span class="keyword">then</span></span><br><span class="line">                <span class="keyword">return</span> func</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>



<p><code>lookforfunc()</code>å‡½æ•°ä¸­é¦–å…ˆåˆ¤æ–­è¯¥æºæ–‡ä»¶æ˜¯å¦æœ‰ç¼“å­˜çš„å‡½æ•°ä¿¡æ¯ï¼Œå¦‚æœæœ‰åˆ™è¿›è¡Œéå†ã€‚å¦‚æœè¡Œå·æ˜¯è´Ÿæ•°ï¼Œåˆ™åªè¦æ‰¾åˆ°mainchunkå°±å¯ä»¥è¿”å›äº†ã€‚å¦åˆ™ï¼Œéœ€è¦åˆ¤æ–­æ–­ç‚¹çš„è¡Œå·æ˜¯å¦åœ¨å‡½æ•°å®šä¹‰çš„èŒƒå›´å†…ã€‚æ‰¾åˆ°äº†ï¼Œå°±è¿”å›æ–­ç‚¹æ‰€åœ¨å‡½æ•°ï¼›æ²¡æœ‰æ‰¾åˆ°è¿”å›<code>nil</code>ã€‚</p>
<h2 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h2><p>é¦–å…ˆï¼Œç¼–å†™ä¸€ä¸ªç”¨äºæµ‹è¯•çš„åŒ…<code>testlib.lua</code>ï¼Œå®ç°äº†ä¸¤ä¸ªç®€å•çš„å‡½æ•°fooå’Œbarã€‚</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">foo</span> <span class="params">()</span></span></span><br><span class="line">    <span class="keyword">local</span> a = <span class="number">1</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">bar</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">local</span> a = <span class="number">1</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> a = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> &#123;</span><br><span class="line">    foo = foo,</span><br><span class="line">    bar = bar,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="æµ‹è¯•é€šè¿‡å‡½æ•°åå’ŒåŒ…åæ·»åŠ æ–­ç‚¹"><a href="#æµ‹è¯•é€šè¿‡å‡½æ•°åå’ŒåŒ…åæ·»åŠ æ–­ç‚¹" class="headerlink" title="æµ‹è¯•é€šè¿‡å‡½æ•°åå’ŒåŒ…åæ·»åŠ æ–­ç‚¹"></a>æµ‹è¯•é€šè¿‡å‡½æ•°åå’ŒåŒ…åæ·»åŠ æ–­ç‚¹</h3><p>æˆ‘ä»¬é€šè¿‡å‡½æ•°åæ·»åŠ äº†ä¸¤ä¸ªæ–­ç‚¹ï¼Œå…¶ä¸­ä¸€ä¸ªçœç•¥è¡Œå·ï¼Œé»˜è®¤ä¸ºå‡½æ•°ç¬¬ä¸€ä¸ªæœ‰æ•ˆè¡Œã€‚åˆé€šè¿‡åŒ…åæ·»åŠ äº†ä¸¤ä¸ªæœ‰æ•ˆæ–­ç‚¹id3å’Œid4ï¼Œid5è™½ç„¶èƒ½æ·»åŠ æˆåŠŸï¼Œä½†æ˜¯å¹¶ä¸è½åœ¨æœ‰æ•ˆå‡½æ•°èŒƒå›´å†…ã€‚id6å’Œid7éƒ½æ˜¯å‚æ•°é”™è¯¯çš„æƒ…å†µï¼Œæ·»åŠ æ–­ç‚¹å¤±è´¥ã€‚</p>
<p>è®¾ç½®å®Œæ–­ç‚¹ï¼Œå…ˆåˆ†åˆ«è°ƒç”¨fooå’Œbarå‡½æ•°ä¸€æ¬¡ï¼Œé¢„æœŸéƒ½åœ¨fooå‡½æ•°ç¬¬2è¡Œç¬¬3è¡Œä¼šç¢°åˆ°æ–­ç‚¹ï¼Œç„¶ååœ¨barå‡½æ•°çš„ç¬¬6è¡Œç¬¬7è¡Œç¢°åˆ°æ–­ç‚¹ã€‚æ¥ç€åˆ†åˆ«åˆ é™¤fooå’Œbarå‡½æ•°ä¸­çš„1ä¸ªæ–­ç‚¹ï¼Œå†åˆ†åˆ«è°ƒç”¨fooå’Œbarå‡½æ•°ä¸€æ¬¡ï¼Œé¢„æœŸåœ¨fooå‡½æ•°çš„ç¬¬3è¡Œå’Œbarå‡½æ•°çš„ç¬¬7è¡Œç¢°åˆ°æ–­ç‚¹ã€‚æœ€ååˆ é™¤fooå’Œbarå‡½æ•°ä¸­çš„å¦ä¸€ä¸ªæ–­ç‚¹ï¼Œå†åˆ†åˆ«è°ƒç”¨fooå’Œbarå‡½æ•°ä¸€æ¬¡ï¼Œé¢„æœŸä¸å†ç¢°åˆ°æ–­ç‚¹ã€‚</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> ldb = <span class="built_in">require</span> <span class="string">&quot;luadebug&quot;</span></span><br><span class="line"><span class="keyword">local</span> lib = <span class="built_in">require</span> <span class="string">&quot;testlib&quot;</span></span><br><span class="line"><span class="keyword">local</span> setbp = ldb.setbreakpoint</span><br><span class="line"><span class="keyword">local</span> rmbp = ldb.removebreakpoint</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> id1 = setbp(<span class="string">&quot;foo@&quot;</span>)           <span class="comment">-- foo 2</span></span><br><span class="line"><span class="keyword">local</span> id2 = setbp(<span class="string">&quot;foo@3&quot;</span>)          <span class="comment">-- foo 3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> id3 = setbp(<span class="string">&quot;testlib:5&quot;</span>)      <span class="comment">-- bar 6</span></span><br><span class="line"><span class="keyword">local</span> id4 = setbp(<span class="string">&quot;testlib:7&quot;</span>)      <span class="comment">-- bar 7</span></span><br><span class="line"><span class="keyword">local</span> id5 = setbp(<span class="string">&quot;testlib:100&quot;</span>)    <span class="comment">-- invalid line</span></span><br><span class="line"><span class="keyword">local</span> id6 = setbp(<span class="string">&quot;:5&quot;</span>)</span><br><span class="line"><span class="built_in">assert</span>(<span class="keyword">not</span> id6)</span><br><span class="line"><span class="keyword">local</span> id7 = setbp(<span class="string">&quot;testlib:aa&quot;</span>)</span><br><span class="line"><span class="built_in">assert</span>(<span class="keyword">not</span> id7)</span><br><span class="line"></span><br><span class="line">lib.foo(<span class="number">1</span>)              <span class="comment">-- break twice</span></span><br><span class="line">lib.bar(<span class="number">1</span>)              <span class="comment">-- break twice</span></span><br><span class="line"></span><br><span class="line">rmbp(id1)</span><br><span class="line">rmbp(id3)</span><br><span class="line"></span><br><span class="line">lib.foo(<span class="number">2</span>)              <span class="comment">-- break once</span></span><br><span class="line">lib.bar(<span class="number">2</span>)              <span class="comment">-- break once</span></span><br><span class="line"></span><br><span class="line">rmbp(id2)</span><br><span class="line">rmbp(id4)</span><br><span class="line"></span><br><span class="line">lib.foo(<span class="number">3</span>)              <span class="comment">-- not break</span></span><br><span class="line">lib.bar(<span class="number">3</span>)              <span class="comment">-- not break</span></span><br></pre></td></tr></table></figure>

<p>è¿è¡Œæµ‹è¯•è„šæœ¬ï¼Œåˆ†åˆ«åœ¨fooå‡½æ•°å’Œbarå‡½æ•°ä¸­ç¢°åˆ°ä¸¤ä¸ªæ–­ç‚¹ã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ lua setbpbysrc.lua</span><br><span class="line">no package name specified!</span><br><span class="line">no valid line number specified!</span><br><span class="line">Lua (field)foo /usr/<span class="built_in">local</span>/share/lua/5.3/testlib.lua:2</span><br><span class="line">lua_debug&gt; cont</span><br><span class="line">Lua (field)foo /usr/<span class="built_in">local</span>/share/lua/5.3/testlib.lua:3</span><br><span class="line">lua_debug&gt; cont</span><br><span class="line">Lua (field)bar /usr/<span class="built_in">local</span>/share/lua/5.3/testlib.lua:6</span><br><span class="line">lua_debug&gt; cont</span><br><span class="line">Lua (field)bar /usr/<span class="built_in">local</span>/share/lua/5.3/testlib.lua:7</span><br><span class="line">lua_debug&gt;</span><br></pre></td></tr></table></figure>

<p>ç»§ç»­æ‰§è¡Œï¼Œåˆ†åˆ«åœ¨fooå‡½æ•°å’Œbarå‡½æ•°ä¸­ç¢°åˆ°ä¸€ä¸ªæ–­ç‚¹ã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">lua_debug&gt; cont</span><br><span class="line">Lua (field)foo /usr/<span class="built_in">local</span>/share/lua/5.3/testlib.lua:3</span><br><span class="line">lua_debug&gt; cont</span><br><span class="line">Lua (field)bar /usr/<span class="built_in">local</span>/share/lua/5.3/testlib.lua:7</span><br><span class="line">lua_debug&gt;</span><br></pre></td></tr></table></figure>

<p>ç»§ç»­æ‰§è¡Œï¼Œæ²¡æœ‰å†ç¢°åˆ°æ–­ç‚¹ã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">lua_debug&gt; cont</span><br><span class="line">$</span><br></pre></td></tr></table></figure>



<h3 id="æµ‹è¯•è¡Œå·æ‰©å±•"><a href="#æµ‹è¯•è¡Œå·æ‰©å±•" class="headerlink" title="æµ‹è¯•è¡Œå·æ‰©å±•"></a>æµ‹è¯•è¡Œå·æ‰©å±•</h3><p>ç¼–å†™å¦‚ä¸‹æµ‹è¯•è„šæœ¬ï¼Œåœ¨mainchunkä¸­æ·»åŠ äº†4ä¸ªæ–­ç‚¹ï¼Œå…¶ä¸­ä¸æŒ‡å®šè¡Œå·æ—¶é»˜è®¤æ˜¯mainchunkçš„ç¬¬ä¸€ä¸ªæœ‰æ•ˆè¡Œã€‚å½“requireè¯¥åŒ…æ—¶ï¼Œé¢„æœŸåœ¨mainchunkçš„ç¬¬3è¡Œã€ç¬¬7è¡Œã€ç¬¬9è¡Œå’Œç¬¬13è¡Œåˆ†åˆ«ç¢°åˆ°æ–­ç‚¹ã€‚</p>
<p>æ¥ç€åœ¨å­å‡½æ•°fooä¸­æ·»åŠ ä¸¤ä¸ªæ–­ç‚¹ï¼Œè°ƒç”¨fooå‡½æ•°ï¼Œé¢„æœŸåœ¨fooå‡½æ•°ç¬¬2è¡Œå’Œç¬¬3è¡Œç¢°åˆ°æ–­ç‚¹ã€‚ç„¶åå…¶ä¸­ä¸€ä¸ªæ–­ç‚¹ï¼Œå†è°ƒç”¨fooå‡½æ•°ï¼Œé¢„æœŸåœ¨fooå‡½æ•°ç¬¬3è¡Œç¢°åˆ°æ–­ç‚¹ã€‚æœ€ååˆ é™¤å‰©ä½™ä¸€ä¸ªæ–­ç‚¹ï¼Œå†è°ƒç”¨fooå‡½æ•°ï¼Œé¢„æœŸä¸å†ç¢°åˆ°æ–­ç‚¹ã€‚</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> ldb = <span class="built_in">require</span> <span class="string">&quot;luadebug&quot;</span></span><br><span class="line"><span class="keyword">local</span> setbp = ldb.setbreakpoint</span><br><span class="line"><span class="keyword">local</span> rmbp = ldb.removebreakpoint</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> id1 = setbp(<span class="string">&quot;testlib:&quot;</span>)       <span class="comment">-- main 3</span></span><br><span class="line"><span class="keyword">local</span> id2 = setbp(<span class="string">&quot;testlib:-5&quot;</span>)     <span class="comment">-- main 7</span></span><br><span class="line"><span class="keyword">local</span> id3 = setbp(<span class="string">&quot;testlib:-9&quot;</span>)     <span class="comment">-- main 9</span></span><br><span class="line"><span class="keyword">local</span> id4 = setbp(<span class="string">&quot;testlib:-13&quot;</span>)    <span class="comment">-- main 13</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> lib = <span class="built_in">require</span> <span class="string">&quot;testlib&quot;</span>       <span class="comment">-- break 4 times</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> id5 = setbp(<span class="string">&quot;testlib:2&quot;</span>)      <span class="comment">-- foo 2</span></span><br><span class="line"><span class="keyword">local</span> id6 = setbp(<span class="string">&quot;testlib:3&quot;</span>)      <span class="comment">-- foo 3</span></span><br><span class="line"></span><br><span class="line">lib.foo()   <span class="comment">-- break 2 times</span></span><br><span class="line"></span><br><span class="line">rmbp(id5)</span><br><span class="line"></span><br><span class="line">lib.foo()   <span class="comment">-- break 1 time</span></span><br><span class="line"></span><br><span class="line">rmbp(id6)</span><br><span class="line"></span><br><span class="line">lib.foo()   <span class="comment">-- not break</span></span><br></pre></td></tr></table></figure>



<p>è¿è¡Œæµ‹è¯•è„šæœ¬ï¼Œé¦–å…ˆç¢°åˆ°äº†mainchunkä¸­çš„4ä¸ªæ–­ç‚¹</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">lua mainchunk.lua</span><br><span class="line">main ()nil /usr/<span class="built_in">local</span>/share/lua/5.3/testlib.lua:3</span><br><span class="line">lua_debug&gt; cont</span><br><span class="line">main ()nil /usr/<span class="built_in">local</span>/share/lua/5.3/testlib.lua:7</span><br><span class="line">lua_debug&gt; cont</span><br><span class="line">main ()nil /usr/<span class="built_in">local</span>/share/lua/5.3/testlib.lua:9</span><br><span class="line">lua_debug&gt; cont</span><br><span class="line">main ()nil /usr/<span class="built_in">local</span>/share/lua/5.3/testlib.lua:13</span><br><span class="line">lua_debug&gt;</span><br></pre></td></tr></table></figure>

<p>ç»§ç»­æ‰§è¡Œï¼Œç¢°åˆ°fooå‡½æ•°ä¸­ä¸¤ä¸ªæ–­ç‚¹</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">lua_debug&gt; cont</span><br><span class="line">Lua (field)foo /usr/<span class="built_in">local</span>/share/lua/5.3/testlib.lua:2</span><br><span class="line">lua_debug&gt; cont</span><br><span class="line">Lua (field)foo /usr/<span class="built_in">local</span>/share/lua/5.3/testlib.lua:3</span><br><span class="line">lua_debug&gt;</span><br></pre></td></tr></table></figure>

<p>å†ç»§ç»­æ‰§è¡Œï¼Œç¢°åˆ°fooå‡½æ•°ä¸­ä¸€ä¸ªæ–­ç‚¹</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">lua_debug&gt; cont</span><br><span class="line">Lua (field)foo /usr/<span class="built_in">local</span>/share/lua/5.3/testlib.lua:3</span><br><span class="line">lua_debug&gt;</span><br></pre></td></tr></table></figure>

<p>å†contå°±ç»“æŸäº†ã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">lua_debug&gt; cont</span><br><span class="line">$</span><br></pre></td></tr></table></figure>



<h3 id="æµ‹è¯•æ–­ç‚¹é‡å¤åŠç¼“å­˜æºæ–‡ä»¶çš„å‡½æ•°"><a href="#æµ‹è¯•æ–­ç‚¹é‡å¤åŠç¼“å­˜æºæ–‡ä»¶çš„å‡½æ•°" class="headerlink" title="æµ‹è¯•æ–­ç‚¹é‡å¤åŠç¼“å­˜æºæ–‡ä»¶çš„å‡½æ•°"></a>æµ‹è¯•æ–­ç‚¹é‡å¤åŠç¼“å­˜æºæ–‡ä»¶çš„å‡½æ•°</h3><p>ç¼–å†™å¦‚ä¸‹æµ‹è¯•è„šæœ¬ï¼Œé¦–å…ˆæˆ‘ä»¬é€šè¿‡å‡½æ•°æ·»åŠ ä¸€ä¸ªæ–­ç‚¹ï¼Œç„¶åå†é€šè¿‡åŒ…åæ·»åŠ ä¸€ä¸ªæ–­ç‚¹ã€‚è™½ç„¶è¿™ä¸¤ä¸ªå®é™…æ˜¯åŒä¸€ä¸ªæ–­ç‚¹ï¼Œä½†æ˜¯åˆšå¼€å§‹çš„æ—¶å€™å› ä¸ºè¿˜æ²¡æœ‰ç¼“å­˜ä¿¡æ¯ï¼Œæ‰€ä»¥ç¬¬äºŒä¸ªæ–­ç‚¹ä¹Ÿä¼šæ·»åŠ æˆåŠŸã€‚æ¥ç€è°ƒç”¨ fooå‡½æ•°ï¼Œé¢„æœŸåœ¨fooå‡½æ•°ç¬¬2è¡Œç¢°åˆ°æ–­ç‚¹ã€‚åœ¨é’©å­å‡½æ•°calläº‹ä»¶ä¸­ä¼šå¤„ç†æœªè½¬æ¢çš„æ–­ç‚¹2ï¼Œå› ä¸ºå·²ç»å­˜åœ¨åŒæ ·çš„æ–­ç‚¹äº†ï¼Œæ‰€ä»¥ä¼šå°†æ–­ç‚¹2åˆ é™¤ã€‚</p>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬åˆ é™¤æ–­ç‚¹1ä¹‹åï¼Œå°±æ²¡æœ‰æ–­ç‚¹äº†ï¼Œå†æ¬¡è°ƒç”¨fooå‡½æ•°ï¼Œé¢„æœŸä¸ä¼šç¢°åˆ°æ–­ç‚¹ã€‚</p>
<p>ç„¶åæˆ‘ä»¬å†é€šè¿‡åŒ…åæ·»åŠ ä¸€ä¸ªæ–­ç‚¹ï¼Œè¿™é‡Œå› ä¸ºå·²ç»æœ‰äº†å¯¹åº”çš„å‡½æ•°ä¿¡æ¯ï¼Œæ‰€ä»¥é¢„æœŸä¼šç›´æ¥è½¬æ¢æˆå¯¹åº”çš„å‡½æ•°æ–­ç‚¹ã€‚å½“æˆ‘ä»¬å†å¯¹å‡½æ•°æ·»åŠ åŒæ ·çš„æ–­ç‚¹çš„æ—¶å€™é¢„æœŸè¿”å›ä¹‹å‰çš„æ–­ç‚¹å·ã€‚</p>
<p>è°ƒç”¨fooå‡½æ•°ï¼Œé¢„æœŸåœ¨fooå‡½æ•°ç¬¬3è¡Œç¢°åˆ°æ–­ç‚¹ã€‚åˆ é™¤æ–­ç‚¹3ï¼Œé¢„æœŸä¸å†ç¢°åˆ°æ–­ç‚¹ã€‚</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> ldb = <span class="built_in">require</span> <span class="string">&quot;luadebug&quot;</span></span><br><span class="line"><span class="keyword">local</span> lib = <span class="built_in">require</span> <span class="string">&quot;testlib&quot;</span></span><br><span class="line"><span class="keyword">local</span> setbp = ldb.setbreakpoint</span><br><span class="line"><span class="keyword">local</span> rmbp = ldb.removebreakpoint</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> id1 = setbp(lib.foo)</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> id2 = setbp(<span class="string">&quot;testlib:1&quot;</span>)  <span class="comment">-- foo 2</span></span><br><span class="line"></span><br><span class="line">lib.foo()   <span class="comment">-- break once</span></span><br><span class="line"></span><br><span class="line">rmbp(id1)</span><br><span class="line"></span><br><span class="line">lib.foo()   <span class="comment">-- not break</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;not break&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> id3 = setbp(<span class="string">&quot;testlib:3&quot;</span>)  <span class="comment">-- foo 3</span></span><br><span class="line"><span class="built_in">assert</span>(id3 == <span class="number">3</span>)</span><br><span class="line"><span class="keyword">local</span> id4 = setbp(lib.foo, <span class="number">3</span>)</span><br><span class="line"><span class="built_in">assert</span>(id3 == id4)</span><br><span class="line"></span><br><span class="line">lib.foo()   <span class="comment">-- break once</span></span><br><span class="line"></span><br><span class="line">rmbp(id3)</span><br><span class="line"></span><br><span class="line">lib.foo()   <span class="comment">-- not break</span></span><br></pre></td></tr></table></figure>



<p>è¿è¡Œæµ‹è¯•è„šæœ¬ï¼Œç»“æœç¬¦åˆé¢„æœŸã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ lua srcfuncmap.lua</span><br><span class="line">Lua (field)foo /usr/<span class="built_in">local</span>/share/lua/5.3/testlib.lua:2</span><br><span class="line">lua_debug&gt; cont</span><br><span class="line">not <span class="built_in">break</span></span><br><span class="line">Lua (field)foo /usr/<span class="built_in">local</span>/share/lua/5.3/testlib.lua:3</span><br><span class="line">lua_debug&gt; cont</span><br></pre></td></tr></table></figure>









]]></content>
      <categories>
        <category>ç¼–ç¨‹å¼€å‘</category>
        <category>Lua</category>
      </categories>
      <tags>
        <tag>Lua</tag>
        <tag>è°ƒè¯•</tag>
      </tags>
  </entry>
  <entry>
    <title>Luaä¸­å¦‚ä½•å®ç°ç±»ä¼¼gdbçš„æ–­ç‚¹è°ƒè¯•â€”09æ”¯æŒåŠ¨æ€æ·»åŠ å’Œåˆ é™¤æ–­ç‚¹</title>
    <url>/posts/1fdd30ce/</url>
    <content><![CDATA[<div class="note primary">
            <p>å‰é¢å·²ç»æ”¯æŒäº†å‡ ç§ä¸åŒçš„æ–¹å¼æ·»åŠ æ–­ç‚¹ï¼Œä½†æ˜¯å¿…é¡»äº‹å…ˆåœ¨ä»£ç ä¸­æ·»åŠ æ–­ç‚¹ï¼Œåœ¨ä½¿ç”¨ä¸Šä¸æ˜¯é‚£ä¹ˆçµæ´»æ–¹ä¾¿ã€‚æœ¬æ–‡å°†æ”¯æŒåŠ¨æ€å¢åˆ æ–­ç‚¹ï¼Œåªéœ€è¦å¼€ä¸€å¼€å§‹å¼•å…¥è°ƒè¯•åº“å³å¯ï¼Œåç»­å¯ä»¥åœ¨è°ƒè¯•è¿‡ç¨‹ä¸­åŠ¨æ€çš„æ·»åŠ å’Œåˆ é™¤æ–­ç‚¹ã€‚äº‹ä¸å®œè¿Ÿï¼Œæˆ‘ä»¬ç›´æ¥è¿›å…¥æ­£é¢˜ã€‚</p>
          </div>

<span id="more"></span>

<p>æºç å·²ç»ä¸Šä¼ <a href="https://github.com/catbro666/lua-debugger">Github</a>ï¼Œæ¬¢è¿watch&#x2F;starğŸ˜˜ã€‚</p>
<h2 id="å®ç°åˆ†æ"><a href="#å®ç°åˆ†æ" class="headerlink" title="å®ç°åˆ†æ"></a>å®ç°åˆ†æ</h2><h3 id="å…¥å£æ–­ç‚¹"><a href="#å…¥å£æ–­ç‚¹" class="headerlink" title="å…¥å£æ–­ç‚¹"></a>å…¥å£æ–­ç‚¹</h3><p>å°½ç®¡æˆ‘ä»¬ç›®æ ‡æ˜¯æ”¯æŒåŠ¨æ€æ·»åŠ æ–­ç‚¹ï¼Œä½†è¿˜æ˜¯éœ€è¦ä¸€ä¸ªå…¥å£ï¼Œæä¾›ç”¨æˆ·æ·»åŠ åˆå§‹çš„æ–­ç‚¹ã€‚ä»ç„¶åƒä¹‹å‰ä¸€æ ·ï¼Œåœ¨ç”¨æˆ·ä»£ç ä¸­æ˜¾å¼æ·»åŠ çš„ç¡®å¯ä»¥ï¼Œä½†æ˜¾ç„¶ä¸æ˜¯æˆ‘ä»¬æƒ³è¦æ•ˆæœã€‚ç†æƒ³çš„æ•ˆæœå°±æ˜¯ç”¨æˆ·å¼€å§‹è°ƒè¯•ç¨‹åºï¼Œå°±è‡ªåŠ¨åœåœ¨å…¥å£å¤„ï¼Œç­‰å¾…ç”¨æˆ·è¾“å…¥äº¤äº’ä¿¡æ¯ï¼Œå°±åƒgdbé‚£æ ·ã€‚</p>
<p>å› ä¸ºå¼•å…¥è°ƒè¯•åº“è¿™ä¸ªåŠ¨ä½œæ˜¯è‚¯å®šè¦åšçš„ï¼Œæ‰€ä»¥æœ€æ–¹ä¾¿çš„æ–¹å¼å°±æ˜¯åœ¨å¼•å…¥è¿™ä¸ªåº“çš„æ—¶å€™å°±ç›´æ¥åœåˆ°å…¥å£æ–­ç‚¹ã€‚æˆ‘ä»¬å¯ä»¥åœ¨è°ƒè¯•åº“ä¸­å®ç°ä¸€ä¸ªinitæ–¹æ³•ï¼Œåœ¨requireè¿™ä¸ªè°ƒè¯•åº“ä¹‹åè°ƒç”¨initè¿›å…¥è°ƒè¯•å…¥å£ï¼Œç±»ä¼¼ä¸‹é¢è¿™æ ·</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="built_in">require</span>(<span class="string">&quot;luadebug&quot;</span>).init()</span><br></pre></td></tr></table></figure>

<p>ç”¨æˆ·ä»£ç ä¸­åªéœ€è¦æ·»åŠ è¿™æ ·ä¸€è¡Œï¼Œæ— éœ€å…¶ä»–ä»»ä½•æ”¹åŠ¨ï¼Œåç»­å°±å¯ä»¥äº¤äº’æ¨¡å¼ä¸­åŠ¨æ€æ·»åŠ æ–­ç‚¹äº†ã€‚</p>
<h3 id="æ”¯æŒåŠ¨æ€æ·»åŠ æ–­ç‚¹"><a href="#æ”¯æŒåŠ¨æ€æ·»åŠ æ–­ç‚¹" class="headerlink" title="æ”¯æŒåŠ¨æ€æ·»åŠ æ–­ç‚¹"></a>æ”¯æŒåŠ¨æ€æ·»åŠ æ–­ç‚¹</h3><p>è¦åœ¨äº¤äº’æ¨¡å¼ä¸­åŠ¨æ€æ·»åŠ æ–­ç‚¹ï¼Œæˆ‘ä»¬çš„æ¥å£å‡½æ•°å¦‚æ·»åŠ æ–­ç‚¹å‡½æ•°ã€åˆ é™¤æ–­ç‚¹å‡½æ•°å°±éœ€è¦åœ¨äº¤äº’æ¨¡å¼çš„ä½œç”¨åŸŸä¸­å¯è§ï¼Œæ‰€ä»¥éœ€è¦å°†å…¬å…±æ¥å£å‡½æ•°æ”¾åˆ°<code>_G</code>æˆ–<code>_ENV</code>ä¸­ã€‚ä½†æ˜¯æ”¾åˆ°è¿™æ ·çš„å…¨å±€è¡¨ä¸­ï¼Œå¯èƒ½å‡ºç°åå­—å†²çªçš„æƒ…å†µï¼Œéœ€è¦æ”¯æŒé€šè¿‡å‚æ•°è‡ªå®šä¹‰æ¥å£å‡½æ•°çš„åç§°ã€‚</p>
<p>æ”¯æŒäº†åŠ¨æ€æ–­ç‚¹ä¹‹åï¼ŒåŸæœ¬åœ¨calläº‹ä»¶ä¸­åˆ¤æ–­å‡½æ•°æ˜¯å¦æœ‰æ–­ç‚¹å¹¶è®°å½•åœ¨status.stackinfosä¸­ï¼Œç„¶ååœ¨returnäº‹ä»¶ä¸­æŸ¥è¯¢è¯¥å€¼çš„æœºåˆ¶å°±å¤±æ•ˆäº†ã€‚å› ä¸ºéšæ—¶å¯ä»¥åŠ¨æ€å¢åˆ æ–­ç‚¹ï¼Œæ‰€ä»¥åœ¨callå’Œreturnäº‹ä»¶éƒ½éœ€è¦å®æ—¶è¿›è¡Œåˆ¤æ–­ï¼Œç„¶åæ ¹æ®ç»“æœå†³å®šæ˜¯å¦æ·»åŠ æˆ–åˆ é™¤lineäº‹ä»¶ã€‚</p>
<p>å¦å¤–ä¸ºäº†æ–¹ä¾¿æ·»åŠ æ–­ç‚¹ï¼Œæ‰©å±•æ–­ç‚¹æ·»åŠ å‡½æ•°ä»¥æ”¯æŒç”¨â€.â€è¡¨ç¤ºå½“å‰å‡½æ•°æˆ–å½“å‰åŒ…ã€‚</p>
<h3 id="æ”¯æŒåŠ¨æ€åˆ é™¤æ–­ç‚¹"><a href="#æ”¯æŒåŠ¨æ€åˆ é™¤æ–­ç‚¹" class="headerlink" title="æ”¯æŒåŠ¨æ€åˆ é™¤æ–­ç‚¹"></a>æ”¯æŒåŠ¨æ€åˆ é™¤æ–­ç‚¹</h3><p>è¦æ”¯æŒåŠ¨æ€åˆ é™¤æ–­ç‚¹ï¼Œéœ€è¦æ·»åŠ ä¸€ä¸ªæ–­ç‚¹æ‰“å°å‡½æ•°ä»¥æŸ¥çœ‹å½“å‰çš„æ–­ç‚¹æƒ…å†µã€‚</p>
<h2 id="é’©å­å‡½æ•°"><a href="#é’©å­å‡½æ•°" class="headerlink" title="é’©å­å‡½æ•°"></a>é’©å­å‡½æ•°</h2><p>é¦–å…ˆæ¥çœ‹é’©å­å‡½æ•°ï¼Œå› ä¸ºéœ€è¦æ”¯æŒåŠ¨æ€å¢åˆ æ–­ç‚¹ï¼Œæ‰€ä»¥callå’Œreturnäº‹ä»¶éœ€è¦ç›¸åº”ä¿®æ”¹ã€‚å…ˆçœ‹calläº‹ä»¶æ”¹åŠ¨ï¼Œupdatehookeventå‡½æ•°æŠŠä¹‹å‰æ ¹æ®å‡½æ•°ä¿¡æ¯åˆ¤æ–­æ˜¯å¦æœ‰æ–­ç‚¹ï¼Œå¹¶è°ƒæ•´lineäº‹ä»¶çš„é€»è¾‘ç»™å°è£…èµ·æ¥äº†ï¼Œå› ä¸ºç°åœ¨åœ¨returnäº‹ä»¶ä¸­ä¹Ÿéœ€è¦è¿›è¡Œè¿™äº›æ“ä½œã€‚è€Œstatus.stackinfosä¸­åˆ™ä¸å†ç¼“å­˜hasbreakï¼Œå› ä¸ºæ”¯æŒåŠ¨æ€æ·»åŠ æ–­ç‚¹åï¼Œéœ€è¦å®æ—¶åˆ¤æ–­äº†ã€‚</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">hook</span> <span class="params">(event, line)</span></span></span><br><span class="line">    <span class="keyword">local</span> s = <span class="built_in">status</span></span><br><span class="line">    <span class="keyword">if</span> event == <span class="string">&quot;call&quot;</span> <span class="keyword">or</span> event == <span class="string">&quot;tail call&quot;</span> <span class="keyword">then</span></span><br><span class="line">        <span class="comment">-- level 2: hook, target func</span></span><br><span class="line">        <span class="keyword">local</span> sinfo = <span class="built_in">debug</span>.<span class="built_in">getinfo</span>(<span class="number">2</span>, <span class="string">&quot;nf&quot;</span>)</span><br><span class="line">        <span class="keyword">local</span> finfo = updatehookevent(sinfo)</span><br><span class="line">        <span class="keyword">if</span> event == <span class="string">&quot;call&quot;</span> <span class="keyword">then</span>     <span class="comment">-- for tail call, just overwrite</span></span><br><span class="line">            s.stackdepth = s.stackdepth + <span class="number">1</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        s.stackinfos[s.stackdepth] =</span><br><span class="line">            &#123;stackinfo = sinfo, funcinfo = finfo&#125;</span><br><span class="line">        <span class="comment">-- çœç•¥...</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>ç„¶åæ¥çœ‹returnäº‹ä»¶çš„æ”¹åŠ¨ã€‚s.stackinfosä¸­æŠŠå½“å‰å‡½æ•°å‡ºæ ˆï¼Œè¿™è¿˜æ˜¯è·Ÿä¹‹å‰ä¸€æ ·ã€‚ç„¶åå¦‚æœå·²ç»åˆ é™¤äº†æ‰€æœ‰æ–­ç‚¹ï¼Œé‚£ä¹ˆå°†é’©å­å‡½æ•°ç§»é™¤ï¼Œå¹¶æ¸…ç©ºs.stackinfosç¼“å­˜ã€‚å¦‚æœæ ˆä¸­è¿˜æœ‰å‡½æ•°ï¼Œåˆ™è°ƒç”¨updatehookeventå‡½æ•°ï¼Œè¿™é‡Œçš„å‚æ•°æ˜¯å³å°†è¿”å›çš„å‡½æ•°çš„ä¿¡æ¯ã€‚</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">hook</span> <span class="params">(event, line)</span></span></span><br><span class="line">    <span class="comment">-- çœç•¥...</span></span><br><span class="line">        <span class="keyword">elseif</span> event == <span class="string">&quot;return&quot;</span> <span class="keyword">or</span> event == <span class="string">&quot;tail return&quot;</span> <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">if</span> s.stackdepth &gt; <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">            s.stackinfos[s.stackdepth] = <span class="literal">nil</span></span><br><span class="line">            s.stackdepth = s.stackdepth - <span class="number">1</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">if</span> s.bpnum == <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">debug</span>.<span class="built_in">sethook</span>()</span><br><span class="line">            s.stackinfos = &#123;&#125;</span><br><span class="line">            s.stackdepth = <span class="number">0</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">if</span> s.stackdepth &gt; <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">            updatehookevent(s.stackinfos[s.stackdepth].stackinfo)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="comment">-- çœç•¥...</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬æ¥çœ‹ä¸‹updatehookeventçš„å®ç°ï¼š</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">updatehookevent</span><span class="params">(stackinfo)</span></span></span><br><span class="line">    <span class="keyword">local</span> s = <span class="built_in">status</span></span><br><span class="line">    <span class="keyword">local</span> func = stackinfo.func</span><br><span class="line">    <span class="keyword">local</span> name = stackinfo.name</span><br><span class="line">    <span class="keyword">local</span> funcinfo = getfuncinfo(func)</span><br><span class="line">    <span class="keyword">local</span> hasbreak = <span class="literal">false</span></span><br><span class="line">    <span class="comment">-- check unsolved srcbp</span></span><br><span class="line">    solvesrcbp(funcinfo, func)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> funcinfo.what ~= <span class="string">&quot;C&quot;</span> <span class="keyword">then</span></span><br><span class="line">        setsrcfunc(funcinfo, func)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> s.funcbpt[func] <span class="keyword">then</span></span><br><span class="line">        hasbreak = <span class="literal">true</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> hasbreak <span class="keyword">and</span> s.namebpt[name] <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">local</span> <span class="built_in">min</span> = funcinfo.linedefined</span><br><span class="line">        <span class="keyword">local</span> <span class="built_in">max</span> = funcinfo.lastlinedefined</span><br><span class="line">        <span class="keyword">for</span> k, _ <span class="keyword">in</span> <span class="built_in">pairs</span>(s.namebpt[name]) <span class="keyword">do</span></span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">type</span>(k) == <span class="string">&quot;number&quot;</span> <span class="keyword">and</span> ((k &gt;= <span class="built_in">min</span> <span class="keyword">and</span> k &lt;= <span class="built_in">max</span>) <span class="keyword">or</span> k == <span class="number">0</span>) <span class="keyword">then</span></span><br><span class="line">                hasbreak = <span class="literal">true</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="comment">-- found breakpoint in current function</span></span><br><span class="line">    <span class="keyword">if</span> hasbreak <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">debug</span>.<span class="built_in">sethook</span>(hook, <span class="string">&quot;crl&quot;</span>)  <span class="comment">-- add &quot;line&quot; event</span></span><br><span class="line">    <span class="keyword">else</span>        <span class="comment">-- no breakpoints found</span></span><br><span class="line">        <span class="built_in">debug</span>.<span class="built_in">sethook</span>(hook, <span class="string">&quot;cr&quot;</span>)   <span class="comment">-- remove &quot;line&quot; event</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> funcinfo</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>å¤§éƒ¨åˆ†éƒ½æ˜¯ä¹‹å‰çš„calläº‹ä»¶ä¸­å¹²çš„äº‹æƒ…ï¼Œé¦–å…ˆæ£€æŸ¥srcbptä¸­æ˜¯å¦æœ‰å½“å‰åŒ…ä¸­æœªè§£æçš„æ–­ç‚¹ï¼Œç„¶ååˆ¤æ–­å½“å‰å‡½æ•°æ—¶å€™æœ‰æ–­ç‚¹ï¼Œæœ‰æ–­ç‚¹æ‰“å¼€lineäº‹ä»¶ï¼Œæ²¡æœ‰æ–­ç‚¹ç§»é™¤lineäº‹ä»¶ã€‚</p>
<p>##åˆå§‹åŒ–å‡½æ•°</p>
<p>æˆ‘ä»¬åˆ†æˆä¸‰ä¸ªéƒ¨åˆ†æ¥çœ‹åˆå§‹åŒ–å‡½æ•°ï¼Œé¦–å…ˆç¬¬ä¸€éƒ¨åˆ†æ˜¯å°†å‡½æ•°æ³¨å†Œåˆ°å…¨å±€è¡¨<code>_G</code>ã€‚</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">init</span><span class="params">(name_table)</span></span></span><br><span class="line">    <span class="keyword">local</span> s = <span class="built_in">status</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">_G</span>.luadebug_inited <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">_G</span>.luadebug_inited = <span class="literal">true</span></span><br><span class="line">        <span class="keyword">if</span> name_table <span class="keyword">and</span> <span class="built_in">type</span>(name_table) == <span class="string">&quot;table&quot;</span> <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">if</span> hasdupname(name_table) <span class="keyword">then</span></span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            <span class="built_in">_G</span>[name_table[<span class="number">1</span>]] = setbreakpoint</span><br><span class="line">            <span class="built_in">_G</span>[name_table[<span class="number">2</span>]] = removebreakpoint</span><br><span class="line">            <span class="built_in">_G</span>[name_table[<span class="number">3</span>]] = printvarvalue</span><br><span class="line">            <span class="built_in">_G</span>[name_table[<span class="number">4</span>]] = setvarvalue</span><br><span class="line">            <span class="built_in">_G</span>[name_table[<span class="number">5</span>]] = printtraceback</span><br><span class="line">            <span class="built_in">_G</span>[name_table[<span class="number">6</span>]] = printbreakinfo</span><br><span class="line">            <span class="built_in">_G</span>[name_table[<span class="number">7</span>]] = help</span><br><span class="line">            hascustomnames = <span class="literal">true</span></span><br><span class="line">            customnames = name_table</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">if</span> hasdupname(longnames) <span class="keyword">then</span></span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">if</span> hasdupname(shortnames) <span class="keyword">then</span></span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            <span class="built_in">_G</span>.setbreakpoint = setbreakpoint</span><br><span class="line">            <span class="built_in">_G</span>.removebreakpoint = removebreakpoint</span><br><span class="line">            <span class="built_in">_G</span>.printvarvalue = printvarvalue</span><br><span class="line">            <span class="built_in">_G</span>.setvarvalue = setvarvalue</span><br><span class="line">            <span class="built_in">_G</span>.printtraceback = printtraceback</span><br><span class="line">            <span class="built_in">_G</span>.printbreakinfo = printbreakinfo</span><br><span class="line">            <span class="built_in">_G</span>.help = help</span><br><span class="line">            <span class="comment">-- short names</span></span><br><span class="line">            <span class="built_in">_G</span>.b = setbreakpoint</span><br><span class="line">            <span class="built_in">_G</span>.d = removebreakpoint</span><br><span class="line">            <span class="built_in">_G</span>.p = printvarvalue</span><br><span class="line">            <span class="built_in">_G</span>.bt = printtraceback</span><br><span class="line">            <span class="built_in">_G</span>.s = setvarvalue</span><br><span class="line">            <span class="built_in">_G</span>.i = printbreakinfo</span><br><span class="line">            <span class="built_in">_G</span>.h = help</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="comment">-- çœç•¥...</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>å¯é€‰å‚æ•°<code>name_table</code>ç”¨äºæŒ‡å®šè‡ªå®šä¹‰çš„å‡½æ•°åç§°ã€‚æˆ‘ä»¬æ·»åŠ äº†ä¸€ä¸ªæ ‡è®°<code>luadebug_inited</code>è¡¨ç¤ºæ˜¯å¦å·²ç»åˆå§‹åŒ–äº†å…¨å±€è¡¨ã€‚å¦‚æœè¿˜æ²¡æœ‰åˆ™è¿›è¡Œæ³¨å†Œï¼Œå¦‚æœæä¾›äº†è‡ªå®šä¹‰çš„å‡½æ•°åï¼Œåˆ™æ³¨å†Œè‡ªå®šä¹‰çš„ï¼Œå¦åˆ™æ³¨å†Œé»˜è®¤çš„å‡½æ•°åã€‚æ³¨å†Œå‰ä½¿ç”¨hasdupnameå‡½æ•°æ£€æŸ¥<code>_G</code>è¡¨ä¸­æ˜¯å¦å·²ç»æœ‰äº†åŒåçš„æˆå‘˜ï¼Œå¦‚æœæœ‰åˆ™ç»ˆæ­¢æ³¨å†Œï¼Œå‡½æ•°è¿”å›ã€‚</p>
<p>æ¥ç€çœ‹å‡½æ•°ç¬¬äºŒéƒ¨åˆ†ï¼Œè¿™éƒ¨åˆ†åœ¨è¾“å‡ºä¸€äº›æç¤ºä¿¡æ¯ådebug.debugè¿›å…¥äº¤äº’æ¨¡å¼ï¼Œè¿™å°±æ˜¯æˆ‘ä»¬ç¬¬ä¸€ä¸ªå…¥å£æ–­ç‚¹ï¼Œå¯ä»¥åœ¨è¿™é‡Œæ·»åŠ ä¸€äº›åˆå§‹çš„æ–­ç‚¹ã€‚</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">init</span><span class="params">(name_table)</span></span></span><br><span class="line">    <span class="comment">-- çœç•¥...</span></span><br><span class="line">    <span class="built_in">io</span>.<span class="built_in">write</span>(<span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">&quot;luadebug %s start ...\n&quot;</span>, version))</span><br><span class="line">    <span class="keyword">if</span> hascustomnames <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">io</span>.<span class="built_in">write</span>(<span class="string">&quot;input &#x27;&quot;</span> .. customnames[<span class="number">7</span>] .. <span class="string">&quot;()&#x27; for help info or &#x27;&quot;</span></span><br><span class="line">            .. customnames[<span class="number">7</span>] .. <span class="string">&quot;(1)&#x27; for verbose info\n&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">io</span>.<span class="built_in">write</span>(<span class="string">&quot;input &#x27;help()&#x27; for help info or &#x27;help(1)&#x27; for verbose info\n&quot;</span>)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">local</span> sinfo = <span class="built_in">debug</span>.<span class="built_in">getinfo</span>(<span class="number">2</span>, <span class="string">&quot;nfl&quot;</span>)</span><br><span class="line">    <span class="keyword">local</span> func = sinfo.func</span><br><span class="line">    <span class="keyword">local</span> name = sinfo.name</span><br><span class="line">    <span class="keyword">local</span> finfo = getfuncinfo(func)</span><br><span class="line">    <span class="keyword">local</span> prompt = <span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">&quot;%s (%s)%s %s:%d\n&quot;</span>,</span><br><span class="line">        finfo.what, sinfo.namewhat, name, finfo.short_src, sinfo.currentline)</span><br><span class="line">    <span class="built_in">io</span>.<span class="built_in">write</span>(prompt)</span><br><span class="line">    <span class="built_in">debug</span>.<span class="built_in">debug</span>()</span><br><span class="line">    <span class="comment">-- çœç•¥...</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥çœ‹å‡½æ•°çš„ç¬¬ä¸‰éƒ¨åˆ†ï¼Œè¿™éƒ¨åˆ†å¯èƒ½ä¸å¤ªå¥½ç†è§£ã€‚æˆ‘ä»¬çš„status.stackinfosæ˜¯ç”¨äºç¼“å­˜è°ƒç”¨æ ˆçš„å‡½æ•°ä¿¡æ¯çš„ï¼Œcalläº‹ä»¶æ—¶å…¥æ ˆï¼Œreturnäº‹ä»¶æ—¶å‡ºæ ˆï¼Œæˆ‘ä»¬ä¾èµ–è¿™ä¸ªç¼“å­˜çš„å‡½æ•°ä¿¡æ¯æ¥å†³å®šæ˜¯å¦æ·»åŠ lineäº‹ä»¶ã€‚ä½†æ˜¯åœ¨sethookå‡½æ•°å¯åŠ¨é’©å­ä¹‹å‰å·²ç»åœ¨è°ƒç”¨æ ˆä¸­çš„å‡½æ•°ï¼Œæˆ‘ä»¬æ˜¯æ²¡æœ‰ç¼“å­˜çš„å‡½æ•°ä¿¡æ¯çš„ï¼Œä¹Ÿå°±é€ æˆå³ä½¿æˆ‘ä»¬åœ¨è¿™äº›å‡½æ•°ä¸Šæ·»åŠ äº†æ–­ç‚¹ï¼Œä¹Ÿæ²¡æœ‰åŠæ³•çœŸæ­£æ–­åˆ°é‚£é‡Œã€‚</p>
<p>è§£å†³åŠæ³•æœ‰ä¸¤ä¸ªï¼šä¸€ä¸ªæ˜¯ä¸ä½¿ç”¨ç¼“å­˜ï¼Œæ¯æ¬¡éƒ½debug.getinfoå®æ—¶è·å–è°ƒç”¨æ ˆä¸­çš„å‡½æ•°ä¿¡æ¯ã€‚è¿™æ ·è™½ç„¶ç®€å•ï¼Œä½†æ˜¯æ€§èƒ½æœ‰ä¸€å®šæŸå¤±ã€‚ç¬¬äºŒä¸ªåŠæ³•å°±æ˜¯æˆ‘ä»¬åœ¨ç¬¬ä¸€æ¬¡è°ƒç”¨sethookå‡½æ•°å‰ï¼ŒæŠŠç¼ºå¤±çš„è°ƒç”¨æ ˆå‡½æ•°ä¿¡æ¯æ‰‹åŠ¨è¡¥ä¸Šå»ã€‚</p>
<p>åŸå…ˆæˆ‘ä»¬æ˜¯åœ¨æ·»åŠ ç¬¬ä¸€ä¸ªæ–­ç‚¹æ—¶ï¼Œdebug.sethookå¯åŠ¨é’©å­å‡½æ•°ï¼Œå› ä¸ºæˆ‘ä»¬æœ‰å¤šä¸ªæ–­ç‚¹æ·»åŠ å‡½æ•°ï¼Œä¸”å­˜åœ¨æ½œåµŒå¥—è°ƒç”¨çš„æƒ…å†µï¼Œæ‰€ä»¥å¦‚æœåœ¨æ–­ç‚¹è®¾ç½®å‡½æ•°ä¸­å¤„ç†ä»£ç ä¸Šä¼šæœ‰é‡å¤ï¼Œè€Œä¸”debug.getinfoåœ¨å±‚æ•°ä¸Šæ—¶ä¸ç¡®å®šçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å†³å®šåœ¨initå‡½æ•°ä¸­å¹²è¿™ä¸ªäº‹æƒ…ã€‚</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">init</span><span class="params">(name_table)</span></span></span><br><span class="line">    <span class="comment">-- çœç•¥...</span></span><br><span class="line">    <span class="keyword">if</span> s.bpnum &gt; <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">if</span> s.stackdepth == <span class="number">0</span> <span class="keyword">then</span>       <span class="comment">-- set hook</span></span><br><span class="line">            <span class="keyword">local</span> max_depth = <span class="number">2</span></span><br><span class="line">            <span class="keyword">while</span> ( <span class="literal">true</span> ) <span class="keyword">do</span></span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">debug</span>.<span class="built_in">getinfo</span>(max_depth, <span class="string">&quot;f&quot;</span>) <span class="keyword">then</span></span><br><span class="line">                    max_depth = max_depth - <span class="number">1</span></span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">                max_depth = max_depth + <span class="number">1</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            <span class="comment">-- init stackinfos</span></span><br><span class="line">            <span class="keyword">for</span> i=max_depth, <span class="number">1</span>, <span class="number">-1</span> <span class="keyword">do</span></span><br><span class="line">                s.stackdepth = s.stackdepth + <span class="number">1</span></span><br><span class="line">                <span class="keyword">local</span> sinfo = <span class="built_in">debug</span>.<span class="built_in">getinfo</span>(i, <span class="string">&quot;nf&quot;</span>)</span><br><span class="line">                <span class="keyword">local</span> func = sinfo.func</span><br><span class="line">                <span class="keyword">local</span> finfo = getfuncinfo(func)</span><br><span class="line">                s.stackinfos[s.stackdepth] =</span><br><span class="line">                    &#123;stackinfo = sinfo, funcinfo = finfo&#125;</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            <span class="comment">-- add sethook</span></span><br><span class="line">            s.stackdepth = s.stackdepth + <span class="number">1</span></span><br><span class="line">            s.stackinfos[s.stackdepth] =</span><br><span class="line">                &#123;stackinfo = &#123;name = <span class="string">&quot;sethook&quot;</span>, func = <span class="built_in">debug</span>.<span class="built_in">sethook</span>&#125;,</span><br><span class="line">                 funcinfo = getfuncinfo(<span class="built_in">debug</span>.<span class="built_in">sethook</span>)&#125;</span><br><span class="line">            <span class="built_in">debug</span>.<span class="built_in">sethook</span>(hook, <span class="string">&quot;cr&quot;</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">	<span class="comment">-- çœç•¥...</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>é¦–å…ˆæ£€æŸ¥æ˜¯å¦æ·»åŠ äº†æ–­ç‚¹ï¼Œå¦‚æœæ²¡æœ‰æ–­ç‚¹ä¸éœ€è¦æ·»åŠ é’©å­å‡½æ•°ã€‚ç„¶åæ£€æŸ¥å½“å‰s.stackdepthæ˜¯å¦ä¸º0ï¼Œè¿™æ˜¯è€ƒè™‘åˆ°initå‡½æ•°å¯èƒ½è¢«å¤šæ¬¡è°ƒç”¨çš„æƒ…å†µï¼Œåªæœ‰ç¬¬ä¸€æ¬¡æ‰éœ€è¦æ‰‹åŠ¨è¡¥è°ƒç”¨æ ˆä¿¡æ¯ã€‚æ¥ä¸‹æ¥çš„whileå¾ªç¯æ˜¯ä¸ºäº†æ¢æµ‹è°ƒç”¨æ ˆçš„æ·±åº¦ï¼Œä¹‹æ‰€ä»¥ä¸ä½¿ç”¨å›ºå®šå€¼ï¼Œæ˜¯è€ƒè™‘åˆ°è°ƒç”¨initå‡½æ•°çš„ä¹Ÿä¸ä¸€å®šå°±æ˜¯æœ€å¤–å±‚ã€‚ç„¶åä»æ ˆçš„æœ€æ·±å¤„å¼€å§‹ä¸€å±‚ä¸€å±‚æ·»åŠ ï¼Œæœ€åå†è¡¥ä¸Šsethookå‡½æ•°æœ¬èº«ã€‚è¡¥å……å®Œstatus.stackinfosä¿¡æ¯åå°±å¯ä»¥è°ƒç”¨debug.sethookè®¾ç½®é’©å­å‡½æ•°äº†ã€‚</p>
<p>æ—¢ç„¶æˆ‘ä»¬åœ¨initå‡½æ•°ä¸­sethookäº†ï¼Œé‚£ä¹ˆä¹‹å‰è®¾ç½®æ–­ç‚¹å‡½æ•°ä¸­çš„sethookå°±éƒ½å¯ä»¥å»æ‰äº†ã€‚</p>
<h2 id="æ–­ç‚¹æ‰“å°å‡½æ•°"><a href="#æ–­ç‚¹æ‰“å°å‡½æ•°" class="headerlink" title="æ–­ç‚¹æ‰“å°å‡½æ•°"></a>æ–­ç‚¹æ‰“å°å‡½æ•°</h2><p>æ–­ç‚¹æ‰“å°å‡½æ•°éå¸¸ç®€å•ï¼Œåªæ˜¯éå†status.bptableè¡¨ï¼Œæ‰“å°æ–­ç‚¹ä¿¡æ¯ï¼Œå¯¹åº”é€šè¿‡å‡½æ•°åå­—æ·»åŠ çš„æ–­ç‚¹æ‰“å°åå­—åŠè¡Œæ•°ï¼Œå…¶ä½™æ–­ç‚¹æ‰“å°åŒ…ååŠè¡Œæ•°ã€‚</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">printbreakinfo</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">local</span> s = <span class="built_in">status</span></span><br><span class="line">    <span class="keyword">for</span> i=<span class="number">1</span>,s.bpid <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">local</span> bp = s.bptable[i]</span><br><span class="line">        <span class="keyword">local</span> prompt</span><br><span class="line">        <span class="keyword">if</span> bp <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">if</span> bp.name <span class="keyword">then</span></span><br><span class="line">                prompt = <span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">&quot;id: %d, name: %s, line: %d\n&quot;</span>,</span><br><span class="line">                    i, bp.name, bp.line)</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                prompt = <span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">&quot;id: %d, src: %s, line: %d\n&quot;</span>,</span><br><span class="line">                    i, bp.src, bp.line)</span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            <span class="built_in">io</span>.<span class="built_in">write</span>(prompt)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>



<h2 id="å…¶ä»–"><a href="#å…¶ä»–" class="headerlink" title="å…¶ä»–"></a>å…¶ä»–</h2><p>helpå¸®åŠ©å‡½æ•°ï¼Œä»¥åŠæ‰©å±•æ–­ç‚¹æ·»åŠ å‡½æ•°æ”¯æŒç”¨â€.â€è¡¨ç¤ºå½“å‰å‡½æ•°æˆ–å½“å‰åŒ…ï¼Œæˆ‘å°±ä¸ä¸“é—¨è®²äº†ã€‚å¦å¤–ï¼Œæ—¢ç„¶æˆ‘ä»¬çš„æ¥å£å‡½æ•°å·²ç»æ”¯æŒåœ¨äº¤äº’æ¨¡å¼ä¸­åŠ¨æ€è°ƒç”¨äº†ï¼Œé‚£ä¹ˆä¹Ÿå°±ä¸éœ€è¦å†å¯¼å‡ºäº†ï¼Œæ¨¡å—åªéœ€è¦å¯¼å‡ºinitå‡½æ•°å³å¯ã€‚</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">return</span> &#123;</span><br><span class="line">    init = init,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h2><p>æˆ‘ä»¬ç¼–å†™ä¸€ä¸ªå¦‚ä¸‹çš„Luaæµ‹è¯•è„šæœ¬</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="built_in">require</span>(<span class="string">&quot;luadebug&quot;</span>).init()</span><br><span class="line"><span class="keyword">local</span> lib = <span class="built_in">require</span> <span class="string">&quot;testlib&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> g = <span class="number">1</span></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">faa</span> <span class="params">()</span></span></span><br><span class="line">    g = <span class="number">2</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">faa()</span><br><span class="line">lib.foo()</span><br><span class="line">lib.bar()</span><br><span class="line">faa()</span><br></pre></td></tr></table></figure>

<p>æµ‹è¯•åŒ…è¿˜æ˜¯è·Ÿä¹‹å‰ä¸€æ ·</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">foo</span> <span class="params">()</span></span></span><br><span class="line">    <span class="keyword">local</span> a = <span class="number">1</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">bar</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">local</span> a = <span class="number">1</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> a = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> &#123;</span><br><span class="line">    foo = foo,</span><br><span class="line">    bar = bar,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="å…¥å£è„šæœ¬ä¸­æ–­ç‚¹æµ‹è¯•"><a href="#å…¥å£è„šæœ¬ä¸­æ–­ç‚¹æµ‹è¯•" class="headerlink" title="å…¥å£è„šæœ¬ä¸­æ–­ç‚¹æµ‹è¯•"></a>å…¥å£è„šæœ¬ä¸­æ–­ç‚¹æµ‹è¯•</h3><p>é¦–å…ˆæµ‹è¯•ä»…åœ¨å…¥å£è„šæœ¬ä¸­æ·»åŠ æ–­ç‚¹</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ lua dynamictest.lua</span><br><span class="line">luadebug 0.0.1 start ...</span><br><span class="line">input <span class="string">&#x27;help()&#x27;</span> <span class="keyword">for</span> <span class="built_in">help</span> info or <span class="string">&#x27;help(1)&#x27;</span> <span class="keyword">for</span> verbose info</span><br><span class="line">main ()nil dynamictest.lua:1</span><br><span class="line">lua_debug&gt; </span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬æ·»åŠ ä¸¤ä¸ªæ–­ç‚¹ï¼Œä¸€ä¸ªæ˜¯å½“å‰åŒ…çš„ç¬¬7è¡Œï¼ŒåŠfaaå‡½æ•°çš„æœ€åä¸€è¡Œï¼Œä¸€ä¸ªæ˜¯å½“å‰å‡½æ•°å³mainchunkçš„ç¬¬9è¡Œ</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">lua_debug&gt; b(<span class="string">&quot;.:7&quot;</span>)</span><br><span class="line">lua_debug&gt; b(<span class="string">&quot;.@9&quot;</span>)</span><br><span class="line">lua_debug&gt; i()</span><br><span class="line">id: 1, src: dynamictest.lua, line: 7, refname: nil</span><br><span class="line">id: 2, src: dynamictest.lua, line: 9, refname: main</span><br><span class="line">lua_debug&gt;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬ç»§ç»­æ‰§è¡Œï¼Œé¦–å…ˆåœåœ¨äº†mainchunkçš„ç¬¬9è¡Œï¼Œæ­¤æ—¶gçš„å€¼ä¸º1ï¼Œç»§ç»­æ‰§è¡Œï¼Œåˆåœåœ¨äº†faaçš„ç¬¬7è¡Œï¼Œæ­¤æ—¶gå·²ç»æ”¹ä¸º2</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">lua_debug&gt; cont</span><br><span class="line">main ()nil dynamictest.lua:9</span><br><span class="line">lua_debug&gt; p(<span class="string">&quot;g&quot;</span>)</span><br><span class="line"><span class="built_in">local</span>	1</span><br><span class="line">lua_debug&gt; cont</span><br><span class="line">Lua (<span class="built_in">local</span>)faa dynamictest.lua:7</span><br><span class="line">lua_debug&gt; p(<span class="string">&quot;g&quot;</span>)</span><br><span class="line">upvalue	2</span><br><span class="line">lua_debug&gt; i()</span><br><span class="line">id: 1, src: dynamictest.lua, line: 7, refname: faa</span><br><span class="line">id: 2, src: dynamictest.lua, line: 9, refname: main</span><br><span class="line">lua_debug&gt;</span><br></pre></td></tr></table></figure>

<p>æ­¤æ—¶æˆ‘ä»¬åˆ é™¤ä¸¤ä¸ªæ–­ç‚¹ï¼Œå†æ¬¡ç»§ç»­æ‰§è¡Œï¼Œç¨‹åºä¸å†åœåˆ°faaä¸Š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">lua_debug&gt; d(1)</span><br><span class="line">lua_debug&gt; d(2)</span><br><span class="line">lua_debug&gt; i()</span><br><span class="line">lua_debug&gt; cont</span><br><span class="line">$ </span><br></pre></td></tr></table></figure>

<h3 id="å…¶ä»–åŒ…ä¸­æ–­ç‚¹æµ‹è¯•"><a href="#å…¶ä»–åŒ…ä¸­æ–­ç‚¹æµ‹è¯•" class="headerlink" title="å…¶ä»–åŒ…ä¸­æ–­ç‚¹æµ‹è¯•"></a>å…¶ä»–åŒ…ä¸­æ–­ç‚¹æµ‹è¯•</h3><p>æ¥ç€æµ‹è¯•ä¸‹åœ¨testlibåŒ…ä¸­æ·»åŠ æ–­ç‚¹ï¼Œé¦–å…ˆå¯åŠ¨è°ƒè¯•ï¼Œæ·»åŠ ä¸¤ä¸ªæ–­ç‚¹</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ lua dynamictest.lua</span><br><span class="line">luadebug 0.0.1 start ...</span><br><span class="line">input <span class="string">&#x27;help()&#x27;</span> <span class="keyword">for</span> <span class="built_in">help</span> info or <span class="string">&#x27;help(1)&#x27;</span> <span class="keyword">for</span> verbose info</span><br><span class="line">main ()nil dynamictest.lua:1</span><br><span class="line">lua_debug&gt; b(<span class="string">&quot;testlib:-9&quot;</span>)</span><br><span class="line">lua_debug&gt; b(<span class="string">&quot;foo@&quot;</span>)</span><br><span class="line">lua_debug&gt; i()</span><br><span class="line">id: 1, src: /usr/<span class="built_in">local</span>/share/lua/5.3/testlib.lua, line: -9, refname: nil</span><br><span class="line">id: 2, name: foo, line: 0</span><br><span class="line">lua_debug&gt;</span><br></pre></td></tr></table></figure>

<p>ç»§ç»­æ‰§è¡Œï¼Œç¨‹åºé¦–å…ˆåœåœ¨äº†testlibçš„mainchunkç¬¬9è¡Œï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œæ·»åŠ faaçš„æ–­ç‚¹</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">lua_debug&gt; cont</span><br><span class="line">main ()nil /usr/<span class="built_in">local</span>/share/lua/5.3/testlib.lua:9</span><br><span class="line">lua_debug&gt; i()</span><br><span class="line">id: 1, src: /usr/<span class="built_in">local</span>/share/lua/5.3/testlib.lua, line: 9, refname: main</span><br><span class="line">id: 2, name: foo, line: 0</span><br><span class="line">lua_debug&gt; b(<span class="string">&quot;faa@&quot;</span>)</span><br><span class="line">lua_debug&gt;</span><br></pre></td></tr></table></figure>

<p>ç»§ç»­æ‰§è¡Œï¼Œç¨‹åºå…ˆåœåœ¨faaå‡½æ•°ï¼Œç„¶ååœåœ¨fooå‡½æ•°ï¼Œæœ€åå¬åˆ°faaå‡½æ•°ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">lua_debug&gt; cont</span><br><span class="line">Lua (local)faa dynamictest.lua:6</span><br><span class="line">lua_debug&gt; cont</span><br><span class="line">Lua (field)foo /usr/local/share/lua/5.3/testlib.lua:2</span><br><span class="line">lua_debug&gt; cont</span><br><span class="line">Lua (local)faa dynamictest.lua:6</span><br><span class="line">lua_debug&gt; cont</span><br></pre></td></tr></table></figure>

<h3 id="å¤šæ¬¡åˆå§‹åŒ–æµ‹è¯•"><a href="#å¤šæ¬¡åˆå§‹åŒ–æµ‹è¯•" class="headerlink" title="å¤šæ¬¡åˆå§‹åŒ–æµ‹è¯•"></a>å¤šæ¬¡åˆå§‹åŒ–æµ‹è¯•</h3><p>æˆ‘ä»¬åœ¨testlibåŒ…å¼€å¤´æ·»åŠ ä¸€è¡Œ<code>require(&quot;luadebug&quot;).init()</code>ã€‚é¦–å…ˆä¸€æ ·åœåœ¨äº†dynamictest.luaä¸­çš„å…¥å£æ–­ç‚¹å¤„ï¼Œæˆ‘ä»¬æ·»åŠ ä¸¤ä¸ªæ–­ç‚¹ã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ lua dynamictest.lua</span><br><span class="line">luadebug 0.0.1 start ...</span><br><span class="line">input <span class="string">&#x27;help()&#x27;</span> <span class="keyword">for</span> <span class="built_in">help</span> info or <span class="string">&#x27;help(1)&#x27;</span> <span class="keyword">for</span> verbose info</span><br><span class="line">main ()nil dynamictest.lua:1</span><br><span class="line">lua_debug&gt; b(<span class="string">&quot;faa@&quot;</span>)</span><br><span class="line">lua_debug&gt; b(<span class="string">&quot;foo@&quot;</span>)</span><br><span class="line">lua_debug&gt; i()</span><br><span class="line">id: 1, name: faa, line: 0</span><br><span class="line">id: 2, name: foo, line: 0</span><br><span class="line">lua_debug&gt;</span><br></pre></td></tr></table></figure>

<p>ç„¶åç»§ç»­æ‰§è¡Œï¼Œå‘ç°ç¨‹åºåœåˆ°äº†testlibçš„å…¥å£æ–­ç‚¹å¤„ï¼Œæ–­ç‚¹æƒ…å†µæ­£å¸¸</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">lua_debug&gt; cont</span><br><span class="line">luadebug 0.0.1 start ...</span><br><span class="line">input <span class="string">&#x27;help()&#x27;</span> <span class="keyword">for</span> <span class="built_in">help</span> info or <span class="string">&#x27;help(1)&#x27;</span> <span class="keyword">for</span> verbose info</span><br><span class="line">main ()nil /usr/<span class="built_in">local</span>/share/lua/5.3/testlib.lua:1</span><br><span class="line">lua_debug&gt; bt()</span><br><span class="line">stack traceback:</span><br><span class="line">	/usr/<span class="built_in">local</span>/share/lua/5.3/testlib.lua:1: <span class="keyword">in</span> main chunk</span><br><span class="line">	[C]: <span class="keyword">in</span> <span class="keyword">function</span> <span class="string">&#x27;require&#x27;</span></span><br><span class="line">	dynamictest.lua:2: <span class="keyword">in</span> main chunk</span><br><span class="line">	[C]: <span class="keyword">in</span> ?</span><br><span class="line">lua_debug&gt; i()</span><br><span class="line">id: 1, name: faa, line: 0</span><br><span class="line">id: 2, name: foo, line: 0</span><br><span class="line">lua_debug&gt;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬ç»§ç»­æ‰§è¡Œï¼Œåœåœ¨äº†faaå‡½æ•°å¤„ï¼Œæˆ‘ä»¬åˆ é™¤æ–­ç‚¹1ï¼Œç„¶åç»§ç»­æ‰§è¡Œ</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">lua_debug&gt; cont</span><br><span class="line">Lua (<span class="built_in">local</span>)faa dynamictest.lua:6</span><br><span class="line">lua_debug&gt; d(1)</span><br><span class="line">lua_debug&gt; i()</span><br><span class="line">id: 2, name: foo, line: 0</span><br><span class="line">lua_debug&gt;</span><br></pre></td></tr></table></figure>

<p>ç¨‹åºåœåœ¨äº†fooå‡½æ•°å¤„ï¼Œå†ç»§ç»­å› ä¸ºfaaå‡½æ•°å¤„çš„æ–­ç‚¹1å·²ç»åˆ é™¤ï¼Œæ‰€ä»¥ç¨‹åºç›´æ¥ç»“æŸã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">lua_debug&gt; cont</span><br><span class="line">Lua (field)foo /usr/<span class="built_in">local</span>/share/lua/5.3/testlib.lua:3</span><br><span class="line">lua_debug&gt; cont</span><br><span class="line">$</span><br></pre></td></tr></table></figure>

<h3 id="ä»…åœ¨testlibåŒ…ä¸­åˆå§‹åŒ–"><a href="#ä»…åœ¨testlibåŒ…ä¸­åˆå§‹åŒ–" class="headerlink" title="ä»…åœ¨testlibåŒ…ä¸­åˆå§‹åŒ–"></a>ä»…åœ¨testlibåŒ…ä¸­åˆå§‹åŒ–</h3><p>æˆ‘ä»¬åˆ é™¤dynamictest.luaä¸­çš„ç¬¬ä¸€è¡Œï¼Œç»§ç»­æµ‹è¯•ï¼Œç¨‹åºç›´æ¥åœåœ¨äº†testlibåŒ…çš„å…¥å£æ–­ç‚¹ï¼Œæˆ‘ä»¬åŒæ ·æ·»åŠ ä¸¤ä¸ªæ–­ç‚¹ã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">lua dynamictest.lua</span><br><span class="line">luadebug 0.0.1 start ...</span><br><span class="line">input <span class="string">&#x27;help()&#x27;</span> <span class="keyword">for</span> <span class="built_in">help</span> info or <span class="string">&#x27;help(1)&#x27;</span> <span class="keyword">for</span> verbose info</span><br><span class="line">main ()nil /usr/<span class="built_in">local</span>/share/lua/5.3/testlib.lua:1</span><br><span class="line">lua_debug&gt; b(<span class="string">&quot;faa@&quot;</span>)</span><br><span class="line">lua_debug&gt; b(<span class="string">&quot;foo@&quot;</span>)</span><br><span class="line">lua_debug&gt; i()</span><br><span class="line">id: 1, name: faa, line: 0</span><br><span class="line">id: 2, name: foo, line: 0</span><br><span class="line">lua_debug&gt;</span><br></pre></td></tr></table></figure>

<p>ç»§ç»­æ‰§è¡Œï¼Œç¨‹åºåœåœ¨äº†faaå‡½æ•°å¤„ï¼Œæˆ‘ä»¬åˆ é™¤æ–­ç‚¹1ï¼Œç„¶åç»§ç»­æ‰§è¡Œ</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">lua_debug&gt; cont</span><br><span class="line">Lua (<span class="built_in">local</span>)faa dynamictest.lua:5</span><br><span class="line">lua_debug&gt; d(1)</span><br><span class="line">lua_debug&gt; i()</span><br><span class="line">id: 2, name: foo, line: 0</span><br><span class="line">lua_debug&gt;</span><br></pre></td></tr></table></figure>

<p>ç¨‹åºåœåœ¨äº†fooå‡½æ•°å¤„ï¼Œå†ç»§ç»­å› ä¸ºæ–­ç‚¹1å·²ç»åˆ é™¤ï¼Œæ‰€ä»¥ä¸å†åœåœ¨faaå‡½æ•°å¤„ï¼Œç¨‹åºç›´æ¥ç»“æŸã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">lua_debug&gt; cont</span><br><span class="line">Lua (field)foo /usr/<span class="built_in">local</span>/share/lua/5.3/testlib.lua:3</span><br><span class="line">lua_debug&gt; cont</span><br><span class="line">$</span><br></pre></td></tr></table></figure>

<h3 id="è‡ªå®šä¹‰å‡½æ•°åç§°åŠé‡åæµ‹è¯•"><a href="#è‡ªå®šä¹‰å‡½æ•°åç§°åŠé‡åæµ‹è¯•" class="headerlink" title="è‡ªå®šä¹‰å‡½æ•°åç§°åŠé‡åæµ‹è¯•"></a>è‡ªå®šä¹‰å‡½æ•°åç§°åŠé‡åæµ‹è¯•</h3><p>æˆ‘ä»¬åœ¨dynamictest.luaæœ€å‰é¢æ·»åŠ ä¸€è¡Œï¼š</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line">d = <span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>æµ‹è¯•è¾“å‡ºå¦‚ä¸‹ï¼Œæç¤ºé”™è¯¯ä¹‹åæ²¡æœ‰è¿›å…¥äº¤äº’æ¨¡å¼ã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ lua dynamictest.lua</span><br><span class="line">table `_G` already has element called <span class="string">&quot;d&quot;</span> please specify custom names as the following example:</span><br><span class="line">require(<span class="string">&quot;luadebug&quot;</span>).init(&#123;<span class="string">&quot;bb&quot;</span>, <span class="string">&quot;dd&quot;</span>, <span class="string">&quot;pp&quot;</span>, <span class="string">&quot;ss&quot;</span>, <span class="string">&quot;tt&quot;</span>, <span class="string">&quot;ii&quot;</span>, <span class="string">&quot;hh&quot;</span>&#125;)</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å†å°†ç¬¬äºŒè¡Œæ”¹ä¸ºå¦‚ä¸‹</p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="built_in">require</span>(<span class="string">&quot;luadebug&quot;</span>).init(&#123;<span class="string">&quot;bb&quot;</span>, <span class="string">&quot;dd&quot;</span>, <span class="string">&quot;pp&quot;</span>, <span class="string">&quot;ss&quot;</span>, <span class="string">&quot;tt&quot;</span>, <span class="string">&quot;ii&quot;</span>, <span class="string">&quot;hh&quot;</span>&#125;)</span><br></pre></td></tr></table></figure>

<p>ç„¶åé‡æ–°æµ‹è¯•ï¼Œå¯ä»¥çœ‹åˆ°å‡½æ•°åå·²ç»é¡ºåˆ©ä¿®æ”¹</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">lua dynamictest.lua</span><br><span class="line">luadebug 0.0.1 start ...</span><br><span class="line">input <span class="string">&#x27;hh()&#x27;</span> <span class="keyword">for</span> <span class="built_in">help</span> info or <span class="string">&#x27;hh(1)&#x27;</span> <span class="keyword">for</span> verbose info</span><br><span class="line">main ()nil dynamictest.lua:2</span><br><span class="line">lua_debug&gt; bb(<span class="string">&quot;faa@&quot;</span>)</span><br><span class="line">lua_debug&gt; bb(<span class="string">&quot;foo@&quot;</span>)</span><br><span class="line">lua_debug&gt; ii()</span><br><span class="line">id: 1, name: faa, line: 0</span><br><span class="line">id: 2, name: foo, line: 0</span><br><span class="line">lua_debug&gt;</span><br></pre></td></tr></table></figure>

<p>ç»§ç»­æ‰§è¡Œï¼Œä¸€åˆ‡æ­£å¸¸ã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">lua_debug&gt; cont</span><br><span class="line">luadebug 0.0.1 start ...</span><br><span class="line">input <span class="string">&#x27;hh()&#x27;</span> <span class="keyword">for</span> <span class="built_in">help</span> info or <span class="string">&#x27;hh(1)&#x27;</span> <span class="keyword">for</span> verbose info</span><br><span class="line">main ()nil /usr/<span class="built_in">local</span>/share/lua/5.3/testlib.lua:1</span><br><span class="line">lua_debug&gt; cont</span><br><span class="line">Lua (<span class="built_in">local</span>)faa dynamictest.lua:7</span><br><span class="line">lua_debug&gt; dd(1)</span><br><span class="line">lua_debug&gt; cont</span><br><span class="line">Lua (field)foo /usr/<span class="built_in">local</span>/share/lua/5.3/testlib.lua:3</span><br><span class="line">lua_debug&gt; tt()</span><br><span class="line">stack traceback:</span><br><span class="line">	/usr/<span class="built_in">local</span>/share/lua/5.3/testlib.lua:3: <span class="keyword">in</span> <span class="keyword">function</span> <span class="string">&#x27;testlib.foo&#x27;</span></span><br><span class="line">	dynamictest.lua:11: <span class="keyword">in</span> main chunk</span><br><span class="line">	[C]: <span class="keyword">in</span> ?</span><br><span class="line">lua_debug&gt; cont</span><br><span class="line">$</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>ç¼–ç¨‹å¼€å‘</category>
        <category>Lua</category>
      </categories>
      <tags>
        <tag>Lua</tag>
        <tag>è°ƒè¯•</tag>
      </tags>
  </entry>
  <entry>
    <title>OpenResty Luaé’©å­è°ƒç”¨å®Œæ•´æµç¨‹</title>
    <url>/posts/30b81f82/</url>
    <content><![CDATA[<div class="note primary">
            <p>å‰é¢ä¸€ç¯‡æ–‡ç« ä»‹ç»äº†<a href="../150430f0/">Openresty Luaåç¨‹è°ƒåº¦æœºåˆ¶</a>ï¼Œä¸»è¦å…³å¿ƒçš„æ˜¯æ ¸å¿ƒè°ƒåº¦å‡½æ•°<code>run_thread()</code>å†…éƒ¨å‘ç”Ÿçš„äº‹æƒ…ï¼Œè€Œå¯¹äºå¤–éƒ¨çš„äº‹æƒ…æˆ‘ä»¬å¹¶æ²¡æœ‰æ¶‰åŠã€‚æœ¬ç¯‡ä½œä¸ºå…¶å§Šå¦¹ç¯‡ï¼Œå‡†å¤‡è¡¥ä¸Šå‰©ä½™çš„éƒ¨åˆ†ã€‚æœ¬ç¯‡å°†é€šè¿‡ä¸€ä¸ªä¾‹å­ï¼Œå®Œæ•´ä»‹ç»OpenRestyä¸­Luaé’©å­çš„è°ƒç”¨æµç¨‹ï¼ŒåŒ…æ‹¬åˆå§‹åŒ–é˜¶æ®µçš„å·¥ä½œã€æ–°è¿æ¥è¿›æ¥æ—¶å¦‚ä½•è¿›å…¥é’©å­ã€I&#x2F;Oç­‰å¾…æ—¶å¦‚ä½•å‡ºå»ã€äº‹ä»¶è§¦å‘æ—¶å¦‚ä½•æ¢å¤ã€é’©å­æ­£å¸¸æ‰§è¡Œç»“æŸæ—¶çš„æ“ä½œã€é’©å­å†…å‡ºé”™çš„æƒ…å†µã€‚æœ¬æ–‡åŒæ ·æ˜¯åŸºäº<code>stream-lua</code>æ¨¡å—çš„ä»£ç ã€‚</p>
          </div>

<span id="more"></span>

<h1 id="æ•´ä½“æµç¨‹"><a href="#æ•´ä½“æµç¨‹" class="headerlink" title="æ•´ä½“æµç¨‹"></a>æ•´ä½“æµç¨‹</h1><p>æˆ‘ä»¬ä»¥<code>ssl_certificate_by_lua*</code>é’©å­ä¸ºä¾‹æ¥è¿›è¡Œä»‹ç»ï¼Œä¸€æ¥æ˜¯å› ä¸ºå®ƒè¿˜æ¶‰åŠSSLæ¡æ‰‹ï¼Œæµç¨‹ä¸Šæ›´é•¿ä¸€ç‚¹ã€‚äºŒæ¥æ˜¯å› ä¸ºåœ¨å…¶ä¸Šä¸‹æ–‡ä¸­æ˜¯<code>YIELDABLE</code>çš„ï¼Œæ”¯æŒçš„<code>ngx</code>æ¥å£æ¯”è¾ƒå®Œæ•´ã€‚</p>
<p>æˆ‘ä»¬å°†ä»¥ä¸‹é¢ä¸¤ä¸ªé…ç½®ä¸ºä¾‹æ¥å±•å¼€ä»‹ç»ã€‚ä¾‹å­éå¸¸ç®€å•ï¼Œç¬¬ä¸€ä¸ªæ˜¯æ­£å¸¸çš„ç»“æŸæƒ…å†µåœ¨<code>ssl_certificate_by_lua_block</code>é‡Œé¢è°ƒç”¨äº†<code>ngx.sleep()</code>ã€‚ç¬¬äºŒä¸ªæ˜¯å‡ºé”™ä¸­æ­¢çš„æƒ…å†µï¼Œå¤šäº†ä¸€ä¸ª<code>ngx.exit(ngx.ERROR)</code>ã€‚</p>
<figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">443</span> ssl;</span><br><span class="line">    <span class="section">ssl_certificate_by_lua_block</span> &#123;</span><br><span class="line">        ngx.sleep(0.1)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="attribute">ssl_certificate</span> test.pem;</span><br><span class="line">    <span class="attribute">ssl_certificate_key</span> test.key;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">443</span> ssl;</span><br><span class="line">    <span class="section">ssl_certificate_by_lua_block</span> &#123;</span><br><span class="line">        ngx.sleep(0.1)</span><br><span class="line">        ngx.exit(ngx.ERROR)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="attribute">ssl_certificate</span> test.pem;</span><br><span class="line">    <span class="attribute">ssl_certificate_key</span> test.key;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é¦–å…ˆï¼Œåˆ†åˆ«æ¥çœ‹ä¸€ä¸‹åˆå§‹åŒ–é˜¶æ®µå’Œè¿æ¥é˜¶æ®µçš„æ•´ä½“æµç¨‹ã€‚åé¢ç« èŠ‚ä¼šç»“åˆå®é™…ä»£ç ï¼Œæ¥è¯¦ç»†ä»‹ç»æ¯ç§æƒ…å†µä¸‹æ˜¯å¦‚ä½•å¤„ç†çš„ã€‚</p>
<h2 id="åˆå§‹åŒ–é˜¶æ®µ"><a href="#åˆå§‹åŒ–é˜¶æ®µ" class="headerlink" title="åˆå§‹åŒ–é˜¶æ®µ"></a>åˆå§‹åŒ–é˜¶æ®µ</h2><p><img src="https://cdn.jsdelivr.net/gh/catbro666/catbro666.github.io/posts/30b81f82/openresty-lua-hook-flow-init-phase.svg" alt="openresty-lua-hook-flow-init-phase" loading="lazy"></p>
<p>åˆå§‹åŒ–é˜¶æ®µçš„æµç¨‹æ¯”è¾ƒç®€å•ï¼šé…ç½®è§£æé˜¶æ®µä¼šè¯»å–é…ç½®æ–‡ä»¶ä¸­çš„ä»£ç å—è¿›è¡Œè§£æä¿å­˜ï¼Œç„¶ååˆ›å»ºLuaä»£ç çš„keyï¼Œè¿™ä¸ªkeyæ˜¯ç”¨äºåé¢å°†ä»£ç cacheåˆ°æ³¨å†Œè¡¨çš„ã€‚é…ç½®åˆå¹¶é˜¶æ®µï¼Œä¸»è¦æ˜¯åˆå¹¶é…ç½®é¡¹ï¼Œç„¶åè®¾ç½®<code>cert_cb</code>å›è°ƒã€‚é…ç½®åå¤„ç†é˜¶æ®µï¼Œä¸»è¦å·¥ä½œæ˜¯åˆå§‹åŒ–Lua VMï¼ŒåŒ…æ‹¬åˆ›å»ºæ³¨å†Œè¡¨é¡¹ã€åˆ›å»ºå…¨å±€è¡¨é¡¹<code>ngx</code>ã€æ›¿æ¢coroutineæ¥å£ã€‚</p>
<h2 id="è¿æ¥é˜¶æ®µ"><a href="#è¿æ¥é˜¶æ®µ" class="headerlink" title="è¿æ¥é˜¶æ®µ"></a>è¿æ¥é˜¶æ®µ</h2><p><img src="https://cdn.jsdelivr.net/gh/catbro666/catbro666.github.io/posts/30b81f82/openresty-lua-hook-flow-connect-phase.svg" alt="openresty-lua-hook-flow-connect-phase" loading="lazy"></p>
<p>è¿æ¥é˜¶æ®µå› ä¸ºæ¶‰åŠæ–°è¿æ¥è¿›å…¥é’©å­ã€I&#x2F;Oç­‰å¾…æ—¶å‡ºå»ã€äº‹ä»¶è§¦å‘æ—¶æ¢å¤ã€é’©å­æ­£å¸¸æ‰§è¡Œç»“æŸï¼ˆYIELDä¹‹åï¼‰ã€é’©å­å†…å‡ºé”™ï¼ˆYIELDä¹‹åï¼‰ç­‰å„ç§æƒ…å†µï¼Œç›¸å¯¹æ¯”è¾ƒå¤æ‚ã€‚å›¾ä¸­ç”¨ä¸åŒé¢œè‰²åˆ†åˆ«è¡¨ç¤ºè¿™å‡ ç§ä¸åŒçš„æƒ…å†µï¼Œæ¯ç§é¢œè‰²åˆç”¨æ•°å­—æ ‡è¯†äº†å…¶æµç¨‹é¡ºåºã€‚è¯»è€…å¯ä»¥ç»“åˆè¿™ä¸ªå›¾ï¼Œé˜…è¯»åç»­æ¯ä¸ªé˜¶æ®µçš„ä»£ç ï¼Œåº”è¯¥èƒ½å¤Ÿå¸®åŠ©æ‚¨æ›´å¥½åœ°ç†è§£ã€‚</p>
<p>å¦å¤–æä¸€ä¸‹ï¼Œæœ¬æ–‡æ²¡æœ‰æ¶‰åŠLuaä»£ç æ‰§è¡Œè¿‡ç¨‹æ²¡æœ‰ç¢°åˆ°YIELDå°±ç›´æ¥å®Œæˆæˆ–è€…å‡ºé”™çš„æƒ…å†µã€‚å› ä¸ºè¿™ç§æƒ…å†µæ¯”è¾ƒç®€å•ï¼Œæ•´ä¸ªæµç¨‹éƒ½æ˜¯ä¸€ä¸ªåŒæ­¥çš„è¿‡ç¨‹ã€‚æ‰§è¡Œå®Œæˆæˆ–è€…å‡ºé”™ä¹‹åï¼Œ<code>lua_resume()</code>è¿”å›ï¼Œåç»­çš„æµç¨‹å°±è·Ÿå›¾ä¸­I&#x2F;Oç­‰å¾…ï¼ˆæ£•è‰²ï¼‰çš„æƒ…å†µæ˜¯ä¸€æ ·çš„ã€‚</p>
<h1 id="åˆå§‹åŒ–é˜¶æ®µ-1"><a href="#åˆå§‹åŒ–é˜¶æ®µ-1" class="headerlink" title="åˆå§‹åŒ–é˜¶æ®µ"></a>åˆå§‹åŒ–é˜¶æ®µ</h1><h2 id="é…ç½®é¡¹è§£æ"><a href="#é…ç½®é¡¹è§£æ" class="headerlink" title="é…ç½®é¡¹è§£æ"></a>é…ç½®é¡¹è§£æ</h2><p>è§£æåˆ°<code>ssl_certificate_by_lua_block</code>æ—¶ä¼šè°ƒç”¨<code>ngx_stream_lua_ssl_cert_by_lua_block()</code>è¿›è¡Œè§£æï¼Œé‡Œé¢ä¼šè¿›è¡Œé…ç½®æ–‡ä»¶çš„è¯æ³•åˆ†æï¼Œå°†ä»£ç å—ä¸­çš„ä»£ç éƒ½åˆå¹¶åˆ°ä¸€ä¸ªbufferä¹‹åï¼Œæ’å…¥åˆ°å‚æ•°æ•°ç»„çš„åé¢ã€‚ç„¶åè°ƒç”¨<code>ngx_stream_lua_ssl_cert_by_lua()</code>ã€‚ï¼ˆå¦‚æœæ˜¯<code>by_lua_file</code>çš„æƒ…å†µä¼šç›´æ¥è°ƒç”¨<code>ngx_stream_lua_ssl_cert_by_lua()</code>ï¼‰</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">char</span> *</span></span><br><span class="line"><span class="function"><span class="title">ngx_stream_lua_ssl_cert_by_lua_block</span><span class="params">(<span class="keyword">ngx_conf_t</span> *cf, <span class="keyword">ngx_command_t</span> *cmd,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">void</span> *conf)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span>        *rv;</span><br><span class="line">    <span class="keyword">ngx_conf_t</span>   save;</span><br><span class="line"></span><br><span class="line">    save = *cf;</span><br><span class="line">    cf-&gt;handler = ngx_stream_lua_ssl_cert_by_lua;</span><br><span class="line">    cf-&gt;handler_conf = conf;</span><br><span class="line"></span><br><span class="line">    rv = ngx_stream_lua_conf_lua_block_parse(cf, cmd);</span><br><span class="line"></span><br><span class="line">    *cf = save;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> rv;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>ngx_stream_lua_ssl_cert_by_lua()</code>ä¸»è¦å·¥ä½œæ˜¯è®¾ç½®<code>lscf-&gt;srv.ssl_cert_src</code>ä»¥åŠåˆ›å»ºLuaä»£ç çš„keyã€‚å¦‚æœæ˜¯<code>by_lua_file</code>çš„æƒ…å†µï¼Œkeyä»¥å­—ç¬¦ä¸²<code>nhlf_</code>å¼€å¤´ï¼Œåè¾¹æ˜¯å¯¹æ–‡ä»¶è·¯å¾„è®¡ç®—çš„æ‘˜è¦åå…­è¿›åˆ¶å€¼ï¼›è€Œ<code>by_lua_block</code>çš„æƒ…å†µï¼Œkeyä»¥å­—ç¬¦ä¸²<code>&quot;ssl_certificate_by_lua&quot;</code>å¼€å¤´ï¼Œåè¾¹æ˜¯å¯¹æ•´ä¸ªLuaä»£ç å—è®¡ç®—çš„æ‘˜è¦åå…­è¿›åˆ¶å€¼ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">lscf-&gt;srv.ssl_cert_src = value[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">p = ngx_palloc(cf-&gt;pool,</span><br><span class="line">               <span class="keyword">sizeof</span>(<span class="string">&quot;ssl_certificate_by_lua&quot;</span>) +</span><br><span class="line">               NGX_STREAM_LUA_INLINE_KEY_LEN);</span><br><span class="line"><span class="keyword">if</span> (p == <span class="literal">NULL</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">lscf-&gt;srv.ssl_cert_src_key = p;</span><br><span class="line"></span><br><span class="line">p = ngx_copy(p, <span class="string">&quot;ssl_certificate_by_lua&quot;</span>,</span><br><span class="line">             <span class="keyword">sizeof</span>(<span class="string">&quot;ssl_certificate_by_lua&quot;</span>) - <span class="number">1</span>);</span><br><span class="line">p = ngx_copy(p, NGX_STREAM_LUA_INLINE_TAG, NGX_STREAM_LUA_INLINE_TAG_LEN);</span><br><span class="line">p = ngx_stream_lua_digest_hex(p, value[<span class="number">1</span>].data, value[<span class="number">1</span>].len);</span><br><span class="line">*p = <span class="string">&#x27;\0&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h2 id="é…ç½®é¡¹åˆå¹¶"><a href="#é…ç½®é¡¹åˆå¹¶" class="headerlink" title="é…ç½®é¡¹åˆå¹¶"></a>é…ç½®é¡¹åˆå¹¶</h2><p>åœ¨é…ç½®åˆå¹¶é˜¶æ®µï¼Œç”±<code>ngx_stream_lua_merge_srv_conf()</code>æŠŠ<code>cert_cb</code>å›è°ƒå‡½æ•°<code>ngx_stream_lua_ssl_cert_handler()</code>è®¾ç½®åˆ°serverçš„<code>SSL_CTX</code>ä¸Šã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">        <span class="comment">/* å…ˆè¿›è¡Œé…ç½®åˆå¹¶ */</span></span><br><span class="line">        <span class="keyword">if</span> (conf-&gt;srv.ssl_cert_src.len == <span class="number">0</span>) &#123;</span><br><span class="line">            conf-&gt;srv.ssl_cert_src = prev-&gt;srv.ssl_cert_src;</span><br><span class="line">            conf-&gt;srv.ssl_cert_src_key = prev-&gt;srv.ssl_cert_src_key;</span><br><span class="line">            conf-&gt;srv.ssl_cert_handler = prev-&gt;srv.ssl_cert_handler;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/* å¦‚æœè®¾ç½®äº†è¯¥é…ç½® */</span></span><br><span class="line">        <span class="keyword">if</span> (conf-&gt;srv.ssl_cert_src.len) &#123;</span><br><span class="line">            <span class="keyword">if</span> (sscf-&gt;ssl.ctx == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                ngx_log_error(NGX_LOG_EMERG, cf-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                              <span class="string">&quot;no ssl configured for the server&quot;</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> NGX_CONF_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#   <span class="meta-keyword">if</span> OPENSSL_VERSION_NUMBER &gt;= 0x1000205fL</span></span><br><span class="line">            <span class="comment">/* è®¾ç½®cert_cbå›è°ƒ */</span></span><br><span class="line">            SSL_CTX_set_cert_cb(sscf-&gt;ssl.ctx, ngx_stream_lua_ssl_cert_handler, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">#   <span class="meta-keyword">else</span></span></span><br><span class="line">            <span class="comment">/* ... */</span></span><br><span class="line"><span class="meta">#   <span class="meta-keyword">endif</span></span></span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<h2 id="é…ç½®åå¤„ç†-postconfiguration"><a href="#é…ç½®åå¤„ç†-postconfiguration" class="headerlink" title="é…ç½®åå¤„ç† postconfiguration"></a>é…ç½®åå¤„ç† postconfiguration</h2><p>åœ¨postconfigé˜¶æ®µï¼Œä¼šè°ƒç”¨<code>ngx_stream_lua_init()</code>ï¼Œå®ƒé‡Œé¢æœ€å…³é”®çš„ä»»åŠ¡å°±æ˜¯åˆå§‹åŒ–Lua VMã€‚ï¼ˆå…¶å®è¿˜ä¼šè°ƒç”¨<code>init_by*</code>é’©å­ï¼Œä¸è¿‡ä¸åœ¨æˆ‘ä»¬ä»Šå¤©çš„è®¨è®ºèŒƒå›´å†…ã€‚ï¼‰</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">rc = ngx_stream_lua_init_vm(&amp;lmcf-&gt;lua, <span class="literal">NULL</span>, cf-&gt;cycle, cf-&gt;pool,</span><br><span class="line">                            lmcf, cf-&gt;<span class="built_in">log</span>, <span class="literal">NULL</span>);</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬æ¥çœ‹ä¸‹<code>ngx_stream_lua_init_vm()</code>é‡Œé¢çš„å®ç°ï¼Œå®ƒå…ˆä¼šåˆ›å»ºLua VMå®ä¾‹ï¼Œç„¶åæ³¨å†Œå…¶cleanup handlerï¼Œå¦‚æœæœ‰ç¬¬ä¸‰æ–¹æ¨¡å—çš„<code>preload_hooks</code>ä¼šæ³¨å†Œä¹‹ï¼Œç„¶åä¼šåŠ è½½<code>resty.core</code>æ¨¡å—ï¼Œæœ€åä¼šæ³¨å…¥ä»£ç å¯¹å…¨å±€å˜é‡çš„å†™æ“ä½œåŠ ä¸€ä¸ªè­¦å‘Šæ—¥å¿—ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">    <span class="comment">/* create new Lua VM instance */</span></span><br><span class="line">    L = ngx_stream_lua_new_state(parent_vm, cycle, lmcf, <span class="built_in">log</span>);</span><br><span class="line">    <span class="keyword">if</span> (L == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* register cleanup handler for Lua VM */</span></span><br><span class="line">    cln-&gt;handler = ngx_stream_lua_cleanup_vm;</span><br><span class="line"></span><br><span class="line">    state = ngx_alloc(<span class="keyword">sizeof</span>(<span class="keyword">ngx_stream_lua_vm_state_t</span>), <span class="built_in">log</span>);</span><br><span class="line">    <span class="keyword">if</span> (state == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line">    state-&gt;vm = L;</span><br><span class="line">    state-&gt;count = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    cln-&gt;data = state;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (lmcf-&gt;vm_cleanup == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="comment">/* this assignment will happen only once,</span></span><br><span class="line"><span class="comment">         * and also only for the main Lua VM */</span></span><br><span class="line">        lmcf-&gt;vm_cleanup = cln;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> OPENRESTY_LUAJIT</span></span><br><span class="line">    <span class="comment">/* load FFI library first since cdata needs it */</span></span><br><span class="line">    luaopen_ffi(L);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (lmcf-&gt;preload_hooks) &#123;</span><br><span class="line">        <span class="comment">/* æ³¨å†Œç¬¬ä¸‰æ–¹preload_hooks */</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    *new_vm = L;</span><br><span class="line"></span><br><span class="line">    lua_getglobal(L, <span class="string">&quot;require&quot;</span>);</span><br><span class="line">    lua_pushstring(L, <span class="string">&quot;resty.core&quot;</span>);</span><br><span class="line"></span><br><span class="line">    rc = lua_pcall(L, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (rc != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_DECLINED;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> OPENRESTY_LUAJIT</span></span><br><span class="line">    ngx_stream_lua_inject_global_write_guard(L, <span class="built_in">log</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br></pre></td></tr></table></figure>

<p>å…³é”®å‡½æ•°æ˜¯åˆ›å»ºLua VMå®ä¾‹çš„<code>ngx_stream_lua_new_state()</code>ï¼Œæˆ‘ä»¬æ¥ä¸€ç¹å…¶èŠ³å®¹ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* åˆ›å»ºvm state*/</span></span><br><span class="line">L = luaL_newstate();</span><br><span class="line"><span class="comment">/* æ‰“å¼€æ ‡å‡†åº“ */</span></span><br><span class="line">luaL_openlibs(L);</span><br><span class="line"><span class="comment">/* è·å–packageè¡¨ */</span></span><br><span class="line">lua_getglobal(L, <span class="string">&quot;package&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* è®¾ç½®package.pathå’Œpackage.cpath */</span></span><br><span class="line"></span><br><span class="line">lua_pop(L, <span class="number">1</span>); <span class="comment">/* remove the &quot;package&quot; table */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* åˆå§‹åŒ–registry */</span></span><br><span class="line">ngx_stream_lua_init_registry(L, <span class="built_in">log</span>);</span><br><span class="line"><span class="comment">/* åˆå§‹åŒ–globals */</span></span><br><span class="line">ngx_stream_lua_init_globals(L, cycle, lmcf, <span class="built_in">log</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> L;</span><br></pre></td></tr></table></figure>

<p>é‡ç‚¹æ˜¯æœ€åçš„ä¸¤ä¸ªå‡½æ•°ï¼Œå®ƒä»¬åˆ†åˆ«åˆå§‹åŒ–<code>registry</code>å’Œ<code>globals</code>ã€‚è¿™ä¸ªä¸¤ä¸ªå‡½æ•°éƒ½ä¸ç®—å¤ªé•¿ï¼Œè®©æˆ‘ä»¬æ¥å®Œæ•´çœ‹ä¸‹å®ƒä»¬åšäº†äº›ä»€ä¹ˆã€‚</p>
<p><code>ngx_stream_lua_init_registry()</code>åˆ›å»ºäº†å‡ ä¸ªæ³¨å†Œè¡¨é¡¹ï¼Œåˆ†åˆ«ç”¨äºå­˜æ”¾åç¨‹ã€Luaçš„è¯·æ±‚ctxã€socketè¿æ¥æ± ã€Luaé¢„ç¼–è¯‘æ­£åˆ™è¡¨è¾¾å¼å¯¹è±¡cacheåŠLuaä»£ç cacheã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">ngx_stream_lua_init_registry(lua_State *L, <span class="keyword">ngx_log_t</span> *<span class="built_in">log</span>)</span><br><span class="line">&#123;</span><br><span class="line">    ngx_log_debug0(NGX_LOG_DEBUG_STREAM, <span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                   <span class="string">&quot;lua initializing lua registry&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* &#123;&#123;&#123; register a table to anchor lua coroutines reliably:</span></span><br><span class="line"><span class="comment">     * &#123;([int]ref) = [cort]&#125; */</span></span><br><span class="line">    lua_pushlightuserdata(L, ngx_stream_lua_lightudata_mask(</span><br><span class="line">                          coroutines_key));</span><br><span class="line">    lua_createtable(L, <span class="number">0</span>, <span class="number">32</span> <span class="comment">/* nrec */</span>);</span><br><span class="line">    lua_rawset(L, LUA_REGISTRYINDEX);</span><br><span class="line">    <span class="comment">/* &#125;&#125;&#125; */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* create the registry entry for the Lua request ctx data table */</span></span><br><span class="line">    lua_pushliteral(L, ngx_stream_lua_ctx_tables_key);</span><br><span class="line">    lua_createtable(L, <span class="number">0</span>, <span class="number">32</span> <span class="comment">/* nrec */</span>);</span><br><span class="line">    lua_rawset(L, LUA_REGISTRYINDEX);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* create the registry entry for the Lua socket connection pool table */</span></span><br><span class="line">    lua_pushlightuserdata(L, ngx_stream_lua_lightudata_mask(</span><br><span class="line">                          socket_pool_key));</span><br><span class="line">    lua_createtable(L, <span class="number">0</span>, <span class="number">8</span> <span class="comment">/* nrec */</span>);</span><br><span class="line">    lua_rawset(L, LUA_REGISTRYINDEX);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (NGX_PCRE)</span></span><br><span class="line">    <span class="comment">/* create the registry entry for the Lua precompiled regex object cache */</span></span><br><span class="line">    lua_pushlightuserdata(L, ngx_stream_lua_lightudata_mask(</span><br><span class="line">                          regex_cache_key));</span><br><span class="line">    lua_createtable(L, <span class="number">0</span>, <span class="number">16</span> <span class="comment">/* nrec */</span>);</span><br><span class="line">    lua_rawset(L, LUA_REGISTRYINDEX);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* &#123;&#123;&#123; register table to cache user code:</span></span><br><span class="line"><span class="comment">     * &#123; [(string)cache_key] = &lt;code closure&gt; &#125; */</span></span><br><span class="line">    lua_pushlightuserdata(L, ngx_stream_lua_lightudata_mask(</span><br><span class="line">                          code_cache_key));</span><br><span class="line">    lua_createtable(L, <span class="number">0</span>, <span class="number">8</span> <span class="comment">/* nrec */</span>);</span><br><span class="line">    lua_rawset(L, LUA_REGISTRYINDEX);</span><br><span class="line">    <span class="comment">/* &#125;&#125;&#125; */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>ngx_stream_lua_init_globals()</code>åˆ™æ˜¯åˆ›å»ºäº†<code>ngx</code>è¡¨ï¼Œæ¥ç€æŠŠç›¸å…³Lua Ngx APIå…¨éƒ¨æ³¨å†Œåˆ°å…¨å±€è¡¨ä¸Šäº†ï¼Œå…¶ä¸­å°±åŒ…æ‹¬æˆ‘ä»¬å‰é¢ä¾‹å­ä¸­çš„<code>ngx.sleep()</code>å’Œ<code>ngx.exit()</code>ã€‚ç„¶åæŠŠ<code>ngx</code>è¡¨åˆ†åˆ«è®¾ä¸ºå…¨å±€è¡¨é¡¹ï¼ŒåŒæ—¶ä¹Ÿè®¾åˆ°<code>package.loaded.ngx</code>äº†ã€‚æ³¨æ„ï¼ŒåŸç”Ÿçš„<code>coroutine</code>æ¥å£ä¹Ÿåœ¨è¿™é‡Œè¢«æ›¿æ¢äº†ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span></span></span><br><span class="line"><span class="function"><span class="title">ngx_stream_lua_inject_ngx_api</span><span class="params">(lua_State *L, <span class="keyword">ngx_stream_lua_main_conf_t</span> *lmcf,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">ngx_log_t</span> *<span class="built_in">log</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    lua_createtable(L, <span class="number">0</span> <span class="comment">/* narr */</span>, <span class="number">113</span> <span class="comment">/* nrec */</span>);    <span class="comment">/* ngx.* */</span></span><br><span class="line"></span><br><span class="line">    lua_pushcfunction(L, ngx_stream_lua_get_raw_phase_context);</span><br><span class="line">    lua_setfield(L, <span class="number">-2</span>, <span class="string">&quot;_phase_ctx&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    ngx_stream_lua_inject_core_consts(L);</span><br><span class="line"></span><br><span class="line">    ngx_stream_lua_inject_log_api(L);</span><br><span class="line">    ngx_stream_lua_inject_output_api(L);</span><br><span class="line">    ngx_stream_lua_inject_string_api(L);</span><br><span class="line">    ngx_stream_lua_inject_control_api(<span class="built_in">log</span>, L);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    ngx_stream_lua_inject_sleep_api(L);</span><br><span class="line">    ngx_stream_lua_inject_phase_api(L);</span><br><span class="line"></span><br><span class="line">    ngx_stream_lua_inject_req_api(<span class="built_in">log</span>, L);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    ngx_stream_lua_inject_shdict_api(lmcf, L);</span><br><span class="line">    ngx_stream_lua_inject_socket_tcp_api(<span class="built_in">log</span>, L);</span><br><span class="line">    ngx_stream_lua_inject_socket_udp_api(<span class="built_in">log</span>, L);</span><br><span class="line">    ngx_stream_lua_inject_uthread_api(<span class="built_in">log</span>, L);</span><br><span class="line">    ngx_stream_lua_inject_timer_api(L);</span><br><span class="line">    ngx_stream_lua_inject_config_api(L);</span><br><span class="line"></span><br><span class="line">    lua_getglobal(L, <span class="string">&quot;package&quot;</span>); <span class="comment">/* ngx package */</span></span><br><span class="line">    lua_getfield(L, <span class="number">-1</span>, <span class="string">&quot;loaded&quot;</span>); <span class="comment">/* ngx package loaded */</span></span><br><span class="line">    lua_pushvalue(L, <span class="number">-3</span>); <span class="comment">/* ngx package loaded ngx */</span></span><br><span class="line">    lua_setfield(L, <span class="number">-2</span>, <span class="string">&quot;ngx&quot;</span>); <span class="comment">/* ngx package loaded */</span></span><br><span class="line">    lua_pop(L, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    lua_setglobal(L, <span class="string">&quot;ngx&quot;</span>);</span><br><span class="line"></span><br><span class="line">    ngx_stream_lua_inject_coroutine_api(<span class="built_in">log</span>, L);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h2><p>åˆå§‹åŒ–é˜¶æ®µçš„ä¸»è¦å·¥ä½œå°±æ˜¯è¿™äº›ï¼Œç®€å•å°ç»“ä¸€ä¸‹ï¼Œé…ç½®é¡¹è§£æé˜¶æ®µå®Œæˆäº†Luaä»£ç keyçš„åˆ›å»ºï¼Œé…ç½®é¡¹åˆå¹¶é˜¶æ®µå®Œæˆäº†Luaé’©å­å›è°ƒçš„è®¾ç½®ï¼Œpostconfigé˜¶æ®µå®Œæˆäº†Luaè™šæ‹Ÿæœºçš„åˆå§‹åŒ–ï¼Œå…¶ä¸­åŒ…æ‹¬registryå’Œglobalsçš„åˆå§‹åŒ–ã€‚å½“masterè¿›ç¨‹forkå‡ºworkerå­è¿›ç¨‹ä¹‹åï¼Œæ¯ä¸ªworkeréƒ½å°†æœ‰ä¸€ä¸ªè‡ªå·±çš„Lua VMå®ä¾‹ã€‚</p>
<h1 id="è¿›å…¥Luaé’©å­"><a href="#è¿›å…¥Luaé’©å­" class="headerlink" title="è¿›å…¥Luaé’©å­"></a>è¿›å…¥Luaé’©å­</h1><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥çœ‹è¿æ¥å‘èµ·é˜¶æ®µã€‚å½“ç›‘å¬çš„socketæ¥æ”¶åˆ°è¿æ¥è¯·æ±‚ä¹‹åï¼Œä¼šè°ƒç”¨<code>accept</code>å»ºç«‹è¿æ¥ï¼Œå› ä¸ºæ˜¯streamå­ç³»ç»Ÿè°ƒç”¨åˆ°<code>ngx_stream_init_connection</code>ï¼Œåˆå› ä¸ºæ˜¯ssl serverä¼šå…ˆèµ°åˆ°<code>ngx_stream_ssl_handler</code>ï¼Œé‡Œé¢è°ƒç”¨<code>ngx_ssl_create_connection</code>åˆ›å»ºè¿æ¥(<code>SSL_new(ssl-&gt;ctx)</code>)ï¼Œæœ€ç»ˆä¼šè°ƒç”¨<code>SSL_do_handshake</code>è¿›å…¥SSLçŠ¶æ€æœºã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">for ( ;; ) &#123;</span><br><span class="line">    ngx_process_events_and_timers(cycle)</span><br><span class="line">    +-- ngx_epoll_process_events()</span><br><span class="line">        |-- epoll_wait()</span><br><span class="line">        +-- ngx_event_accept()</span><br><span class="line">            |-- accept4()</span><br><span class="line">            |-- ngx_get_connection()</span><br><span class="line">            +-- ngx_stream_init_connection()</span><br><span class="line">                +-- ngx_stream_session_handler()</span><br><span class="line">                    |-- s = ngx_pcalloc(c-&gt;pool, sizeof(ngx_stream_session_t))</span><br><span class="line">                    +-- ngx_stream_core_run_phases()</span><br><span class="line">                        +-- ngx_stream_core_generic_phase()</span><br><span class="line">                            +-- ngx_stream_ssl_handler()</span><br><span class="line">                                +-- ngx_stream_ssl_init_connection()</span><br><span class="line">                                    |-- ngx_ssl_create_connection()</span><br><span class="line">                                    |   +-- SSL_new(ssl-&gt;ctx)</span><br><span class="line">                                    +-- ngx_ssl_handshake()</span><br><span class="line">                                        |-- SSL_do_handshake()</span><br><span class="line">                                        |-- sslerr = SSL_get_error();</span><br><span class="line">                       </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>SSLçŠ¶æ€æœºçš„éƒ¨åˆ†ä¸æ˜¯æˆ‘ä»¬ä»Šå¤©çš„é‡ç‚¹ï¼Œè¿™é‡Œæš‚ä¸”ç•¥è¿‡ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ossl_statem_accept()</span><br><span class="line">+-- state_machine()</span><br><span class="line">    +-- read_state_machine()</span><br><span class="line">        +-- ossl_statem_server_post_process_message()</span><br></pre></td></tr></table></figure>

<p>çŠ¶æ€æœºæœ€ç»ˆä¼šè°ƒç”¨åˆ°<code>tls_post_process_client_hello()</code>é‡Œçš„<code>cert_cb</code>ã€‚è¿™ä¸ªå›è°ƒæˆ‘ä»¬å·²ç»åœ¨é…ç½®åˆå§‹åŒ–é˜¶æ®µè®¾ç½®äº†ï¼Œåœ¨åˆ›å»ºSSLè¿æ¥çš„æ—¶å€™åˆä¼šæ‹·è´åˆ°<code>SSL</code>ç»“æ„ä½“é‡Œã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">tls_post_process_client_hello()</span><br><span class="line">+-- s-&gt;cert-&gt;cert_cb(); /* å³ngx_stream_lua_ssl_cert_handler */</span><br><span class="line">    |   /* å³ngx_stream_lua_ssl_cert_handler_inline */</span><br><span class="line">    +-- lscf-&gt;srv.ssl_cert_handler(r, lscf, L); </span><br><span class="line">        |-- ngx_stream_lua_cache_loadbuffer()</span><br><span class="line">        +-- ngx_stream_lua_ssl_cert_by_chunk()</span><br><span class="line">            |-- ngx_stream_lua_create_ctx()</span><br><span class="line">            |-- lua_xmove(L, co, 1);    /* å°†ä»£ç é—­åŒ…ä»Lç§»åˆ°coä¸Š */</span><br><span class="line">            |-- ngx_stream_lua_new_thread()</span><br><span class="line">            +-- ngx_stream_lua_run_thread() </span><br><span class="line">                |-- lua_resume()</span><br></pre></td></tr></table></figure>

<p>åœ¨<code>ngx_stream_lua_ssl_cert_handler</code>ä¸­ä¼šåšä¸€äº›åˆå§‹åŒ–å·¥ä½œï¼Œå¦‚åˆ›å»ºfakeè¿æ¥ã€fakeä¼šè¯ã€fakeè¯·æ±‚(å› ä¸ºè¿˜åœ¨SSLæ¡æ‰‹é˜¶æ®µï¼Œè¿˜æ²¡æœ‰çœŸå®çš„å‰ç«¯è¯·æ±‚)ï¼Œè®¾ç½®é»˜è®¤çš„è¿”å›ç ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">fc = ngx_stream_lua_create_fake_connection(<span class="literal">NULL</span>);</span><br><span class="line">fs = ngx_stream_lua_create_fake_session(fc);</span><br><span class="line">r = ngx_stream_lua_create_fake_request(fs);</span><br><span class="line">cctx-&gt;exit_code = <span class="number">1</span>;  <span class="comment">/* successful by default */</span></span><br><span class="line">cctx-&gt;connection = c;</span><br><span class="line">cctx-&gt;request = r;</span><br><span class="line">cctx-&gt;entered_cert_handler = <span class="number">1</span>;</span><br><span class="line">cctx-&gt;done = <span class="number">0</span>;</span><br><span class="line">SSL_set_ex_data(c-&gt;ssl-&gt;connection, ngx_stream_lua_ssl_ctx_index, </span><br><span class="line">                cctx)</span><br></pre></td></tr></table></figure>



<p>ç„¶åå› ä¸ºæ˜¯ç”¨é…ç½®æŒ‡ä»¤æ˜¯<code>xxx_by_lua_block</code>æ‰€ä»¥è°ƒç”¨<code>ngx_stream_lua_ssl_cert_handler_inline</code>ï¼Œå®ƒé‡Œé¢ä¼šåŠ è½½Luaä»£ç ã€‚å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡åŠ è½½ä¼šæŠŠä»£ç å—åŠ è½½ä¸ºä¸€ä¸ªLuaå‡½æ•°é—­åŒ…å·¥å‚ï¼Œç„¶åä¿å­˜é—­åŒ…å·¥å‚åˆ°è™šæ‹Ÿæœºçš„æ³¨å†Œè¡¨ä¸Šå¹¶ç”Ÿæˆä¸€ä¸ªé—­åŒ…åˆ°æ ˆé¡¶ï¼›åç»­ä¼šç›´æ¥ä»è™šæ‹Ÿæœºæ³¨å†Œè¡¨ä¸ŠæŸ¥æ‰¾å¹¶ç”Ÿæˆé—­åŒ…åˆ°æ ˆé¡¶ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">ngx_int_t</span></span></span><br><span class="line"><span class="function"><span class="title">ngx_stream_lua_ssl_cert_handler_inline</span><span class="params">(<span class="keyword">ngx_stream_lua_request_t</span> *r,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">ngx_stream_lua_srv_conf_t</span> *lscf, lua_State *L)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">        rc = ngx_stream_lua_cache_loadbuffer(r-&gt;connection-&gt;<span class="built_in">log</span>, L,</span><br><span class="line">                                         lscf-&gt;srv.ssl_cert_src.data,</span><br><span class="line">                                         lscf-&gt;srv.ssl_cert_src.len,</span><br><span class="line">                                         lscf-&gt;srv.ssl_cert_src_key,</span><br><span class="line">                                         <span class="string">&quot;=ssl_certificate_by_lua&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> ngx_stream_lua_ssl_cert_by_chunk(L, r);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥å°±æ˜¯è¿›å…¥<code>by_chunk()</code>å‡†å¤‡æ‰§è¡ŒLuaä»£ç äº†ï¼Œè¿™é‡Œé¦–å…ˆåˆ›å»ºæ¨¡å—<code>ctx</code>ï¼Œæ¥ç€åœ¨è™šæ‹Ÿæœºä¸Šåˆ›å»ºä¸€ä¸ªå…¥å£çº¿ç¨‹ï¼Œå¹¶æŠŠä»£ç é—­åŒ…ä»è™šæ‹Ÿæœºæ ˆä¸Šç§»åˆ°æ–°çº¿ç¨‹çš„æ ˆä¸Šï¼Œè¿˜åœ¨fakeè¯·æ±‚ä¸ŠæŒ‚äº†ä¸€ä¸ªcleanupã€‚ç„¶åå°±æ˜¯è°ƒç”¨<code>run_thread()</code>è¿›å…¥åç¨‹è°ƒåº¦å¾ªç¯äº†ã€‚é‡Œé¢çš„äº‹æƒ…æˆ‘ä»¬å·²ç»åœ¨ä¸Šä¸€ç¯‡ä¸­è®²åˆ°äº†ï¼Œ<code>lua_resume()</code>å¼€å§‹æ‰§è¡Œæˆ‘ä»¬çš„Luaä»£ç ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">ctx = ngx_stream_lua_create_ctx(r-&gt;session);</span><br><span class="line">ctx-&gt;entered_content_phase = <span class="number">1</span>;</span><br><span class="line"><span class="comment">/* åˆ›å»ºå…¥å£çº¿ç¨‹ */</span></span><br><span class="line">co = ngx_stream_lua_new_thread(r, L, &amp;co_ref);</span><br><span class="line"><span class="comment">/* å°†ä»£ç é—­åŒ…ç§»åˆ°å…¥å£çº¿ç¨‹ä¸­ */</span></span><br><span class="line">lua_xmove(L, co, <span class="number">1</span>);</span><br><span class="line"><span class="comment">/* è®¾ç½®é—­åŒ…çš„ç¯å¢ƒè¡¨ä¸ºæ–°åç¨‹çš„å…¨å±€è¡¨ */</span></span><br><span class="line">ngx_stream_lua_get_globals_table(co);</span><br><span class="line">lua_setfenv(co, <span class="number">-2</span>);</span><br><span class="line"><span class="comment">/* æŠŠnginxè¯·æ±‚ä¿å­˜åˆ°åç¨‹å…¨å±€è¡¨ä¸­ */</span></span><br><span class="line">ngx_stream_lua_set_req(co, r);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* æ³¨å†Œè¯·æ±‚çš„cleanup hooks */</span></span><br><span class="line"><span class="keyword">if</span> (ctx-&gt;cleanup == <span class="literal">NULL</span>) &#123;</span><br><span class="line">    cln = ngx_stream_lua_cleanup_add(r, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (cln == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        rc = NGX_ERROR;</span><br><span class="line">        ngx_stream_lua_finalize_request(r, rc);</span><br><span class="line">        <span class="keyword">return</span> rc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    cln-&gt;handler = ngx_stream_lua_request_cleanup_handler;</span><br><span class="line">    cln-&gt;data = ctx;</span><br><span class="line">    ctx-&gt;cleanup = &amp;cln-&gt;handler;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ctx-&gt;context = NGX_STREAM_LUA_CONTEXT_SSL_CERT;</span><br><span class="line">rc = ngx_stream_lua_run_thread(L, r, ctx, <span class="number">0</span>);</span><br></pre></td></tr></table></figure>

<h1 id="I-x2F-Oç­‰å¾…æŒ‚èµ·"><a href="#I-x2F-Oç­‰å¾…æŒ‚èµ·" class="headerlink" title="I&#x2F;Oç­‰å¾…æŒ‚èµ·"></a>I&#x2F;Oç­‰å¾…æŒ‚èµ·</h1><p>æˆ‘ä»¬åœ¨åˆå§‹åŒ–é˜¶æ®µå·²ç»å°†Lua Ngx APIè®¾ç½®åˆ°å…¨å±€è¡¨ä¸­äº†ï¼Œæ‰€ä»¥<code>ngx.sleep()</code>ä¼šè°ƒç”¨åˆ°å¯¹åº”çš„Cå‡½æ•°<code>ngx_stream_lua_ngx_sleep()</code>ï¼Œé‡Œé¢ä¸»è¦æ˜¯è®¾ç½®äº†ä¸€ä¸ªå®šæ—¶å™¨ï¼Œå…¶äº‹ä»¶çš„handleræ˜¯<code>ngx_stream_lua_sleep_handler()</code>ã€‚æŒ‚å®Œå®šæ—¶å™¨ï¼Œå°±ç›´æ¥<code>lua_yield()</code>äº†ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">coctx-&gt;sleep.handler = ngx_stream_lua_sleep_handler;</span><br><span class="line">coctx-&gt;sleep.data = coctx;</span><br><span class="line">coctx-&gt;sleep.<span class="built_in">log</span> = r-&gt;connection-&gt;<span class="built_in">log</span>;</span><br><span class="line"></span><br><span class="line">ngx_add_timer(&amp;coctx-&gt;sleep, (<span class="keyword">ngx_msec_t</span>) delay);</span><br><span class="line"><span class="keyword">return</span> lua_yield(L, <span class="number">0</span>);</span><br></pre></td></tr></table></figure>

<p>å›åˆ°æˆ‘ä»¬çš„ä¸»çº¿ç¨‹<code>run_thread()</code>ä¹‹åï¼Œå› ä¸ºæ˜¯I&#x2F;Oç­‰å¾…å°±ç›´æ¥è¿”å›<code>NGX_AGAIN</code>äº†</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">rv = lua_resume(orig_coctx-&gt;co, nrets);</span><br><span class="line"><span class="keyword">switch</span> (rv) &#123;</span><br><span class="line">    <span class="keyword">case</span> LUA_YIELD:</span><br><span class="line">        <span class="keyword">switch</span> (ctx-&gt;co_op) &#123;</span><br><span class="line">            <span class="keyword">case</span> NGX_STREAM_LUA_USER_CORO_NOP:</span><br><span class="line">                ctx-&gt;cur_co_ctx = <span class="literal">NULL</span>;</span><br><span class="line">                <span class="keyword">return</span> NGX_AGAIN;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™æ ·åˆå›åˆ°äº†æˆ‘ä»¬çš„<code>by_chunk()</code>å‡½æ•°ï¼Œå› ä¸ºè¿”å›å€¼æ˜¯<code>NGX_AGAIN</code>æ‰€ä»¥ä¼šæ£€æŸ¥å…ˆé˜Ÿåˆ—é‡Œé¢æœ‰æ²¡æœ‰postedçš„åç¨‹ï¼Œå¦‚æœæœ‰çš„è¯ä¼šå»æ¢å¤åç¨‹çš„æ‰§è¡Œï¼Œåœ¨æˆ‘ä»¬è¿™ä¸ªä¾‹å­æ˜¯æ²¡æœ‰çš„ï¼Œä¸è¿‡å®ƒçš„è¿”å›å€¼<code>rc</code>æ”¹æˆäº†<code>NGX_DONE</code>ï¼Œæ‰€ä»¥<code>ngx_stream_lua_finalize_request(r, rc);</code>é‡Œå•¥ä¹Ÿæ²¡å¹²å°±è¿”å›äº†ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">rc = ngx_stream_lua_run_thread(L, r, ctx, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (rc == NGX_ERROR || rc &gt;= NGX_OK) &#123;</span><br><span class="line">    <span class="comment">/* do nothing */</span></span><br><span class="line"></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (rc == NGX_AGAIN) &#123;</span><br><span class="line">    rc = ngx_stream_lua_content_run_posted_threads(L, r, ctx, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (rc == NGX_DONE) &#123;</span><br><span class="line">    rc = ngx_stream_lua_content_run_posted_threads(L, r, ctx, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    rc = NGX_OK;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ngx_stream_lua_finalize_request(r, rc);</span><br><span class="line"><span class="keyword">return</span> rc;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ª<code>NGX_DONE</code>çš„è¿”å›å€¼å¾€å›ä¼ é€’åˆ°<code>ngx_stream_lua_ssl_cert_handler</code>ï¼Œåœ¨è¿™é‡Œä¼šå¯¹ä¸åŒè¿”å›å€¼åšä¸åŒå¤„ç†ã€‚å¦‚æœæ˜¯å®Œæˆ<code>NGX_OK</code>æˆ–å‡ºé”™<code>NGX_ERROR</code>çš„æƒ…å†µï¼Œå°±æ„å‘³ç€é’©å­çš„å·¥ä½œå·²ç»ç»“æŸäº†ã€‚æˆ‘ä»¬ç›®å‰çš„è¿”å›å€¼æ˜¯<code>NGX_DONE</code>ï¼Œè¯´æ˜å·¥ä½œè¿˜æ²¡æœ‰ç»“æŸï¼Œå®ƒåœ¨è¿”å›<code>-1</code>ä¹‹å‰ï¼ŒæŒ‚äº†ä¸¤ä¸ªcleanupã€‚å…¶ä¸­<code>_done()</code>çš„é‚£ä¸ªæ˜¯æŒ‚åœ¨fakeè¿æ¥çš„poolä¸Šçš„ï¼Œè€Œ<code>_aborted()</code>é‚£ä¸ªæ˜¯æ˜¯æŒ‚åœ¨å‰ç«¯è¿æ¥ä¸Šçš„ã€‚æ‰€ä»¥<code>_done()</code>å‡½æ•°ä¸Šåœ¨é’©å­å·¥ä½œç»“æŸä¹‹åè°ƒç”¨çš„ï¼Œè€Œ<code>_aborted()</code>æ˜¯åœ¨å‰ç«¯è¿æ¥ç»ˆæ­¢çš„æ—¶å€™è°ƒç”¨ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"> rc = lscf-&gt;srv.ssl_cert_handler(r, lscf, L);</span><br><span class="line"><span class="comment">/* å·²ç»å¤„ç†å®Œæ¯•æˆ–è€…å‡ºé”™çš„æƒ…å†µ */</span></span><br><span class="line"><span class="keyword">if</span> (rc &gt;= NGX_OK || rc == NGX_ERROR) &#123;</span><br><span class="line">    cctx-&gt;done = <span class="number">1</span>;</span><br><span class="line">    ...;</span><br><span class="line">    <span class="keyword">return</span> cctx-&gt;exit_code;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* rc == NGX_DONE */</span></span><br><span class="line"></span><br><span class="line">cln = ngx_pool_cleanup_add(fc-&gt;pool, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">cln-&gt;handler = ngx_stream_lua_ssl_cert_done;</span><br><span class="line">cln-&gt;data = cctx;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (cctx-&gt;cleanup == <span class="literal">NULL</span>) &#123;</span><br><span class="line">    cln = ngx_pool_cleanup_add(c-&gt;pool, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    cln-&gt;data = cctx;</span><br><span class="line">    cctx-&gt;cleanup = &amp;cln-&gt;handler;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">*cctx-&gt;cleanup = ngx_stream_lua_ssl_cert_aborted;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span>;</span><br></pre></td></tr></table></figure>

<p>è¿™æ ·å°±å›åˆ°äº†OpenSSLçš„é¢†åœ°ï¼Œæˆ‘ä»¬çœ‹çœ‹å‡ºå»çš„æµç¨‹æ˜¯æ€ä¹ˆæ ·çš„ã€‚å› ä¸ºä¸Šå±‚çš„è¿”å›å€¼æ˜¯<code>-1</code>ï¼Œè¿™é‡Œè®¾ç½®çŠ¶æ€ä¸º<code>SSL_X509_LOOKUP</code>ç„¶åè¿”å›<code>WORK_MORE_B</code>ï¼Œ</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">int</span> rv = s-&gt;cert-&gt;cert_cb(s, s-&gt;cert-&gt;cert_cb_arg);</span><br><span class="line"><span class="keyword">if</span> (rv &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    s-&gt;rwstate = SSL_X509_LOOKUP;</span><br><span class="line">    <span class="keyword">return</span> WORK_MORE_B;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªè¿”å›å€¼ä¼ é€’åˆ°<code>read_state_machine</code>ï¼Œå˜æˆäº†è¿”å›<code>SUB_STATE_ERROR</code>ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">case</span> READ_STATE_POST_PROCESS:</span><br><span class="line">    st-&gt;read_state_work = post_process_message(s, st-&gt;read_state_work);</span><br><span class="line">    <span class="keyword">switch</span> (st-&gt;read_state_work) &#123;</span><br><span class="line">    <span class="keyword">case</span> WORK_ERROR:</span><br><span class="line">        check_fatal(s, SSL_F_READ_STATE_MACHINE);</span><br><span class="line">        <span class="comment">/* Fall through */</span></span><br><span class="line">    <span class="keyword">case</span> WORK_MORE_A:</span><br><span class="line">    <span class="keyword">case</span> WORK_MORE_B:</span><br><span class="line">    <span class="keyword">case</span> WORK_MORE_C:</span><br><span class="line">        <span class="keyword">return</span> SUB_STATE_ERROR;</span><br></pre></td></tr></table></figure>

<p>ä¼ é€’åˆ°<code>state_machine</code>ï¼Œå˜æˆäº†è¿”å›<code>-1</code>ã€‚æœ€ç»ˆ<code>ossl_statem_accept</code>åŠ<code>SSL_do_handshake()</code>éƒ½è¿”å›è¿™ä¸ªå€¼ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (st-&gt;state == MSG_FLOW_READING) &#123;</span><br><span class="line">    ssret = read_state_machine(s);</span><br><span class="line">    <span class="keyword">if</span> (ssret == SUB_STATE_FINISHED) &#123;</span><br><span class="line">        st-&gt;state = MSG_FLOW_WRITING;</span><br><span class="line">        init_write_state_machine(s);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">/* NBIO or error */</span></span><br><span class="line">        <span class="keyword">goto</span> end;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>çœ‹çœ‹å›åˆ°nginxä¹‹ååšäº†ä»€ä¹ˆï¼Œå› ä¸ºè¿”å›å€¼æ˜¯-1ï¼Œæ‰€ä»¥ä¼šå…ˆå»è·å–é”™è¯¯ç±»å‹ï¼Œå› ä¸ºä¹‹å‰åœ¨<code>cert_cb()</code>è¿”å›ä»¥åå·²ç»è®¾ç½®äº†<code>s-&gt;rwstate = SSL_X509_LOOKUP;</code>æ‰€ä»¥ä¼šè¿”å›<code>SSL_ERROR_WANT_X509_LOOKUP</code>ï¼Œè¿™é‡Œå°†è¯»å†™äº‹ä»¶çš„å›è°ƒè®¾ç½®ä¸ºsslæ¡æ‰‹çš„å›è°ƒä»¥ä¾¿ä¸‹æ¬¡æ¢å¤ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">n = SSL_do_handshake(c-&gt;ssl-&gt;connection);</span><br><span class="line"><span class="comment">/* ... */</span></span><br><span class="line">sslerr = SSL_get_error(c-&gt;ssl-&gt;connection, n);</span><br><span class="line"><span class="comment">/* ... */</span></span><br><span class="line"><span class="keyword">if</span> (sslerr == SSL_ERROR_WANT_X509_LOOKUP)</span><br><span class="line">&#123;</span><br><span class="line">    c-&gt;read-&gt;handler = ngx_ssl_handshake_handler;</span><br><span class="line">    c-&gt;write-&gt;handler = ngx_ssl_handshake_handler;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ngx_handle_read_event(c-&gt;read, <span class="number">0</span>) != NGX_OK) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ngx_handle_write_event(c-&gt;write, <span class="number">0</span>) != NGX_OK) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_AGAIN;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç„¶å<code>NGX_AGAIN</code>çš„è¿”å›å€¼ä¸€ç›´å¾€ä¸Šä¼ é€’ï¼Œç›´åˆ°<code>ngx_stream_core_generic_phase</code>å˜ä¸º<code>NGX_OK</code>ã€‚ç„¶åæœ¬æ¬¡çš„äº‹ä»¶å¤„ç†å°±ç®—ç»“æŸäº†ã€‚</p>
<h1 id="äº‹ä»¶è§¦å‘æ—¶æ¢å¤"><a href="#äº‹ä»¶è§¦å‘æ—¶æ¢å¤" class="headerlink" title="äº‹ä»¶è§¦å‘æ—¶æ¢å¤"></a>äº‹ä»¶è§¦å‘æ—¶æ¢å¤</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ngx_process_events_and_timers</span><br><span class="line">|-- ngx_event_expire_timers</span><br><span class="line">    |-- ngx_stream_lua_sleep_handler</span><br><span class="line">        |-- ngx_stream_lua_sleep_resume</span><br><span class="line">            |-- ngx_stream_lua_run_thread</span><br></pre></td></tr></table></figure>

<p>ç­‰åˆ°å®šæ—¶å™¨è¶…æ—¶çš„æ—¶å€™ï¼Œä¼šæ‰§è¡Œæˆ‘ä»¬ä¹‹å‰è®¾ç½®çš„<code>ngx_stream_lua_sleep_handler</code>ï¼Œé‡Œé¢ä¼šè®¾ç½®å½“å‰åç¨‹ä¸Šä¸‹æ–‡ï¼Œç„¶åè°ƒç”¨<code>ngx_stream_lua_sleep_resume()</code>ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">coctx = ev-&gt;data;</span><br><span class="line">ctx-&gt;cur_co_ctx = coctx;</span><br><span class="line"><span class="keyword">if</span> (ctx-&gt;entered_content_phase) &#123;</span><br><span class="line">    (<span class="keyword">void</span>) ngx_stream_lua_sleep_resume(r);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨<code>ngx_stream_lua_sleep_resume</code>é‡Œè°ƒç”¨<code>ngx_stream_lua_run_thread</code>æ¢å¤åç¨‹çš„æ‰§è¡Œã€‚è¿™æ ·å°±åˆå›åˆ°äº†æˆ‘ä»¬çš„Luaä»£ç é‡Œã€‚</p>
<h1 id="Luaé’©å­æ­£å¸¸æ‰§è¡Œç»“æŸ"><a href="#Luaé’©å­æ­£å¸¸æ‰§è¡Œç»“æŸ" class="headerlink" title="Luaé’©å­æ­£å¸¸æ‰§è¡Œç»“æŸ"></a>Luaé’©å­æ­£å¸¸æ‰§è¡Œç»“æŸ</h1><p>æ¥ä¸‹æ¥Luaä»£ç æ‰§è¡Œå®Œæ¯•ï¼Œ<code>lua_resume()</code>è¿”å›ï¼Œå› ä¸ºæ˜¯åç¨‹æ­£å¸¸ç»“æŸï¼Œä¸”æ²¡æœ‰å…¶ä»–åœ¨postedé˜Ÿåˆ—é‡Œçš„åç¨‹äº†ï¼Œæ‰€ä»¥<code>run_thread()</code>ç›´æ¥è¿”å›<code>NGX_OK</code>ã€‚å› æ­¤åœ¨<code>ngx_stream_lua_finalize_request</code>é‡Œå°±ä¼šå®é™…æ¸…é™¤fakeè¯·æ±‚ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">rc = ngx_stream_lua_run_thread(vm, r, ctx, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (rc == NGX_AGAIN) &#123;</span><br><span class="line">    <span class="keyword">return</span> ngx_stream_lua_run_posted_threads(c, vm, r, ctx, nreqs);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (rc == NGX_DONE) &#123;</span><br><span class="line">    ngx_stream_lua_finalize_request(r, NGX_DONE);</span><br><span class="line">    <span class="keyword">return</span> ngx_stream_lua_run_posted_threads(c, vm, r, ctx, nreqs);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (ctx-&gt;entered_content_phase) &#123;</span><br><span class="line">    ngx_stream_lua_finalize_request(r, rc);</span><br><span class="line">    <span class="keyword">return</span> NGX_DONE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> rc;</span><br></pre></td></tr></table></figure>

<p>é‡Œé¢ä¼šè°ƒç”¨åˆ°ä¹‹å‰è®¾ç½®çš„cleanupå‡½æ•°ï¼Œæ¸…ç†fakeè¯·æ±‚çš„æ—¶å€™è°ƒç”¨<code>ngx_stream_lua_request_cleanup_handler</code>æ¸…ç†Luaçº¿ç¨‹ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">cln = r-&gt;cleanup;</span><br><span class="line">r-&gt;cleanup = <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">while</span> (cln) &#123;</span><br><span class="line">    <span class="keyword">if</span> (cln-&gt;handler) &#123;</span><br><span class="line">        cln-&gt;handler(cln-&gt;data);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    cln = cln-&gt;next;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">r-&gt;connection-&gt;destroyed = <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<p>æ¸…ç†fakeè¿æ¥çš„æ—¶å€™è°ƒç”¨<code>ngx_stream_lua_ssl_cert_done</code>ã€‚æˆ‘ä»¬æ¥çœ‹çœ‹<code>ngx_stream_lua_ssl_cert_done</code>é‡Œé¢åšäº†ä»€ä¹ˆã€‚ä¸»è¦æ˜¯è®¾ç½®äº†å®Œæˆæ ‡å¿—ï¼Œç„¶åæŠŠå‰ç«¯è¿æ¥çš„å†™äº‹ä»¶åŠ å…¥äº†<code>ngx_posted_events</code>é˜Ÿåˆ—é‡Œã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">cctx-&gt;done = <span class="number">1</span>;</span><br><span class="line">ngx_post_event(c-&gt;write, &amp;ngx_posted_events);</span><br></pre></td></tr></table></figure>

<p>å®šæ—¶å™¨è¶…æ—¶äº‹ä»¶å®Œæˆä¹‹åè¿”å›åˆ°å¤–å±‚ï¼Œå¤„ç†åç»­çš„<code>ngx_posted_events</code>é˜Ÿåˆ—äº‹ä»¶ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">(<span class="keyword">void</span>) ngx_process_events(cycle, timer, flags);</span><br><span class="line"></span><br><span class="line">delta = ngx_current_msec - delta;</span><br><span class="line"></span><br><span class="line">ngx_log_debug1(NGX_LOG_DEBUG_EVENT, cycle-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">               <span class="string">&quot;timer delta: %M&quot;</span>, delta);</span><br><span class="line"></span><br><span class="line">ngx_event_process_posted(cycle, &amp;ngx_posted_accept_events);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (ngx_accept_mutex_held) &#123;</span><br><span class="line">    ngx_shmtx_unlock(&amp;ngx_accept_mutex);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (delta) &#123;</span><br><span class="line">    ngx_event_expire_timers();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ngx_event_process_posted(cycle, &amp;ngx_posted_events);</span><br></pre></td></tr></table></figure>

<p>å› ä¸ºå‰ç«¯è¿æ¥çš„å†™äº‹ä»¶å·²ç»è®¾ç½®æˆ<code>ngx_ssl_handshake_handler</code>ï¼Œæ‰€ä»¥ä¼šå†æ¬¡è°ƒç”¨åˆ°<code>ngx_ssl_handshake-SSL_do_handshake</code>ï¼Œè¿™æ ·å°±å†æ¬¡è¿›å…¥äº†SSLçŠ¶æ€æœºï¼Œåˆä¼šæ¥åˆ°<code>ngx_stream_lua_ssl_cert_handler</code>ä¸­ã€‚å› ä¸ºæ˜¯ç¬¬äºŒæ¬¡è¿›å…¥äº†ï¼Œä¸”å·²ç»è®¾ç½®äº†<code>cctx-&gt;done</code>ï¼Œæ‰€ä»¥å°±ç›´æ¥è¿”å›ç¦»å¼€ç äº†ï¼Œå…¶ä¸­<code>cctx-&gt;exit_code</code>å°±æ˜¯<code>ngx.exit()</code>æ—¶çš„å‚æ•°ï¼Œ<code>cctx-&gt;exit_code</code>åˆå§‹åŒ–æ—¶çš„é»˜è®¤å€¼æ—¶0ï¼Œä½†æ˜¯æ³¨æ„åˆ°å‰é¢ç¬¬ä¸€æ¬¡è¿›å…¥<code>ngx_stream_lua_ssl_cert_handler</code>çš„æ—¶å€™å·²ç»å°†é»˜è®¤å€¼è®¾ä¸º1äº†ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (cctx &amp;&amp; cctx-&gt;entered_cert_handler) &#123;</span><br><span class="line">    <span class="comment">/* not the first time */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (cctx-&gt;done) &#123;</span><br><span class="line">        ngx_log_debug1(NGX_LOG_DEBUG_STREAM, c-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                       <span class="string">&quot;stream lua_certificate_by_lua:&quot;</span></span><br><span class="line">                       <span class="string">&quot; cert cb exit code: %d&quot;</span>,</span><br><span class="line">                       cctx-&gt;exit_code);</span><br><span class="line"></span><br><span class="line">        dd(<span class="string">&quot;lua ssl cert done, finally&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> cctx-&gt;exit_code;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥ï¼Œå›åˆ°äº†<code>tls_post_process_client_hello()</code>ç»§ç»­åé¢çš„æ¡æ‰‹æµç¨‹äº†ã€‚</p>
<h1 id="Luaé’©å­å†…å‡ºé”™çš„æƒ…å†µ"><a href="#Luaé’©å­å†…å‡ºé”™çš„æƒ…å†µ" class="headerlink" title="Luaé’©å­å†…å‡ºé”™çš„æƒ…å†µ"></a>Luaé’©å­å†…å‡ºé”™çš„æƒ…å†µ</h1><p>å‡ºé”™çš„æµç¨‹è·Ÿæ­£å¸¸ç»“æŸç±»ä¼¼ï¼Œåªä¸è¿‡è¿”å›å€¼ä¸ä¸€æ ·ã€‚<code>ngx.exit()</code>çš„å®ç°å¦‚ä¸‹</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">ngx.<span class="built_in">exit</span> = function (rc)</span><br><span class="line">    local err = get_string_buf(ERR_BUF_SIZE)</span><br><span class="line">    local errlen = get_size_ptr()</span><br><span class="line">    local r = get_request()</span><br><span class="line">    <span class="keyword">if</span> r == nil then</span><br><span class="line">        error(<span class="string">&quot;no request found&quot;</span>)</span><br><span class="line">    end</span><br><span class="line">    errlen[<span class="number">0</span>] = ERR_BUF_SIZE</span><br><span class="line">    rc = ngx_lua_ffi_exit(r, rc, err, errlen)</span><br><span class="line">    <span class="keyword">if</span> rc == <span class="number">0</span> then</span><br><span class="line">        -- print(<span class="string">&quot;yielding...&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">co_yield</span>()</span><br><span class="line">    end</span><br><span class="line">    <span class="keyword">if</span> rc == FFI_DONE then</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    end</span><br><span class="line">    error(ffi_string(err, errlen[<span class="number">0</span>]), <span class="number">2</span>)</span><br><span class="line">end</span><br></pre></td></tr></table></figure>

<p>é‡Œé¢ä¼šè°ƒç”¨ffiå‡½æ•°<code>ngx_stream_lua_ffi_exit()</code>ï¼Œåœ¨å…¶ä¸­è®¾ç½®<code>ctx-&gt;exit_code</code>ï¼Œç„¶åè¿”å›<code>NGX_OK</code>ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (ctx-&gt;context &amp; (NGX_STREAM_LUA_CONTEXT_SSL_CERT</span><br><span class="line">                    | NGX_STREAM_LUA_CONTEXT_SSL_CLIENT_HELLO ))</span><br><span class="line">&#123;</span><br><span class="line">    ctx-&gt;exit_code = status;</span><br><span class="line">    ctx-&gt;exited = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å›åˆ°<code>ngx.exit()</code>å‡½æ•°ä¹‹åï¼Œå°±è°ƒç”¨åŸç”Ÿçš„<code>coroutine.yield()</code>ï¼Œå›åˆ°æˆ‘ä»¬çš„ä¸»çº¿ç¨‹<code>run_thread()</code>ä¹‹åï¼Œå› ä¸ºè®¾ç½®äº†<code>ctx-&gt;exited</code>ä¼šè°ƒç”¨<code>ngx_stream_lua_handle_exit</code>è¿”å›</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">rv = lua_resume(orig_coctx-&gt;co, nrets);</span><br><span class="line"><span class="keyword">switch</span> (rv) &#123;</span><br><span class="line">    <span class="keyword">case</span> LUA_YIELD:</span><br><span class="line">        <span class="keyword">if</span> (ctx-&gt;exited) &#123;</span><br><span class="line">            <span class="keyword">return</span> ngx_stream_lua_handle_exit(L, r, ctx);</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>ngx_stream_lua_handle_exit()</code>é‡Œé¢è°ƒç”¨<code>ngx_stream_lua_request_cleanup</code>æ¸…ç†çº¿ç¨‹ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">ctx-&gt;cur_co_ctx-&gt;co_status = NGX_STREAM_LUA_CO_DEAD;</span><br><span class="line">ngx_stream_lua_request_cleanup(ctx, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">return</span> ctx-&gt;exit_code;</span><br></pre></td></tr></table></figure>

<p>ç„¶åè¿”å›åˆ°<code>sleep_resume</code>ï¼Œæ­¤æ—¶<code>rc</code>ä¸º<code>ctx-&gt;exit_code</code>ï¼Œå³<code>ngx.ERROR</code>ï¼Œæ¥ä¸‹æ¥è·Ÿæ­£å¸¸ç»“æŸæ—¶ä¸€æ ·ä¹Ÿæ˜¯ç»“æŸæˆ‘ä»¬çš„è¯·æ±‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">rc = ngx_stream_lua_run_thread(L, r, ctx, <span class="number">0</span>);</span><br><span class="line">...;</span><br><span class="line"><span class="keyword">if</span> (ctx-&gt;entered_content_phase) &#123;</span><br><span class="line">    ngx_stream_lua_finalize_request(r, rc);</span><br><span class="line">    <span class="keyword">return</span> NGX_DONE;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> rc;</span><br></pre></td></tr></table></figure>

<p>å› ä¸ºæ˜¯fakeè¯·æ±‚ï¼Œ<code>ngx_stream_lua_finalize_request</code>è°ƒç”¨<code>ngx_stream_lua_finalize_fake_request</code>ï¼Œé‡Œé¢å°†<code>cctx-&gt;exit_code</code>è®¾ä¸º0ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (rc == NGX_ERROR || rc &gt;= NGX_STREAM_BAD_REQUEST) &#123;</span><br><span class="line">    <span class="keyword">if</span> (r-&gt;connection-&gt;ssl) &#123;</span><br><span class="line">        ssl_conn = r-&gt;connection-&gt;ssl-&gt;connection;</span><br><span class="line">        <span class="keyword">if</span> (ssl_conn) &#123;</span><br><span class="line">            c = ngx_ssl_get_connection(ssl_conn);</span><br><span class="line">            <span class="keyword">if</span> (c &amp;&amp; c-&gt;ssl) &#123;</span><br><span class="line">                cctx = ngx_stream_lua_ssl_get_ctx(c-&gt;ssl-&gt;connection);</span><br><span class="line">                <span class="keyword">if</span> (cctx != <span class="literal">NULL</span>) &#123;</span><br><span class="line">                    cctx-&gt;exit_code = <span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ngx_stream_lua_close_fake_request(r);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨æ¸…ç†fakeè¯·æ±‚çš„æ—¶å€™è°ƒç”¨<code>ngx_stream_lua_request_cleanup_handler</code>æ¸…ç†Luaçº¿ç¨‹ã€‚åœ¨æ¸…ç†fakeè¿æ¥çš„æ—¶å€™ä¼šè§¦å‘<code>ngx_stream_lua_ssl_cert_done</code>ï¼Œè·Ÿæ­£å¸¸å®Œæˆæ—¶ä¸€æ ·ï¼Œä¹Ÿæ˜¯è®¾ç½®å®Œæˆæ ‡å¿—ï¼Œç„¶åæŠŠå‰ç«¯è¿æ¥çš„å†™äº‹ä»¶åŠ å…¥äº†<code>ngx_posted_events</code>é˜Ÿåˆ—é‡Œã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">cctx-&gt;done = <span class="number">1</span>;</span><br><span class="line">ngx_post_event(c-&gt;write, &amp;ngx_posted_events);</span><br></pre></td></tr></table></figure>

<p>åˆ°æ­¤å®šæ—¶å™¨çš„äº‹ä»¶å°±ç»“æŸäº†ï¼Œå¼€å§‹å¤„ç†åç»­çš„postedé˜Ÿåˆ—äº‹ä»¶ã€‚åŒæ ·åœ°ï¼Œä¹Ÿä¼šå†æ¬¡è°ƒç”¨<code>ngx_ssl_handshake_handler</code>æœ€ç»ˆè°ƒåˆ°åˆ°<code>ngx_stream_lua_ssl_cert_handler</code>ä¸­ã€‚å› ä¸ºæ˜¯ç¬¬äºŒæ¬¡è¿›å…¥äº†ï¼Œä¸”å·²ç»è®¾ç½®äº†<code>cctx-&gt;done</code>ï¼Œæ‰€ä»¥å°±ç›´æ¥è¿”å›ç¦»å¼€ç äº†ï¼Œè€Œæœ¬æ¬¡å› ä¸ºæ˜¯å‡ºé”™<code>cctx-&gt;exit_code</code>çš„å€¼æ˜¯0.</p>
<p>è¿”å›åˆ°OpenSSLä¹‹åï¼Œä¸€è·¯å¾€ä¸Šä¼ é€’é”™è¯¯ç ã€‚ã€‚ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">int</span> rv = s-&gt;cert-&gt;cert_cb(s, s-&gt;cert-&gt;cert_cb_arg);</span><br><span class="line"><span class="keyword">if</span> (rv == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">goto</span> err;</span><br><span class="line">&#125;</span><br><span class="line">err:</span><br><span class="line"><span class="keyword">return</span> WORK_ERROR;</span><br></pre></td></tr></table></figure>

<p>æœ€ç»ˆï¼Œ<code>SSL_do_handshake</code>è¿”å›é”™è¯¯å€¼ï¼Œç»“æŸSSLæ¡æ‰‹ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">n = SSL_do_handshake(c-&gt;ssl-&gt;connection);</span><br><span class="line">sslerr = SSL_get_error(c-&gt;ssl-&gt;connection, n);</span><br><span class="line">return NGX_ERROR;</span><br></pre></td></tr></table></figure>

<h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>æˆ‘ä»¬æœ¬ç¯‡æ˜¯ä»¥ä¸€ä¸ªå®šæ—¶å™¨ä¸ºä¾‹å­ï¼Œå¯¹äºsocket I&#x2F;Oç­‰å¾…å…¶å®ä¹Ÿæ˜¯ç±»ä¼¼çš„æµç¨‹ã€‚åªä¸è¿‡è§¦å‘äº‹ä»¶ç”±å®šæ—¶å™¨è¶…æ—¶å˜æˆäº†ç›¸åº”çš„fdçš„è¯»å†™äº‹ä»¶ï¼Œåç¨‹çš„æ¢å¤ç”±å®šæ—¶å™¨æ—¶çš„ç›´æ¥æ¢å¤å˜æˆäº†å®Œæˆæœ¬æ¬¡I&#x2F;Oä»»åŠ¡ï¼ˆæˆ–è€…å‡ºé”™ï¼‰ä¹‹åæ¢å¤åç¨‹ã€‚</p>
]]></content>
      <categories>
        <category>ç¼–ç¨‹å¼€å‘</category>
        <category>Nginx/OpenResty</category>
      </categories>
      <tags>
        <tag>Lua</tag>
        <tag>OpenResty</tag>
        <tag>Nginx</tag>
        <tag>é’©å­</tag>
      </tags>
  </entry>
  <entry>
    <title>æ·±å…¥ç†è§£mmap--å†…æ ¸ä»£ç åˆ†æåŠé©±åŠ¨demoç¤ºä¾‹</title>
    <url>/posts/5ec4fb12/</url>
    <content><![CDATA[<div class="note primary">
            <p>mmapæ˜¯ä¸€ä¸ªç”¨æˆ·ç©ºé—´å¾ˆå¸¸ç”¨çš„ç³»ç»Ÿè°ƒç”¨ï¼Œæ— è®ºæ˜¯åˆ†é…å†…å­˜ã€è¯»å†™å¤§æ–‡ä»¶ã€é“¾æ¥åŠ¨æ€åº“æ–‡ä»¶ï¼Œè¿˜æ˜¯å¤šè¿›ç¨‹é—´å…±äº«å†…å­˜ï¼Œéƒ½å¯ä»¥çœ‹åˆ°å…¶èº«å½±ã€‚æœ¬æ–‡é¦–å…ˆä»‹ç»äº†è¿›ç¨‹åœ°å€ç©ºé—´å’Œmmapï¼Œç„¶ååˆ†æäº†å†…æ ¸ä»£ç ä»¥äº†è§£å…¶å®ç°ï¼Œæœ€åé€šè¿‡ä¸€ä¸ªç®€å•çš„demoé©±åŠ¨ç¤ºä¾‹ï¼ŒåŠ æ·±å¯¹mmapçš„ç†è§£ã€‚</p>
          </div>

<span id="more"></span>

<h2 id="è¿›ç¨‹åœ°å€ç©ºé—´åŠvma"><a href="#è¿›ç¨‹åœ°å€ç©ºé—´åŠvma" class="headerlink" title="è¿›ç¨‹åœ°å€ç©ºé—´åŠvma"></a>è¿›ç¨‹åœ°å€ç©ºé—´åŠvma</h2><p>ä½œä¸ºå‰ç½®çŸ¥è¯†ï¼Œå…ˆæ¥å¯¹è¿›ç¨‹åœ°å€ç©ºé—´åšä¸ªç®€å•ä»‹ç»ï¼Œä»¥ä¾¿æ›´å¥½åœ°ç†è§£åé¢çš„å†…å®¹ã€‚ç°ä»£æ“ä½œç³»ç»Ÿçš„å†…å­˜ç®¡ç†ç¦»ä¸å¼€ç¡¬ä»¶çš„æ”¯æŒï¼Œå¦‚åˆ†æ®µæœºåˆ¶ã€åˆ†é¡µæœºåˆ¶ã€‚å®ƒä»¬ç”¨äºå®ç°å†…å­˜çš„éš”ç¦»ã€ä¿æŠ¤ä»¥åŠé«˜æ•ˆä½¿ç”¨ã€‚è¿›ç¨‹ä¹‹é—´åœ°å€ç©ºé—´ç›¸äº’éš”ç¦»ï¼Œæ¯ä¸ªè¿›ç¨‹éƒ½æœ‰ä¸€å¥—é¡µè¡¨ï¼Œå®ç°çº¿æ€§åœ°å€åˆ°ç‰©ç†åœ°å€çš„è½¬æ¢ã€‚</p>
<h3 id="è™šæ‹Ÿå†…å­˜æ˜ å°„"><a href="#è™šæ‹Ÿå†…å­˜æ˜ å°„" class="headerlink" title="è™šæ‹Ÿå†…å­˜æ˜ å°„"></a>è™šæ‹Ÿå†…å­˜æ˜ å°„</h3><p>ä¸‹é¢æ˜¯32ä½ç³»ç»Ÿï¼ˆx86ï¼‰çš„è¿›ç¨‹åœ°å€ç©ºé—´å¸ƒå±€å›¾</p>
<p><img src="https://imgs.developpaper.com/imgs/1458743340-5ddbcaa6525a5_articlex.png" alt="img" loading="lazy"></p>
<p>0ï½3G éƒ¨åˆ†æ˜¯ç”¨æˆ·ç©ºé—´çš„åœ°å€ï¼Œ3Gï½4G éƒ¨åˆ†æ˜¯å†…æ ¸åœ°å€ç©ºé—´ã€‚è™šæ‹Ÿåœ°å€ä»ä½åˆ°é«˜åˆ†åˆ«ä¸ºä»£ç æ®µã€æ•°æ®æ®µï¼ˆå·²åˆå§‹åŒ–çš„é™æ€å˜é‡ï¼‰ã€bssæ®µï¼ˆæœªåˆå§‹åŒ–çš„é™æ€å˜é‡ï¼‰ã€heapå †ã€mmapæ˜ å°„åŒºã€æ ˆã€å‘½ä»¤è¡Œå‚æ•°ã€ç¯å¢ƒå˜é‡ã€‚</p>
<p>ä»0xc0000000å¼€å§‹å°±æ˜¯å†…æ ¸åœ°å€ç©ºé—´äº†ã€‚å†…æ ¸åœ°å€ç©ºé—´åˆåˆ†ä¸ºçº¿æ€§å†…å­˜åŒºå’Œé«˜ç«¯å†…å­˜åŒºã€‚é«˜ç«¯å†…å­˜åŒºæ˜¯ç”¨äºvmallocæœºåˆ¶ã€fixmapç­‰çš„ã€‚åœ¨x86ä½“ç³»ä¸­ï¼Œæœ€ä½16MBç‰©ç†å†…å­˜æ˜¯DMAå†…å­˜åŒºï¼Œç”¨äºæ‰§è¡ŒDMAæ“ä½œã€‚</p>
<p>64ä½ç³»ç»Ÿï¼ˆx86_64ï¼‰ä¸Šï¼Œå†…å­˜åœ°å€å¯ç”¨ç©ºé—´ä¸º0x0000000000000000 ~ 0xFFFFFFFFFFFFFFFFï¼Œè¿™æ˜¯ä¸€ä¸ªéå¸¸å·¨å¤§çš„åœ°å€ç©ºé—´ã€‚è€ŒLinuxå®é™…ä¸Šåªç”¨äº†ä½47ä½ï¼ˆ128Tï¼‰ï¼Œé«˜17ä½ä½œæ‰©å±•ã€‚å®é™…ç”¨åˆ°çš„åœ°å€ç©ºé—´ä¸º<strong>0x0000000000000000 ~ 0x00007FFFFFFFFFFF</strong>ï¼ˆç”¨æˆ·ç©ºé—´ï¼‰å’Œ<strong>0xFFFF800000000000 ~ 0xFFFFFFFFFFFFFFFF</strong>ï¼ˆå†…æ ¸ç©ºé—´ï¼‰ã€‚</p>
<p>åœ¨64ä½å¤„ç†å™¨ä¸­ï¼Œç”±äºæœ‰è¶³å¤Ÿçš„å†…æ ¸ç©ºé—´å¯ä»¥çº¿æ€§æ˜ å°„ç‰©ç†å†…å­˜ï¼Œæ‰€ä»¥å°±ä¸éœ€è¦é«˜ç«¯å†…å­˜è¿™ä¸ªç®¡ç†åŒºäº†ã€‚æ›´è¯¦ç»†çš„ä¿¡æ¯å¯ä»¥å‚è€ƒ<a href="https://www.kernel.org/doc/Documentation/x86/x86_64/mm.txt">å†…æ ¸æ–‡æ¡£</a>ã€‚</p>
<h3 id="VMA"><a href="#VMA" class="headerlink" title="VMA"></a>VMA</h3><p>è¿›ç¨‹åœ°å€ç©ºé—´åœ¨Linuxå†…æ ¸ä¸­ä½¿ç”¨<code>struct vm_area_struct</code>æ¥æè¿°ï¼Œç®€ç§°<strong>VMA</strong>ã€‚ç”±äºè¿™äº›åœ°å€ç©ºé—´å½’å±äºå„ä¸ªç”¨æˆ·è¿›ç¨‹ï¼Œæ‰€ä»¥åœ¨ç”¨æˆ·è¿›ç¨‹çš„<code>struct mm_struct</code>ä¸­ä¹Ÿæœ‰ç›¸åº”çš„æˆå‘˜ã€‚è¿›ç¨‹å¯ä»¥é€šè¿‡å†…æ ¸çš„å†…å­˜ç®¡ç†æœºåˆ¶åŠ¨æ€åœ°æ·»åŠ æˆ–åˆ é™¤è¿™äº›å†…å­˜åŒºåŸŸã€‚</p>
<p>æ¯ä¸ªå†…å­˜åŒºåŸŸå…·æœ‰ç›¸å…³çš„æƒé™ï¼Œæ¯”å¦‚å¯è¯»ã€å¯å†™ã€å¯æ‰§è¡Œã€‚å¦‚æœè¿›ç¨‹è®¿é—®äº†ä¸åœ¨æœ‰æ•ˆèŒƒå›´å†…çš„å†…å­˜åŒºåŸŸã€æˆ–éæ³•è®¿é—®äº†å†…å­˜ï¼Œé‚£ä¹ˆå¤„ç†å™¨ä¼šæŠ¥ç¼ºé¡µå¼‚å¸¸ï¼Œä¸¥é‡çš„ä¼šå‡ºç°æ®µé”™è¯¯ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// include/linux/mm_types.h</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * This struct defines a memory VMM memory area. There is one of these</span></span><br><span class="line"><span class="comment"> * per VM-area/task.  A VM area is any part of the process virtual memory</span></span><br><span class="line"><span class="comment"> * space that has a special rule for the page-fault handlers (ie a shared</span></span><br><span class="line"><span class="comment"> * library, the executable area etc).</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">vm_area_struct</span> &#123;</span></span><br><span class="line">    <span class="comment">/* The first cache line has the info for VMA tree walking. */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> vm_start;     <span class="comment">/* Our start address within vm_mm. */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> vm_end;       <span class="comment">/* The first byte after our end address</span></span><br><span class="line"><span class="comment">                       within vm_mm. */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* linked list of VM areas per task, sorted by address */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">vm_area_struct</span> *<span class="title">vm_next</span>, *<span class="title">vm_prev</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rb_node</span> <span class="title">vm_rb</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Largest free memory gap in bytes to the left of this VMA.</span></span><br><span class="line"><span class="comment">     * Either between this VMA and vma-&gt;vm_prev, or between one of the</span></span><br><span class="line"><span class="comment">     * VMAs below us in the VMA rbtree and its -&gt;vm_prev. This helps</span></span><br><span class="line"><span class="comment">     * get_unmapped_area find a free area of the right size.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rb_subtree_gap;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Second cache line starts here. */</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mm_struct</span> *<span class="title">vm_mm</span>;</span>    <span class="comment">/* The address space we belong to. */</span></span><br><span class="line">    <span class="keyword">pgprot_t</span> vm_page_prot;      <span class="comment">/* Access permissions of this VMA. */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> vm_flags;     <span class="comment">/* Flags, see mm.h. */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * For areas with an address space and backing store,</span></span><br><span class="line"><span class="comment">     * linkage into the address_space-&gt;i_mmap interval tree.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">rb_node</span> <span class="title">rb</span>;</span></span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> rb_subtree_last;</span><br><span class="line">    &#125; shared;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * A file&#x27;s MAP_PRIVATE vma can be in both i_mmap tree and anon_vma</span></span><br><span class="line"><span class="comment">     * list, after a COW of one of the file pages.  A MAP_SHARED vma</span></span><br><span class="line"><span class="comment">     * can only be in the i_mmap tree.  An anonymous MAP_PRIVATE, stack</span></span><br><span class="line"><span class="comment">     * or brk vma (with NULL file) can only be in an anon_vma list.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">anon_vma_chain</span>;</span> <span class="comment">/* Serialized by mmap_sem &amp;</span></span><br><span class="line"><span class="comment">                      * page_table_lock */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">anon_vma</span> *<span class="title">anon_vma</span>;</span>  <span class="comment">/* Serialized by page_table_lock */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Function pointers to deal with this struct. */</span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">vm_operations_struct</span> *<span class="title">vm_ops</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Information about our backing store: */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> vm_pgoff;     <span class="comment">/* Offset (within vm_file) in PAGE_SIZE</span></span><br><span class="line"><span class="comment">                       units */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">file</span> * <span class="title">vm_file</span>;</span>      <span class="comment">/* File we map to (can be NULL). */</span></span><br><span class="line">    <span class="keyword">void</span> * vm_private_data;     <span class="comment">/* was vm_pte (shared mem) */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">atomic_long_t</span> swap_readahead_info;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> CONFIG_MMU</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">vm_region</span> *<span class="title">vm_region</span>;</span>    <span class="comment">/* NOMMU mapping region */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_NUMA</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mempolicy</span> *<span class="title">vm_policy</span>;</span>    <span class="comment">/* NUMA policy for the VMA */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">vm_userfaultfd_ctx</span> <span class="title">vm_userfaultfd_ctx</span>;</span></span><br><span class="line">&#125; __randomize_layout;</span><br></pre></td></tr></table></figure>

<p>è§£é‡Šä¸‹å‡ ä¸ªä¸»è¦çš„æˆå‘˜ï¼š</p>
<ul>
<li>vm_startå’Œvm_endï¼šè¡¨ç¤ºvmaçš„èµ·å§‹å’Œç»“æŸåœ°å€ï¼Œç›¸å‡å°±æ˜¯vmaçš„é•¿åº¦</li>
<li>vm_nextå’Œvm_prevï¼šé“¾è¡¨æŒ‡é’ˆ</li>
<li>vm_rbï¼šçº¢é»‘æ ‘èŠ‚ç‚¹</li>
<li>vm_mmï¼šæ‰€å±è¿›ç¨‹çš„å†…å­˜æè¿°ç¬¦mm_structæ•°æ®ç»“æ„</li>
<li>vm_page_protï¼švmaçš„è®¿é—®æƒé™</li>
<li>vm_flagsï¼švmaçš„æ ‡å¿—</li>
<li>anon_vma_chainå’Œanon_vmaï¼šç”¨äºç®¡ç†RMAPåå‘æ˜ å°„</li>
<li>vm_opsï¼šæŒ‡å‘æ“ä½œæ–¹æ³•ç»“æ„ä½“</li>
<li>vm_pgoffï¼šæ–‡ä»¶æ˜ å°„çš„åç§»é‡ã€‚</li>
<li>vm_fileï¼šæŒ‡å‘è¢«æ˜ å°„çš„æ–‡ä»¶</li>
</ul>
<h2 id="mmapç®€ä»‹"><a href="#mmapç®€ä»‹" class="headerlink" title="mmapç®€ä»‹"></a>mmapç®€ä»‹</h2><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// include&lt;sys/mman.h&gt;</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">mmap</span><span class="params">(<span class="keyword">void</span> *addr, <span class="keyword">size_t</span> length, <span class="keyword">int</span> prot, <span class="keyword">int</span> flags, <span class="keyword">int</span> fd, <span class="keyword">off_t</span> offset)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">munmap</span><span class="params">(<span class="keyword">void</span> *addr, <span class="keyword">size_t</span> length)</span></span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>addrï¼šæŒ‡å®šèµ·å§‹åœ°å€ï¼Œä¸ºäº†å¯ç§»æ¤æ€§ä¸€èˆ¬è®¾ä¸ºNULL</li>
<li>lengthï¼šè¡¨ç¤ºæ˜ å°„åˆ°è¿›ç¨‹åœ°å€ç©ºé—´çš„å¤§å°</li>
<li>protï¼šè¯»å†™å±æ€§ï¼ŒPROT_EXECã€PROT_READã€PROT_WRITEã€PROT_NONE</li>
<li>flagsï¼šæ ‡å¿—ï¼Œå¦‚å…±äº«æ˜ å°„ã€ç§æœ‰æ˜ å°„</li>
<li>fdï¼šæ–‡ä»¶æè¿°ç¬¦ï¼ŒåŒ¿åæ˜ å°„æ—¶è®¾ä¸º-1ã€‚</li>
<li>offsetï¼šæ–‡ä»¶æ˜ å°„æ—¶ï¼Œè¡¨ç¤ºåç§»é‡</li>
</ul>
<h3 id="flagæ ‡å¿—"><a href="#flagæ ‡å¿—" class="headerlink" title="flagæ ‡å¿—"></a>flagæ ‡å¿—</h3><ul>
<li>MAP_SHAREDï¼šåˆ›å»ºä¸€ä¸ªå…±äº«çš„æ˜ å°„åŒºåŸŸã€‚å¤šä¸ªè¿›ç¨‹å¯ä»¥è¿™æ ·æ˜ å°„åŒä¸€ä¸ªæ–‡ä»¶ï¼Œä¿®æ”¹åçš„å†…å®¹ä¼šåŒæ­¥åˆ°ç£ç›˜æ–‡ä»¶ä¸­ã€‚</li>
<li>MAP_PRIVATEï¼šåˆ›å»ºå†™æ—¶å¤åˆ¶çš„ç§æœ‰æ˜ å°„ã€‚å¤šä¸ªè¿›ç¨‹å¯ä»¥ç§æœ‰æ˜ å°„åŒä¸€ä¸ªæ–‡ä»¶ï¼Œä¿®æ”¹ä¹‹åä¸ä¼šåŒæ­¥åˆ°ç£ç›˜ä¸­ã€‚</li>
<li>MAP_ANONYMOUSï¼šåˆ›å»ºåŒ¿åæ˜ å°„ï¼Œå³æ²¡æœ‰å…³è”åˆ°æ–‡ä»¶çš„æ˜ å°„</li>
<li>MAP_FIXEDï¼šä½¿ç”¨å‚æ•°addråˆ›å»ºæ˜ å°„ï¼Œå¦‚æœæ— æ³•æ˜ å°„æŒ‡å®šçš„åœ°å€å°±è¿”å›å¤±è´¥ï¼Œaddrè¦æ±‚æŒ‰é¡µå¯¹é½ã€‚å¦‚æœæŒ‡å®šçš„åœ°å€ç©ºé—´ä¸å·²æœ‰çš„VMAé‡å ï¼Œä¼šå…ˆé”€æ¯é‡å çš„åŒºåŸŸã€‚</li>
<li>MAP_POPULATEï¼šå¯¹äºæ–‡ä»¶æ˜ å°„ï¼Œä¼šæå‰é¢„è¯»æ–‡ä»¶å†…å®¹åˆ°æ˜ å°„åŒºåŸŸï¼Œè¯¥ç‰¹æ€§åªæ”¯æŒç§æœ‰æ˜ å°„ã€‚</li>
</ul>
<h3 id="4ç±»æ˜ å°„"><a href="#4ç±»æ˜ å°„" class="headerlink" title="4ç±»æ˜ å°„"></a>4ç±»æ˜ å°„</h3><p>æ ¹æ®protå’Œflagsçš„ä¸åŒç»„åˆï¼Œå¯ä»¥åˆ†ä¸ºä»¥ä¸‹4ç§æ˜ å°„ç±»å‹ï¼š</p>
<ul>
<li><p>ç§æœ‰åŒ¿åï¼šé€šå¸¸ç”¨äºå†…å­˜åˆ†é…ï¼ˆå¤§å—ï¼‰</p>
</li>
<li><p>ç§æœ‰æ–‡ä»¶ï¼šé€šå¸¸ç”¨äºåŠ è½½åŠ¨æ€åº“</p>
</li>
<li><p>å…±äº«åŒ¿åï¼šé€šå¸¸ç”¨äºè¿›ç¨‹é—´å…±äº«å†…å­˜ï¼Œé»˜è®¤æ‰“å¼€<code>/dev/zero</code>è¿™ä¸ªç‰¹æ®Šçš„è®¾å¤‡æ–‡ä»¶</p>
</li>
<li><p>å…±äº«æ–‡ä»¶ï¼šé€šå¸¸ç”¨äºå†…å­˜æ˜ å°„I&#x2F;Oï¼Œè¿›ç¨‹é—´é€šä¿¡</p>
</li>
</ul>
<h3 id="mmapå†…å­˜æ˜ å°„åŸç†"><a href="#mmapå†…å­˜æ˜ å°„åŸç†" class="headerlink" title="mmapå†…å­˜æ˜ å°„åŸç†"></a>mmapå†…å­˜æ˜ å°„åŸç†</h3><ol>
<li>å½“ç”¨æˆ·ç©ºé—´è°ƒç”¨mmapæ—¶ï¼Œç³»ç»Ÿä¼šå¯»æ‰¾ä¸€æ®µæ»¡è¶³è¦æ±‚çš„è¿ç»­è™šæ‹Ÿåœ°å€ï¼Œç„¶ååˆ›å»ºä¸€ä¸ªæ–°çš„vmaæ’å…¥åˆ°mmç³»ç»Ÿçš„é“¾è¡¨å’Œçº¢é»‘æ ‘ä¸­ã€‚</li>
<li>è°ƒç”¨å†…æ ¸ç©ºé—´mmapï¼Œå»ºç«‹æ–‡ä»¶å—&#x2F;è®¾å¤‡ç‰©ç†åœ°å€å’Œè¿›ç¨‹è™šæ‹Ÿåœ°å€vmaçš„æ˜ å°„å…³ç³»<ol>
<li>å¦‚æœæ˜¯ç£ç›˜æ–‡ä»¶ï¼Œæ²¡æœ‰ç‰¹åˆ«è®¾ç½®æ ‡å¿—çš„è¯è¿™é‡Œåªæ˜¯å»ºç«‹æ˜ å°„ä¸ä¼šå®é™…åˆ†é…å†…å­˜ã€‚</li>
<li>å¦‚æœæ˜¯è®¾å¤‡æ–‡ä»¶ï¼Œç›´æ¥é€šè¿‡remap_pfn_rangeå‡½æ•°å»ºç«‹è®¾å¤‡ç‰©ç†åœ°å€åˆ°è™šæ‹Ÿåœ°å€çš„æ˜ å°„ã€‚</li>
</ol>
</li>
<li>ï¼ˆå¦‚æœæ˜¯ç£ç›˜æ–‡ä»¶æ˜ å°„ï¼‰å½“è¿›ç¨‹å¯¹è¿™ç‰‡æ˜ å°„åœ°å€ç©ºé—´è¿›è¡Œè®¿é—®æ—¶ï¼Œå¼•å‘ç¼ºé¡µå¼‚å¸¸ï¼Œå°†æ•°æ®ä»ç£ç›˜ä¸­æ‹·è´åˆ°ç‰©ç†å†…å­˜ã€‚åç»­ç”¨æˆ·ç©ºé—´å°±å¯ä»¥ç›´æ¥å¯¹è¿™å—å†…æ ¸ç©ºé—´çš„ç‰©ç†å†…å­˜è¿›è¡Œè¯»å†™ï¼Œçœå»äº†ç”¨æˆ·ç©ºé—´è·Ÿå†…æ ¸ç©ºé—´ä¹‹é—´çš„æ‹·è´è¿‡ç¨‹ã€‚</li>
</ol>
<h2 id="å†…æ ¸ä»£ç åˆ†æ"><a href="#å†…æ ¸ä»£ç åˆ†æ" class="headerlink" title="å†…æ ¸ä»£ç åˆ†æ"></a>å†…æ ¸ä»£ç åˆ†æ</h2><p>å½“æˆ‘ä»¬åœ¨ç”¨æˆ·ç©ºé—´è°ƒç”¨mmapæ—¶ï¼Œé¦–å…ˆé€šè¿‡ç³»ç»Ÿè°ƒç”¨è¿›å…¥å†…æ ¸ç©ºé—´ï¼Œå¯ä»¥çœ‹åˆ°è¿™é‡Œå°†offsetè½¬æˆäº†ä»¥é¡µä¸ºå•ä½ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// arch/x86/kernel/sys_x86_64.c</span></span><br><span class="line">SYSCALL_DEFINE6(mmap, <span class="keyword">unsigned</span> <span class="keyword">long</span>, addr, <span class="keyword">unsigned</span> <span class="keyword">long</span>, len,</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span>, prot, <span class="keyword">unsigned</span> <span class="keyword">long</span>, flags,</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span>, fd, <span class="keyword">unsigned</span> <span class="keyword">long</span>, off)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">long</span> error;</span><br><span class="line">    error = -EINVAL;</span><br><span class="line">    <span class="keyword">if</span> (off &amp; ~PAGE_MASK)</span><br><span class="line">        <span class="keyword">goto</span> out;</span><br><span class="line"></span><br><span class="line">    error = sys_mmap_pgoff(addr, len, prot, flags, fd, off &gt;&gt; PAGE_SHIFT);</span><br><span class="line">out:</span><br><span class="line">    <span class="keyword">return</span> error;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ¥çœ‹ç³»ç»Ÿè°ƒç”¨<code>sys_mmap_pgoff</code>ï¼Œå¦‚æœæ˜¯ä¸æ˜¯åŒ¿åæ˜ å°„ï¼Œä¼šé€šè¿‡fdè·å–fileç»“æ„ä½“ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// mm/mmap.c</span></span><br><span class="line">SYSCALL_DEFINE6(mmap_pgoff, <span class="keyword">unsigned</span> <span class="keyword">long</span>, addr, <span class="keyword">unsigned</span> <span class="keyword">long</span>, len,</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span>, prot, <span class="keyword">unsigned</span> <span class="keyword">long</span>, flags,</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span>, fd, <span class="keyword">unsigned</span> <span class="keyword">long</span>, pgoff)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">file</span> *<span class="title">file</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> retval;</span><br><span class="line">    <span class="keyword">if</span> (!(flags &amp; MAP_ANONYMOUS)) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        file = fget(fd);</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    retval = vm_mmap_pgoff(file, addr, len, prot, flags, pgoff);</span><br><span class="line">    <span class="keyword">return</span> retval;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ¥ç€çœ‹<code>vm_mmap_pgoff</code>å‡½æ•°ï¼Œè¿™é‡Œä¸»è¦ç”¨ä¿¡å·é‡å¯¹è¿›ç¨‹åœ°å€ç©ºé—´åšäº†ä¸€ä¸ªä¿æŠ¤ï¼Œç„¶åæ ¹æ®populateçš„å€¼ä¼šprefaulté¡µè¡¨ï¼Œå¦‚æœæ˜¯æ–‡ä»¶æ˜ å°„åˆ™ä¼šå¯¹æ–‡ä»¶è¿›è¡Œé¢„è¯»ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// mm/util.c</span></span><br><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="title">vm_mmap_pgoff</span><span class="params">(struct file *file, <span class="keyword">unsigned</span> <span class="keyword">long</span> addr,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">unsigned</span> <span class="keyword">long</span> len, <span class="keyword">unsigned</span> <span class="keyword">long</span> prot,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">unsigned</span> <span class="keyword">long</span> flag, <span class="keyword">unsigned</span> <span class="keyword">long</span> pgoff)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> ret;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mm_struct</span> *<span class="title">mm</span> =</span> current-&gt;mm;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> populate;</span><br><span class="line">    LIST_HEAD(uf);</span><br><span class="line"></span><br><span class="line">    ret = security_mmap_file(file, prot, flag);</span><br><span class="line">    <span class="keyword">if</span> (!ret) &#123;</span><br><span class="line">        <span class="keyword">if</span> (down_write_killable(&amp;mm-&gt;mmap_sem))</span><br><span class="line">            <span class="keyword">return</span> -EINTR;</span><br><span class="line">        ret = do_mmap_pgoff(file, addr, len, prot, flag, pgoff,</span><br><span class="line">                    &amp;populate, &amp;uf);</span><br><span class="line">        up_write(&amp;mm-&gt;mmap_sem);</span><br><span class="line">        userfaultfd_unmap_complete(mm, &amp;uf);</span><br><span class="line">        <span class="keyword">if</span> (populate)</span><br><span class="line">            mm_populate(ret, populate);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>do_mmap_pgoff</code>åªæ˜¯ç®€å•è°ƒç”¨<code>do_mmap</code></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// include/linux/mm.h</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">unsigned</span> <span class="keyword">long</span></span></span><br><span class="line"><span class="function"><span class="title">do_mmap_pgoff</span><span class="params">(struct file *file, <span class="keyword">unsigned</span> <span class="keyword">long</span> addr,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">unsigned</span> <span class="keyword">long</span> len, <span class="keyword">unsigned</span> <span class="keyword">long</span> prot, <span class="keyword">unsigned</span> <span class="keyword">long</span> flags,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">unsigned</span> <span class="keyword">long</span> pgoff, <span class="keyword">unsigned</span> <span class="keyword">long</span> *populate,</span></span></span><br><span class="line"><span class="params"><span class="function">    struct list_head *uf)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> do_mmap(file, addr, len, prot, flags, <span class="number">0</span>, pgoff, populate, uf);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬æ¥çœ‹<code>do_mmap</code>å®ç°ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// mm/mmap.c</span></span><br><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="title">do_mmap</span><span class="params">(struct file *file, <span class="keyword">unsigned</span> <span class="keyword">long</span> addr,</span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="keyword">unsigned</span> <span class="keyword">long</span> len, <span class="keyword">unsigned</span> <span class="keyword">long</span> prot,</span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="keyword">unsigned</span> <span class="keyword">long</span> flags, <span class="keyword">vm_flags_t</span> vm_flags,</span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="keyword">unsigned</span> <span class="keyword">long</span> pgoff, <span class="keyword">unsigned</span> <span class="keyword">long</span> *populate,</span></span></span><br><span class="line"><span class="params"><span class="function">            struct list_head *uf)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mm_struct</span> *<span class="title">mm</span> =</span> current-&gt;mm;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    len = PAGE_ALIGN(len);</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    addr = get_unmapped_area(file, addr, len, pgoff, flags);</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    addr = mmap_region(file, addr, len, vm_flags, pgoff, uf);</span><br><span class="line">    <span class="keyword">if</span> (!IS_ERR_VALUE(addr) &amp;&amp;</span><br><span class="line">        ((vm_flags &amp; VM_LOCKED) ||</span><br><span class="line">         (flags &amp; (MAP_POPULATE | MAP_NONBLOCK)) == MAP_POPULATE))</span><br><span class="line">        *populate = len;</span><br><span class="line">    <span class="keyword">return</span> addr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªå‡½æ•°ä¸»è¦å°†æ˜ å°„é•¿åº¦é¡µå¯¹é½ï¼Œå¯¹protå±æ€§å’Œflagsæ ‡å¿—è¿›è¡Œäº†æ£€æŸ¥å’Œå¤„ç†ï¼Œè®¾ç½®äº†vm_flagsã€‚<code>get_unmapped_area</code>å‡½æ•°æ£€æŸ¥æŒ‡å®šçš„åœ°å€æˆ–è‡ªåŠ¨é€‰æ‹©å¯ç”¨çš„è™šæ‹Ÿåœ°å€ã€‚ç„¶åå°±è°ƒç”¨<code>mmap_region</code>ï¼Œå¯ä»¥çœ‹åˆ°è¿”å›ä¹‹åï¼Œæ ¹æ®è°ƒç”¨æ¥å£æ—¶è®¾ç½®çš„flagså¯¹populateè¿›è¡Œäº†è®¾ç½®ã€‚å¦‚æœè®¾ç½®äº†<code>MAP_LOCKED</code>ï¼Œæˆ–è€…è®¾ç½®äº†<code>MAP_POPULATE</code>ä½†æ²¡æœ‰è®¾ç½®<code>MAP_NONBLOCK</code>ï¼Œå°±è¿›è¡Œå‰é¢æåˆ°çš„prefaultæ“ä½œã€‚</p>
<p>ç„¶åç»§ç»­çœ‹<code>mmap_region</code></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// mm/mmap.c</span></span><br><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="title">mmap_region</span><span class="params">(struct file *file, <span class="keyword">unsigned</span> <span class="keyword">long</span> addr,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">unsigned</span> <span class="keyword">long</span> len, <span class="keyword">vm_flags_t</span> vm_flags, <span class="keyword">unsigned</span> <span class="keyword">long</span> pgoff,</span></span></span><br><span class="line"><span class="params"><span class="function">        struct list_head *uf)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    vma = vma_merge(mm, prev, addr, addr + len, vm_flags,</span><br><span class="line">            <span class="literal">NULL</span>, file, pgoff, <span class="literal">NULL</span>, NULL_VM_UFFD_CTX);</span><br><span class="line">    <span class="keyword">if</span> (vma)    <span class="comment">// å¯ä»¥è·Ÿä¹‹å‰çš„æ˜ å°„åˆå¹¶</span></span><br><span class="line">        <span class="keyword">goto</span> out;</span><br><span class="line">    </span><br><span class="line">    vma = kmem_cache_zalloc(vm_area_cachep, GFP_KERNEL);</span><br><span class="line">    vma-&gt;vm_mm = mm;</span><br><span class="line">    vma-&gt;vm_start = addr;</span><br><span class="line">    vma-&gt;vm_end = addr + len;</span><br><span class="line">    vma-&gt;vm_flags = vm_flags;</span><br><span class="line">    vma-&gt;vm_page_prot = vm_get_page_prot(vm_flags);</span><br><span class="line">    vma-&gt;vm_pgoff = pgoff;</span><br><span class="line">    INIT_LIST_HEAD(&amp;vma-&gt;anon_vma_chain);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (file) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        vma-&gt;vm_file = get_file(file);</span><br><span class="line">        error = call_mmap(file, vma);   <span class="comment">// è°ƒç”¨æ–‡ä»¶çš„mmap</span></span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (vm_flags &amp; VM_SHARED) &#123;</span><br><span class="line">        error = shmem_zero_setup(vma);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">return</span> addr;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¯¥å‡½æ•°é¦–å…ˆåšäº†ä¸€äº›åœ°å€ç©ºé—´æ£€æŸ¥ï¼Œæ¥ç€<code>vma_merge</code>æ£€æŸ¥æ˜¯å¦å¯ä»¥å’Œè€çš„æ˜ å°„åˆå¹¶ï¼Œç„¶åå°±æ˜¯åˆ†é…vmaå¹¶åˆå§‹åŒ–ã€‚å¦‚æœæ˜¯æ–‡ä»¶æ˜ å°„ï¼Œè°ƒç”¨<code>call_mmap</code>ï¼›å¦‚æœæ˜¯åŒ¿åå…±äº«æ˜ å°„ï¼Œè°ƒç”¨<code>shmem_zero_setup</code>ï¼Œå®ƒé‡Œé¢ä¼šè¿›è¡Œ<code>/dev/zero</code>æ–‡ä»¶ç›¸å…³è®¾ç½®ã€‚</p>
<p><code>call_mmap</code>åªæ˜¯ç®€å•åœ°è°ƒç”¨æ–‡ä»¶å¥æŸ„ä¸­çš„mmapæ“ä½œå‡½æ•°ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// include/linux/fs.h</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">call_mmap</span><span class="params">(struct file *file, struct vm_area_struct *vma)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> file-&gt;f_op-&gt;mmap(file, vma);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¦‚æœæ˜¯æ™®é€šæ–‡ä»¶ç³»ç»Ÿä¸­çš„æ–‡ä»¶çš„è¯ï¼Œæˆ‘ä»¬ä»¥ext4ä¸ºä¾‹ï¼Œé‡Œé¢ä¸»è¦æ˜¯è®¾ç½®äº†<code>vma-&gt;vm_ops</code>ä¸º<code>ext4_file_vm_ops</code>ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// fs/ext4/file.c</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">ext4_file_mmap</span><span class="params">(struct file *file, struct vm_area_struct *vma)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    vma-&gt;vm_ops = &amp;ext4_file_vm_ops;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">vm_operations_struct</span> <span class="title">ext4_file_vm_ops</span> =</span> &#123;</span><br><span class="line">    .fault      = ext4_filemap_fault,</span><br><span class="line">    .map_pages  = filemap_map_pages,</span><br><span class="line">    .page_mkwrite   = ext4_page_mkwrite,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>åç»­å½“è®¿é—®è¿™ä¸ªvmaåœ°å€ç©ºé—´æ—¶ï¼Œå°±ä¼šè°ƒç”¨ç›¸åº”çš„æ“ä½œå‡½æ•°è¿›è¡Œå¤„ç†ï¼Œæ¯”å¦‚é¡µé”™è¯¯å¤„ç†å‡½æ•°ä¼šè°ƒç”¨<code>ext4_filemap_fault</code>ï¼Œé‡Œé¢åˆä¼šè°ƒç”¨<code>filemap_fault</code>ã€‚</p>
<p>å¦‚æœæ˜¯è®¾å¤‡æ–‡ä»¶çš„è¯ï¼Œç”±ç›¸åº”çš„è®¾å¤‡é©±åŠ¨å®ç°mmapæ–¹æ³•ï¼Œåœ¨é‡Œé¢å»ºç«‹è®¾å¤‡ç‰©ç†å†…å­˜åˆ°vmaåœ°å€ç©ºé—´çš„æ˜ å°„ã€‚æ¥ä¸‹æ¥é€šè¿‡ä¸€ä¸ªç®€å•çš„é©±åŠ¨demoæ¥æ¼”ç¤ºã€‚</p>
<p>ç®€å•æ€»ç»“ä¸€ä¸‹</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mmap                        // offsetè½¬æˆé¡µä¸ºå•ä½</span><br><span class="line">+-- sys_mmap_pgoff          // é€šè¿‡fdè·å–file</span><br><span class="line">    +-- vm_mmap_pgoff       // ä¿¡å·é‡ä¿æŠ¤ï¼Œæ˜ å°„å®Œæˆåpopulate</span><br><span class="line">        +-- do_mmap_pgoff   // ç®€å•å°è£…</span><br><span class="line">            +-- do_mmap     // æ˜ å°„é•¿åº¦é¡µå¯¹é½ï¼Œprotå’Œflagsæ£€æŸ¥ï¼Œè®¾ç½®vm_flagsï¼Œè·å–æ˜ å°„è™šæ‹Ÿåœ°å€</span><br><span class="line">                +-- mmap_region      // åœ°å€ç©ºé—´æ£€æŸ¥ï¼Œvma_mergeï¼Œvmaåˆ†é…åŠåˆå§‹åŒ–</span><br><span class="line">                    |-- call_mmap    // æ–‡ä»¶æ˜ å°„ï¼Œç®€å•å°è£…</span><br><span class="line">                    |   +-- file-&gt;f_op-&gt;mmap    // è°ƒç”¨å®é™…æ–‡ä»¶çš„mmapæ–¹æ³•</span><br><span class="line">                    |-- shmem_zero_setup       // åŒ¿åå…±äº«æ˜ å°„ï¼Œ/dev/zero</span><br></pre></td></tr></table></figure>



<h2 id="é©±åŠ¨demo"><a href="#é©±åŠ¨demo" class="headerlink" title="é©±åŠ¨demo"></a>é©±åŠ¨demo</h2><p>æˆ‘ä»¬ç¼–å†™äº†ä¸€ä¸ªç®€å•çš„miscè®¾å¤‡ï¼Œåœ¨é©±åŠ¨åŠ è½½çš„æ—¶å€™ä½¿ç”¨<code>alloc_pages</code>åˆ†é…è®¾å¤‡çš„ç‰©ç†å†…å­˜ï¼ˆ4é¡µï¼‰ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥ä½¿ç”¨kmallocæˆ–vmallocã€‚ç„¶åå®ç°äº†å‡ ä¸ªæ“ä½œæ–¹æ³•ï¼Œå…¶ä¸­æœ€ä¸»è¦çš„å°±æ˜¯mmapæ–¹æ³•ï¼Œä¸ºäº†æ–¹ä¾¿æµ‹è¯•æˆ‘ä»¬è¿˜å®ç°äº†readã€writeã€llseekç­‰æ–¹æ³•ã€‚</p>
<div class="note default">
            <p>ps: é©±åŠ¨åŠæµ‹è¯•ç¨‹åºä»£ç å·²ä¸Šä¼ githubï¼Œ<a href="https://github.com/catbro666/mmap-driver-demo">catbro666&#x2F;mmap-driver-demo</a></p>
          </div>



<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/fs.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/mm.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/gfp.h&gt;</span>          <span class="comment">// alloc_page</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/miscdevice.h&gt;</span>   <span class="comment">// miscdevice misc_xxx</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/uaccess.h&gt;</span>      <span class="comment">// copy_from/to_user</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DEMO_NAME <span class="meta-string">&quot;demo_dev&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PAGE_ORDER 2</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX_SIZE (PAGE_SIZE &lt;&lt; PAGE_ORDER)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">mydemodrv_device</span>;</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">char</span> *device_buffer = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">demodrv_fops</span> =</span> &#123;</span><br><span class="line">    .owner      = THIS_MODULE,</span><br><span class="line">    .open       = demodrv_open,</span><br><span class="line">    .release    = demodrv_release,</span><br><span class="line">    .read       = demodrv_read,</span><br><span class="line">    .write      = demodrv_write,</span><br><span class="line">    .mmap       = demodev_mmap,</span><br><span class="line">    .llseek     = demodev_llseek</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">miscdevice</span> <span class="title">mydemodrv_misc_device</span> =</span> &#123;</span><br><span class="line">    .minor = MISC_DYNAMIC_MINOR,</span><br><span class="line">    .name = DEMO_NAME,</span><br><span class="line">    .fops = &amp;demodrv_fops,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> __init <span class="title">demo_dev_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">    ret = misc_register(&amp;mydemodrv_misc_device);</span><br><span class="line">    <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">        printk(<span class="string">&quot;failed to register misc device&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mydemodrv_device = mydemodrv_misc_device.this_device;</span><br><span class="line"></span><br><span class="line">    printk(<span class="string">&quot;succeeded register misc device: %s\n&quot;</span>, DEMO_NAME);</span><br><span class="line"></span><br><span class="line">    page = alloc_pages(GFP_KERNEL, PAGE_ORDER);</span><br><span class="line">    <span class="keyword">if</span> (!page) &#123;</span><br><span class="line">        printk(<span class="string">&quot;alloc_page failed\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> -ENOMEM;</span><br><span class="line">    &#125;</span><br><span class="line">    device_buffer = page_address(page);</span><br><span class="line">    printk(<span class="string">&quot;device_buffer physical address: %lx, virtual address: %px\n&quot;</span>,</span><br><span class="line">           page_to_pfn(page) &lt;&lt; PAGE_SHIFT, device_buffer);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> __exit <span class="title">demo_dev_exit</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    printk(<span class="string">&quot;removing device\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    __free_pages(page, PAGE_ORDER);</span><br><span class="line"></span><br><span class="line">    misc_deregister(&amp;mydemodrv_misc_device);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(demo_dev_init);</span><br><span class="line">module_exit(demo_dev_exit);</span><br><span class="line">MODULE_AUTHOR(<span class="string">&quot;catbro666&quot;</span>);</span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL v2&quot;</span>);</span><br><span class="line">MODULE_DESCRIPTION(<span class="string">&quot;mmap test module&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œä¸»è¦çœ‹ä¸€ä¸‹mmapæ–¹æ³•çš„å®ç°ï¼Œæ ¸å¿ƒå‡½æ•°æ˜¯<code>remap_pfn_range</code>ï¼Œå®ƒç”¨äºå»ºç«‹å®é™…ç‰©ç†åœ°å€åˆ°vmaè™šæ‹Ÿåœ°å€çš„æ˜ å°„ã€‚æˆ‘ä»¬æ¥çœ‹ä¸‹å®ƒçš„å‚æ•°ï¼Œç¬¬ä¸€ä¸ªæ˜¯è¦æ˜ å°„çš„ç”¨æˆ·ç©ºé—´vmaï¼Œç¬¬äºŒä¸ªæ˜¯æ˜ å°„èµ·å§‹åœ°å€ï¼Œç¬¬ä¸‰ä¸ªæ˜¯å†…æ ¸å†…å­˜çš„ç‰©ç†é¡µå¸§å·ï¼Œç¬¬å››ä¸ªæ˜¯æ˜ å°„åŒºåŸŸçš„å¤§å°ï¼Œç¬¬äº”ä¸ªæ˜¯å¯¹è¿™ä¸ªæ˜ å°„çš„é¡µä¿æŠ¤æ ‡å¿—ã€‚</p>
<p>æˆ‘ä»¬ç”¨åˆ°çš„å¤§éƒ¨åˆ†å‚æ•°é€šè¿‡vmaè·å–ï¼Œå¦‚ä¸Šä¸€èŠ‚æ‰€çœ‹åˆ°çš„ï¼Œå¤–å±‚å‡½æ•°å·²ç»åšå¥½äº†vmaåˆå§‹åŒ–å·¥ä½œã€‚å› ä¸ºæˆ‘ä»¬æ˜¯ç”¨<code>alloc_pages</code>åˆ†é…çš„å†…å­˜ï¼Œå…¶ç‰©ç†åœ°å€æ˜¯è¿ç»­çš„ï¼Œæ‰€ä»¥æ˜ å°„ä¹Ÿæ¯”è¾ƒç®€å•ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">demodev_mmap</span><span class="params">(struct file *file, struct vm_area_struct *vma)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mm_struct</span> *<span class="title">mm</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> size;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> pfn_start;</span><br><span class="line">    <span class="keyword">void</span> *virt_start;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">    mm = current-&gt;mm;</span><br><span class="line">    pfn_start = page_to_pfn(page) + vma-&gt;vm_pgoff;</span><br><span class="line">    virt_start = page_address(page) + (vma-&gt;vm_pgoff &lt;&lt; PAGE_SHIFT);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* æ˜ å°„å¤§å°ä¸è¶…è¿‡å®é™…åˆ†é…çš„ç‰©ç†å†…å­˜å¤§å° */</span></span><br><span class="line">    size = min(((<span class="number">1</span> &lt;&lt; PAGE_ORDER) - vma-&gt;vm_pgoff) &lt;&lt; PAGE_SHIFT,</span><br><span class="line">               vma-&gt;vm_end - vma-&gt;vm_start);</span><br><span class="line"></span><br><span class="line">    printk(<span class="string">&quot;phys_start: 0x%lx, offset: 0x%lx, vma_size: 0x%lx, map size:0x%lx\n&quot;</span>,</span><br><span class="line">           pfn_start &lt;&lt; PAGE_SHIFT, vma-&gt;vm_pgoff &lt;&lt; PAGE_SHIFT,</span><br><span class="line">           vma-&gt;vm_end - vma-&gt;vm_start, size);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (size &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        printk(<span class="string">&quot;%s: offset 0x%lx too large, max size is 0x%lx\n&quot;</span>, __func__,</span><br><span class="line">               vma-&gt;vm_pgoff &lt;&lt; PAGE_SHIFT, MAX_SIZE);</span><br><span class="line">        <span class="keyword">return</span> -EINVAL;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¤–å±‚vm_mmap_pgoffå·²ç»ç”¨ä¿¡å·é‡ä¿æŠ¤äº†</span></span><br><span class="line">    ret = remap_pfn_range(vma, vma-&gt;vm_start, pfn_start, size, vma-&gt;vm_page_prot);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ret) &#123;</span><br><span class="line">        printk(<span class="string">&quot;remap_pfn_range failed, vm_start: 0x%lx\n&quot;</span>, vma-&gt;vm_start);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        printk(<span class="string">&quot;map kernel 0x%px to user 0x%lx, size: 0x%lx\n&quot;</span>,</span><br><span class="line">               virt_start, vma-&gt;vm_start, size);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>å†æ¥çœ‹ä¸‹readæ–¹æ³•çš„å®ç°ï¼Œä¸»è¦å°±æ˜¯ä»è®¾å¤‡å†…å­˜ä¸­æ‹·è´æ•°æ®åˆ°ç”¨æˆ·ç©ºé—´çš„bufä¸­ï¼Œç„¶åæ›´æ–°æ–‡ä»¶åç§»ã€‚writeæ–¹æ³•ä¹Ÿæ˜¯ç±»ä¼¼ï¼Œè¿™é‡Œå°±ä¸å†å±•ç¤ºã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">ssize_t</span></span></span><br><span class="line"><span class="function"><span class="title">demodrv_read</span><span class="params">(struct file *file, <span class="keyword">char</span> __user *buf, <span class="keyword">size_t</span> count, <span class="keyword">loff_t</span> *ppos)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> actual_readed;</span><br><span class="line">    <span class="keyword">int</span> max_read;</span><br><span class="line">    <span class="keyword">int</span> need_read;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line">    max_read = PAGE_SIZE - *ppos;</span><br><span class="line">    need_read = max_read &gt; count ? count : max_read;</span><br><span class="line">    <span class="keyword">if</span> (need_read == <span class="number">0</span>)</span><br><span class="line">        dev_warn(mydemodrv_device, <span class="string">&quot;no space for read&quot;</span>);</span><br><span class="line"></span><br><span class="line">    ret = copy_to_user(buf, device_buffer + *ppos, need_read);</span><br><span class="line">    <span class="keyword">if</span> (ret == need_read)</span><br><span class="line">        <span class="keyword">return</span> -EFAULT;</span><br><span class="line">    actual_readed = need_read - ret;</span><br><span class="line">    *ppos += actual_readed;</span><br><span class="line"></span><br><span class="line">    printk(<span class="string">&quot;%s actual_readed=%d, pos=%lld\n&quot;</span>, __func__, actual_readed, *ppos);</span><br><span class="line">    <span class="keyword">return</span> actual_readed;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="æµ‹è¯•ç¨‹åº"><a href="#æµ‹è¯•ç¨‹åº" class="headerlink" title="æµ‹è¯•ç¨‹åº"></a>æµ‹è¯•ç¨‹åº</h2><h3 id="å®‰è£…é©±åŠ¨"><a href="#å®‰è£…é©±åŠ¨" class="headerlink" title="å®‰è£…é©±åŠ¨"></a>å®‰è£…é©±åŠ¨</h3><p>æˆ‘ä»¬é¦–å…ˆç¼–è¯‘å®‰è£…é©±åŠ¨ï¼Œè®¾å¤‡èŠ‚ç‚¹æ–‡ä»¶å·²ç»è‡ªåŠ¨åˆ›å»ºã€‚æŸ¥çœ‹å†…æ ¸æ—¥å¿—å¯ä»¥çœ‹åˆ°å·²ç»æˆåŠŸåˆ›å»ºäº†è®¾å¤‡ï¼Œå¹¶åˆ†é…äº†å†…å­˜ã€‚èµ·å§‹ç‰©ç†åœ°å€ä¸º0x5b1558000ï¼Œå†…æ ¸è™šæ‹Ÿåœ°å€ä¸º0xffff8d1ab1558000ã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo insmod mydemodev.ko</span><br><span class="line">$ ll /dev|grep demo</span><br><span class="line">crw-------   1 root root     10,  58 12æœˆ 12 23:33 demo_dev</span><br><span class="line">$ dmesg | tail -n 2</span><br><span class="line">[110047.799513] succeeded register misc device: demo_dev</span><br><span class="line">[110047.799517] device_buffer physical address: 5b1558000, virtual address: ffff8d1ab1558000</span><br></pre></td></tr></table></figure>

<h3 id="æµ‹è¯•ç¨‹åº1"><a href="#æµ‹è¯•ç¨‹åº1" class="headerlink" title="æµ‹è¯•ç¨‹åº1"></a>æµ‹è¯•ç¨‹åº1</h3><p>æ¥ä¸‹æ¥æˆ‘ä»¬å†™äº†å‡ ä¸ªæµ‹è¯•ç¨‹åºæ¥å¯¹è¿™ä¸ªé©±åŠ¨è¿›è¡Œæµ‹è¯•ã€‚é¦–å…ˆæ¥çœ‹ç¬¬ä¸€ä¸ªæµ‹è¯•ç¨‹åºï¼Œæˆ‘ä»¬æ‰“å¼€é©±åŠ¨è®¾å¤‡æ–‡ä»¶<code>/dev/demo_dev</code>ï¼Œç„¶åmmapæ˜ å°„äº†1é¡µçš„å¤§å°ï¼Œè¿™é‡Œå‰ååˆ†åˆ«sleepäº†5ç§’ï¼Œæ˜¯ä¸ºäº†æä¾›è§‚å¯Ÿçš„æ—¶é—´ã€‚ç„¶åé€šè¿‡æ˜ å°„çš„ç”¨æˆ·ç©ºé—´è™šæ‹Ÿåœ°å€è¿›è¡Œè¯»å†™æµ‹è¯•ï¼ŒéªŒè¯mmapæ˜¯å¦æ­£ç¡®æ˜ å°„äº†ã€‚é¦–å…ˆé€šè¿‡è™šæ‹Ÿåœ°å€å†™ï¼Œéšåç”¨readè¯»å–è¿›è¡Œæ¯”å¯¹æ£€æŸ¥ã€‚ç„¶åé€šè¿‡writeå†™ï¼Œéšåç”¨è™šæ‹Ÿåœ°å€è¯»å–è¿›è¡Œæ¯”å¯¹æ£€æŸ¥ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// test1.c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span>      <span class="comment">// printf</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span>      <span class="comment">// open</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span>     <span class="comment">// read, close, getpagesize</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span>   <span class="comment">// mmap</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span>     <span class="comment">// memcmp, strlen</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;assert.h&gt;</span>     <span class="comment">// assert</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DEMO_DEV_NAME   <span class="meta-string">&quot;/dev/demo_dev&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">64</span>];</span><br><span class="line">    <span class="keyword">int</span> fd;</span><br><span class="line">    <span class="keyword">char</span> *addr = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line">    <span class="keyword">char</span> *message = <span class="string">&quot;Hello World\n&quot;</span>;</span><br><span class="line">    <span class="keyword">char</span> *message2 = <span class="string">&quot;I&#x27;m superman\n&quot;</span>;</span><br><span class="line"></span><br><span class="line">    fd = open(DEMO_DEV_NAME, O_RDWR);</span><br><span class="line">    <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;open device %s failed\n&quot;</span>, DEMO_DEV_NAME);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    sleep(<span class="number">5</span>);</span><br><span class="line">    addr = mmap(<span class="literal">NULL</span>, (<span class="keyword">size_t</span>)getpagesize(), PROT_READ | PROT_WRITE,</span><br><span class="line">                MAP_SHARED | MAP_LOCKED, fd, <span class="number">0</span>);</span><br><span class="line">    sleep(<span class="number">5</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* æµ‹è¯•æ˜ å°„æ­£ç¡® */</span></span><br><span class="line">    <span class="comment">/* å†™åˆ°mmapæ˜ å°„çš„è™šæ‹Ÿåœ°å€ä¸­ï¼Œé€šè¿‡readè¯»å–è®¾å¤‡æ–‡ä»¶ */</span></span><br><span class="line">    ret = <span class="built_in">sprintf</span>(addr, <span class="string">&quot;%s&quot;</span>, message);</span><br><span class="line">    assert(ret == <span class="built_in">strlen</span>(message));</span><br><span class="line"></span><br><span class="line">    ret = read(fd, buf, <span class="number">64</span>);</span><br><span class="line">    assert(ret == <span class="number">64</span>);</span><br><span class="line">    assert(!<span class="built_in">memcmp</span>(buf, message, <span class="built_in">strlen</span>(message)));</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* é€šè¿‡writeå†™å…¥è®¾å¤‡æ–‡ä»¶ï¼Œä¿®æ”¹ä½“ç°åœ¨mmapæ˜ å°„çš„è™šæ‹Ÿåœ°å€ */</span></span><br><span class="line">    ret = write(fd, message2, <span class="built_in">strlen</span>(message2));</span><br><span class="line"></span><br><span class="line">    assert(ret == <span class="built_in">strlen</span>(message2));</span><br><span class="line">    assert(!<span class="built_in">memcmp</span>(addr + <span class="number">64</span>, message2, <span class="built_in">strlen</span>(message2)));</span><br><span class="line"></span><br><span class="line">    munmap(addr, (<span class="keyword">size_t</span>)getpagesize());</span><br><span class="line">    close(fd);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬ç¼–è¯‘è¿è¡Œæµ‹è¯•ç¨‹åºï¼Œç»“æœå¦‚æˆ‘ä»¬é¢„æœŸã€‚ä»å†…æ ¸æ—¥å¿—å¯ä»¥çœ‹åˆ°æ˜ å°„èµ·å§‹ç‰©ç†åœ°å€0x5b1558000ï¼Œåç§»ä¸º0ï¼Œvmaå¤§å°æ˜¯1é¡µï¼Œæ˜ å°„å¤§å°ä¹Ÿæ˜¯1é¡µã€‚å°†å†…æ ¸ç©ºé—´è™šæ‹Ÿåœ°å€0xffff8d1ab1558000æ˜ å°„åˆ°äº†ç”¨æˆ·ç©ºé—´0x7f21c0f58000ã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo ./test1</span><br><span class="line">$ dmesg|tail -n 4</span><br><span class="line">[110691.745381] phys_start: 0x5b1558000, offset: 0x0, vma_size: 0x1000, map size:0x1000</span><br><span class="line">[110691.745388] map kernel 0xffff8d1ab1558000 to user 0x7f21c0f58000, size: 0x1000</span><br><span class="line">[110696.745816] demodrv_read actual_readed=64, pos=64</span><br><span class="line">[110696.745822] demodrv_write actual_written=13, pos=77</span><br></pre></td></tr></table></figure>

<p>ä¸æ­¤åŒæ—¶ï¼Œæˆ‘ä»¬ä½¿ç”¨pmapè§‚å¯Ÿmmapå‰åçš„è¿›ç¨‹çš„åœ°å€ç©ºé—´</p>
<div><div class="fold_hider"><div class="close hider_title">ç‚¹å‡»å±•å¼€è¿›ç¨‹åœ°å€ç©ºé—´</div></div><div class="fold">
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo pmap -x $(pgrep test1)</span><br><span class="line">[sudo] password <span class="keyword">for</span> ssl:</span><br><span class="line">30830:   ./test1</span><br><span class="line">Address           Kbytes     RSS   Dirty Mode  Mapping</span><br><span class="line">0000557b19475000       4       4       0 r-x-- test1</span><br><span class="line">0000557b19475000       0       0       0 r-x-- test1</span><br><span class="line">0000557b19676000       4       4       4 r---- test1</span><br><span class="line">0000557b19676000       0       0       0 r---- test1</span><br><span class="line">0000557b19677000       4       4       4 rw--- test1</span><br><span class="line">0000557b19677000       0       0       0 rw--- test1</span><br><span class="line">00007f21c0941000    1948     888       0 r-x-- libc-2.27.so</span><br><span class="line">00007f21c0941000       0       0       0 r-x-- libc-2.27.so</span><br><span class="line">00007f21c0b28000    2048       0       0 ----- libc-2.27.so</span><br><span class="line">00007f21c0b28000       0       0       0 ----- libc-2.27.so</span><br><span class="line">00007f21c0d28000      16      16      16 r---- libc-2.27.so</span><br><span class="line">00007f21c0d28000       0       0       0 r---- libc-2.27.so</span><br><span class="line">00007f21c0d2c000       8       8       8 rw--- libc-2.27.so</span><br><span class="line">00007f21c0d2c000       0       0       0 rw--- libc-2.27.so</span><br><span class="line">00007f21c0d2e000      16       8       8 rw---   [ anon ]</span><br><span class="line">00007f21c0d2e000       0       0       0 rw---   [ anon ]</span><br><span class="line">00007f21c0d32000     156     156       0 r-x-- ld-2.27.so</span><br><span class="line">00007f21c0d32000       0       0       0 r-x-- ld-2.27.so</span><br><span class="line">00007f21c0f41000       8       8       8 rw---   [ anon ]</span><br><span class="line">00007f21c0f41000       0       0       0 rw---   [ anon ]</span><br><span class="line">00007f21c0f59000       4       4       4 r---- ld-2.27.so</span><br><span class="line">00007f21c0f59000       0       0       0 r---- ld-2.27.so</span><br><span class="line">00007f21c0f5a000       4       4       4 rw--- ld-2.27.so</span><br><span class="line">00007f21c0f5a000       0       0       0 rw--- ld-2.27.so</span><br><span class="line">00007f21c0f5b000       4       4       4 rw---   [ anon ]</span><br><span class="line">00007f21c0f5b000       0       0       0 rw---   [ anon ]</span><br><span class="line">00007ffdacdf1000     132       8       8 rw---   [ stack ]</span><br><span class="line">00007ffdacdf1000       0       0       0 rw---   [ stack ]</span><br><span class="line">00007ffdacf3c000      12       0       0 r----   [ anon ]</span><br><span class="line">00007ffdacf3c000       0       0       0 r----   [ anon ]</span><br><span class="line">00007ffdacf3f000       4       4       0 r-x--   [ anon ]</span><br><span class="line">00007ffdacf3f000       0       0       0 r-x--   [ anon ]</span><br><span class="line">ffffffffff600000       4       0       0 --x--   [ anon ]</span><br><span class="line">ffffffffff600000       0       0       0 --x--   [ anon ]</span><br><span class="line">---------------- ------- ------- -------</span><br><span class="line">total kB            4376    1120      68</span><br><span class="line"></span><br><span class="line">$ sudo pmap -x $(pgrep test1)</span><br><span class="line">30830:   ./test1</span><br><span class="line">Address           Kbytes     RSS   Dirty Mode  Mapping</span><br><span class="line">0000557b19475000       4       4       0 r-x-- test1</span><br><span class="line">0000557b19475000       0       0       0 r-x-- test1</span><br><span class="line">0000557b19676000       4       4       4 r---- test1</span><br><span class="line">0000557b19676000       0       0       0 r---- test1</span><br><span class="line">0000557b19677000       4       4       4 rw--- test1</span><br><span class="line">0000557b19677000       0       0       0 rw--- test1</span><br><span class="line">00007f21c0941000    1948     888       0 r-x-- libc-2.27.so</span><br><span class="line">00007f21c0941000       0       0       0 r-x-- libc-2.27.so</span><br><span class="line">00007f21c0b28000    2048       0       0 ----- libc-2.27.so</span><br><span class="line">00007f21c0b28000       0       0       0 ----- libc-2.27.so</span><br><span class="line">00007f21c0d28000      16      16      16 r---- libc-2.27.so</span><br><span class="line">00007f21c0d28000       0       0       0 r---- libc-2.27.so</span><br><span class="line">00007f21c0d2c000       8       8       8 rw--- libc-2.27.so</span><br><span class="line">00007f21c0d2c000       0       0       0 rw--- libc-2.27.so</span><br><span class="line">00007f21c0d2e000      16       8       8 rw---   [ anon ]</span><br><span class="line">00007f21c0d2e000       0       0       0 rw---   [ anon ]</span><br><span class="line">00007f21c0d32000     156     156       0 r-x-- ld-2.27.so</span><br><span class="line">00007f21c0d32000       0       0       0 r-x-- ld-2.27.so</span><br><span class="line">00007f21c0f41000       8       8       8 rw---   [ anon ]</span><br><span class="line">00007f21c0f41000       0       0       0 rw---   [ anon ]</span><br><span class="line">00007f21c0f58000       4       0       0 rw-s- demo_dev</span><br><span class="line">00007f21c0f58000       0       0       0 rw-s- demo_dev</span><br><span class="line">00007f21c0f59000       4       4       4 r---- ld-2.27.so</span><br><span class="line">00007f21c0f59000       0       0       0 r---- ld-2.27.so</span><br><span class="line">00007f21c0f5a000       4       4       4 rw--- ld-2.27.so</span><br><span class="line">00007f21c0f5a000       0       0       0 rw--- ld-2.27.so</span><br><span class="line">00007f21c0f5b000       4       4       4 rw---   [ anon ]</span><br><span class="line">00007f21c0f5b000       0       0       0 rw---   [ anon ]</span><br><span class="line">00007ffdacdf1000     132       8       8 rw---   [ stack ]</span><br><span class="line">00007ffdacdf1000       0       0       0 rw---   [ stack ]</span><br><span class="line">00007ffdacf3c000      12       0       0 r----   [ anon ]</span><br><span class="line">00007ffdacf3c000       0       0       0 r----   [ anon ]</span><br><span class="line">00007ffdacf3f000       4       4       0 r-x--   [ anon ]</span><br><span class="line">00007ffdacf3f000       0       0       0 r-x--   [ anon ]</span><br><span class="line">ffffffffff600000       4       0       0 --x--   [ anon ]</span><br><span class="line">ffffffffff600000       0       0       0 --x--   [ anon ]</span><br><span class="line">---------------- ------- ------- -------</span><br><span class="line">total kB            4380    1120      68</span><br></pre></td></tr></table></figure>

</div></div>

<p>å¯ä»¥çœ‹åˆ°mmapä¹‹åå¤šäº†ä¸€ä¸ªå«åšdemo_devçš„æ®µï¼Œå…¶èµ·å§‹åœ°å€å°±æ˜¯æˆ‘ä»¬æ˜ å°„çš„ç”¨æˆ·ç©ºé—´åœ°å€0x7f21c0f58000ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">00007f21c0f58000       4       0       0 rw-s- demo_dev</span><br><span class="line">00007f21c0f58000       0       0       0 rw-s- demo_dev</span><br></pre></td></tr></table></figure>

<h3 id="æµ‹è¯•ç¨‹åº2"><a href="#æµ‹è¯•ç¨‹åº2" class="headerlink" title="æµ‹è¯•ç¨‹åº2"></a>æµ‹è¯•ç¨‹åº2</h3><p>æµ‹è¯•ç¨‹åº2å·®åˆ«ä¸å¤§ï¼Œæ‰“å¼€åŒä¸€ä¸ªè®¾å¤‡æ–‡ä»¶ï¼Œmmapå»ºç«‹ç›¸åŒçš„æ˜ å°„ï¼Œç„¶ååˆ†åˆ«é€šè¿‡readå’Œè™šæ‹Ÿåœ°å€è¯»å–å‰ä¸€ä¸ªç¨‹åºå†™çš„å†…å®¹ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// test.2</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">64</span>];</span><br><span class="line">    <span class="keyword">int</span> fd;</span><br><span class="line">    <span class="keyword">char</span> *addr = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line">    <span class="keyword">char</span> *message = <span class="string">&quot;Hello World\n&quot;</span>;</span><br><span class="line">    <span class="keyword">char</span> *message2 = <span class="string">&quot;I&#x27;m superman\n&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* å¦ä¸€è¿›ç¨‹æ‰“å¼€åŒä¸€è®¾å¤‡æ–‡ä»¶ï¼Œç„¶åç”¨mmapæ˜ å°„ */</span></span><br><span class="line">    fd = open(DEMO_DEV_NAME, O_RDWR);</span><br><span class="line">    <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;open device %s failed\n&quot;</span>, DEMO_DEV_NAME);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    addr = mmap(<span class="literal">NULL</span>, (<span class="keyword">size_t</span>)getpagesize(), PROT_READ | PROT_WRITE,</span><br><span class="line">                MAP_SHARED | MAP_LOCKED, fd, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* é€šè¿‡readè¯»å–è®¾å¤‡æ–‡ä»¶ */</span></span><br><span class="line">    ret = read(fd, buf, <span class="keyword">sizeof</span>(buf));</span><br><span class="line"></span><br><span class="line">    assert(ret == <span class="keyword">sizeof</span>(buf));</span><br><span class="line">    assert(!<span class="built_in">memcmp</span>(buf, message, <span class="built_in">strlen</span>(message)));</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* é€šè¿‡mmapæ˜ å°„çš„è™šæ‹Ÿåœ°å€è¯»å– */</span></span><br><span class="line">    assert(!<span class="built_in">memcmp</span>(addr + <span class="keyword">sizeof</span>(buf), message2, <span class="built_in">strlen</span>(message2)));</span><br><span class="line"></span><br><span class="line">    munmap(addr, (<span class="keyword">size_t</span>)getpagesize());</span><br><span class="line">    close(fd);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç¼–è¯‘è¿è¡Œï¼Œæµ‹è¯•ç»“æœå¦‚æˆ‘ä»¬é¢„æœŸã€‚åŒä¸€ä¸ªå†…æ ¸è™šæ‹Ÿåœ°å€ç°åœ¨æ˜ å°„åˆ°äº†ä¸åŒçš„ç”¨æˆ·ç©ºé—´è™šæ‹Ÿåœ°å€ã€‚é€šè¿‡mmapæˆ‘ä»¬å®ç°äº†è¿›ç¨‹é—´é€šä¿¡ã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo ./test2</span><br><span class="line">$ dmesg|tail -n 3</span><br><span class="line">[111333.818374] phys_start: 0x5b1558000, offset: 0x0, vma_size: 0x1000, map size:0x1000</span><br><span class="line">[111333.818378] map kernel 0xffff8d1ab1558000 to user 0x7f015ee94000, size: 0x1000</span><br><span class="line">[111333.818381] demodrv_read actual_readed=64, pos=64</span><br></pre></td></tr></table></figure>

<h3 id="æµ‹è¯•ç¨‹åº3"><a href="#æµ‹è¯•ç¨‹åº3" class="headerlink" title="æµ‹è¯•ç¨‹åº3"></a>æµ‹è¯•ç¨‹åº3</h3><p>è¿™æ¬¡æˆ‘ä»¬æ¥æµ‹è¯•ä¸€äº›ç‰¹æ®Šæƒ…å†µï¼Œæ˜ å°„çš„å¤§å°æ”¹æˆäº†1ä¸ªå­—èŠ‚ï¼Œæ ¹æ®å‰é¢çš„ä»£ç åˆ†æï¼Œæ˜ å°„æ˜¯éœ€è¦é¡µå¯¹é½çš„ï¼Œæ‰€ä»¥é¢„æœŸå®é™…ä¼šæ˜ å°„ä¸€ä¸ªé¡µã€‚åœ¨ä¸€é¡µçš„èŒƒå›´å†…æ˜¯å¯ä»¥æ­£å¸¸è¯»å†™çš„ã€‚ç„¶åå°è¯•å†™åˆ°vmaæ˜ å°„èŒƒå›´ä¹‹å¤–ï¼Œé¢„æœŸä¼šå‡ºç°æ®µé”™è¯¯ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">64</span>];</span><br><span class="line">    <span class="keyword">int</span> fd;</span><br><span class="line">    <span class="keyword">char</span> *addr = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">off_t</span> offset;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line">    <span class="keyword">char</span> *message = <span class="string">&quot;Hello World\n&quot;</span>;</span><br><span class="line">    <span class="keyword">char</span> *message2 = <span class="string">&quot;I&#x27;m superman\n&quot;</span>;</span><br><span class="line"></span><br><span class="line">    fd = open(DEMO_DEV_NAME, O_RDWR);</span><br><span class="line">    <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;open device %s failed\n&quot;</span>, DEMO_DEV_NAME);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* æ˜ å°„1ä¸ªå­—èŠ‚ */</span></span><br><span class="line">    addr = mmap(<span class="literal">NULL</span>, <span class="number">1</span>, PROT_READ | PROT_WRITE,</span><br><span class="line">                MAP_SHARED | MAP_LOCKED, fd, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* å†™åˆ°mmapæ˜ å°„çš„è™šæ‹Ÿåœ°å€ä¸­ï¼Œé€šè¿‡readè¯»å–è®¾å¤‡æ–‡ä»¶ */</span></span><br><span class="line">    ret =<span class="built_in">sprintf</span>(addr, <span class="string">&quot;%s&quot;</span>, message);</span><br><span class="line">    assert(ret == <span class="built_in">strlen</span>(message));</span><br><span class="line"></span><br><span class="line">    ret = read(fd, buf, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">    assert(ret == <span class="keyword">sizeof</span>(buf));</span><br><span class="line">    assert(!<span class="built_in">memcmp</span>(buf, message, <span class="built_in">strlen</span>(message)));</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* å†™åˆ°ä¸€é¡µçš„å°¾éƒ¨ */</span></span><br><span class="line">    ret = <span class="built_in">sprintf</span>(addr + getpagesize() - <span class="keyword">sizeof</span>(buf), <span class="string">&quot;%s&quot;</span>, message2);</span><br><span class="line">    assert(ret == <span class="built_in">strlen</span>(message2));</span><br><span class="line"></span><br><span class="line">    offset = lseek(fd, getpagesize() - <span class="keyword">sizeof</span>(buf), SEEK_SET);</span><br><span class="line">    assert(offset == getpagesize() - <span class="keyword">sizeof</span>(buf));</span><br><span class="line"></span><br><span class="line">    ret = read(fd, buf, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">    assert(ret == <span class="keyword">sizeof</span>(buf));</span><br><span class="line">    assert(!<span class="built_in">memcmp</span>(buf, message2, <span class="built_in">strlen</span>(message2)));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* å†™åˆ°ä¸€é¡µä¹‹åï¼Œè¶…å‡ºæ˜ å°„èŒƒå›´ */</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;expect segment error\n&quot;</span>);</span><br><span class="line">    ret = <span class="built_in">sprintf</span>(addr + getpagesize(), <span class="string">&quot;something&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;never reach here\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    munmap(addr, <span class="number">1</span>);</span><br><span class="line">    close(fd);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬ç¼–è¯‘è¿è¡Œæµ‹è¯•ï¼Œç»“æœå¦‚æˆ‘ä»¬é¢„æœŸï¼Œå®é™…æ˜ å°„äº†1é¡µçš„å¤§å°ï¼Œå½“å°è¯•è¶…å‡ºæ˜ å°„èŒƒå›´å†™æ—¶ï¼Œå‡ºç°äº†æ®µé”™è¯¯ï¼ˆSIGSEGVï¼‰ã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo ./test3</span><br><span class="line">expect segment error</span><br><span class="line">Segmentation fault</span><br><span class="line">$ dmesg|tail -n 6</span><br><span class="line">[111762.605089] phys_start: 0x5b1558000, offset: 0x0, vma_size: 0x1000, map size:0x1000</span><br><span class="line">[111762.605093] map kernel 0xffff8d1ab1558000 to user 0x7f96b5d08000, size: 0x1000</span><br><span class="line">[111762.605105] demodrv_read actual_readed=64, pos=64</span><br><span class="line">[111762.605110] demodrv_read actual_readed=64, pos=4096</span><br><span class="line">[111762.605165] test3[31001]: segfault at 7f96b5d09000 ip 0000560c0fd3ad25 sp 00007ffc5a515330 error 7 <span class="keyword">in</span> test3[560c0fd3a000+2000]</span><br><span class="line">[111762.605170] Code: e8 80 fb ff ff 48 8d 3d 1a 02 00 00 e8 14 fb ff ff e8 cf fb ff ff 48 63 d0 48 8b 45 80 48 01 d0 48 bb 73 6f 6d 65 74 68 69 6e &lt;48&gt; 89 18 66 c7 40 08 67 00 c7 85 7c ff ff ff 09 00 00 00 48 8d 3d</span><br></pre></td></tr></table></figure>

<h3 id="æµ‹è¯•ç¨‹åº4"><a href="#æµ‹è¯•ç¨‹åº4" class="headerlink" title="æµ‹è¯•ç¨‹åº4"></a>æµ‹è¯•ç¨‹åº4</h3><p>è¿™æ¬¡æˆ‘ä»¬åˆä¿®æ”¹äº†mmapçš„å‚æ•°ï¼Œè¿™æ¬¡æ˜ å°„äº†2é¡µçš„å¤§å°ï¼Œåç§»è®¾ç½®ä¸º3é¡µã€‚å› ä¸ºæˆ‘ä»¬è®¾å¤‡åˆ†é…çš„ç‰©ç†å†…å­˜å¤§å°æ˜¯4é¡µï¼Œæ‰€ä»¥æ˜ å°„çš„ç¬¬2é¡µå·²ç»è¶…å‡ºäº†å®é™…çš„è®¾å¤‡ç‰©ç†å†…å­˜ã€‚é¢„æœŸæ˜ å°„çš„ç¬¬ä¸€é¡µå¯ä»¥æ­£å¸¸è¯»å†™ï¼Œç¬¬äºŒé¡µä¼šå‡ºç°busé”™è¯¯ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">64</span>];</span><br><span class="line">    <span class="keyword">int</span> fd;</span><br><span class="line">    <span class="keyword">char</span> *addr = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">off_t</span> offset;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line">    <span class="keyword">char</span> *message = <span class="string">&quot;Hello World\n&quot;</span>;</span><br><span class="line">    <span class="keyword">char</span> *message2 = <span class="string">&quot;I&#x27;m superman\n&quot;</span>;</span><br><span class="line"></span><br><span class="line">    fd = open(DEMO_DEV_NAME, O_RDWR);</span><br><span class="line">    <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;open device %s failed\n&quot;</span>, DEMO_DEV_NAME);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* æ˜ å°„2é¡µï¼Œoffset 3é¡µ */</span></span><br><span class="line">    addr = mmap(<span class="literal">NULL</span>, getpagesize() * <span class="number">2</span>, PROT_READ | PROT_WRITE,</span><br><span class="line">                MAP_SHARED | MAP_LOCKED, fd, getpagesize() * <span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* å†™åˆ°mmapæ˜ å°„çš„è™šæ‹Ÿåœ°å€ä¸­ï¼Œé€šè¿‡readè¯»å–è®¾å¤‡æ–‡ä»¶ */</span></span><br><span class="line">    ret =<span class="built_in">sprintf</span>(addr, <span class="string">&quot;%s&quot;</span>, message);</span><br><span class="line">    assert(ret == <span class="built_in">strlen</span>(message));</span><br><span class="line"></span><br><span class="line">    offset = lseek(fd, getpagesize() * <span class="number">3</span>, SEEK_SET);</span><br><span class="line">    ret = read(fd, buf, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">    assert(ret == <span class="keyword">sizeof</span>(buf));</span><br><span class="line">    assert(!<span class="built_in">memcmp</span>(buf, message, <span class="built_in">strlen</span>(message)));</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* å†™åˆ°ä¸€é¡µä¹‹åï¼Œè¶…å‡ºå®é™…ç‰©ç†å†…å­˜èŒƒå›´ */</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;expect bus error\n&quot;</span>);</span><br><span class="line">    ret = <span class="built_in">sprintf</span>(addr + getpagesize(), <span class="string">&quot;something&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;never reach here\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    munmap(addr, getpagesize() * <span class="number">2</span>);</span><br><span class="line">    close(fd);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç¼–è¯‘è¿è¡Œæµ‹è¯•ç¨‹åºï¼Œç»“æœå¦‚é¢„æœŸã€‚è™½ç„¶vmaçš„å¤§å°ä¸º2é¡µï¼Œä½†æ˜¯å®é™…åªæ˜ å°„äº†1é¡µçš„ç‰©ç†å†…å­˜ï¼Œå½“å°è¯•å†™åˆ°ç¬¬äºŒé¡µæ—¶å‡ºç°äº†busé”™è¯¯(SIGBUS)ã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo ./test4</span><br><span class="line">expect bus error</span><br><span class="line">Bus error</span><br><span class="line">$ dmesg|tail -n 3</span><br><span class="line">[112105.841706] phys_start: 0x5b155b000, offset: 0x3000, vma_size: 0x2000, map size:0x1000</span><br><span class="line">[112105.841710] map kernel 0xffff8d1ab155b000 to user 0x7fe662ec4000, size: 0x1000</span><br><span class="line">[112105.841723] demodrv_read actual_readed=64, pos=12352</span><br></pre></td></tr></table></figure>



<h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ul>
<li><p><a href="https://developpaper.com/linux-virtual-address-space/">linux-virtual-address-space&#x2F;</a></p>
</li>
<li><p><a href="https://www.kernel.org/doc/Documentation/x86/x86_64/mm.txt">virtual memory map</a></p>
</li>
<li><p>linux-4.15å†…æ ¸æºç </p>
</li>
</ul>
]]></content>
      <categories>
        <category>æ“ä½œç³»ç»Ÿ</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>å†…å­˜ç®¡ç†</tag>
        <tag>mmap</tag>
      </tags>
  </entry>
  <entry>
    <title>ä»å‹æµ‹ç¢°åˆ°çš„è¯¡å¼‚æ–­è¿é—®é¢˜èŠèŠNginxçš„è¿æ¥ç®¡ç†å’Œæ€§èƒ½è°ƒæµ‹</title>
    <url>/posts/4198933e/</url>
    <content><![CDATA[<div class="note primary">
            <p>Nginxæ˜¯ç›®å‰ä½¿ç”¨æœ€å¹¿æ³›çš„WebæœåŠ¡å™¨ä¹‹ä¸€ï¼Œä»¥é«˜æ€§èƒ½è€Œè‘—ç§°ï¼Œå¾—ç›Šäºå…¶å¼‚æ­¥äº‹ä»¶é©±åŠ¨æ¶æ„ï¼Œåœ¨é«˜å¹¶å‘ä¸‹ä»ç„¶å¯ä»¥ä¿æŒä½æ¶ˆè€—é«˜æ€§èƒ½ï¼Œè€Œæ¨¡å—åŒ–çš„è®¾è®¡ä¹Ÿä½¿å…¶æ›´æ˜“æ‰©å±•ï¼Œä¸°å¯Œäº†å…¶åŠŸèƒ½ã€‚å¯¹äºNginxåŸºæœ¬çš„ä»‹ç»ç½‘ä¸Šå·²æœ‰å¾ˆå¤šçš„æ–‡ç« ï¼Œä¹Ÿæœ‰åƒã€Šæ·±å…¥ç†è§£Nginxã€‹è¿™æ ·çš„ä¹¦ç±è®²è§£Nginxçš„æ¶æ„è®¾è®¡ä¸å¼€å‘æ–¹æ³•ã€‚æœ¬æ–‡ä¸ä¼šæ¶‰åŠNginxå¼€å‘ç›¸å…³å†…å®¹ï¼Œè€Œæ˜¯ä»¥ä¸€ä¸ªå®é™…é—®é¢˜çš„å®šä½è¿‡ç¨‹ä½œä¸ºå¼•å­ï¼ŒèŠä¸€ä¸‹Nginxçš„è¿æ¥ç®¡ç†å’Œæ€§èƒ½è°ƒæµ‹ã€‚å¦‚æœä½ å¹¶ä¸å…³å¿ƒè¿™ä¸ªå®é™…é—®é¢˜ï¼Œå¯ä»¥ç›´æ¥è·³åˆ°<a href="#%E8%BF%9E%E6%8E%A5%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F">è¿æ¥ç”Ÿå‘½å‘¨æœŸ</a>ã€‚</p>
          </div>

<span id="more"></span>

<h2 id="é—®é¢˜æè¿°"><a href="#é—®é¢˜æè¿°" class="headerlink" title="é—®é¢˜æè¿°"></a>é—®é¢˜æè¿°</h2><p>é—®é¢˜æ˜¯è¿™æ ·çš„ï¼Œæˆ‘ä»¬çš„NginxæœåŠ¡æ˜¯ä½œä¸ºHTTPåå‘ä»£ç†ï¼Œå‰ç«¯æ˜¯HTTPSï¼Œåç«¯æ˜¯HTTPã€‚åœ¨ä¸€æ¬¡å‹æµ‹è¿‡ç¨‹ä¸­ç¢°åˆ°äº†è¿æ¥å¼‚å¸¸æ–­å¼€çš„é—®é¢˜ï¼Œä½†æ˜¯Nginxè¿™è¾¹æ²¡æœ‰å‘ç°ä»»ä½•çš„é”™è¯¯æ—¥å¿—ï¼ˆå·²ç»å¼€äº†Infoçº§åˆ«ä¹Ÿæ²¡æœ‰ï¼‰ã€‚å› ä¸ºæ˜¯åœ¨å®¢æˆ·é‚£è¾¹è¿›è¡Œçš„æµ‹è¯•ï¼Œè€Œä¸”æ˜¯åŒäº‹åœ¨å¯¹æ¥çš„é¡¹ç›®ï¼Œæˆ‘å¹¶ä¸äº†è§£ç¬¬ä¸€æ‰‹çš„æƒ…å†µï¼ŒåŒ…æ‹¬æµ‹è¯•æ–¹æ³•ã€Nginxçš„é…ç½®ç­‰ï¼Œå”¯ä¸€ç»™åˆ°æˆ‘è¿™è¾¹çš„å°±æ˜¯ä¸€ä¸ªæŠ“åŒ…ï¼Œåªæœ‰è¿™ä¸ªæ˜¯ç¡®å‡¿çš„ä¿¡æ¯ï¼Œå…¶ä½™çš„å°±æ˜¯ä¸€äº›é›¶æ˜Ÿçš„å£å¤´è½¬è¿°ã€‚åŒäº‹å¤šæ¬¡å°è¯•åœ¨å…¬å¸å¤ç°è¿™ä¸ªé—®é¢˜ä½†æ²¡æœ‰æˆåŠŸã€‚</p>
<p>æŠ“åŒ…çš„æƒ…å†µæ˜¯è¿™æ ·çš„ï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/catbro666/catbro666.github.io/posts/4198933e/packages-captured-in-client-environment.png" alt="packages-captured-in-client-environment.png" loading="lazy"></p>
<p>æŠ“åŒ…æ–‡ä»¶å¾ˆå¤§ï¼Œåœ¨ä¸€æ®µå¾ˆçŸ­çš„æ—¶é—´å†…å‡ºç°å¾ˆå¤šè¿ç»­çš„è¿™ç§é”™è¯¯ã€‚ä¸Šé¢çš„æˆªå›¾ä¸­æ˜¯è·Ÿå‰ç«¯çš„äº¤äº’ï¼Œå› ä¸ºæ˜¯å‹æµ‹çš„å…³ç³»ï¼ŒçŸ­æ—¶é—´æœ‰å¤§é‡çš„åŒ…ï¼Œæ‰€ä»¥ä»æŠ“åŒ…ä¸­æ— æ³•ç¡®å®šå¯¹åº”çš„åç«¯è¿æ¥ï¼Œä¸æ¸…æ¥šåç«¯è¿æ¥æ˜¯å¦å·²ç»å»ºç«‹ï¼Œæ˜¯å¦æ˜¯åç«¯å‡ºé”™äº†ã€‚</p>
<h2 id="é—®é¢˜å®šä½"><a href="#é—®é¢˜å®šä½" class="headerlink" title="é—®é¢˜å®šä½"></a>é—®é¢˜å®šä½</h2><p>æˆ‘ä»¬é¦–å…ˆåˆ†æä¸‹ä¸Šå›¾ä¸­æŠ“åŒ…çš„æƒ…å†µï¼Œå‰é¢æ˜¯ä¸€ä¸ªGMVPNçš„æ¡æ‰‹ï¼Œå› ä¸ºå‹æµ‹çš„å…³ç³»ï¼ŒæœåŠ¡ç«¯å›å¤ServerHelloæ¶ˆæ¯ä»¥åŠåé¢çš„ChangeCipherSpecæ¶ˆæ¯éƒ½éš”äº†ä¸€ä¸¤ç§’çš„æ—¶é—´ã€‚æ¡å®Œæ‰‹ä¹‹åå®¢æˆ·ç«¯å‘äº†ä¸¤ä¸ªåº”ç”¨æ•°æ®åŒ…ï¼ˆå¯¹åº”HTTPè¯·æ±‚å¤´å’Œè¯·æ±‚ä½“ï¼‰ã€‚å¤§æ¦‚ä¸¤ç§’ä¹‹åï¼ŒæœåŠ¡ç«¯å‘é€äº†ä¸€ä¸ªalertæ¶ˆæ¯ï¼Œç„¶åç´§æ¥ç€å‘é€äº†ä¸€ä¸ªresetã€‚</p>
<p>åŒäº‹è¿˜è§‚å¯Ÿåˆ°ï¼ŒæŠ“åŒ…ä¸­ä»æ”¶åˆ°åº”ç”¨æ•°æ®åˆ°è¿æ¥æ–­å¼€çš„æ—¶é—´éƒ½æ˜¯2så·¦å³ï¼Œæ‰€ä»¥çŒœæµ‹å¯èƒ½è·Ÿè¶…æ—¶æœ‰å…³ã€‚resetçš„å‘é€åŸå› ä¹Ÿæ˜¯ä¸€ä¸ªå…³é”®çš„çº¿ç´¢ï¼Œå¦å¤–è¿˜æœ‰å‰é¢æåˆ°çš„Nginxæ—¥å¿—ï¼ˆInfoçº§åˆ«ï¼‰ä¸­æ²¡æœ‰ä»»ä½•é”™è¯¯ã€‚æˆ‘ä»¬å°±æ ¹æ®è¿™å‡ ä¸ªçº¿ç´¢æ¥è¿›è¡Œé—®é¢˜çš„å®šä½ï¼Œé¦–å…ˆæ¥åˆ†æresetçš„æƒ…å†µã€‚</p>
<h3 id="resetåŸå› "><a href="#resetåŸå› " class="headerlink" title="resetåŸå› "></a>resetåŸå› </h3><p>æœ‰å¾ˆå¤šæƒ…å†µéƒ½ä¼šè§¦å‘TCPçš„resetï¼Œå…¶ä¸­å¤§éƒ¨åˆ†éƒ½æ˜¯å†…æ ¸è‡ªèº«çš„è¡Œä¸ºã€‚</p>
<ul>
<li><p>ç«¯å£æ²¡æœ‰ç›‘å¬</p>
<p>æ˜¾ç„¶å¯ä»¥æ’é™¤è¿™ç§æƒ…å†µï¼Œæˆ‘ä»¬çš„è¿æ¥éƒ½å·²ç»å¼€å§‹å¤„ç†äº†ã€‚</p>
</li>
<li><p>é˜²ç«å¢™æ‹¦æˆª</p>
<p>æœåŠ¡å™¨å¹¶æ²¡æœ‰é…ç½®ç±»ä¼¼çš„é˜²ç«å¢™ç­–ç•¥ï¼Œè¿™ç§æƒ…å†µä¹Ÿæ’é™¤ã€‚</p>
</li>
<li><p>å‘å·²ç»å…³é—­çš„socketå‘é€æ¶ˆæ¯</p>
<p>socketå¯èƒ½æ˜¯è¿›ç¨‹ä¸»åŠ¨å…³é—­ï¼Œä¹Ÿå¯èƒ½æ˜¯è¢«åŠ¨å…³é—­ï¼Œä¹Ÿå°±æ˜¯è¿›ç¨‹å´©äº†çš„æƒ…å†µã€‚æ˜¾ç„¶ä»æŠ“åŒ…å¯ä»¥çœ‹å‡ºæˆ‘ä»¬çš„è¿›ç¨‹å¹¶æ²¡æœ‰å´©ï¼Œå†µä¸”è¿›ç¨‹å´©äº†ä¹Ÿä¼šæœ‰å†…æ ¸æ—¥å¿—ã€‚é‚£å¦‚æœæ˜¯è¿›ç¨‹ä¸»åŠ¨å…³é—­socketçš„æƒ…å†µå‘¢ï¼Œæˆ‘ä»¬ä»æŠ“åŒ…ä¸­å¯ä»¥çœ‹åˆ°æœåŠ¡ç«¯æ˜¯åœ¨å‘é€äº†ä¸€ä¸ªEncrypted Alertæ¶ˆæ¯ä¹‹åç´§æ¥ç€å°±å‘é€äº†resetï¼Œå…¶é—´å¹¶æ²¡æœ‰æ”¶åˆ°å®¢æˆ·ç«¯çš„æ¶ˆæ¯ï¼Œæ‰€ä»¥ä¹Ÿå¯ä»¥æ’é™¤è¿™ç§æƒ…å†µã€‚</p>
</li>
<li><p>æ¥æ”¶ç¼“å†²åŒºè¿˜æœ‰æ•°æ®æœªæ¥æ”¶æ—¶å…³é—­è¯¥socket</p>
<p>å› ä¸ºæˆ‘ä»¬å¹¶ä¸æ¸…æ¥šåç«¯è¿æ¥çš„æƒ…å†µï¼Œæ‰€ä»¥æŠ“åŒ…ä¸­çš„ä¸¤ä¸ªåº”ç”¨æ•°æ®åŒ…æ˜¯å¦å·²ç»è¢«åº”ç”¨å±‚æ¥æ”¶æ˜¯æ— æ³•ç¡®å®šçš„ã€‚å› æ­¤ï¼Œè¿™ç§æƒ…å†µæ˜¯æœ‰å¯èƒ½çš„ã€‚</p>
</li>
<li><p>SO_LINGER</p>
<p>å‰é¢å‡ ç§éƒ½æ˜¯å†…æ ¸è‡ªå‘çš„è¡Œä¸ºï¼Œä¸éœ€è¦ç”¨æˆ·å‚ä¸ã€‚SO_LINGERæ˜¯ä¸€ä¸ªTCPé€‰é¡¹ï¼Œå¯ä»¥ä¿®æ”¹close()ç³»ç»Ÿè°ƒç”¨çš„è¡Œä¸ºã€‚</p>
<ul>
<li>é»˜è®¤ä¸å¼€çš„æƒ…å†µä¸‹ï¼Œcloseè°ƒç”¨ä¼šç«‹å³è¿”å›ï¼Œå‘é€é˜Ÿåˆ—ä¸€ç›´ä¿æŒåˆ°å‘é€å®Œæˆï¼Œè¿æ¥é€šè¿‡æ­£å¸¸çš„å››æ¬¡æŒ¥æ‰‹è¿›è¡Œå…³é—­ã€‚</li>
<li>æ‰“å¼€ä¸”æ—¶é—´è®¾ä¸º0çš„æƒ…å†µä¸‹ï¼Œç›´æ¥ä¸¢å¼ƒå‘é€ç¼“å†²åŒºçš„æ•°æ®ï¼Œå¹¶å‘é€RSTç»™å¯¹æ–¹ï¼ˆä¸èµ°4æ¬¡æŒ¥æ‰‹æµç¨‹ï¼‰ã€‚</li>
<li>æ‰“å¼€ä¸”æ—¶é—´ä¸ä¸º0çš„æƒ…å†µä¸‹ï¼Œè¿›ç¨‹å°†é˜»å¡ç›´åˆ°1ï¼‰æ‰€æœ‰æ•°æ®å‘é€å®Œæ¯•ä¸”æ”¶åˆ°å¯¹æ–¹ç¡®è®¤ï¼Œ2ï¼‰è¶…æ—¶æ—¶é—´åˆ°ã€‚å¯¹äºå‰è€…ä¼šæ­£å¸¸å…³é—­ï¼›å¯¹äºåè€…ï¼Œcloseå°†è¿”å›EWOULDBLOCKï¼Œç„¶åè·Ÿç¬¬äºŒç§æƒ…å†µç›¸åŒå¤„ç†ï¼Œå³ä¸”ä¸¢å¼ƒå‘é€ç¼“å†²åŒºæ•°æ®ç„¶åå‘é€RSTã€‚è¿™ç§æƒ…å†µsocketå¿…é¡»æ˜¯é˜»å¡çš„ï¼Œå¦åˆ™closeä¼šç«‹å³è¿”å›ã€‚</li>
</ul>
<p>äº†è§£äº†SO_LINGERçš„æƒ…å†µï¼Œä¸€çœ‹Nginxä»£ç ï¼Œç¡®å®æ˜¯ç”¨åˆ°äº†è¿™ä¸ªé€‰é¡¹ï¼Œä¸è¿‡åªæœ‰å½“è¿æ¥è¶…æ—¶å¹¶ä¸”æ‰“å¼€äº†reset_timeout_connectioné…ç½®é¡¹æ—¶æ‰ä¼šå»è®¾ç½®ã€‚è€Œè¿™ä¸ªé€‰é¡¹é»˜è®¤æ˜¯å…³é—­çš„ï¼Œä¸”æˆ‘ä»¬ä¹Ÿæ²¡æœ‰æ˜¾å¼åœ°è®¾ç½®è¿‡ï¼Œæ‰€ä»¥è¿™ç§æƒ…å†µä¹Ÿæ’é™¤äº†ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (r-&gt;connection-&gt;timedout) &#123;</span><br><span class="line">    clcf = ngx_http_get_module_loc_conf(r, ngx_http_core_module);</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> (clcf-&gt;reset_timedout_connection) &#123;</span><br><span class="line">        linger.l_onoff = <span class="number">1</span>;</span><br><span class="line">        linger.l_linger = <span class="number">0</span>;</span><br><span class="line">  </span><br><span class="line">        <span class="keyword">if</span> (setsockopt(r-&gt;connection-&gt;fd, SOL_SOCKET, SO_LINGER,</span><br><span class="line">                       (<span class="keyword">const</span> <span class="keyword">void</span> *) &amp;linger, <span class="keyword">sizeof</span>(struct linger)) == <span class="number">-1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            ngx_log_error(NGX_LOG_ALERT, <span class="built_in">log</span>, ngx_socket_errno,</span><br><span class="line">                          <span class="string">&quot;setsockopt(SO_LINGER) failed&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<p>è‡³æ­¤å¯ä»¥å¾—å‡ºç»“è®ºï¼Œresetçš„åŸå› å¤§æ¦‚ç‡å°±æ˜¯å› ä¸ºæ¥æ”¶ç¼“å†²åŒºè¿˜æœ‰æ•°æ®çš„æ—¶å€™å…³é—­äº†è¿æ¥ã€‚è‡³äºè¿æ¥ä¸ºä»€ä¹ˆè¢«å…³é—­ï¼Œåˆ™è¿˜éœ€è¦è¿›ä¸€æ­¥å®šä½ã€‚</p>
<h3 id="è¿æ¥å…³é—­åŸå› "><a href="#è¿æ¥å…³é—­åŸå› " class="headerlink" title="è¿æ¥å…³é—­åŸå› "></a>è¿æ¥å…³é—­åŸå› </h3><p>æ¥ç€å‰é¢çš„ç»“è®ºæˆ‘ä»¬è¿›ä¸€æ­¥æ’æŸ¥ï¼ŒSSLæ¡æ‰‹æ˜¾ç„¶æ˜¯å®Œæˆäº†ï¼Œå› ä¸ºå®¢æˆ·ç«¯å·²ç»å‘é€äº†åº”ç”¨æ•°æ®æ¶ˆæ¯ï¼Œæ‰€ä»¥åœ¨æ¥æ”¶ç¼“å†²åŒºä¸­æ•°æ®åº”è¯¥å°±æ˜¯Application Dataã€‚è‡³äºè¯·æ±‚å¤´æ˜¯å¦å·²ç»è¢«è¯»å–ç›®å‰è¿˜ä¸å¥½åˆ¤æ–­ã€‚ä¸è¿‡ä»æŠ“åŒ…å¯ä»¥çœ‹å‡ºï¼ŒæœåŠ¡ç«¯æ˜¯ç›´æ¥å…³é—­çš„è¿æ¥ï¼Œå¹¶æ²¡æœ‰ç»™å®¢æˆ·ç«¯å‘é€å“åº”ï¼Œæ‰€ä»¥å¯ä»¥ç¡®è®¤æœåŠ¡ç«¯è¿˜æ²¡æœ‰èµ°åˆ°åº”ç”¨å±‚å¤„ç†çš„ç¯èŠ‚ï¼Œè¦ä¹ˆæ˜¯è¿˜æ²¡æœ‰æ¥æ”¶è¯·æ±‚å¤´ã€è¦ä¹ˆæ˜¯è¿˜æ²¡å¤„ç†å®Œæ¯•ï¼Œå¦åˆ™è‚¯å®šä¼šæœ‰åº”ç”¨å±‚çš„å“åº”ã€‚äºæ˜¯é—®é¢˜çš„èŒƒå›´å°±ç¼©å°åˆ°äº†SSLæ¡æ‰‹å®Œæˆä¹‹åã€è¯·æ±‚å¤´å¤„ç†å®Œæ¯•ä¹‹å‰ã€‚</p>
<p>æ˜¯ä¸æ˜¯ä¹‹å‰æåˆ°çš„è¶…æ—¶åŸå› å‘¢ï¼Ÿä¸è¿‡åŒäº‹åˆæŒ‡å‡ºè¶…æ—¶æ—¶é—´å·²ç»è®¾ç½®äº†å¾ˆå¤§ï¼ˆåˆ†é’Ÿçº§åˆ«ï¼‰ï¼Œé‚£ä¼šä¸ä¼šé—æ¼äº†æŸäº›è¶…æ—¶å‘¢ã€‚ä½†æ˜¯å¥½åƒæ²¡æœ‰ä¸¤ç§’è¿™ä¹ˆçŸ­çš„è¶…æ—¶æ—¶é—´ï¼ŒNginxé»˜è®¤çš„è¶…æ—¶åŸºæœ¬éƒ½æ˜¯60sçº§åˆ«çš„ã€‚äºæ˜¯å¼€å§‹å¯»æ‰¾å¯èƒ½å­˜åœ¨çš„è¶…æ—¶ï¼Œå‘ç°SSLé˜¶æ®µå¹¶æ²¡æœ‰å•ç‹¬çš„è¶…æ—¶ï¼Œåœ¨è¯·æ±‚å¤´è¯»å®Œä¹‹å‰å°±åªæœ‰ä¸€ä¸ªè¶…æ—¶æ—¶é—´å°±æ˜¯client_header_timeoutï¼Œä½†æ˜¯æ˜¾ç„¶è¿™ä¸ªè¶…æ—¶ä¸æ˜¯2sã€‚æˆ‘ä»¬åˆç†å‡è®¾æ˜¯ç°åœºé…ç½®é”™äº†ï¼Œä½†æˆ‘åœ¨ç¡®è®¤ä»£ç åå‘ç°å¦‚æœæ˜¯è¶…æ—¶ä¹Ÿæ˜¯ä¼šæœ‰INFOçº§åˆ«ï¼Œæ¥æ”¶åˆ°è¯·æ±‚å‰å’Œæ¥æ”¶åˆ°è¯·æ±‚åéƒ½æ˜¯å¦‚æ­¤ã€‚</p>
<p>æ‰€ä»¥è¶…æ—¶è¿™æ¡è·¯èµ°ä¸é€šäº†ï¼Œå¤§æ¦‚ç‡ä¸æ˜¯ç”±äºè¶…æ—¶å¯¼è‡´çš„è¿æ¥å…³é—­ã€‚æ²¡æœ‰åŠæ³•åªèƒ½ç»§ç»­çœ‹æºç åˆ†æï¼Œçœ‹çœ‹ä»SSLæ¡æ‰‹å®Œæˆåˆ°HTTPè¯·æ±‚å¤´å¤„ç†å®Œæˆä¹‹å‰ï¼ŒNginxåˆ°åº•å¹²äº†äº›ä»€ä¹ˆã€‚åœ¨è¯¦ç»†çœ‹äº†è¿™éƒ¨åˆ†ä»£ç ä¹‹åï¼Œä¸€ä¸ªåœ¨ä¸åŒhandlerä¸­å¤šæ¬¡å‡ºç°çš„å‡½æ•°<code>ngx_reusable_connection</code>å¼•èµ·äº†æˆ‘çš„æ³¨æ„ã€‚è¿™ä¸ªå‡½æ•°ç”¨äºä¿®æ”¹è¿æ¥çš„reusableæ ‡è®°ï¼Œå¹¶ä¸”ngx_cycleç»´æŠ¤äº†ä¸€ä¸ªresuableè¿æ¥çš„é˜Ÿåˆ—ï¼Œé‚£ä¹ˆè¿™ä¸ªé˜Ÿåˆ—æ˜¯å¹²å•¥çš„å‘¢ï¼Ÿè¿›ä¸€æ­¥æ¢ç©¶å‘ç°ï¼Œ<code>ngx_get_connection</code>åœ¨è·å–æ–°è¿æ¥çš„æ—¶å€™ï¼Œå¦‚æœç©ºé—²çš„è¿æ¥ä¸è¶³ï¼Œä¼šå°è¯•é‡ç”¨éƒ¨åˆ†reusableçš„è¿æ¥ï¼ˆä¸€æ¬¡æœ€å¤š32ä¸ªï¼‰ã€‚è€Œnginxè¿æ¥åœ¨å®ŒæˆSSLæ¡æ‰‹ä¹‹åã€æ¥æ”¶åˆ°HTTPè¯·æ±‚ä¹‹å‰å°±æ˜¯å¤„äºreusableçŠ¶æ€çš„ã€‚æˆ‘ä»¬å†æ¬¡æ‰“å¼€æŠ“åŒ…æ–‡ä»¶ä¸€æ•°ï¼Œå‘ç°è¿ç»­å…³é—­çš„è¿æ¥æ­£å¥½æ˜¯31&#x2F;32ä¸ªå·¦å³ï¼Œäºæ˜¯æˆ‘ä»¬å·²ç»æœ‰å…«ä¹æˆçš„æŠŠæ¡å°±æ˜¯å› ä¸ºè¿™ä¸ªåŸå› å¯¼è‡´çš„è¿æ¥æ–­å¼€ï¼Œè€Œä¸”æ­£å¥½è¿™ç§æƒ…å†µä¸‹æˆ‘ä»¬ä½¿ç”¨ç‰ˆæœ¬çš„Nginxæ˜¯æ²¡æœ‰æ—¥å¿—çš„ï¼ˆé«˜ç‰ˆæœ¬åŠ äº†WARNçº§åˆ«æ—¥å¿—ï¼‰ã€‚</p>
<h2 id="å¤ç°é—®é¢˜"><a href="#å¤ç°é—®é¢˜" class="headerlink" title="å¤ç°é—®é¢˜"></a>å¤ç°é—®é¢˜</h2><p>ä¸ºäº†è¿›ä¸€æ­¥è¯æ˜å°±æ˜¯è¿™ä¸ªåŸå› å¯¼è‡´çš„è¿æ¥æ–­å¼€ï¼Œæˆ‘å°è¯•æ„é€ åœºæ™¯å¤ç°é—®é¢˜ï¼Œè¿™ä¸ªé—®é¢˜çš„å…³é”®åœ¨äºworkerè¿›ç¨‹çš„æ€»è¿æ¥æ•°ä¸è¶³ï¼Œä½†æ˜¯åªå»ºç«‹å‰ç«¯è¿æ¥åˆæ˜¯å¤Ÿçš„ï¼Œæœ‰å¾ˆå¤šè¿æ¥åœç•™åœ¨SSLæ¡æ‰‹å®Œæˆåˆæ²¡æœ‰å¼€å§‹å¤„ç†HTTPè¯·æ±‚å¤´çš„é˜¶æ®µã€‚å½“å…¶ä»–è¿æ¥çš„è¯·æ±‚å°è¯•å»ºç«‹åç«¯è¿æ¥æ—¶ï¼Œå°±ä¼šæŠŠè¿™äº›reusableè¿æ¥è¸¢æ‰ã€‚æ‰€ä»¥workeræœ€å¤§è¿æ¥æ•°éœ€è¦å¤§äºå‰ç«¯è¿æ¥æ•°ã€å°äºå‰ç«¯è¿æ¥æ•°çš„ä¸¤å€ã€‚</p>
<p>å› ä¸ºæˆ‘æ˜¯ç”¨è‡ªå·±è™šæ‹Ÿæœºç®€å•æµ‹è¯•ï¼Œå®¢æˆ·ç«¯ç”¨wrkè®¾ç½®äº†100ä¸ªè¿æ¥ï¼Œnginxåªé…äº†1ä¸ªworkerï¼Œæœ€å¤§è¿æ¥æ•°æ˜¯120ï¼ˆå…·ä½“æ•°å€¼å¯èƒ½æœ‰ç‚¹å‡ºå…¥ï¼Œå› ä¸ºå·²ç»è¿‡å»æœ‰æ®µæ—¶é—´äº†è®°å¾—ä¸å¤ªæ¸…æ¥šäº†ï¼‰ã€‚ä¸€æµ‹è¯•æˆåŠŸå¤ç°äº†è¿™ä¸ªé—®é¢˜ï¼ŒæŠ“åŒ…æˆªå›¾å¦‚ä¸‹ï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/catbro666/catbro666.github.io/posts/4198933e/packages-captured-when-recurring-problem-1.jpg" alt="packages-captured-when-recurring-problem-1" loading="lazy"></p>
<p>è¿™æ˜¯è·Ÿè¸ªçš„å…¶ä¸­ä¸€ä¸ªæµï¼Œå¯ä»¥çœ‹åˆ°ä¹Ÿæ˜¯åœ¨SSLæ¡æ‰‹å®Œæˆä¹‹åï¼Œæ”¶åˆ°äº†å®¢æˆ·ç«¯å‘é€çš„åº”ç”¨æ•°æ®ï¼Œç„¶åå‘é€äº†Alertä»¥åŠRSTã€‚é¡ºå¸¦æä¸€ä¸‹ï¼Œè¿™é‡Œåé¢è¿˜å¤šäº†ä¸€ä¸ªRSTï¼Œè¿™æ˜¯å› ä¸ºè¿æ¥å…³é—­ä¹‹åæ”¶åˆ°äº†å®¢æˆ·ç«¯çš„ä¸€ä¸ªACKã€‚</p>
<p>å†çœ‹ä¸‹ä¸€ä¸ªæˆªå›¾ï¼Œå¯ä»¥è§‚å¯Ÿåˆ°ï¼Œåœ¨è¿™ä¸¤ä¸ªreusableè¿æ¥è¢«è¸¢æ‰ä¹‹åï¼Œç«‹é©¬å°±å¾€åç«¯æ–°å»ºäº†ä¸¤ä¸ªè¿æ¥ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/catbro666/catbro666.github.io/posts/4198933e/packages-captured-when-recurring-problem-2.jpg" alt="packages-captured-when-recurring-problem-2" loading="lazy"></p>
<p>è‡³æ­¤ï¼Œé—®é¢˜çš„åŸå› åŸºæœ¬å·²ç»ç¡®è®¤ã€‚ç›´æ¥åŸå› å°±æ˜¯å› ä¸ºworkerè¿æ¥æ•°ä¸è¶³ã€‚</p>
<h2 id="æ€»ç»“å›é¡¾"><a href="#æ€»ç»“å›é¡¾" class="headerlink" title="æ€»ç»“å›é¡¾"></a>æ€»ç»“å›é¡¾</h2><p>é—®é¢˜åŸå› å·²ç»å®šä½åˆ°ï¼Œå†å›è¿‡å¤´çœ‹ç°åœºçš„æµ‹è¯•é…ç½®ã€‚å…¶å®æŒ‰ç…§æ‰€æœ‰workerçš„è¿æ¥æ€»æ•°æ¥ç®—ï¼Œè¿æ¥æ˜¯å¤Ÿçš„ï¼Œè€Œå•ä¸ªworkeråˆ™æ˜¯ä¸å¤Ÿçš„ã€‚ä½†æ˜¯å› ä¸ºå…¶ä»–å‡ ä¸ªé…ç½®çš„é—´æ¥ä½œç”¨å¯¼è‡´äº†è¿æ¥é›†ä¸­åœ¨äº†å•ä¸ªworkerä¸­ã€‚é¦–å…ˆï¼Œå› ä¸ºç³»ç»Ÿç‰ˆæœ¬è¾ƒä½ä¸æ”¯æŒreuseportï¼Œåªèƒ½ä¾èµ–nginxè‡ªèº«è¿›è¡Œè¿›ç¨‹é—´çš„è¿æ¥åˆ†é…ã€‚å…¶æ¬¡åˆé…ç½®äº†multi_acceptï¼Œæ‰€ä»¥åªè¦æœ‰å·²ç»å°±ç»ªçš„TCPè¿æ¥ï¼Œworkerè¿›ç¨‹å°±ä¸€ç›´è¿›è¡Œacceptï¼Œé€ æˆå•ä¸ªworkerè¿›ç¨‹çš„æ¥æ”¶äº†å¤§éƒ¨åˆ†è¿æ¥ã€‚è¿™å‡ ä¸ªå› ç´ ç»“åˆåœ¨ä¸€èµ·é€ æˆäº†æœ€ç»ˆçš„é—®é¢˜ã€‚å½’æ ¹ç»“åº•ï¼Œè¿˜æ˜¯å› ä¸ºå¯¹Nginxé…ç½®ç†è§£ä¸å¤Ÿæ·±å…¥å¯¼è‡´çš„ã€‚</p>
<h2 id="è¿æ¥ç”Ÿå‘½å‘¨æœŸ"><a href="#è¿æ¥ç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="è¿æ¥ç”Ÿå‘½å‘¨æœŸ"></a>è¿æ¥ç”Ÿå‘½å‘¨æœŸ</h2><p>åœ¨è®¨è®ºå‰é¢çš„é—®é¢˜æ—¶æˆ‘ä»¬ä¹Ÿçœ‹åˆ°äº†ï¼ŒNginxä¸­çš„è¿æ¥æ˜¯æœ‰å‡ ä¸ªä¸åŒçš„çŠ¶æ€çš„ï¼Œæˆ‘ä»¬åˆ†æˆè¿æ¥å»ºç«‹æ—¶å’Œè¿æ¥å…³é—­æ—¶ä¸¤éƒ¨åˆ†æ¥çœ‹è¿æ¥çš„ç”Ÿå‘½å‘¨æœŸã€‚</p>
<h3 id="è¿æ¥å»ºç«‹"><a href="#è¿æ¥å»ºç«‹" class="headerlink" title="è¿æ¥å»ºç«‹"></a>è¿æ¥å»ºç«‹</h3><p>ä¸‹é¢æ˜¯è¿æ¥å»ºç«‹æ—¶ä¸€ä¸ªå¤§è‡´çš„è°ƒç”¨å…³ç³»å›¾ï¼Œå®é™…æƒ…å†µè¦æ¯”ç€å¤æ‚çš„å¤šã€‚ä»»ä½•ä¸€å¤„éƒ½å¯èƒ½è¶…æ—¶æˆ–å‡ºé”™æå‰ç»ˆæ­¢è¿æ¥ï¼Œç¢°åˆ°NGX_EAGAINåˆ™å¯èƒ½å¤šæ¬¡è°ƒç”¨åŒä¸€ä¸ªhandlerã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ngx_event_accept</span><br><span class="line">|-- accept</span><br><span class="line">|-- ngx_get_connection</span><br><span class="line">+-- ngx_http_init_connection</span><br><span class="line">    |-- ngx_reusable_connection(1)</span><br><span class="line">    +-- ngx_http_ssl_handshake</span><br><span class="line">        |-- NGX_EAGAIN: ngx_reusable_connection(1)</span><br><span class="line">        |-- ngx_ssl_create_connection</span><br><span class="line">        |-- ngx_reusable_connection(0)</span><br><span class="line">        |-- ngx_ssl_handshake</span><br><span class="line">        +-- ngx_http_ssl_handshake_handler</span><br><span class="line">            |-- ngx_reusable_connection(1)</span><br><span class="line">            +-- ngx_http_wait_request_handler</span><br><span class="line">                |-- ngx_reusable_connection(0)</span><br><span class="line">                |-- ngx_http_create_request</span><br><span class="line">                +-- ngx_http_process_request_line</span><br><span class="line">                    |-- ngx_http_read_request_header</span><br><span class="line">                    |-- ngx_http_parse_request_line</span><br><span class="line">                    +-- ngx_http_process_request_headers</span><br><span class="line">                        |-- ngx_http_read_request_header</span><br><span class="line">                        |-- ngx_http_parse_header_line</span><br><span class="line">                        |-- ngx_http_process_request_header</span><br><span class="line">                        +-- ngx_http_process_request</span><br><span class="line">                            |-- Switch stat from reading to writing</span><br><span class="line">                            +-- ngx_http_handler</span><br><span class="line">                                |-- HTTP to HTTPS? certificate verify fail?</span><br><span class="line">                                +-- ngx_http_core_run_phases</span><br><span class="line">                                    +-- ngx_http_proxy_handler</span><br><span class="line">                                        +-- ngx_http_read_client_request_body</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>é¦–å…ˆï¼Œnginxæ˜¯ä»acceptæ‰å¼€å§‹æ¥æ‰‹è¿æ¥çš„å¤„ç†ï¼Œåœ¨æ­¤ä¹‹å‰åˆ™å®Œå…¨æ˜¯å†…æ ¸çš„è¡Œä¸ºã€‚ä¸è¿‡åœ¨åˆå§‹åŒ–é˜¶æ®µå¯ä»¥é€šè¿‡è®¾ç½®ä¸€äº›socketé€‰é¡¹æ¥æ”¹å˜å…¶è¡Œä¸ºï¼Œå¤§å®¶æ¯”è¾ƒç†ŸçŸ¥çš„æœ‰æ¯”å¦‚SO_REUSEPORTï¼ŒTCP_DEFER_ACCEPTã€‚å‰è€…å…è®¸å¤šä¸ªsocketç»‘å®šåˆ°åœ¨ç›¸åŒçš„åœ°å€ç«¯å£å¯¹ä¸Šï¼Œç”±å†…æ ¸åœ¨å¤šä¸ªè¿›ç¨‹çš„socketé—´è¿›è¡Œè¿æ¥æ¥æ”¶çš„è´Ÿè½½å‡è¡¡ï¼Œåè€…åˆ™å¯ä»¥æ¨è¿Ÿè¿æ¥å°±ç»ªçš„æ—¶é—´ï¼Œåªæœ‰å½“æ”¶åˆ°å®¢æˆ·ç«¯å‘æ¥çš„åº”ç”¨æ•°æ®æ—¶æ‰å¯ä»¥acceptã€‚</p>
<p>acceptä¹‹ånginxä¼šä»ç©ºé—²çš„è¿æ¥ä¸­è·å–ä¸€ä¸ªï¼Œè¿™ä¸ªåŠ¨ä½œåœ¨ngx_get_connectionä¸­å®Œæˆï¼Œç„¶åè¿›å…¥HTTPåˆå§‹åŒ–æµç¨‹ã€‚æˆ‘ä»¬è¿™é‡Œä¸»è¦å…³æ³¨è¿æ¥çŠ¶æ€çš„å˜åŒ–æƒ…å†µï¼Œå®ƒæ˜¯é€šè¿‡<strong>ngx_resuable_connection</strong>å‡½æ•°è¿›è¡Œä¿®æ”¹ã€‚æœ€åˆè¿æ¥æ˜¯å¤„äºfreeçŠ¶æ€çš„ï¼Œè¿›å…¥ngx_http_ssl_handshakeå®Œæˆä¸€äº›åŸºæœ¬çš„åˆå§‹åŒ–ä¹‹åï¼Œè¿æ¥è®¾ç½®å®šæ—¶å™¨å¼€å§‹å‡†å¤‡æ¥æ”¶æ¶ˆæ¯ï¼Œæ­¤æ—¶çš„è¶…æ—¶æ—¶é—´æ˜¯post_accept_timeoutï¼Œä¹Ÿå°±æ˜¯é…ç½®é¡¹ä¸­çš„client_header_timeoutï¼ŒåŒæ­¥åœ°è¿æ¥è¿›å…¥reusableçŠ¶æ€ã€‚ç­‰åˆ°æ¥æ”¶åˆ°SSLæ¡æ‰‹æ¶ˆæ¯ä¹‹åï¼Œä¼šåˆ›å»ºSSLè¿æ¥ï¼ŒåŒæ­¥åœ°nginxè¿æ¥è¿›å…¥unreusableçŠ¶æ€ã€‚åç»­ä¼šè¿›å…¥æ¡æ‰‹æµç¨‹ï¼Œç­‰åˆ°æ¡æ‰‹å®Œæˆä¹‹åï¼Œè¿æ¥åˆå˜æˆäº†reusableçŠ¶æ€ï¼Œå¼€å§‹ç­‰å¾…æ¥æ”¶HTTPè¯·æ±‚ï¼Œæ­¤æ—¶çš„è¶…æ—¶æ—¶é—´ä»ç„¶æ˜¯post_accept_timeoutã€‚ç›´åˆ°æ¥æ”¶åˆ°HTTPè¯·æ±‚ï¼Œè¿æ¥å°±æ­¤è¿›å…¥unreusableçŠ¶æ€ã€‚ä¸€ç›´åˆ°è¯·æ±‚ç»“æŸä¸ºæ­¢ï¼ŒçŠ¶æ€éƒ½ä¸å†å˜åŒ–ã€‚</p>
<h3 id="è¿æ¥å…³é—­"><a href="#è¿æ¥å…³é—­" class="headerlink" title="è¿æ¥å…³é—­"></a>è¿æ¥å…³é—­</h3><p>æ¥ä¸‹æ¥å†æ¥çœ‹ä¸‹è¯·æ±‚ç»“æŸæ—¶çš„æƒ…å†µï¼Œå¦‚æœæ˜¯çŸ­è¿æ¥çš„æƒ…å†µä¼šè¿›å…¥ngx_http_close_requestæµç¨‹ï¼Œé‡Šæ”¾è¯·æ±‚ä¹‹åä¼šå…³é—­è¿æ¥ï¼Œè¿æ¥å˜ä¸ºfreeçŠ¶æ€è¢«æ”¾å…¥ç©ºé—²é˜Ÿåˆ—ä¸­ã€‚å¦‚æœæ˜¯é•¿è¿æ¥çš„æƒ…å†µåˆ™ä¼šè¿›å…¥ngx_http_set_keepaliveæµç¨‹ï¼Œæ­¤æ—¶è¯·æ±‚è¢«é‡Šæ”¾ï¼Œä½†æ˜¯è¿æ¥è¿›å…¥reusableçŠ¶æ€ï¼Œæ­¤æ—¶å®šæ—¶å™¨çš„è¶…æ—¶æ—¶é—´å°±æ˜¯keepalive_timeoutäº†ã€‚å¦‚æœåœ¨è¶…æ—¶æ—¶é—´å†…æ”¶åˆ°äº†æ–°çš„è¯·æ±‚ï¼Œé‚£ä¹ˆè¿æ¥åˆå˜ä¸ºunreusableçŠ¶æ€ï¼Œè¿›å…¥è¯·æ±‚çš„å¤„ç†æµç¨‹ï¼›å¦‚æœç›´åˆ°è¶…æ—¶éƒ½æ²¡æœ‰æ”¶åˆ°æ–°è¯·æ±‚ï¼Œåˆ™ä¼šè°ƒç”¨ngx_http_close_connectionå…³é—­è¿æ¥ï¼Œè¿æ¥å˜ä¸ºfreeçŠ¶æ€è¢«æ”¾å…¥ç©ºé—²é˜Ÿåˆ—ä¸­ã€‚</p>
<p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œè¿æ¥å˜æˆreusableçŠ¶æ€æ—¶ï¼Œè‚¯å®šæ˜¯å¤„äºç­‰å¾…ä»€ä¹ˆæ¶ˆæ¯çš„çŠ¶æ€ï¼ŒåŒæ­¥åœ°ä¼šæœ‰ä¸€ä¸ªå®šæ—¶å™¨å­˜åœ¨ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ngx_http_finalize_request</span><br><span class="line">+-- ngx_http_finalize_connection</span><br><span class="line">    |-- ngx_http_set_keepalive</span><br><span class="line">    |   |-- ngx_http_free_request</span><br><span class="line">    |   |-- ngx_reusable_connection(1)</span><br><span class="line">    |   +-- ngx_http_keepalive_handler</span><br><span class="line">    |       |-- ngx_http_close_connection</span><br><span class="line">    |       |-- ngx_reusable_connection(0)</span><br><span class="line">    |       |-- ngx_http_create_request</span><br><span class="line">    |       +-- ngx_http_process_request_line</span><br><span class="line">    +-- ngx_http_close_request</span><br><span class="line">        |-- ngx_http_free_request</span><br><span class="line">        +-- ngx_http_close_connection</span><br><span class="line">            |-- ngx_ssl_shutdown</span><br><span class="line">            +-- ngx_close_connection</span><br><span class="line">                |-- ngx_reusable_connection(0)</span><br><span class="line">                |-- ngx_free_connection</span><br><span class="line">                +-- ngx_close_socket</span><br></pre></td></tr></table></figure>

<p>ä¸ºäº†æ›´æ¸…æ™°åœ°è¡¨ç¤ºè¿æ¥çŠ¶æ€çš„è½¬ç§»æƒ…å†µï¼Œæˆ‘ä»¬ç”¨ä¸€å¼ å›¾æ¥æè¿°ï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/catbro666/catbro666.github.io/posts/4198933e/nginx-connection-life-cycle.png" alt="nginx-connection-life-cycle" loading="lazy"></p>
<h2 id="è¿æ¥è¶…æ—¶"><a href="#è¿æ¥è¶…æ—¶" class="headerlink" title="è¿æ¥è¶…æ—¶"></a>è¿æ¥è¶…æ—¶</h2><p>åœ¨è¿æ¥çš„å„ä¸ªé˜¶æ®µéƒ½ä¼šä¼´éšç€è¶…æ—¶çš„å­˜åœ¨ï¼Œåªè¦ä¸æ˜¯è¿›ç¨‹æ­£åœ¨å¤„ç†å½“å‰è¿æ¥ï¼Œæ€»ä¼šæœ‰æŸä¸ªå®šæ—¶å™¨ç®¡ç€å½“å‰è¿æ¥ã€‚ä»¥HTTPä¸ºä¾‹ï¼Œä¸»è¦æœ‰ä»¥ä¸‹è¿™äº›è¶…æ—¶ï¼š</p>
<ul>
<li>client_header_timeout (60s): åœ¨è¿™ä¸ªæ—¶é—´å†…ï¼Œè¿™ä¸ªè¯·æ±‚å¤´å¿…é¡»æ¥æ”¶å®Œã€‚</li>
<li>client_body_timeout (60s)ï¼šè¯»è¯·æ±‚å¤´çš„è¶…æ—¶æ—¶é—´ï¼Œåªæ˜¯é™åˆ¶ä¸¤æ¬¡è¿ç»­æ“ä½œä¹‹é—´çš„é—´éš”</li>
<li>send_timeout (60s)ï¼šå‘é€å“åº”ç»™å®¢æˆ·ç«¯çš„è¶…æ—¶æ—¶é—´ï¼ŒåŒæ ·åªæ˜¯é™åˆ¶ä¸¤æ¬¡è¿ç»­æ“ä½œä¹‹é—´çš„é—´éš”</li>
<li>proxy_connect_timeout (60s)ï¼šä¸åç«¯æœåŠ¡å™¨å»ºç«‹è¿æ¥çš„è¶…æ—¶</li>
<li>proxy_send_timeout (60s)ï¼šå‘é€è¯·æ±‚ç»™ä»£ç†æœåŠ¡å™¨çš„è¶…æ—¶ï¼Œåªæ˜¯é™åˆ¶ä¸¤æ¬¡è¿ç»­æ“ä½œä¹‹é—´çš„é—´éš”</li>
<li>proxy_read_timeout (60s)ï¼šä»ä»£ç†æœåŠ¡å™¨è¯»å“åº”çš„è¶…æ—¶ï¼Œåªæ˜¯é™åˆ¶ä¸¤æ¬¡è¿ç»­æ“ä½œä¹‹é—´çš„é—´éš”</li>
<li>keepalive_timeout (75s)ï¼šé•¿è¿æ¥ä¿æŒæ‰“å¼€çš„æ—¶é—´ã€‚</li>
<li>resolver_timeout (5s): åŸŸåè§£æçš„è¶…æ—¶æ—¶é—´</li>
</ul>
<p>è¿æ¥çš„è¶…æ—¶æ§åˆ¶ï¼Œå½“ç„¶æ˜¯ä¸ºäº†é˜²æ­¢â€œåâ€çš„è¿æ¥ä¸€ç›´å ç”¨ç³»ç»Ÿèµ„æºã€‚ä½†æ˜¯æˆ‘ä»¬æ³¨æ„åˆ°ï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰è¶…æ—¶éƒ½æ˜¯é™åˆ¶æ€»ä½“çš„æ—¶é—´ï¼Œå¾ˆå¤šè¶…æ—¶éƒ½åªæ˜¯é™åˆ¶ä¸¤æ¬¡è¿ç»­æ“ä½œä¹‹é—´çš„é—´éš”ã€‚æ‰€ä»¥ä¸€ä¸ªæ¶æ„çš„è¿æ¥ï¼Œå…¶å®è¿˜æ˜¯å¯ä»¥åšåˆ°é•¿æ—¶é—´å ç”¨ä¸€ä¸ªè¿æ¥çš„ã€‚æ¯”å¦‚å®¢æˆ·ç«¯å‘é€è¯·æ±‚ä½“æ—¶ï¼Œæ¯æ¬¡åªå‘ä¸€ä¸ªå­—èŠ‚ï¼Œä½†æ˜¯èµ¶åœ¨æœåŠ¡ç«¯è¶…æ—¶ä¹‹å‰å‘é€ç¬¬äºŒä¸ªå­—èŠ‚ã€‚å¯¹äºè¿™ç§æƒ…å†µï¼Œè²Œä¼¼æ²¡æœ‰å¤ªå¥½çš„é¿å…åŠæ³•ã€‚ä¸è¿‡æˆ‘ä»¬å¯ä»¥é€šè¿‡é™é€Ÿç­‰å…¶ä»–æ‰‹æ®µï¼Œé™åˆ¶æ¶æ„æ–¹å ç”¨çš„è¿æ¥ä¸ªæ•°ï¼Œä¸€å®šç¨‹åº¦ç¼“è§£äº†è¿™ä¸ªé—®é¢˜ã€‚</p>
<h2 id="æ€§èƒ½è°ƒæµ‹"><a href="#æ€§èƒ½è°ƒæµ‹" class="headerlink" title="æ€§èƒ½è°ƒæµ‹"></a>æ€§èƒ½è°ƒæµ‹</h2><p>å…³äºNginxçš„æ€§èƒ½è°ƒä¼˜æµ‹è¯•ï¼Œè‡³å°‘æœ‰ä»¥ä¸‹ä¸‰ä¸ªéƒ¨åˆ†æ˜¯éœ€è¦å…³æ³¨çš„ï¼šNginxé…ç½®ã€ç½‘å¡é˜Ÿåˆ—åŠirqã€å†…æ ¸ç½‘ç»œæ ˆå‚æ•°ã€‚å¦å¤–åœ¨æµ‹è¯•æ—¶åº”æ—¶åˆ»å…³æ³¨CPUã€å†…å­˜ã€IOç­‰ç³»ç»Ÿè´Ÿè½½çŠ¶å†µã€‚</p>
<h3 id="åŸºæœ¬åŸåˆ™"><a href="#åŸºæœ¬åŸåˆ™" class="headerlink" title="åŸºæœ¬åŸåˆ™"></a>åŸºæœ¬åŸåˆ™</h3><p>Linuxä¸‹æ€§èƒ½è°ƒä¼˜å…¶å®æ˜¯ä¸€ä¸ªå•ç‹¬çš„é¢†åŸŸï¼Œæˆ‘åœ¨è¿™é‡Œä¸å¯èƒ½è¯¦ç»†å±•å¼€ï¼Œä¸€æ²¡è¿™ä¸ªæ—¶é—´äºŒæ²¡è¿™ä¸ªèƒ½åŠ›ï¼Œåªä¼šä»‹ç»ä¸‹ä¸€äº›åŸºæœ¬åŸåˆ™å’Œæµ‹è¯•çš„å…³é”®æ­¥éª¤ã€‚éµå¾ªè¿™äº›å»ºè®®ï¼Œè²Œä¼¼å¢åŠ äº†å·¥ä½œé‡ï¼Œå…¶å®æœ€ç»ˆä¼šæå‡ä½ çš„æ•ˆç‡ï¼Œå‡å°‘å‡ºé”™å’Œç»•å¼¯çš„å¯èƒ½æ€§ï¼Œè€Œä¸”è¿˜æ–¹ä¾¿åç»­å¤ç°ä¸å›çœ‹ï¼Œä¸‹æ¬¡å†è¿›è¡Œç±»ä¼¼æµ‹è¯•æ—¶ä¹Ÿå¯ä»¥çœå»å¾ˆå¤šé‡å¤çš„å·¥ä½œã€‚</p>
<p>å› ä¸ºæˆ‘æ³¨æ„åˆ°å¾ˆå¤šäººå…¶å®æ˜¯ä¸æ³¨æ„è¿™äº›çš„ï¼Œä¸ç®¡ä¸‰ä¸ƒäºŒåä¸€ä¸Šæ¥å°±æ˜¯ä¸€é¡¿æµ‹è¯•ï¼Œæ‹¿åˆ°ä¸€ä¸ªæ•°æ®å°±ä»¥ä¸ºä¸‡äº‹å¤§å‰äº†ã€‚äº‹å®ä¸Šï¼Œå¯èƒ½æµ‹çš„æ ¹æœ¬ä¸æ˜¯ä»–æƒ³çš„é‚£ä¸ªä¸œè¥¿ï¼Œæµ‹è¯•å€¼è·ŸçœŸå®å€¼ç›¸å»ç”šè¿œã€‚å½“ç„¶ï¼Œåªè¦æ˜¯æµ‹è¯•è‚¯å®šä¼šå¼•å…¥å½±å“ï¼Œä¸ç¡®å®šæ€§åŸç†å·²ç»æŠŠè¿™å—æ‹¿æå¾—æ­»æ­»çš„äº†ï¼Œæˆ‘ä»¬èƒ½åšçš„å°±è®©æµ‹è¯•å€¼å°½é‡æ¥è¿‘çœŸå®å€¼ï¼Œæä¾›æœ‰å‚è€ƒæ„ä¹‰çš„ç»“æœã€‚</p>
<p>åºŸè¯ä¸å¤šè¯´ï¼Œä¸‹é¢æ˜¯ä¸€äº›å¸¸ç”¨çš„å»ºè®®ï¼š</p>
<ul>
<li>å°½å¯èƒ½è¯¦ç»†çš„è®°å½•<ul>
<li>è®°å½•è½¯ç¡¬ä»¶é…ç½®</li>
<li>ä¿å­˜å¹¶æ•´ç†æµ‹è¯•ç»“æœ</li>
<li>å†™ä¸‹å‘½ä»¤è¡Œè°ƒç”¨ï¼Œé¿å…æ¯æ¬¡æ‰‹è¾“</li>
<li>è®°å½•æŸ¥è¯¢å’Œç ”ç©¶çš„æ–‡æ¡£å’Œurlç­‰</li>
</ul>
</li>
<li>è‡ªåŠ¨æ‰§è¡Œé‡å¤ä»»åŠ¡<ul>
<li>æµ‹è¯•ä»»åŠ¡å°½é‡è‡ªåŠ¨åŒ–ï¼Œæ—¢å‡å°å‡ºé”™çš„å¯èƒ½ï¼Œä¹Ÿå‡å°äº†æµ‹è¯•è´Ÿæ‹…</li>
</ul>
</li>
<li>å°½é‡é€‰ç”¨ä½å¼€é”€çš„å·¥å…·<ul>
<li>ä½¿æˆ‘ä»¬çš„æµ‹è¯•å€¼æ›´æ¥è¿‘çœŸå®å€¼</li>
</ul>
</li>
<li>ä½¿ç”¨å¤šä¸ªå·¥å…·<ul>
<li>å¿…è¦æ—¶å¯èƒ½éœ€ä½¿ç”¨å¤šä¸ªå·¥å…·è¿›è¡Œç›¸äº’éªŒè¯ï¼Œæ’é™¤å·¥å…·æœ¬èº«çš„é—®é¢˜</li>
</ul>
</li>
<li>ç¡®å®šåŸºçº¿å’Œç›®æ ‡<ul>
<li>å•ä¸ªå€¼é€šå¸¸æ²¡æœ‰å¤ªå¤§çš„æ„ä¹‰ï¼Œä¸çŸ¥é“å®ƒæ˜¯å¥½æ˜¯åï¼Œæ²¡æœ‰å¯¹æ¯”å°±æ²¡æœ‰ä¼¤å®³</li>
</ul>
</li>
<li>åˆ†ç¦»é—®é¢˜ã€å¯¹æ¯”ã€æ§åˆ¶å˜é‡<ul>
<li>è¿™æ˜¯å®šä½é—®é¢˜çš„åŸºæœ¬æ€è·¯</li>
</ul>
</li>
<li>åšäº†ä¼˜åŒ–ä¹‹åéœ€è¦é‡æ–°è¿›è¡Œå®Œæ•´æµ‹è¯•<ul>
<li>å› ä¸ºä¸ç¡®å®šæ˜¯å¦ä¼šå¯¹å…¶ä»–é¡¹ç›®äº§ç”Ÿè´Ÿé¢å½±å“</li>
</ul>
</li>
</ul>
<h3 id="Nginxé…ç½®"><a href="#Nginxé…ç½®" class="headerlink" title="Nginxé…ç½®"></a>Nginxé…ç½®</h3><p>Nginxçš„é…ç½®éå¸¸å¤šï¼Œè¿™é‡Œåˆ—çš„åŸºæœ¬éƒ½æ˜¯æ€§èƒ½æµ‹è¯•ç›¸å…³çš„ï¼Œä¹Ÿæ˜¯æˆ‘å¹³å¸¸æ¯”è¾ƒå…³æ³¨çš„ã€‚æ³¨ï¼šä¸‹é¢å¹¶ä¸æ˜¯ä¸€ä¸ªå®Œæ•´çš„é…ç½®æ–‡ä»¶ï¼Œåªæ˜¯ä¸ºäº†æ–¹ä¾¿è§‚çœ‹ï¼Œå°†è¿™äº›é…ç½®æ”¾åœ¨äº†ä¸€èµ·ã€‚</p>
<figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="attribute">worker_processes</span> auto;</span><br><span class="line"><span class="attribute">worker_cpu_affinity</span> auto;</span><br><span class="line"><span class="attribute">worker_rlimit_nofile</span> <span class="number">1000000</span>; </span><br><span class="line"><span class="attribute">worker_priority</span> -<span class="number">10</span>;</span><br><span class="line"><span class="attribute">error_log</span> logs/error.log  <span class="literal">error</span>;</span><br><span class="line"><span class="attribute">master_process</span> <span class="literal">on</span>;</span><br><span class="line"></span><br><span class="line"><span class="section">events</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="attribute">use</span> <span class="literal">epoll</span>;</span><br><span class="line">    <span class="attribute">worker_connections</span> <span class="number">8192</span>;</span><br><span class="line">    <span class="attribute">multi_accept</span> <span class="literal">off</span>;</span><br><span class="line">    <span class="attribute">accept_mutex</span> <span class="literal">off</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">http</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="attribute">access_log</span> <span class="literal">off</span>;</span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span> <span class="number">443</span> ssl reuseport backlog=<span class="number">131072</span> deferred so_keepalive=<span class="literal">off</span>; </span><br><span class="line"></span><br><span class="line">        <span class="attribute">keepalive_requests</span>  <span class="number">0</span>;</span><br><span class="line">        <span class="attribute">keepalive_timeout</span>  <span class="number">0s</span>;</span><br><span class="line">        <span class="attribute">sendfile</span> <span class="literal">on</span>;</span><br><span class="line">        <span class="attribute">tcp_nopush</span> <span class="literal">on</span>;</span><br><span class="line">        <span class="attribute">tcp_nodelay</span> <span class="literal">on</span>;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">lingering_close</span> <span class="literal">off</span>;</span><br><span class="line">        <span class="attribute">lingering_time</span> <span class="number">1</span>;</span><br><span class="line">        <span class="attribute">lingering_timeout</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">ssl_session_cache</span>   <span class="literal">off</span>;</span><br><span class="line">        <span class="comment">#ssl_session_cache    shared:SSL:1m;</span></span><br><span class="line">        <span class="attribute">ssl_session_timeout</span>  <span class="number">5m</span>;</span><br><span class="line">        <span class="attribute">ssl_session_tickets</span> <span class="literal">off</span>;</span><br><span class="line">        <span class="comment">#ssl_verify_client on;</span></span><br><span class="line">        <span class="attribute">ssl_verify_client</span> <span class="literal">off</span>;</span><br><span class="line">        <span class="attribute">ssl_client_certificate</span> ca;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">ssl_prefer_server_ciphers</span> <span class="literal">on</span>;</span><br><span class="line">        <span class="attribute">ssl_buffer_size</span> <span class="number">65536</span>;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">proxy_cache</span> cache_zone | <span class="literal">off</span>;</span><br><span class="line">        <span class="attribute">proxy_cache_path</span> /data/nginx/cache levels=<span class="number">1</span>:<span class="number">2</span> keys_zone=cache_zone:<span class="number">10m</span>;</span><br><span class="line">        <span class="comment"># client/proxy bufferç›¸å…³</span></span><br><span class="line">        <span class="attribute">location</span> / &#123;</span><br><span class="line">            <span class="attribute">root</span>   html;</span><br><span class="line">            <span class="attribute">index</span>  index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<div><div class="fold_hider"><div class="close hider_title">ç‚¹å‡»å±•å¼€é…ç½®è¯¦è§£</div></div><div class="fold">
<h4 id="main"><a href="#main" class="headerlink" title="main"></a>main</h4><ul>
<li><p>worker_processes</p>
<p>ä¸€èˆ¬è®¾æˆautoå°±å¯ä»¥ï¼Œä¼šè‡ªåŠ¨æ ¹æ®ç³»ç»ŸCPUæ ¸å¿ƒæ•°è¿›è¡Œè®¾ç½®</p>
</li>
<li><p>worker_cpu_affinity</p>
<p>ä¸€èˆ¬autoå°±å¯ä»¥ï¼Œä¼šè‡ªåŠ¨æ¯ä¸ªè¿›ç¨‹ç»‘å®šä¸€ä¸ªæ ¸</p>
</li>
<li><p>worker_rlimit_nofile</p>
<p>è®¾ç½®è¿›ç¨‹èƒ½æ‰“å¼€çš„æœ€å¤§æ–‡ä»¶æ•°ç›®ï¼Œåº•å±‚æ˜¯è®¾ç½®çš„RLIMIT_NOFILEï¼Œä¸èƒ½è¶…è¿‡hard nofile</p>
</li>
<li><p>worker_priority</p>
<p>è®¾ç½®è¿›ç¨‹çš„ä¼˜å…ˆçº§ï¼Œè·Ÿniceå‘½ä»¤å¹²çš„äº‹æƒ…å·®ä¸å¤šï¼Œå€¼è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜ã€‚</p>
</li>
<li><p>error_log</p>
<p>æŠŠæ—¥å¿—é…ç½®ä¹Ÿåˆ—è¿›æ¥æ³¨æ„æ˜¯ä¸ºäº†æé†’å¤§å®¶ä¸è¦å¿˜è®°ä¿®æ”¹</p>
</li>
</ul>
<h4 id="event"><a href="#event" class="headerlink" title="event"></a>event</h4><ul>
<li><p>worker_connections</p>
<p>è¿›ç¨‹è¿æ¥æ•°ä¸€å®šè¦è¶³å¤Ÿï¼Œä½†æ˜¯ä¹Ÿä¸è¦æ— è„‘è®¾æˆè¶…å¤§çš„ä¸€ä¸ªå€¼ï¼Œå› ä¸ºè¿™äº›è¿æ¥çš„å†…å­˜åœ¨å¯åŠ¨æ—¶å°±ä¼šåˆ†é…ï¼Œå¯èƒ½ä¼šå¯¼è‡´å†…å­˜ä¸è¶³ã€‚å¦å¤–æä¸€ä¸‹ï¼Œè¿™æ˜¯æ•´ä¸ªworkerçš„è¿æ¥æ•°ï¼ŒåŒ…æ‹¬äº†ä¸‹æ¸¸å’Œä¸Šæ¸¸ã€‚</p>
</li>
<li><p>multi_accept</p>
<p>é»˜è®¤å…³é—­æ—¶ï¼Œè¿›ç¨‹ä¸€æ¬¡åªacceptä¸€ä¸ªè¿æ¥ï¼›æ‰“å¼€çš„æ—¶å€™è¿›ç¨‹ä¼šä¸€æ¬¡æ€§acceptæ‰€æœ‰å·²ç»å°±ç»ªçš„è¿æ¥ã€‚è¿™ä¸ªé…ç½®éœ€è¦æ ¹æ®å…·ä½“æµ‹è¯•åœºæ™¯é€‰æ‹©ï¼Œä¸€èˆ¬ä¿æŒé»˜è®¤å…³é—­ã€‚</p>
</li>
<li><p>accept_mutex</p>
<p>æ‰“å¼€æ—¶æ¯ä¸ªworkerè½®æµæ¥æ”¶æ–°è¿æ¥ï¼Œå…³é—­æ—¶åˆ™æ‰€æœ‰workeréƒ½ä¼šæ”¶åˆ°æ–°è¿æ¥é€šçŸ¥ï¼ˆå³æ‰€è°“çš„æƒŠç¾¤æ•ˆåº”ï¼‰ã€‚å¦‚æœæ–°è¿æ¥æ•°å¾ˆå°‘ï¼Œä¼šæµªè´¹ç³»ç»Ÿèµ„æºã€‚æ³¨æ„å½“ä½¿ç”¨reuseportçš„æ—¶å€™å°±æ²¡æœ‰è¿™ä¸ªé…ç½®ä»€ä¹ˆäº‹äº†ï¼Œå› ä¸ºå†…æ ¸å·²ç»åšäº†è´Ÿè½½å‡è¡¡äº†ã€‚è¿™ä¸ªé…ç½®æ˜¯å¦æ‰“å¼€ï¼Œéœ€è¦æ ¹æ®å®é™…çš„è´Ÿè½½æƒ…å†µå®æµ‹ç¡®å®šã€‚</p>
</li>
</ul>
<h4 id="http"><a href="#http" class="headerlink" title="http"></a>http</h4><ul>
<li><p>access_log</p>
<p>æ€§èƒ½æµ‹è¯•æ—¶æ—¥å¿—ä¸€èˆ¬é€‰æ‹©å…³é—­</p>
</li>
<li><p>listen</p>
<p>listenæœ‰å¾ˆå¤šé™„åŠ å‚æ•°ï¼Œå¯ä»¥é…ç½®ä¸€äº›socketé€‰é¡¹</p>
<ul>
<li><p>reuseport</p>
<p>å¯¹åº”<code>SO_REUSEPORT</code>é€‰é¡¹ï¼Œå¤šä¸ªworkerè¿›ç¨‹åˆ›å»ºç‹¬ç«‹çš„ç›‘å¬å¥—æ¥å­—ï¼Œå…è®¸å†…æ ¸åœ¨workerè¿›ç¨‹é—´å¯¹è¿æ¥çš„è¿æ¥è¿›è¡Œè´Ÿè½½å‡è¡¡ã€‚</p>
</li>
<li><p>deferred</p>
<p>å¯¹åº”<code>TCP_DEFER_ACCEPT</code>é€‰é¡¹ï¼Œå¯ä»¥æ¨è¿Ÿè¿æ¥å°±ç»ªçš„æ—¶é—´ï¼Œåªæœ‰å½“æ”¶åˆ°å®¢æˆ·ç«¯å‘æ¥çš„åº”ç”¨æ•°æ®æ—¶æ‰å¯ä»¥acceptï¼Œå¯ä»¥ç¨å¾®å‡å°æœåŠ¡ç«¯çš„å¼€é”€ã€‚</p>
</li>
<li><p>backlog</p>
<p>è®¾ç½®listenå…¨è¿æ¥é˜Ÿåˆ—å¤§å°ï¼Œä¸èƒ½è¶…è¿‡ç³»ç»Ÿ<code>net.core.somaxconn</code>çš„é™åˆ¶ã€‚è¿™ä¸ªéœ€è¦è¶³å¤Ÿå¤§ï¼Œå¦åˆ™ä¼šå½±å“æ–°å»ºè¿æ¥çš„é€Ÿåº¦ã€‚</p>
</li>
</ul>
</li>
<li><p>keepalive_requests&#x2F;keepalive_time</p>
<p> è¿™ä¸¤ä¸ªåˆ†åˆ«è®¾ç½®httpé•¿è¿æ¥çš„æœ€å¤§è¯·æ±‚æ•°å’Œè¶…æ—¶æ—¶é—´ï¼Œæ ¹æ®å®é™…æµ‹è¯•æŒ‡æ ‡é€‰æ‹©æ˜¯å¦å¯åŠ¨</p>
</li>
<li><p>sendfile</p>
<p>æ˜¯å¦ä½¿ç”¨sendfile()ç³»ç»Ÿè°ƒç”¨ï¼Œå¯ä»¥ç›´æ¥åœ¨å†…æ ¸å®Œæˆæ–‡ä»¶çš„å‘é€ï¼Œä¸éœ€è¦å†åˆ°ç”¨æˆ·æ€è½¬ä¸€æ‰‹</p>
</li>
<li><p>tcp_nopush</p>
<p>åªæœ‰ä½¿ç”¨sendfileæ—¶æ‰æ‰“å¼€è¿™ä¸ªï¼Œå¯¹åº”Linuxä¸Šçš„<code>TCP_CORK</code>é€‰é¡¹ï¼Œå“åº”å¤´å’Œæ–‡ä»¶å¼€å¤´åœ¨ä¸€ä¸ªåŒ…ä¸­å‘é€ï¼Œæ–‡ä»¶ä»¥æ»¡åŒ…å‘é€ï¼Œæå‡ç½‘ç»œæ•ˆç‡ã€‚</p>
</li>
<li><p>tcp_nodelay</p>
<p>å¯¹åº”<code>TCP_NODELAY</code>é€‰é¡¹ï¼Œè¯¥é€‰é¡¹æ˜¯é’ˆå¯¹Nagleç®—æ³•ï¼ˆåœ¨å‘å‡ºå»çš„æ•°æ®è¿˜æœªè¢«ç¡®è®¤å‰ï¼ŒæŠŠæ–°çš„å°æ•°æ®å…ˆä¿å­˜èµ·æ¥ï¼Œç­‰åˆ°å‡‘æ»¡ä¸€ä¸ªMSSæˆ–è€…æ”¶åˆ°äº†å¯¹æ–¹çš„ç¡®è®¤åå†å‘é€ï¼‰ã€‚</p>
</li>
<li><p>linger_close&#x2F;linger_time&#x2F;linger_timeout</p>
<p>è¿™å‡ ä¸ªæ§åˆ¶åœ¨å…³é—­æœåŠ¡ç«¯è¿æ¥å‰æ˜¯å¦ç­‰å¾…å’Œå¤„ç†é¢å¤–æ•°æ®ï¼Œä»¥åŠç­‰å¾…çš„æ—¶é—´ã€‚</p>
</li>
<li><p>ssl_session_cache&#x2F;ssl_session_timeout&#x2F;ssl_session_tickets</p>
<p>è¿™å‡ ä¸ªå‚æ•°æ§åˆ¶æ˜¯å¦å¯ç”¨SSLä¼šè¯é‡ç”¨ä»¥åŠè¶…æ—¶æ—¶é—´ï¼Œæ ¹æ®æµ‹è¯•æŒ‡æ ‡ç¡®å®š</p>
</li>
<li><p>ssl_verify_client&#x2F;ssl_client_certificate</p>
<p>æ˜¯å¦è¿›è¡ŒSSLåŒå‘è®¤è¯ï¼Œæ ¹æ®æµ‹è¯•éœ€æ±‚è€Œå®š</p>
</li>
<li><p>ssl_buffer_size</p>
<p>å‘é€æ•°æ®æ—¶çš„SSL bufferå¤§å°ï¼Œæˆ‘ä»¬çŸ¥é“æ•°æ®å—é•¿åº¦è¶Šå¤§ï¼Œå¯¹ç§°åŠ å¯†é€Ÿåº¦è¶Šå¿«ï¼Œæ‰€ä»¥è¿™ä¸ªé»˜è®¤å€¼è¾ƒå¤§ã€‚ä½†æ˜¯å¦‚æœä½ å¾ˆå…³å¿ƒç¬¬ä¸€ä¸ªå­—èŠ‚åˆ°è¾¾æ—¶é—´çš„è¯ï¼Œæœ€å¥½å°†è¿™ä¸ªé…ç½®æ”¹å°ä¸€ç‚¹ã€‚</p>
</li>
<li><p>proxy_cache&#x2F;proxy_cache_path</p>
<p>é™æ€æ–‡ä»¶ä½¿ç”¨cacheå¯ä»¥æé«˜æ€§èƒ½</p>
</li>
<li><p>clientå’Œproxy bufferç›¸å…³é…ç½®</p>
<p>æ ¹æ®åº”ç”¨æ•°æ®æƒ…å†µä»¥åŠå®é™…ç½‘ç»œæƒ…å†µï¼Œclientå’Œproxy bufferç›¸å…³çš„é…ç½®ä¹Ÿå¯èƒ½å½±å“æ€§èƒ½ã€‚</p>
</li>
</ul>

</div></div>



<h3 id="ç½‘å¡é˜Ÿåˆ—åŠirq"><a href="#ç½‘å¡é˜Ÿåˆ—åŠirq" class="headerlink" title="ç½‘å¡é˜Ÿåˆ—åŠirq"></a>ç½‘å¡é˜Ÿåˆ—åŠirq</h3><p>åœ¨å®é™…æµ‹è¯•ä¸­ï¼Œä½ å¯èƒ½ä¼šå‘ç°æŸäº›ä¸ªCPUä¸Šçš„siç‰¹åˆ«é«˜ï¼Œæˆä¸ºäº†æ€§èƒ½ç“¶é¢ˆã€‚è¿™æ—¶å€™å°±éœ€è¦å°†ç½‘å¡é˜Ÿåˆ—åˆ†é…åˆ°ä¸åŒCPUæ ¸ä¸Šè¿›è¡Œè½¯ä¸­æ–­çš„å¤„ç†ã€‚</p>
<h4 id="ä¸­æ–­å·ç»‘å®š"><a href="#ä¸­æ–­å·ç»‘å®š" class="headerlink" title="ä¸­æ–­å·ç»‘å®š"></a>ä¸­æ–­å·ç»‘å®š</h4><p>irqbalanceæœåŠ¡å¯ä»¥å¸®ä½ è‡ªåŠ¨ç»‘å®šä¸­æ–­å·ï¼Œä¸è¿‡å®ƒæ˜¯åŠ¨æ€å˜åŒ–çš„ï¼Œå¦‚æœä½ å¯¹irqbalanceçš„æ•ˆæœä¸æ»¡æ„ï¼Œæˆ–è€…æƒ³é™æ€ç»‘å®šï¼Œä¹Ÿå¯ä»¥è‡ªå·±æ‰‹åŠ¨è¿›è¡Œç»‘å®šã€‚æ“ä½œæ­¥éª¤å¦‚ä¸‹ï¼š</p>
<ul>
<li><p><code>cat /proc/interrupts</code>æŸ¥çœ‹å¯¹åº”ç½‘å¡çš„ä¸­æ–­å·</p>
<p>ä¸‹é¢çš„218åˆ°249å°±æ˜¯eth11è¿™ä¸ªç½‘å¡å¯¹åº”çš„ä¸­æ–­å·ï¼Œè¯¥ç½‘å¡æ‹¥æœ‰32ä¸ªé˜Ÿåˆ—ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"> 218:   17094773          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0         14         22          0          0          0          0      12697          0          0          0          0          0          0          0          0          0  IR-PCI-MSI-edge      eth11-TxRx-0</span><br><span class="line"> 219:       3119   13271410          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0  IR-PCI-MSI-edge      eth11-TxRx-1</span><br><span class="line"> 220:       2385          0   13265837          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0  IR-PCI-MSI-edge      eth11-TxRx-2</span><br><span class="line"> 221:         23          0          0   13290114          0          0          0          0          0          0          0          0       2064          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0  IR-PCI-MSI-edge      eth11-TxRx-3</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line"> 245:          0         23          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          5       2000    6603326          0          0          0          0          0          0          0     149556          0          0          0          0  IR-PCI-MSI-edge      eth11-TxRx-27</span><br><span class="line"> 246:          0         23          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          5    6869437          0          0       2000  IR-PCI-MSI-edge      eth11-TxRx-28</span><br><span class="line"> 247:          0         23          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          5          0          0    6846871       2000          0  IR-PCI-MSI-edge      eth11-TxRx-29</span><br><span class="line"> 248:          0         23          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          5          0          0          0       2000    6937093          0  IR-PCI-MSI-edge      eth11-TxRx-30</span><br><span class="line"> 249:          0         23          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          5          0          0          0       2000          0          0    6837127  IR-PCI-MSI-edge      eth11-TxRx-31</span><br></pre></td></tr></table></figure>
</li>
<li><p>æ¥ä¸‹æ¥å°†ä¸­æ–­å·ç»‘å®šåˆ°CPUæ ¸ä¸Š</p>
<p>ç¤ºä¾‹ä¸­218å·ä¸­æ–­ç»‘å®šåˆ°1å·CPU</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">echo 00000001 &gt; /proc/irq/218/smp_affinity</span><br><span class="line">echo 00000002 &gt; /proc/irq/219/smp_affinity</span><br><span class="line">echo 00000004 &gt; /proc/irq/220/smp_affinity</span><br><span class="line">echo 00000008 &gt; /proc/irq/221/smp_affinity</span><br><span class="line">echo 00000010 &gt; /proc/irq/222/smp_affinity</span><br><span class="line">echo 00000020 &gt; /proc/irq/223/smp_affinity</span><br><span class="line">echo 00000040 &gt; /proc/irq/224/smp_affinity</span><br><span class="line">echo 00000080 &gt; /proc/irq/225/smp_affinity</span><br><span class="line"># ...</span><br><span class="line">echo 01000000 &gt; /proc/irq/242/smp_affinity</span><br><span class="line">echo 02000000 &gt; /proc/irq/243/smp_affinity</span><br><span class="line">echo 04000000 &gt; /proc/irq/244/smp_affinity</span><br><span class="line">echo 08000000 &gt; /proc/irq/245/smp_affinity</span><br><span class="line">echo 10000000 &gt; /proc/irq/246/smp_affinity</span><br><span class="line">echo 20000000 &gt; /proc/irq/247/smp_affinity</span><br><span class="line">echo 40000000 &gt; /proc/irq/248/smp_affinity</span><br><span class="line">echo 80000000 &gt; /proc/irq/249/smp_affinity</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="RPS"><a href="#RPS" class="headerlink" title="RPS"></a>RPS</h4><p>æœ‰æ—¶å€™ä½ çš„ç½‘å¡ä¸æ”¯æŒå¤šé˜Ÿåˆ—ã€æˆ–è€…é˜Ÿåˆ—æ•°å°‘äºCPUæ ¸å¿ƒæ•°ã€åˆæˆ–æ˜¯NICçš„é—´æ¥è¡¨ï¼ˆIndirection Tableï¼‰çš„RXé˜Ÿåˆ—æ•°å°‘äºCPUæ ¸å¿ƒæ•°ï¼Œè¿™ä¸ªæ—¶å€™å°±éœ€è¦å€ŸåŠ©å†…æ ¸çš„<a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt">RPS&#x2F;RFSæœºåˆ¶</a>ï¼Œåœ¨è½¯ä»¶å±‚é¢å†æ¬¡è¿›è¡Œåˆ†é…ã€‚æ¯”å¦‚ä¸‹é¢çš„ä¾‹å­ï¼ŒNICçš„é—´æ¥è¡¨æœ€å¤§RXé˜Ÿåˆ—æ•°åªæœ‰16</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ethtool --show-rxfh-indir enp7s0f0</span></span><br><span class="line">RX flow <span class="built_in">hash</span> indirection table <span class="keyword">for</span> enp7s0f0 with 56 RX ring(s):</span><br><span class="line">    0:      0     1     2     3     4     5     6     7</span><br><span class="line">    8:      8     9    10    11    12    13    14    15</span><br><span class="line">   16:      0     1     2     3     4     5     6     7</span><br><span class="line">   24:      8     9    10    11    12    13    14    15</span><br><span class="line">   32:      0     1     2     3     4     5     6     7</span><br><span class="line">   40:      8     9    10    11    12    13    14    15</span><br><span class="line">   48:      0     1     2     3     4     5     6     7</span><br><span class="line">   56:      8     9    10    11    12    13    14    15</span><br><span class="line">   64:      0     1     2     3     4     5     6     7</span><br><span class="line">   72:      8     9    10    11    12    13    14    15</span><br><span class="line">   80:      0     1     2     3     4     5     6     7</span><br><span class="line">   88:      8     9    10    11    12    13    14    15</span><br><span class="line">   96:      0     1     2     3     4     5     6     7</span><br><span class="line">  104:      8     9    10    11    12    13    14    15</span><br><span class="line">  112:      0     1     2     3     4     5     6     7</span><br><span class="line">  120:      8     9    10    11    12    13    14    15</span><br><span class="line">RSS <span class="built_in">hash</span> key:</span><br><span class="line">fb:db:6a:ad:9d:49:5f:c7:d1:d9:d0:c8:bd:4c:e9:f3:60:c6:34:1e:09:c5:7f:f5:ae:bf:62:38:ca:83:a5:a2:40:c2:59:4b:32:92:6b:5b</span><br><span class="line">RSS <span class="built_in">hash</span> <span class="keyword">function</span>:</span><br><span class="line">    toeplitz: on</span><br><span class="line">    xor: off</span><br><span class="line">    crc32: off</span><br></pre></td></tr></table></figure>

<p>è®¾ç½®æˆå¤§16çš„å€¼ä¼šå¤±è´¥</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ethtool --set-rxfh-indir enp7s0f0 equal 56</span></span><br><span class="line">Cannot <span class="built_in">set</span> RX flow <span class="built_in">hash</span> configuration: Invalid argument</span><br></pre></td></tr></table></figure>

<p>ä½¿ç”¨RPSå°†16ä¸ªrxé˜Ÿåˆ—å†åˆ†é…åˆ°56ä¸ªæ ¸ä¸Šã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="built_in">echo</span> 010001,00010001 &gt; /sys/class/net/enp7s0f0/queues/rx-0/rps_cpus</span><br><span class="line"><span class="built_in">echo</span> 020002,00020002 &gt; /sys/class/net/enp7s0f0/queues/rx-1/rps_cpus</span><br><span class="line"><span class="built_in">echo</span> 040004,00040004 &gt; /sys/class/net/enp7s0f0/queues/rx-2/rps_cpus</span><br><span class="line"><span class="built_in">echo</span> 080008,00080008 &gt; /sys/class/net/enp7s0f0/queues/rx-3/rps_cpus</span><br><span class="line"><span class="built_in">echo</span> 100010,00100010 &gt; /sys/class/net/enp7s0f0/queues/rx-4/rps_cpus</span><br><span class="line"><span class="built_in">echo</span> 200020,00200020 &gt; /sys/class/net/enp7s0f0/queues/rx-5/rps_cpus</span><br><span class="line"><span class="built_in">echo</span> 400040,00400040 &gt; /sys/class/net/enp7s0f0/queues/rx-6/rps_cpus</span><br><span class="line"><span class="built_in">echo</span> 800080,00800080 &gt; /sys/class/net/enp7s0f0/queues/rx-7/rps_cpus</span><br><span class="line"><span class="built_in">echo</span> 000100,01000100 &gt; /sys/class/net/enp7s0f0/queues/rx-8/rps_cpus</span><br><span class="line"><span class="built_in">echo</span> 000200,02000200 &gt; /sys/class/net/enp7s0f0/queues/rx-9/rps_cpus</span><br><span class="line"><span class="built_in">echo</span> 000400,04000400 &gt; /sys/class/net/enp7s0f0/queues/rx-10/rps_cpus</span><br><span class="line"><span class="built_in">echo</span> 000800,08000800 &gt; /sys/class/net/enp7s0f0/queues/rx-11/rps_cpus</span><br><span class="line"><span class="built_in">echo</span> 001000,10001000 &gt; /sys/class/net/enp7s0f0/queues/rx-12/rps_cpus</span><br><span class="line"><span class="built_in">echo</span> 002000,20002000 &gt; /sys/class/net/enp7s0f0/queues/rx-13/rps_cpus</span><br><span class="line"><span class="built_in">echo</span> 004000,40004000 &gt; /sys/class/net/enp7s0f0/queues/rx-14/rps_cpus</span><br><span class="line"><span class="built_in">echo</span> 008000,80008000 &gt; /sys/class/net/enp7s0f0/queues/rx-15/rps_cpus</span><br></pre></td></tr></table></figure>



<p>ä¸‹å›¾å¾ˆå¥½çš„æè¿°äº†ä¸Šé¢å‘ç”Ÿçš„äº‹æƒ…ï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/catbro666/catbro666.github.io/posts/4198933e/RSS-RPS-REUSRPORT.jpg" alt="RSS-RPS-REUSRPORT" loading="lazy"></p>
<p>ç½‘å¡æ”¶åˆ°åŒ…é€åˆ°å¤šä¸ªé˜Ÿåˆ—ä¸­ï¼Œç„¶åå°†é˜Ÿåˆ—çš„ä¸­æ–­å·ä¸CPUæ ¸å¿ƒç»‘å®šï¼Œå¦‚æœæ²¡æœ‰å……åˆ†åˆ©ç”¨CPUï¼Œå€ŸåŠ©RPSå†æ¬¡åˆ†é…åˆ°å…¶ä»–CPUæ ¸å¿ƒä¸Šã€‚æ¯ä¸ªCPUæ ¸ä¸Šæœ‰ä¸€ä¸ªksoftirqdåœ¨å·¥ä½œã€‚SO_REUSEPORTè§£å†³socketç«äº‰çš„é—®é¢˜ï¼Œæ¯ä¸ªè¿›ç¨‹æœ‰ä¸€ä¸ªç‹¬ç«‹çš„socketï¼Œé»˜è®¤æƒ…å†µä¸‹æ˜¯å¯¹æ•°æ®æµï¼ˆæºå’Œç›®çš„çš„ipç«¯å£å·ï¼‰åšå“ˆå¸Œå€¼æ¥é€‰æ‹©é€åˆ°é‚£ä¸ªsocketã€‚ä½†æ˜¯è¿™ä¸ªåœ°æ–¹å…¶å®è¿˜æ˜¯å­˜åœ¨ä¸€ç‚¹ç«äº‰ï¼ŒåŒä¸€ä¸ªsocketå¯èƒ½è¢«ä¸åŒçš„æ ¸é€‰æ‹©ï¼ŒLinuxå†…æ ¸ä»4.5ç‰ˆæœ¬èµ·å·²ç»æ”¯æŒSO_ATTACH_REUSEPORT_CBPF&#x2F;EBPFï¼Œå¯ä»¥æ ¹æ®æ ¸å¿ƒå·æ¥é€‰æ‹©socketä»¥æ¶ˆé™¤softirqè¿™é‡Œçš„ç«äº‰ï¼Œé…åˆä¸Šè¿›ç¨‹çš„CPUäº²å’Œæ€§ç»‘å®šå¯ä»¥æœ€å¤§ç¨‹åº¦çš„æå‡æ€§èƒ½ã€‚ä¸è¿‡Nginxç›®å‰è¿˜ä¸æ”¯æŒè¿™ä¸ªé€‰é¡¹ã€‚</p>
<h3 id="Linuxå†…æ ¸ç½‘ç»œæ ˆå‚æ•°"><a href="#Linuxå†…æ ¸ç½‘ç»œæ ˆå‚æ•°" class="headerlink" title="Linuxå†…æ ¸ç½‘ç»œæ ˆå‚æ•°"></a>Linuxå†…æ ¸ç½‘ç»œæ ˆå‚æ•°</h3><p>è¿™éƒ¨åˆ†ç”±äºå†…å®¹å¤ªå¤šï¼Œæˆ‘ä¸å‡†å¤‡å†å±•å¼€ï¼Œåªæ˜¯è´´ä¸€ä¸ªå‚è€ƒé…ç½®ã€‚å»ºè®®å¤§å®¶åœ¨ç†è§£å‚æ•°å«ä¹‰çš„åŸºç¡€ä¸Šè°¨æ…å‚è€ƒï¼Œä¸è¦æ— è„‘ç…§æ¬ï¼Œå¦åˆ™å¾ˆå¯èƒ½å¸¦æ¥åæ•ˆæœã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">ufw <span class="built_in">disable</span>                                                                     <span class="comment">#disable Debian firewall</span></span><br><span class="line">iptables -F                                                                     <span class="comment">#flush the iptables rules</span></span><br><span class="line"><span class="comment">#TCP Memory</span></span><br><span class="line"><span class="built_in">echo</span> 16777216                &gt; /proc/sys/net/core/rmem_max</span><br><span class="line"><span class="built_in">echo</span> 16777216                &gt; /proc/sys/net/core/wmem_max</span><br><span class="line"><span class="built_in">echo</span> 16777216                &gt; /proc/sys/net/core/rmem_default</span><br><span class="line"><span class="built_in">echo</span> 16777216                &gt; /proc/sys/net/core/wmem_default</span><br><span class="line"><span class="built_in">echo</span> 16777216 16777216 16777216  &gt; /proc/sys/net/ipv4/tcp_rmem</span><br><span class="line"><span class="built_in">echo</span> 538750 538750 538750  &gt; /proc/sys/net/ipv4/tcp_wmem</span><br><span class="line"><span class="built_in">echo</span> 16777216            &gt; /proc/sys/net/core/optmem_max</span><br><span class="line"><span class="built_in">echo</span> 16777216 16777216  16777216 &gt; /proc/sys/net/ipv4/tcp_mem</span><br><span class="line"><span class="built_in">echo</span> 65536       &gt; /proc/sys/vm/min_free_kbytes                                  <span class="comment">#ensure there will always be free</span></span><br><span class="line"><span class="comment">#TCP Behavior</span></span><br><span class="line"><span class="built_in">echo</span> 0                     &gt; /proc/sys/net/ipv4/tcp_timestamps</span><br><span class="line"><span class="built_in">echo</span> 0                     &gt; /proc/sys/net/ipv4/tcp_sack</span><br><span class="line"><span class="built_in">echo</span> 0                     &gt; /proc/sys/net/ipv4/tcp_fack</span><br><span class="line"><span class="built_in">echo</span> 0                     &gt; /proc/sys/net/ipv4/tcp_dsack</span><br><span class="line"><span class="built_in">echo</span> 0                     &gt; /proc/sys/net/ipv4/tcp_moderate_rcvbuf</span><br><span class="line"><span class="built_in">echo</span> 1                     &gt; /proc/sys/net/ipv4/tcp_rfc1337</span><br><span class="line"><span class="built_in">echo</span> 600        &gt; /proc/sys/net/core/netdev_budget</span><br><span class="line"><span class="built_in">echo</span> 128                   &gt; /proc/sys/net/core/dev_weight</span><br><span class="line"><span class="built_in">echo</span> 1                     &gt; /proc/sys/net/ipv4/tcp_syncookies</span><br><span class="line"><span class="built_in">echo</span> 0                     &gt; /proc/sys/net/ipv4/tcp_slow_start_after_idle</span><br><span class="line"><span class="built_in">echo</span> 1                     &gt; /proc/sys/net/ipv4/tcp_no_metrics_save</span><br><span class="line"><span class="built_in">echo</span> 1                     &gt; /proc/sys/net/ipv4/tcp_orphan_retries</span><br><span class="line"><span class="built_in">echo</span> 0                     &gt; /proc/sys/net/ipv4/tcp_fin_timeout</span><br><span class="line"><span class="built_in">echo</span> 0                     &gt; /proc/sys/net/ipv4/tcp_tw_reuse</span><br><span class="line"><span class="built_in">echo</span> 0                     &gt; /proc/sys/net/ipv4/tcp_tw_recycle</span><br><span class="line"><span class="built_in">echo</span> 1                     &gt; /proc/sys/net/ipv4/tcp_syncookies</span><br><span class="line"><span class="built_in">echo</span> 2                       &gt; /proc/sys/net/ipv4/tcp_synack_retries</span><br><span class="line"><span class="built_in">echo</span> 2                     &gt; /proc/sys/net/ipv4/tcp_syn_retries</span><br><span class="line"><span class="built_in">echo</span> cubic                   &gt; /proc/sys/net/ipv4/tcp_congestion_control</span><br><span class="line"><span class="built_in">echo</span> 0                     &gt; /proc/sys/net/ipv4/tcp_low_latency</span><br><span class="line"><span class="built_in">echo</span> 1                     &gt; /proc/sys/net/ipv4/tcp_window_scaling</span><br><span class="line"><span class="built_in">echo</span> 1                     &gt; /proc/sys/net/ipv4/tcp_adv_win_scale</span><br><span class="line"><span class="comment">#TCP Queueing</span></span><br><span class="line"><span class="built_in">echo</span> 0                &gt; /proc/sys/net/ipv4/tcp_max_tw_buckets</span><br><span class="line"><span class="built_in">echo</span> 1025 65535            &gt; /proc/sys/net/ipv4/ip_local_port_range</span><br><span class="line"><span class="built_in">echo</span> 131072                &gt; /proc/sys/net/core/somaxconn</span><br><span class="line"><span class="built_in">echo</span> 262144            &gt; /proc/sys/net/ipv4/tcp_max_orphans</span><br><span class="line"><span class="built_in">echo</span> 262144           &gt; /proc/sys/net/core/netdev_max_backlog</span><br><span class="line"><span class="built_in">echo</span> 262144        &gt; /proc/sys/net/ipv4/tcp_max_syn_backlog</span><br><span class="line"><span class="built_in">echo</span> 4000000             &gt; /proc/sys/fs/nr_open</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> 4194304     &gt; /proc/sys/net/ipv4/ipfrag_high_thresh</span><br><span class="line"><span class="built_in">echo</span> 3145728     &gt; /proc/sys/net/ipv4/ipfrag_low_thresh</span><br><span class="line"><span class="built_in">echo</span> 30      &gt; /proc/sys/net/ipv4/ipfrag_time</span><br><span class="line"><span class="built_in">echo</span> 0   &gt; /proc/sys/net/ipv4/tcp_abort_on_overflow</span><br><span class="line"><span class="built_in">echo</span> 1       &gt; /proc/sys/net/ipv4/tcp_autocorking</span><br><span class="line"><span class="built_in">echo</span> 31      &gt; /proc/sys/net/ipv4/tcp_app_win</span><br><span class="line"><span class="built_in">echo</span> 1       &gt; /proc/sys/net/ipv4/tcp_mtu_probing</span><br><span class="line"><span class="built_in">set</span> selinux=disabled</span><br><span class="line"><span class="built_in">ulimit</span> -n 1000000</span><br></pre></td></tr></table></figure>

<p>æœ€åå†é‡ç”³ä¸€ä¸‹ï¼Œé…ç½®å¹¶ä¸æ˜¯ä¸€æˆä¸å˜çš„ï¼Œéœ€è¦åœ¨ç†è§£é…ç½®å«ä¹‰çš„åŸºç¡€ä¸Šï¼Œç»“åˆè‡ªèº«çš„æµ‹è¯•éœ€æ±‚åˆç†è¿›è¡Œé…ç½®ã€‚</p>
]]></content>
      <categories>
        <category>ç¼–ç¨‹å¼€å‘</category>
        <category>Nginx/OpenResty</category>
        <category>æ€§èƒ½</category>
      </categories>
      <tags>
        <tag>Nginx</tag>
        <tag>æ€§èƒ½è°ƒä¼˜</tag>
      </tags>
  </entry>
  <entry>
    <title>Openresty Luaåç¨‹è°ƒåº¦æœºåˆ¶</title>
    <url>/posts/150430f0/</url>
    <content><![CDATA[<div class="note primary">
            <h1 id="å†™åœ¨å‰é¢"><a href="#å†™åœ¨å‰é¢" class="headerlink" title="å†™åœ¨å‰é¢"></a>å†™åœ¨å‰é¢</h1><p>OpenRestyï¼ˆåé¢ç®€ç§°ï¼šORï¼‰æ˜¯ä¸€ä¸ªåŸºäºNginxå’ŒLuaçš„é«˜æ€§èƒ½Webå¹³å°ï¼Œå®ƒå†…éƒ¨é›†æˆå¤§é‡çš„Lua APIä»¥åŠç¬¬ä¸‰æ–¹æ¨¡å—ï¼Œå¯ä»¥åˆ©ç”¨å®ƒå¿«é€Ÿæ­å»ºæ”¯æŒé«˜å¹¶å‘ã€æå…·åŠ¨æ€æ€§å’Œæ‰©å±•æ€§çš„Webåº”ç”¨ã€WebæœåŠ¡æˆ–åŠ¨æ€ç½‘å…³ã€‚</p><p>ORæœ€å¤§çš„ç‰¹ç‚¹å°±æ˜¯ï¼Œå°†Luaåç¨‹ä¸Nginxäº‹ä»¶é©±åŠ¨æ¨¡å‹åŠéé˜»å¡I&#x2F;Oç»“åˆèµ·æ¥ã€‚ä½¿ç”¨æˆ·å¯ä»¥åœ¨handlerä¸­ä½¿ç”¨ <strong>åŒæ­¥ä½†æ˜¯ä¾ç„¶æ˜¯éé˜»å¡</strong> çš„æ–¹å¼ç¼–å†™å…¶åº”ç”¨ä»£ç ï¼Œè€Œæ— éœ€å…³å¿ƒåº•å±‚çš„åç¨‹è°ƒåº¦ä»¥åŠä¸Nginxäº‹ä»¶é©±åŠ¨æ¨¡å‹çš„äº¤äº’ã€‚</p><p>æœ¬æ–‡å°†å…ˆä»æ€»ä½“ä¸Šä»‹ç»ORçš„åç¨‹è°ƒåº¦æœºåˆ¶ï¼Œç„¶åç»“åˆæºç ä»¥åŠLuaæ ˆçš„æƒ…å†µæ¥è¯¦ç»†äº†è§£å„ä¸ªéƒ¨åˆ†æ˜¯å¦‚ä½•å®ç°çš„ï¼ŒåŒ…æ‹¬å…¶å¼‚å¸¸ä¿æŠ¤ã€åç¨‹åˆå§‹åŒ–ã€åç¨‹çš„æ¢å¤å’Œæ‰§è¡Œã€åç¨‹çš„æŒ‚èµ·ã€åç¨‹çš„æ‰§è¡Œç»“æŸã€åç¨‹å‡ºé”™çš„æƒ…å†µã€‚</p><p>æœ¬æ–‡ä¸»è¦å…³æ³¨è°ƒåº¦å‡½æ•°å†…éƒ¨çš„é€»è¾‘ï¼Œå¦‚æœæƒ³äº†è§£å¤–éƒ¨çš„è°ƒç”¨æµç¨‹ã€‚å¯ä»¥å‚çœ‹<a href="../30b81f82/">Openresty Luaé’©å­è°ƒç”¨å®Œæ•´æµç¨‹</a></p>
          </div>

<span id="more"></span>

<div class="note default">
            <p>æ³¨ï¼š<code>lua-nginx</code>æ¨¡å—ä¸<code>stream-lua-nginx</code>æ¨¡å—çš„ä¸»ä½“éƒ¨åˆ†ç±»ä¼¼ï¼Œåè€…å®ç°ç›¸å¯¹ç®€å•ä¸€ç‚¹ã€‚ä¸‹é¢çš„è®¨è®ºå°†åŸºäº<code>stream-lua</code>æ¨¡å—ã€‚</p><p>ä¸ºäº†é˜²æ­¢æ­§ä¹‰ï¼Œæ–‡ä¸­ç”¨åˆ°çš„ä¸€äº›æœ¯è¯­æ˜ç¡®ä¸€ä¸‹ï¼š</p><ul><li><code>ä¸»çº¿ç¨‹</code>ï¼šè¡¨ç¤ºå¤–å±‚è°ƒç”¨<code>run_thread()</code>çš„OSçº¿ç¨‹</li><li><code>å…¥å£çº¿ç¨‹</code>ï¼šæ¯ä¸ªhandlerè¢«è°ƒç”¨æ—¶ä¼šåˆ›å»ºä¸€ä¸ªå…¥å£çº¿ç¨‹ï¼Œç”¨äºæ‰§è¡Œluaä»£ç </li><li><code>ç”¨æˆ·çº¿ç¨‹</code>ï¼šç”¨æˆ·åœ¨Luaä»£ç ä¸­é€šè¿‡<code>ngx.thread.spawn()</code>åˆ›å»ºçš„çº¿ç¨‹</li><li><code>ç”¨æˆ·åç¨‹</code>ï¼šç”¨æˆ·åœ¨Luaä»£ç ä¸­é€šè¿‡<code>coroutine.create()</code>åˆ›å»ºçš„åç¨‹</li><li><code>åç¨‹</code>ï¼šæ³›æŒ‡æ‰€æœ‰åç¨‹ï¼ŒåŒ…æ‹¬å…¥å£çº¿ç¨‹ã€ç”¨æˆ·çº¿ç¨‹å’Œç”¨æˆ·åç¨‹</li><li><code>vm</code>ï¼šè¡¨ç¤ºLuaè™šæ‹Ÿæœº</li><li><code>L</code>ï¼šè§†å‡ºç°çš„ä¸Šä¸‹æ–‡ï¼Œä¸€èˆ¬è¡¨ç¤ºçˆ¶åç¨‹ï¼Œåœ¨åˆ›å»ºå…¥å£çº¿ç¨‹çš„æ—¶å€™è¡¨ç¤ºLua VM</li><li><code>co</code>ï¼šä¸€èˆ¬è¡¨ç¤ºæ–°åˆ›å»ºçš„åç¨‹</li><li><code>Læ ˆï¼š |åç¨‹è¡¨|æ–°åç¨‹|é¡¶|</code>ï¼šè¡¨ç¤ºLuaæ ˆç»“æ„ï¼Œæœ€å³è¾¹æ˜¯æ ˆé¡¶</li></ul>
          </div>

<h1 id="å…³é”®æ•°æ®ç»“æ„"><a href="#å…³é”®æ•°æ®ç»“æ„" class="headerlink" title="å…³é”®æ•°æ®ç»“æ„"></a>å…³é”®æ•°æ®ç»“æ„</h1><p>åœ¨æ·±å…¥äº†è§£åç¨‹è°ƒåº¦æœºåˆ¶ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥è®¤è¯†ä¸€ä¸‹ä¸»è¦çš„æ•°æ®ç»“æ„ï¼š</p>
<ul>
<li>åç¨‹ä¸Šä¸‹æ–‡ï¼š<code>ngx_stream_lua_co_ctx_t</code><ul>
<li>åç¨‹å†…éƒ¨æ ˆï¼ˆ<code>coctx-&gt;co</code>ï¼‰</li>
<li>åç¨‹çŠ¶æ€ï¼ˆ<code>coctx-&gt;co_status</code>ï¼‰</li>
<li>ç»´æŠ¤åç¨‹ä¹‹é—´å…³ç³»çš„æ•°æ®ï¼ˆçˆ¶åç¨‹<code>coctx-&gt;parent_co_ctx</code>ã€åƒµå°¸å­çº¿ç¨‹<code>coctx-&gt;zombie_child_threads</code>ï¼‰</li>
<li>ç”¨æˆ·ç›¸å…³æ•°æ®ï¼ˆ<code>coctx-&gt;data</code>ï¼‰</li>
<li>åœ¨Luaçš„registryè¡¨ä¸­å¯¹åº”è¯¥çº¿ç¨‹æŒ‡é’ˆçš„å¼•ç”¨å€¼ï¼ˆ<code>co_ref</code>ï¼‰</li>
<li>ä¸€äº›çŠ¶æ€æ ‡è®°ï¼ˆæ˜¯å¦æ˜¯ç”¨æˆ·çº¿ç¨‹<code>is_uthread</code>ã€æ˜¯å¦å› åˆ›å»ºæ–°çº¿ç¨‹<code>thread_spawn_yielded</code>è¢«yield)</li>
</ul>
</li>
<li>æ¨¡å—ä¸Šä¸‹æ–‡ï¼š<code>ngx_stream_lua_ctx_t</code><ul>
<li><code>ctx-&gt;cur_co_ctx</code>ï¼ˆå½“å‰è°ƒåº¦åç¨‹ä¸Šä¸‹æ–‡ï¼‰</li>
<li><code>ctx-&gt;co_op</code>ï¼ˆåç¨‹æ˜¯ä»¥ä½•ç§æ–¹å¼YIELDï¼‰</li>
</ul>
</li>
<li>æ ¸å¿ƒè°ƒåº¦å‡½æ•°ï¼š<code>ngx_stream_lua_run_thread()</code></li>
</ul>
<h1 id="åç¨‹è°ƒåº¦"><a href="#åç¨‹è°ƒåº¦" class="headerlink" title="åç¨‹è°ƒåº¦"></a>åç¨‹è°ƒåº¦</h1><p>é¦–å…ˆä½ å¯èƒ½å¾ˆå¥½å¥‡ORä¸ºä»€ä¹ˆè¦åœ¨Cå¼•æ“å±‚é¢è‡ªå·±å®ç°åç¨‹çš„è°ƒåº¦ï¼Ÿæˆ–è€…è¯´è¿™ä¹ˆåšçš„å¥½å¤„æ˜¯ä»€ä¹ˆï¼Ÿæˆ‘è§‰å¾—æœ€ä¸»è¦çš„åŸå› è¿˜æ˜¯å‡è½»å¼€å‘è€…çš„è´Ÿæ‹…ã€‚</p>
<h2 id="åŸç”ŸLua-coroutineæ¥å£"><a href="#åŸç”ŸLua-coroutineæ¥å£" class="headerlink" title="åŸç”ŸLua coroutineæ¥å£"></a>åŸç”ŸLua coroutineæ¥å£</h2><p>æˆ‘ä»¬çŸ¥é“Luaæ˜¯ä¸ªéå¸¸è½»å·§çš„è¯­è¨€ï¼Œå®ƒä¸åƒGoæœ‰è‡ªå·±çš„è°ƒåº¦å™¨ã€‚LuaåŸç”Ÿçš„å¯¹åç¨‹çš„æ“ä½œæ— éå°±æ˜¯<code>coroutine.resume()</code>å’Œ<code>coroutine.yield()</code>ã€‚è¿™ä¸¤è€…æ˜¯æˆå¯¹å‡ºç°çš„ï¼Œåç¨‹<code>coroutine.yield()</code>ä¹‹åè‚¯å®šå›åˆ°çˆ¶åç¨‹<code>coroutine.resume()</code>çš„åœ°æ–¹ï¼Œæ¢å¤å­åç¨‹éœ€è¦æ˜¾å¼å†æ¬¡<code>coroutine.resume()</code>ã€‚å¦‚æœè¦åœ¨Luaä»£ç å±‚é¢å®ç°éé˜»å¡I&#x2F;Oï¼Œé‚£ä¹ˆçˆ¶åç¨‹å¿…é¡»å¤„ç†å­åç¨‹I&#x2F;Oç­‰å¾…çš„æƒ…å†µï¼Œå¹¶åœ¨äº‹ä»¶å‘ç”Ÿæ—¶æ¢å¤å­åç¨‹çš„æ‰§è¡Œã€‚å¦‚æœéœ€è¦åŒæ—¶è¿›è¡Œå¤šä¸ªä»»åŠ¡ï¼Œé‚£ä¹ˆçˆ¶åç¨‹å°±éœ€è¦è´Ÿè´£å¤šä¸ªåç¨‹é—´çš„è°ƒåº¦ã€‚å› ä¸ºåç¨‹çš„æ‹“æ‰‘å¯èƒ½æ˜¯ä¸€ä¸ªå¤æ‚çš„æ ‘çŠ¶ç»“æ„ï¼Œæ‰€ä»¥åç¨‹çš„è°ƒåº¦ç®¡ç†å°†å˜å¾—å¼‚å¸¸å¤æ‚ã€‚</p>
<h2 id="OpenRestyå®ç°"><a href="#OpenRestyå®ç°" class="headerlink" title="OpenRestyå®ç°"></a>OpenRestyå®ç°</h2><p>ORåœ¨Cå¼•æ“å±‚å¸®æˆ‘ä»¬æŠŠè¿™äº›äº‹æƒ…éƒ½åšäº†ï¼Œä½ æ— é¡»å†å…³å¿ƒæ‰€æœ‰è¿™äº›ï¼Œåªéœ€ä¸“å¿ƒå†™ä½ çš„ä¸šåŠ¡é€»è¾‘ã€‚ä¸ºäº†æ”¯æŒåŒæ­¥éé˜»å¡çš„æ–¹å¼ç¼–å†™åº”ç”¨ä»£ç ï¼ŒORé‡å†™äº†<code>coroutine</code>çš„æ¥å£å‡½æ•°ï¼Œä»è€Œæ¥ç®¡äº†åç¨‹çš„è°ƒåº¦ï¼Œå¹¶åœ¨<code>coroutine</code>åŸºç¡€ä¸Šå°è£…æŠ½è±¡å‡ºäº†<code>thread</code>çš„æ¦‚å¿µã€‚æ— è®ºæ˜¯<code>coroutine</code>è¿˜æ˜¯<code>thread</code>ï¼ŒI&#x2F;Oç­‰å¾…å¯¹äºç”¨æˆ·éƒ½æ˜¯é€æ˜çš„ï¼Œç”¨æˆ·æ— éœ€å…³å¿ƒã€‚ä¸¤è€…çš„ä¸»è¦åŒºåˆ«æ˜¯ï¼Œ<code>coroutine</code>çˆ¶å­ä¹‹é—´çš„åä½œåº¦æ›´é«˜ï¼Œ<code>coroutine.yield()</code>å’Œ<code>coroutine.resume()</code>æˆå¯¹å‡ºç°ã€‚åœ¨å­åç¨‹æ‰§è¡Œå®Œæˆï¼ˆå‡ºé”™ï¼‰æˆ–è€…æ˜¾å¼<code>coroutine.yield()</code>ä¹‹å‰ï¼Œçˆ¶åç¨‹ä¸€ç›´å¤„äºç­‰å¾…çŠ¶æ€ã€‚è€Œ<code>thread</code>åˆ™ç”±è°ƒåº¦å™¨è¿›è¡Œè°ƒåº¦ï¼Œå­<code>thread</code>ä¸€æ—¦å¼€å§‹æ‰§è¡Œå°±ä¸å†å—çˆ¶åç¨‹æ§åˆ¶äº†ï¼Œåœ¨éœ€è¦å¹¶å‘è¯·æ±‚æ—¶å¾ˆæœ‰ç”¨ã€‚<code>thread</code>æä¾›äº†<code>spawn()</code>ã€<code>wait()</code>ç­‰æ¥å£ï¼Œ<code>spawn()</code>æ‰§è¡Œå‚æ•°ä¸­æŒ‡å®šçš„å‡½æ•°ï¼Œç›´åˆ°æ‰§è¡Œå®Œæ¯•ã€å‡ºé”™æˆ–è€…I&#x2F;Oç­‰å¾…æ—¶è¿”å›ã€‚<code>wait()</code>åˆ™ä½¿çˆ¶åç¨‹å¯ä»¥åŒæ­¥ç­‰å¾…å­çº¿ç¨‹æ‰§è¡Œå®Œæ¯•ã€è·å–ç»“æœã€‚</p>
<div class="note primary">
            <p>ORåœ¨å¯¹åç¨‹è°ƒåº¦ä¸Šï¼Œæœ€æ ¸å¿ƒçš„æ”¹åŠ¨æ˜¯å…¶åˆ›å»ºæ–°åç¨‹æ—¶çš„è¡Œä¸ºï¼ˆ<code>coroutine.resume()</code>, <code>ngx.thread.spawn()</code>ï¼‰ã€‚å®ƒä¸ä¼šç›´æ¥è°ƒç”¨<code>lua_resume()</code>ï¼Œè€Œæ˜¯å…ˆ<code>lua_yield()</code>å›åˆ°ä¸»çº¿ç¨‹ï¼Œç„¶åç”±ä¸»çº¿ç¨‹å†æ ¹æ®æƒ…å†µ<code>lua_resume()</code>ä¸‹ä¸€ä¸ªåç¨‹ã€‚Luaä»£ç åŸŸå†…ä»æ¥ä¸ä¼šç›´æ¥è°ƒç”¨<code>lua_resume()</code>ï¼Œç†è§£äº†è¿™ä¸€ç‚¹ä½ å°±ç†è§£äº†OpenRestyåç¨‹è°ƒåº¦çš„ç²¾é«“ã€‚</p>
          </div>

<p>æ‰€ä»¥ORä¸­åç¨‹æ‹“æ‰‘æ˜¯ä¸€ä¸ªå•å±‚çš„ç»“æ„ï¼Œå®ƒåªæœ‰<strong>ä¸€ä¸ªå…¥å£ç‚¹</strong>ã€‚è¿™æ ·ä½¿å¾—åç¨‹è°ƒåº¦æ›´åŠ çµæ´»ï¼ŒI&#x2F;Oäº‹ä»¶çš„è§¦å‘æ—¶å›è°ƒå‡½æ•°ä¹Ÿæ›´å®¹æ˜“å®ç°ã€‚</p>
<p>ORè°ƒåº¦å™¨æ ¹æ®<code>lua_resume()</code>çš„è¿”å›å€¼ï¼Œç¡®å®šåç¨‹æ˜¯æŒ‚èµ·äº†ã€ç»“æŸäº†è¿˜æ˜¯å‡ºé”™äº†ã€‚å› ä¸ºORæ”¹åŠ¨äº†åˆ›å»ºæ–°åç¨‹æ—¶è¡Œä¸ºï¼ŒåŒæ—¶åˆæŠ½è±¡äº†threadæ¦‚å¿µï¼Œæ‰€ä»¥å¦‚æœæ˜¯åç¨‹æŒ‚èµ·çš„æƒ…å†µï¼Œè¿˜éœ€è¦çŸ¥é“æ˜¯ä»€ä¹ˆåŸå› æŒ‚èµ·ï¼Œä»¥ä¾¿åšç›¸åº”çš„ä¸åŒå¤„ç†ã€‚æ˜¯ç»§ç»­è°ƒåº¦ï¼Ÿè¿˜æ˜¯è¿”å›ä¸Šå±‚ï¼Ÿæˆ‘ä»¬å‰é¢æåˆ°çš„<code>ctx-&gt;co_op</code>ä¾¿æ˜¯åšè¿™ä¸ªç”¨é€”ã€‚</p>
<h2 id="åç¨‹è°ƒåº¦é€»è¾‘"><a href="#åç¨‹è°ƒåº¦é€»è¾‘" class="headerlink" title="åç¨‹è°ƒåº¦é€»è¾‘"></a>åç¨‹è°ƒåº¦é€»è¾‘</h2><p>åç¨‹çš„è°ƒåº¦åœ¨æ ¸å¿ƒè°ƒåº¦å‡½æ•°<code>ngx_stream_lua_run_thread()</code>ä¸­è¿›è¡Œï¼Œå®ƒæ˜¯åˆ›å»ºæˆ–æ¢å¤åç¨‹çš„å”¯ä¸€å…¥å£ç‚¹ã€‚æœ€åˆæ˜¯ç”±é…ç½®çš„Luaé’©å­è°ƒç”¨ï¼ˆå›¾ä¸­<code>ssl_cert_handler()</code>ï¼‰ï¼Œå¦‚æœç¢°åˆ°äº†I&#x2F;Oç­‰å¾…çš„æƒ…å†µï¼Œåç»­åˆ™ç”±å¯¹åº”çš„äº‹ä»¶handlerï¼ˆå›¾ä¸­çš„<code>sleep_handler()</code>å’Œ<code>read_handler()</code>ï¼‰å†æ¬¡æ‹‰èµ·ã€‚<code>run_thread()</code>é‡Œé¢å®ç°äº†ä¸€ä¸ªè°ƒåº¦å¾ªç¯ï¼Œå¾ªç¯é‡Œé¢å…ˆä»<code>ctx-&gt;cur_co_ctx</code>è·å–ä¸‹ä¸€ä¸ªå¾…resumeçš„åç¨‹ä¸Šä¸‹æ–‡ï¼Œç„¶å<code>lua_resume()</code>æ‰§è¡Œæˆ–æ¢å¤è¯¥åç¨‹ï¼Œå…¶è¿”å›å€¼<code>LUA_YIELD</code>è¡¨ç¤ºåç¨‹æŒ‚èµ·ï¼Œ<code>0</code>è¡¨ç¤ºåç¨‹æ‰§è¡Œç»“æŸï¼Œå…¶ä½™çš„è¡¨ç¤ºåç¨‹å‡ºé”™äº†ã€‚å…¶ä¸­åç¨‹æŒ‚èµ·åˆåˆ†ä¸ºå››ç§ä¸åŒçš„æƒ…å†µï¼šå³ç­‰å¾…I&#x2F;Oã€æ–°å»ºthreadã€<code>coroutine.resume()</code>å’Œ<code>coroutine.yield()</code>ã€‚æ ¹æ®ä¸åŒçš„æƒ…å†µï¼Œå†³å®šæ˜¯è·³åˆ°å¾ªç¯å‰é¢ç»§ç»­æ¢å¤ä¸‹ä¸€ä¸ªåç¨‹ï¼Œè¿˜æ˜¯è¿”å›ä¸Šå±‚å‡½æ•°ã€‚</p>
<p>ä¸‹å›¾æ˜¯åç¨‹è°ƒåº¦ä¸»è¦é€»è¾‘çš„ç¤ºæ„å›¾ï¼Œå¯ä»¥çœ‹åˆ°åœ¨Luaä»£ç åŸŸä¸­æ— è®ºæ˜¯æ–°å»ºã€æŒ‚èµ·æˆ–æ¢å¤åç¨‹ï¼Œéƒ½æ˜¯å…ˆè°ƒç”¨<code>lua_yield()</code>å›åˆ°ä¸»çº¿ç¨‹ã€‚I&#x2F;Oæ“ä½œä¾‹å¦‚<code>ngx.tcp.receive()</code>å¦‚æœç¢°åˆ°äº†I&#x2F;Oç­‰å¾…ï¼Œä¼šåœ¨å†…éƒ¨æ³¨å†Œepolläº‹ä»¶ï¼ˆå¯¹äºsleepçš„æƒ…å†µæ˜¯å®šæ—¶å™¨ï¼‰ï¼Œç„¶åè‡ªåŠ¨<code>lua_yield()</code>ï¼Œå½“äº‹ä»¶è§¦å‘æ—¶ç»§ç»­æœªå®Œæˆçš„I&#x2F;Oæ“ä½œï¼Œå®Œæˆä¹‹åå†è°ƒç”¨<code>run_thread()</code>æ¢å¤ä¹‹å‰è¢«æŒ‚èµ·çš„åç¨‹ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/catbro666/catbro666.github.io/posts/150430f0/openresty-lua-coroutine-schedule.svg" loading="lazy"></p>
<h1 id="å¼‚å¸¸ä¿æŠ¤"><a href="#å¼‚å¸¸ä¿æŠ¤" class="headerlink" title="å¼‚å¸¸ä¿æŠ¤"></a>å¼‚å¸¸ä¿æŠ¤</h1><p>ä½œä¸ºä¸€ä¸ªè°ƒåº¦å™¨ï¼ŒOpenRestyæ‰®æ¼”è€…ç±»ä¼¼æ“ä½œç³»ç»Ÿå†…æ ¸çš„è§’è‰²ï¼Œä¸è¿‡å®ƒçš„è°ƒåº¦å¯¹è±¡æ˜¯Luaåç¨‹ã€‚ä½œä¸ºä¸€ä¸ªâ€œå†…æ ¸â€ï¼Œæ— è®ºå…¶è°ƒåº¦å¯¹è±¡å‡ºäº†ä»€ä¹ˆé—®é¢˜ï¼Œéƒ½ä¸åº”è¯¥ä½¿è¿™ä¸ªç³»ç»Ÿå´©æºƒï¼Œè€Œæ˜¯åº”è¯¥å°†é”™è¯¯ä¿¡æ¯æ‰“å°å‡ºæ¥ã€‚</p>
<p>Openrestyå†…éƒ¨å°±åšäº†ä¸€ä¸ªè¿™æ ·çš„å¼‚å¸¸ä¿æŠ¤ï¼Œå…¶åŸç†å°±æ˜¯ç”¨<code>setjmp</code>ã€<code>longjmp</code>åŒ…ä½äº†<code>run_thread()</code>é‡Œé¢çš„æ•´ä¸ªåç¨‹è°ƒåº¦é€»è¾‘ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* é¦–å…ˆæ³¨å†Œè™šæ‹Ÿæœºçš„panicå›è°ƒ */</span></span><br><span class="line">lua_atpanic(L, ngx_stream_lua_atpanic);</span><br><span class="line"><span class="comment">/* setjmpä¿å­˜ç¯å¢ƒ */</span></span><br><span class="line">NGX_LUA_EXCEPTION_TRY &#123;</span><br><span class="line">    <span class="comment">/* æ‰§è¡Œè°ƒåº¦é€»è¾‘ */</span></span><br><span class="line">&#125; NGX_LUA_EXCEPTION_CATCH &#123;</span><br><span class="line">    <span class="comment">/* å‡ºç°å¼‚å¸¸æ—¶èµ°åˆ°è¿™é‡Œ */</span></span><br><span class="line">    dd(<span class="string">&quot;nginx execution restored&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>ngx_stream_lua_atpanic()</code>çš„å®ç°ä¹Ÿéå¸¸ç®€å•ï¼Œåªæ˜¯ç®€å•åœ°æ‰“å°å´©æºƒæ—¥å¿—ï¼Œç„¶åè°ƒç”¨<code>NGX_LUA_EXCEPTION_THROW(1);</code>æ¢å¤nginxçš„æ‰§è¡Œã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span></span></span><br><span class="line"><span class="function"><span class="title">ngx_stream_lua_atpanic</span><span class="params">(lua_State *L)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> NGX_LUA_ABORT_AT_PANIC</span></span><br><span class="line">    <span class="built_in">abort</span>();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">    u_char                  *s = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">size_t</span>                   len = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (lua_type(L, <span class="number">-1</span>) == LUA_TSTRING) &#123;</span><br><span class="line">        s = (u_char *) lua_tolstring(L, <span class="number">-1</span>, &amp;len);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (s == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        s = (u_char *) <span class="string">&quot;unknown reason&quot;</span>;</span><br><span class="line">        len = <span class="keyword">sizeof</span>(<span class="string">&quot;unknown reason&quot;</span>) - <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ngx_log_stderr(<span class="number">0</span>, <span class="string">&quot;lua atpanic: Lua VM crashed, reason: %*s&quot;</span>, len, s);</span><br><span class="line">    ngx_quit = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*  restore nginx execution */</span></span><br><span class="line">    NGX_LUA_EXCEPTION_THROW(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* impossible to reach here */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™å‡ ä¸ªå®å®šä¹‰åˆ†åˆ«å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NGX_LUA_EXCEPTION_TRY                                                \</span></span><br><span class="line"><span class="meta">    <span class="meta-keyword">if</span> (setjmp(ngx_stream_lua_exception) == 0)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NGX_LUA_EXCEPTION_CATCH                                              \</span></span><br><span class="line"><span class="meta">    <span class="meta-keyword">else</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NGX_LUA_EXCEPTION_THROW(x)                                           \</span></span><br><span class="line"><span class="meta">    longjmp(ngx_stream_lua_exception, (x))</span></span><br></pre></td></tr></table></figure>



<h1 id="åç¨‹åˆå§‹åŒ–"><a href="#åç¨‹åˆå§‹åŒ–" class="headerlink" title="åç¨‹åˆå§‹åŒ–"></a>åç¨‹åˆå§‹åŒ–</h1><h2 id="é’©å­çš„å…¥å£çº¿ç¨‹"><a href="#é’©å­çš„å…¥å£çº¿ç¨‹" class="headerlink" title="é’©å­çš„å…¥å£çº¿ç¨‹"></a>é’©å­çš„å…¥å£çº¿ç¨‹</h2><p><code>ngx_stream_lua_new_thread()</code>ç”¨äºåˆ›å»ºå…¥å£çº¿ç¨‹</p>
<p>ORä¸­éœ€è¦åœ¨Registryè¡¨ä¸­å­˜å‚¨æ¯ä¸ªåˆ›å»ºå‡ºæ¥çš„Luaçº¿ç¨‹çš„referenceï¼Œè¿™ä¸ªå­˜å‚¨åç¨‹çš„è¡¨åœ¨Registryè¡¨ä¸­å¯¹åº”çš„keyæ˜¯å…¨å±€å˜é‡<code>ngx_stream_lua_coroutines_key</code>çš„åœ°å€ï¼Œå› æ­¤ä¸‹é¢è¿™æ®µä»£ç å°±æ˜¯ä»Registryè¡¨ä¸­æŸ¥è¯¢è¿™ä¸ªå‚¨å­˜åç¨‹çš„è¡¨ï¼Œè¿”å›åˆ°æ ˆé¡¶ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* è¿”å›æ ˆé¡¶å…ƒç´ çš„ç´¢å¼•ï¼Œç­‰äºæ ˆä¸­å…ƒç´ çš„ä¸ªæ•° */</span></span><br><span class="line">base = lua_gettop(L);</span><br><span class="line"><span class="comment">/* å°†å­˜å‚¨åç¨‹çš„è¡¨å¯¹åº”çš„keyå‹æ ˆ */</span></span><br><span class="line">lua_pushlightuserdata(L, ngx_stream_lua_lightudata_mask(</span><br><span class="line">                      coroutines_key));</span><br><span class="line"><span class="comment">/* å°†keyå‡ºæ ˆï¼Œè·å–Registryè¡¨ä¸­keyå¯¹åº”çš„å…ƒç´ ï¼Œç„¶åå°†ç»“æœå…¥æ ˆ */</span></span><br><span class="line">lua_rawget(L, LUA_REGISTRYINDEX);</span><br></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥åˆ›å»ºä¸€ä¸ªæ–°çš„åç¨‹ï¼ŒåŒæ—¶åˆå§‹åŒ–å…¶å…¨å±€è¡¨ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* åˆ›å»ºLuaåç¨‹ï¼Œè¿”å›çš„æ–°lua_Stateè·ŸåŸæœ‰çš„lua_Stateå…±äº«æ‰€æœ‰çš„å…¨å±€å¯¹è±¡ï¼ˆå¦‚è¡¨ï¼‰ï¼Œ</span></span><br><span class="line"><span class="comment">   ä½†æ˜¯æœ‰ä¸€ä¸ªç‹¬ç«‹çš„æ‰§è¡Œæ ˆã€‚ åç¨‹ä¾èµ–åƒåœ¾å›æ”¶é”€æ¯ */</span></span><br><span class="line"><span class="comment">/* Læ ˆï¼š |åç¨‹è¡¨|æ–°åç¨‹|é¡¶| */</span></span><br><span class="line">co = lua_newthread(L);  </span><br><span class="line"><span class="comment">/* åˆ›å»ºè¯¥åç¨‹çš„å…¨å±€è¡¨ï¼Œè®¾ç½®_G fieldä¸ºå…¨å±€è¡¨è‡ªå·± */</span></span><br><span class="line"><span class="comment">/* Læ ˆï¼š |åç¨‹è¡¨|æ–°åç¨‹|åç¨‹æ–°çš„å…¨å±€è¡¨|é¡¶| */</span></span><br><span class="line">ngx_stream_lua_create_new_globals_table(co, <span class="number">0</span>, <span class="number">0</span>); </span><br><span class="line"><span class="comment">/* å†åˆ›å»ºä¸€ä¸ªæ–°è¡¨ */</span></span><br><span class="line"><span class="comment">/* Læ ˆï¼š |åç¨‹è¡¨|æ–°åç¨‹|åç¨‹æ–°çš„å…¨å±€è¡¨|æ–°è¡¨|é¡¶| */</span></span><br><span class="line">lua_createtable(co, <span class="number">0</span>, <span class="number">1</span>);  </span><br><span class="line"><span class="comment">/* æ‹¿åˆ°å…¨å±€è¡¨ */</span></span><br><span class="line"><span class="comment">/* Læ ˆï¼š |åç¨‹è¡¨|æ–°åç¨‹|åç¨‹æ–°çš„å…¨å±€è¡¨|æ–°è¡¨|æ—§å…¨å±€è¡¨|é¡¶| */</span></span><br><span class="line">ngx_stream_lua_get_globals_table(co);   </span><br><span class="line"><span class="comment">/* æ–°è¡¨çš„__indexçš„å€¼ä¸ºæ ˆé¡¶çš„å€¼ï¼Œä¹Ÿå³å°±å…¨å±€è¡¨ */</span></span><br><span class="line"><span class="comment">/* Læ ˆï¼š |åç¨‹è¡¨|æ–°åç¨‹|åç¨‹æ–°çš„å…¨å±€è¡¨|æ–°è¡¨|é¡¶| */</span></span><br><span class="line">lua_setfield(co, <span class="number">-2</span>, <span class="string">&quot;__index&quot;</span>);    </span><br><span class="line"><span class="comment">/* æ–°è¡¨å‡ºæ ˆï¼Œå°†å…¶è®¾ä¸ºç´¢å¼•-2å¤„å³åç¨‹æ–°çš„å…¨å±€è¡¨çš„å…ƒè¡¨ */</span></span><br><span class="line"><span class="comment">/* Læ ˆï¼š |åç¨‹è¡¨|æ–°åç¨‹|åç¨‹æ–°çš„å…¨å±€è¡¨|é¡¶| */</span></span><br><span class="line">lua_setmetatable(co, <span class="number">-2</span>);</span><br><span class="line"><span class="comment">/* è®¾ç½®åç¨‹æ–°çš„å…¨å±€è¡¨åˆ°å¯¹åº”ç´¢å¼•ï¼Œå…¶_G fieldæ˜¯è‡ªå·±ï¼Œ</span></span><br><span class="line"><span class="comment">   å…¶å…ƒè¡¨æ˜¯æ–°è¡¨ï¼Œæ–°è¡¨çš„__indexæ˜¯çˆ¶åç¨‹çš„å…¨å±€è¡¨ */</span></span><br><span class="line"><span class="comment">/* Læ ˆï¼š |åç¨‹è¡¨|æ–°åç¨‹|é¡¶| */</span></span><br><span class="line">ngx_stream_lua_set_globals_table(co);</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸€å—çš„é€»è¾‘æœ‰ç‚¹ç»•ï¼Œæˆ‘ä»¬æ¥ç¨å¾®ç†ä¸€ä¸‹ï¼Œå…¶å®å°±æ˜¯ç”¨æ–°å»ºçš„å…¨å±€è¡¨æ›¿æ¢äº†æ—§çš„å…¨å±€è¡¨ï¼Œå…¶ä¸­æ–°çš„å…¨å±€è¡¨çš„<code>_G</code>å­—æ®µæ˜¯å®ƒè‡ªå·±ï¼Œæ–°å…¨å±€è¡¨çš„å…ƒè¡¨ä¸­<code>__index</code>å…ƒæ–¹æ³•æ˜¯æ—§çš„å…¨å±€è¡¨ã€‚</p>
<p>æ­¤æ—¶çš„Luaè™šæ‹Ÿæœºæ ˆé¡¶æƒ…å†µå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">L-&gt;top      |   æ ˆé¡¶    |</span><br><span class="line">L-&gt;top - 1  |Lua_State*|    æ–°åˆ›å»ºçš„åç¨‹</span><br><span class="line">L-&gt;top -2   | Lua Table|    å­˜å‚¨åç¨‹å¼•ç”¨çš„è¡¨</span><br></pre></td></tr></table></figure>

<p>ä¸‹é¢ä¸€æ­¥å°±æ˜¯åœ¨Luaè™šæ‹Ÿæœºä¸­ä¸ºè¿™ä¸ªæ–°åç¨‹åˆ›å»ºä¸€ä¸ªreferenceï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* ä¸ºæ ˆé¡¶å¯¹è±¡ï¼ˆå³æ–°åç¨‹ï¼‰ï¼Œåˆ›å»ºå¹¶è¿”å›ä¸€ä¸ªåç¨‹è¡¨ä¸­çš„å¼•ç”¨ */</span></span><br><span class="line"><span class="comment">/* å½“å‰æ ˆï¼š |åç¨‹è¡¨|é¡¶| */</span></span><br><span class="line">*ref = luaL_ref(L, <span class="number">-2</span>);</span><br><span class="line"><span class="keyword">if</span> (*ref == LUA_NOREF) &#123;</span><br><span class="line">    lua_settop(L, base);  <span class="comment">/* restore main thread stack */</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æœ€åæ¢å¤å †æ ˆ</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* è®¾ç½®æ ˆé¡¶ç´¢å¼• */</span></span><br><span class="line"><span class="comment">/* å½“å‰æ ˆï¼š |é¡¶| */</span></span><br><span class="line">lua_settop(L, base);    </span><br><span class="line"><span class="keyword">return</span> co;</span><br></pre></td></tr></table></figure>

<p>ä»¥ä¸Šæ­¥éª¤è¿˜åªæ˜¯åˆ›å»ºäº†ä¸€ä¸ªä»€ä¹ˆéƒ½ä¸èƒ½åšçš„Luaåç¨‹ï¼Œå›åˆ°<code>_by_chunk()</code>å‡½æ•°ä¹‹åè¿˜éœ€è¦æŠŠå…¥å£å‡½æ•°æ”¾å…¥åç¨‹ä¸­ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* å°†luaè™šæ‹ŸæœºVMæ ˆä¸Šçš„å…¥å£å‡½æ•°é—­åŒ…ç§»åˆ°æ–°åˆ›å»ºçš„åç¨‹æ ˆä¸Šï¼Œ</span></span><br><span class="line"><span class="comment">   è¿™æ ·æ–°åç¨‹å°±æœ‰äº†è™šæ‹Ÿæœºå·²ç»è§£æå®Œæ¯•çš„ä»£ç äº†ã€‚*/</span></span><br><span class="line">lua_xmove(L, co, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* æ‹¿åˆ°coå…¨å±€è¡¨ï¼Œæ”¾åˆ°æ ˆé¡¶ */</span></span><br><span class="line"><span class="comment">/* å½“å‰æ ˆï¼š |å…¥å£closure|å…¨å±€è¡¨|é¡¶| */</span></span><br><span class="line">ngx_stream_lua_get_globals_table(co);</span><br><span class="line"><span class="comment">/* å°†å…¨å±€è¡¨è®¾ä¸ºå…¥å£closureçš„ç¯å¢ƒè¡¨ */</span></span><br><span class="line"><span class="comment">/* å½“å‰æ ˆï¼š |å…¥å£closure|é¡¶|*/</span></span><br><span class="line">lua_setfenv(co, <span class="number">-2</span>);</span><br></pre></td></tr></table></figure>

<p>è‡³æ­¤ï¼Œåç¨‹å…¥å£å‡½æ•°ä»¥åŠç¯å¢ƒè¡¨å·²ç»è®¾ç½®å¥½ã€‚æ¥ä¸‹æ¥å°±æ˜¯è®©å®ƒèƒ½å¤Ÿè¿è¡Œèµ·æ¥ï¼Œè®©è°ƒåº¦å™¨èƒ½å¤Ÿè°ƒåº¦å®ƒè¿è¡Œï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* å°†nginxè¯·æ±‚ä¿å­˜åˆ°åç¨‹å…¨å±€è¡¨ */</span></span><br><span class="line">ngx_stream_lua_set_req(co, r);</span><br><span class="line"></span><br><span class="line">ctx-&gt;cur_co_ctx = &amp;ctx-&gt;entry_co_ctx;</span><br><span class="line">ctx-&gt;cur_co_ctx-&gt;co = co;</span><br><span class="line">ctx-&gt;cur_co_ctx-&gt;co_ref = co_ref;</span><br></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥å°±æ˜¯æ³¨å†Œcleanupé’©å­ï¼Œç„¶å<code>ngx_stream_lua_run_thread()</code>ã€‚</p>
<h2 id="ç”¨æˆ·åˆ›å»ºçš„uthread"><a href="#ç”¨æˆ·åˆ›å»ºçš„uthread" class="headerlink" title="ç”¨æˆ·åˆ›å»ºçš„uthread"></a>ç”¨æˆ·åˆ›å»ºçš„uthread</h2><p>ç”¨æˆ·çº¿ç¨‹ç”±<code>ngx.thread.spawn()</code>åˆ›å»ºï¼Œå¯¹åº”çš„Cå®ç°æ˜¯<code>ngx_stream_lua_uthread_spawn()</code>ã€‚é¦–å…ˆå®ƒä¼šè°ƒ<code>ngx_stream_lua_coroutine_create_helper()</code>åˆ›å»ºä¸€ä¸ªæ–°çš„åç¨‹ã€‚</p>
<h3 id="åˆ›å»ºåç¨‹"><a href="#åˆ›å»ºåç¨‹" class="headerlink" title="åˆ›å»ºåç¨‹"></a>åˆ›å»ºåç¨‹</h3><p>æ³¨æ„åç¨‹éƒ½æ˜¯åœ¨workerçš„è™šæ‹Ÿæœºä¸Šåˆ›å»ºçš„ï¼ˆä¸è€ƒè™‘cache offçš„æƒ…å†µçš„è¯ï¼‰ã€‚ä½†æ˜¯ç”¨æˆ·åç¨‹ä¼šç»§æ‰¿çˆ¶åç¨‹çš„å…¨å±€è¡¨ï¼Œå…¶çˆ¶å­å…³ç³»ç”±ORè¿›è¡Œç»´æŠ¤ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* è·å–è™šæ‹Ÿæœº */</span></span><br><span class="line">vm = ngx_stream_lua_get_lua_vm(r, ctx);</span><br><span class="line"><span class="comment">/* åˆ›å»ºæ–°åç¨‹ */</span></span><br><span class="line">co = lua_newthread(vm);</span><br><span class="line"><span class="comment">/* ç„¶ååˆ›å»ºcoctxï¼Œè®¾ç½®å…¶coã€co_statuså€¼ */</span></span><br><span class="line">coctx = ngx_stream_lua_create_co_ctx;</span><br><span class="line">coctx-&gt;co = co;</span><br><span class="line">coctx-&gt;co_status = NGX_STREAM_LUA_CO_SUSPENDED;</span><br></pre></td></tr></table></figure>

<p>æ­¤æ—¶çˆ¶åç¨‹çš„æ ˆå¦‚ä¸‹:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/* å½“å‰æ ˆ: |entry_func|args|é¡¶| */</span><br></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥å°†çˆ¶åç¨‹çš„å…¨å±€è¡¨ç»™æ–°åˆ›å»ºçš„åç¨‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* make new coroutine share globals of the parent coroutine.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">NOTE:</span> globals don&#x27;t have to be separated! */</span></span><br><span class="line"><span class="comment">/* æ‹·è´çˆ¶åç¨‹çš„å…¨å±€è¡¨åˆ°æ ˆä¸Š */</span></span><br><span class="line"><span class="comment">/* Læ ˆ: |entry_func|args|å…¨å±€è¡¨|é¡¶| */</span></span><br><span class="line">ngx_stream_lua_get_globals_table(L);</span><br><span class="line"><span class="comment">/* å°†å…¨å±€è¡¨ç§»åŠ¨åˆ°æ–°åˆ›å»ºçš„åç¨‹coçš„æ ˆä¸Š */</span></span><br><span class="line"><span class="comment">/* Læ ˆ: |entry_func|args|é¡¶| */</span></span><br><span class="line">lua_xmove(L, co, <span class="number">1</span>);</span><br><span class="line"><span class="comment">/* ä»æ–°åç¨‹æ ˆä¸Šå†™å…¥å…¶çš„å…¨å±€è¡¨ */</span></span><br><span class="line">ngx_stream_lua_set_globals_table(co);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* å°†æ–°åç¨‹ä»è¿›ç¨‹è™šæ‹Ÿæœºï¼Œç§»åŠ¨åˆ°çˆ¶åç¨‹ä¸­ */</span></span><br><span class="line"><span class="comment">/* Læ ˆ: |entry_func|args|æ–°åç¨‹|é¡¶| */</span></span><br><span class="line">lua_xmove(vm, L, <span class="number">1</span>);</span><br><span class="line"><span class="comment">/* å…¥å£å‡½æ•°æ‹·è´åˆ°Læ ˆé¡¶ */</span></span><br><span class="line"><span class="comment">/* Læ ˆ: |entry_func|args|æ–°åç¨‹|entry_func|é¡¶|*/</span></span><br><span class="line">lua_pushvalue(L, <span class="number">1</span>); </span><br><span class="line"><span class="comment">/* å°†å…¥å£å‡½æ•°ä»Lç§»åˆ°coæ ˆä¸­ */</span></span><br><span class="line"><span class="comment">/* Læ ˆ: |entry_func|args|æ–°åç¨‹|é¡¶| */</span></span><br><span class="line"><span class="comment">/* coæ ˆ: |entry_func|é¡¶|*/</span></span><br><span class="line">lua_xmove(L, co, <span class="number">1</span>);  </span><br></pre></td></tr></table></figure>

<p><code>create_helper</code>å‡½æ•°è¿”å›ä¹‹åï¼ŒLçš„æ ˆé¡¶æ˜¯æ–°åç¨‹ï¼Œcoçš„æ ˆé¡¶æ˜¯å…¥å£å‡½æ•°ã€‚</p>
<h3 id="åˆå§‹åŒ–uthread"><a href="#åˆå§‹åŒ–uthread" class="headerlink" title="åˆå§‹åŒ–uthread"></a>åˆå§‹åŒ–uthread</h3><p><code>ngx_stream_lua_coroutine_create_helper</code>è¿”å›ä¹‹åï¼Œè¿›è¡Œuthreadçš„åˆå§‹åŒ–ã€‚</p>
<p>æ­¤æ—¶ï¼Œçˆ¶åç¨‹Læ˜¯è¿™æ ·çš„ï¼š</p>
<ul>
<li>æ ˆé¡¶æ˜¯æ–°åˆ›å»ºçš„åç¨‹</li>
<li>ç„¶åæ˜¯å‚æ•°å’Œå…¥å£å‡½æ•°</li>
</ul>
<p>åœ¨æ­¤ä¹‹å‰ï¼Œå…ˆåœ¨registryè¡¨ä¸­ä¿å­˜ä¸€ä¸ªè¯¥åç¨‹çš„refã€‚ï¼ˆåˆ°ç°åœ¨è¿˜æ²¡ææ˜ç™½è¿™ä¸ªrefæ˜¯å¹²å˜›ç”¨çš„ï¼Ÿé™¤äº†åˆ›å»ºçº¿ç¨‹å’Œåˆ é™¤çº¿ç¨‹ï¼Œè²Œä¼¼åªæœ‰æ£€æŸ¥çº¿ç¨‹æ˜¯å¦æ´»ç€çš„æ—¶å€™ä¼šæŸ¥ä¸€ä¸‹è¿™ä¸ªrefï¼Œåªæ˜¯æ£€æŸ¥çŠ¶æ€ç”¨<code>coctx-&gt;co_status</code>ä¸æ˜¯ä¹Ÿèƒ½åšåˆ°ä¹ˆï¼Ÿ8.12æ›´æ–°ï¼Œä¹‹æ‰€ä»¥è¦æŠŠçº¿ç¨‹é”šå®šåˆ°æ³¨å†Œè¡¨ä¸Šï¼Œæ˜¯ä¸ºäº†é˜²æ­¢è¢«å½“æˆåƒåœ¾å›æ”¶ã€‚è¿™ä¹Ÿè§£é‡Šäº†ä¸ºä»€ä¹ˆåªæœ‰çº¿ç¨‹éœ€è¦é”šå®šåˆ°æ³¨å†Œè¡¨ä¸Šï¼Œè€Œç”¨æˆ·åç¨‹ä¸éœ€è¦ã€‚å› ä¸ºç”¨æˆ·åç¨‹è‚¯å®šç”±å…¶çˆ¶åç¨‹ä¿ç•™ç€ä¸€ä¸ªå¼•ç”¨ã€‚ï¼‰</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* anchor the newly created coroutine into the Lua registry */</span></span><br><span class="line"><span class="comment">/* æŠŠæ–°åˆ›å»ºçš„åç¨‹å†™å…¥Lua registryè¡¨ä¸­ */</span></span><br><span class="line"><span class="comment">/* å°†ngx_stream_lua_coroutines_keyçš„åœ°å€å‹å…¥æ ˆä¸­ */</span></span><br><span class="line">lua_pushlightuserdata(L, &amp;ngx_stream_lua_coroutines_key);</span><br><span class="line"><span class="comment">/* ä»registryè¡¨ä¸­è·å–åç¨‹è¡¨ */</span></span><br><span class="line"><span class="comment">/* Læ ˆ: |entry_func|args|æ–°åç¨‹|åç¨‹è¡¨|é¡¶|*/</span></span><br><span class="line">lua_rawget(L, LUA_REGISTRYINDEX);</span><br><span class="line"><span class="comment">/* å°†æ–°åç¨‹å‹æ ˆ */</span></span><br><span class="line"><span class="comment">/* Læ ˆ: |entry_func|args|æ–°åç¨‹|åç¨‹è¡¨|æ–°åç¨‹|é¡¶|*/</span></span><br><span class="line">lua_pushvalue(L, <span class="number">-2</span>);</span><br><span class="line"><span class="comment">/* -2ä½ç½®æ˜¯æ³¨å†Œè¡¨ï¼Œä¸ºæ–°åç¨‹åˆ›å»ºåœ¨æŠ¥è¡¨ä¸­çš„ç´¢å¼• */</span></span><br><span class="line"><span class="comment">/* Læ ˆ: |entry_func|args|æ–°åç¨‹|åç¨‹è¡¨|é¡¶| */</span></span><br><span class="line">coctx-&gt;co_ref = luaL_ref(L, <span class="number">-2</span>);    <span class="comment">// </span></span><br><span class="line"><span class="comment">/* å¼¹å‡ºåç¨‹è¡¨ */</span></span><br><span class="line"><span class="comment">/* Læ ˆ: |entry_func|args|æ–°åç¨‹|é¡¶| */</span></span><br><span class="line">lua_pop(L, <span class="number">1</span>);</span><br></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥æ˜¯åˆå§‹åŒ–è¿è¡Œç¯å¢ƒï¼š</p>
<p>æ­¤æ—¶çš„ï¼ŒLçš„æ ˆæƒ…å†µå¦‚ä¸‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">|entry_func|å‚æ•°1|...|å‚æ•°n|æ–°åç¨‹|</span><br><span class="line">    1        2   ...  -2    -1</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (n &gt; <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="comment">/* ç”±äºluaå‡½æ•°å‹æ ˆé¡ºåºæ˜¯ä»å·¦åˆ°å³</span></span><br><span class="line"><span class="comment">     * å› æ­¤1å°±æ˜¯å‹å…¥çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œè€Œspawnçš„ç¬¬ä¸€ä¸ªå‚æ•°å°±æ˜¯å…¥å£å‡½æ•°</span></span><br><span class="line"><span class="comment">     * æŠŠæ ˆé¡¶å…ƒç´ ï¼ˆå³æ–°åç¨‹ï¼‰ç§»åŠ¨åˆ°1ï¼Œè¦†ç›–å…¥å£å‡½æ•°ï¼Œå…¥å£å‡½æ•°å‰é¢å·²ç»æ‹·è´åˆ°æ–°åç¨‹æ ˆä¸Šäº†</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">/* Læ ˆ: |æ–°åç¨‹|args|é¡¶| */</span></span><br><span class="line">    lua_replace(L, <span class="number">1</span>);</span><br><span class="line">    <span class="comment">/* å°†å‚æ•°ç§»åˆ°æ–°åç¨‹æ ˆä¸­ */</span></span><br><span class="line">    <span class="comment">/* Læ ˆ: |æ–°åç¨‹|é¡¶|*/</span></span><br><span class="line">    <span class="comment">/* coæ ˆ: |å…¥å£å‡½æ•°|args|é¡¶| */</span></span><br><span class="line">    lua_xmove(L, coctx-&gt;co, n - <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è®¾ç½®çŠ¶æ€ï¼Œå°†çˆ¶åç¨‹æ”¾å…¥post_threadé˜Ÿåˆ—ä¸­ï¼Œè®¾ç½®åç¨‹çš„çˆ¶å­å…³ç³»ï¼Œè®¾ç½®æ–°åç¨‹ä¸ºä¸‹ä¸€ä¸ªè°ƒåº¦çš„çº¿ç¨‹</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* è®¾ç½®çŠ¶æ€ */</span></span><br><span class="line">coctx-&gt;co_status = NGX_STREAM_LUA_CO_RUNNING;</span><br><span class="line">ctx-&gt;co_op = NGX_STREAM_LUA_USER_THREAD_RESUME;</span><br><span class="line">ctx-&gt;cur_co_ctx-&gt;thread_spawn_yielded = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* å°†çˆ¶åç¨‹æ”¾å…¥post_threadé˜Ÿåˆ—ä¸­ */</span></span><br><span class="line">ngx_stream_lua_post_thread(r, ctx, ctx-&gt;cur_co_ctx)</span><br><span class="line"></span><br><span class="line"><span class="comment">/* ä¿å­˜å­çº¿ç¨‹çš„çˆ¶åç¨‹ä¸Šä¸‹æ–‡ä¸ºå½“å‰åç¨‹ */</span></span><br><span class="line">coctx-&gt;parent_co_ctx = ctx-&gt;cur_co_ctx;</span><br><span class="line"><span class="comment">/* åˆ‡æ¢å½“å‰åç¨‹ä¸ºæ–°åˆ›å»ºçš„åç¨‹ */</span></span><br><span class="line">ctx-&gt;cur_co_ctx = coctx;</span><br></pre></td></tr></table></figure>

<p>æœ€åï¼Œspawnå‡½æ•°çš„è¿”å›å€¼æ˜¯æ–°åˆ›å»ºçš„åç¨‹</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* å°†åŸåç¨‹çš„æ‰§è¡Œæƒåˆ‡æ¢å‡ºå»ï¼Œè¿™é‡Œçš„å‚æ•°1è¡¨ç¤ºæ ˆä¸Šç•™äº†ä¸€ä¸ªå€¼ï¼Œè¿™é‡Œæ˜¯æŒ‡æ–°åˆ›å»ºçš„åç¨‹</span></span><br><span class="line"><span class="comment"> * ä¸»çº¿ç¨‹å¹¶ä¸ä¼šå–è¿™ä¸ªå€¼ï¼Œè€Œæ˜¯ç­‰åˆ°æ–°çº¿ç¨‹spawnè¿”å›æ—¶ä½œä¸ºè¿”å›å€¼ã€‚</span></span><br><span class="line"><span class="comment"> * æ­¤æ—¶Læ ˆä¸­æ˜¯æ–°åç¨‹ï¼Œcoæ ˆä¸­æ˜¯å‚æ•°å’Œå…¥å£å‡½æ•°ã€‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">return</span> lua_yield(L, <span class="number">1</span>);</span><br></pre></td></tr></table></figure>

<h2 id="ç”¨æˆ·åˆ›å»ºçš„coroutine"><a href="#ç”¨æˆ·åˆ›å»ºçš„coroutine" class="headerlink" title="ç”¨æˆ·åˆ›å»ºçš„coroutine"></a>ç”¨æˆ·åˆ›å»ºçš„coroutine</h2><p>ORæ›¿æ¢äº†åŸç”Ÿçš„coroutineæ¥å£ï¼Œå½“å­˜åœ¨<code>getfenv(0).__ngx_req</code>æ—¶ï¼ˆå…¨å±€ç¯å¢ƒä¿å­˜äº†nginxè¯·æ±‚ï¼‰ï¼Œä½¿ç”¨é‡å†™åçš„coroutineæ¥å£å‡½æ•°ã€‚</p>
<p><code>coroutine.create()</code>åˆ›å»ºæ–°åç¨‹éƒ¨åˆ†è·Ÿuthreadæ˜¯ä¸€æ ·çš„ï¼Œéƒ½æ˜¯è°ƒç”¨<code>ngx_stream_lua_coroutine_create_helper()</code>ã€‚Luaå‡½æ•°è¿”å›æ–°åç¨‹ã€‚æ­¤æ—¶æ–°åç¨‹æ ˆä¸­æ˜¯å…¥å£å‡½æ•°ã€‚</p>
<p><code>coroutine.resume()</code>ç”¨äºå¼€å§‹æˆ–æ¢å¤æ–°åç¨‹ï¼Œå…¶å¯¹åº”çš„Cå‡½æ•°æ˜¯<code>ngx_http_lua_coroutine_resume()</code>ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* é¦–å…ˆï¼Œè·å–åˆ°åç¨‹ */</span></span><br><span class="line"><span class="comment">/* Læ ˆ: |co|å‚æ•°|,  coæ ˆ: |å…¥å£å‡½æ•°| */</span></span><br><span class="line">co = lua_tothread(L, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* ç„¶åè®¾ç½®çŠ¶æ€å’Œçˆ¶å­å…³ç³» */</span></span><br><span class="line"><span class="comment">/* çˆ¶åç¨‹ä¸ºnormal */</span></span><br><span class="line">p_coctx-&gt;co_status = NGX_HTTP_LUA_CO_NORMAL;</span><br><span class="line"></span><br><span class="line">coctx-&gt;parent_co_ctx = p_coctx;</span><br><span class="line"></span><br><span class="line">dd(<span class="string">&quot;set coroutine to running&quot;</span>);</span><br><span class="line"><span class="comment">/* å­åç¨‹ä¸ºrunning */</span></span><br><span class="line">coctx-&gt;co_status = NGX_HTTP_LUA_CO_RUNNING;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* è®¾ç½®co_opå‘ŠçŸ¥ä¸»çº¿ç¨‹yieldç±»å‹ */</span></span><br><span class="line">ctx-&gt;co_op = NGX_HTTP_LUA_USER_CORO_RESUME;</span><br><span class="line"><span class="comment">/* è®¾ç½®ä¸‹ä¸€ä¸ªè°ƒåº¦åç¨‹ä¸ºæ–°åç¨‹ */</span></span><br><span class="line">ctx-&gt;cur_co_ctx = coctx;</span><br></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥ï¼Œå°†æ§åˆ¶æƒäº¤è¿˜ç»™ä¸»åç¨‹ï¼Œå¹¶æŠŠå‚æ•°ä¼ ç»™ä¸»çº¿ç¨‹ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* æ­¤æ—¶Læ ˆ: |co|å‚æ•°|ï¼Œ coæ ˆ: |å…¥å£å‡½æ•°| */</span></span><br><span class="line"><span class="comment">/* lua_gettop(L) - 1è¡¨ç¤ºç•™åœ¨æ ˆä¸­çš„è¿”å›å€¼ä¸ªæ•°ï¼Œ</span></span><br><span class="line"><span class="comment"> * ç”±ä¸»çº¿ç¨‹å–ç”¨ä¹‹åï¼Œåœ¨lua_resumeæ–°åç¨‹æ—¶ä¼ é€’ */</span></span><br><span class="line"><span class="comment">/* å‡ä¸€ä¸ªï¼Œè¡¨ç¤ºä¸ä¼ åº•ä¸‹çš„co */</span></span><br><span class="line"><span class="keyword">return</span> lua_yield(L, lua_gettop(L) - <span class="number">1</span>);</span><br></pre></td></tr></table></figure>

<h1 id="åç¨‹æ‰§è¡Œå’Œæ¢å¤"><a href="#åç¨‹æ‰§è¡Œå’Œæ¢å¤" class="headerlink" title="åç¨‹æ‰§è¡Œå’Œæ¢å¤"></a>åç¨‹æ‰§è¡Œå’Œæ¢å¤</h1><p>ORä¸­åç¨‹çš„æ‰§è¡Œå’Œæ¢å¤æ€»æ˜¯ç”±ä¸»çº¿ç¨‹æ¥è¿›è¡Œï¼Œä¸ç®¡æ˜¯<code>coroutine.resume()</code>è¿˜æ˜¯<code>ngx.thread.spawn()</code>ï¼Œéƒ½æ˜¯å…ˆ<code>lua_yield()</code>å›åˆ°ä¸»çº¿ç¨‹ä¹‹åï¼Œåœ¨ä¸»çº¿ç¨‹ä¸­<code>lua_resume()</code>ã€‚</p>
<p>æ³¨æ„åˆ°å‰é¢åˆ›å»ºé˜¶æ®µï¼Œthreadæ˜¯<code>lua_yield(L, 1)</code>ï¼Œcoroutineæ˜¯<code>lua_yield(L, lua_gettop(L) - 1)</code>ã€‚yieldåˆ°ä¸»çº¿ç¨‹ä¹‹åï¼Œæˆ‘ä»¬ç»§ç»­çœ‹è°ƒåº¦ç¨‹åºçš„å¤„ç†ã€‚</p>
<h2 id="uthread"><a href="#uthread" class="headerlink" title="uthread"></a>uthread</h2><p>å…ˆè·å–å‚æ•°ä¸ªæ•°</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* å› ä¸ºå…¥å£å‡½æ•°å’Œå‚æ•°å·²ç»åœ¨æ–°çº¿ç¨‹æ ˆä¸­äº†,æ‰€ä»¥ä»æ–°åç¨‹ä¸­è·å–å‚æ•°ä¸ªæ•°ï¼Œ-1æ˜¯é™¤æ‰å…¥å£å‡½æ•° */</span></span><br><span class="line">nrets = lua_gettop(ctx-&gt;cur_co_ctx-&gt;co) - <span class="number">1</span>;    </span><br></pre></td></tr></table></figure>

<p>ç„¶åè·³åˆ°ä¸»å¾ªç¯çš„å‰é¢ï¼Œæ‰§è¡Œæ–°çº¿ç¨‹</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* ä¿å­˜æ–°åç¨‹coctx */</span></span><br><span class="line">orig_coctx = ctx-&gt;cur_co_ctx;</span><br><span class="line"><span class="comment">/* æ‰§è¡Œæ–°çº¿ç¨‹ï¼Œå…¶ä¸­nretsä¸ºå‚æ•°ä¸ªæ•° */</span></span><br><span class="line">rv = lua_resume(orig_coctx-&gt;co, nrets);</span><br></pre></td></tr></table></figure>

<p>åœ¨<code>lua_resume</code>ä¸­å°±ä¼šå¼€å§‹æ–°çº¿ç¨‹çš„æ‰§è¡Œã€‚å½“æ–°çº¿ç¨‹æ‰§è¡Œå®Œæ¯•æˆ–å› I&#x2F;Oä¸­æ–­yieldä¹‹åï¼Œä¼šæ¢å¤çˆ¶åç¨‹ã€‚åœ¨æ¢å¤çˆ¶åç¨‹ä¹‹å‰ï¼Œå…ˆè®¾ç½®å‚æ•°ä¸ªæ•°ä¸º1ï¼Œå³ä¹‹å‰ç•™åœ¨æ ˆä¸Šçš„æ–°åç¨‹coã€‚æ¢å¤çˆ¶åç¨‹ä¹‹åï¼Œ<code>ngx.thread.spawn()</code>å‡½æ•°å°±è¿”å›äº†ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (ctx-&gt;cur_co_ctx-&gt;thread_spawn_yielded) &#123;</span><br><span class="line">    ctx-&gt;cur_co_ctx-&gt;thread_spawn_yielded = <span class="number">0</span>;</span><br><span class="line">    nrets = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="coroutine"><a href="#coroutine" class="headerlink" title="coroutine"></a>coroutine</h2><p>åŒæ ·æ˜¯å…ˆè·å–å‚æ•°ä¸ªæ•°</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* è·å–çˆ¶åç¨‹ */</span></span><br><span class="line">old_co = ctx-&gt;cur_co_ctx-&gt;parent_co_ctx-&gt;co;</span><br><span class="line"><span class="comment">/* å› ä¸ºå‚æ•°è¿˜åœ¨çˆ¶åç¨‹æ ˆä¸­ï¼Œæ‰€ä»¥ä»çˆ¶åç¨‹æ ˆä¸­è·å–å‚æ•°ä¸ªæ•° */</span></span><br><span class="line">nrets = lua_gettop(old_co);</span><br><span class="line"><span class="keyword">if</span> (nrets) &#123;</span><br><span class="line">    <span class="comment">/* å°†å‚æ•°ä»çˆ¶åç¨‹ç§»åˆ°å­åç¨‹ */</span></span><br><span class="line">    lua_xmove(old_co, ctx-&gt;cur_co_ctx-&gt;co, nrets);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ­¤æ—¶å­åç¨‹æ ˆä¸­æ˜¯å‚æ•°å’Œå…¥å£å‡½æ•°ã€‚</p>
<p>ç„¶åè·³åˆ°ä¸»å¾ªç¯çš„å‰é¢ï¼Œæ‰§è¡Œæ–°åç¨‹ï¼Œè·Ÿå‰é¢uthreadæ—¶ä¸€æ ·ã€‚</p>
<h1 id="åç¨‹æŒ‚èµ·"><a href="#åç¨‹æŒ‚èµ·" class="headerlink" title="åç¨‹æŒ‚èµ·"></a>åç¨‹æŒ‚èµ·</h1><p>åç¨‹çš„æŒ‚èµ·åˆ†ä¸ºä¸¤ç§æƒ…å†µï¼š</p>
<ul>
<li>ä¸€ç§æ˜¯å†…éƒ¨åœ¨I&#x2F;Oç­‰å¾…æ—¶è‡ªåŠ¨æŒ‚èµ·ï¼Œè¿™ç§æƒ…å†µç”¨æˆ·ä¸ç”¨å‚ä¸ï¼ŒORä¼šè‡ªåŠ¨å°†ç›¸åº”çš„äº‹ä»¶åŠå…¶handleræŒ‚åˆ°äº‹ä»¶é©±åŠ¨ä¸Šï¼Œå½“äº‹ä»¶è¢«å”¤é†’æ—¶ç»§ç»­æœªå®Œæˆçš„I&#x2F;Oæ“ä½œï¼Œå®Œæˆä¹‹åç”±è°ƒåº¦å™¨æ¢å¤ä¹‹å‰æŒ‚èµ·çš„åç¨‹ã€‚</li>
<li>å¦ä¸€ç§æ˜¯ç”¨æˆ·åœ¨Luaä»£ç ä¸»åŠ¨è°ƒç”¨<code>coroutine.yield()</code>æŒ‚èµ·ã€‚æ­¤æ—¶ç”±è°ƒåº¦å™¨æ ¹æ®æƒ…å†µå†³å®šæ‰§è¡Œä¸‹ä¸€ä¸ªæ‰§è¡Œçš„åç¨‹ã€‚</li>
</ul>
<h2 id="æ˜¾å¼ä¸»åŠ¨æŒ‚èµ·"><a href="#æ˜¾å¼ä¸»åŠ¨æŒ‚èµ·" class="headerlink" title="æ˜¾å¼ä¸»åŠ¨æŒ‚èµ·"></a>æ˜¾å¼ä¸»åŠ¨æŒ‚èµ·</h2><p>æˆ‘ä»¬å…ˆæ¥çœ‹ç”¨æˆ·ä¸»åŠ¨æŒ‚èµ·çš„æƒ…å†µï¼Œ<code>coroutine.yield()</code>å¯¹åº”çš„Cå‡½æ•°ä¸º<code>ngx_stream_lua_coroutine_yield()</code>ã€‚æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹å®ƒé‡Œé¢å¹²äº†äº›ä»€ä¹ˆã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* é¦–å…ˆä¿®æ”¹å½“å‰åç¨‹çš„çŠ¶æ€ä¸ºæŒ‚èµ· */</span></span><br><span class="line">coctx = ctx-&gt;cur_co_ctx;</span><br><span class="line">coctx-&gt;co_status = NGX_STREAM_LUA_CO_SUSPENDED;</span><br><span class="line"><span class="comment">/* è®¾ç½®co_op */</span></span><br><span class="line">ctx-&gt;co_op = NGX_STREAM_LUA_USER_CORO_YIELD;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* å¦‚æœä¸æ˜¯ç”¨æˆ·çº¿ç¨‹ï¼ˆä¹Ÿå³æ˜¯æ™®é€šcoroutineï¼‰ï¼Œä¸”æœ‰çˆ¶åç¨‹ï¼Œ</span></span><br><span class="line"><span class="comment">   å°†å…¶çˆ¶åç¨‹çŠ¶æ€è®¾ç½®ä¸ºrunning */</span></span><br><span class="line"><span class="keyword">if</span> (!coctx-&gt;is_uthread &amp;&amp; coctx-&gt;parent_co_ctx) &#123;</span><br><span class="line">    coctx-&gt;parent_co_ctx-&gt;co_status = NGX_STREAM_LUA_CO_RUNNING;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* æœ€åå°†æ§åˆ¶æƒäº¤è¿˜ä¸»çº¿ç¨‹ï¼Œå°†æ‰€æœ‰yieldå‚æ•°ä¼ é€’ç»™ä¸»çº¿ç¨‹ */</span></span><br><span class="line"><span class="keyword">return</span> lua_yield(L, lua_gettop(L));</span><br></pre></td></tr></table></figure>

<p>å›åˆ°ä¸»çº¿ç¨‹ä¹‹åï¼Œæ ¹æ®å¾…æŒ‚èµ·åç¨‹æ˜¯threadè¿˜æ˜¯corotineè¿›è¡Œä¸åŒå¤„ç†ã€‚</p>
<h3 id="thread"><a href="#thread" class="headerlink" title="thread"></a>thread</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (ngx_stream_lua_is_thread(ctx)) &#123;</span><br><span class="line">    <span class="comment">/* ä¸¢å¼ƒcoroutine.yield()çš„ä»»ä½•å‚æ•° */</span></span><br><span class="line">    lua_settop(ctx-&gt;cur_co_ctx-&gt;co, <span class="number">0</span>);</span><br><span class="line">    <span class="comment">/* å› ä¸ºthreadç”±è°ƒåº¦å™¨è´Ÿè´£è°ƒåº¦ï¼Œæ‰€ä»¥å°†å½“å‰çº¿ç¨‹çš„çŠ¶æ€æ”¹ä¸ºrunningï¼Œä¸ºä»€ä¹ˆä¸åœ¨å‰é¢ä¸€èµ·æ”¹ï¼Ÿ*/</span></span><br><span class="line">    ctx-&gt;cur_co_ctx-&gt;co_status = NGX_STREAM_LUA_CO_RUNNING;</span><br><span class="line">    <span class="comment">/* å¦‚æœå·²ç»æœ‰pendingçš„çº¿ç¨‹ï¼Œåˆ™æ”¾åˆ°é˜Ÿåˆ—ä¸­ */</span></span><br><span class="line">    <span class="keyword">if</span> (ctx-&gt;posted_threads) &#123;</span><br><span class="line">        ngx_stream_lua_post_thread(r, ctx, ctx-&gt;cur_co_ctx);</span><br><span class="line">        ctx-&gt;cur_co_ctx = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* å¦åˆ™ï¼Œç«‹å³æ¢å¤çº¿ç¨‹ */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="coroutine-1"><a href="#coroutine-1" class="headerlink" title="coroutine"></a>coroutine</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* è·å–å½“å‰æ ˆçš„é«˜åº¦ï¼Œä¹Ÿå³coroutine.yield()çš„å‚æ•°ä¸ªæ•° */</span></span><br><span class="line">nrets = lua_gettop(ctx-&gt;cur_co_ctx-&gt;co);</span><br><span class="line"><span class="comment">/* è®¾ç½®çˆ¶åç¨‹ä¸ºä¸‹ä¸€ä¸ªè°ƒåº¦çš„åç¨‹ */</span></span><br><span class="line">next_coctx = ctx-&gt;cur_co_ctx-&gt;parent_co_ctx;</span><br><span class="line">next_co = next_coctx-&gt;co;</span><br><span class="line"><span class="comment">/* å°†å‚æ•°ä»å­åç¨‹æ ˆä¸­ç§»åˆ°çˆ¶åç¨‹æ ˆä¸­ */</span></span><br><span class="line"><span class="keyword">if</span> (nrets) &#123;</span><br><span class="line">    dd(<span class="string">&quot;moving %d return values to next co&quot;</span>, nrets);</span><br><span class="line">    lua_xmove(ctx-&gt;cur_co_ctx-&gt;co, next_co, nrets);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> NGX_LUA_USE_ASSERT</span></span><br><span class="line">    ctx-&gt;cur_co_ctx-&gt;co_top -= nrets;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* å¦‚æœä¸æ˜¯wrapå°è£…çš„ï¼Œè¿˜è¦åŠ ä¸€ä¸ªtrueï¼Œä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•° */</span></span><br><span class="line"><span class="keyword">if</span> (!ctx-&gt;cur_co_ctx-&gt;is_wrap) &#123;</span><br><span class="line">    <span class="comment">/* prepare return values for coroutine.resume</span></span><br><span class="line"><span class="comment">     * (true plus any retvals)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    lua_pushboolean(next_co, <span class="number">1</span>);</span><br><span class="line">    <span class="comment">/* æ’å…¥1çš„ä½ç½®ï¼Œä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•° */</span></span><br><span class="line">    lua_insert(next_co, <span class="number">1</span>);</span><br><span class="line">    nrets++; <span class="comment">/* add the true boolean value */</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ctx-&gt;cur_co_ctx = next_coctx;</span><br><span class="line"><span class="comment">/* å›åˆ°ä¸»å¾ªç¯çš„å‰é¢ï¼Œresumeçˆ¶åç¨‹ */</span></span><br><span class="line"><span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>

<h2 id="I-x2F-Oç­‰å¾…åœºæ™¯"><a href="#I-x2F-Oç­‰å¾…åœºæ™¯" class="headerlink" title="I&#x2F;Oç­‰å¾…åœºæ™¯"></a>I&#x2F;Oç­‰å¾…åœºæ™¯</h2><p>I&#x2F;Oç­‰å¾…çš„åœºæ™¯æœ‰å¾ˆå¤šï¼Œä¸è¿‡å…¶èƒŒåçš„åŸç†éƒ½å·®ä¸å¤šï¼š</p>
<ul>
<li>å®šä¹‰ä¸€ä¸ªäº‹ä»¶ï¼Œè®¾ç½®æ¢å¤æ—¶çš„handleråŠå¯¹åº”åç¨‹ä¸Šä¸‹æ–‡ï¼Œç„¶å<code>lua_yield()</code>å›åˆ°<code>run_thread()</code>ã€‚</li>
<li>ä¸»çº¿ç¨‹å°†<code>ctx-&gt;cur_co_ctx</code>è®¾ä¸ºç©ºä¹‹åï¼Œç›´æ¥è¿”å›<code>NGX_AGAIN</code>ï¼Œå¦‚æœæœ‰<code>posted_thread</code>ä¼šç»§ç»­æ‰§è¡Œï¼Œå¦åˆ™å°†æ§åˆ¶æƒäº¤è¿˜ç»™nginxå±‚</li>
<li>åç»­å½“äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œç»§ç»­æœªå®Œæˆçš„æ“ä½œï¼Œå®Œæˆä¹‹åå°†ä¿å­˜çš„åç¨‹ä¸Šä¸‹æ–‡è®¾ä¸º<code>ctx-&gt;cur_co_ctx</code>ï¼Œç„¶åè°ƒç”¨<code>ngx_stream_lua_run_thread()</code>æ¢å¤åç¨‹çš„æ‰§è¡Œã€‚</li>
</ul>
<p>è¿™é‡Œä¸¾ä¸¤ä¸ªå…¸å‹çš„ä¾‹å­:</p>
<h3 id="ngx-sleep"><a href="#ngx-sleep" class="headerlink" title="ngx.sleep()"></a>ngx.sleep()</h3><p>å®ƒçš„Cå‡½æ•°å®ç°æ˜¯<code>ngx_stream_lua_ngx_sleep()</code>ï¼Œå…ˆå®šä¹‰è®¾ç½®å¥½handlerå’Œcoctxï¼ŒæŒ‚ä¸Šå®šæ—¶å™¨ï¼Œç„¶å<code>lua_yield()</code></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">    ngx_stream_lua_cleanup_pending_operation(coctx);</span><br><span class="line">    coctx-&gt;cleanup = ngx_stream_lua_sleep_cleanup;</span><br><span class="line">    coctx-&gt;data = r;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* ä¿å­˜æ¢å¤æ—¶çš„handlerå’Œåç¨‹ä¸Šä¸‹æ–‡ */</span></span><br><span class="line">    coctx-&gt;sleep.handler = ngx_stream_lua_sleep_handler;</span><br><span class="line">    coctx-&gt;sleep.data = coctx;</span><br><span class="line">    coctx-&gt;sleep.<span class="built_in">log</span> = r-&gt;connection-&gt;<span class="built_in">log</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* å½“delayä¸º0æ—¶ï¼Œæ”¾å…¥post_eventé˜Ÿåˆ—æˆ–æ·»åŠ å®šæ—¶å™¨ */</span></span><br><span class="line">    <span class="keyword">if</span> (delay == <span class="number">0</span>) &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> HAVE_POSTED_DELAYED_EVENTS_PATCH</span></span><br><span class="line">        dd(<span class="string">&quot;posting 0 sec sleep event to head of delayed queue&quot;</span>);</span><br><span class="line"></span><br><span class="line">        coctx-&gt;sleep.delayed = <span class="number">1</span>;</span><br><span class="line">        ngx_post_event(&amp;coctx-&gt;sleep, &amp;ngx_posted_delayed_events);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">        ngx_log_error(NGX_LOG_WARN, r-&gt;connection-&gt;<span class="built_in">log</span>, <span class="number">0</span>, <span class="string">&quot;ngx.sleep(0)&quot;</span></span><br><span class="line">                      <span class="string">&quot; called without delayed events patch, this will&quot;</span></span><br><span class="line">                      <span class="string">&quot; hurt performance&quot;</span>);</span><br><span class="line">        ngx_add_timer(&amp;coctx-&gt;sleep, (<span class="keyword">ngx_msec_t</span>) delay);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;    <span class="comment">/* æ·»åŠ å®šæ—¶å™¨ */</span></span><br><span class="line">        ngx_add_timer(&amp;coctx-&gt;sleep, (<span class="keyword">ngx_msec_t</span>) delay);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* å¤–å±‚å‡½æ•°*/</span></span><br><span class="line">    <span class="keyword">return</span> lua_yield(L, <span class="number">0</span>);</span><br></pre></td></tr></table></figure>

<p>åœ¨<code>run_thread()</code>é‡Œå°†å½“å‰åç¨‹ä¸Šä¸‹æ–‡ç½®ä¸º<code>NULL</code>ï¼Œç„¶åè¿”å›<code>NGX_AGAIN</code></p>
<p>åœ¨<code>by_chunk()</code>é‡Œä¼šå…ˆæ£€æŸ¥æœ‰æ²¡æœ‰åœ¨posté˜Ÿåˆ—é‡Œçš„çº¿ç¨‹ï¼Œå¦‚æœæ²¡æœ‰åˆ™è¿”å›</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">rc = ngx_stream_lua_run_thread(L, r, ctx, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (rc == NGX_ERROR || rc &gt;= NGX_OK) &#123;</span><br><span class="line">    <span class="comment">/* do nothing */</span></span><br><span class="line"></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (rc == NGX_AGAIN) &#123;</span><br><span class="line">    rc = ngx_stream_lua_content_run_posted_threads(L, r, ctx, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (rc == NGX_DONE) &#123; <span class="comment">/* è¿™é‡ŒDONEçš„æƒ…å†µåªæœ‰HTTPå­è¯·æ±‚çš„æ—¶å€™ä¼šå‡ºç° */</span></span><br><span class="line">    rc = ngx_stream_lua_content_run_posted_threads(L, r, ctx, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    rc = NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å½“å®šæ—¶å™¨è¶…æ—¶æ—¶ï¼Œå®ƒä¼šæ‰§è¡Œ<code>sleep_handler()</code>ï¼Œè®¾ç½®<code>ctx-&gt;cur_co_ctx</code>ç„¶åæ‰§è¡Œ<code>run_thread()</code>æ¢å¤åç¨‹è°ƒåº¦ã€‚</p>
<h3 id="ngx-tcp-receive"><a href="#ngx-tcp-receive" class="headerlink" title="ngx.tcp.receive()"></a>ngx.tcp.receive()</h3><p>å…¶å¯¹åº”çš„Cå‡½æ•°å®ç°æ˜¯<code>ngx_stream_lua_socket_tcp_receive()</code>ï¼Œé‡Œé¢ä¼šè°ƒ<code>ngx_stream_lua_socket_tcp_receive_helper()</code>ã€‚ç¢°åˆ°è¯»ç­‰å¾…çš„æƒ…å†µï¼Œä¹Ÿæ˜¯å…ˆè®¾ç½®å¥½handlerå’Œcoctxï¼Œç„¶å<code>lua_yield()</code>ã€‚æˆ‘ä»¬æ¥çœ‹ä¸‹é‡Œé¢ä»£ç ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* è¿™é‡Œ0è¡¨ç¤ºè¿˜æœªè¿›è¡Œåç¨‹åˆ‡æ¢ */</span></span><br><span class="line">u-&gt;read_waiting = <span class="number">0</span>;</span><br><span class="line">u-&gt;read_co_ctx = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* è¯»å–çš„ä¸»è¦é€»è¾‘ç”±æ­¤å‡½æ•°å¤„ç† */</span></span><br><span class="line">rc = ngx_stream_lua_socket_tcp_read(r, u);</span><br><span class="line"><span class="comment">/* ä¸ç®¡æ˜¯æˆåŠŸã€å‡ºé”™æˆ–ç­‰å¾…I/Oï¼Œè‚¯å®šä¼šè¿”å› */</span></span><br><span class="line"><span class="keyword">if</span>(rc == NGX_ERROR) &#123;</span><br><span class="line">    <span class="comment">/*...*/</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(rc == NGX_OK) &#123;</span><br><span class="line">    <span class="comment">/*...*/</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* rc == NGX_AGAIN */</span></span><br><span class="line"><span class="comment">/* å¦‚æœæ˜¯ç­‰å¾…I/Oçš„æƒ…å†µï¼Œè®¾ç½®äº‹ä»¶è§¦å‘æ—¶çš„handlerã€å½“å‰åç¨‹ä¸Šä¸‹æ–‡ */</span></span><br><span class="line">u-&gt;read_event_handler = ngx_stream_lua_socket_read_handler;</span><br><span class="line">coctx = lctx-&gt;cur_co_ctx;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* è®¾ç½®è¯·æ±‚çš„å†™äº‹ä»¶handlerï¼Œè¿™ä¸ªæ˜¯è¿”å›åˆ°Luaå±‚å‰è°ƒç”¨çš„handler */</span></span><br><span class="line">r-&gt;write_event_handler = ngx_stream_lua_content_wev_handler;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* ä¿å­˜å½“å‰åç¨‹ä¸Šä¸‹æ–‡åˆ°uä¸Š */</span></span><br><span class="line">u-&gt;read_co_ctx = coctx;</span><br><span class="line"><span class="comment">/* è¡¨ç¤ºæ˜¯åç»­æ˜¯éœ€è¦åç¨‹æ¢å¤çš„ */</span></span><br><span class="line">u-&gt;read_waiting = <span class="number">1</span>;</span><br><span class="line"><span class="comment">/* è®¾ç½®å‡†å¤‡è¿”å›å€¼çš„å›è°ƒ */</span></span><br><span class="line">u-&gt;read_prepare_retvals = ngx_stream_lua_socket_tcp_receive_retval_handler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> lua_yield(L, <span class="number">0</span>);</span><br></pre></td></tr></table></figure>

<p>å›åˆ°<code>run_thread()</code>ï¼ŒåŒæ ·æ˜¯å°†å½“å‰åç¨‹ä¸Šä¸‹æ–‡ç½®ä¸º<code>NULL</code>ï¼Œç„¶åè¿”å›<code>NGX_AGAIN</code>ã€‚</p>
<p>å½“äº‹ä»¶è¢«è§¦å‘æ—¶ï¼Œæ‰§è¡Œå‰é¢è®¾ç½®çš„<code>ngx_stream_lua_socket_read_handler()</code>ï¼Œé‡Œé¢åˆä¼šè°ƒç”¨è¯»å–æ“ä½œæ ¸å¿ƒå‡½æ•°<code>ngx_stream_lua_socket_tcp_read()</code>ã€‚å¦‚æœç»§ç»­ç¢°åˆ°ç­‰å¾…I&#x2F;Oï¼Œhandlerç›´æ¥ç»“æŸï¼Œç­‰å¾…ä¸‹ä¸€æ¬¡äº‹ä»¶ã€‚å¦‚æœæ˜¯å®Œæˆæˆ–å‡ºé”™ï¼Œä¼šæ‰§è¡Œå¦‚ä¸‹æ“ä½œï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* æ¢å¤è¯¥å€¼ä¸º0 */</span></span><br><span class="line">u-&gt;read_waiting = <span class="number">0</span>;</span><br><span class="line"><span class="comment">/* è·å–åç¨‹ä¸Šä¸‹æ–‡ */</span></span><br><span class="line">coctx = u-&gt;read_co_ctx;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* è®¾ç½®åç¨‹æ¢å¤çš„handler */</span></span><br><span class="line">ctx-&gt;resume_handler = ngx_stream_lua_socket_tcp_read_resume;</span><br><span class="line"><span class="comment">/* è®¾ç½®ä¸‹ä¸€ä¸ªè°ƒåº¦çš„ä¸Šä¸‹æ–‡ï¼Œä¸ºä¹‹å‰è°ƒç”¨è¯»å–æ“ä½œçš„åç¨‹ */</span></span><br><span class="line">ctx-&gt;cur_co_ctx = coctx;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* è¿™ä¸ªhandlerå°±æ˜¯yieldä¹‹å‰è®¾ç½®çš„é‚£ä¸ªï¼Œå®ƒé‡Œé¢è°ƒç”¨ ctx-&gt;resume_handler */</span></span><br><span class="line">r-&gt;write_event_handler(r);  </span><br></pre></td></tr></table></figure>

<p><code>r-&gt;write_event_handler(r);</code>æ˜¯è¿”å›Luaå±‚å‰è°ƒç”¨çš„handlerï¼Œé‡Œé¢ä¼šè°ƒç”¨<code>resume_handler</code>ã€‚<code>ngx_stream_lua_socket_tcp_read_resume()</code>åªæ˜¯å°è£…äº†ä¸€ä¸‹ï¼Œæœ€ç»ˆéƒ½æ˜¯è°ƒç”¨çš„<code>ngx_stream_lua_socket_tcp_resume_helper()</code>ï¼Œæˆ‘ä»¬çœ‹æ¥ä¸‹å®ƒçš„ä»£ç ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* å¾…æ¢å¤åç¨‹ä¸Šä¸‹æ–‡ */</span></span><br><span class="line">coctx = ctx-&gt;cur_co_ctx;</span><br><span class="line"></span><br><span class="line">u = coctx-&gt;data;</span><br><span class="line">prepare_retvals = u-&gt;read_prepare_retvals;</span><br><span class="line"><span class="comment">/* å‡†å¤‡è¿”å›å€¼ */</span></span><br><span class="line">nret = prepare_retvals(r, u, ctx-&gt;cur_co_ctx-&gt;co);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* æ¢å¤åç¨‹è°ƒåº¦ï¼Œå›åˆ°Luaå±‚ */</span></span><br><span class="line">rc = ngx_stream_lua_run_thread(vm, r, ctx, nret);</span><br></pre></td></tr></table></figure>

<p>è‡³äºå®Œæˆçš„æ¡ä»¶ï¼Œå–å†³ä¸ä¸åŒçš„è°ƒç”¨æ–¹å¼ã€‚å¦‚æœæ˜¯è¯»å–å›ºå®šå­—èŠ‚æ•°çš„è¯ï¼Œä¼šç»´æŠ¤ä¸€ä¸ªå‰©ä½™å¾…è¯»å–çš„å­—èŠ‚æ•°<code>u-&gt;rest</code>ã€‚å¦‚æœæ˜¯è¯»å–ä¸€è¡Œï¼Œåˆ™è¯»å–åˆ°<code>\n</code>å°±ç»“æŸã€‚å¦‚æœæ˜¯readallï¼Œåˆ™ä¸€ç›´è¯»åˆ°<code>u-&gt;eof</code>ä¸ºæ­¢ã€‚</p>
<h1 id="åç¨‹æ‰§è¡Œå®Œæ¯•"><a href="#åç¨‹æ‰§è¡Œå®Œæ¯•" class="headerlink" title="åç¨‹æ‰§è¡Œå®Œæ¯•"></a>åç¨‹æ‰§è¡Œå®Œæ¯•</h1><p>ä¸ºäº†ä¸å¤±å®Œæ•´æ€§ï¼Œå†è¯´ä¸€ä¸‹æ­£å¸¸ç»“æŸå’Œå‡ºé”™æ—¶çš„æƒ…å†µã€‚æ­£å¸¸æ‰§è¡Œå®Œæ¯•æ—¶ï¼Œä¼šè®¾ç½®åç¨‹çŠ¶æ€ï¼Œç„¶åæ¸…ç†å®ƒçš„åƒµå°¸å­çº¿ç¨‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* å°†å½“å‰åç¨‹çŠ¶æ€ç½®ä¸ºDEAD */</span></span><br><span class="line">ctx-&gt;cur_co_ctx-&gt;co_status = NGX_STREAM_LUA_CO_DEAD;</span><br><span class="line"><span class="comment">/* å¦‚æœå­çº¿ç¨‹æœ‰åƒµå°¸çº¿ç¨‹ï¼Œåˆ™æ¸…ç†ä¹‹ */</span></span><br><span class="line"><span class="keyword">if</span> (ctx-&gt;cur_co_ctx-&gt;zombie_child_threads) &#123;</span><br><span class="line">    ngx_stream_lua_cleanup_zombie_child_uthreads(</span><br><span class="line">        r, L, ctx, ctx-&gt;cur_co_ctx);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥ï¼Œæ ¹æ®ç»“æŸçš„åç¨‹çš„ç±»å‹ä¸åŒæ‰§è¡Œä¸åŒçš„æ“ä½œï¼š</p>
<h2 id="å…¥å£çº¿ç¨‹"><a href="#å…¥å£çº¿ç¨‹" class="headerlink" title="å…¥å£çº¿ç¨‹"></a>å…¥å£çº¿ç¨‹</h2><p>æ­¤æ—¶ç›´æ¥åˆ é™¤çº¿ç¨‹å³å¯ï¼Œç„¶åæ ¹æ®æ˜¯å¦è¿˜æœ‰ç”¨æˆ·çº¿ç¨‹ï¼Œé€‰æ‹©è¿”å›<code>NGX_AGAIN</code>æˆ–<code>NGX_OK</code></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (ngx_stream_lua_is_entry_thread(ctx)) &#123;</span><br><span class="line">    <span class="comment">/* å°†è™šæ‹Ÿæœºæ ˆæ¸…ç©º */</span></span><br><span class="line">    lua_settop(L, <span class="number">0</span>);</span><br><span class="line">    <span class="comment">/* åˆ é™¤å½“å‰çº¿ç¨‹ï¼Œä¼šä»REGISTYè¡¨ä¸­è§£å¼•ç”¨å½“å‰åç¨‹çš„`coctx-&gt;co_ref` */</span></span><br><span class="line">    ngx_stream_lua_del_thread(r, L, ctx, ctx-&gt;cur_co_ctx);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* å¦‚æœè¿˜æœ‰å…¶ä»–ç”¨æˆ·çº¿ç¨‹ï¼Œè¿”å›NGX_AGAIN */</span></span><br><span class="line">    <span class="keyword">if</span> (ctx-&gt;uthreads) &#123;</span><br><span class="line">        ctx-&gt;cur_co_ctx = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">return</span> NGX_AGAIN;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* all user threads terminated already */</span></span><br><span class="line">    <span class="keyword">goto</span> done;      <span class="comment">/* åˆ°è¿™å°±åœ†æ»¡ç»“æŸäº† return NGX_OK; */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="ç”¨æˆ·çº¿ç¨‹"><a href="#ç”¨æˆ·çº¿ç¨‹" class="headerlink" title="ç”¨æˆ·çº¿ç¨‹"></a>ç”¨æˆ·çº¿ç¨‹</h2><p>æ­¤æ—¶å¦‚æœçˆ¶åç¨‹å·²ç»æ­»äº†ï¼Œå¤„ç†æ–¹å¼è·Ÿå…¥å£çº¿ç¨‹ä¸€æ ·ï¼Œå³åˆ é™¤çº¿ç¨‹ï¼Œç„¶åæ ¹æ®æ˜¯å¦è¿˜æœ‰ä»»ä½•ç”¨æˆ·çº¿ç¨‹æˆ–å…¥å£çº¿ç¨‹ï¼Œé€‰æ‹©è¿”å›<code>NGX_AGAIN</code>æˆ–<code>NGX_OK</code>ã€‚</p>
<p>å¦‚æœçˆ¶åç¨‹è¿˜æ´»ç€ï¼Œå¹¶ä¸”å·²ç»åœ¨waitå®ƒäº†ï¼Œç›´æ¥æ¢å¤çˆ¶åç¨‹ã€‚å¦åˆ™ï¼ŒåŠ å…¥åˆ°çˆ¶åç¨‹çš„åƒµå°¸çº¿ç¨‹åˆ—è¡¨ä¸­ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (ctx-&gt;cur_co_ctx-&gt;is_uthread) &#123;</span><br><span class="line">    <span class="comment">/* æ¸…ç©ºè™šæ‹Ÿæœºæ ˆ */</span></span><br><span class="line">    lua_settop(L, <span class="number">0</span>); </span><br><span class="line">    <span class="comment">/* è·å–çˆ¶åç¨‹ */</span></span><br><span class="line">    parent_coctx = ctx-&gt;cur_co_ctx-&gt;parent_co_ctx;</span><br><span class="line">    <span class="comment">/* å¦‚æœçˆ¶åç¨‹è¿˜æ´»ç€ */</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_stream_lua_coroutine_alive(parent_coctx)) &#123;</span><br><span class="line">        <span class="comment">/* å¹¶ä¸”åœ¨waitå½“å‰çº¿ç¨‹ï¼Œåˆ™æ¢å¤çˆ¶åç¨‹ */</span></span><br><span class="line">        <span class="keyword">if</span> (ctx-&gt;cur_co_ctx-&gt;waited_by_parent) &#123;</span><br><span class="line">            ngx_stream_lua_probe_info(<span class="string">&quot;parent already waiting&quot;</span>);</span><br><span class="line">            ctx-&gt;cur_co_ctx-&gt;waited_by_parent = <span class="number">0</span>;</span><br><span class="line">            success = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">goto</span> user_co_done;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* å¦åˆ™å°†å½“å‰çº¿ç¨‹æŒ‚åˆ°çˆ¶åç¨‹çš„åƒµå°¸å­çº¿ç¨‹ä¸­ */</span></span><br><span class="line">        <span class="keyword">if</span> (ngx_stream_lua_post_zombie_thread(r, parent_coctx,</span><br><span class="line">                                              ctx-&gt;cur_co_ctx)</span><br><span class="line">            != NGX_OK)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/* å‹å…¥ç¬¬ä¸€ä¸ªè¿”å›å€¼trueï¼Œä»¥å¤‡åç»­waitæ—¶è¿”å› */</span></span><br><span class="line">        lua_pushboolean(ctx-&gt;cur_co_ctx-&gt;co, <span class="number">1</span>);</span><br><span class="line">        lua_insert(ctx-&gt;cur_co_ctx-&gt;co, <span class="number">1</span>);</span><br><span class="line">        <span class="comment">/* è®¾ç½®å½“å‰çº¿ç¨‹çŠ¶æ€ä¸ºZOMBIE */</span></span><br><span class="line">        ctx-&gt;cur_co_ctx-&gt;co_status = NGX_STREAM_LUA_CO_ZOMBIE;</span><br><span class="line">        ctx-&gt;cur_co_ctx = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">return</span> NGX_AGAIN;       <span class="comment">/* è¿”å›ä¸Šå±‚ */</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* å¦‚æœçˆ¶åç¨‹å·²ç»æ­»äº†ï¼Œç›´æ¥åˆ é™¤å½“å‰çº¿ç¨‹</span></span><br><span class="line"><span class="comment">     * ä¼šä»REGISTYè¡¨ä¸­è§£å¼•ç”¨å½“å‰åç¨‹çš„`coctx-&gt;co_ref` */</span></span><br><span class="line">    ngx_stream_lua_del_thread(r, L, ctx, ctx-&gt;cur_co_ctx);</span><br><span class="line">    ctx-&gt;uthreads--;</span><br><span class="line">    <span class="comment">/* å¦‚æœæ²¡æœ‰ç”¨æˆ·çº¿ç¨‹äº† */</span></span><br><span class="line">    <span class="keyword">if</span> (ctx-&gt;uthreads == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">/* å…¥å£çº¿ç¨‹åœ¨æ´»ç€ï¼Œè¿”å›ä¸Šå±‚ */</span></span><br><span class="line">        <span class="keyword">if</span> (ngx_stream_lua_entry_thread_alive(ctx)) &#123;</span><br><span class="line">            ctx-&gt;cur_co_ctx = <span class="literal">NULL</span>;</span><br><span class="line">            <span class="keyword">return</span> NGX_AGAIN;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* all threads terminated already */</span></span><br><span class="line">        <span class="keyword">goto</span> done;  <span class="comment">/* åˆ°è¿™å°±åœ†æ»¡ç»“æŸäº† return NGX_OK; */</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* å¦‚æœè¿˜æœ‰å…¶ä»–ç”¨æˆ·çº¿ç¨‹ï¼Œè¿”å›ä¸Šå±‚ */</span></span><br><span class="line">    ctx-&gt;cur_co_ctx = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">return</span> NGX_AGAIN;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="ç”¨æˆ·åç¨‹"><a href="#ç”¨æˆ·åç¨‹" class="headerlink" title="ç”¨æˆ·åç¨‹"></a>ç”¨æˆ·åç¨‹</h2><p>å‰©ä¸‹çš„å°±æ˜¯ç”¨æˆ·åç¨‹çš„æƒ…å†µï¼Œè¿™ä¸ªæƒ…å†µè·Ÿç”¨æˆ·çº¿ç¨‹è¢«çˆ¶åç¨‹waitçš„æƒ…å†µæ˜¯ä¸€æ ·çš„ã€‚ä¸»è¦æ˜¯å°†è¿”å›å€¼ç§»åŠ¨åˆ°çˆ¶åç¨‹æ ˆä¸­ï¼Œç„¶åè·³åˆ°ä¸»å¾ªç¯å‰é¢æ¢å¤çˆ¶åç¨‹çš„æ‰§è¡Œã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">success = <span class="number">1</span>;</span><br><span class="line"><span class="comment">/* è·å–è¿”å›å€¼ä¸ªæ•° */</span></span><br><span class="line">nrets = lua_gettop(ctx-&gt;cur_co_ctx-&gt;co);</span><br><span class="line">next_coctx = ctx-&gt;cur_co_ctx-&gt;parent_co_ctx;</span><br><span class="line">next_co = next_coctx-&gt;co;</span><br><span class="line"><span class="comment">/* å°†è¿”å›å€¼ç§»åˆ°çˆ¶åç¨‹æ ˆä¸­ */</span></span><br><span class="line"><span class="keyword">if</span> (nrets) &#123;</span><br><span class="line">    lua_xmove(ctx-&gt;cur_co_ctx-&gt;co, next_co, nrets);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* å¦‚æœæ˜¯ç”¨æˆ·çº¿ç¨‹ï¼Œåˆ é™¤ä¹‹ */</span></span><br><span class="line"><span class="keyword">if</span> (ctx-&gt;cur_co_ctx-&gt;is_uthread) &#123;</span><br><span class="line">    ngx_stream_lua_del_thread(r, L, ctx, ctx-&gt;cur_co_ctx);</span><br><span class="line">    ctx-&gt;uthreads--;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* é™¤äº†wrapçš„ç”¨æˆ·åç¨‹ï¼ŒåŠ ä¸Šç¬¬ä¸€ä¸ªtrueçš„è¿”å›å€¼ */</span></span><br><span class="line"><span class="keyword">if</span> (!ctx-&gt;cur_co_ctx-&gt;is_wrap) &#123;</span><br><span class="line">    <span class="comment">/* ended successfully, coroutine.resume returns true plus</span></span><br><span class="line"><span class="comment">     * any return values</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    lua_pushboolean(next_co, success);</span><br><span class="line">    lua_insert(next_co, <span class="number">1</span>);</span><br><span class="line">    nrets++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* è®¾ç½®çˆ¶åç¨‹çš„çŠ¶æ€ä¸ºRUNNING */</span></span><br><span class="line">ctx-&gt;cur_co_ctx = next_coctx;</span><br><span class="line">next_coctx-&gt;co_status = NGX_STREAM_LUA_CO_RUNNING;</span><br><span class="line"><span class="comment">/* å›åˆ°ä¸»å¾ªç¯å‰é¢ï¼Œæ¢å¤çˆ¶åç¨‹çš„æ‰§è¡Œ */</span></span><br><span class="line"><span class="keyword">continue</span>;</span><br></pre></td></tr></table></figure>



<h1 id="å‡ºé”™çš„æƒ…å†µ"><a href="#å‡ºé”™çš„æƒ…å†µ" class="headerlink" title="å‡ºé”™çš„æƒ…å†µ"></a>å‡ºé”™çš„æƒ…å†µ</h1><p>å¤§è‡´å¤„ç†æ­¥éª¤æ˜¯ï¼Œæ¢å¤<code>cur_co_ctx</code>ï¼Œè·å–è™šæ‹ŸæœºLæ ˆä¸Šé”™è¯¯ä¿¡æ¯ï¼Œè·å–å½“å‰åç¨‹æ ˆä¸­é”™è¯¯ä¿¡æ¯ï¼Œåé¢çš„æ“ä½œç±»ä¼¼åç¨‹æ‰§è¡Œå®Œæ¯•æ—¶ï¼Œæ ¹æ®ä¸åŒçš„æƒ…å†µé€‰æ‹©æ¢å¤çˆ¶åç¨‹æˆ–è€…è¿”å›ä¸Šå±‚ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* æ¢å¤cur_co_ctx */</span></span><br><span class="line"><span class="keyword">if</span> (ctx-&gt;cur_co_ctx != orig_coctx) &#123;</span><br><span class="line">    ctx-&gt;cur_co_ctx = orig_coctx;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* è®¾ç½®å½“å‰åç¨‹çŠ¶æ€ä¸ºDEAD */</span></span><br><span class="line">ctx-&gt;cur_co_ctx-&gt;co_status = NGX_HTTP_LUA_CO_DEAD;</span><br><span class="line"><span class="comment">/* è·å–é”™è¯¯ä¿¡æ¯ */</span></span><br><span class="line"><span class="keyword">if</span> (orig_coctx-&gt;is_uthread</span><br><span class="line">    || orig_coctx-&gt;is_wrap</span><br><span class="line">    || ngx_http_lua_is_entry_thread(ctx))</span><br><span class="line">&#123;</span><br><span class="line">    ngx_http_lua_thread_traceback(L, orig_coctx-&gt;co, orig_coctx);</span><br><span class="line">    trace = lua_tostring(L, <span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (lua_isstring(orig_coctx-&gt;co, <span class="number">-1</span>)) &#123;</span><br><span class="line">        msg = lua_tostring(orig_coctx-&gt;co, <span class="number">-1</span>);</span><br><span class="line">        dd(<span class="string">&quot;user custom error msg: %s&quot;</span>, msg);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        msg = <span class="string">&quot;unknown reason&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="ç”¨æˆ·çº¿ç¨‹-1"><a href="#ç”¨æˆ·çº¿ç¨‹-1" class="headerlink" title="ç”¨æˆ·çº¿ç¨‹"></a>ç”¨æˆ·çº¿ç¨‹</h2><p>è·Ÿæ­£å¸¸ç»“æŸçš„å¤„ç†ä¸€æ ·ï¼Œé™¤äº†ç¬¬ä¸€ä¸ªè¿”å›å€¼æ˜¯falseã€‚</p>
<p>æ­¤æ—¶å¦‚æœçˆ¶åç¨‹å·²ç»æ­»äº†ï¼Œç›´æ¥åˆ é™¤çº¿ç¨‹ï¼Œç„¶åæ ¹æ®æ˜¯å¦è¿˜æœ‰ä»»ä½•ç”¨æˆ·çº¿ç¨‹æˆ–å…¥å£çº¿ç¨‹ï¼Œé€‰æ‹©è¿”å›<code>NGX_AGAIN</code>æˆ–<code>NGX_OK</code>ã€‚</p>
<p>å¦‚æœçˆ¶åç¨‹è¿˜æ´»ç€ï¼Œå¹¶ä¸”å·²ç»åœ¨waitå®ƒäº†ï¼Œç›´æ¥æ¢å¤çˆ¶åç¨‹ã€‚å¦åˆ™ï¼ŒåŠ å…¥åˆ°çˆ¶åç¨‹çš„åƒµå°¸çº¿ç¨‹åˆ—è¡¨ä¸­ã€‚</p>
<h2 id="å…¥å£çº¿ç¨‹-1"><a href="#å…¥å£çº¿ç¨‹-1" class="headerlink" title="å…¥å£çº¿ç¨‹"></a>å…¥å£çº¿ç¨‹</h2><p><code>ngx_stream_lua_request_cleanup()</code>æ¸…ç†å½“å‰è¯·æ±‚ï¼Œé‡Œé¢ä¼šæ¸…ç†æ‰æ‰€æœ‰çš„ç”¨æˆ·åˆ›å»ºçš„åç¨‹ï¼Œç„¶åæ¸…ç†å…¥å£åç¨‹è‡ªå·±ã€‚æœ€åè¿”å›é”™è¯¯ç ã€‚</p>
<h2 id="ç”¨æˆ·åç¨‹-1"><a href="#ç”¨æˆ·åç¨‹-1" class="headerlink" title="ç”¨æˆ·åç¨‹"></a>ç”¨æˆ·åç¨‹</h2><p>å¦‚æœæ˜¯wrapçš„åç¨‹ï¼Œå°†é”™è¯¯ä¼ é€’ç»™çˆ¶åç¨‹ï¼ˆå°±å¥½åƒæ˜¯çˆ¶åç¨‹å‡ºé”™äº†ï¼Œç„¶åçˆ¶åç¨‹é‡æ–°èµ°ä¸€éä¸Šé¢çš„å‡ºé”™å¤„ç†æµç¨‹ï¼‰ã€‚</p>
<p>å¦‚æœæ˜¯æ™®é€šåç¨‹ï¼Œåˆ™æ¢å¤çˆ¶åç¨‹çš„æ‰§è¡Œï¼Œè¿”å›falseå’Œé”™è¯¯ä¿¡æ¯ã€‚</p>
<h1 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h1><ul>
<li><a href="https://openresty-reference.readthedocs.io/en/latest/Lua_Nginx_API/">Lua-Ngx-API</a></li>
<li><a href="https://github.com/openresty/stream-lua-nginx-module">stream-lua-nginxæºç </a></li>
<li><a href="https://www.lua.org/manual/5.1/manual.html">lua-5.1-manual</a></li>
<li><a href="https://www.codedump.info/post/20190501-lua-stream/">lua streamå®ç°åˆ†æ</a></li>
</ul>
]]></content>
      <categories>
        <category>ç¼–ç¨‹å¼€å‘</category>
        <category>Nginx/OpenResty</category>
      </categories>
      <tags>
        <tag>Lua</tag>
        <tag>OpenResty</tag>
        <tag>Nginx</tag>
        <tag>åç¨‹</tag>
      </tags>
  </entry>
  <entry>
    <title>Nginxçš„å…±äº«å†…å­˜ç®¡ç†--slabç®—æ³•</title>
    <url>/posts/2dc32e47/</url>
    <content><![CDATA[<div class="note primary">
            <p>åˆæ¬¡äº†è§£åˆ°slabç®—æ³•ï¼Œæ˜¯åœ¨å­¦ä¹ Linuxå†…æ ¸æ—¶ã€‚å†…æ ¸ä¸­é‡‡ç”¨äº†ä¼™ä¼´ç³»ç»Ÿï¼ˆBuddy Systemï¼‰ç®—æ³•å¯¹å†…å­˜é¡µé¢è¿›è¡Œç®¡ç†ã€‚ä½†æ˜¯å¯¹äºå°å¯¹è±¡ï¼Œè¿˜ç”¨é¡µé¢åˆ†é…å™¨å°±æ˜¾å¾—æœ‰äº›æµªè´¹äº†ï¼Œäºæ˜¯slabå°±åº”è¿è€Œç”Ÿäº†ï¼Œå†…æ ¸çš„kmalloc()å°±æ˜¯ä½¿ç”¨slabè¿›è¡Œç®¡ç†çš„ã€‚nginxä¸­çš„å…±äº«å†…å­˜ç®¡ç†ä½¿ç”¨äº†ç›¸åŒçš„æ€æƒ³ï¼Œå½“ç„¶å®ƒæ²¡æœ‰Linuxå†…æ ¸ä¸­çš„slabé‚£ä¹ˆå¤æ‚ã€‚</p>
          </div>

<span id="more"></span>

<h2 id="slabåŸç†"><a href="#slabåŸç†" class="headerlink" title="slabåŸç†"></a>slabåŸç†</h2><p>å®ƒçš„åŸºæœ¬å·¥ä½œåŸç†å¦‚ä¸‹ï¼š</p>
<ol>
<li>é¦–å…ˆå¯¹å…±äº«å†…å­˜è¿›è¡Œåˆå§‹åŒ–ï¼Œæœ€å‰é¢ä¸€éƒ¨åˆ†æ˜¯ç”¨äºç®¡ç†çš„å…ƒæ•°æ®ï¼Œå‰©ä½™éƒ¨åˆ†æŒ‰é¡µè¿›è¡Œåˆ’åˆ†ã€‚æ¯ä¸ªé¡µåœ¨å‰é¢å…ƒæ•°æ®ä¸­éƒ½æœ‰ä¸€ä¸ªå¯¹åº”çš„é¡µå¤´ï¼Œç”¨äºç®¡ç†è¯¥é¡µ</li>
<li>å…ƒæ•°æ®ä¸­æœ‰ä¸€ä¸ªç©ºé—²é¡µå—é“¾è¡¨ï¼Œç®¡ç†ç€æ‰€æœ‰ç©ºé—²çš„é¡µå—ï¼ˆåˆå§‹æ˜¯ä¸€ä¸ªå®Œæ•´çš„è¿ç»­é¡µå—ï¼‰</li>
<li>åˆ†é…å¯¹è±¡æ—¶å°†é•¿åº¦æŒ‰2çš„æ¬¡å¹‚è¿›è¡Œå¯¹é½ï¼Œnginxä¸­ç§°å…¶ä¸ºä¸åŒçš„slot</li>
<li>ä¸€ä¸ªé¡µé¢è¢«åˆ†é…ç»™æŸä¸ªslotï¼Œå°±åªç”¨äºè¿™ç§é•¿åº¦å¯¹è±¡çš„åˆ†é…ï¼Œä¾‹å¦‚ä¸€ä¸ª4KBé¡µé¢ï¼Œå¯ä»¥åˆ‡åˆ†æˆ64ä¸ª64Bçš„å¯¹è±¡ï¼Œæˆ–è€…32ä¸ª128Bçš„å¯¹è±¡ã€‚</li>
<li>æ¯ç§slotçš„å¯¹è±¡éƒ½æœ‰ä¸€ä¸ªæœªæ»¡é¡µé“¾è¡¨ï¼Œç®¡ç†ç€è¯¥slotæ‰€æœ‰æœªæ»¡ä¸”æœªç©ºçš„é¡µã€‚</li>
<li>slotçš„å¯¹è±¡æ˜¯é€šè¿‡bitmapè¿›è¡Œç®¡ç†çš„ï¼Œä¸€ä¸ªå¯¹è±¡è¢«åˆ†é…äº†å°±å°†å¯¹åº”ä½ç½®1ï¼Œé‡Šæ”¾äº†ç½®0ï¼Œç”±æ­¤åˆ¤æ–­é¡µé¢ä¸­å“ªäº›å†…å­˜å—æ˜¯ç©ºé—²çš„</li>
<li>å¦‚æœæŸä¸ªé¡µæ»¡äº†ï¼Œé‚£ä¹ˆå°±ä»æœªæ»¡é¡µé“¾è¡¨ä¸­ç§»é™¤ï¼›å¦‚æœä¸€ä¸ªé¡µä»æ»¡é¡µå˜ä¸ºæœªæ»¡ï¼ˆå³æ»¡é¡µé‡Šæ”¾äº†ä¸€ä¸ªå¯¹è±¡ï¼‰ï¼Œåˆ™é‡æ–°æŒ‚åˆ°æœªæ»¡é¡µé“¾è¡¨ä¸­</li>
<li>å¦‚æœåˆ†é…æŸslotå¯¹è±¡æ—¶ï¼Œå‘ç°æœªæ»¡é¡µé“¾è¡¨ç©ºäº†ï¼Œé‚£ä¹ˆå°±ä»ç©ºé—²é¡µå—é“¾è¡¨ä¸­åˆ†é…ä¸€ä¸ªç©ºé—²é¡µï¼Œåˆ†é…å¯¹è±¡ä¹‹åæ’å…¥è¯¥slotçš„æœªæ»¡é¡µé“¾è¡¨ä¸­ï¼›å¦‚æœé‡Šæ”¾å¯¹è±¡ä¹‹åï¼Œè¿™ä¸ªé¡µç©ºäº†ï¼Œåˆ™è¿˜ç»™ç©ºé—²é¡µå—é“¾è¡¨</li>
<li>åˆ†é…å’Œé‡Šæ”¾é¡µé¢æ—¶ï¼Œç©ºé—²é¡µå—é“¾è¡¨æœ‰åˆ‡åˆ†å’Œåˆå¹¶æ“ä½œ</li>
<li>å¤§å¯¹è±¡ï¼ˆè¶…è¿‡åŠé¡µï¼‰ç›´æ¥ä»ç©ºé—²é¡µå—é“¾è¡¨ä¸­åˆ†é…ï¼Œä¸èµ°slot</li>
</ol>
<p><img src="https://cdn.jsdelivr.net/gh/catbro666/catbro666.github.io/posts/2dc32e47/nginx-slab-mechanism.svg" alt="nginx-slab-mechanism" loading="lazy"></p>
<p>å€¼å¾—ä¸€æçš„æ˜¯ï¼Œslotæ ¹æ®å¯¹è±¡çš„å°ºå¯¸å¤§å°åˆ†æˆ3ç±»ï¼Œå¯¹äºå¤§å°ºå¯¸å¯¹è±¡å› ä¸ºä¸€ä¸ªé¡µå¯ä»¥åˆ†æˆçš„å†…å­˜å—æ•°è¾ƒå°‘ï¼Œç›´æ¥ç”¨é¡µé¢å¤´ä¸­çš„slabå­—æ®µä½œä¸ºbitmapå°±å¤Ÿäº†ã€‚è€Œå¯¹äºå°å°ºå¯¸å¯¹è±¡ï¼Œå› ä¸ºåˆ‡åˆ†çš„å—æ•°å¾ˆå¤šï¼Œæ‰€ä»¥éœ€è¦ä½¿ç”¨å®é™…çš„å†…å­˜é¡µé¢ä¸­å‰é¢çš„å‡ ä¸ªå—ä½œä¸ºbitmapã€‚</p>
<h2 id="ä¸»è¦æ•°æ®ç»“æ„"><a href="#ä¸»è¦æ•°æ®ç»“æ„" class="headerlink" title="ä¸»è¦æ•°æ®ç»“æ„"></a>ä¸»è¦æ•°æ®ç»“æ„</h2><div class="note default no-icon">
            <p>æ³¨ï¼šåé¢çš„ä»£ç éƒ½æ˜¯åŸºäºNginx-1.19.3</p>
          </div>

<p>ä¸‹å›¾ç»™å‡ºäº†å‡ ä¸ªä¸»è¦ç»“æ„ä½“ä¹‹é—´çš„å…³ç³»ï¼Œä»¥åŠå‡ ä¸ªä¸»è¦çš„æŒ‡é’ˆæŒ‡å‘çš„å…±äº«å†…å­˜çš„ä½ç½®ã€‚ä»addråˆ°lastæ˜¯ç”¨äºç®¡ç†çš„å…ƒæ•°æ®ï¼Œä»startåˆ°endåˆ™å®é™…ç”¨äºåˆ†é…çš„å†…å­˜ã€‚slotså’Œstatsåˆ†åˆ«æ˜¯å„ä¸ªslotçš„åŠæ»¡é“¾è¡¨å¤´å’Œç»Ÿè®¡ä¿¡æ¯ã€‚pagesæ˜¯é¡µé¢å¤´æ•°ç»„ï¼Œè·Ÿåé¢å®é™…åˆ†é…çš„å†…å­˜é¡µé¢ä¸€ä¸€å¯¹åº”ã€‚é€šè¿‡é¡µé¢å¤´å¯ä»¥æ‰¾åˆ°å¯¹åº”é¡µï¼Œé€šè¿‡é¡µé¢åœ°å€ä¹Ÿå¯ä»¥æ‰¾åˆ°å®ƒçš„é¡µé¢å¤´ï¼Œè¿ç»­çš„é¡µå—å…¶é¡µé¢å¤´ä¹Ÿæ˜¯è¿ç»­çš„ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/catbro666/catbro666.github.io/posts/2dc32e47/nginx-slab-structures.svg" alt="nginx-slab-structures" loading="lazy"></p>
<p><code>ngx_shm_zone_t</code>æ˜¯ç”¨äºæè¿°å…±äº«å†…å­˜çš„ç»“æ„ä½“ï¼Œdataæ˜¯ç§æœ‰æ•°æ®æŒ‡é’ˆï¼Œinitæ˜¯ç§æœ‰çš„åˆå§‹åŒ–å‡½æ•°ï¼Œtagç”¨äºåŒºåˆ«ä¸åŒçš„å…±äº«å†…å­˜ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ngx_shm_zone_tæ˜¯å…±äº«å†…å­˜çš„ç»“æ„ä½“ï¼Œé‡Œé¢åŒ…å«äº†shmï¼Œdataæ˜¯ç§æœ‰æ•°æ®</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ngx_shm_zone_s</span> &#123;</span></span><br><span class="line">    <span class="keyword">void</span>                     *data;</span><br><span class="line">    <span class="keyword">ngx_shm_t</span>                 shm;</span><br><span class="line">    ngx_shm_zone_init_pt      init;</span><br><span class="line">    <span class="keyword">void</span>                     *tag;</span><br><span class="line">    <span class="keyword">void</span>                     *sync;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>                noreuse;  <span class="comment">/* unsigned  noreuse:1; */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­çš„shmè®°å½•äº†å…±äº«å†…å­˜çš„å…·ä½“ä¿¡æ¯ï¼Œaddræ˜¯å…±äº«å†…å­˜èµ·å§‹åœ°å€ï¼Œsizeæ˜¯å¤§å°ï¼Œnameåå­—ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// shmé‡Œçš„addræŒ‡å‘å®é™…mmapçš„å…±äº«å†…å­˜</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    u_char      *addr;</span><br><span class="line">    <span class="keyword">size_t</span>       size;</span><br><span class="line">    <span class="keyword">ngx_str_t</span>    name;</span><br><span class="line">    <span class="keyword">ngx_log_t</span>   *<span class="built_in">log</span>;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>   exists;   <span class="comment">/* unsigned  exists:1;  */</span></span><br><span class="line">&#125; <span class="keyword">ngx_shm_t</span>;</span><br></pre></td></tr></table></figure>

<p><code>ngx_slab_pool_t</code>ç”¨äºç®¡ç†slabï¼Œå®ƒä½äºå…±äº«å†…å­˜çš„æœ€å¼€å¤´ã€‚min_size&#x2F;min_shiftè®°å½•äº†æœ€å°çš„slotçš„å°ºå¯¸åŠå¯¹åº”ä½åç§»ï¼Œfreeæ˜¯å‰é¢å·²ç»æåˆ°çš„ç©ºé—²é¡µå—é“¾è¡¨å¤´ã€‚pages&#x2F;last&#x2F;stats&#x2F;start&#x2F;end&#x2F;data&#x2F;addréƒ½æ˜¯æŒ‡é’ˆï¼ŒæŒ‡å‘å…±äº«å†…å­˜çš„ä¸åŒä½ç½®ï¼Œå…·ä½“å‚çœ‹ä¸‹å›¾ã€‚lockå’Œmutexç”¨äºä¿æŠ¤å…±äº«å†…å­˜ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// å…±äº«å†…å­˜æœ€å¼€å¤´æ˜¯ngx_slab_pool_tï¼Œå®ƒç”¨äºç®¡ç†slabï¼Œåé¢ä¼šè¯¦ç»†ä»‹ç»å®ƒçš„å­—æ®µ</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="keyword">ngx_shmtx_sh_t</span>    lock;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span>            min_size;     <span class="comment">// åˆ†é…å†…å­˜æœ€å°å°ºå¯¸ï¼Œ8</span></span><br><span class="line">    <span class="keyword">size_t</span>            min_shift;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">ngx_slab_page_t</span>  *pages;        <span class="comment">// æŒ‡å‘é¡µé¢å¤´æ•°ç»„</span></span><br><span class="line">    <span class="keyword">ngx_slab_page_t</span>  *last;         <span class="comment">// æŒ‡å‘é¡µé¢å¤´æ•°ç»„æœ«å°¾</span></span><br><span class="line">    <span class="keyword">ngx_slab_page_t</span>   <span class="built_in">free</span>;         <span class="comment">// ç©ºé—²é¡µé¢é“¾è¡¨å¤´</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">ngx_slab_stat_t</span>  *stats;        <span class="comment">// æŒ‡å‘ç»Ÿè®¡æ•°ç»„</span></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>        pfree;        <span class="comment">// æ€»ç©ºé—²é¡µé¢æ•°</span></span><br><span class="line"></span><br><span class="line">    u_char           *start;        <span class="comment">// å®é™…æ•°æ®é¡µé¢èµ·å§‹ä½ç½®</span></span><br><span class="line">    u_char           *end;          <span class="comment">// å…±äº«å†…å­˜ç»“æŸä½ç½®</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">ngx_shmtx_t</span>       mutex;</span><br><span class="line"></span><br><span class="line">    u_char           *log_ctx;</span><br><span class="line">    u_char            zero;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span>          log_nomem:<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span>             *data;         <span class="comment">// ç§æœ‰æ•°æ®</span></span><br><span class="line">    <span class="keyword">void</span>             *addr;</span><br><span class="line">&#125; <span class="keyword">ngx_slab_pool_t</span>;</span><br></pre></td></tr></table></figure>

<p><code>ngx_slab_page_s</code>ç”¨äºç®¡ç†é¡µé¢ï¼Œå°±æ˜¯æˆ‘ä»¬å‰é¢æ‰€è¯´çš„é¡µé¢å¤´ï¼Œå®ƒæ—¢ä½œä¸ºé“¾è¡¨èŠ‚ç‚¹ï¼Œåˆè®°å½•ä¸€äº›é¡µé¢çš„ä¿¡æ¯ã€‚slabå­—æ®µåœ¨ä¸åŒæƒ…å†µä¸‹ç”¨é€”ä¹Ÿä¸åŒï¼Œprevé™¤äº†ä½œä¸ºé“¾è¡¨æŒ‡é’ˆï¼Œä½ä½è¿˜ç”¨äºè¡¨ç¤ºé¡µé¢ç±»å‹ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// é¡µé¢å¤´ï¼Œç”¨äºç®¡ç†é¡µé¢</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ngx_slab_page_s</span> &#123;</span></span><br><span class="line">    <span class="keyword">uintptr_t</span>         slab;         <span class="comment">// å¯¹äºç©ºé—²é¡µé¢å¤´èŠ‚ç‚¹ï¼Œè¡¨ç¤ºå½“å‰èŠ‚ç‚¹é¡µå—å¤§å°ï¼›ç©ºé—²é¡µé¢éå¤´èŠ‚ç‚¹ï¼Œä¸ºFREEï¼›å¯¹äºå·²åˆ†é…é¡µå—ï¼Œç¬¬ä¸€ä¸ªé¡µæ˜¯pages | NGX_SLAB_PAGE_STARTï¼Œå…¶ä½™æ˜¯NGX_SLAB_PAGE_BUSYï¼›å¯¹äºslabé¡µé¢ï¼Œå°å¯¹è±¡slabè®°å½•shiftå€¼ï¼Œä¸­å¯¹è±¡slabç”¨ä½œbitmapï¼Œå¤§å¯¹è±¡slabé«˜ä½ç”¨ä½œbitmapï¼Œä½ä½è®°å½•shiftå€¼</span></span><br><span class="line">    <span class="keyword">ngx_slab_page_t</span>  *next;         <span class="comment">// ä¸åœ¨é“¾è¡¨ä¸­æ—¶ï¼Œä¸ºNULL</span></span><br><span class="line">    <span class="keyword">uintptr_t</span>         prev;         <span class="comment">// å¯¹äºå·²ç»åˆ†é…çš„é¡µï¼Œä½ä½è¿˜å…¼èŒè¡¨ç¤ºé¡µç±»å‹</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><code>ngx_slab_stat_t</code>ç”¨äºç»Ÿè®¡slotçš„ä¿¡æ¯</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// ç”¨äºç»Ÿè®¡slotä¿¡æ¯</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>        total;  <span class="comment">// æ€»å…±æœ‰å¤šå°‘ä¸ªå¯¹è±¡</span></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>        used;   <span class="comment">// ç›®å‰ä½¿ç”¨äº†å¤šå°‘ä¸ª</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>        reqs;   <span class="comment">// è¯·æ±‚è¯¥slotæ¬¡æ•°ï¼Œç´¯åŠ è®¡æ•°å™¨</span></span><br><span class="line">    <span class="keyword">ngx_uint_t</span>        fails;  <span class="comment">// è¯·æ±‚å¤±è´¥çš„æ¬¡æ•°ï¼Œç´¯åŠ è®¡æ•°å™¨</span></span><br><span class="line">&#125; <span class="keyword">ngx_slab_stat_t</span>;</span><br></pre></td></tr></table></figure>



<h2 id="åˆå§‹åŒ–æµç¨‹"><a href="#åˆå§‹åŒ–æµç¨‹" class="headerlink" title="åˆå§‹åŒ–æµç¨‹"></a>åˆå§‹åŒ–æµç¨‹</h2><h3 id="é¦–æ¬¡å¯åŠ¨"><a href="#é¦–æ¬¡å¯åŠ¨" class="headerlink" title="é¦–æ¬¡å¯åŠ¨"></a>é¦–æ¬¡å¯åŠ¨</h3><p>å…±äº«åˆå§‹åŒ–çš„ä¸»è¦å‡½æ•°è°ƒç”¨å…³ç³»å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">ngx_shared_memory_add()		<span class="comment">// åˆå§‹åŒ–ngx_shm_zone_tï¼Œå¹¶æ”¾åˆ°å…¨å±€é“¾è¡¨cf-&gt;cycle-&gt;shared_memoryä¸­</span></span><br><span class="line">ngx_init_cycle()</span><br><span class="line">  ngx_shm_alloc(&amp;shm_zone[i].shm)      <span class="comment">// åˆ†é…å†…å­˜</span></span><br><span class="line">  ngx_init_zone_pool(cycle, &amp;shm_zone[i])     <span class="comment">// slabåˆå§‹åŒ–</span></span><br><span class="line">    ngx_slab_init()</span><br><span class="line">  shm_zone[i].init(&amp;shm_zone[i], oshm_zone[n].data) <span class="comment">// å„å…±äº«å†…å­˜ç§æœ‰çš„åˆå§‹åŒ–å‡½æ•°ï¼Œä¾‹å¦‚ngx_ssl_session_cache_initï¼Œä¸»è¦è´Ÿè´£åˆå§‹åŒ–ngx_ssl_session_cache_t</span></span><br></pre></td></tr></table></figure>

<ul>
<li>åœ¨é…ç½®å¤„ç†é˜¶æ®µï¼Œå°†shm_zoneåŠ åˆ°é“¾è¡¨ä¸­</li>
<li>ç„¶ååœ¨init_cycleä¸­åˆ†é…å…±äº«å†…å­˜ï¼Œåˆå§‹åŒ–shm_zone</li>
<li>ngx_slab_init()ä¸»è¦åˆå§‹åŒ–ngx_slab_pool_tç»“æ„ä½“</li>
<li>å®Œæˆé€šç”¨çš„åˆå§‹åŒ–ä¹‹åï¼Œè¿›è¡Œå„å…±äº«å†…å­˜ç§æœ‰çš„åˆå§‹åŒ–æ“ä½œ</li>
</ul>
<p>ngx_slab_init()æ˜¯æ‰€æœ‰å…±äº«å†…å­˜å…±åŒçš„åˆå§‹åŒ–æ“ä½œï¼Œä¸»è¦æ˜¯åˆå§‹åŒ–ngx_slab_pool_tç»“æ„ä½“ä¸­çš„å„ä¸ªå­—æ®µã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span></span></span><br><span class="line"><span class="function"><span class="title">ngx_slab_init</span><span class="params">(<span class="keyword">ngx_slab_pool_t</span> *pool)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    u_char           *p;</span><br><span class="line">    <span class="keyword">size_t</span>            size;</span><br><span class="line">    <span class="keyword">ngx_int_t</span>         m;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>        i, n, pages;</span><br><span class="line">    <span class="keyword">ngx_slab_page_t</span>  *slots, *page;</span><br><span class="line"></span><br><span class="line">    pool-&gt;min_size = (<span class="keyword">size_t</span>) <span class="number">1</span> &lt;&lt; pool-&gt;min_shift;</span><br><span class="line"></span><br><span class="line">    slots = ngx_slab_slots(pool);</span><br><span class="line"></span><br><span class="line">    p = (u_char *) slots;</span><br><span class="line">    size = pool-&gt;end - p;</span><br><span class="line"></span><br><span class="line">    ngx_slab_junk(p, size);</span><br><span class="line"></span><br><span class="line">    n = ngx_pagesize_shift - pool-&gt;min_shift;  <span class="comment">// slotçš„ç§ç±»</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">        <span class="comment">/* only &quot;next&quot; is used in list head */</span></span><br><span class="line">        slots[i].slab = <span class="number">0</span>;</span><br><span class="line">        slots[i].next = &amp;slots[i];</span><br><span class="line">        slots[i].prev = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    p += n * <span class="keyword">sizeof</span>(<span class="keyword">ngx_slab_page_t</span>);</span><br><span class="line"></span><br><span class="line">    pool-&gt;stats = (<span class="keyword">ngx_slab_stat_t</span> *) p;</span><br><span class="line">    ngx_memzero(pool-&gt;stats, n * <span class="keyword">sizeof</span>(<span class="keyword">ngx_slab_stat_t</span>));</span><br><span class="line"></span><br><span class="line">    p += n * <span class="keyword">sizeof</span>(<span class="keyword">ngx_slab_stat_t</span>);</span><br><span class="line"></span><br><span class="line">    size -= n * (<span class="keyword">sizeof</span>(<span class="keyword">ngx_slab_page_t</span>) + <span class="keyword">sizeof</span>(<span class="keyword">ngx_slab_stat_t</span>));</span><br><span class="line"></span><br><span class="line">    pages = (<span class="keyword">ngx_uint_t</span>) (size / (ngx_pagesize + <span class="keyword">sizeof</span>(<span class="keyword">ngx_slab_page_t</span>)));               <span class="comment">// è®¡ç®—é¡µæ•°</span></span><br><span class="line"></span><br><span class="line">    pool-&gt;pages = (<span class="keyword">ngx_slab_page_t</span> *) p; <span class="comment">// æŒ‡å‘é¡µé¢å¤´æ•°ç»„</span></span><br><span class="line">    ngx_memzero(pool-&gt;pages, pages * <span class="keyword">sizeof</span>(<span class="keyword">ngx_slab_page_t</span>));</span><br><span class="line"></span><br><span class="line">    page = pool-&gt;pages;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* only &quot;next&quot; is used in list head */</span></span><br><span class="line">    pool-&gt;<span class="built_in">free</span>.slab = <span class="number">0</span>;</span><br><span class="line">    pool-&gt;<span class="built_in">free</span>.next = page;</span><br><span class="line">    pool-&gt;<span class="built_in">free</span>.prev = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// åˆå§‹åªæœ‰ä¸€ä¸ªå¤§çš„å—</span></span><br><span class="line">    page-&gt;slab = pages;                  <span class="comment">// é¡µå—çš„é¡µæ•°</span></span><br><span class="line">    page-&gt;next = &amp;pool-&gt;<span class="built_in">free</span>;            <span class="comment">// æŒ‡å‘ç©ºé—²é“¾è¡¨çš„å“¨å…µ</span></span><br><span class="line">    page-&gt;prev = (<span class="keyword">uintptr_t</span>) &amp;pool-&gt;<span class="built_in">free</span>;<span class="comment">// æŒ‡å‘ç©ºé—²é“¾è¡¨çš„å“¨å…µ</span></span><br><span class="line"></span><br><span class="line">    pool-&gt;start = ngx_align_ptr(p + pages * <span class="keyword">sizeof</span>(<span class="keyword">ngx_slab_page_t</span>),</span><br><span class="line">                                ngx_pagesize);  <span class="comment">// å®é™…æ•°æ®é¡µé¢å¼€å§‹ä½ç½®</span></span><br><span class="line"></span><br><span class="line">    m = pages - (pool-&gt;end - pool-&gt;start) / ngx_pagesize;</span><br><span class="line">    <span class="keyword">if</span> (m &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        pages -= m;</span><br><span class="line">        page-&gt;slab = pages;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    pool-&gt;last = pool-&gt;pages + pages;      <span class="comment">// é¡µé¢å¤´æ•°ç»„çš„æœ«å°¾</span></span><br><span class="line">    pool-&gt;pfree = pages;                   <span class="comment">// æ€»ç©ºé—²é¡µé¢æ•°</span></span><br><span class="line"></span><br><span class="line">    pool-&gt;log_nomem = <span class="number">1</span>;</span><br><span class="line">    pool-&gt;log_ctx = &amp;pool-&gt;zero;</span><br><span class="line">    pool-&gt;zero = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥<code>shm_zone[i].init()</code>æ˜¯å„å…±äº«å†…å­˜ç§æœ‰çš„åˆå§‹åŒ–ï¼Œä¸€èˆ¬ä¼šåˆå§‹åŒ–ç§æœ‰æ•°æ®ï¼Œç„¶åå°†æŒ‡é’ˆèµ‹å€¼åˆ°<code>ngx_shm_zone_t</code>å’Œ<code>ngx_slab_pool_t</code>çš„ç§æœ‰æ•°æ®<code>data</code>å­—æ®µã€‚</p>
<h3 id="reload"><a href="#reload" class="headerlink" title="reload"></a>reload</h3><p>reloadçš„æ—¶å€™é»˜è®¤æ˜¯é‡ç”¨ä¹‹å‰çš„å…±äº«å†…å­˜çš„ï¼Œé™¤é<code>ngx_shm_zone_s</code>ä¸­çš„<code>noreuse</code>ç½®1äº†ï¼Œä½†æ˜¯è¿™ä¸ªå­—æ®µç›®å‰æ˜¯ä»£ç å†™æ­»çš„ï¼Œå¹¶æ²¡æœ‰ä½œä¸ºé…ç½®å¼€æ”¾ã€‚æ‰€ä»¥reloadæ—¶ä¸€èˆ¬åªæ˜¯æ‰§è¡Œå¦‚ä¸‹å‡½æ•°ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">ngx_shared_memory_add()</span><br><span class="line">shm_zone[i].init(&amp;shm_zone[i], oshm_zone[n].data)</span><br></pre></td></tr></table></figure>

<p>ä¸è¿‡æœ‰ä¸€ç§æƒ…å†µä¸‹ï¼Œreloadä¹Ÿä¼šé‡æ–°ç”Ÿæˆå…±äº«å†…å­˜ï¼Œé‚£å°±æ˜¯å¤§å°æ”¹å˜äº†çš„æ—¶å€™ã€‚</p>
<h2 id="åˆ†é…é€»è¾‘"><a href="#åˆ†é…é€»è¾‘" class="headerlink" title="åˆ†é…é€»è¾‘"></a>åˆ†é…é€»è¾‘</h2><p>åˆ†é…é€»è¾‘å’Œé‡Šæ”¾é€»è¾‘æ˜¯slabçš„æ ¸å¿ƒï¼Œæƒ³å®Œå…¨ç†è§£éœ€è¦ä»”ç»†é˜…è¯»æ¥ä¸‹æ¥4ä¸ªå‡½æ•°ã€‚</p>
<h3 id="åˆ†é…é¡µé¢"><a href="#åˆ†é…é¡µé¢" class="headerlink" title="åˆ†é…é¡µé¢"></a>åˆ†é…é¡µé¢</h3><p>é¡µé¢åˆ†é…é€»è¾‘æ¯”è¾ƒç®€å•ï¼Œå‰©ä½™çš„ç©ºé—²é¡µå—æ˜¯ä¸€ä¸ªé“¾è¡¨ï¼Œ<code>pool-&gt;free</code>æ˜¯å¤´èŠ‚ç‚¹ï¼Œç”¨ä½œå“¨å…µã€‚éå†é“¾è¡¨å¯»æ‰¾è¶³å¤Ÿå¤§çš„ç©ºé—²é¡µå—ï¼Œå¦‚æœé¡µå—æ­£å¥½ç­‰äºè¯·æ±‚çš„å¤§å°ï¼Œé‚£ä¹ˆå°†å…¶ä»é“¾è¡¨ä¸­ç§»é™¤ï¼Œå¦‚æœé¡µå—è¿˜æœ‰å‰©ä½™ï¼Œå°†å‰©ä½™éƒ¨åˆ†çš„ç¬¬ä¸€ä¸ªé¡µé¢å¤´æ’å…¥é“¾è¡¨ä¸­ï¼Œå¦‚æœå‰©ä½™å—å¤§äº1é¡µï¼Œé‚£ä¹ˆå°†æœ€åä¸€é¡µçš„é¡µé¢å¤´çš„prevæŒ‡å‘å…¶ç¬¬ä¸€ä¸ªé¡µé¢å¤´çš„ä½ç½®ï¼ˆåˆå¹¶é¡µå—æ—¶éœ€è¦ç”¨åˆ°ï¼‰ã€‚</p>
<p>å¯¹äºåˆ†é…çš„é¡µå—ï¼Œç¬¬ä¸€ä¸ªé¡µé¢å¤´è®°å½•é¡µå—å¤´æ ‡å¿—ï¼Œå¹¶è®°å½•äº†é¡µå—å¤§å°ï¼Œåé¢çš„é¡µé¢å¤´è®°å½•BUSYæ ‡å¿—ã€‚prevçš„æœ€åä¸¤ä½è¡¨ç¤ºé¡µç±»å‹ï¼Œ<code>NGX_SLAB_PAGE</code>è¡¨ç¤ºæ˜¯æ•´é¡µåˆ†é…ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">ngx_slab_page_t</span> *</span></span><br><span class="line"><span class="function"><span class="title">ngx_slab_alloc_pages</span><span class="params">(<span class="keyword">ngx_slab_pool_t</span> *pool, <span class="keyword">ngx_uint_t</span> pages)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">ngx_slab_page_t</span>  *page, *p;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (page = pool-&gt;<span class="built_in">free</span>.next; page != &amp;pool-&gt;<span class="built_in">free</span>; page = page-&gt;next) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (page-&gt;slab &gt;= pages) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (page-&gt;slab &gt; pages) &#123;   <span class="comment">// æœ‰å‰©ä½™çš„æƒ…å†µ</span></span><br><span class="line">                page[page-&gt;slab - <span class="number">1</span>].prev = (<span class="keyword">uintptr_t</span>) &amp;page[pages];  <span class="comment">// è¿™ä¸€æ­¥æ˜¯åˆå¹¶æ—¶å€™ç”¨çš„ï¼Œæ‰¾åˆ°å®ƒçš„å—å¤´</span></span><br><span class="line">                <span class="comment">// å‰©ä½™éƒ¨åˆ†ä»ç„¶æ’å…¥é“¾è¡¨ä¸­</span></span><br><span class="line">                page[pages].slab = page-&gt;slab - pages;</span><br><span class="line">                page[pages].next = page-&gt;next;</span><br><span class="line">                page[pages].prev = page-&gt;prev;</span><br><span class="line"></span><br><span class="line">                p = (<span class="keyword">ngx_slab_page_t</span> *) page-&gt;prev;</span><br><span class="line">                p-&gt;next = &amp;page[pages];</span><br><span class="line">                page-&gt;next-&gt;prev = (<span class="keyword">uintptr_t</span>) &amp;page[pages];</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;                     <span class="comment">// æ­£å¥½çš„æƒ…å†µ</span></span><br><span class="line">                p = (<span class="keyword">ngx_slab_page_t</span> *) page-&gt;prev;  <span class="comment">// å°†èŠ‚ç‚¹ä»é“¾è¡¨ç§»é™¤</span></span><br><span class="line">                p-&gt;next = page-&gt;next;</span><br><span class="line">                page-&gt;next-&gt;prev = page-&gt;prev;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// ç¬¬ä¸€ä¸ªé¡µè®°å½•é¡µæ•°</span></span><br><span class="line">            page-&gt;slab = pages | NGX_SLAB_PAGE_START;</span><br><span class="line">            page-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line">            page-&gt;prev = NGX_SLAB_PAGE;</span><br><span class="line"></span><br><span class="line">            pool-&gt;pfree -= pages;  <span class="comment">// æ›´æ–°å‰©ä½™ç©ºé—²é¡µæ•°</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (--pages == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> page;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// å…¶ä½™é¡µè®¾ä¸ºBUSY</span></span><br><span class="line">            <span class="keyword">for</span> (p = page + <span class="number">1</span>; pages; pages--) &#123;</span><br><span class="line">                p-&gt;slab = NGX_SLAB_PAGE_BUSY;</span><br><span class="line">                p-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line">                p-&gt;prev = NGX_SLAB_PAGE;</span><br><span class="line">                p++;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> page;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pool-&gt;log_nomem) &#123;</span><br><span class="line">        ngx_slab_error(pool, NGX_LOG_CRIT,</span><br><span class="line">                       <span class="string">&quot;ngx_slab_alloc() failed: no memory&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="åˆ†é…å¯¹è±¡"><a href="#åˆ†é…å¯¹è±¡" class="headerlink" title="åˆ†é…å¯¹è±¡"></a>åˆ†é…å¯¹è±¡</h3><p>å°å¯¹è±¡æ ¹æ®å°ºå¯¸å¤§å°ï¼Œåˆ†æˆäº†3ç±»ï¼Œå³ä»£ç ä¸­çš„<code>NGX_SLAB_BIG</code>ã€<code>NGX_SLAB_EXACT</code>å’Œ<code>NGX_SLAB_SMALL</code>ã€‚ä¹‹æ‰€ä»¥è¦åˆ†æˆä¸‰ç±»ï¼Œæ˜¯ä¸ºäº†èŠ‚çœç®¡ç†çš„å†…å­˜å¼€é”€ã€‚å…¶ä¸­exactçš„è¡¨ç¤ºé¡µé¢å¤´ä¸­çš„slabå­—æ®µæ­£å¥½å¯ä»¥ç”¨ä½œä¸€ä¸ªé¡µé¢çš„bitmapã€‚smallçš„å°±éœ€è¦ä½¿ç”¨é¡µé¢æœ€å‰é¢çš„å†…å­˜å—æ¥ä½œä¸ºbitampäº†ï¼Œæ­¤æ—¶slabç”¨äºè®°å½•è¯¥é¡µçš„shiftå€¼ï¼ˆå³å®ƒå±äºå“ªä¸ªslotï¼‰ã€‚è€Œå¯¹äºbigçš„ï¼Œå› ä¸ºå†…å­˜å—æ•°è¾ƒå°‘ï¼Œslabå­—æ®µé«˜ä½ç”¨ä½œbitmapï¼Œä½ä½åˆ™è®°å½•shiftå€¼ã€‚</p>
<p>å¯¹äºè¶…å¤§å¯¹è±¡ç›´æ¥åˆ†é…é¡µï¼Œå¦åˆ™éå†å¯¹åº”çš„slotåŠæ»¡é“¾è¡¨ä¸­è·å–ä¸€ä¸ªç©ºé—²å†…å­˜å—ï¼Œæ‰¾åˆ°åå°†ç›¸åº”çš„bitä½ç½®ä½ï¼Œå¦‚æœé“¾è¡¨ä¸ºç©ºåˆ™å…ˆåˆ†é…ä¸€ä¸ªæ–°é¡µï¼Œç„¶åæ’å…¥slotåŠæ»¡é“¾è¡¨ä¸­ã€‚å¦‚æœåˆ†é…ä¸€ä¸ªå¯¹è±¡åé¡µé¢æ»¡äº†ï¼Œåˆ™å°†å…¶ä»åŠæ»¡é“¾è¡¨ä¸­ç§»é™¤ã€‚</p>
<p><code>ngx_slab_alloc_locked</code>æ˜¯æœ€æ ¸å¿ƒçš„ä¸€ä¸ªå‡½æ•°äº†ï¼Œæœ‰å…´è¶£çš„å¯ä»¥çœ‹çœ‹å®ƒæ˜¯æ€ä¹ˆæ“ä½œbitmapå’Œé“¾è¡¨çš„ã€‚ä»£ç ä¸­åŸºæœ¬éƒ½åšäº†æ³¨é‡Šï¼Œè¿™é‡Œå°±ä¸å†èµ˜è¿°äº†ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> *</span></span><br><span class="line"><span class="function"><span class="title">ngx_slab_alloc_locked</span><span class="params">(<span class="keyword">ngx_slab_pool_t</span> *pool, <span class="keyword">size_t</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">size_t</span>            s;</span><br><span class="line">    <span class="keyword">uintptr_t</span>         p, m, mask, *bitmap;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>        i, n, slot, shift, <span class="built_in">map</span>;</span><br><span class="line">    <span class="keyword">ngx_slab_page_t</span>  *page, *prev, *slots;</span><br><span class="line">    <span class="comment">// è¶…å¤§å¯¹è±¡ç›´æ¥åˆ†é…é¡µ</span></span><br><span class="line">    <span class="keyword">if</span> (size &gt; ngx_slab_max_size) &#123;</span><br><span class="line"></span><br><span class="line">        ngx_log_debug1(NGX_LOG_DEBUG_ALLOC, ngx_cycle-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                       <span class="string">&quot;slab alloc: %uz&quot;</span>, size);</span><br><span class="line"></span><br><span class="line">        page = ngx_slab_alloc_pages(pool, (size &gt;&gt; ngx_pagesize_shift)</span><br><span class="line">                                          + ((size % ngx_pagesize) ? <span class="number">1</span> : <span class="number">0</span>));</span><br><span class="line">        <span class="keyword">if</span> (page) &#123;</span><br><span class="line">            p = ngx_slab_page_addr(pool, page);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            p = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">goto</span> done;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å°å¯¹è±¡é€‰æ‹©å¯¹åº”slot</span></span><br><span class="line">    <span class="keyword">if</span> (size &gt; pool-&gt;min_size) &#123;</span><br><span class="line">        shift = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span> (s = size - <span class="number">1</span>; s &gt;&gt;= <span class="number">1</span>; shift++) &#123; <span class="comment">/* void */</span> &#125;</span><br><span class="line">        slot = shift - pool-&gt;min_shift;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        shift = pool-&gt;min_shift;</span><br><span class="line">        slot = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¯¹åº”slotè¯·æ±‚+1</span></span><br><span class="line">    pool-&gt;stats[slot].reqs++;</span><br><span class="line"></span><br><span class="line">    ngx_log_debug2(NGX_LOG_DEBUG_ALLOC, ngx_cycle-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                   <span class="string">&quot;slab alloc: %uz slot: %ui&quot;</span>, size, slot);</span><br><span class="line"></span><br><span class="line">    slots = ngx_slab_slots(pool);</span><br><span class="line">    page = slots[slot].next;   <span class="comment">// slotçš„é“¾è¡¨</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (page-&gt;next != page) &#123;  <span class="comment">// é“¾è¡¨ä¸ºç©ºï¼Œè·³åˆ°åé¢åˆ†é…æ–°çš„1é¡µ</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (shift &lt; ngx_slab_exact_shift) &#123;  <span class="comment">// éœ€è¦ä½¿ç”¨é¡µé¢å¼€å¤´éƒ¨åˆ†ç©ºé—´ä½œä¸ºbitmap</span></span><br><span class="line"></span><br><span class="line">            bitmap = (<span class="keyword">uintptr_t</span> *) ngx_slab_page_addr(pool, page); <span class="comment">// é¡µé¢å¼€å¤´æ˜¯bitmap</span></span><br><span class="line"></span><br><span class="line">            <span class="built_in">map</span> = (ngx_pagesize &gt;&gt; shift) / (<span class="number">8</span> * <span class="keyword">sizeof</span>(<span class="keyword">uintptr_t</span>)); <span class="comment">// å‡ ä¸ªuintptr_tå¤§å°çš„map</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (n = <span class="number">0</span>; n &lt; <span class="built_in">map</span>; n++) &#123;  <span class="comment">// éå†å¯»æ‰¾ä¸€ä¸ªç©ºé—²çš„å¯¹è±¡</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (bitmap[n] != NGX_SLAB_BUSY) &#123;  <span class="comment">// å½“å‰bitmapå—æ²¡æœ‰å…¨ç½®ä½</span></span><br><span class="line"></span><br><span class="line">                    <span class="keyword">for</span> (m = <span class="number">1</span>, i = <span class="number">0</span>; m; m &lt;&lt;= <span class="number">1</span>, i++) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (bitmap[n] &amp; m) &#123;</span><br><span class="line">                            <span class="keyword">continue</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">// ç¬¬nä¸ªmapçš„ç¬¬iä½ï¼ˆä»å³å¾€å·¦æ•°ï¼‰</span></span><br><span class="line">                        bitmap[n] |= m;</span><br><span class="line">                        <span class="comment">// æ€»å…±ç¬¬å‡ ä½ * å¯¹è±¡å¤§å° = å¯¹è±¡åœ°å€å…³äºé¡µåœ°å€çš„åç§»</span></span><br><span class="line">                        i = (n * <span class="number">8</span> * <span class="keyword">sizeof</span>(<span class="keyword">uintptr_t</span>) + i) &lt;&lt; shift;</span><br><span class="line"></span><br><span class="line">                        p = (<span class="keyword">uintptr_t</span>) bitmap + i; <span class="comment">// pä¸ºå¯¹è±¡åœ°å€</span></span><br><span class="line"></span><br><span class="line">                        pool-&gt;stats[slot].used++;   <span class="comment">// æ­£åœ¨ä½¿ç”¨çš„+1</span></span><br><span class="line">                        <span class="comment">// å¦‚æœå½“å‰bitmapæ»¡äº†ï¼Œæ£€æŸ¥åé¢çš„æ˜¯å¦éƒ½æ»¡äº†</span></span><br><span class="line">                        <span class="keyword">if</span> (bitmap[n] == NGX_SLAB_BUSY) &#123;</span><br><span class="line">                            <span class="keyword">for</span> (n = n + <span class="number">1</span>; n &lt; <span class="built_in">map</span>; n++) &#123;</span><br><span class="line">                                <span class="keyword">if</span> (bitmap[n] != NGX_SLAB_BUSY) &#123;</span><br><span class="line">                                    <span class="keyword">goto</span> done;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="comment">// å¦‚æœæ•´ä¸ªé¡µéƒ½ç”¨å®Œäº†ï¼Œå°†å…¶ä»sloté“¾è¡¨ä¸­ç§»é™¤</span></span><br><span class="line">                            prev = ngx_slab_page_prev(page);</span><br><span class="line">                            prev-&gt;next = page-&gt;next;</span><br><span class="line">                            page-&gt;next-&gt;prev = page-&gt;prev;</span><br><span class="line"></span><br><span class="line">                            page-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line">                            page-&gt;prev = NGX_SLAB_SMALL;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">goto</span> done;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (shift == ngx_slab_exact_shift) &#123; <span class="comment">// é¡µé¢å¤´ä¸­çš„slabæ­£å¥½ä½œä¸ºbimap</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (m = <span class="number">1</span>, i = <span class="number">0</span>; m; m &lt;&lt;= <span class="number">1</span>, i++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (page-&gt;slab &amp; m) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                page-&gt;slab |= m;  <span class="comment">// ç½®ä½</span></span><br><span class="line">                <span class="comment">// è¯¥é¡µå¦‚æœæ»¡äº†ï¼Œç§»å‡ºsloté“¾è¡¨</span></span><br><span class="line">                <span class="keyword">if</span> (page-&gt;slab == NGX_SLAB_BUSY) &#123;</span><br><span class="line">                    prev = ngx_slab_page_prev(page);</span><br><span class="line">                    prev-&gt;next = page-&gt;next;</span><br><span class="line">                    page-&gt;next-&gt;prev = page-&gt;prev;</span><br><span class="line"></span><br><span class="line">                    page-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line">                    page-&gt;prev = NGX_SLAB_EXACT;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// è·å–å¯¹è±¡åœ°å€</span></span><br><span class="line">                p = ngx_slab_page_addr(pool, page) + (i &lt;&lt; shift);</span><br><span class="line"></span><br><span class="line">                pool-&gt;stats[slot].used++;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">goto</span> done;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; <span class="comment">/* shift &gt; ngx_slab_exact_shift */</span></span><br><span class="line">            <span class="comment">// 111...11ï¼Œ1é¡µå¯¹è±¡ä¸ªæ•°ä¸ª1</span></span><br><span class="line">            mask = ((<span class="keyword">uintptr_t</span>) <span class="number">1</span> &lt;&lt; (ngx_pagesize &gt;&gt; shift)) - <span class="number">1</span>;</span><br><span class="line">            mask &lt;&lt;= NGX_SLAB_MAP_SHIFT;  <span class="comment">// ç§»åˆ°é«˜ä½ä¸Šï¼Œä¸ºå•¥? å› ä¸ºä½ä½è¿˜è¦è®°å½•shiftã€‚ä¸ºå•¥éœ€è¦è®°å½•shiftï¼Œå› ä¸ºåœ¨é‡Šæ”¾å¯¹è±¡çš„æ—¶å€™éœ€è¦çŸ¥é“å¤§å°</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (m = (<span class="keyword">uintptr_t</span>) <span class="number">1</span> &lt;&lt; NGX_SLAB_MAP_SHIFT, i = <span class="number">0</span>;</span><br><span class="line">                 m &amp; mask;</span><br><span class="line">                 m &lt;&lt;= <span class="number">1</span>, i++)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (page-&gt;slab &amp; m) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                page-&gt;slab |= m;  <span class="comment">// ç½®ä½</span></span><br><span class="line">                <span class="comment">// è¯¥é¡µå¦‚æœæ»¡äº†ï¼Œç§»å‡ºsloté“¾è¡¨</span></span><br><span class="line">                <span class="keyword">if</span> ((page-&gt;slab &amp; NGX_SLAB_MAP_MASK) == mask) &#123;</span><br><span class="line">                    prev = ngx_slab_page_prev(page);</span><br><span class="line">                    prev-&gt;next = page-&gt;next;</span><br><span class="line">                    page-&gt;next-&gt;prev = page-&gt;prev;</span><br><span class="line"></span><br><span class="line">                    page-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line">                    page-&gt;prev = NGX_SLAB_BIG;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                p = ngx_slab_page_addr(pool, page) + (i &lt;&lt; shift);</span><br><span class="line"></span><br><span class="line">                pool-&gt;stats[slot].used++;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">goto</span> done;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ngx_slab_error(pool, NGX_LOG_ALERT, <span class="string">&quot;ngx_slab_alloc(): page is busy&quot;</span>);</span><br><span class="line">        ngx_debug_point();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// åˆ†é…æ–°é¡µ</span></span><br><span class="line">    page = ngx_slab_alloc_pages(pool, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (page) &#123;</span><br><span class="line">        <span class="keyword">if</span> (shift &lt; ngx_slab_exact_shift) &#123;</span><br><span class="line">            bitmap = (<span class="keyword">uintptr_t</span> *) ngx_slab_page_addr(pool, page);</span><br><span class="line">            <span class="comment">// è®¡ç®—éœ€è¦å¼€å¤´å‡ ä¸ªå¯¹è±¡ä½œä¸ºbitmap: n = 1é¡µå¯¹è±¡ä¸ªæ•° / 1ä¸ªå¯¹è±¡ä½æ•°</span></span><br><span class="line">            n = (ngx_pagesize &gt;&gt; shift) / ((<span class="number">1</span> &lt;&lt; shift) * <span class="number">8</span>);</span><br><span class="line">            <span class="comment">// ä¸æ»¡1ä¸ªå¯¹è±¡ï¼Œä½¿ç”¨1å¯¹è±¡</span></span><br><span class="line">            <span class="keyword">if</span> (n == <span class="number">0</span>) &#123;</span><br><span class="line">                n = <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// æ¥ä¸‹æ¥åˆå§‹åŒ–bitmapï¼Œå°†bitmapæœ¬èº«å ç”¨çš„å¯¹è±¡ç½®1ï¼Œå°†ç”³è¯·çš„ç›®æ ‡å¯¹è±¡ç½®1</span></span><br><span class="line">            <span class="comment">/* &quot;n&quot; elements for bitmap, plus one requested */</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; (n + <span class="number">1</span>) / (<span class="number">8</span> * <span class="keyword">sizeof</span>(<span class="keyword">uintptr_t</span>)); i++) &#123;</span><br><span class="line">                bitmap[i] = NGX_SLAB_BUSY;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// ä¸æ»¡ä¸€ä¸ªbitmapçš„éƒ¨åˆ†ç½®1</span></span><br><span class="line">            m = ((<span class="keyword">uintptr_t</span>) <span class="number">1</span> &lt;&lt; ((n + <span class="number">1</span>) % (<span class="number">8</span> * <span class="keyword">sizeof</span>(<span class="keyword">uintptr_t</span>)))) - <span class="number">1</span>;</span><br><span class="line">            bitmap[i] = m;</span><br><span class="line">            <span class="comment">// å‰©ä½™bitmapç½®0</span></span><br><span class="line">            <span class="built_in">map</span> = (ngx_pagesize &gt;&gt; shift) / (<span class="number">8</span> * <span class="keyword">sizeof</span>(<span class="keyword">uintptr_t</span>));</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (i = i + <span class="number">1</span>; i &lt; <span class="built_in">map</span>; i++) &#123;</span><br><span class="line">                bitmap[i] = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            page-&gt;slab = shift;  <span class="comment">// slabè®°å½•shift</span></span><br><span class="line">            page-&gt;next = &amp;slots[slot]; <span class="comment">// æ’å…¥sloté“¾è¡¨å¤´</span></span><br><span class="line">            page-&gt;prev = (<span class="keyword">uintptr_t</span>) &amp;slots[slot] | NGX_SLAB_SMALL;</span><br><span class="line"></span><br><span class="line">            slots[slot].next = page;</span><br><span class="line">            <span class="comment">// å¢åŠ è¯¥slotæ€»å¯¹è±¡æ•°ï¼ˆä¸åŒ…æ‹¬bitmapæœ¬èº«å ç”¨çš„å¯¹è±¡ï¼‰</span></span><br><span class="line">            pool-&gt;stats[slot].total += (ngx_pagesize &gt;&gt; shift) - n;</span><br><span class="line"></span><br><span class="line">            p = ngx_slab_page_addr(pool, page) + (n &lt;&lt; shift);</span><br><span class="line"></span><br><span class="line">            pool-&gt;stats[slot].used++;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">goto</span> done;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (shift == ngx_slab_exact_shift) &#123;</span><br><span class="line"></span><br><span class="line">            page-&gt;slab = <span class="number">1</span>;  <span class="comment">// ç”³è¯·çš„å¯¹è±¡ç½®ä½</span></span><br><span class="line">            <span class="comment">// æ’å…¥sloté“¾è¡¨å¤´</span></span><br><span class="line">            page-&gt;next = &amp;slots[slot];</span><br><span class="line">            page-&gt;prev = (<span class="keyword">uintptr_t</span>) &amp;slots[slot] | NGX_SLAB_EXACT;</span><br><span class="line"></span><br><span class="line">            slots[slot].next = page;</span><br><span class="line">            <span class="comment">// å¢åŠ è¯¥slotæ€»å¯¹è±¡æ•°</span></span><br><span class="line">            pool-&gt;stats[slot].total += <span class="number">8</span> * <span class="keyword">sizeof</span>(<span class="keyword">uintptr_t</span>);</span><br><span class="line"></span><br><span class="line">            p = ngx_slab_page_addr(pool, page);</span><br><span class="line"></span><br><span class="line">            pool-&gt;stats[slot].used++;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">goto</span> done;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; <span class="comment">/* shift &gt; ngx_slab_exact_shift */</span></span><br><span class="line">            <span class="comment">// é«˜ä½ç”³è¯·çš„å¯¹è±¡ç½®ä½ + ä½ä½è®°å½•shift</span></span><br><span class="line">            page-&gt;slab = ((<span class="keyword">uintptr_t</span>) <span class="number">1</span> &lt;&lt; NGX_SLAB_MAP_SHIFT) | shift;</span><br><span class="line">            page-&gt;next = &amp;slots[slot];</span><br><span class="line">            page-&gt;prev = (<span class="keyword">uintptr_t</span>) &amp;slots[slot] | NGX_SLAB_BIG;</span><br><span class="line"></span><br><span class="line">            slots[slot].next = page;</span><br><span class="line"></span><br><span class="line">            pool-&gt;stats[slot].total += ngx_pagesize &gt;&gt; shift;</span><br><span class="line"></span><br><span class="line">            p = ngx_slab_page_addr(pool, page);</span><br><span class="line"></span><br><span class="line">            pool-&gt;stats[slot].used++;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">goto</span> done;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    p = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    pool-&gt;stats[slot].fails++;  <span class="comment">// åˆ†é…å¯¹è±¡å¤±è´¥æ¬¡æ•°</span></span><br><span class="line"></span><br><span class="line">done:</span><br><span class="line"></span><br><span class="line">    ngx_log_debug1(NGX_LOG_DEBUG_ALLOC, ngx_cycle-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                   <span class="string">&quot;slab alloc: %p&quot;</span>, (<span class="keyword">void</span> *) p);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">void</span> *) p;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="é‡Šæ”¾é€»è¾‘"><a href="#é‡Šæ”¾é€»è¾‘" class="headerlink" title="é‡Šæ”¾é€»è¾‘"></a>é‡Šæ”¾é€»è¾‘</h2><h3 id="é‡Šæ”¾é¡µé¢"><a href="#é‡Šæ”¾é¡µé¢" class="headerlink" title="é‡Šæ”¾é¡µé¢"></a>é‡Šæ”¾é¡µé¢</h3><p>å¦‚æœæ˜¯é‡Šæ”¾å¤šä¸ªé¡µé¢ï¼Œå°†åé¢çš„é¡µé¢å¤´éƒ½æ¸…é›¶ã€‚å¦‚æœæ˜¯sloté¡µï¼Œå°†å…¶ä»sloté“¾è¡¨ä¸­ç§»é™¤ã€‚ç„¶åå°è¯•åˆå¹¶å‰åçš„é¡µé¢ï¼Œä»è€Œç»„æˆæ›´å¤§çš„è¿ç»­é¡µã€‚åˆå¹¶å®Œæˆåï¼Œæ’å…¥åˆ°ç©ºé—²é¡µå—é“¾è¡¨ä¸­ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span></span></span><br><span class="line"><span class="function"><span class="title">ngx_slab_free_pages</span><span class="params">(<span class="keyword">ngx_slab_pool_t</span> *pool, <span class="keyword">ngx_slab_page_t</span> *page,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">ngx_uint_t</span> pages)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">ngx_slab_page_t</span>  *prev, *join;</span><br><span class="line"></span><br><span class="line">    pool-&gt;pfree += pages;</span><br><span class="line"></span><br><span class="line">    page-&gt;slab = pages--;</span><br><span class="line">    <span class="comment">// ç¬¬äºŒé¡µå¼€å§‹çš„é¡µé¢å¤´éƒ½æ¸…é›¶</span></span><br><span class="line">    <span class="keyword">if</span> (pages) &#123;</span><br><span class="line">        ngx_memzero(&amp;page[<span class="number">1</span>], pages * <span class="keyword">sizeof</span>(<span class="keyword">ngx_slab_page_t</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// nextä¸éƒ½ç­‰äºNULLä¹ˆ? ä¸ç­‰äºNULLè¡¨ç¤ºæ˜¯sloté¡µï¼Œå°†å…¶ä»sloté“¾è¡¨ä¸­ç§»é™¤ </span></span><br><span class="line">    <span class="keyword">if</span> (page-&gt;next) &#123;</span><br><span class="line">        prev = ngx_slab_page_prev(page);</span><br><span class="line">        prev-&gt;next = page-&gt;next;</span><br><span class="line">        page-&gt;next-&gt;prev = page-&gt;prev;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å°è¯•åˆå¹¶åé¢çš„é¡µé¢</span></span><br><span class="line">    join = page + page-&gt;slab;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (join &lt; pool-&gt;last) &#123;  <span class="comment">// æ£€æŸ¥åé¢æ˜¯å¦è¿˜æœ‰é¡µ</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ngx_slab_page_type(join) == NGX_SLAB_PAGE) &#123;  <span class="comment">// æ˜¯æ•´é¡µ</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (join-&gt;next != <span class="literal">NULL</span>) &#123;            <span class="comment">// åœ¨ç©ºé—²é¡µé“¾è¡¨ä¸­</span></span><br><span class="line">                pages += join-&gt;slab;             <span class="comment">// åŠ ä¸Šåˆå¹¶å—çš„é¡µæ•°</span></span><br><span class="line">                page-&gt;slab += join-&gt;slab;        <span class="comment">// å¢åŠ é¡µå—å¤§å°</span></span><br><span class="line">                <span class="comment">// å°†joinå—ä»ç©ºé—²é“¾è¡¨ä¸­ç§»é™¤</span></span><br><span class="line">                prev = ngx_slab_page_prev(join);</span><br><span class="line">                prev-&gt;next = join-&gt;next;</span><br><span class="line">                join-&gt;next-&gt;prev = join-&gt;prev;</span><br><span class="line">                <span class="comment">// æ¸…ç†é¡µå—å¤´ï¼Œæ¢å¤æŒ‡é’ˆå’Œæ ‡å¿—</span></span><br><span class="line">                join-&gt;slab = NGX_SLAB_PAGE_FREE;</span><br><span class="line">                join-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line">                join-&gt;prev = NGX_SLAB_PAGE;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å°è¯•åˆå¹¶å‰é¢çš„é¡µ</span></span><br><span class="line">    <span class="keyword">if</span> (page &gt; pool-&gt;pages) &#123;  <span class="comment">// å‰é¢è¿˜æœ‰é¡µ</span></span><br><span class="line">        join = page - <span class="number">1</span>;       <span class="comment">// joinæŒ‡å‘è¢«é‡Šæ”¾é¡µçš„å‰ä¸€é¡µ</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ngx_slab_page_type(join) == NGX_SLAB_PAGE) &#123;  <span class="comment">// æ˜¯æ•´é¡µ</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (join-&gt;slab == NGX_SLAB_PAGE_FREE) &#123;  <span class="comment">// ä¸æ˜¯é¡µå—å¤´</span></span><br><span class="line">                join = ngx_slab_page_prev(join);     <span class="comment">// joinæŒ‡å‘é¡µå—å¤´</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (join-&gt;next != <span class="literal">NULL</span>) &#123;            <span class="comment">// åœ¨ç©ºé—²é“¾è¡¨ä¸­</span></span><br><span class="line">                pages += join-&gt;slab;             <span class="comment">// åŠ ä¸Šåˆå¹¶å—çš„é¡µæ•°</span></span><br><span class="line">                join-&gt;slab += page-&gt;slab;        <span class="comment">// å¢åŠ é¡µå—å¤§å°</span></span><br><span class="line">                <span class="comment">// å°†joinå—ä»ç©ºé—²é“¾è¡¨ä¸­ç§»é™¤</span></span><br><span class="line">                prev = ngx_slab_page_prev(join);</span><br><span class="line">                prev-&gt;next = join-&gt;next;</span><br><span class="line">                join-&gt;next-&gt;prev = join-&gt;prev;</span><br><span class="line">                <span class="comment">// æ¸…ç†é¡µå—å¤´ï¼Œæ¢å¤æŒ‡é’ˆå’Œæ ‡å¿—</span></span><br><span class="line">                page-&gt;slab = NGX_SLAB_PAGE_FREE;</span><br><span class="line">                page-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line">                page-&gt;prev = NGX_SLAB_PAGE;</span><br><span class="line"></span><br><span class="line">                page = join;     <span class="comment">// æ›´æ–°é¡µå—å¤´</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¦‚æœé¡µå—å¤§äº1é¡µï¼Œå°†æœ€åä¸€é¡µçš„prevæŒ‡å‘é¡µå—å¤´ï¼Œåˆå¹¶æ—¶ç”¨</span></span><br><span class="line">    <span class="keyword">if</span> (pages) &#123;</span><br><span class="line">        page[pages].prev = (<span class="keyword">uintptr_t</span>) page;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å°†é¡µå—æ’å…¥ç©ºé—²é¡µé“¾è¡¨å¤´</span></span><br><span class="line">    page-&gt;prev = (<span class="keyword">uintptr_t</span>) &amp;pool-&gt;<span class="built_in">free</span>;</span><br><span class="line">    page-&gt;next = pool-&gt;<span class="built_in">free</span>.next;</span><br><span class="line"></span><br><span class="line">    page-&gt;next-&gt;prev = (<span class="keyword">uintptr_t</span>) page;</span><br><span class="line"></span><br><span class="line">    pool-&gt;<span class="built_in">free</span>.next = page;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="é‡Šæ”¾å¯¹è±¡"><a href="#é‡Šæ”¾å¯¹è±¡" class="headerlink" title="é‡Šæ”¾å¯¹è±¡"></a>é‡Šæ”¾å¯¹è±¡</h3><p>é¦–å…ˆæ ¹æ®å¯¹è±¡æŒ‡é’ˆè·å–åˆ°å¯¹åº”çš„é¡µé¢å¤´ä»¥åŠç›¸åº”çš„é¡µé¢ä¿¡æ¯ï¼Œç„¶åæ ¹æ®é¡µé¢ç±»å‹åšä¸åŒçš„å¤„ç†ã€‚å¯¹äºslotå¯¹è±¡ï¼Œå°†å¯¹åº”çš„bitä½å¤ä½ã€‚å¦‚æœé‡Šæ”¾è¯¥å¯¹è±¡å‰é¡µé¢æ˜¯æ»¡çš„ï¼Œåˆ™å°†è¯¥é¡µé¢é‡æ–°æ’å…¥slotåŠæ»¡é“¾è¡¨ã€‚å¦‚æœé‡Šæ”¾è¯¥å¯¹è±¡åé¡µé¢ç©ºäº†ï¼Œåˆ™é‡Šæ”¾è¯¥é¡µã€‚</p>
<p>å¦‚æœä½ å·²ç»äº†è§£äº†åˆ†é…é€»è¾‘ï¼Œé‚£ä¹ˆé‡Šæ”¾é€»è¾‘åº”è¯¥å¾ˆå¥½ç†è§£ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span></span></span><br><span class="line"><span class="function"><span class="title">ngx_slab_free_locked</span><span class="params">(<span class="keyword">ngx_slab_pool_t</span> *pool, <span class="keyword">void</span> *p)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">size_t</span>            size;</span><br><span class="line">    <span class="keyword">uintptr_t</span>         slab, m, *bitmap;</span><br><span class="line">    <span class="keyword">ngx_uint_t</span>        i, n, type, slot, shift, <span class="built_in">map</span>;</span><br><span class="line">    <span class="keyword">ngx_slab_page_t</span>  *slots, *page;</span><br><span class="line"></span><br><span class="line">    ngx_log_debug1(NGX_LOG_DEBUG_ALLOC, ngx_cycle-&gt;<span class="built_in">log</span>, <span class="number">0</span>, <span class="string">&quot;slab free: %p&quot;</span>, p);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((u_char *) p &lt; pool-&gt;start || (u_char *) p &gt; pool-&gt;end) &#123;</span><br><span class="line">        ngx_slab_error(pool, NGX_LOG_ALERT, <span class="string">&quot;ngx_slab_free(): outside of pool&quot;</span>);</span><br><span class="line">        <span class="keyword">goto</span> fail;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è®¡ç®—é‡Šæ”¾çš„æŒ‡é’ˆåœ¨ç¬¬å‡ é¡µ</span></span><br><span class="line">    n = ((u_char *) p - pool-&gt;start) &gt;&gt; ngx_pagesize_shift;</span><br><span class="line">    page = &amp;pool-&gt;pages[n];  <span class="comment">// è·å–å¯¹åº”é¡µé¢å¤´</span></span><br><span class="line">    slab = page-&gt;slab;</span><br><span class="line">    type = ngx_slab_page_type(page);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (type) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> NGX_SLAB_SMALL:</span><br><span class="line"></span><br><span class="line">        shift = slab &amp; NGX_SLAB_SHIFT_MASK;</span><br><span class="line">        size = (<span class="keyword">size_t</span>) <span class="number">1</span> &lt;&lt; shift;</span><br><span class="line">        <span class="comment">// æ£€æŸ¥æŒ‡é’ˆæ˜¯å¦å¯¹è±¡å¯¹é½</span></span><br><span class="line">        <span class="keyword">if</span> ((<span class="keyword">uintptr_t</span>) p &amp; (size - <span class="number">1</span>)) &#123;</span><br><span class="line">            <span class="keyword">goto</span> wrong_chunk;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ç¬¬å‡ ä¸ªå¯¹è±¡: n = é¡µä¸­çš„åç§» / å¯¹è±¡å¤§å°</span></span><br><span class="line">        n = ((<span class="keyword">uintptr_t</span>) p &amp; (ngx_pagesize - <span class="number">1</span>)) &gt;&gt; shift;</span><br><span class="line">        m = (<span class="keyword">uintptr_t</span>) <span class="number">1</span> &lt;&lt; (n % (<span class="number">8</span> * <span class="keyword">sizeof</span>(<span class="keyword">uintptr_t</span>)));</span><br><span class="line">        n /= <span class="number">8</span> * <span class="keyword">sizeof</span>(<span class="keyword">uintptr_t</span>);</span><br><span class="line">        bitmap = (<span class="keyword">uintptr_t</span> *)</span><br><span class="line">                             ((<span class="keyword">uintptr_t</span>) p &amp; ~((<span class="keyword">uintptr_t</span>) ngx_pagesize - <span class="number">1</span>));  <span class="comment">// é¡µèµ·å§‹åœ°å€ï¼Œè·å–bitmap</span></span><br><span class="line">      <span class="comment">// ç¬¬nä¸ªbitmapçš„mä½</span></span><br><span class="line">        <span class="keyword">if</span> (bitmap[n] &amp; m) &#123;</span><br><span class="line">            slot = shift - pool-&gt;min_shift;</span><br><span class="line">            <span class="comment">// å¦‚æœå½“å‰é¡µä¸åœ¨sloté“¾è¡¨ä¸­ï¼ˆå³é‡Šæ”¾å‰æ˜¯æ»¡çš„ï¼‰ï¼Œé‡æ–°åŠ å›é“¾è¡¨</span></span><br><span class="line">            <span class="keyword">if</span> (page-&gt;next == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                slots = ngx_slab_slots(pool);</span><br><span class="line"></span><br><span class="line">                page-&gt;next = slots[slot].next;</span><br><span class="line">                slots[slot].next = page;</span><br><span class="line"></span><br><span class="line">                page-&gt;prev = (<span class="keyword">uintptr_t</span>) &amp;slots[slot] | NGX_SLAB_SMALL;</span><br><span class="line">                page-&gt;next-&gt;prev = (<span class="keyword">uintptr_t</span>) page | NGX_SLAB_SMALL;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// æ¸…bitä½</span></span><br><span class="line">            bitmap[n] &amp;= ~m;</span><br><span class="line">            <span class="comment">// è®¡ç®—éœ€è¦å¼€å¤´å‡ ä¸ªå¯¹è±¡ä½œä¸ºbitmap: n = 1é¡µå¯¹è±¡ä¸ªæ•° / 1ä¸ªå¯¹è±¡ä½æ•°</span></span><br><span class="line">            n = (ngx_pagesize &gt;&gt; shift) / ((<span class="number">1</span> &lt;&lt; shift) * <span class="number">8</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (n == <span class="number">0</span>) &#123;</span><br><span class="line">                n = <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// æ¥ä¸‹æ¥æ£€æŸ¥é™¤äº†bitmapæœ¬èº«å ç”¨çš„å¯¹è±¡å¤–ï¼Œæ˜¯å¦è¿˜æœ‰å…¶ä»–å¯¹è±¡</span></span><br><span class="line">            <span class="comment">// å·²ç»è¢«bitmapå æ»¡çš„uintptr_tä¸ç”¨æ£€æŸ¥ï¼Œå¯¹äºbitmapå¯¹è±¡å’Œå®é™…æ•°æ®å¯¹è±¡æ··ç”¨çš„uintptr_téœ€è¦unmaskæ‰bitmapçš„éƒ¨åˆ†</span></span><br><span class="line">            i = n / (<span class="number">8</span> * <span class="keyword">sizeof</span>(<span class="keyword">uintptr_t</span>));</span><br><span class="line">            m = ((<span class="keyword">uintptr_t</span>) <span class="number">1</span> &lt;&lt; (n % (<span class="number">8</span> * <span class="keyword">sizeof</span>(<span class="keyword">uintptr_t</span>)))) - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (bitmap[i] &amp; ~m) &#123;</span><br><span class="line">                <span class="keyword">goto</span> done;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// map = å¤šå°‘ä¸ªuintptr_tå¤§å°çš„map</span></span><br><span class="line">            <span class="built_in">map</span> = (ngx_pagesize &gt;&gt; shift) / (<span class="number">8</span> * <span class="keyword">sizeof</span>(<span class="keyword">uintptr_t</span>));</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (i = i + <span class="number">1</span>; i &lt; <span class="built_in">map</span>; i++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (bitmap[i]) &#123;</span><br><span class="line">                    <span class="keyword">goto</span> done;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// å¦‚æœç©ºäº†ï¼Œå°±é‡Šæ”¾è¯¥é¡µ</span></span><br><span class="line">            ngx_slab_free_pages(pool, page, <span class="number">1</span>);</span><br><span class="line">            <span class="comment">// å‡å»slotçš„å¯¹è±¡ä¸ªæ•°</span></span><br><span class="line">            pool-&gt;stats[slot].total -= (ngx_pagesize &gt;&gt; shift) - n;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">goto</span> done;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">goto</span> chunk_already_free;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> NGX_SLAB_EXACT:</span><br><span class="line"></span><br><span class="line">        m = (<span class="keyword">uintptr_t</span>) <span class="number">1</span> &lt;&lt;</span><br><span class="line">                (((<span class="keyword">uintptr_t</span>) p &amp; (ngx_pagesize - <span class="number">1</span>)) &gt;&gt; ngx_slab_exact_shift);  <span class="comment">// ç›®æ ‡å¯¹è±¡å¯¹åº”çš„ä½</span></span><br><span class="line">        size = ngx_slab_exact_size;</span><br><span class="line">        <span class="comment">// æ£€æŸ¥å¯¹é½</span></span><br><span class="line">        <span class="keyword">if</span> ((<span class="keyword">uintptr_t</span>) p &amp; (size - <span class="number">1</span>)) &#123;</span><br><span class="line">            <span class="keyword">goto</span> wrong_chunk;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (slab &amp; m) &#123;</span><br><span class="line">            slot = ngx_slab_exact_shift - pool-&gt;min_shift;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (slab == NGX_SLAB_BUSY) &#123;  <span class="comment">// bitmapæ˜¯æ»¡çš„ï¼Œé‡æ–°åŠ å…¥é“¾è¡¨</span></span><br><span class="line">                slots = ngx_slab_slots(pool);</span><br><span class="line"></span><br><span class="line">                page-&gt;next = slots[slot].next;</span><br><span class="line">                slots[slot].next = page;</span><br><span class="line"></span><br><span class="line">                page-&gt;prev = (<span class="keyword">uintptr_t</span>) &amp;slots[slot] | NGX_SLAB_EXACT;</span><br><span class="line">                page-&gt;next-&gt;prev = (<span class="keyword">uintptr_t</span>) page | NGX_SLAB_EXACT;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            page-&gt;slab &amp;= ~m;  <span class="comment">// æ¸…bitä½</span></span><br><span class="line">            <span class="comment">// å¦‚æœç©ºäº†ï¼Œå°±é‡Šæ”¾è¯¥é¡µ</span></span><br><span class="line">            <span class="keyword">if</span> (page-&gt;slab) &#123;</span><br><span class="line">                <span class="keyword">goto</span> done;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ngx_slab_free_pages(pool, page, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">            pool-&gt;stats[slot].total -= <span class="number">8</span> * <span class="keyword">sizeof</span>(<span class="keyword">uintptr_t</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">goto</span> done;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">goto</span> chunk_already_free;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> NGX_SLAB_BIG:</span><br><span class="line"></span><br><span class="line">        shift = slab &amp; NGX_SLAB_SHIFT_MASK;</span><br><span class="line">        size = (<span class="keyword">size_t</span>) <span class="number">1</span> &lt;&lt; shift;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((<span class="keyword">uintptr_t</span>) p &amp; (size - <span class="number">1</span>)) &#123;</span><br><span class="line">            <span class="keyword">goto</span> wrong_chunk;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ç›®æ ‡å¯¹è±¡å¯¹åº”çš„ä½</span></span><br><span class="line">        m = (<span class="keyword">uintptr_t</span>) <span class="number">1</span> &lt;&lt; ((((<span class="keyword">uintptr_t</span>) p &amp; (ngx_pagesize - <span class="number">1</span>)) &gt;&gt; shift)</span><br><span class="line">                              + NGX_SLAB_MAP_SHIFT);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (slab &amp; m) &#123;</span><br><span class="line">            slot = shift - pool-&gt;min_shift;</span><br><span class="line">            <span class="comment">// å¦‚æœå½“å‰é¡µä¸åœ¨sloté“¾è¡¨ä¸­ï¼ˆå³é‡Šæ”¾å‰æ˜¯æ»¡çš„ï¼‰ï¼Œé‡æ–°åŠ å›é“¾è¡¨</span></span><br><span class="line">            <span class="keyword">if</span> (page-&gt;next == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                slots = ngx_slab_slots(pool);</span><br><span class="line"></span><br><span class="line">                page-&gt;next = slots[slot].next;</span><br><span class="line">                slots[slot].next = page;</span><br><span class="line"></span><br><span class="line">                page-&gt;prev = (<span class="keyword">uintptr_t</span>) &amp;slots[slot] | NGX_SLAB_BIG;</span><br><span class="line">                page-&gt;next-&gt;prev = (<span class="keyword">uintptr_t</span>) page | NGX_SLAB_BIG;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            page-&gt;slab &amp;= ~m;</span><br><span class="line">            <span class="comment">// å¦‚æœç©ºäº†ï¼Œå°±é‡Šæ”¾è¯¥é¡µ</span></span><br><span class="line">            <span class="keyword">if</span> (page-&gt;slab &amp; NGX_SLAB_MAP_MASK) &#123;</span><br><span class="line">                <span class="keyword">goto</span> done;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            ngx_slab_free_pages(pool, page, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">            pool-&gt;stats[slot].total -= ngx_pagesize &gt;&gt; shift;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">goto</span> done;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">goto</span> chunk_already_free;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> NGX_SLAB_PAGE:</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((<span class="keyword">uintptr_t</span>) p &amp; (ngx_pagesize - <span class="number">1</span>)) &#123;</span><br><span class="line">            <span class="keyword">goto</span> wrong_chunk;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!(slab &amp; NGX_SLAB_PAGE_START)) &#123;</span><br><span class="line">            ngx_slab_error(pool, NGX_LOG_ALERT,</span><br><span class="line">                           <span class="string">&quot;ngx_slab_free(): page is already free&quot;</span>);</span><br><span class="line">            <span class="keyword">goto</span> fail;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (slab == NGX_SLAB_PAGE_BUSY) &#123;</span><br><span class="line">            ngx_slab_error(pool, NGX_LOG_ALERT,</span><br><span class="line">                           <span class="string">&quot;ngx_slab_free(): pointer to wrong page&quot;</span>);</span><br><span class="line">            <span class="keyword">goto</span> fail;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        size = slab &amp; ~NGX_SLAB_PAGE_START;</span><br><span class="line"></span><br><span class="line">        ngx_slab_free_pages(pool, page, size);</span><br><span class="line"></span><br><span class="line">        ngx_slab_junk(p, size &lt;&lt; ngx_pagesize_shift);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* not reached */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">done:</span><br><span class="line"></span><br><span class="line">    pool-&gt;stats[slot].used--;  <span class="comment">// å¯¹è±¡ä½¿ç”¨æ•°å‡1</span></span><br><span class="line"></span><br><span class="line">    ngx_slab_junk(p, size);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">wrong_chunk:</span><br><span class="line"></span><br><span class="line">    ngx_slab_error(pool, NGX_LOG_ALERT,</span><br><span class="line">                   <span class="string">&quot;ngx_slab_free(): pointer to wrong chunk&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">goto</span> fail;</span><br><span class="line"></span><br><span class="line">chunk_already_free:</span><br><span class="line"></span><br><span class="line">    ngx_slab_error(pool, NGX_LOG_ALERT,</span><br><span class="line">                   <span class="string">&quot;ngx_slab_free(): chunk is already free&quot;</span>);</span><br><span class="line"></span><br><span class="line">fail:</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="å…±äº«å†…å­˜é”€æ¯"><a href="#å…±äº«å†…å­˜é”€æ¯" class="headerlink" title="å…±äº«å†…å­˜é”€æ¯"></a>å…±äº«å†…å­˜é”€æ¯</h2><p>å‰é¢è®²äº†åˆå§‹åŒ–ã€åˆ†é…é€»è¾‘ã€é‡Šæ”¾é€»è¾‘ï¼Œä¸ºäº†ä¸å¤±å®Œæ•´æ€§ï¼Œè¿™é‡Œå†è®²ä¸‹é”€æ¯é€»è¾‘ã€‚</p>
<p>æœç´¢äº†æ•´ä¸ªä»£ç å¹¶æ²¡æœ‰å‘ç°é‡Šæ”¾å…±äº«å†…å­˜çš„åœ°æ–¹ï¼Œåªæœ‰åœ¨cycle_init()å¤±è´¥æ—¶ä¼šmunmap()é‡Šæ”¾æ–°åˆ›å»ºçš„å…±äº«å†…å­˜ã€æˆ–è€…reloadçš„æ—¶å€™é‡Šæ”¾æ‰è¢«æ›¿æ¢çš„å…±äº«å†…å­˜ã€‚</p>
<p>æ‰€ä»¥çŒœæµ‹æ˜¯åœ¨è¿›ç¨‹é€€å‡ºçš„æ—¶å€™è‡ªåŠ¨è¿›è¡Œäº†é‡Šæ”¾ã€‚é‚£ä¹ˆå¦‚ä½•è¿›è¡ŒéªŒè¯å‘¢ï¼Ÿæˆ‘ä»¬ç¼–å†™ä¸€ä¸ªç®€å•çš„æµ‹è¯•ç¨‹åºï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> *addr = (<span class="keyword">char</span> *)<span class="number">0x7f1000000000</span>;</span><br><span class="line">    <span class="keyword">size_t</span> size = <span class="number">8192</span>;</span><br><span class="line">    <span class="keyword">char</span> *p = mmap(addr, size, PROT_READ|PROT_WRITE,</span><br><span class="line">                   MAP_SHARED|MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;addr p = %p, size = %zu\n&quot;</span>, p, size);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸ºäº†æµ‹è¯•æ–¹ä¾¿ï¼Œå‚æ•°é‡ŒæŒ‡å®šäº†ä¸€ä¸ªå»ºè®®çš„åœ°å€ã€‚è¿è¡Œç¨‹åºè¾“å‡ºå¦‚ä¸‹ï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ./a.out</span><br><span class="line">addr p = 0x7f1000000000, size = 8192</span><br></pre></td></tr></table></figure>

<p>ç„¶åï¼Œæˆ‘ä»¬ç¼–å†™ä¸€ä¸ªsystemtapè„šæœ¬ï¼Œæ‰“å°å‚æ•°ä¿¡æ¯å’Œè°ƒç”¨æ ˆä¿¡æ¯</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">probe kernel.function(<span class="string">&quot;unmap_page_range&quot;</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> ($addr != <span class="number">0x7f1000000000</span>)</span><br><span class="line">        next;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;--------\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;addr: 0x%lx, size: %lu\n&quot;</span>, $addr, $end-$addr);</span><br><span class="line">    print_backtrace();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;--------\n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬è¿è¡Œstapè„šæœ¬ï¼Œç„¶åæ‰§è¡Œ<code>./a.out</code>ç»“æœå¦‚ä¸‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">--------</span><br><span class="line">addr: 0x7f1000000000, size: 8192</span><br><span class="line"> 0xffffffff8bc168e0 : unmap_page_range+0x0/0xd00 [kernel]</span><br><span class="line"> 0xffffffff8bc1765d : unmap_single_vma+0x7d/0xf0 [kernel]</span><br><span class="line"> 0xffffffff8bc179a1 : unmap_vmas+0x51/0xb0 [kernel]</span><br><span class="line"> 0xffffffff8bc21535 : exit_mmap+0xb5/0x1d0 [kernel]</span><br><span class="line"> 0xffffffff8ba8b5e7 : mmput+0x57/0x140 [kernel]</span><br><span class="line"> 0xffffffff8ba93b22 : do_exit+0x352/0xb90 [kernel]</span><br><span class="line"> 0xffffffff8ba943e3 : do_group_exit+0x43/0xb0 [kernel]</span><br><span class="line"> 0xffffffff8ba94464 : SyS_exit_group+0x14/0x20 [kernel]</span><br><span class="line"> 0xffffffff8ba03a43 : do_syscall_64+0x73/0x130 [kernel]</span><br><span class="line"> 0xffffffff8c400085 : entry_SYSCALL_64_after_hwframe+0x41/0xa6 [kernel]</span><br><span class="line"> 0xffffffff8c400085 : entry_SYSCALL_64_after_hwframe+0x41/0xa6 [kernel]</span><br><span class="line">--------</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°åœ¨è¿›ç¨‹é€€å‡ºçš„æ—¶å€™ï¼Œè‡ªåŠ¨unmapäº†æˆ‘ä»¬ç”¨mmapåˆ†é…çš„å†…å­˜ã€‚</p>
<h2 id="ç»Ÿè®¡ä¸ç›‘æ§"><a href="#ç»Ÿè®¡ä¸ç›‘æ§" class="headerlink" title="ç»Ÿè®¡ä¸ç›‘æ§"></a>ç»Ÿè®¡ä¸ç›‘æ§</h2><p><a href="https://github.com/hongxiaolong/ngx_slab_stat">ngx_slab_statæ¨¡å—</a>å¯ä»¥ç”¨äºæŸ¥çœ‹slabçš„ç»Ÿè®¡ä¿¡æ¯ï¼Œå®ƒçš„æ•ˆæœå¦‚ä¸‹ï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">^_^$ curl http://127.0.0.1:50090/slab</span><br><span class="line">* shared memory: SSL</span><br><span class="line">total:          64(KB) free:          20(KB) size:           4(KB)</span><br><span class="line">pages:          20(KB) start:00007FA1F9D8C000 end:00007FA1F9D9B000</span><br><span class="line">slot:           8(Bytes) total:         504 used:           1 reqs:           1 fails:           0</span><br><span class="line">slot:          16(Bytes) total:         254 used:           1 reqs:           1 fails:           0</span><br><span class="line">slot:          32(Bytes) total:         127 used:           1 reqs:           1 fails:           0</span><br><span class="line">slot:          64(Bytes) total:          64 used:           2 reqs:           2 fails:           0</span><br><span class="line">slot:         128(Bytes) total:          32 used:          12 reqs:          15 fails:           0</span><br><span class="line">slot:         256(Bytes) total:          16 used:           2 reqs:           2 fails:           0</span><br><span class="line">slot:         512(Bytes) total:           8 used:           1 reqs:           1 fails:           0</span><br><span class="line">slot:        1024(Bytes) total:           4 used:           1 reqs:           1 fails:           0</span><br><span class="line">slot:        2048(Bytes) total:           2 used:           2 reqs:           5 fails:           0</span><br></pre></td></tr></table></figure>

<p>ä¸»è¦å°±æ˜¯è¯»å–<code>ngx_slab_stat_t</code>ç»“æ„ä½“ä¸­çš„é‚£äº›ç»Ÿè®¡ä¿¡æ¯ã€‚å½“ç„¶å®ƒéœ€è¦ç¼–è¯‘æ—¶åŠ å…¥è¯¥æ¨¡å—ï¼Œç„¶ååŠ å…¥ç›¸åº”é…ç½®é¡¹ï¼Œè®¿é—®æ¥å£æ‰èƒ½è·å–ã€‚å¦‚æœè¿™äº›ä¸å¯æ¥å—çš„è¯ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨systemtapéä¾µå…¥å¼åœ°å®ç°ç±»ä¼¼åŠŸèƒ½ã€‚</p>
<h2 id="ssl-session-cache"><a href="#ssl-session-cache" class="headerlink" title="ssl session cache"></a>ssl session cache</h2><p>æœ€åæä¸€ä¸‹ssl session cacheï¼Œå®ƒæ˜¯ä¸€ä¸ªå®é™…ä½¿ç”¨å…±äº«å†…å­˜çš„ä¾‹å­ï¼Œä¹Ÿæ˜¯æˆ‘ä¸ºä»€ä¹ˆä¼šå†™è¿™ç¯‡åšå®¢çš„åŸå› ã€‚<code>ngx_ssl_session_cache_init</code>æ˜¯å…¶ç§æœ‰çš„åˆå§‹åŒ–å‡½æ•°ï¼Œä¸»è¦æ˜¯åˆå§‹åŒ–<code>ngx_ssl_session_cache_t</code>ç»“æ„ï¼ŒåŒ…æ‹¬çº¢é»‘æ ‘å’Œé˜Ÿåˆ—çš„åˆå§‹åŒ–ã€‚çº¢é»‘æ ‘ç”¨äºsession cacheçš„æŸ¥æ‰¾ï¼Œé˜Ÿåˆ—ç”¨äºè¿‡æœŸæ·˜æ±°ã€‚ç„¶åå°†æŒ‡é’ˆèµ‹å€¼åˆ°<code>ngx_shm_zone_t</code>å’Œ<code>ngx_slab_pool_t</code>çš„ç§æœ‰æ•°æ®<code>data</code>å­—æ®µã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">ngx_int_t</span></span></span><br><span class="line"><span class="function"><span class="title">ngx_ssl_session_cache_init</span><span class="params">(<span class="keyword">ngx_shm_zone_t</span> *shm_zone, <span class="keyword">void</span> *data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">size_t</span>                    len;</span><br><span class="line">    <span class="keyword">ngx_slab_pool_t</span>          *shpool;</span><br><span class="line">    <span class="keyword">ngx_ssl_session_cache_t</span>  *cache;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (data) &#123;</span><br><span class="line">        shm_zone-&gt;data = data;</span><br><span class="line">        <span class="keyword">return</span> NGX_OK;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    shpool = (<span class="keyword">ngx_slab_pool_t</span> *) shm_zone-&gt;shm.addr;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (shm_zone-&gt;shm.exists) &#123;</span><br><span class="line">        shm_zone-&gt;data = shpool-&gt;data;</span><br><span class="line">        <span class="keyword">return</span> NGX_OK;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    cache = ngx_slab_alloc(shpool, <span class="keyword">sizeof</span>(<span class="keyword">ngx_ssl_session_cache_t</span>));</span><br><span class="line">    <span class="keyword">if</span> (cache == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    shpool-&gt;data = cache;</span><br><span class="line">    shm_zone-&gt;data = cache;</span><br><span class="line"></span><br><span class="line">    ngx_rbtree_init(&amp;cache-&gt;session_rbtree, &amp;cache-&gt;sentinel,</span><br><span class="line">                    ngx_ssl_session_rbtree_insert_value);</span><br><span class="line"></span><br><span class="line">    ngx_queue_init(&amp;cache-&gt;expire_queue);</span><br><span class="line"></span><br><span class="line">    len = <span class="keyword">sizeof</span>(<span class="string">&quot; in SSL session shared cache \&quot;\&quot;&quot;</span>) + shm_zone-&gt;shm.name.len;</span><br><span class="line"></span><br><span class="line">    shpool-&gt;log_ctx = ngx_slab_alloc(shpool, len);</span><br><span class="line">    <span class="keyword">if</span> (shpool-&gt;log_ctx == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ngx_sprintf(shpool-&gt;log_ctx, <span class="string">&quot; in SSL session shared cache \&quot;%V\&quot;%Z&quot;</span>,</span><br><span class="line">                &amp;shm_zone-&gt;shm.name);</span><br><span class="line"></span><br><span class="line">    shpool-&gt;log_nomem = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><code>ngx_ssl_new_session()</code>ç”¨äºåˆ›å»ºæ–°session cacheï¼Œæ¯æ¬¡åˆ›å»ºéƒ½ä¼šå…ˆå°è¯•æ·˜æ±°æœ€å¤š2ä¸ªè¿‡æœŸsessionï¼Œè¿™æ ·æ—¢ä¿è¯äº†cacheä¸ä¼šå †ç§¯ã€åˆæ˜¯æƒ°æ€§æ·˜æ±°ä¸ä¼šè®©äº‹ä»¶å ç”¨å¤ªé•¿æ—¶é—´ã€‚æ¯æ¬¡ç”³è¯·å¤±è´¥ï¼Œéƒ½æœ‰ä¸€æ¬¡å¼ºåˆ¶æ·˜æ±°çš„æœºä¼šã€‚å› ä¸ºåº•å±‚çš„slabæœºåˆ¶ï¼Œæ‰€ä»¥ä¸ç®¡æ·˜æ±°å‡ ä¸ªè¿‡æœŸçš„sessionéƒ½æ˜¯æ— æ³•ä¿è¯æ–°sessionä¸€å®šç”³è¯·æˆåŠŸçš„ã€‚é™¤éæ·˜æ±°çš„å¯¹è±¡è·Ÿæ–°åˆ†é…çš„å±äºåŒä¸€ä¸ªslotï¼Œæˆ–è€…æ·˜æ±°äº†å¯¹è±¡ä¹‹åæ­£å¥½ç©ºå‡ºäº†ä¸€ä¸ªé¡µã€‚</p>
<p>å› ä¸ºssl session cacheæœ¬æ¥å°±æ˜¯å±äºä¸€ç§ä¼˜åŒ–ï¼Œæ‰€ä»¥ä¼˜åŒ–å¤±è´¥ä¹Ÿæ˜¯æ­£å¸¸çš„ã€‚å¦‚æœæ¯”è¾ƒåœ¨æ„è¿™ä¸ªï¼Œé‚£ä¹ˆå½“å‡ºç°å¼ºåˆ¶æ·˜æ±°æ—¶å°±å·²ç»è¯´æ˜å…±äº«å†…å­˜ç©ºé—´ä¸å¤Ÿäº†ï¼Œéœ€è¦ç›¸åº”åœ°å¢åŠ ç¼“å­˜å®¹é‡æˆ–è€…å‡å°è¶…æ—¶æ—¶é—´ã€‚ç¼“å­˜å®¹é‡å’Œè¶…æ—¶æ—¶é—´åº”æ»¡è¶³ä¸‹é¢çš„å…³ç³»ï¼š</p>
<p><code>ç¼“å­˜å®¹é‡ &gt; âˆ‘ [( TPS / è¶…æ—¶æ—¶é—´ ) * å•ä¸ªå¤§å°]</code></p>
]]></content>
      <categories>
        <category>ç¼–ç¨‹å¼€å‘</category>
        <category>Nginx/OpenResty</category>
      </categories>
      <tags>
        <tag>Nginx</tag>
        <tag>slab</tag>
        <tag>å…±äº«å†…å­˜</tag>
      </tags>
  </entry>
  <entry>
    <title>VIMå¸¸ç”¨å¿«æ·é”®å’Œæ’ä»¶æ•´ç†</title>
    <url>/posts/d6ca5270/</url>
    <content><![CDATA[<div class="note primary">
            <p>æœ¬æ–‡ä¸ä¼šä»‹ç»åŸºæœ¬çš„VIMä½¿ç”¨æ–¹æ³•ï¼Œå¦‚æœä½ å¯¹VIMçš„å‡ ç§æ¨¡å¼ã€åŸºæœ¬çš„ç¼–è¾‘ã€ç§»åŠ¨å’Œé€‰å–ç­‰è¿˜ä¸äº†è§£ï¼Œæ¨èä½ å…ˆçœ‹ä¸€ä¸‹è¿™ç¯‡<a href="https://coolshell.cn/articles/5426.html">ç®€æ˜ VIM ç»ƒçº§æ”»ç•¥</a>ï¼Œå†™å¾—è¿˜æ˜¯ä¸é”™çš„ï¼ŒåŸºæœ¬ä¸Šæœ€å¸¸ç”¨çš„å‘½ä»¤éƒ½æœ‰äº†ã€‚å¦‚æœä½ ä¸æ˜¯vimé‡åº¦ç”¨æˆ·çš„è¯ï¼ŒçŸ¥é“è¿™äº›å‘½ä»¤å·²ç»è¶³å¤Ÿã€‚åªèƒ½è¯´vimçš„æ°´å¤ªæ·±ï¼Œæ ¹æ®è‡ªèº«æƒ…å†µåœ¨ç¼–è¾‘æ•ˆç‡å’Œå­¦ä¹ æˆæœ¬ä¹‹é—´åšä¸ªå¹³è¡¡å§ã€‚</p>
          </div>

<span id="more"></span>

<p>è¿™é‡Œæœ‰ä¸€ä¸ªvim cheat sheetå›¾ï¼Œå¯ä»¥ä½œä¸ºå¿«é€ŸæŸ¥é˜…ç”¨ã€‚è¦äº†è§£å…·ä½“çš„å‘½ä»¤æ¨èæŸ¥çœ‹vimçš„helpæ–‡æ¡£ï¼Œå†…å®¹å†™å¾—éå¸¸è¯¦ç»†ã€‚</p>
<p><img src="https://coolshell.cn/wp-content/uploads/2011/09/vim_cheat_sheet_for_programmers_print.png" alt="vim cheet sheet" loading="lazy"></p>
<h2 id="Vimç¼–è¾‘å‘½ä»¤ä¸€èˆ¬æ ¼å¼"><a href="#Vimç¼–è¾‘å‘½ä»¤ä¸€èˆ¬æ ¼å¼" class="headerlink" title="Vimç¼–è¾‘å‘½ä»¤ä¸€èˆ¬æ ¼å¼"></a>Vimç¼–è¾‘å‘½ä»¤ä¸€èˆ¬æ ¼å¼</h2><p>vimä¸­ç¼–è¾‘å‘½ä»¤çš„ç»“æ„</p>
<p><code>&lt;number&gt; &lt;operator&gt; &lt;number&gt; &lt;text object or motion&gt;</code></p>
<p>motionæˆ–å¯¹è±¡å‰å¯ä»¥åŒ…å«ä¸€ä¸ªæ•°å­—ï¼Œå¦‚æœoperatorå‰ä¹Ÿå¸¦äº†ä¸€ä¸ªæ•°å­—ï¼Œä¸¤è€…æ˜¯<strong>ç›¸ä¹˜</strong>çš„å…³ç³»ã€‚</p>
<p>ä¾‹å¦‚<code>2d3w</code>ï¼Œåˆ é™¤6ä¸ªå•è¯ã€‚</p>
<h2 id="æ“ä½œç¬¦"><a href="#æ“ä½œç¬¦" class="headerlink" title="æ“ä½œç¬¦"></a>æ“ä½œç¬¦</h2><p>æ“ä½œç¬¦ä¹Ÿæ˜¯å¯é€‰çš„ï¼Œå¦‚æœæ²¡æœ‰åˆ™å˜æˆäº†ç§»åŠ¨å‘½ä»¤ï¼Œè€Œéç¼–è¾‘å‘½ä»¤ã€‚</p>
<p>vimé»˜è®¤çš„operatoræœ‰</p>
<table>
<thead>
<tr>
<th>å‘½ä»¤</th>
<th>ä½œç”¨</th>
</tr>
</thead>
<tbody><tr>
<td><strong>c</strong></td>
<td>change</td>
</tr>
<tr>
<td><strong>d</strong></td>
<td>delete</td>
</tr>
<tr>
<td><strong>y</strong></td>
<td>yank into register</td>
</tr>
<tr>
<td>~</td>
<td>swap case (only if â€˜tildepâ€™ is set)</td>
</tr>
<tr>
<td>g~</td>
<td>swap case</td>
</tr>
<tr>
<td>gu</td>
<td>make lowercase</td>
</tr>
<tr>
<td>gU</td>
<td>make uppercase</td>
</tr>
<tr>
<td>!</td>
<td>filter through an external program</td>
</tr>
<tr>
<td>&#x3D;</td>
<td>filter through â€˜equalprgâ€™ or C-indenting if empty</td>
</tr>
<tr>
<td>gq</td>
<td>text formatting</td>
</tr>
<tr>
<td>g?</td>
<td>ROT13 encoding</td>
</tr>
<tr>
<td>&gt;</td>
<td>shift right</td>
</tr>
<tr>
<td>&lt;</td>
<td>shift left</td>
</tr>
<tr>
<td>zf</td>
<td>define a fold</td>
</tr>
<tr>
<td>g@</td>
<td>call function set with the â€˜operatorfuncâ€™ option</td>
</tr>
</tbody></table>
<p>æ“ä½œè¦ä¹ˆå½±å“æ•´è¡Œï¼Œè¦ä¹ˆå½±å“èµ·æ­¢ä½ç½®ä¹‹é—´çš„å­—ç¬¦ã€‚ç§»åŠ¨æœ‰inclusiveå’Œexclusiveä¹‹åˆ†ã€‚</p>
<p>å¦‚æœæ“ä½œpendingäº†ï¼ˆå³æ“ä½œç¬¦å·²ç»è¾“å…¥äº†ï¼Œmotionè¿˜æ²¡æœ‰ï¼‰ï¼Œæœ‰ä¸€äº›ç‰¹æ®Šæ˜ å°„å¯ä»¥ä½¿ç”¨ï¼ˆ:omapï¼‰ã€‚</p>
<p>motionä¹Ÿå¯ä»¥ä½¿ç”¨å‘½ä»¤ï¼Œä¾‹å¦‚<code>d:call FindEnd()</code>ï¼Œå¦‚æœå‘½ä»¤å¤šäºä¸€è¡Œä¸èƒ½é‡å¤ã€‚</p>
<p>å¯ä»¥åœ¨æ“ä½œç¬¦åè¾“å…¥<code>v</code>ã€<code>V</code>æˆ–<code>CTRL-V</code>ï¼Œå¼ºåˆ¶å°†motionè½¬æ¢ä¸ºé€å­—ç¬¦ã€é€è¡Œã€é€å—ã€‚å…¶ä¸­å¯¹äºvï¼Œå¦‚æœæœ¬èº«å°±æ˜¯é€å­—ç¬¦çš„ï¼Œåˆ™è½¬æ¢inclusive&#x2F;exclusiveã€‚</p>
<p>æ‰©å±•çš„æ“ä½œç¬¦ï¼š</p>
<table>
<thead>
<tr>
<th>å¿«æ·é”®</th>
<th>å‘½ä»¤</th>
<th>ä½œç”¨</th>
</tr>
</thead>
<tbody><tr>
<td>nnoremap Y</td>
<td>:CopyText&lt;cr&gt;</td>
<td>æ‹·è´åˆ°æŒ‡å®šå­—ç¬¦</td>
</tr>
<tr>
<td>nnoremap D</td>
<td>:DeleteText&lt;cr&gt;</td>
<td>åˆ é™¤åˆ°æŒ‡å®šå­—ç¬¦</td>
</tr>
<tr>
<td>nnoremap C</td>
<td>:ChangeText&lt;cr&gt;</td>
<td>æ”¹å†™åˆ°æŸä¸ªå­—ç¬¦</td>
</tr>
</tbody></table>
<p>æˆå¯¹ç¬¦å·çš„æ“ä½œï¼š</p>
<table>
<thead>
<tr>
<th>å¿«æ·é”®</th>
<th>ä¾‹å­</th>
<th>ä½œç”¨</th>
</tr>
</thead>
<tbody><tr>
<td>csâ€â€˜</td>
<td>â€œHello world!â€ -&gt; â€˜Hello world!â€™</td>
<td>â€œæ”¹æˆâ€˜</td>
</tr>
<tr>
<td>csâ€™&lt;q&gt;</td>
<td>â€˜Hello world!â€™ -&gt; &lt;q&gt;Hello world!&lt;&#x2F;q&gt;</td>
<td>â€˜æ”¹æˆ&lt;q&gt;å¯¹</td>
</tr>
<tr>
<td>cstâ€</td>
<td>&lt;q&gt;Hello world!&lt;&#x2F;q&gt; -&gt; â€œHello world!â€</td>
<td>&lt;q&gt;å¯¹æ”¹æˆâ€ï¼Œtè¡¨ç¤ºå®Œæ•´åŒ¹é…&lt;q&gt;</td>
</tr>
<tr>
<td>dsâ€</td>
<td>â€œHello world!â€ -&gt; Hello world!</td>
<td>å»æ‰â€</td>
</tr>
<tr>
<td>dst</td>
<td>&lt;q&gt;Hello world!&lt;&#x2F;q&gt; -&gt; Hello world!</td>
<td>tè¡¨ç¤ºå®Œæ•´åŒ¹é…&lt;q&gt;ï¼Œè€Œä¸æ˜¯å•ä¸ª&lt;</td>
</tr>
<tr>
<td>ysiw]</td>
<td>Hello world! -&gt; [Hello] world!</td>
<td>å…‰æ ‡æ‰€åœ¨å•è¯åŠ æ‹¬å·ï¼Œå³æ‹¬å·ä¸åŠ ç©ºæ ¼</td>
</tr>
<tr>
<td>ysiw{</td>
<td>Hello world! -&gt; { Hello } world!</td>
<td>å…‰æ ‡æ‰€åœ¨å•è¯åŠ æ‹¬å·ï¼Œå·¦æ‹¬å·åŠ ç©ºæ ¼</td>
</tr>
<tr>
<td>yss)</td>
<td>{ Hello } world! -&gt; ({ Hello } world!)</td>
<td>æ•´è¡ŒåŠ ()å¯¹</td>
</tr>
</tbody></table>
<p>å¯ä»¥è·Ÿvim-repeaté…åˆï¼Œä½¿ç”¨<code>.</code>é‡å¤ä¹‹å‰çš„æ“ä½œã€‚</p>
<h2 id="å·¦å³ç§»åŠ¨"><a href="#å·¦å³ç§»åŠ¨" class="headerlink" title="å·¦å³ç§»åŠ¨"></a>å·¦å³ç§»åŠ¨</h2><table>
<thead>
<tr>
<th>æ“ä½œç¬¦</th>
<th>ä½œç”¨</th>
<th>inclusive&#x2F;exclusive</th>
</tr>
</thead>
<tbody><tr>
<td><strong>h</strong></td>
<td>å·¦ç§»</td>
<td>e</td>
</tr>
<tr>
<td><strong>l</strong></td>
<td>å³ç§»</td>
<td>e</td>
</tr>
<tr>
<td><strong>0</strong></td>
<td>ç§»åˆ°è¡Œé¦–</td>
<td>e</td>
</tr>
<tr>
<td><strong>^</strong></td>
<td>ç§»åˆ°è¡Œé¦–ç¬¬ä¸€ä¸ªéç©ºå­—ç¬¦</td>
<td>e</td>
</tr>
<tr>
<td><strong>$</strong></td>
<td>ç§»åˆ°è¡Œå°¾</td>
<td>i</td>
</tr>
<tr>
<td>g_</td>
<td>ç§»åˆ°è¡Œå°¾ç¬¬ä¸€ä¸ªéç©ºå­—ç¬¦</td>
<td>i</td>
</tr>
<tr>
<td><strong>g0</strong></td>
<td>ç§»åˆ°å½“å‰è¡Œå±å¹•æœ€å·¦å­—ç¬¦</td>
<td>e</td>
</tr>
<tr>
<td>g^</td>
<td>ç§»åˆ°å±å¹•è¡Œç¬¬ä¸€ä¸ªéç©ºå­—ç¬¦</td>
<td>e</td>
</tr>
<tr>
<td>gm</td>
<td>ç±»ä¼¼g0ï¼Œä½†æ˜¯å±å¹•ç§»åŠ¨</td>
<td>e</td>
</tr>
<tr>
<td>g$</td>
<td>å±å¹•è¡Œçš„æœ€åä¸€ä¸ªéç©ºå­—ç¬¦</td>
<td>i</td>
</tr>
<tr>
<td><strong>ï½œ</strong></td>
<td>åˆ°å½“å‰è¡Œçš„å±å¹•ä¸­çš„ç¬¬[count]åˆ—</td>
<td>e</td>
</tr>
<tr>
<td><strong>f{char}</strong></td>
<td>ç§»åŠ¨åˆ°å³è¾¹ç¬¬[count]ä¸ª{char}å­—ç¬¦å‡ºç°å¤„</td>
<td>i</td>
</tr>
<tr>
<td><strong>F{char}</strong></td>
<td>ç§»åŠ¨åˆ°å·¦è¾¹ç¬¬[count]ä¸ª{char}å­—ç¬¦å‡ºç°å¤„</td>
<td>e</td>
</tr>
<tr>
<td><strong>t{char}</strong></td>
<td>ç§»åŠ¨åˆ°å³è¾¹ç¬¬[count]ä¸ª{char}å­—ç¬¦å‰</td>
<td>i</td>
</tr>
<tr>
<td><strong>T{char}</strong></td>
<td>ç§»åŠ¨åˆ°å·¦è¾¹ç¬¬[count]ä¸ª{char}å­—ç¬¦å</td>
<td>e</td>
</tr>
<tr>
<td>;</td>
<td>é‡å¤æœ€è¿‘ä¸€ä¸ªf,t,F,T [count]æ¬¡</td>
<td></td>
</tr>
<tr>
<td>,</td>
<td>é‡å¤æœ€è¿‘ä¸€ä¸ªf,t,F,T ç›¸åæ–¹å‘[count]æ¬¡</td>
<td></td>
</tr>
</tbody></table>
<h2 id="ä¸Šä¸‹ç§»åŠ¨"><a href="#ä¸Šä¸‹ç§»åŠ¨" class="headerlink" title="ä¸Šä¸‹ç§»åŠ¨"></a>ä¸Šä¸‹ç§»åŠ¨</h2><table>
<thead>
<tr>
<th>æ“ä½œç¬¦</th>
<th>ä½œç”¨</th>
<th>inclusive&#x2F;exclusive</th>
</tr>
</thead>
<tbody><tr>
<td><strong>k</strong></td>
<td>ä¸Šç§»</td>
<td>i</td>
</tr>
<tr>
<td><strong>j</strong></td>
<td>ä¸‹ç§»</td>
<td>i</td>
</tr>
<tr>
<td>gk</td>
<td>ä¸Šç§»æ˜¾ç¤ºè¡Œï¼Œè¡ŒæŠ˜å æ—¶æˆ–è€…ä¸æ“ä½œç¬¦ä½¿ç”¨æ—¶</td>
<td>e</td>
</tr>
<tr>
<td>gj</td>
<td>ä¸‹ç§»æ˜¾ç¤ºè¡Œ</td>
<td>e</td>
</tr>
<tr>
<td>-</td>
<td>ä¸Šç§»ï¼Œåœ¨ç¬¬ä¸€ä¸ªéç©ºå­—ç¬¦</td>
<td></td>
</tr>
<tr>
<td>_</td>
<td>ä¸‹ç§»[count] -1è¡Œï¼Œç¬¬ä¸€ä¸ªéç©ºå­—ç¬¦</td>
<td></td>
</tr>
<tr>
<td><strong>G</strong></td>
<td>åˆ°ç¬¬[count]è¡Œï¼Œé»˜è®¤æœ€åä¸€è¡Œï¼Œç¬¬ä¸€ä¸ªéç©ºå­—ç¬¦</td>
<td></td>
</tr>
<tr>
<td><strong>gg</strong></td>
<td>åˆ°ç¬¬[count]è¡Œï¼Œé»˜è®¤ç¬¬ä¸€è¡Œï¼Œç¬¬ä¸€ä¸ªéç©ºå­—ç¬¦</td>
<td></td>
</tr>
<tr>
<td>:[range]</td>
<td>å…‰æ ‡è·³åˆ°[range]çš„æœ€åä¸€è¡Œï¼Œç›¸æ¯”Gä¸æ”¹jumplist</td>
<td></td>
</tr>
<tr>
<td><strong>{count}%</strong></td>
<td>è·³åˆ°æ–‡ä»¶ç™¾åˆ†ä¹‹{count}å¤„ï¼Œç¬¬ä¸€ä¸ªéç©ºå­—ç¬¦</td>
<td></td>
</tr>
</tbody></table>
<h2 id="å•è¯ç§»åŠ¨"><a href="#å•è¯ç§»åŠ¨" class="headerlink" title="å•è¯ç§»åŠ¨"></a>å•è¯ç§»åŠ¨</h2><table>
<thead>
<tr>
<th>æ“ä½œç¬¦</th>
<th>ä½œç”¨</th>
<th>inclusive&#x2F;exclusive</th>
</tr>
</thead>
<tbody><tr>
<td><strong>w</strong></td>
<td>å¾€å‰[count]ä¸ªwords</td>
<td>e</td>
</tr>
<tr>
<td><strong>W</strong></td>
<td>å¾€å‰[count]ä¸ªWORDS</td>
<td>e</td>
</tr>
<tr>
<td><strong>e</strong></td>
<td>å¾€å‰åˆ°ç¬¬[count]ä¸ªwordsçš„æœ€åï¼Œç©ºè¡Œä¸åœ</td>
<td>i</td>
</tr>
<tr>
<td><strong>E</strong></td>
<td>å¾€å‰åˆ°ç¬¬[count]ä¸ªWORDSçš„æœ€åï¼Œç©ºè¡Œä¸åœ</td>
<td>i</td>
</tr>
<tr>
<td><strong>b</strong></td>
<td>å¾€å›[count]ä¸ªwords</td>
<td>e</td>
</tr>
<tr>
<td><strong>B</strong></td>
<td>å¾€å›[count]ä¸ªWORDS</td>
<td>e</td>
</tr>
<tr>
<td><strong>ge</strong></td>
<td>å¾€å›åˆ°ç¬¬[count]ä¸ªwordsçš„æœ€å</td>
<td>i</td>
</tr>
<tr>
<td><strong>gE</strong></td>
<td>å¾€å›åˆ°ç¬¬[count]ä¸ªWORDSçš„æœ€å</td>
<td>i</td>
</tr>
<tr>
<td><strong>&lt;leader&gt; w</strong></td>
<td>è·³åˆ°æŒ‡å®šå•è¯å¤„</td>
<td></td>
</tr>
</tbody></table>
<p>å…¶ä¸­<strong>word</strong>ç”±å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿çš„åºåˆ—ç»„æˆï¼Œæˆ–è€…å…¶ä»–éç©ºå­—ç¬¦çš„åºåˆ—ï¼Œä»¥ç©ºç™½ç¬¦åˆ†éš”ã€‚å¯ä»¥ç”¨<code>iskeyword</code>é€‰é¡¹ä¿®æ”¹ã€‚ç©ºè¡Œä¹Ÿå½“æˆä¸€ä¸ªwordã€‚</p>
<p><strong>WORD</strong>ç”±éç©ºå­—ç¬¦åºåˆ—ç»„æˆï¼Œä»¥ç©ºç™½ç¬¦åˆ†éš”ã€‚ç©ºè¡Œä¹Ÿå½“æˆä¸€ä¸ªWORDã€‚</p>
<p>ç‰¹æ®Šæƒ…å†µï¼š</p>
<ul>
<li><code>cw</code>å’Œ<code>cW</code>å½“ä½œ<code>ce</code>å’Œ<code>cE</code>å¤„ç†ï¼ˆå¦‚æœå…‰æ ‡åœ¨éç©ºå­—ç¬¦ä¸Šçš„è¯ï¼‰</li>
<li>å½“<code>w</code>è·Ÿæ“ä½œç¬¦ä¸€èµ·ä½¿ç”¨ï¼Œå½“æœ€åä¸€ä¸ªç§»è¿‡çš„å•è¯æ˜¯ä¸€è¡Œæœ€åæ—¶ï¼Œå•è¯å°¾éƒ¨æˆä¸ºæ“ä½œæ–‡æœ¬çš„å°¾éƒ¨ï¼Œä¸æ˜¯ä¸‹ä¸€è¡Œçš„å¼€å§‹ã€‚</li>
</ul>
<h2 id="æ–‡æœ¬å¯¹è±¡ç§»åŠ¨"><a href="#æ–‡æœ¬å¯¹è±¡ç§»åŠ¨" class="headerlink" title="æ–‡æœ¬å¯¹è±¡ç§»åŠ¨"></a>æ–‡æœ¬å¯¹è±¡ç§»åŠ¨</h2><table>
<thead>
<tr>
<th>æ“ä½œç¬¦</th>
<th>ä½œç”¨</th>
<th>inclusive&#x2F;exclusive</th>
</tr>
</thead>
<tbody><tr>
<td>(</td>
<td>å›ç§»[count]ä¸ªå¥å­</td>
<td>e</td>
</tr>
<tr>
<td>)</td>
<td>å‰ç§»[count]ä¸ªå¥å­</td>
<td>e</td>
</tr>
<tr>
<td>{</td>
<td>å›ç§»[count]ä¸ªæ®µè½</td>
<td>e</td>
</tr>
<tr>
<td>}</td>
<td>å‰ç§»[count]ä¸ªæ®µè½</td>
<td>e</td>
</tr>
<tr>
<td>]]</td>
<td>å‰ç§»[count]ä¸ªå°èŠ‚æˆ–ç¬¬1åˆ—ä¸­çš„ä¸‹ä¸€ä¸ªâ€˜{â€™ã€‚å¦‚æœå’Œæ“ä½œç¬¦ä¸€èµ·ä½¿ç”¨ï¼Œåˆ™ä¹Ÿåœåœ¨ç¬¬ä¸€åˆ—çš„â€™}â€™ä¸‹</td>
<td>e</td>
</tr>
<tr>
<td>][</td>
<td>å‰ç§»[count]ä¸ªå°èŠ‚æˆ–ç¬¬1åˆ—ä¸­çš„ä¸‹ä¸€ä¸ªâ€˜}â€™</td>
<td>e</td>
</tr>
<tr>
<td>[[</td>
<td>å›ç§»[count]ä¸ªå°èŠ‚æˆ–ç¬¬1åˆ—ä¸­çš„å‰ä¸€ä¸ªâ€˜{â€™</td>
<td>e</td>
</tr>
<tr>
<td>[]</td>
<td>å›ç§»[count]ä¸ªå°èŠ‚æˆ–ç¬¬1åˆ—ä¸­çš„å‰ä¸€ä¸ªâ€˜}â€™</td>
<td>e</td>
</tr>
</tbody></table>
<p><strong>å¥å­</strong>ï¼šç”±<code>.</code>æˆ–<code>!</code>æˆ–<code>?</code>ç»“å°¾ï¼Œåé¢è¦ä¹ˆæ—¶è¡Œå°¾ã€è¦ä¹ˆæ˜¯ç©ºæ ¼æˆ–tabã€‚<code>.</code>æˆ–<code>!</code>æˆ–<code>?</code>åé¢å¯ä»¥è·Ÿä»»æ„æ•°ç›®çš„â€™)â€™ã€â€™]â€™ã€â€™â€â€˜ã€â€™â€™â€™ã€‚</p>
<p><strong>æ®µè½</strong>ï¼šç”±ç©ºè¡Œä¹‹åå¼€å§‹ï¼Œæˆ–è€…ç”±æ®µè½å®å¼€å§‹ã€‚å°èŠ‚çš„è¾¹ç•Œä¹Ÿæ˜¯æ®µè½çš„è¾¹ç•Œã€‚æ³¨æ„ç©ºè¡Œä¸æ˜¯æ®µè½çš„è¾¹ç•Œã€‚</p>
<h2 id="æ–‡æœ¬çš„å¯¹è±¡é€‰å–"><a href="#æ–‡æœ¬çš„å¯¹è±¡é€‰å–" class="headerlink" title="æ–‡æœ¬çš„å¯¹è±¡é€‰å–"></a>æ–‡æœ¬çš„å¯¹è±¡é€‰å–</h2><p>è¿™æ˜¯ä¸€ç³»åˆ—åªèƒ½åœ¨visualæ¨¡å¼æˆ–è€…æ“ä½œç¬¦ä¹‹åæ‰èƒ½ç”¨çš„å‘½ä»¤ã€‚<code>a</code>å‘½ä»¤é€‰å–nä¸ªå¯¹è±¡ï¼ŒåŒ…æ‹¬ç©ºç™½ã€‚<code>i</code>å‘½ä»¤é€‰å–ä¸€ä¸ªå†…éƒ¨å¯¹è±¡ä¸å¸¦ç©ºç™½æˆ–è€…åªé€‰å–ç©ºç™½ï¼Œæ‰€ä»¥<code>i</code>å‘½ä»¤è‚¯å®šæ¯”<code>a</code>å‘½ä»¤é€‰å¾—å°‘ã€‚</p>
<p><code>v3aw</code>ï¼Œ<code>d2iw</code>ã€‚</p>
<p>å¯ä»¥è·Ÿå„ç§æ–‡æœ¬å¯¹è±¡ç»„åˆã€‚å¦‚aw, iw, aW, iW, as, iså¥å­, ap, ipæ®µè½, a], a[, i], i[æ˜¯[]å—ï¼Œa), a(, ab, i), i(, ibæ˜¯å—ï¼Œa&gt;, a&lt;, i&gt;, i&lt;æ˜¯å°–æ‹¬å·å—ï¼Œat, itæ˜¯tagå—ï¼Œa}, a{, aB, i}, i{, iBæ˜¯å—ï¼Œaâ€, aâ€™, a`,iâ€, iâ€™, i`æ˜¯å¼•ç”¨çš„å­—ç¬¦ä¸²ã€‚</p>
<p>æ‰©å±•æ–‡æœ¬å¯¹è±¡</p>
<table>
<thead>
<tr>
<th>æ“ä½œç¬¦</th>
<th>ä½œç”¨</th>
<th>inclusive&#x2F;exclusive</th>
</tr>
</thead>
<tbody><tr>
<td><strong>if</strong></td>
<td>å‡½æ•°æ–‡ä»¶å¯¹è±¡ï¼Œå†…éƒ¨ä»£ç å—</td>
<td></td>
</tr>
<tr>
<td><strong>af</strong></td>
<td>å‡½æ•°æ–‡ä»¶å¯¹è±¡ï¼Œæ•´ä¸ªå‡½æ•°</td>
<td></td>
</tr>
<tr>
<td>iF</td>
<td>å‡½æ•°å‚æ•°å¯¹è±¡ï¼Œæ•´ä¸ªå‡½æ•°</td>
<td></td>
</tr>
<tr>
<td><strong>aF</strong></td>
<td>å‡½æ•°å‚æ•°å¯¹è±¡ï¼Œæ•´ä¸ªå‡½æ•°åŒ…å«å‰åçš„ç©ºè¡Œ</td>
<td></td>
</tr>
<tr>
<td>i,</td>
<td>å†…éƒ¨å‚æ•°ï¼Œä¸åŒ…æ‹¬åé¢çš„é€—å·å’Œç©ºæ ¼</td>
<td></td>
</tr>
<tr>
<td>a,</td>
<td>å‚æ•°ï¼ŒåŒ…å«é€—å·å’Œç©ºæ ¼</td>
<td></td>
</tr>
</tbody></table>
<h3 id="å½“åœ¨æ“ä½œç¬¦åé¢ä½¿ç”¨æ—¶"><a href="#å½“åœ¨æ“ä½œç¬¦åé¢ä½¿ç”¨æ—¶" class="headerlink" title="å½“åœ¨æ“ä½œç¬¦åé¢ä½¿ç”¨æ—¶"></a>å½“åœ¨æ“ä½œç¬¦åé¢ä½¿ç”¨æ—¶</h3><ul>
<li><p>å¯¹äºéå—å¯¹è±¡</p>
<p>aç³»åˆ—å‘½ä»¤ï¼Œä½œç”¨äºå¯¹è±¡åŠå…¶åé¢çš„ç©ºç™½ã€‚å¦‚æœå¯¹è±¡åé¢æ²¡æœ‰ç©ºç™½æˆ–å…‰æ ‡åœ¨å¯¹è±¡ä¹‹å‰çš„ç©ºç™½ä¸Šï¼Œå¯¹è±¡å‰é¢çš„ç©ºç™½ä¹ŸåŒ…å«è¿›æ¥ã€‚</p>
<p>iç³»åˆ—å‘½ä»¤ï¼Œå¦‚æœå…‰æ ‡åœ¨å¯¹è±¡ä¸Šï¼Œä½œç”¨äºå¯¹è±¡ï¼›å¦‚æœå…‰æ ‡åœ¨ç©ºç™½ä¸Šï¼Œä½œç”¨äºç©ºç™½</p>
</li>
<li><p>å¯¹äºå—å¯¹è±¡</p>
<p>ä½œç”¨äºå…‰æ ‡æ‰€åœ¨çš„å—ï¼ˆå…‰æ ‡åœ¨å—å†…æˆ–æ‹¬å·ä¸Šï¼‰ã€‚aç³»åˆ—å‘½ä»¤åŒ…æ‹¬æ‹¬å·ï¼Œiç³»åˆ—ä¸åŒ…æ‹¬æ‹¬å·ã€‚</p>
</li>
</ul>
<h3 id="å½“åœ¨Visualæ¨¡å¼ä½¿ç”¨æ—¶"><a href="#å½“åœ¨Visualæ¨¡å¼ä½¿ç”¨æ—¶" class="headerlink" title="å½“åœ¨Visualæ¨¡å¼ä½¿ç”¨æ—¶"></a>å½“åœ¨Visualæ¨¡å¼ä½¿ç”¨æ—¶</h3><ul>
<li><p>å¦‚æœæ˜¯åˆšè¿›å…¥Visualæ¨¡å¼</p>
<p>é€‰æ‹©ä¸€ä¸ªå¯¹è±¡ï¼Œå°±è·Ÿå‰é¢ä½¿ç”¨æ“ä½œç¬¦æ—¶ä¸€æ ·</p>
</li>
<li><p>å¦‚æœä¸æ˜¯åˆšè¿›å…¥visualæ¨¡å¼</p>
<p>å¯¹äºéå—å¯¹è±¡ï¼ŒvisualåŒºåŸŸæ‰©å±•ä¸€ä¸ªå¯¹è±¡æˆ–ä¸‹ä¸€ä¸ªå¯¹è±¡å‰çš„ç©ºç™½ï¼Œæˆ–è€…æ‰©å±•ä¸¤è€…ã€‚é€‰å–æ–¹æ³•å–å†³äºå…‰æ ‡è¿åŠ¨æ–¹å‘ã€‚å¯¹äºå—å¯¹è±¡ï¼Œå¾€å¤–æ‰©å±•ä¸€å±‚ã€‚</p>
</li>
</ul>
<h3 id="ä¾‹å­"><a href="#ä¾‹å­" class="headerlink" title="ä¾‹å­"></a>ä¾‹å­</h3><p>ä¸‹é¢æ˜¯åˆ é™¤å‘½ä»¤ä¸ºä¾‹çš„ä¸€ä¸ªä¾‹å­</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&quot;dl&quot;    delete character (alias: &quot;x&quot;)           dl</span><br><span class="line">&quot;diw&quot;   delete inner word                       diw</span><br><span class="line">&quot;daw&quot;   delete a word                           daw</span><br><span class="line">&quot;diW&quot;   delete inner WORD (see WORD)            diW</span><br><span class="line">&quot;daW&quot;   delete a WORD (see WORD)                daW</span><br><span class="line">&quot;dgn&quot;   delete the next search pattern match    dgn</span><br><span class="line">&quot;dd&quot;    delete one line                         dd</span><br><span class="line">&quot;dis&quot;   delete inner sentence                   dis</span><br><span class="line">&quot;das&quot;   delete a sentence                       das</span><br><span class="line">&quot;dib&quot;   delete inner &#x27;(&#x27; &#x27;)&#x27; block              dib</span><br><span class="line">&quot;dab&quot;   delete a &#x27;(&#x27; &#x27;)&#x27; block                  dab</span><br><span class="line">&quot;dip&quot;   delete inner paragraph                  dip</span><br><span class="line">&quot;dap&quot;   delete a paragraph                      dap</span><br><span class="line">&quot;diB&quot;   delete inner &#x27;&#123;&#x27; &#x27;&#125;&#x27; block              diB</span><br><span class="line">&quot;daB&quot;   delete a &#x27;&#123;&#x27; &#x27;&#125;&#x27; block                  daB</span><br></pre></td></tr></table></figure>



<h2 id="æœç´¢æ›¿æ¢"><a href="#æœç´¢æ›¿æ¢" class="headerlink" title="æœç´¢æ›¿æ¢"></a>æœç´¢æ›¿æ¢</h2><p>ä¹Ÿæ˜¯å…‰æ ‡çš„è·³è½¬ã€‚åœ¨æŒ‰å›è½¦ä¹‹å‰å¯ä»¥æŒ‰<strong>ctrl+j&#x2F;k</strong>æ¥ä¸Šä¸‹é€‰æ‹©ã€‚</p>
<table>
<thead>
<tr>
<th>å¿«æ·é”®</th>
<th>å‘½ä»¤</th>
<th>ä½œç”¨</th>
</tr>
</thead>
<tbody><tr>
<td>map &#x2F;</td>
<td>&lt;Plug&gt;(incsearch-forward)</td>
<td>å¾€ä¸‹æœç´¢</td>
</tr>
<tr>
<td>map  ?</td>
<td>&lt;Plug&gt;(incsearch-backward)</td>
<td>å¾€ä¸Šæœç´¢</td>
</tr>
<tr>
<td>map g&#x2F;</td>
<td>&lt;Plug&gt;(incsearch-stay)</td>
<td>æŒ‰å›è½¦åå…‰æ ‡ä¸åŠ¨</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th>å¿«æ·é”®</th>
<th>å‘½ä»¤</th>
<th>ä½œç”¨</th>
</tr>
</thead>
<tbody><tr>
<td>nnoremap &lt;leader&gt;f</td>
<td>:LeaderfFile .&lt;cr&gt;</td>
<td>å½“å‰ç›®å½•ä¸‹æ–‡ä»¶æœç´¢ï¼Œtabé€‰æ‹©</td>
</tr>
<tr>
<td>nnoremap &lt;leader&gt;F</td>
<td>:Ack!&lt;space&gt;</td>
<td>æ–‡æœ¬æ­£åˆ™åŒ¹é…</td>
</tr>
<tr>
<td>rr</td>
<td></td>
<td>normalä¸‹æ›¿æ¢æ‰å…‰æ ‡æ‰€åœ¨å•è¯ï¼Œvisualæ›¿æ¢é€‰ä¸­æ–‡æœ¬</td>
</tr>
<tr>
<td>nnoremap &lt;leader&gt;r</td>
<td>:ReplaceTo&lt;space&gt;</td>
<td>å…¨æ–‡æ›¿æ¢å•è¯</td>
</tr>
</tbody></table>
<h2 id="æ–‡ä»¶è·³è½¬"><a href="#æ–‡ä»¶è·³è½¬" class="headerlink" title="æ–‡ä»¶è·³è½¬"></a>æ–‡ä»¶è·³è½¬</h2><table>
<thead>
<tr>
<th>å¿«æ·é”®</th>
<th>å‘½ä»¤</th>
<th>ä½œç”¨</th>
</tr>
</thead>
<tbody><tr>
<td>nnoremap &lt;leader&gt;U</td>
<td>:GoToFunImpl&lt;cr&gt;</td>
<td>è·³åˆ°å‡½æ•°å®ç°</td>
</tr>
<tr>
<td>nnoremap &lt;silent&gt; &lt;leader&gt;a</td>
<td>:Switch&lt;cr&gt;</td>
<td>C++å¤´æ–‡ä»¶å’Œæºæ–‡ä»¶åˆ‡æ¢</td>
</tr>
<tr>
<td>nnoremap &lt;leader&gt;u</td>
<td>:YcmCompleter GoToDeclaration&lt;cr&gt;</td>
<td>è·³è½¬çš„å‡½æ•°å£°æ˜</td>
</tr>
<tr>
<td>nnoremap &lt;leader&gt;o</td>
<td>:YcmCompleter GoToInclude&lt;cr&gt;</td>
<td>è·³è½¬åˆ°includeæ–‡ä»¶</td>
</tr>
<tr>
<td>Ctrl + ]</td>
<td></td>
<td>ctagsè·³è½¬åˆ°å‡½æ•°æˆ–å˜é‡å®šä¹‰å¤„</td>
</tr>
<tr>
<td>Ctrl + t</td>
<td></td>
<td>ctagsè¿”å›è·³è½¬å‰çš„åœ°æ–¹</td>
</tr>
</tbody></table>
<p>bufferåˆ‡æ¢</p>
<table>
<thead>
<tr>
<th>å¿«æ·é”®</th>
<th>å‘½ä»¤</th>
<th>ä½œç”¨</th>
</tr>
</thead>
<tbody><tr>
<td>nnoremap &lt;c-p&gt;</td>
<td>:PreviousBuffer&lt;cr&gt;</td>
<td>åˆ‡æ¢åˆ°ä¸Šä¸€ä¸ªbuffer</td>
</tr>
<tr>
<td>nnoremap &lt;c-n&gt;</td>
<td>:NextBuffer&lt;cr&gt;</td>
<td>åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªbuffer</td>
</tr>
<tr>
<td>nnoremap &lt;leader&gt;d</td>
<td>:CloseCurrentBuffer&lt;cr&gt;</td>
<td>å…³é—­å½“å‰buffer</td>
</tr>
<tr>
<td>nnoremap &lt;leader&gt;D</td>
<td>:BufOnly&lt;cr&gt;</td>
<td>åˆ é™¤é™¤å½“å‰bufferå¤–çš„æ‰€æœ‰buffer</td>
</tr>
</tbody></table>
<h2 id="git"><a href="#git" class="headerlink" title="git"></a>git</h2><p><code>:Git</code>ååŠ å¯¹åº”gitå‘½ä»¤ï¼Œè¿˜æœ‰ä¸€äº›æ‰©å±•å‘½ä»¤ï¼Œå¦‚<code>:Gread</code>ã€<code>:Ggrep</code>ç­‰ã€‚</p>
<p>git commitæµè§ˆå™¨ã€‚</p>
<table>
<thead>
<tr>
<th>å¿«æ·é”®</th>
<th>å‘½ä»¤</th>
<th>ä½œç”¨</th>
</tr>
</thead>
<tbody><tr>
<td>nnoremap &lt;leader&gt;g</td>
<td>:GV</td>
<td>æ‰“å¼€commitæµè§ˆå™¨ï¼Œå¯ä»¥åŠ git logé€‰é¡¹</td>
</tr>
<tr>
<td>nnoremap &lt;leader&gt;G</td>
<td>:GV!</td>
<td>åªåˆ—å‡ºå½±å“å½“å‰æ–‡ä»¶çš„commits</td>
</tr>
<tr>
<td>nnoremap &lt;leader&gt;gg</td>
<td>:GV?</td>
<td>å½“å‰æ–‡ä»¶revisionsçš„ä½ç½®åˆ—è¡¨</td>
</tr>
</tbody></table>
<p><code>:GV</code>å’Œ<code>:GV?</code>å¯ä»¥ç”¨äºvisualæ¨¡å¼ï¼Œè¿½è¸ªé€‰æ‹©è¡Œçš„å˜åŒ–ã€‚</p>
<p>åœ¨åˆ—è¡¨ä¸­ç•Œé¢</p>
<p><code>o</code>æˆ–<code>&lt;cr&gt;</code>ï¼Œå•ä¸ªcommitï¼Œæ˜¾ç¤ºå…¶å†…å®¹ã€‚</p>
<p><code>o</code>æˆ–<code>&lt;cr&gt;</code>ï¼Œå¤šä¸ªcommitsï¼Œæ˜¾ç¤ºæ‰€é€‰èŒƒå›´çš„å˜åŒ–</p>
<p><code>O</code>ï¼Œæ‰“å¼€ä¸€ä¸ªæ–°tabæ˜¾ç¤ºï¼Œè€Œä¸æ˜¯åˆ†éš”çª—å£</p>
<p><code>.</code>ï¼Œå½“å‰å…‰æ ‡æ‰€åœ¨commitï¼Œå¼€å§‹ä¸€æ¡å‘½ä»¤<code>:Git [CURSOR] SHA</code></p>
<p><code>q</code>æˆ–<code>gq</code>å…³é—­</p>
<h2 id="è‡ªåŠ¨ç”Ÿæˆä¸æ ¼å¼åŒ–"><a href="#è‡ªåŠ¨ç”Ÿæˆä¸æ ¼å¼åŒ–" class="headerlink" title="è‡ªåŠ¨ç”Ÿæˆä¸æ ¼å¼åŒ–"></a>è‡ªåŠ¨ç”Ÿæˆä¸æ ¼å¼åŒ–</h2><p>CPPè¾…åŠ©</p>
<table>
<thead>
<tr>
<th>å¿«æ·é”®</th>
<th>å‘½ä»¤</th>
<th>ä½œç”¨</th>
</tr>
</thead>
<tbody><tr>
<td>nnoremap &lt;leader&gt;y</td>
<td>:CopyCode&lt;cr&gt;</td>
<td>æ‹·è´å‡½æ•°æˆ–å˜é‡</td>
</tr>
<tr>
<td>nnoremap &lt;leader&gt;p</td>
<td>:PasteCode&lt;cr&gt;</td>
<td>ç”Ÿæˆå‡½æ•°å®ç°æˆ–å˜é‡å®šä¹‰</td>
</tr>
<tr>
<td>nnoremap &lt;leader&gt;&lt;leader&gt;fp</td>
<td>:FormatFunParam&lt;cr&gt;</td>
<td>æ ¼å¼åŒ–å‡½æ•°å‚æ•°</td>
</tr>
<tr>
<td>nnoremap &lt;leader&gt;&lt;leader&gt;if</td>
<td>:FormatIf&lt;cr&gt;</td>
<td>æ ¼å¼åŒ–if-else</td>
</tr>
<tr>
<td>nnoremap &lt;leader&gt;&lt;leader&gt;t</td>
<td>:GenTryCatch&lt;cr&gt;</td>
<td>ç”Ÿæˆtry-catchå—</td>
</tr>
</tbody></table>
<p>æ–‡æœ¬å¯¹é½ã€‚</p>
<table>
<thead>
<tr>
<th>å¿«æ·é”®</th>
<th>å‘½ä»¤</th>
<th>ä½œç”¨</th>
</tr>
</thead>
<tbody><tr>
<td>nnoremap &lt;leader&gt;&#x3D;</td>
<td>:Tab &#x2F;&#x3D;&lt;cr&gt;</td>
<td>å…³äº&#x3D;å·å¯¹é½</td>
</tr>
<tr>
<td></td>
<td>:Tab &#x2F;,&#x2F;r1c1l0&lt;cr&gt;</td>
<td>é€—å·åˆ†éš”ï¼Œå³å¯¹é½ç©ºä¸€ä¸ªï¼Œä¸­å¯¹é½ç©ºä¸€æ ¼å·¦å¯¹é½ä¸ç©º</td>
</tr>
</tbody></table>
<p>å¿«é€Ÿæ³¨é‡Š</p>
<table>
<thead>
<tr>
<th>å¿«æ·é”®</th>
<th>å‘½ä»¤</th>
<th>ä½œç”¨</th>
</tr>
</thead>
<tbody><tr>
<td>gcc</td>
<td></td>
<td>å•è¡Œæ³¨é‡Š</td>
</tr>
<tr>
<td>gc</td>
<td></td>
<td>visualæ¨¡å¼æ³¨é‡Šé€‰æ‹©è¡Œ</td>
</tr>
<tr>
<td>gcap</td>
<td></td>
<td>æ³¨é‡Šä¸€æ•´æ®µ</td>
</tr>
<tr>
<td>:7,17Commentary</td>
<td></td>
<td>æ³¨é‡Šæ‰€é€‰è¡Œ</td>
</tr>
<tr>
<td>gcgc</td>
<td></td>
<td>å»æ‰æ‰€æœ‰ç›¸é‚»æ³¨é‡Šè¡Œçš„æ³¨é‡Š</td>
</tr>
</tbody></table>
<p>æ–°å»ºæ–‡ä»¶æ—¶æ¨¡ç‰ˆ<code>~/.vim/plugged/prepare-code/snippet</code></p>
<h2 id="vimä¸shelläº¤äº’"><a href="#vimä¸shelläº¤äº’" class="headerlink" title="vimä¸shelläº¤äº’"></a>vimä¸shelläº¤äº’</h2><ul>
<li><code>:!command</code></li>
</ul>
<p>ä¸é€€å‡ºvimï¼Œæ‰§è¡Œshellå‘½ä»¤ï¼Œä¾‹å¦‚<code>:!ls -l</code></p>
<ul>
<li><code>:!!</code></li>
</ul>
<p>æ‰§è¡Œä¸Šä¸€æ¬¡çš„å‘½ä»¤</p>
<ul>
<li><code>:r !command </code>æˆ–<code>!!command</code></li>
</ul>
<p>å°†å‘½ä»¤æ‰§è¡Œç»“æœæ’å…¥åˆ°å½“å‰è¡Œçš„ä¸‹ä¸€è¡Œï¼Œä¾‹å¦‚<code>:r date</code></p>
<ul>
<li><code>:start,end !command</code></li>
</ul>
<p>å°†æŒ‡å®šè¡ŒèŒƒå›´ä¸­çš„å†…å®¹è¾“å…¥åˆ°shellå‘½ä»¤è¿›è¡Œå¤„ç†ï¼Œå¹¶ç”¨è¾“å‡ºç»“æœæ›¿æ¢æŒ‡å®šå†…å®¹ï¼Œä¾‹å¦‚<code>:62,72 !sort</code>ã€‚</p>
<p>å¯ä»¥åªæŒ‡å®šå•è¡Œï¼Œ<code>:62 !tr &quot;[a-z]&quot; &quot;[A-Z]&quot;</code>ï¼Œå°†62è¡Œè½¬æˆå¤§å†™å­—æ¯ã€‚</p>
<p>å½“å‰è¡Œå¯ä»¥ç”¨<code>.</code>è¡¨ç¤ºï¼Œä¾‹å¦‚<code>. !tr &quot;[a-z]&quot; &quot;[A-Z]&quot;</code></p>
<ul>
<li><code>:start,end w !command</code></li>
</ul>
<p>å°†æŒ‡å®šè¡ŒèŒƒå›´ä¸­çš„å†…å®¹è¾“å…¥åˆ°shellå‘½ä»¤è¿›è¡Œå¤„ç†ï¼Œä½†æ˜¯åªæ˜¯æ˜¾ç¤ºç»“æœï¼Œä¸ä¼šæ”¹å˜å½“å‰æ–‡ä»¶çš„å†…å®¹ã€‚ä¾‹å¦‚ï¼Œ<code>:62,72 w !sort</code></p>
<ul>
<li><code>:shell</code></li>
</ul>
<p>ä¸é€€å‡ºvimï¼Œæ–°å¼€ä¸€ä¸ªshellï¼Œexitä¹‹åå›åˆ°vimã€‚</p>
<ul>
<li><code>:terminal</code>æˆ–<code>:vertical :term</code></li>
</ul>
<p>åœ¨æ–°å»ºçš„åˆ†å‰²çª—å£ä¸­è¿›å…¥ç»ˆç«¯ã€‚å¯ä»¥ç”¨<code>Ctrl-W N</code>æˆ–<code>Ctrl-\ Ctrl-N</code>åœ¨ç»ˆç«¯bufferä¸­è¿›å…¥Normalæ¨¡å¼ï¼Œæ³¨æ„å‰è€…çš„Næ˜¯å¤§å†™çš„ï¼Œéœ€è¦æŒ‰ä½shiftã€‚Terminal-Normalæ¨¡å¼ä¸‹å¯ä»¥é€‰æ‹©å¤åˆ¶æ–‡æœ¬ã€‚ç‚¹å‡»<code>i</code>é”®å¯ä»¥è¿”å›åˆ°Terminal-Jobæ¨¡å¼ã€‚</p>
<h2 id="å…¶ä»–å‘½ä»¤"><a href="#å…¶ä»–å‘½ä»¤" class="headerlink" title="å…¶ä»–å‘½ä»¤"></a>å…¶ä»–å‘½ä»¤</h2><table>
<thead>
<tr>
<th>å¿«æ·é”®</th>
<th>å‘½ä»¤</th>
<th>ä½œç”¨</th>
</tr>
</thead>
<tbody><tr>
<td>nnoremap &lt;silent&gt;&lt;leader&gt;t</td>
<td>:TagBarToggle .&lt;cr&gt;</td>
<td>æ˜¾å¼å³è¾¹æ ï¼Œæ–¹æ³•å˜é‡</td>
</tr>
<tr>
<td>nnoremap &lt;silent&gt;&lt;leader&gt;n</td>
<td>:NERDTreeToggle .&lt;cr&gt;</td>
<td>æ˜¾å¼å·¦è¾¹æ ï¼Œæ–‡ä»¶ç›®å½•</td>
</tr>
<tr>
<td>nnoremap &lt;leader&gt;ff</td>
<td>:YcmCompleter FixIt&lt;cr&gt;</td>
<td>è‡ªåŠ¨ä¿®å¤é”™è¯¯</td>
</tr>
<tr>
<td>nmap &lt;F5&gt;</td>
<td>:YcmDiags&lt;cr&gt;</td>
<td>è¯Šæ–­é”™è¯¯</td>
</tr>
</tbody></table>
<h2 id="å¿«æ·é”®æ˜ å°„"><a href="#å¿«æ·é”®æ˜ å°„" class="headerlink" title="å¿«æ·é”®æ˜ å°„"></a>å¿«æ·é”®æ˜ å°„</h2><p>mapç³»åˆ—å‘½ä»¤è¯­æ³•</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[&lt;mode&gt;][nore]map [&lt;args&gt;] &#123;lhs&#125; &#123;rhs&#125;</span><br></pre></td></tr></table></figure>

<p>ç¬¬ä¸€ä¸ªå¯é€‰å­—ç¬¦è¡¨ç¤ºæ¨¡å¼</p>
<table>
<thead>
<tr>
<th>å­—ç¬¦</th>
<th>æ¨¡å¼</th>
</tr>
</thead>
<tbody><tr>
<td>n</td>
<td>normal only</td>
</tr>
<tr>
<td>v</td>
<td>visual and select</td>
</tr>
<tr>
<td>o</td>
<td>operator-pending</td>
</tr>
<tr>
<td>x</td>
<td>visual only</td>
</tr>
<tr>
<td>s</td>
<td>select only</td>
</tr>
<tr>
<td>i</td>
<td>insert</td>
</tr>
<tr>
<td>c</td>
<td>command-line</td>
</tr>
<tr>
<td>l</td>
<td>insert, command-line, regexp-search</td>
</tr>
</tbody></table>
<p>noremap    ä¸é€’å½’æ˜ å°„</p>
<p>ä¾‹å¦‚ï¼Œä¸‹é¢çš„ä¾‹å­æ˜¯æ­£å¸¸çš„</p>
<p>noremap    Y y</p>
<p>noremap    y Y</p>
<p>å¸¸ç”¨çš„å‚æ•°æœ‰</p>
<p><code>&lt;silent&gt;</code>è¡¨ç¤ºé™é»˜æ˜ å°„ï¼Œä¸ä¼šæ˜¾ç¤ºVimåœ¨å¤„ç†rhsè¿‡ç¨‹ä¸­å¯¹ç•Œé¢äº§ç”Ÿçš„å˜åŒ–ã€‚</p>
<p><code>&lt;buffer&gt;</code>è¡¨ç¤ºè¿™ä¸ªæ˜ å°„åªæ˜¯åœ¨å½“å‰çš„bufferä¸­å®šä¹‰ï¼Œè€Œä¸æ˜¯å®šä¹‰å…¨å±€çš„æ˜ å°„</p>
<p><code>&lt;expr&gt;</code> è¡¨ç¤º{rhs}æ˜¯ä¸€ä¸ª<code>Vimè¡¨è¾¾å¼</code> ï¼Œè€Œä¸æ˜¯æŒ‰é”®åºåˆ—ï¼Œè§ä¸‹æ–‡</p>
<p>è¡¨è¾¾å¼çš„ä¾‹å­å¦‚ä¸‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">noremap  &lt;expr&gt;0     col(&#x27;.&#x27;) == 1 ? &#x27;^&#x27;: &#x27;0&#x27;</span><br></pre></td></tr></table></figure>

<p>åœ¨normalæˆ–visualæ¨¡å¼ä¸‹ï¼ŒæŒ‰0é”®å¯ä»¥å®ç°è®©å…‰æ ‡åœ¨é¦–åˆ—å’Œé¦–ä¸ªéç©ºç™½å­—ç¬¦ä¹‹é—´çš„åˆ‡æ¢ã€‚</p>
<h2 id="æ’ä»¶æ•´ç†"><a href="#æ’ä»¶æ•´ç†" class="headerlink" title="æ’ä»¶æ•´ç†"></a>æ’ä»¶æ•´ç†</h2><p><a href="https://github.com/chxuan/vimplus">vimplus</a>æ˜¯ä¸€ä¸ªvimè‡ªåŠ¨é…ç½®å·¥å…·ï¼ŒåŸºæœ¬ä¸ŠåŒ…å«äº†ä¸‹é¢æ‰€æœ‰çš„æ’ä»¶ï¼Œå¯ä»¥å‚»ç“œå¼ä¸€é”®å®‰è£…ä½¿ç”¨ã€‚</p>
<h3 id="ctags"><a href="#ctags" class="headerlink" title="ctags"></a>ctags</h3><p>è·³è½¬åˆ°æ ‡ç­¾å®šä¹‰å¤„ï¼Œéœ€è¦äº‹å…ˆç”Ÿæˆç´¢å¼•æ–‡ä»¶</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ctags -R .</span><br></pre></td></tr></table></figure>



<table>
<thead>
<tr>
<th>å¿«æ·é”®</th>
<th>ç”¨æ³•</th>
</tr>
</thead>
<tbody><tr>
<td>Ctrl + ]</td>
<td>è·³è½¬åˆ°å‡½æ•°æˆ–å˜é‡å®šä¹‰å¤„</td>
</tr>
<tr>
<td>Ctrl + t</td>
<td>è¿”å›è·³è½¬å‰çš„åœ°æ–¹</td>
</tr>
</tbody></table>
<p>æ³¨æ„åªæœ‰åœ¨ç´¢å¼•æ‰€åœ¨ç›®å½•ä¸‹æ‰èƒ½å®ç°è·³è½¬</p>
<h3 id="chxuan-x2F-cpp-mode"><a href="#chxuan-x2F-cpp-mode" class="headerlink" title="chxuan&#x2F;cpp-mode"></a><a href="https://github.com/chxuan/cpp-mode">chxuan&#x2F;cpp-mode</a></h3><p>æä¾›ç”Ÿæˆå‡½æ•°å®ç°ã€å‡½æ•°å£°æ˜&#x2F;å®ç°è·³è½¬ã€.h .cppåˆ‡æ¢ç­‰åŠŸèƒ½</p>
<table>
<thead>
<tr>
<th>å¿«æ·é”®</th>
<th>å‘½ä»¤</th>
<th>ä½œç”¨</th>
</tr>
</thead>
<tbody><tr>
<td>nnoremap &lt;leader&gt;y</td>
<td>:CopyCode&lt;cr&gt;</td>
<td>æ‹·è´å‡½æ•°æˆ–å˜é‡</td>
</tr>
<tr>
<td>nnoremap &lt;leader&gt;p</td>
<td>:PasteCode&lt;cr&gt;</td>
<td>ç”Ÿæˆå‡½æ•°å®ç°æˆ–å˜é‡å®šä¹‰</td>
</tr>
<tr>
<td>nnoremap &lt;leader&gt;U</td>
<td>:GoToFunImpl&lt;cr&gt;</td>
<td>è·³åˆ°å‡½æ•°å®ç°</td>
</tr>
<tr>
<td>nnoremap &lt;silent&gt; &lt;leader&gt;a</td>
<td>:Switch&lt;cr&gt;</td>
<td>C++å¤´æ–‡ä»¶å’Œæºæ–‡ä»¶åˆ‡æ¢</td>
</tr>
<tr>
<td>nnoremap &lt;leader&gt;&lt;leader&gt;fp</td>
<td>:FormatFunParam&lt;cr&gt;</td>
<td>æ ¼å¼åŒ–å‡½æ•°å‚æ•°</td>
</tr>
<tr>
<td>nnoremap &lt;leader&gt;&lt;leader&gt;if</td>
<td>:FormatIf&lt;cr&gt;</td>
<td>æ ¼å¼åŒ–if-else</td>
</tr>
<tr>
<td>nnoremap &lt;leader&gt;&lt;leader&gt;t</td>
<td>:GenTryCatch&lt;cr&gt;</td>
<td>ç”Ÿæˆtry-catchå—</td>
</tr>
</tbody></table>
<h3 id="chxuan-x2F-vim-edit"><a href="#chxuan-x2F-vim-edit" class="headerlink" title="chxuan&#x2F;vim-edit"></a><a href="https://github.com/chxuan/vim-edit">chxuan&#x2F;vim-edit</a></h3><table>
<thead>
<tr>
<th>å¿«æ·é”®</th>
<th>å‘½ä»¤</th>
<th>ä½œç”¨</th>
</tr>
</thead>
<tbody><tr>
<td>nnoremap Y</td>
<td>:CopyText&lt;cr&gt;</td>
<td>æ‹·è´åˆ°æŒ‡å®šå­—ç¬¦</td>
</tr>
<tr>
<td>nnoremap D</td>
<td>:DeleteText&lt;cr&gt;</td>
<td>åˆ é™¤åˆ°æŒ‡å®šå­—ç¬¦</td>
</tr>
<tr>
<td>nnoremap C</td>
<td>:ChangeText&lt;cr&gt;</td>
<td>æ”¹å†™åˆ°æŸä¸ªå­—ç¬¦</td>
</tr>
<tr>
<td>rr</td>
<td></td>
<td>normalä¸‹æ›¿æ¢æ‰å…‰æ ‡æ‰€åœ¨å•è¯ï¼Œvisualæ›¿æ¢é€‰ä¸­æ–‡æœ¬</td>
</tr>
<tr>
<td>nnoremap &lt;leader&gt;r</td>
<td>:ReplaceTo&lt;space&gt;</td>
<td>å…¨æ–‡æ›¿æ¢å•è¯</td>
</tr>
</tbody></table>
<h3 id="chxuan-x2F-prepare-code"><a href="#chxuan-x2F-prepare-code" class="headerlink" title="chxuan&#x2F;prepare-code"></a><a href="https://github.com/chxuan/prepare-code">chxuan&#x2F;prepare-code</a></h3><p>æ–°å»ºæ–‡ä»¶æ—¶è‡ªåŠ¨ç”Ÿæˆä»£ç ï¼Œæ¨¡æ¿åœ¨<code>~/.vim/plugged/prepare-code/snippet</code>ç›®å½•ä¸‹</p>
<h3 id="chxuan-x2F-vim-buffer"><a href="#chxuan-x2F-vim-buffer" class="headerlink" title="chxuan&#x2F;vim-buffer"></a><a href="https://github.com/chxuan/vim-buffer">chxuan&#x2F;vim-buffer</a></h3><p>bufferåˆ‡æ¢</p>
<table>
<thead>
<tr>
<th>å¿«æ·é”®</th>
<th>å‘½ä»¤</th>
<th>ä½œç”¨</th>
</tr>
</thead>
<tbody><tr>
<td>nnoremap &lt;c-p&gt;</td>
<td>:PreviousBuffer&lt;cr&gt;</td>
<td>åˆ‡æ¢åˆ°ä¸Šä¸€ä¸ªbuffer</td>
</tr>
<tr>
<td>nnoremap &lt;c-n&gt;</td>
<td>:NextBuffer&lt;cr&gt;</td>
<td>åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªbuffer</td>
</tr>
<tr>
<td>nnoremap &lt;leader&gt;d</td>
<td>:CloseCurrentBuffer&lt;cr&gt;</td>
<td>å…³é—­å½“å‰buffer</td>
</tr>
<tr>
<td>nnoremap &lt;leader&gt;D</td>
<td>:BufOnly&lt;cr&gt;</td>
<td>åˆ é™¤é™¤å½“å‰bufferå¤–çš„æ‰€æœ‰buffer</td>
</tr>
</tbody></table>
<h3 id="preservim-x2F-tagbar"><a href="#preservim-x2F-tagbar" class="headerlink" title="preservim&#x2F;tagbar"></a><a href="https://github.com/preservim/tagbar">preservim&#x2F;tagbar</a></h3><p>å³è¾¹æ ï¼Œæ˜¾å¼æ–¹æ³•å˜é‡</p>
<table>
<thead>
<tr>
<th>å¿«æ·é”®</th>
<th>å‘½ä»¤</th>
<th>ä½œç”¨</th>
</tr>
</thead>
<tbody><tr>
<td>nnoremap &lt;silent&gt;&lt;leader&gt;t</td>
<td>:TagBarToggle .&lt;cr&gt;</td>
<td>æ˜¾å¼å³è¾¹æ </td>
</tr>
</tbody></table>
<h3 id="ycm-core-x2F-YouCompleteMe"><a href="#ycm-core-x2F-YouCompleteMe" class="headerlink" title="ycm-core&#x2F;YouCompleteMe"></a><a href="https://github.com/ycm-core/YouCompleteMe">ycm-core&#x2F;YouCompleteMe</a></h3><table>
<thead>
<tr>
<th>å¿«æ·é”®</th>
<th>å‘½ä»¤</th>
<th>ä½œç”¨</th>
</tr>
</thead>
<tbody><tr>
<td>nnoremap &lt;leader&gt;u</td>
<td>:YcmCompleter GoToDeclaration&lt;cr&gt;</td>
<td>è·³è½¬çš„å‡½æ•°å£°æ˜</td>
</tr>
<tr>
<td>nnoremap &lt;leader&gt;o</td>
<td>:YcmCompleter GoToInclude&lt;cr&gt;</td>
<td>è·³è½¬åˆ°includeæ–‡ä»¶</td>
</tr>
<tr>
<td>nnoremap &lt;leader&gt;ff</td>
<td>:YcmCompleter FixIt&lt;cr&gt;</td>
<td>è‡ªåŠ¨ä¿®å¤é”™è¯¯</td>
</tr>
<tr>
<td>nmap &lt;F5&gt;</td>
<td>:YcmDiags&lt;cr&gt;</td>
<td>è¯Šæ–­é”™è¯¯</td>
</tr>
</tbody></table>
<h3 id="Yggdroot-x2F-LeaderF"><a href="#Yggdroot-x2F-LeaderF" class="headerlink" title="Yggdroot&#x2F;LeaderF"></a><a href="https://github.com/Yggdroot/LeaderF">Yggdroot&#x2F;LeaderF</a></h3><p>æ–‡ä»¶æ¨¡ç³Šæœç´¢ï¼ŒæŒ‰tabè¿›è¡Œé€‰æ‹©</p>
<table>
<thead>
<tr>
<th>å¿«æ·é”®</th>
<th>å‘½ä»¤</th>
<th>ä½œç”¨</th>
</tr>
</thead>
<tbody><tr>
<td>nnoremap &lt;leader&gt;f</td>
<td>:LeaderfFile .&lt;cr&gt;</td>
<td>å½“å‰ç›®å½•ä¸‹æ–‡ä»¶æœç´¢ï¼Œtabé€‰æ‹©</td>
</tr>
</tbody></table>
<h3 id="mileszs-x2F-ack-vim"><a href="#mileszs-x2F-ack-vim" class="headerlink" title="mileszs&#x2F;ack.vim"></a><a href="https://github.com/mileszs/ack.vim">mileszs&#x2F;ack.vim</a></h3><p>ackæ–‡æœ¬æœç´¢</p>
<table>
<thead>
<tr>
<th>å¿«æ·é”®</th>
<th>å‘½ä»¤</th>
<th>ä½œç”¨</th>
</tr>
</thead>
<tbody><tr>
<td>nnoremap &lt;leader&gt;F</td>
<td>:Ack!&lt;space&gt;</td>
<td>æ–‡æœ¬æ­£åˆ™åŒ¹é…</td>
</tr>
</tbody></table>
<p>!è¡¨ç¤ºä¸è‡ªåŠ¨è·³åˆ°ç¬¬ä¸€ä¸ªåŒ¹é…ã€‚</p>
<p>å¯ä»¥è€ƒè™‘æ›¿æ¢æˆ[junegunn&#x2F;fzf.vim]ï¼Œä½¿ç”¨rg&#x2F;agæ›´å¿«ã€‚</p>
<h3 id="easymotion-x2F-vim-easymotion"><a href="#easymotion-x2F-vim-easymotion" class="headerlink" title="easymotion&#x2F;vim-easymotion"></a><a href="https://github.com/easymotion/vim-easymotion">easymotion&#x2F;vim-easymotion</a></h3><p>normalæ¨¡å¼å…‰æ ‡å¿«é€Ÿè·³è½¬ï¼Œvisualæ¨¡å¼é€‰æ‹©åˆ°æŒ‡å®šä½ç½®ã€‚</p>
<table>
<thead>
<tr>
<th>å¿«æ·é”®</th>
<th>å‘½ä»¤</th>
<th>ä½œç”¨</th>
</tr>
</thead>
<tbody><tr>
<td>map &lt;leader&gt;w</td>
<td>&lt;Plug&gt;(easymotion-bd-w)</td>
<td>é€‰å–è‡³æŒ‡å®šä½ç½®</td>
</tr>
<tr>
<td>nmap &lt;leader&gt;w</td>
<td>&lt;Plug&gt;(easymotion-overwin-w)</td>
<td>è·³è½¬åˆ°æŒ‡å®šä½ç½®</td>
</tr>
</tbody></table>
<h3 id="haya14busa-x2F-incsearch-vim"><a href="#haya14busa-x2F-incsearch-vim" class="headerlink" title="haya14busa&#x2F;incsearch.vim"></a><a href="https://github.com/haya14busa/incsearch.vim">haya14busa&#x2F;incsearch.vim</a></h3><p>æ–‡æœ¬æœç´¢ï¼Œå…¶å®è·Ÿå‰ä¸€ä¸ªç±»ä¼¼ï¼Œä¹Ÿæ˜¯å…‰æ ‡çš„è·³è½¬ã€‚</p>
<p>åœ¨æŒ‰å›è½¦ä¹‹å‰å¯ä»¥æŒ‰ctrl+j&#x2F;kæ¥ä¸Šä¸‹é€‰æ‹©ã€‚</p>
<table>
<thead>
<tr>
<th>å¿«æ·é”®</th>
<th>å‘½ä»¤</th>
<th>ä½œç”¨</th>
</tr>
</thead>
<tbody><tr>
<td>map &#x2F;</td>
<td>&lt;Plug&gt;(incsearch-forward)</td>
<td>å¾€ä¸‹æœç´¢</td>
</tr>
<tr>
<td>map  ?</td>
<td>&lt;Plug&gt;(incsearch-backward)</td>
<td>å¾€ä¸Šæœç´¢</td>
</tr>
<tr>
<td>map g&#x2F;</td>
<td>&lt;Plug&gt;(incsearch-stay)</td>
<td>æŒ‰å›è½¦åå…‰æ ‡ä¸åŠ¨</td>
</tr>
</tbody></table>
<h3 id="jiangmiao-x2F-auto-pairs"><a href="#jiangmiao-x2F-auto-pairs" class="headerlink" title="jiangmiao&#x2F;auto-pairs"></a><a href="https://github.com/jiangmiao/auto-pairs">jiangmiao&#x2F;auto-pairs</a></h3><p>è‡ªåŠ¨è¡¥å…¨æˆå¯¹ç¬¦å·</p>
<h3 id="preservim-x2F-nerdtree"><a href="#preservim-x2F-nerdtree" class="headerlink" title="preservim&#x2F;nerdtree"></a><a href="https://github.com/preservim/nerdtree">preservim&#x2F;nerdtree</a></h3><p>æ˜¾å¼å·¦è¾¹æ ï¼Œç›®å½•ã€‚</p>
<table>
<thead>
<tr>
<th>å¿«æ·é”®</th>
<th>å‘½ä»¤</th>
<th>ä½œç”¨</th>
</tr>
</thead>
<tbody><tr>
<td>nnoremap &lt;silent&gt;&lt;leader&gt;n</td>
<td>:NERDTreeToggle .&lt;cr&gt;</td>
<td>æ˜¾å¼å·¦è¾¹æ </td>
</tr>
</tbody></table>
<h3 id="vim-nerdtree-syntax-highlight"><a href="#vim-nerdtree-syntax-highlight" class="headerlink" title="vim-nerdtree-syntax-highlight"></a><a href="https://github.com/tiagofumo/vim-nerdtree-syntax-highlight">vim-nerdtree-syntax-highlight</a></h3><p>å·¦è¾¹æ æ–‡ä»¶ç±»å‹é«˜äº®</p>
<h3 id="godlygeek-x2F-tabular"><a href="#godlygeek-x2F-tabular" class="headerlink" title="godlygeek&#x2F;tabular"></a><a href="https://github.com/godlygeek/tabular">godlygeek&#x2F;tabular</a></h3><p>æ–‡æœ¬å¯¹é½ã€‚</p>
<table>
<thead>
<tr>
<th>å¿«æ·é”®</th>
<th>å‘½ä»¤</th>
<th>ä½œç”¨</th>
</tr>
</thead>
<tbody><tr>
<td>nnoremap &lt;leader&gt;&#x3D;</td>
<td>:Tab &#x2F;&#x3D;&lt;cr&gt;</td>
<td>å…³äº&#x3D;å·å¯¹é½</td>
</tr>
<tr>
<td></td>
<td>:Tab &#x2F;,&#x2F;r1c1l0&lt;cr&gt;</td>
<td>é€—å·åˆ†éš”ï¼Œå³å¯¹é½ç©ºä¸€ä¸ªï¼Œä¸­å¯¹é½ç©ºä¸€æ ¼å·¦å¯¹é½ä¸ç©º</td>
</tr>
</tbody></table>
<p>é»˜è®¤æ˜¯å·¦å¯¹é½ï¼Œä¸‹ä¸€ä¸ªå­—æ®µå‰ç©ºä¸€æ ¼ã€‚å¯ä»¥é€šè¿‡ä¸€ä¸ªå­—æ¯åŠ æ•°å­—æŒ‡å®šæ ¼å¼ï¼Œå…¶ä¸­l&#x2F;c&#x2F;råˆ†åˆ«è¡¨ç¤ºå·¦å¯¹é½&#x2F;å±…ä¸­å¯¹é½&#x2F;å³å¯¹é½ï¼Œç´§è·Ÿçš„æ•°å­—è¡¨ç¤ºä¸‹ä¸€ä¸ªå­—æ®µå‰æ’å…¥çš„ç©ºæ ¼æ•°ã€‚å¦‚æœæŒ‡å®šäº†å¤šä¸ªæ ¼å¼ä¼šä¾æ¬¡ä½¿ç”¨ï¼Œç”¨å®Œäº†å†ä»ç¬¬ä¸€ä¸ªå¼€å§‹ã€‚æ³¨æ„è¿™ä¸ªåˆ†éš”ç¬¦æœ¬èº«ä¹Ÿç®—ä¸€ä¸ªå­—æ®µã€‚åˆ†éš”ç¬¦å¹¶ä¸ä¸€å®šæ˜¯å•ä¸ªå­—ç¬¦ï¼Œå…¶å®å¯ä»¥æ˜¯æ­£åˆ™è¡¨è¾¾å¼ã€‚</p>
<h3 id="tpope-x2F-vim-fugitive"><a href="#tpope-x2F-vim-fugitive" class="headerlink" title="tpope&#x2F;vim-fugitive"></a><a href="https://github.com/tpope/vim-fugitive">tpope&#x2F;vim-fugitive</a></h3><p>é›†æˆGitï¼Œ<code>:Git</code>ååŠ å¯¹åº”gitå‘½ä»¤ï¼Œè¿˜æœ‰ä¸€äº›æ‰©å±•å‘½ä»¤ï¼Œå¦‚<code>:Gread</code>ã€<code>:Ggrep</code>ç­‰ã€‚</p>
<h3 id="tpope-x2F-vim-surround"><a href="#tpope-x2F-vim-surround" class="headerlink" title="tpope&#x2F;vim-surround"></a><a href="https://github.com/tpope/vim-surround">tpope&#x2F;vim-surround</a></h3><table>
<thead>
<tr>
<th>å¿«æ·é”®</th>
<th>ä¾‹å­</th>
<th>ä½œç”¨</th>
</tr>
</thead>
<tbody><tr>
<td>csâ€â€˜</td>
<td>â€œHello world!â€ -&gt; â€˜Hello world!â€™</td>
<td>â€œæ”¹æˆâ€˜</td>
</tr>
<tr>
<td>csâ€™&lt;q&gt;</td>
<td>â€˜Hello world!â€™ -&gt; &lt;q&gt;Hello world!&lt;&#x2F;q&gt;</td>
<td>â€˜æ”¹æˆ&lt;q&gt;å¯¹</td>
</tr>
<tr>
<td>cstâ€</td>
<td>&lt;q&gt;Hello world!&lt;&#x2F;q&gt; -&gt; â€œHello world!â€</td>
<td>&lt;q&gt;å¯¹æ”¹æˆâ€ï¼Œtè¡¨ç¤ºå®Œæ•´åŒ¹é…&lt;q&gt;</td>
</tr>
<tr>
<td>dsâ€</td>
<td>â€œHello world!â€ -&gt; Hello world!</td>
<td>å»æ‰â€</td>
</tr>
<tr>
<td>dst</td>
<td>&lt;q&gt;Hello world!&lt;&#x2F;q&gt; -&gt; Hello world!</td>
<td>tè¡¨ç¤ºå®Œæ•´åŒ¹é…&lt;q&gt;ï¼Œè€Œä¸æ˜¯å•ä¸ª&lt;</td>
</tr>
<tr>
<td>ysiw]</td>
<td>Hello world! -&gt; [Hello] world!</td>
<td>å…‰æ ‡æ‰€åœ¨å•è¯åŠ æ‹¬å·ï¼Œå³æ‹¬å·ä¸åŠ ç©ºæ ¼</td>
</tr>
<tr>
<td>ysiw{</td>
<td>Hello world! -&gt; { Hello } world!</td>
<td>å…‰æ ‡æ‰€åœ¨å•è¯åŠ æ‹¬å·ï¼Œå·¦æ‹¬å·åŠ ç©ºæ ¼</td>
</tr>
<tr>
<td>yss)</td>
<td>{ Hello } world! -&gt; ({ Hello } world!)</td>
<td>æ•´è¡ŒåŠ ()å¯¹</td>
</tr>
</tbody></table>
<p>å¯ä»¥è·Ÿvim-repeaté…åˆï¼Œä½¿ç”¨<code>.</code>é‡å¤ä¹‹å‰çš„æ“ä½œã€‚</p>
<h3 id="tpope-x2F-vim-commentary"><a href="#tpope-x2F-vim-commentary" class="headerlink" title="tpope&#x2F;vim-commentary"></a><a href="https://github.com/tpope/vim-commentary">tpope&#x2F;vim-commentary</a></h3><p>å¿«é€Ÿæ³¨é‡Š</p>
<table>
<thead>
<tr>
<th>å¿«æ·é”®</th>
<th>å‘½ä»¤</th>
<th>ä½œç”¨</th>
</tr>
</thead>
<tbody><tr>
<td>gcc</td>
<td></td>
<td>å•è¡Œæ³¨é‡Š</td>
</tr>
<tr>
<td>gc</td>
<td></td>
<td>visualæ¨¡å¼æ³¨é‡Šé€‰æ‹©è¡Œ</td>
</tr>
<tr>
<td>gcap</td>
<td></td>
<td>æ³¨é‡Šä¸€æ•´æ®µ</td>
</tr>
<tr>
<td>:7,17Commentary</td>
<td></td>
<td>æ³¨é‡Šæ‰€é€‰è¡Œ</td>
</tr>
<tr>
<td>gcgc</td>
<td></td>
<td>å»æ‰æ‰€æœ‰ç›¸é‚»æ³¨é‡Šè¡Œçš„æ³¨é‡Š</td>
</tr>
</tbody></table>
<h3 id="tpope-x2F-vim-repeat"><a href="#tpope-x2F-vim-repeat" class="headerlink" title="tpope&#x2F;vim-repeat"></a><a href="https://github.com/tpope/vim-repeat">tpope&#x2F;vim-repeat</a></h3><p><code>.</code>æ“ä½œæ”¯æŒmapï¼Œæ”¯æŒtpope&#x2F;vim-repeatç­‰æ’ä»¶ã€‚</p>
<h3 id="tpope-x2F-vim-endwise"><a href="#tpope-x2F-vim-endwise" class="headerlink" title="tpope&#x2F;vim-endwise"></a><a href="https://github.com/tpope/vim-endwise">tpope&#x2F;vim-endwise</a></h3><p>if doç­‰å°¾éƒ¨è¡¥å…¨</p>
<h3 id="octol-x2F-vim-cpp-enhanced-highlight"><a href="#octol-x2F-vim-cpp-enhanced-highlight" class="headerlink" title="octol&#x2F;vim-cpp-enhanced-highlight"></a><a href="https://github.com/octol/vim-cpp-enhanced-highlight">octol&#x2F;vim-cpp-enhanced-highlight</a></h3><p>cppé¢å¤–çš„è¯­æ³•é«˜äº®ï¼Œå¢åŠ äº†æ ‡å‡†åº“&#x2F;boostå‡½æ•°ã€å®¹å™¨ã€ç±»å‹çš„é«˜äº®ã€‚</p>
<h3 id="vim-airline-x2F-vim-airline"><a href="#vim-airline-x2F-vim-airline" class="headerlink" title="vim-airline&#x2F;vim-airline"></a><a href="https://github.com/vim-airline/vim-airline">vim-airline&#x2F;vim-airline</a></h3><p>çŠ¶æ€æ ç¾åŒ–</p>
<h3 id="vim-airline-x2F-vim-airline-themes"><a href="#vim-airline-x2F-vim-airline-themes" class="headerlink" title="vim-airline&#x2F;vim-airline-themes"></a><a href="https://github.com/vim-airline/vim-airline-themes">vim-airline&#x2F;vim-airline-themes</a></h3><p>çŠ¶æ€æ ä¸»é¢˜åº“</p>
<h3 id="ryanoasis-x2F-vim-devicons"><a href="#ryanoasis-x2F-vim-devicons" class="headerlink" title="ryanoasis&#x2F;vim-devicons"></a><a href="https://github.com/ryanoasis/vim-devicons">ryanoasis&#x2F;vim-devicons</a></h3><p>æ˜¾ç¤ºæ–‡ä»¶ç±»å‹å›¾è¡¨</p>
<h3 id="junegunn-x2F-vim-slash"><a href="#junegunn-x2F-vim-slash" class="headerlink" title="junegunn&#x2F;vim-slash"></a><a href="https://github.com/junegunn/vim-slash">junegunn&#x2F;vim-slash</a></h3><p>å…‰æ ‡ç§»åŠ¨åæ¸…é™¤æœç´¢çš„é«˜äº®</p>
<h3 id="junegunn-x2F-gv-vim"><a href="#junegunn-x2F-gv-vim" class="headerlink" title="junegunn&#x2F;gv.vim"></a><a href="https://github.com/junegunn/gv.vim">junegunn&#x2F;gv.vim</a></h3><p>git commitæµè§ˆå™¨ã€‚</p>
<table>
<thead>
<tr>
<th>å¿«æ·é”®</th>
<th>å‘½ä»¤</th>
<th>ä½œç”¨</th>
</tr>
</thead>
<tbody><tr>
<td>nnoremap &lt;leader&gt;g</td>
<td>:GV</td>
<td>æ‰“å¼€commitæµè§ˆå™¨ï¼Œå¯ä»¥åŠ git logé€‰é¡¹</td>
</tr>
<tr>
<td>nnoremap &lt;leader&gt;G</td>
<td>:GV!</td>
<td>åªåˆ—å‡ºå½±å“å½“å‰æ–‡ä»¶çš„commits</td>
</tr>
<tr>
<td>nnoremap &lt;leader&gt;gg</td>
<td>:GV?</td>
<td>å½“å‰æ–‡ä»¶revisionsçš„ä½ç½®åˆ—è¡¨</td>
</tr>
</tbody></table>
<p><code>:GV</code>å’Œ<code>:GV?</code>å¯ä»¥ç”¨äºvisualæ¨¡å¼ï¼Œè¿½è¸ªé€‰æ‹©è¡Œçš„å˜åŒ–ã€‚</p>
<p>åœ¨åˆ—è¡¨ä¸­ç•Œé¢</p>
<p><code>o</code>æˆ–<code>&lt;cr&gt;</code>ï¼Œå•ä¸ªcommitï¼Œæ˜¾ç¤ºå…¶å†…å®¹ã€‚</p>
<p><code>o</code>æˆ–<code>&lt;cr&gt;</code>ï¼Œå¤šä¸ªcommitsï¼Œæ˜¾ç¤ºæ‰€é€‰èŒƒå›´çš„å˜åŒ–</p>
<p><code>O</code>ï¼Œæ‰“å¼€ä¸€ä¸ªæ–°tabæ˜¾ç¤ºï¼Œè€Œä¸æ˜¯åˆ†éš”çª—å£</p>
<p><code>.</code>ï¼Œå½“å‰å…‰æ ‡æ‰€åœ¨commitï¼Œå¼€å§‹ä¸€æ¡å‘½ä»¤<code>:Git [CURSOR] SHA</code></p>
<p><code>q</code>æˆ–<code>gq</code>å…³é—­</p>
<h3 id="kana-x2F-vim-textobj-user"><a href="#kana-x2F-vim-textobj-user" class="headerlink" title="kana&#x2F;vim-textobj-user"></a><a href="https://github.com/kana/vim-textobj-user">kana&#x2F;vim-textobj-user</a></h3><p>è‡ªå®šä¹‰æ–‡æœ¬å¯¹è±¡ã€‚ä¾‹å¦‚ä¸‹é¢å®šä¹‰äº†<code>ad</code>&#x2F;<code>id</code>é€‰å–ä¸€ä¸ªæ—¥æœŸå¦‚<code>2013-03-16</code>ï¼Œ<code>at</code>&#x2F;<code>it</code>é€‰å–ä¸€ä¸ªæ—¶é—´å¦‚<code>22:04:21</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">call textobj#user#plugin(&#x27;datetime&#x27;, &#123;</span><br><span class="line">\   &#x27;date&#x27;: &#123;</span><br><span class="line">\     &#x27;pattern&#x27;: &#x27;\&lt;\d\d\d\d-\d\d-\d\d\&gt;&#x27;,</span><br><span class="line">\     &#x27;select&#x27;: [&#x27;ad&#x27;, &#x27;id&#x27;],</span><br><span class="line">\   &#125;,</span><br><span class="line">\   &#x27;time&#x27;: &#123;</span><br><span class="line">\     &#x27;pattern&#x27;: &#x27;\&lt;\d\d:\d\d:\d\d\&gt;&#x27;,</span><br><span class="line">\     &#x27;select&#x27;: [&#x27;at&#x27;, &#x27;it&#x27;],</span><br><span class="line">\   &#125;,</span><br><span class="line">\ &#125;)</span><br></pre></td></tr></table></figure>

<h3 id="kana-x2F-vim-textobj-indent"><a href="#kana-x2F-vim-textobj-indent" class="headerlink" title="kana&#x2F;vim-textobj-indent"></a><a href="https://github.com/kana/vim-textobj-indent">kana&#x2F;vim-textobj-indent</a></h3><p> indented blocks of linesçš„æ–‡æœ¬å¯¹è±¡ï¼Œä¸çŸ¥é“ä»–æŒ‡çš„å•¥</p>
<h3 id="kana-x2F-vim-textobj-syntax"><a href="#kana-x2F-vim-textobj-syntax" class="headerlink" title="kana&#x2F;vim-textobj-syntax"></a><a href="https://github.com/kana/vim-textobj-syntax">kana&#x2F;vim-textobj-syntax</a></h3><p>è¯­æ³•é«˜äº®é¡¹ç›®çš„æ–‡æœ¬å¯¹è±¡</p>
<h3 id="kana-x2F-vim-textobj-function"><a href="#kana-x2F-vim-textobj-function" class="headerlink" title="kana&#x2F;vim-textobj-function"></a><a href="https://github.com/kana/vim-textobj-function">kana&#x2F;vim-textobj-function</a></h3><p>å‡½æ•°çš„æ–‡æœ¬å¯¹è±¡ï¼Œaf if aF iF</p>
<h3 id="sgur-x2F-vim-textobj-parameter"><a href="#sgur-x2F-vim-textobj-parameter" class="headerlink" title="sgur&#x2F;vim-textobj-parameter"></a><a href="https://github.com/sgur/vim-textobj-parameter">sgur&#x2F;vim-textobj-parameter</a></h3><p>å‡½æ•°å‚æ•°æ–‡æœ¬å¯¹è±¡ï¼Œé»˜è®¤æ˜¯a, i,</p>
<h3 id="Shougo-x2F-echodoc-vim"><a href="#Shougo-x2F-echodoc-vim" class="headerlink" title="Shougo&#x2F;echodoc.vim"></a><a href="https://github.com/Shougo/echodoc.vim">Shougo&#x2F;echodoc.vim</a></h3><p>è¡¥å…¨æ—¶åœ¨å‘½ä»¤è¡Œæ˜¾ç¤ºå‡½æ•°ç­¾åã€‚</p>
<h3 id="rhysd-x2F-clever-f-vim"><a href="#rhysd-x2F-clever-f-vim" class="headerlink" title="rhysd&#x2F;clever-f.vim"></a><a href="https://github.com/rhysd/clever-f.vim">rhysd&#x2F;clever-f.vim</a></h3><p>å¢å¼ºçš„f&#x2F;F&#x2F;t&#x2F;Tï¼Œå¤šæ¬¡è¿ç»­å¯ä»¥åªæŒ‰ä¸€ä¸ªå­—ç¬¦ï¼Œä¸ç¬¬ä¸€å¤§å°å†™ç›¸åŒåˆ™åŒæ–¹å‘ï¼Œå¦åˆ™åæ–¹å‘ã€‚</p>
<h3 id="vim-scripts-x2F-indentpython-vim"><a href="#vim-scripts-x2F-indentpython-vim" class="headerlink" title="vim-scripts&#x2F;indentpython.vim"></a><a href="https://github.com/vim-scripts/indentpython.vim">vim-scripts&#x2F;indentpython.vim</a></h3><p>pythonç¼©è¿›è„šæœ¬</p>
<h3 id="rhysd-x2F-github-complete-vim"><a href="#rhysd-x2F-github-complete-vim" class="headerlink" title="rhysd&#x2F;github-complete.vim"></a><a href="https://github.com/rhysd/github-complete.vim">rhysd&#x2F;github-complete.vim</a></h3><p>githubè¡¥å…¨ï¼ŒåŒ…æ‹¬emojiã€ç”¨æˆ·åã€ä»“åº“åã€issueå·ã€é“¾æ¥URLè¡¥å…¨ã€‚</p>
<h3 id="DrwaIt"><a href="#DrwaIt" class="headerlink" title="DrwaIt"></a><a href="">DrwaIt</a></h3><p>vimç”»å›¾å·¥å…·ï¼Œ</p>
<table>
<thead>
<tr>
<th>å¿«æ·é”®</th>
<th>å‘½ä»¤</th>
<th>ä½œç”¨</th>
</tr>
</thead>
<tbody><tr>
<td>&lt;leader&gt;di</td>
<td>:DrawIt</td>
<td>å¼€å§‹ç”»å›¾æ¨¡å¼</td>
</tr>
<tr>
<td>&lt;leader&gt;ds</td>
<td>:DIstop</td>
<td>ç»“æŸç”»å›¾æ¨¡å¼</td>
</tr>
<tr>
<td>&lt;leader&gt;a é€‰æ‹©æ¨¡å¼</td>
<td></td>
<td>ç”»ç®­å¤´</td>
</tr>
<tr>
<td>&lt;leader&gt;b é€‰æ‹©æ¨¡å¼</td>
<td></td>
<td>ç”»çŸ©å½¢</td>
</tr>
<tr>
<td>&lt;leader&gt;e é€‰æ‹©æ¨¡å¼</td>
<td></td>
<td>ç”»æ¤­åœ†</td>
</tr>
<tr>
<td>&lt;leader&gt;l é€‰æ‹©æ¨¡å¼</td>
<td></td>
<td>ç”»ç›´çº¿</td>
</tr>
<tr>
<td>&lt;leader&gt;c</td>
<td></td>
<td>ç”»å¸ƒå¢å¤§</td>
</tr>
<tr>
<td>&lt;leader&gt;f</td>
<td></td>
<td>å­—ç¬¦æŸä¸ªå¡«å……</td>
</tr>
<tr>
<td>&lt;leader&gt;s</td>
<td></td>
<td>è¿½åŠ ç©ºæ ¼è‡³æ–‡æœ¬å®½åº¦ï¼ˆé»˜è®¤78ï¼‰</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>space</td>
<td></td>
<td>åˆ‡æ¢ç”»å›¾&#x2F;æ“¦é™¤æ¨¡å¼</td>
</tr>
<tr>
<td>r&#x2F;R</td>
<td></td>
<td>æ›¿æ¢æ¨¡å¼</td>
</tr>
<tr>
<td>&lt;&gt;^v</td>
<td></td>
<td>æ’å…¥ç®­å¤´ï¼Œå‰é¢åŠ &lt;leader&gt;ç²—ç®­å¤´</td>
</tr>
</tbody></table>
<h3 id="dense-analysis-x2F-ale"><a href="#dense-analysis-x2F-ale" class="headerlink" title="dense-analysis&#x2F;ale"></a><a href="https://github.com/dense-analysis/ale">dense-analysis&#x2F;ale</a></h3>]]></content>
      <categories>
        <category>å·¥å…·</category>
      </categories>
      <tags>
        <tag>Vim</tag>
      </tags>
  </entry>
  <entry>
    <title>å¦‚ä½•åœ¨è£¸æœºä¸Šç›´æ¥è¿è¡Œç¨‹åºâ€”ç‹çˆ½ã€Šæ±‡ç¼–è¯­è¨€ã€‹è¯¾ç¨‹è®¾è®¡2</title>
    <url>/posts/8054db72/</url>
    <content><![CDATA[<div class="note primary">
            <p>å¹³å¸¸æˆ‘ä»¬çš„ç¨‹åºåŸºæœ¬éƒ½æ˜¯è¿è¡Œåœ¨æ“ä½œç³»ç»Ÿä¹‹ä¸Šï¼Œå¾ˆå°‘æœ‰æœºä¼šç›´æ¥åœ¨è£¸æœºä¸Šè¿è¡Œç¨‹åºã€‚ç°ä»£æ“ä½œç³»ç»Ÿéœ€è¦æ”¯æŒå¤šä»»åŠ¡ç¯å¢ƒçš„å·¥ä½œæ–¹å¼ï¼Œè¿™è¦æ±‚CPUåœ¨ç¡¬ä»¶ä¸Šæä¾›æ”¯æŒã€‚ä»¥Intelå¤„ç†å™¨ä¸ºä¾‹ï¼Œä»80286&#x2F;80386å¼€å§‹ï¼ŒCPUå¼€å§‹æ”¯æŒå·¥ä½œåœ¨ä¿æŠ¤æ¨¡å¼ï¼Œä¸ºå¤šä»»åŠ¡ç¯å¢ƒæä¾›ä¿æŠ¤æœºåˆ¶ã€‚</p><p>æ“ä½œç³»ç»Ÿä¸ºæˆ‘ä»¬æä¾›äº†ä¿æŠ¤å’ŒæŠ½è±¡ï¼Œè¿™æ–¹ä¾¿äº†å¼€å‘å’Œä½¿ç”¨ï¼Œä½†æ˜¯åŒæ—¶ä¹Ÿå¯¹å­¦ä¹ è€…äº†è§£è®¡ç®—æœºåº•å±‚å·¥ä½œåŸç†é€ æˆäº†ä¸€å®šçš„éšœç¢ã€‚æœ¬æ–‡é€šè¿‡ç¼–ç å®è·µç‹çˆ½è€å¸ˆã€Šæ±‡ç¼–è¯­è¨€ã€‹ä¸­çš„è¯¾ç¨‹è®¾è®¡2ï¼Œä¸å¯„å­˜å™¨ã€å†…å­˜ã€æ˜¾å­˜ã€ä¸­æ–­ã€å¤–è®¾ç­‰è¿›è¡Œäº†è¿‘è·ç¦»çš„äº²å¯†æ¥è§¦ï¼Œé€šè¿‡è¿™æ¬¡å®è·µä¹Ÿç®—æ˜¯å…¥é—¨æ±‡ç¼–äº†å§ã€‚</p>
          </div>

<span id="more"></span>

<h2 id="èƒŒæ™¯çŸ¥è¯†"><a href="#èƒŒæ™¯çŸ¥è¯†" class="headerlink" title="èƒŒæ™¯çŸ¥è¯†"></a>èƒŒæ™¯çŸ¥è¯†</h2><p>è®¡ç®—æœºä¸Šç”µä¹‹åï¼ŒCPUè‡ªåŠ¨ä»FFFF:0å•å…ƒå¤„å¼€å§‹æ‰§è¡Œï¼Œè¿™é‡Œæœ‰ä¸€æ¡è·³è½¬æŒ‡ä»¤ï¼ŒCPUè½¬å»æ‰§è¡ŒBIOSä¸­çš„ç¡¬ä»¶ç³»ç»Ÿæ£€æµ‹å’Œåˆå§‹åŒ–ç¨‹åºã€‚åˆå§‹åŒ–ç¨‹åºå°†ä»0:0å•å…ƒå¤„å¼€å§‹å»ºç«‹ä¸­æ–­å‘é‡è¡¨ã€‚ç¡¬ä»¶ç³»ç»Ÿæ£€æµ‹å’Œåˆå§‹åŒ–å®Œæˆä¹‹åï¼Œè°ƒç”¨int 19hè¿›è¡Œæ“ä½œç³»ç»Ÿå¼•å¯¼ã€‚ä»è½¯ç›˜æˆ–ç¡¬ç›˜ç¬¬ä¸€ä¸ªæ‰‡åŒºè¯»å–å†…å®¹åˆ°0:7c00ï¼Œç„¶åCS:IPæŒ‡å‘0:7c00å¼€å§‹æ‰§è¡Œã€‚</p>
<p>è¿™ä¸ªè¯¾ç¨‹è®¾è®¡çš„ä»»åŠ¡å°±æ˜¯ç¼–å†™ä¸€ä¸ªå¯ä»¥ç›´æ¥åœ¨è£¸æœºä¸Šè¿è¡Œçš„ç¨‹åºï¼Œå…·ä½“åŠŸèƒ½å¦‚ä¸‹ï¼š</p>
<ol>
<li>åˆ—å‡ºåŠŸèƒ½é€‰é¡¹ï¼Œè®©ç”¨æˆ·é€šè¿‡é”®ç›˜è¿›è¡Œé€‰æ‹©ï¼Œç•Œé¢å¦‚ä¸‹ã€‚<ol>
<li>reset pc            ; é‡æ–°å¯åŠ¨è®¡ç®—æœº</li>
<li>start system                ; å¼•å¯¼ç°æœ‰çš„æ“ä½œç³»ç»Ÿ</li>
<li>clock                             ; è¿›å…¥æ—¶é’Ÿç¨‹åº</li>
<li>set clock                       ; è®¾ç½®æ—¶é’Ÿ</li>
</ol>
</li>
<li>ç”¨æˆ·è¾“å…¥â€œ1â€åé‡æ–°å¯åŠ¨è®¡ç®—æœºï¼ˆé‡æ–°è·³è½¬åˆ°ffff:0å•å…ƒï¼‰</li>
<li>ç”¨æˆ·è¾“å…¥â€œ2â€åå¼•å¯¼ç°æœ‰çš„æ“ä½œç³»ç»Ÿï¼ˆè¯»å–ç¡¬ç›˜Cçš„0é“0é¢1æ‰‡åŒºè¿›è¡Œå¼•å¯¼ï¼‰</li>
<li>ç”¨æˆ·è¾“å…¥â€œ3â€åï¼Œæ‰§è¡ŒåŠ¨æ€æ˜¾ç¤ºå½“å‰æ—¥æœŸã€æ—¶é—´çš„ç¨‹åºï¼ˆå¾ªç¯è¯»å–CMOSï¼‰ï¼Œæ ¼å¼ï¼šå¹´&#x2F;æœˆ&#x2F;æ—¥ æ—¶:åˆ†:ç§’ã€‚æŒ‰ä¸‹F1é”®åï¼Œæ”¹å˜æ˜¾ç¤ºé¢œè‰²ï¼›æŒ‰ä¸‹Escé”®åï¼Œè¿”å›åˆ°ä¸»é€‰å•ï¼ˆåˆ©ç”¨é”®ç›˜ä¸­æ–­ï¼‰</li>
<li>ç”¨æˆ·è¾“å…¥â€œ4â€åï¼Œç”¨æˆ·å¯è¾“å…¥å­—ç¬¦ä¸²æ›´æ”¹CMOSä¸­çš„æ—¥æœŸæ—¶é—´ï¼Œæ›´æ”¹åè¿”å›åˆ°ä¸»é€‰å•</li>
</ol>
<h2 id="å‡†å¤‡å·¥ä½œ"><a href="#å‡†å¤‡å·¥ä½œ" class="headerlink" title="å‡†å¤‡å·¥ä½œ"></a>å‡†å¤‡å·¥ä½œ</h2><ul>
<li>é¦–å…ˆéœ€è¦å‡†å¤‡ä¸€ä¸ªå¸¸ç”¨è™šæ‹Ÿæœºï¼ŒVMware&#x2F;VirtualBoxç­‰éƒ½å¯ä»¥</li>
<li>å‡†å¤‡<a href="https://winworldpc.com/product/ms-dos/622">MS-DOS 6.22æ˜ åƒ</a>ï¼Œæˆ–è€…<a href="https://www.dosbox.com/download.php?main=1">DOSBox</a>ï¼Œä½œä¸ºå¼€å‘å’Œè°ƒè¯•çš„ç¯å¢ƒï¼ŒDOS 6.22è™šæ‹Ÿæœºçš„å®‰è£…å¯ä»¥å‚è€ƒ<a href="https://www.cnblogs.com/pchmonster/p/8372902.html">è¿™é‡Œ</a></li>
<li>å‡†å¤‡debugã€masmã€linkç¨‹åºï¼Œåˆ†åˆ«æ˜¯DOSä¸‹çš„è°ƒè¯•å™¨ã€ç¼–è¯‘å™¨å’Œé“¾æ¥å™¨ï¼Œå¯ä»¥ä»<a href="https://github.com/xDarkLemon/DOSBox_MASM/tree/master/masm">è¿™é‡Œ</a>ä¸‹è½½</li>
</ul>
<h2 id="ç¨‹åºè®¾è®¡"><a href="#ç¨‹åºè®¾è®¡" class="headerlink" title="ç¨‹åºè®¾è®¡"></a>ç¨‹åºè®¾è®¡</h2><p>ç”±å‰é¢çš„èƒŒæ™¯çŸ¥è¯†å¯çŸ¥ï¼Œè®¡ç®—æœºåˆšä¸Šç”µä¹‹åï¼ŒCPUä¼šè‡ªåŠ¨æ‰§è¡Œç¡¬ä»¶ç³»ç»Ÿæ£€æµ‹åŠåˆå§‹åŒ–å·¥ä½œï¼Œè¿™äº›æ“ä½œæˆ‘ä»¬ç”¨æˆ·æ˜¯æ— æ³•è¿›è¡Œæ’æ‰‹çš„ã€‚å®Œæˆåˆå§‹åŒ–ä¹‹åï¼Œå°†è°ƒç”¨int 19hè¯»å–å¯åŠ¨è®¾å¤‡ç¬¬ä¸€ä¸ªæ‰‡åŒºçš„å†…å®¹åˆ°0:7c00ï¼Œä»è¿™é‡Œå¼€å§‹æˆ‘ä»¬å°±æ¥æ‰‹CPUçš„æ§åˆ¶æƒäº†ã€‚</p>
<h3 id="åˆ¶ä½œå¯åŠ¨ç›˜"><a href="#åˆ¶ä½œå¯åŠ¨ç›˜" class="headerlink" title="åˆ¶ä½œå¯åŠ¨ç›˜"></a>åˆ¶ä½œå¯åŠ¨ç›˜</h3><p>æ‰€ä»¥æˆ‘ä»¬é¦–å…ˆè¦åšçš„å°±æ˜¯åˆ¶ä½œä¸€ä¸ªå¯åŠ¨ç›˜ï¼Œæˆ‘ä»¬è¿™é‡Œé€‰ç”¨1.44Mçš„è½¯ç›˜ï¼Œå®ƒæ¯”ç¡¬ç›˜å…·æœ‰æ›´é«˜çš„ä¼˜å…ˆçº§ã€‚åˆ›å»ºä¸€ä¸ªç©ºçš„è½¯ç›˜æ˜ åƒéå¸¸ç®€å•ï¼Œåœ¨Windowä¸‹å¯ä»¥ä½¿ç”¨WinImageå·¥å…·ï¼Œåœ¨Linuxä¸Šåˆ™ç›´æ¥ä½¿ç”¨å¦‚ä¸‹ddå‘½ä»¤å³å¯ï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">dd <span class="keyword">if</span>=/dev/zero of=floppy.img bs=512 count=2880</span><br></pre></td></tr></table></figure>

<h3 id="å®‰è£…ç¨‹åº"><a href="#å®‰è£…ç¨‹åº" class="headerlink" title="å®‰è£…ç¨‹åº"></a>å®‰è£…ç¨‹åº</h3><p>æœ‰äº†è½¯ç›˜æ˜ åƒä¹‹åï¼Œæ¥ä¸‹æ¥çš„ä»»åŠ¡å°±æ˜¯å°†æˆ‘ä»¬çš„ç¨‹åºå†™åˆ°è½¯ç›˜ä¸Šï¼Œè¿™ä¸ªå¯ä»¥é€šè¿‡ä¸€ä¸ªå®‰è£…ç¨‹åºæ¥å®Œæˆï¼Œå€ŸåŠ©int 13hä¸­æ–­å°†ä»»åŠ¡ç¨‹åºçš„äºŒè¿›åˆ¶ä»£ç å†™åˆ°è½¯ç›˜ä¸Šã€‚</p>
<h3 id="ä»»åŠ¡ç¨‹åºå¼•å¯¼éƒ¨åˆ†"><a href="#ä»»åŠ¡ç¨‹åºå¼•å¯¼éƒ¨åˆ†" class="headerlink" title="ä»»åŠ¡ç¨‹åºå¼•å¯¼éƒ¨åˆ†"></a>ä»»åŠ¡ç¨‹åºå¼•å¯¼éƒ¨åˆ†</h3><p>å¦‚å‰æ‰€è¿°ï¼Œint 19hä¼šå¸®æˆ‘ä»¬å°†å¯åŠ¨ç›˜çš„ç¬¬ä¸€ä¸ªæ‰‡åŒºè¯»åˆ°0:7c00ï¼Œç„¶åCPUä»0:7c00å¼€å§‹æ‰§è¡Œã€‚ä¸€ä¸ªæ‰‡åŒºåŸºæœ¬ä¸å¯èƒ½æ”¾ä¸‹æˆ‘ä»¬æ•´ä¸ªä»»åŠ¡ç¨‹åºï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å°†ä»»åŠ¡ç¨‹åºåˆ†æˆä¸¤ä¸ªéƒ¨åˆ†ï¼šå¼•å¯¼éƒ¨åˆ†å’Œä¸»ä½“éƒ¨åˆ†ã€‚å¼•å¯¼éƒ¨åˆ†çš„ä»£ç è´Ÿè´£æŠŠå‰©ä½™ä¸»ä½“éƒ¨åˆ†è¯»åˆ°å†…å­˜ä¸­ã€‚æˆ‘ä»¬è¿™é‡Œé€‰æ‹©è¯»åˆ°0:7e00hå¤„ï¼Œç´§è·Ÿåœ¨ç¬¬ä¸€ä¸ªæ‰‡åŒºåé¢ã€‚è¯»å®Œä¹‹åå°±è·³è½¬åˆ°ä¸»ä½“éƒ¨åˆ†ä»£ç çš„å¼€å¤´ç»§ç»­æ‰§è¡Œã€‚</p>
<h3 id="ä»»åŠ¡ç¨‹åºä¸»ä½“éƒ¨åˆ†"><a href="#ä»»åŠ¡ç¨‹åºä¸»ä½“éƒ¨åˆ†" class="headerlink" title="ä»»åŠ¡ç¨‹åºä¸»ä½“éƒ¨åˆ†"></a>ä»»åŠ¡ç¨‹åºä¸»ä½“éƒ¨åˆ†</h3><p>ä¸»ä½“éƒ¨åˆ†å®Œæˆæˆ‘ä»¬ç¨‹åºçš„ä¸»è¦åŠŸèƒ½</p>
<ol>
<li>é¦–å…ˆæˆ‘ä»¬éœ€è¦æ³¨å†Œä¸€ä¸ªæ–°çš„int 9ä¸­æ–­ä¾‹ç¨‹ï¼ŒåŒ…è£…BIOSæä¾›çš„ä¸­æ–­ä¾‹ç¨‹ï¼Œå› ä¸ºæˆ‘ä»¬éœ€è¦æ ¹æ®ç”¨æˆ·çš„é”®ç›˜è¾“å…¥åšä¸åŒçš„æ“ä½œã€‚è¿™ä¸ªä¸­æ–­ä¾‹ç¨‹æ˜¯æˆ‘ä»¬ç¨‹åºçš„æ ¸å¿ƒã€‚</li>
<li>æ¥ç€æ˜¾ç¤ºå‡ ä¸ªé€‰é¡¹ä¾›ç”¨æˆ·é€‰æ‹©</li>
<li>ç„¶åè¿›å…¥å¾ªç¯ï¼Œæ ¹æ®æ¨¡å¼æ ‡å¿—å†³å®šæ˜¯å¦æ˜¾ç¤ºæ—¶é—´</li>
</ol>
<h3 id="int-9ä¸­æ–­ä¾‹ç¨‹"><a href="#int-9ä¸­æ–­ä¾‹ç¨‹" class="headerlink" title="int 9ä¸­æ–­ä¾‹ç¨‹"></a>int 9ä¸­æ–­ä¾‹ç¨‹</h3><p>int9ä¸­æ–­ä¾‹ç¨‹è´Ÿè´£å¤„ç†ç”¨æˆ·çš„é”®ç›˜è¾“å…¥ï¼Œåˆ†ä¸ºä¸¤ä¸ªçŠ¶æ€ã€‚</p>
<ul>
<li>ç”¨æˆ·åœ¨ä¸»é€‰å•æ—¶<ul>
<li>è¾“å…¥æŒ‰é”®1ï¼šé‡æ–°å¯åŠ¨è®¡ç®—æœºï¼Œè·³åˆ°ffff:0æ‰§è¡Œ</li>
<li>è¾“å…¥æŒ‰é”®2ï¼šé¦–å…ˆå¤åŸBIOSçš„int9ä¸­æ–­ä¾‹ç¨‹ï¼Œç„¶åæ¸…å±ï¼Œå°†ç¡¬ç›˜çš„ç¬¬ä¸€ä¸ªæ‰‡åŒºè¯»å–åˆ°å†…å­˜0:7c00å¤„ï¼Œç„¶åè·³è½¬åˆ°0:7c00è¿›è¡Œç¡¬ç›˜å¼•å¯¼</li>
<li>è¾“å…¥æŒ‰é”®3ï¼šä¿å­˜å±å¹•ï¼ˆä¸»é€‰å•ï¼‰ï¼Œæ¸…å±ï¼Œä¿®æ”¹æ¨¡å¼ä¸º1ï¼ˆåŠ¨æ€æ˜¾ç¤ºæ—¶é—´ï¼‰</li>
<li>è¾“å…¥æŒ‰é”®4ï¼šé¦–å…ˆéœ€è¦å¤åŸBIOSçš„int9ä¸­æ–­ä¾‹ç¨‹ï¼Œä¿å­˜å±å¹•ï¼ˆä¸»é€‰å•ï¼‰ï¼Œæ¸…å±ï¼Œæ˜¾ç¤ºæç¤ºå­—ç¬¦ä¸²ï¼Œç­‰å¾…ç”¨æˆ·è¾“å…¥æ—¥æœŸæ—¶é—´ï¼Œæ£€æŸ¥æ ¼å¼æ˜¯å¦æ­£ç¡®ï¼Œå°†æ—¶é—´è®¾ç½®åˆ°CMOS RTCä¸Šã€‚å®Œæˆä¹‹åæ¢å¤å±å¹•ï¼Œé‡æ–°å®‰è£…æˆ‘ä»¬åŒ…è£…çš„int 9ä¸­æ–­ä¾‹ç¨‹ã€‚</li>
</ul>
</li>
<li>ç”¨æˆ·åœ¨æ—¶é’Ÿç¨‹åºæ—¶<ul>
<li>è¾“å…¥æŒ‰é”®F1ï¼šæ”¹å˜æ˜¾ç¤ºçš„é¢œè‰²</li>
<li>è¾“å…¥æŒ‰é”®Escï¼šæ¢å¤å±å¹•ï¼Œä¿®æ”¹æ¨¡å¼ä¸º0ï¼ˆä¸»é€‰å•ï¼‰</li>
</ul>
</li>
</ul>
<h3 id="å¤„ç†ç”¨æˆ·è¾“å…¥çš„æ—¶é—´"><a href="#å¤„ç†ç”¨æˆ·è¾“å…¥çš„æ—¶é—´" class="headerlink" title="å¤„ç†ç”¨æˆ·è¾“å…¥çš„æ—¶é—´"></a>å¤„ç†ç”¨æˆ·è¾“å…¥çš„æ—¶é—´</h3><p>æˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªå­—ç¬¦æ ˆæ¥ä¿å­˜ç”¨æˆ·è¾“å…¥çš„å­—ç¬¦ï¼ŒåŒæ—¶ç”¨ä¸€ä¸ªå˜é‡topä¿å­˜å½“å‰æ ˆé¡¶çš„ä½ç½®ã€‚</p>
<ul>
<li>å½“ç”¨æˆ·è¾“å…¥å­—ç¬¦æ—¶ï¼šé¦–å…ˆæ£€æŸ¥æ˜¯å¦åˆ°æ ˆé¡¶ï¼Œ åˆ°äº†æ ˆé¡¶åˆ™å¿½ç•¥ï¼Œå¦åˆ™å°†å­—ç¬¦å…¥æ ˆï¼Œç„¶åæ›´æ–°å±å¹•æ˜¾ç¤º</li>
<li>å½“ç”¨æˆ·è¾“å…¥é€€æ ¼é”®æ—¶ï¼šå¦‚æœæ ˆæ˜¯ç©ºçš„ï¼Œä¸åšå•¥æ“ä½œï¼Œå¦åˆ™å¼¹å‡ºä¸€ä¸ªå­—ç¬¦ï¼Œç„¶åæ›´æ–°å±å¹•æ˜¾ç¤º</li>
<li>å½“ç”¨æˆ·è¾“å…¥Enteré”®æ—¶ï¼šç»“æŸè¾“å…¥è¿‡ç¨‹</li>
</ul>
<h2 id="é¿å‘æŒ‡å—"><a href="#é¿å‘æŒ‡å—" class="headerlink" title="é¿å‘æŒ‡å—"></a>é¿å‘æŒ‡å—</h2><p>ç¬”è€…åœ¨ç¼–ç æµ‹è¯•è¿‡ç¨‹ç¢°åˆ°äº†è®¸å¤šçš„é—®é¢˜ï¼Œæ±‡ç¼–çš„è°ƒè¯•ä¸æ˜¯é‚£ä¹ˆæ–¹ä¾¿ï¼Œæœ‰äº›bugè¿˜è—å¾—æ¯”è¾ƒéšè”½ï¼Œæ‰€ä»¥èŠ±äº†ä¸å°‘æ—¶é—´æ¥è°ƒè¯•é—®é¢˜ã€‚ç¬”è€…ç—›å®šæ€ç—›ï¼Œå«æ³ªæ€»ç»“äº†ä¸‹é¢è¿™å‡ æ¡ï¼Œå¸Œæœ›å¯¹æœ‰ç±»ä¼¼ç»å†çš„æœ‹å‹æœ‰æ‰€å¸®åŠ©ã€‚</p>
<ul>
<li>é€»è¾‘ç‹¬ç«‹çš„ç¨‹åºå—æœ€å¥½è®¾è®¡æˆå­ç¨‹åº<ul>
<li>ä¸€æ–¹é¢ï¼Œæ˜¯å› ä¸ºæ¡ä»¶è½¬ç§»æŒ‡ä»¤åªèƒ½æ˜¯çŸ­è½¬ç§»ï¼Œç¨‹åºå¤ªé•¿ä¼šè¶…å‡ºå…¶èŒƒå›´ã€‚</li>
<li>å¦ä¸€æ–¹é¢ï¼Œä»£ç é€»è¾‘æ›´åŠ æ¸…æ™°ï¼Œè€Œä¸”å¯ä»¥å•ç‹¬è¿›è¡Œå•å…ƒæµ‹è¯•ï¼Œå¦åˆ™å…¨éƒ¨å†™åˆ°ä¸€å—åé¢é—®é¢˜ä¼šæ¯”è¾ƒéš¾å®šä½ã€‚</li>
<li>å­ç¨‹åºåœ¨å®ç°çš„æ—¶å€™ä¸€å®šè¦æ ‡æ³¨å¥½å‚æ•°å’Œè¿”å›å€¼çš„æƒ…å†µï¼Œå‰ææ¡ä»¶å’Œåç½®æ¡ä»¶ï¼Œè¿™å…³ç³»åˆ°å¯„å­˜å™¨çš„ä½¿ç”¨ã€‚</li>
</ul>
</li>
<li>å¯„å­˜å™¨çš„ä¿æŠ¤<ul>
<li>è¢«è°ƒç”¨è€…ä¿æŠ¤çš„å¯„å­˜å™¨ï¼šè°ƒç”¨æ–¹åœ¨è°ƒç”¨å­å‡½æ•°å‰ï¼Œéœ€è¦å…ˆå¤‡ä»½å®ƒã€‚æˆ‘ä»¬è¿™é‡Œä¸»è¦æ˜¯è¿”å›å€¼ç”¨åˆ°çš„å¯„å­˜å™¨ã€‚</li>
<li>è°ƒç”¨è€…ä¿æŠ¤çš„å¯„å­˜å™¨ï¼šå­å‡½æ•°åœ¨ä¿®æ”¹å‰éœ€è¦å…ˆä¿å­˜åŸå€¼</li>
<li>pushå’Œpopä¸€å®šè¦å¯¹åº”ï¼Œé¡ºåºç›¸åï¼Œå»ºè®®åŠ äº†ä¸€ä¸ªpushä¹‹åç«‹é©¬å†™å¯¹åº”çš„popï¼Œå¦åˆ™å¾ˆå¯èƒ½é—å¿˜ã€‚</li>
</ul>
</li>
<li>å†…å­˜çš„æ“ä½œ<ul>
<li>å¤„ç†å†…å­˜çš„æ—¶å€™ä¸€å®šè¦æ³¨æ„é•¿åº¦ï¼Œå°¤å…¶æ˜¯å¯„å­˜å™¨ä¸€èµ·ä½¿ç”¨çš„æŒ‡ä»¤ï¼Œè¦ä½¿ç”¨å¯¹åº”é•¿åº¦çš„å¯„å­˜å™¨ï¼Œè¿™ä¸ªå¦‚æœæé”™äº†ç¼–è¯‘å™¨ä¹Ÿæ˜¯ä¸ä¼šç»™å‡ºæŠ¥é”™çš„ã€‚</li>
<li>å†…å­˜å¯»å€æ—¶æ®µå¯„å­˜å™¨æœ€å¥½ä¸è¦çœç•¥ï¼Œé¿å…ç–å¿½é€ æˆä¸å¿…è¦çš„bugã€‚ï¼ˆæ¯”å¦‚ç”¨åˆ°äº†bpå¯„å­˜å™¨ï¼Œæ®µåœ°å€é»˜è®¤åœ¨ssä¸­ï¼‰</li>
</ul>
</li>
<li>åˆç†å®‰æ’å¯„å­˜å™¨çš„ä½¿ç”¨<ul>
<li>å¯„å­˜å™¨æ˜¯ç¨€ç¼ºèµ„æºï¼Œæ€»å…±å°±è¿™ä¹ˆåå‡ ä¸ªï¼Œæœ‰äº›ä½¿ç”¨åœºæ™¯è¿˜å—é™</li>
<li>é¦–å…ˆç¡®å®šå†…å­˜å¯»å€éœ€è¦ç”¨åˆ°çš„å¯„å­˜å™¨ï¼Œå†…å­˜å¯»å€åªèƒ½ä½¿ç”¨è¿™å‡ ä¸ªå¯„å­˜å™¨ï¼šbx&#x2F;bpã€di&#x2F;siã€‚å¯ä»¥å•ç‹¬ä½¿ç”¨ï¼Œä¹Ÿå¯ä»¥å·¦å³ä¸¤ä¸ªç»„åˆä½¿ç”¨ã€‚æç¤ºï¼šå…¶ä¸­bxå¯ä»¥åˆ†æˆblå’Œbhä½¿ç”¨ï¼Œå…¶ä»–å‡ ä¸ªåˆ™åªèƒ½ä½œä¸ºæ•´ä½“ä½¿ç”¨ï¼Œæ‰€ä»¥æœ‰äº›åœºæ™¯å¯èƒ½åªæœ‰bxèƒ½èƒœä»»ã€‚</li>
<li>å…¶æ¬¡æ˜¯ç¡®å®šæŒ‡ä»¤ã€å­ç¨‹åºæˆ–ä¸­æ–­è§„å®šä½¿ç”¨çš„å¯„å­˜å™¨</li>
<li>å­—èŠ‚çš„æ“ä½œåªèƒ½ä½¿ç”¨ah&#x2F;alã€bh&#x2F;hlã€ch&#x2F;clã€dh&#x2F;dlï¼Œå…¶ä½™å¯„å­˜å™¨ä¸èƒ½æ‹†åˆ†ä½¿ç”¨ã€‚</li>
<li>å¦‚æœå¯„å­˜å™¨å®åœ¨ä¸å¤Ÿç”¨ï¼Œå°±åªèƒ½ä¸´æ—¶å…ˆå‹æ ˆï¼Œç„¶åç”¨å®Œå†å‡ºæ ˆã€‚æˆ–è€…å°†ç¨‹åºåˆ†æ‹†ä¸ºå¤šä¸ªå­ç¨‹åºã€‚</li>
</ul>
</li>
<li>æ³¨æ„æ ‡å·çš„åç§»åœ°å€ï¼Œæ˜¯å…¶åœ¨å®‰è£…ç¨‹åºä¸­çš„åç§»åœ°å€ï¼Œå¹¶ä¸æ˜¯åé¢ä»»åŠ¡ç¨‹åºä»å¯åŠ¨ç›˜è¢«è¯»å–åˆ°å†…å­˜ä¸­ä¹‹åçš„åç§»åœ°å€ã€‚æ‰€ä»¥æˆ‘ä»¬è®¿é—®æ•°æ®æ—¶éœ€è¦å¯¹åç§»åœ°å€åšä¿®æ­£ã€‚ï¼ˆ<code>call æ ‡å·</code>æŒ‡ä»¤åœ¨ç¼–è¯‘æˆæœºå™¨ç æ—¶ä¼šè½¬æˆç›¸å¯¹ä½ç§»ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥ä½¿ç”¨æ ‡å·ï¼‰</li>
<li>ç•™å¿ƒç¨‹åºä¸­çš„ç«äº‰é—®é¢˜ï¼Œå› ä¸ºä¸­æ–­éšæ—¶å¯èƒ½å‘ç”Ÿï¼Œéœ€è¦æ³¨æ„ä¸­æ–­ä¾‹ç¨‹å’Œä¸»ç¨‹åºä¸­éƒ½ç”¨åˆ°çš„æ•°æ®ï¼Œå¿…è¦æ—¶å¯ä»¥å…³ä¸­æ–­ã€‚</li>
<li>åå­—ç›¸ä¼¼çš„æŒ‡ä»¤ä¸è¦æ‰“é”™ï¼Œæ¯”å¦‚andå’ŒaddæŒ‡ä»¤ï¼Œå®ƒä»¬çœŸçš„å¤ªåƒäº†ï¼Œæˆ‘è‡³å°‘åœ¨å®ƒä»¬ä¸Šé¢æ ½äº†ä¸¤ä¸ªè·Ÿå¤´ã€‚</li>
</ul>
<h2 id="ç¨‹åºå®ç°"><a href="#ç¨‹åºå®ç°" class="headerlink" title="ç¨‹åºå®ç°"></a>ç¨‹åºå®ç°</h2><p>æ¥ä¸‹æ¥æ¥çœ‹å®é™…ä»£ç å®ç°ï¼Œé¦–å…ˆçœ‹ä¸‹æ•´ä½“çš„æ¡†æ¶ï¼Œç„¶åçœ‹æ¯ä¸ªéƒ¨åˆ†çš„ç»†èŠ‚ã€‚</p>
<h3 id="ç¨‹åºæ¡†æ¶"><a href="#ç¨‹åºæ¡†æ¶" class="headerlink" title="ç¨‹åºæ¡†æ¶"></a>ç¨‹åºæ¡†æ¶</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">assume cs:code, ss:stack, ds:data</span><br><span class="line">stack segment</span><br><span class="line">    dw 64 dup(0)</span><br><span class="line">stack ends</span><br><span class="line">data segment</span><br><span class="line">    mes db &#x27;fail to write to floppy!&#x27;, 0</span><br><span class="line">data ends</span><br><span class="line"></span><br><span class="line">code segment</span><br><span class="line">; ä»»åŠ¡ç¨‹åºå¼•å¯¼éƒ¨åˆ†ï¼ˆ1ä¸ªæ‰‡åŒº512å­—èŠ‚ï¼‰</span><br><span class="line">; åŠŸèƒ½: å°†ä»»åŠ¡ç¨‹åºçš„ä¸»ä½“éƒ¨åˆ†è¯»å…¥å†…å­˜</span><br><span class="line">; ç¬¬ä¸€ä¸ªæ‰‡åŒºç”±BIOSè¯»å…¥å†…å­˜0:7c00hå¤„</span><br><span class="line">boot:</span><br><span class="line">; ä»ç¬¬äºŒä¸ªæ‰‡åŒºå¼€å§‹è¯»å–åˆ°0:7e00hå¤„</span><br><span class="line">; ç„¶åè·³è½¬åˆ°ä»»åŠ¡ç¨‹åºä¸»ä½“éƒ¨åˆ†task</span><br><span class="line">        çœç•¥...</span><br><span class="line">        db 512-($-boot) dup(0)  ; padåˆ°512å­—èŠ‚</span><br><span class="line">        </span><br><span class="line">; ä»»åŠ¡ç¨‹åºä¸»ä½“éƒ¨åˆ†ï¼ˆ3ä¸ªæ‰‡åŒº1536å­—èŠ‚ï¼‰</span><br><span class="line">; åŠŸèƒ½ï¼šå¤„ç†ç”¨æˆ·è¾“å…¥ï¼Œæ‰§è¡Œå¯¹åº”æ“ä½œ</span><br><span class="line">; ç¨‹åºä½äºå†…å­˜0:7e00hå¤„</span><br><span class="line">task:</span><br><span class="line">        çœç•¥...</span><br><span class="line">        db 1536-($-task) dup(0)  ; padåˆ°3ä¸ªæ‰‡åŒºçš„é•¿åº¦</span><br><span class="line">        </span><br><span class="line">; ä»»åŠ¡ç¨‹åºæ•°æ®éƒ¨åˆ†ï¼ˆ1ä¸ªæ‰‡åŒº512å­—èŠ‚ï¼‰</span><br><span class="line">dat:</span><br><span class="line">        çœç•¥...</span><br><span class="line">        db 512-($-dat) dup(0)           ; padåˆ°512å­—èŠ‚</span><br><span class="line">        </span><br><span class="line">; å®‰è£…ç¨‹åº: å°†ä»»åŠ¡ç¨‹åºå†™åˆ°è½¯ç›˜ä¸Š</span><br><span class="line">start:</span><br><span class="line">        çœç•¥...</span><br><span class="line">ok:</span><br><span class="line">        mov ax, 4c00h</span><br><span class="line">        int 21h</span><br><span class="line">code ends</span><br><span class="line">end start</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°æˆ‘ä»¬çš„ä»£ç æ®µåˆ†ä¸º4å¤§å—ï¼Œé™¤äº†å®‰è£…ç¨‹åºä¹‹å¤–ï¼Œæ˜¯ä»»åŠ¡ç¨‹åºçš„å¼•å¯¼éƒ¨åˆ†ã€ä¸»ä½“éƒ¨åˆ†ä»¥åŠæ•°æ®éƒ¨åˆ†ã€‚æˆ‘ä»¬åœ¨ä»»åŠ¡ç¨‹åºçš„æ¯ä¸ªéƒ¨åˆ†æœ€åéƒ½åšäº†è¡¥0å¤„ç†ï¼Œè¡¥é½åˆ°æ‰‡åŒºçš„é•¿åº¦ï¼Œä½¿æ“ä½œæ›´æ–¹ä¾¿ã€‚å¦å¤–ï¼Œå°†æ•°æ®å•ç‹¬æ”¾åœ¨ä¸€ä¸ªæ‰‡åŒºä¸­ï¼Œæ–¹ä¾¿è®¡ç®—åç§»ï¼Œè¿›è¡Œæ•°æ®çš„è®¿é—®ã€‚</p>
<h3 id="å®‰è£…ç¨‹åº-1"><a href="#å®‰è£…ç¨‹åº-1" class="headerlink" title="å®‰è£…ç¨‹åº"></a>å®‰è£…ç¨‹åº</h3><p>æˆ‘ä»¬å…ˆæ¥çœ‹å®‰è£…ç¨‹åº</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">; å®‰è£…ç¨‹åº: å°†ä»»åŠ¡ç¨‹åºå†™åˆ°è½¯ç›˜ä¸Š</span><br><span class="line">start:</span><br><span class="line">        mov ax, data</span><br><span class="line">        mov ds, ax</span><br><span class="line">        mov ax, stack</span><br><span class="line">        mov ss, ax</span><br><span class="line">        mov sp, 128</span><br><span class="line"></span><br><span class="line">        mov ax, cs</span><br><span class="line">        mov es, ax</span><br><span class="line">        mov bx, offset boot     ; es:bx æŒ‡å‘ç¼“å­˜æ•°æ®çš„å†…å­˜åœ°å€</span><br><span class="line"></span><br><span class="line">        mov al, 5               ; è¯»å†™çš„æ‰‡åŒºæ•°</span><br><span class="line">        mov ch, 0               ; ç£é“å·</span><br><span class="line">        mov cl, 1               ; æ‰‡åŒºå·</span><br><span class="line">        mov dl, 0               ; é©±åŠ¨å™¨å·  è½¯é©±ä»0å¼€å§‹ï¼Œ0:è½¯é©±Aï¼Œ1:è½¯é©±Bï¼›</span><br><span class="line">                                ; ç¡¬ç›˜ä»80hå¼€å§‹ï¼Œ80hï¼šç¡¬ç›˜Cï¼Œ81hï¼šç¡¬ç›˜D</span><br><span class="line">        mov dh, 0               ; ç£å¤´å·ï¼ˆå¯¹äºè½¯ç›˜å³é¢å·ï¼‰</span><br><span class="line">        mov ah, 3               ; åŠŸèƒ½å·ï¼Œ2è¡¨ç¤ºè¯»æ‰‡åŒºï¼Œ3è¡¨ç¤ºå†™æ‰‡åŒº</span><br><span class="line">        int 13h</span><br><span class="line"></span><br><span class="line">        cmp ah, 0</span><br><span class="line">        je ok</span><br><span class="line">        mov dh, 10</span><br><span class="line">        mov dl, 10</span><br><span class="line">        mov si, 0</span><br><span class="line">        call showstr</span><br><span class="line">ok:</span><br><span class="line">        mov ax, 4c00h</span><br><span class="line">        int 21h</span><br></pre></td></tr></table></figure>

<p>é¦–å…ˆè®¾ç½®æ®µå¯„å­˜å™¨ï¼Œç„¶åå°†es:bxæŒ‡å‘ä»£ç æ®µçš„å¼€å¤´å³bootçš„ä½ç½®ï¼Œæˆ‘ä»¬å°†ä»è¿™ä¸ªä½ç½®å¼€å§‹å†™5ä¸ªæ‰‡åŒºåˆ°è½¯ç›˜ä¸­ã€‚å¦‚æœå†™ç£ç›˜æˆåŠŸï¼Œåˆ™ç¨‹åºç»“æŸï¼›å¦åˆ™æ˜¾ç¤ºä¸€æ¡é”™è¯¯ä¿¡æ¯ã€‚å…¶ä¸­<code>showstr</code>æ˜¯æˆ‘ä»¬å°è£…çš„å­ç¨‹åºï¼Œç”¨äºåœ¨å±å¹•æŒ‡å®šä½ç½®æ˜¾ç¤ºä»¥0ç»“å°¾çš„å­—ç¬¦ä¸²ã€‚</p>
<h3 id="ä»»åŠ¡ç¨‹åºå¼•å¯¼éƒ¨åˆ†-1"><a href="#ä»»åŠ¡ç¨‹åºå¼•å¯¼éƒ¨åˆ†-1" class="headerlink" title="ä»»åŠ¡ç¨‹åºå¼•å¯¼éƒ¨åˆ†"></a>ä»»åŠ¡ç¨‹åºå¼•å¯¼éƒ¨åˆ†</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">; ä»»åŠ¡ç¨‹åºå¼•å¯¼éƒ¨åˆ†ï¼ˆ1ä¸ªæ‰‡åŒº512å­—èŠ‚ï¼‰</span><br><span class="line">; åŠŸèƒ½: å°†ä»»åŠ¡ç¨‹åºçš„ä¸»ä½“éƒ¨åˆ†è¯»å…¥å†…å­˜</span><br><span class="line">; ç¬¬ä¸€ä¸ªæ‰‡åŒºç”±BIOSè¯»å…¥å†…å­˜0:7c00hå¤„</span><br><span class="line">boot:</span><br><span class="line">; ä»ç¬¬äºŒä¸ªæ‰‡åŒºå¼€å§‹è¯»å–åˆ°0:7e00hå¤„</span><br><span class="line">; ç„¶åè·³è½¬åˆ°ä»»åŠ¡ç¨‹åºä¸»ä½“éƒ¨åˆ†task</span><br><span class="line">        mov ax, 0</span><br><span class="line">        mov es, ax</span><br><span class="line">        mov bx, 7e00h           ; es:bx æŒ‡å‘æ¥æ”¶ä»æ‰‡åŒºè¯»å–æ•°æ®çš„å†…å­˜åŒº</span><br><span class="line"></span><br><span class="line">        mov al, 4               ; è¯»å–çš„æ‰‡åŒºæ•°</span><br><span class="line">        mov ch, 0               ; ç£é“å·(0~79)</span><br><span class="line">        mov cl, 2               ; æ‰‡åŒºå·(1~18)ï¼Œç¬¬äºŒä¸ªæ‰‡åŒºå¼€å§‹</span><br><span class="line">        mov dl, 0               ; é©±åŠ¨å™¨å·  è½¯é©±ä»0å¼€å§‹ï¼Œ0:è½¯é©±Aï¼Œ1:è½¯é©±B</span><br><span class="line">                                ; ç¡¬ç›˜ä»80hå¼€å§‹ï¼Œ80hï¼šç¡¬ç›˜Cï¼Œ81hï¼šç¡¬ç›˜D</span><br><span class="line">        mov dh, 0               ; ç£å¤´å·(0~1)ï¼ˆå¯¹äºè½¯ç›˜å³é¢å·ï¼‰</span><br><span class="line">        mov ah, 2               ; åŠŸèƒ½å·ï¼Œ2è¡¨ç¤ºè¯»æ‰‡åŒºï¼Œ3è¡¨ç¤ºå†™æ‰‡åŒº</span><br><span class="line">        int 13h</span><br><span class="line">        ; è¿™é‡Œå¤±è´¥çš„è¯ï¼Œå›é€€åˆ°ä»ç¡¬ç›˜å¯åŠ¨</span><br><span class="line"></span><br><span class="line">        jmp bx                  ; è·³è½¬åˆ°ä»»åŠ¡ç¨‹åºä¸»ä½“éƒ¨åˆ†task</span><br><span class="line"></span><br><span class="line">        db 512-($-boot) dup(0)  ; padåˆ°512å­—èŠ‚</span><br></pre></td></tr></table></figure>

<p>å¼•å¯¼éƒ¨åˆ†è´Ÿè´£å°†ä»»åŠ¡ç¨‹åºçš„ä¸»ä½“éƒ¨åˆ†è¯»åˆ°å†…å­˜ä¸­ï¼Œæˆ‘ä»¬è¿™é‡Œé€‰æ‹©è¯»åˆ°0:7e00hå¤„ï¼Œç´§è·Ÿåœ¨ç¬¬ä¸€ä¸ªå¼•å¯¼æ‰‡åŒºåé¢ã€‚æ€»å…±è¯»äº†4ä¸ªæ‰‡åŒºï¼Œå…¶ä¸­3ä¸ªæ‰‡åŒºä»£ç ã€1ä¸ªæ‰‡åŒºæ•°æ®ã€‚è¯»å®Œä¹‹åï¼Œè·³è½¬åˆ°0:7e00hå¤„æ‰§è¡Œã€‚</p>
<h3 id="æ•°æ®éƒ¨åˆ†"><a href="#æ•°æ®éƒ¨åˆ†" class="headerlink" title="æ•°æ®éƒ¨åˆ†"></a>æ•°æ®éƒ¨åˆ†</h3><p>æˆ‘ä»¬å°†æ‰€æœ‰çš„æ•°æ®é›†ä¸­åˆ°äº†ä¸€èµ·ä»¥æ–¹ä¾¿è®¿é—®ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">; ä»»åŠ¡ç¨‹åºæ•°æ®éƒ¨åˆ†ï¼ˆ1ä¸ªæ‰‡åŒº512å­—èŠ‚ï¼‰</span><br><span class="line">dat:</span><br><span class="line">    ; ç›¸å¯¹taskåç§»+7e00h</span><br><span class="line">    ; m1:0, m2:1, m3:2, m4:3, m5:4</span><br><span class="line">    dw offset m1-task+7e00h, offset m2-task+7e00h, offset m3-task+7e00h</span><br><span class="line">    dw offset m4-task+7e00h, offset m5-task+7e00h</span><br><span class="line">    m1 db &#x27;--------------------------------------MENU--------------------------------------&#x27;, 0</span><br><span class="line">    m2 db &#x27;1) reset pc&#x27;, 0          ; é‡æ–°å¯åŠ¨è®¡ç®—æœº</span><br><span class="line">    m3 db &#x27;2) start system&#x27;, 0      ; å¼•å¯¼ç°æœ‰çš„æ“ä½œç³»ç»Ÿ</span><br><span class="line">    m4 db &#x27;3) clock&#x27;, 0             ; è¿›å…¥æ—¶é’Ÿç¨‹åº</span><br><span class="line">    m5 db &#x27;4) set clock&#x27;, 0         ; è®¾ç½®æ—¶é—´</span><br><span class="line">    prompt db &#x27;time format: yy/MM/dd hh:mm:ss&#x27;, 0   ; è®¾ç½®æ—¶é—´æç¤ºå­—ç¬¦ä¸²</span><br><span class="line">    timeformat db &#x27;yy/MM/dd hh:mm:ss&#x27;, 0            ; æ—¶é—´æ ¼å¼</span><br><span class="line">    timeoffset db 9, 8, 7, 4, 2, 0                  ; CMOSæ—¶é—´å„é¡¹å¯„å­˜å™¨å·</span><br><span class="line">    old9 dd 0                       ; ä¿å­˜int9ä¸­æ–­åŸæœ¬çš„åœ°å€</span><br><span class="line">    mode db 0                       ; int9ä¸­æ–­ä¾‹ç¨‹æ¨¡å¼ï¼Œ0è¡¨ç¤ºä¸»é€‰é¡¹ï¼Œ1è¡¨ç¤ºæ—¶é—´ç¨‹åº</span><br><span class="line">    charstk db 32 dup(0)            ; è®¾ç½®æ—¶é—´çš„å­—ç¬¦æ ˆ</span><br><span class="line">    top dw 0</span><br><span class="line">    digitoffset db 0,1,3,4,6,7,9,10,12,13,15,16     ; æ—¶é—´å­—ç¬¦ä¸²ä¸­æ•°å­—çš„åç§»</span><br><span class="line">    daysofmonth db 0,31,29,31,30,31,30,31,31,30,31,30,31     ; æ¯ä¸ªæœˆçš„å¤©æ•°</span><br><span class="line">    hextable db &#x27;0123456789ABCDEF&#x27;  ; åå…­è¿›åˆ¶æ‰“å°</span><br><span class="line"></span><br><span class="line">    db 512-($-dat) dup(0)           ; padåˆ°512å­—èŠ‚</span><br></pre></td></tr></table></figure>



<h3 id="ä¸»ç¨‹åº"><a href="#ä¸»ç¨‹åº" class="headerlink" title="ä¸»ç¨‹åº"></a>ä¸»ç¨‹åº</h3><p>å¼•å¯¼ç¨‹åºå°†ç¨‹åºçš„å‰©ä½™éƒ¨åˆ†è¯»å–åˆ°å†…å­˜ä¹‹åï¼Œä¼šè·³è½¬åˆ°ä¸»ç¨‹åºå¼€å§‹è¿™é‡Œå¼€å§‹æ‰§è¡Œ</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">; ä»»åŠ¡ç¨‹åºä¸»ä½“éƒ¨åˆ†ï¼ˆ3ä¸ªæ‰‡åŒº1536å­—èŠ‚ï¼‰</span><br><span class="line">; åŠŸèƒ½ï¼šå¤„ç†ç”¨æˆ·è¾“å…¥ï¼Œæ‰§è¡Œå¯¹åº”æ“ä½œ</span><br><span class="line">; ç¨‹åºä½äºå†…å­˜0:7e00hå¤„</span><br><span class="line">task:</span><br><span class="line">;ä¸»ç¨‹åºé€»è¾‘ï¼š</span><br><span class="line">;- é¦–å…ˆæ³¨å†Œä¸»èœå•int9ä¸­æ–­ä¾‹ç¨‹</span><br><span class="line">;- æ˜¾ç¤ºèœå•</span><br><span class="line">;- æ— é™å¾ªç¯, æ ¹æ®æ¨¡å¼æ ‡å¿—å†³å®šæ˜¯å¦æ˜¾ç¤ºæ—¶é—´</span><br><span class="line">        mov ax, 0               ;</span><br><span class="line">        mov ds, ax              ; ä¸»ç¨‹åºä¸­å°†dsè®¾ä¸º0</span><br><span class="line"></span><br><span class="line">        call mount9             ; æ³¨å†ŒåŒ…è£…è¿‡çš„int9ä¸­æ–­ä¾‹ç¨‹</span><br><span class="line"></span><br><span class="line">        mov cx, 5               ; æ˜¾ç¤ºä¸»èœå•ï¼Œ5è¡Œ</span><br><span class="line">        mov di, 0               ;</span><br><span class="line">        mov dh, 0               ; è¡Œå·</span><br><span class="line">        mov dl ,0               ; åˆ—å·</span><br><span class="line">s:</span><br><span class="line">        mov si, 8400h[di]       ; èœå•å­—ç¬¦ä¸²åç§»</span><br><span class="line">        call showstr</span><br><span class="line">        inc dh</span><br><span class="line">        add di, 2               ; æŒ‡å‘ä¸‹ä¸€ä¸ªå­—ç¬¦ä¸²çš„åç§»</span><br><span class="line">        loop s                  ;</span><br><span class="line"></span><br><span class="line">        mov dh, 5               ; è¡Œå·</span><br><span class="line">        mov dl, 0               ; åˆ—å·</span><br><span class="line">        mov bx, 0               ; bhé¡µå·</span><br><span class="line">        mov ah, 2               ; åŠŸèƒ½å·2: è®¾ç½®å…‰æ ‡</span><br><span class="line">        int 10h</span><br><span class="line">        </span><br><span class="line">        mov bx, offset mode-task+7e00h</span><br><span class="line">        mov si, offset timeformat-task+7e00h    ; +3</span><br><span class="line">        mov dh, 0</span><br><span class="line">        mov dl, 0</span><br><span class="line">        ; è¿›å…¥æ— é™å¾ªç¯</span><br><span class="line">s1:</span><br><span class="line">        call getclock           ; ä»CMOSè¯»å–æ—¶é—´</span><br><span class="line">        pushf</span><br><span class="line">        cli                     ; å±è”½ä¸­æ–­ï¼Œé˜²æ­¢ä¸­æ–­ä¸­å°†æ¨¡å¼æ”¹ä¸º0åï¼Œè¿˜æ˜¾ç¤ºæ—¶é—´</span><br><span class="line">        cmp byte ptr [bx], 0    ; æ¨¡å¼å€¼</span><br><span class="line">        je skiptime</span><br><span class="line">        call showstr            ; æ˜¾ç¤ºä»CMOSè¯»å–çš„æ—¶é—´</span><br><span class="line">skiptime:</span><br><span class="line">        popf</span><br><span class="line">        jmp s1</span><br></pre></td></tr></table></figure>

<p><code>getclock</code>æ˜¯æˆ‘ä»¬å°è£…çš„ä¸€ä¸ªå­ç¨‹åºï¼Œç”¨äºä»CMOSè¯»å–æ—¶é—´å†™åˆ°<code>timeformat</code>æ‰€åœ¨çš„ä½ç½®ã€‚æœ€ååœ¨æ˜¾ç¤ºå­—ç¬¦ä¸²çš„åœ°æ–¹ï¼Œæˆ‘ä»¬å…³é—­äº†ä¸­æ–­ï¼Œå› ä¸ºint 9ä¸­æ–­ä¸­éšæ—¶å¯èƒ½å°†å‘ç”Ÿï¼Œå¦‚æœåœ¨ä¸»ç¨‹åºåˆ¤æ–­æ¨¡å¼çš„å€¼å’Œå®Œæˆæ—¶é—´æ˜¾ç¤ºä¹‹é—´ï¼Œä¸­æ–­ä¾‹ç¨‹å°†æ¨¡å¼ä»1æ”¹ä¸º0ï¼Œé‚£ä¹ˆæ˜¾ç¤ºå°±ä¼šå‡ºç°é—®é¢˜ã€‚</p>
<h3 id="ä¸­æ–­ä¾‹ç¨‹çš„æ³¨å†ŒåŠæ¢å¤"><a href="#ä¸­æ–­ä¾‹ç¨‹çš„æ³¨å†ŒåŠæ¢å¤" class="headerlink" title="ä¸­æ–­ä¾‹ç¨‹çš„æ³¨å†ŒåŠæ¢å¤"></a>ä¸­æ–­ä¾‹ç¨‹çš„æ³¨å†ŒåŠæ¢å¤</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">; ç”¨äºæ³¨å†Œæ–°çš„int 9ä¸­æ–­ä¾‹ç¨‹ï¼ŒåŸæ¥çš„ä¸­æ–­å‘é‡ä¿å­˜åœ¨old9çš„ä½ç½®</span><br><span class="line">mount9:</span><br><span class="line">        push ax</span><br><span class="line">        push si</span><br><span class="line">        mov si, offset old9-task+7e00h</span><br><span class="line">        mov ax, ds:[9*4]        ; ä¿å­˜åŸæ¥çš„ä¸­æ–­ä¾‹ç¨‹çš„åç§»åœ°å€</span><br><span class="line">        mov [si], ax            ; ä¿å­˜åˆ°old9ä½ç½®</span><br><span class="line">        mov ax, ds:[9*4+2]      ; ä¿å­˜åŸæ¥çš„ä¸­æ–­ä¾‹ç¨‹çš„æ®µåœ°å€</span><br><span class="line">        mov [si].2, ax          ; ä¿å­˜åˆ°old9+2ä½ç½®</span><br><span class="line"></span><br><span class="line">        pushf</span><br><span class="line">        cli                     ; å±è”½ä¸­æ–­ï¼Œé˜²æ­¢ä¸­æ–­å‘é‡å‡ºç°éæ³•çŠ¶æ€</span><br><span class="line">        mov ds:[9*4], offset int9 + 7c00h   ; è®¾ç½®æ–°çš„int9åç§», +7c00hä¿®æ­£</span><br><span class="line">        mov word ptr ds:[9*4+2], 0h     ; æ–°çš„int9æ®µåœ°å€, 9000h</span><br><span class="line">        popf</span><br><span class="line"></span><br><span class="line">        pop si</span><br><span class="line">        pop ax</span><br><span class="line">        ret</span><br></pre></td></tr></table></figure>

<p><code>mount9</code>ç”¨äºæ³¨å†Œæ–°çš„int 9ä¸­æ–­ä¾‹ç¨‹ï¼Œå°†å¯¹åº”çš„ä¸­æ–­å‘é‡è®¾ç½®ä¸ºæ–°çš„ä¸­æ–­ä¾‹ç¨‹<code>int9</code>çš„åç§»åœ°å€ã€‚å› ä¸ºæˆ‘ä»¬è¿˜è¦ç”¨æ¥åŸæ¥çš„ä¸­æ–­ä¾‹ç¨‹ï¼Œæ‰€ä»¥å°†å…¶ä¸­æ–­å‘é‡ä¿å­˜åœ¨<code>old9</code>æ‰€åœ¨çš„ä½ç½®ã€‚</p>
<p>åŒæ ·åœ°ï¼Œè¿™é‡Œåœ¨ä¿®æ”¹ä¸­æ–­å‘é‡ä¹‹å‰ï¼Œæˆ‘ä»¬ä¹Ÿå±è”½äº†ä¸­æ–­ã€‚å› ä¸ºä¿®æ”¹åç§»åœ°å€å’Œæ®µåœ°å€è‡³å°‘éœ€è¦ä¸¤ä¸ªæŒ‡ä»¤ï¼Œå¦‚æœåœ¨ä¸¤è€…ä¹‹é—´æ­£å¥½å‘ç”Ÿäº†ä¸­æ–­ï¼Œé‚£ä¹ˆä¸­æ–­å‘é‡å°±å¤„äºä¸€ä¸ªéæ³•çš„çŠ¶æ€ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">; æ¢å¤int 9ä¸­æ–­ä¾‹ç¨‹ä¸ºBIOSè‡ªå¸¦çš„é‚£ä¸ª</span><br><span class="line">umount9:</span><br><span class="line">        push ax</span><br><span class="line">        push si</span><br><span class="line">        mov si, offset old9-task+7e00h</span><br><span class="line">        pushf</span><br><span class="line">        cli                     ; å±è”½ä¸­æ–­ï¼Œé˜²æ­¢ä¸­æ–­å‘é‡å‡ºç°éæ³•çŠ¶æ€</span><br><span class="line">        mov ax, [si]</span><br><span class="line">        mov ds:[9*4], ax        ; åç§»åœ°å€</span><br><span class="line">        mov ax, [si].2</span><br><span class="line">        mov ds:[9*4+2], ax      ; æ®µåœ°å€</span><br><span class="line">        popf</span><br><span class="line"></span><br><span class="line">        pop si</span><br><span class="line">        pop ax</span><br><span class="line">        ret</span><br></pre></td></tr></table></figure>

<p><code>umount9</code>åˆ™æ˜¯å°†old9ä¸­ä¿å­˜çš„ä¸­æ–­å‘é‡æ¢å¤åˆ°ä¸­æ–­å‘é‡è¡¨ä¸­å¯¹åº”çš„ä½ç½®ã€‚</p>
<h3 id="int-9ä¸­æ–­ä¾‹ç¨‹å®ç°"><a href="#int-9ä¸­æ–­ä¾‹ç¨‹å®ç°" class="headerlink" title="int 9ä¸­æ–­ä¾‹ç¨‹å®ç°"></a>int 9ä¸­æ–­ä¾‹ç¨‹å®ç°</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">;ä¸»é€‰èœå•int9ä¸­æ–­ä¾‹ç¨‹é€»è¾‘ï¼šï¼ˆå¤„ç†å­—ç¬¦1~4ï¼‰</span><br><span class="line">;- ç”¨æˆ·è¾“å…¥1ï¼Œé‡æ–°å¯åŠ¨è®¡ç®—æœºï¼Œè·³åˆ°ffff:0æ‰§è¡Œ</span><br><span class="line">;- ç”¨æˆ·è¾“å…¥2ï¼Œé¦–å…ˆå¤åŸint9ä¸­æ–­ä¾‹ç¨‹ï¼Œç„¶åæ¸…å±ï¼Œå°†ç¡¬ç›˜ç¬¬ä¸€ä¸ªæ‰‡åŒºå†…å®¹è¯»åˆ°0:7c00ï¼Œè·³è½¬åˆ°0:7c00</span><br><span class="line">;- ç”¨æˆ·è¾“å…¥3ï¼Œä¿å­˜å±å¹•(ä¸»é€‰å•)ï¼Œæ¸…å±ï¼Œä¿®æ”¹æ¨¡å¼ä¸º1(åŠ¨æ€æ˜¾ç¤ºæ—¶é—´)</span><br><span class="line">;- ç”¨æˆ·è¾“å…¥4ï¼Œé¦–å…ˆå¤åŸint9ä¸­æ–­ä¾‹ç¨‹ï¼Œä¿å­˜å±å¹•(ä¸»é€‰å•)ï¼Œæ¸…å±ï¼Œæ˜¾ç¤ºæç¤ºå­—ç¬¦ä¸²</span><br><span class="line">;             ç­‰å¾…ç”¨æˆ·è¾“å…¥æ—¥æœŸæ—¶é—´ï¼Œæ£€æŸ¥æ ¼å¼æ˜¯å¦æ­£ç¡®ï¼Œå°†æ—¶é—´è®¾ç½®åˆ°CMOS RTCä¸Š</span><br><span class="line">;             å®Œæˆä¹‹åæ¢å¤å±å¹•ï¼Œé‡æ–°å®‰è£…æˆ‘ä»¬åŒ…è£…çš„int 9ä¸­æ–­ä¾‹ç¨‹ã€‚</span><br><span class="line">;</span><br><span class="line">;æ—¶é’Ÿç¨‹åºint9ä¸­æ–­ä¾‹ç¨‹é€»è¾‘ï¼šï¼ˆå¤„ç†F1å’ŒEscï¼‰</span><br><span class="line">;- ç”¨æˆ·è¾“å…¥F1ï¼Œæ”¹å˜æ˜¾ç¤ºé¢œè‰²</span><br><span class="line">;- ç”¨æˆ·è¾“å…¥Escï¼Œæ¢å¤å±å¹•ï¼Œä¿®æ”¹æ¨¡å¼ä¸º0ï¼ˆä¸»é€‰å•ï¼‰</span><br><span class="line">int9:</span><br><span class="line">        push ax</span><br><span class="line">        push bx</span><br><span class="line">        push si</span><br><span class="line"></span><br><span class="line">        pushf                   ; ä¸­æ–­è¿‡ç¨‹ï¼šæ ‡å¿—å¯„å­˜å™¨å…¥æ ˆ</span><br><span class="line">        mov si, offset old9-task+7e00h</span><br><span class="line">        call dword ptr [si]     ; ä¸­æ–­è¿‡ç¨‹ï¼šæ¨¡æ‹Ÿint9</span><br><span class="line"></span><br><span class="line">int9s:</span><br><span class="line">        mov ah, 1               ; int9è¿›æ¥ï¼Œé”®ç›˜ç¼“å†²åŒºä¸ä¸€å®šæœ‰æ•°æ®</span><br><span class="line">        int 16h</span><br><span class="line">        je int9ret</span><br><span class="line"></span><br><span class="line">        mov ah, 0</span><br><span class="line">        int 16h                 ; è¯»å–é”®ç›˜ç¼“å†²åŒº,é˜²æ­¢é”®ç›˜ç¼“å†²åŒºæº¢å‡º</span><br><span class="line">                                ; (ah)=scan code, (al)=ascii</span><br><span class="line">                                </span><br><span class="line">int9s1:</span><br><span class="line">        ;in al, 60h      ; ä»60hç«¯å£è¯»å–æ‰«æç </span><br><span class="line">        mov bx, offset mode-task+7e00h</span><br><span class="line">        mov al, [bx]            ; è·å–æ¨¡å¼å€¼</span><br><span class="line">        cmp al, 1</span><br><span class="line">        je timemode</span><br><span class="line">        cmp ah, 02              ; 1çš„æ‰«æç 02</span><br><span class="line">        je sub1</span><br><span class="line">        cmp ah, 03              ; 2çš„æ‰«æç 03</span><br><span class="line">        je sub2</span><br><span class="line">        cmp ah, 04              ; 3çš„æ‰«æç 04</span><br><span class="line">        je sub3</span><br><span class="line">        cmp ah, 05              ; 4çš„æ‰«æç 05</span><br><span class="line">        je sub4</span><br><span class="line">        jmp int9ret</span><br><span class="line">timemode:</span><br><span class="line">        cmp ah, 3bh             ; F1çš„æ‰«æç 3bh</span><br><span class="line">        je subf1</span><br><span class="line">        cmp ah, 01              ; Escçš„æ‰«æç 01</span><br><span class="line">        je subesc</span><br><span class="line">        jmp int9ret</span><br><span class="line">int9ret:</span><br><span class="line">        pop si</span><br><span class="line">        pop bx</span><br><span class="line">        pop ax</span><br><span class="line">        iret</span><br></pre></td></tr></table></figure>

<p>é¦–å…ˆè°ƒç”¨BIOSçš„int 9ä¸­æ–­ä¾‹ç¨‹è¿›è¡Œå¤„ç†ï¼Œè¿™é‡Œä¸ºäº†æ¨¡æ‹Ÿ<code>int</code>æŒ‡ä»¤çš„æ“ä½œï¼Œæˆ‘ä»¬æ‰‹åŠ¨æ¨¡æ‹Ÿä¸­æ–­è¿‡ç¨‹ã€‚ä¸­æ–­è¿‡ç¨‹å¯ä»¥ç®€å•æè¿°å¦‚ä¸‹ï¼š</p>
<ol>
<li>å–å¾—ä¸­æ–­ç±»å‹ç N</li>
<li>pushf</li>
<li>TF&#x3D;0, IF&#x3D;0</li>
<li>push CS</li>
<li>push IP</li>
<li>(IP)&#x3D;(N*4), (CS)&#x3D;(N*4+2)</li>
</ol>
<p>å…¶ä¸­ç¬¬ä¸€æ­¥å·²ç»çŸ¥é“ï¼Œæˆ‘ä»¬éœ€è¦æ‰‹åŠ¨æ‰§è¡Œ<code>pushf</code>å°†æ ‡å¿—å¯„å­˜å™¨å…¥æ ˆï¼Œç¬¬ä¸‰æ­¥å¤–éƒ¨å·²ç»ç½®0ä¹Ÿå¯ä»¥çœç•¥ï¼Œ4ï½6æ­¥é€šè¿‡<code>call</code>æŒ‡ä»¤å®ç°ã€‚</p>
<p>ç„¶åæˆ‘ä»¬é€šè¿‡int 16hä¸­æ–­ä»é”®ç›˜ç¼“å†²åŒºè¯»å–æ•°æ®ï¼Œä¸ºäº†é˜²æ­¢ç¼“å†²åŒºæº¢å‡ºï¼Œè¿™é‡Œè¯»å–ä¹‹åå°†ç¼“å†²åŒºä¸­å¯¹åº”æ•°æ®ç§»é™¤ã€‚ï¼ˆå®é™…æµ‹è¯•å‘ç°å¦‚æœä¸ç§»é™¤ï¼Œç¼“å†²åŒºæ»¡äº†ä¹‹åé”®ç›˜è¾“å…¥å°±æ²¡æœ‰å“åº”äº†ï¼‰ã€‚</p>
<p>è·å–åˆ°é”®ç›˜æ‰«æç ä¹‹åï¼Œé¦–å…ˆåˆ¤æ–­å½“å‰æ¨¡å¼ï¼Œå¦‚æœæ˜¯æ¨¡å¼0ï¼Œå¤„ç†æŒ‰é”®1~4ï¼›å¦‚æœæ˜¯æ¨¡å¼1ï¼Œå¤„ç†æŒ‰é”®F1å’ŒEscã€‚å¤„ç†ç»“æŸä¹‹åéƒ½ä¼šè·³åˆ°int9retå¤„ä¸­æ–­è¿”å›ã€‚</p>
<p>æ¥ä¸‹æ¥ä¾æ¬¡æ¥çœ‹æ¯ä¸ªæŒ‰é”®çš„å¤„ç†</p>
<h4 id="æŒ‰é”®1-é‡æ–°å¯åŠ¨"><a href="#æŒ‰é”®1-é‡æ–°å¯åŠ¨" class="headerlink" title="æŒ‰é”®1: é‡æ–°å¯åŠ¨"></a>æŒ‰é”®1: é‡æ–°å¯åŠ¨</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sub1:</span><br><span class="line">        pop si</span><br><span class="line">        pop ax</span><br><span class="line">        mov ax, 0ffffh</span><br><span class="line">        push ax</span><br><span class="line">        mov ax, 0</span><br><span class="line">        push ax</span><br><span class="line">        retf                    ; 0ffffh:0</span><br></pre></td></tr></table></figure>

<p>æŒ‰é”®1çš„å¤„ç†éå¸¸ç®€å•ï¼Œç›´æ¥è·³è½¬åˆ°ffff:0å³å¯ã€‚</p>
<h4 id="æŒ‰é”®2-bootæ“ä½œç³»ç»Ÿ"><a href="#æŒ‰é”®2-bootæ“ä½œç³»ç»Ÿ" class="headerlink" title="æŒ‰é”®2: bootæ“ä½œç³»ç»Ÿ"></a>æŒ‰é”®2: bootæ“ä½œç³»ç»Ÿ</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sub2:</span><br><span class="line">        push cx</span><br><span class="line">        push dx</span><br><span class="line">        push es</span><br><span class="line">        call umount9            ; è°ƒç”¨umount9</span><br><span class="line"></span><br><span class="line">        ; æ¸…å±</span><br><span class="line">        mov ah, 0               ; åŠŸèƒ½å·0, æ¸…å±</span><br><span class="line">        call screen</span><br><span class="line"></span><br><span class="line">        mov dh, 0               ; è¡Œå·</span><br><span class="line">        mov dl, 0               ; åˆ—å·</span><br><span class="line">        mov bx, 0               ; bhé¡µå·</span><br><span class="line">        mov ah, 2               ; åŠŸèƒ½å·2: è®¾ç½®å…‰æ ‡</span><br><span class="line">        int 10h</span><br><span class="line"></span><br><span class="line">; ä»ç¡¬ç›˜ç¬¬ä¸€ä¸ªæ‰‡åŒºè¯»å–åˆ°0:7c00hå¤„</span><br><span class="line">; ç„¶åè·³è½¬</span><br><span class="line">        mov ax, 0</span><br><span class="line">        mov es, ax</span><br><span class="line">        mov bx, 7c00h           ; es:bx æŒ‡å‘æ¥æ”¶ä»æ‰‡åŒºè¯»å–æ•°æ®çš„å†…å­˜åŒº</span><br><span class="line"></span><br><span class="line">        mov al, 1               ; è¯»å–çš„æ‰‡åŒºæ•°</span><br><span class="line">        mov ch, 0               ; ç£é“å·</span><br><span class="line">        mov cl, 1               ; æ‰‡åŒºå·ï¼Œç¬¬ä¸€ä¸ªæ‰‡åŒºå¼€å§‹</span><br><span class="line">        mov dl, 80h             ; é©±åŠ¨å™¨å·  è½¯é©±ä»0å¼€å§‹ï¼Œ0:è½¯é©±Aï¼Œ1:è½¯é©±Bï¼›ç¡¬ç›˜ä»80hå¼€å§‹ï¼Œ80hï¼šç¡¬ç›˜Cï¼Œ81hï¼šç¡¬ç›˜D</span><br><span class="line">        mov dh, 0               ; ç£å¤´å·ï¼ˆå¯¹äºè½¯ç›˜å³é¢å·ï¼‰</span><br><span class="line">        mov ah, 2               ; åŠŸèƒ½å·ï¼Œ2è¡¨ç¤ºè¯»æ‰‡åŒºï¼Œ3è¡¨ç¤ºå†™æ‰‡åŒº</span><br><span class="line">        int 13h</span><br><span class="line"></span><br><span class="line">        ; éœ€è¦æ¸…æ ˆä¹ˆ</span><br><span class="line">        jmp bx                  ; è·³è½¬åˆ°ç¡¬ç›˜å¼•å¯¼</span><br></pre></td></tr></table></figure>

<p>æŒ‰é”®2ä»ç¡¬ç›˜å¼•å¯¼ç°æœ‰æ“ä½œç³»ç»Ÿï¼Œä¸ºäº†ä¸å½±å“åé¢çš„æ˜¾ç¤ºï¼Œæˆ‘ä»¬å…ˆè¿›è¡Œæ¸…å±æ“ä½œï¼Œå°†å…‰æ ‡è®¾åˆ°å¼€å¤´ï¼Œç„¶åå°†ç¡¬ç›˜çš„ç¬¬ä¸€ä¸ªæ‰‡åŒºè¯»å–åˆ°0:7c00å¤„ï¼Œæœ€åè·³è½¬åˆ°0:7c00å¤„å¼€å§‹æ‰§è¡Œã€‚</p>
<h4 id="æŒ‰é”®3-åŠ¨æ€æ˜¾ç¤ºCMOSæ—¶é—´"><a href="#æŒ‰é”®3-åŠ¨æ€æ˜¾ç¤ºCMOSæ—¶é—´" class="headerlink" title="æŒ‰é”®3: åŠ¨æ€æ˜¾ç¤ºCMOSæ—¶é—´"></a>æŒ‰é”®3: åŠ¨æ€æ˜¾ç¤ºCMOSæ—¶é—´</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sub3:</span><br><span class="line">        ; ä¿å­˜å±å¹•</span><br><span class="line">        mov ah, 2               ; åŠŸèƒ½å·2, ä¿å­˜</span><br><span class="line">        call screen</span><br><span class="line"></span><br><span class="line">        ; æ¸…å±</span><br><span class="line">        mov ah, 0               ; åŠŸèƒ½å·0, æ¸…å±</span><br><span class="line">        call screen</span><br><span class="line"></span><br><span class="line">        mov byte ptr [bx], 1    ; æ¨¡å¼æ”¹ä¸º1</span><br><span class="line"></span><br><span class="line">        push dx</span><br><span class="line">        mov dh, 0               ; è¡Œå·</span><br><span class="line">        mov dl, 17              ; åˆ—å·</span><br><span class="line">        mov bx, 0               ; bxå·²ç»ä¸ç”¨äº†, å¯ä»¥è¦†ç›–</span><br><span class="line">        mov ah, 2               ; åŠŸèƒ½å·2: è®¾ç½®å…‰æ ‡</span><br><span class="line">        int 10h</span><br><span class="line">        pop dx</span><br><span class="line"></span><br><span class="line">        jmp int9ret</span><br></pre></td></tr></table></figure>

<p><code>screen</code>æ˜¯æˆ‘ä»¬å°è£…çš„ä¸€ä¸ªå­ç¨‹åºï¼Œè´Ÿè´£å±å¹•ç›¸å…³æ“ä½œã€‚é¦–å…ˆä¿å­˜å½“å‰å±å¹•ï¼ˆä¸»é€‰å•ï¼‰ï¼Œç„¶åæ¸…å±ï¼Œå°†æ¨¡å¼æ”¹ä¸º1ï¼Œæœ€åä¸ºäº†ç¾è§‚ä¸€ç‚¹å°†å…‰æ ‡è®¾ç½®åˆ°äº†æ—¶é—´åé¢ã€‚ä¸­æ–­ä¾‹ç¨‹åªæ˜¯ä¿®æ”¹äº†æ¨¡å¼ï¼Œæ—¶é—´çš„åŠ¨æ€æ˜¾ç¤ºåœ¨å¤–é¢ä¸­ç¨‹åºå¾ªç¯ä¸­è¿›è¡Œã€‚å› ä¸ºåœ¨åŠ¨æ€æ˜¾ç¤ºæ—¶é—´çš„æ—¶å€™ï¼Œä¹Ÿæ˜¯éœ€è¦å¤„ç†é”®ç›˜æŒ‰é”®ä¸­æ–­çš„ã€‚</p>
<h4 id="æŒ‰é”®4-è®¾ç½®CMOSæ—¶é—´"><a href="#æŒ‰é”®4-è®¾ç½®CMOSæ—¶é—´" class="headerlink" title="æŒ‰é”®4: è®¾ç½®CMOSæ—¶é—´"></a>æŒ‰é”®4: è®¾ç½®CMOSæ—¶é—´</h4><p>æŒ‰é”®4çš„å¤„ç†ç¨å¾®æœ‰ç‚¹å¤æ‚ï¼Œæˆ‘ä»¬ä¸€ç‚¹ç‚¹æ¥çœ‹ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sub4:</span><br><span class="line">        push dx</span><br><span class="line">        call umount9            ; æ¢å¤åŸæ¥çš„int 9ä¸­æ–­ä¾‹ç¨‹</span><br><span class="line"></span><br><span class="line">        mov ah, 2               ; åŠŸèƒ½å·2, ä¿å­˜å±å¹•</span><br><span class="line">        call screen</span><br><span class="line"></span><br><span class="line">sub4s:</span><br><span class="line">        mov ah, 0               ; åŠŸèƒ½å·0, æ¸…å±</span><br><span class="line">        call screen</span><br><span class="line"></span><br><span class="line">        mov si, offset prompt-task+7e00h</span><br><span class="line">        mov dh, 0</span><br><span class="line">        mov dl, 0</span><br><span class="line">        call showstr            ; æ˜¾ç¤ºæç¤ºå­—ç¬¦ä¸²</span><br><span class="line"></span><br><span class="line">        mov dh, 1               ; è¡Œå·</span><br><span class="line">        mov bx, 0               ; bxå·²ç»ä¸ç”¨äº†, å¯ä»¥è¦†ç›–</span><br><span class="line">        mov ah, 2               ; åŠŸèƒ½å·2: è®¾ç½®å…‰æ ‡</span><br><span class="line">        int 10h</span><br><span class="line">        mov si, offset charstk-task+7e00h</span><br><span class="line">        call inputclock         ; ç”¨æˆ·è¾“å…¥å­—ç¬¦ä¸²</span><br><span class="line">        call checkclock         ; æ£€æŸ¥å­—ç¬¦ä¸²æ ¼å¼æ˜¯å¦åˆæ³•</span><br><span class="line">        cmp ah, 0</span><br><span class="line">        jne sub4s               ; æ ¼å¼ä¸æ­£ç¡®ï¼Œé‡æ–°è¾“å…¥</span><br><span class="line"></span><br><span class="line">        call setclock           ; å†™åˆ°CMOS RTC</span><br><span class="line"></span><br><span class="line">        mov ah, 3               ; åŠŸèƒ½å·3, æ¢å¤å±å¹•</span><br><span class="line">        call screen             ; call screen</span><br><span class="line"></span><br><span class="line">        mov dh, 5               ; è¡Œå·</span><br><span class="line">        mov dl, 0               ; åˆ—å·</span><br><span class="line">        mov bx, 0               ; bxå·²ç»ä¸ç”¨äº†, å¯ä»¥è¦†ç›–</span><br><span class="line">        mov ah, 2               ; åŠŸèƒ½å·2: è®¾ç½®å…‰æ ‡</span><br><span class="line">        int 10h</span><br><span class="line"></span><br><span class="line">        call mount9             ; é‡æ–°æ³¨å†Œæ–°çš„int9ä¸­æ–­ä¾‹ç¨‹</span><br><span class="line">        pop dx</span><br><span class="line">        jmp int9ret</span><br></pre></td></tr></table></figure>

<p>é¦–å…ˆè°ƒç”¨<code>umount9</code>æ¢å¤åŸæ¥çš„int 9ä¸­æ–­ä¾‹ç¨‹ï¼Œä¸å†é¢å¤–å¤„ç†é‚£äº›é”®ç›˜è¾“å…¥ï¼Œæ¥ç€ä¿å­˜å½“å‰å±å¹•ï¼ˆä¸»é€‰å•ï¼‰å¹¶æ¸…å±ï¼Œç„¶åæ˜¾ç¤ºä¸€ä¸ªæç¤ºå­—ç¬¦ä¸²å¹¶æ˜¾ç¤ºå…‰æ ‡åˆ°ä¸‹ä¸€è¡Œã€‚</p>
<p>è¿™äº›å‡†å¤‡å·¥ä½œåšå®Œä¹‹åï¼Œå°±è°ƒç”¨<code>intputclock</code>è®©ç”¨æˆ·è¾“å…¥å­—ç¬¦ä¸²ï¼Œç”¨æˆ·å®Œæˆè¾“å…¥ä¹‹åè°ƒç”¨<code>checkclock</code>æ£€æŸ¥æ ¼å¼æ˜¯å¦æ­£ç¡®ï¼Œå¦‚æœä¸æ­£ç¡®è·³åˆ°å‰é¢é‡æ–°è¾“å…¥ã€‚å¦‚æœæ ¼å¼æ­£ç¡®ï¼Œåˆ™è°ƒç”¨<code>setclock</code>å°†æ—¶é—´å†™åˆ°CMOSä¸Šã€‚</p>
<p>å®Œæˆè®¾ç½®ä¹‹åï¼Œè¿˜æœ‰ä¸€äº›æ¢å¤çš„å·¥ä½œåˆ«å¿˜äº†ï¼Œéœ€è¦æ¢å¤å±å¹•åŠå…‰æ ‡ä½ç½®ï¼Œç„¶åé‡æ–°æ³¨å†Œint 9ä¸­æ–­ä¾‹ç¨‹ã€‚</p>
<h4 id="æŒ‰é”®F1-ä¿®æ”¹æ˜¾ç¤ºé¢œè‰²"><a href="#æŒ‰é”®F1-ä¿®æ”¹æ˜¾ç¤ºé¢œè‰²" class="headerlink" title="æŒ‰é”®F1: ä¿®æ”¹æ˜¾ç¤ºé¢œè‰²"></a>æŒ‰é”®F1: ä¿®æ”¹æ˜¾ç¤ºé¢œè‰²</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">subf1:</span><br><span class="line">        mov ah, 1               ; åŠŸèƒ½å·1, ä¿®æ”¹é¢œè‰²</span><br><span class="line">        call screen</span><br><span class="line">        jmp int9ret</span><br></pre></td></tr></table></figure>

<p>å› ä¸ºæˆ‘ä»¬å°†å±å¹•çš„ç›¸å…³æ“ä½œéƒ½å°è£…æˆäº†screenå‡½æ•°ï¼Œæ‰€ä»¥è¿™é‡Œç®€å•è°ƒç”¨å³å¯</p>
<h4 id="æŒ‰é”®Esc-é€€å‡ºæ—¶é—´æ˜¾ç¤ºï¼Œæ¢å¤ä¸ºä¸»é€‰å•"><a href="#æŒ‰é”®Esc-é€€å‡ºæ—¶é—´æ˜¾ç¤ºï¼Œæ¢å¤ä¸ºä¸»é€‰å•" class="headerlink" title="æŒ‰é”®Esc: é€€å‡ºæ—¶é—´æ˜¾ç¤ºï¼Œæ¢å¤ä¸ºä¸»é€‰å•"></a>æŒ‰é”®Esc: é€€å‡ºæ—¶é—´æ˜¾ç¤ºï¼Œæ¢å¤ä¸ºä¸»é€‰å•</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">subesc:</span><br><span class="line">        ; æ¢å¤å±å¹•</span><br><span class="line">        mov ah, 3               ; åŠŸèƒ½å·3, æ¢å¤</span><br><span class="line">        call screen</span><br><span class="line"></span><br><span class="line">        mov byte ptr [bx], 0    ; æ¨¡å¼æ”¹ä¸º0</span><br><span class="line"></span><br><span class="line">        push dx</span><br><span class="line">        mov dh, 5               ; è¡Œå·</span><br><span class="line">        mov dl, 0               ; åˆ—å·</span><br><span class="line">        mov bx, 0               ; bxå·²ç»ä¸ç”¨äº†, å¯ä»¥è¦†ç›–</span><br><span class="line">        mov ah, 2               ; åŠŸèƒ½å·2: è®¾ç½®å…‰æ ‡</span><br><span class="line">        int 10h</span><br><span class="line">        pop dx</span><br><span class="line"></span><br><span class="line">        jmp int9ret</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªä¹Ÿæ¯”è¾ƒç®€å•ï¼Œæ¢å¤å±å¹•ï¼Œè®¾ç½®å…‰æ ‡ä½ç½®ï¼Œå°†æ¨¡å¼ä¿®æ”¹ä¸º0ã€‚</p>
<h3 id="å±å¹•æ“ä½œå­ç¨‹åº"><a href="#å±å¹•æ“ä½œå­ç¨‹åº" class="headerlink" title="å±å¹•æ“ä½œå­ç¨‹åº"></a>å±å¹•æ“ä½œå­ç¨‹åº</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">; å±å¹•ç›¸å…³æ“ä½œ</span><br><span class="line">; ah åŠŸèƒ½å·: 0æ¸…å±, 1æ¢é¢œè‰², 2ä¿å­˜å½“å‰å±å¹•ï¼Œ3æ¢å¤ä¿å­˜çš„å±å¹•</span><br><span class="line">; ä»ç¬¬0é¡µä¿å­˜åˆ°ç¬¬1é¡µï¼Œä»ç¬¬1é¡µæ¢å¤åˆ°ç¬¬0é¡µ</span><br><span class="line">screen:</span><br><span class="line">        push ax</span><br><span class="line">        push bx</span><br><span class="line">        push cx</span><br><span class="line">        push ds</span><br><span class="line">        push es</span><br><span class="line">        push si</span><br><span class="line">        push di</span><br><span class="line"></span><br><span class="line">        cmp ah, 0</span><br><span class="line">        je clear</span><br><span class="line">        cmp ah, 1</span><br><span class="line">        je color</span><br><span class="line">        cmp ah, 2</span><br><span class="line">        je save</span><br><span class="line">        cmp ah, 3</span><br><span class="line">        je restore</span><br><span class="line">        jmp screenret</span><br><span class="line">        </span><br><span class="line">        ; çœç•¥</span><br><span class="line">screenret:</span><br><span class="line">        pop di</span><br><span class="line">        pop si</span><br><span class="line">        pop es</span><br><span class="line">        pop ds</span><br><span class="line">        pop cx</span><br><span class="line">        pop bx</span><br><span class="line">        pop ax</span><br><span class="line">        ret</span><br></pre></td></tr></table></figure>

<p><code>screen</code>å­ç¨‹åºåŒ…å«4ä¸ªåŠŸèƒ½ï¼Œç”±ahå¯„å­˜å™¨æŒ‡å®šåŠŸèƒ½å·ã€‚</p>
<p>(ah)&#x3D;0è¡¨ç¤ºæ¸…å±æ“ä½œï¼Œä¿®æ”¹ç¬¬0é¡µçš„æ˜¾ç¤ºç¼“å†²åŒºï¼Œæ‰€æœ‰å­—ç¬¦éƒ½æ”¹æˆç©ºæ ¼ï¼Œé¢œè‰²å±æ€§æ”¹æˆé»‘åº•ç™½å­—ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">clear:</span><br><span class="line">        mov ax, 0b800h                  ; æ˜¾ç¤ºç¼“å†²åŒºç¬¬0é¡µèµ·å§‹åœ°å€</span><br><span class="line">        mov ds, ax</span><br><span class="line">        mov si, 0</span><br><span class="line">        mov cx, 2000                    ; 80 * 25</span><br><span class="line">clears:</span><br><span class="line">        mov byte ptr [si], &#x27; &#x27;          ; æ¸…å±</span><br><span class="line">        mov byte ptr [si].1, 00000111b  ; é»‘åº•ç™½å­—</span><br><span class="line">        add si, 2</span><br><span class="line">        loop clears</span><br><span class="line">        jmp screenret</span><br></pre></td></tr></table></figure>

<p>(ah)&#x3D;1è¡¨ç¤ºä¿®æ”¹æ˜¾ç¤ºé¢œè‰²ï¼Œæ“ä½œè·Ÿä¸Šé¢ç±»ä¼¼</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">color:</span><br><span class="line">        mov ax, 0b800h                  ; æ˜¾ç¤ºç¼“å†²åŒºç¬¬0é¡µèµ·å§‹åœ°å€</span><br><span class="line">        mov ds, ax</span><br><span class="line">        mov si, 1</span><br><span class="line">        mov cx, 2000                    ; 80 * 25</span><br><span class="line">colors:</span><br><span class="line">        inc byte ptr [si]               ; ä¿®æ”¹é¢œè‰²</span><br><span class="line">        add si, 2</span><br><span class="line">        loop colors</span><br><span class="line">        jmp screenret</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>(ah)&#x3D;2è¡¨ç¤ºä¿å­˜å½“å‰å±å¹•ï¼Œæˆ‘ä»¬é€‰æ‹©å°†æ˜¾ç¤ºç¼“å†²åŒºç¬¬0é¡µå†…å®¹æ‹·è´åˆ°äº†ç¬¬1é¡µä¸­ã€‚è¿™é‡Œä½¿ç”¨äº†ä¸²å¤„ç†æŒ‡ä»¤ç®€åŒ–ä»£ç ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">save:</span><br><span class="line">        mov ax, 0b800h                  ; ç¬¬0é¡µèµ·å§‹åœ°å€</span><br><span class="line">        mov ds, ax</span><br><span class="line">        mov si, 0</span><br><span class="line">        mov ax, 0b8fah                  ; ç¬¬1é¡µèµ·å§‹åœ°å€</span><br><span class="line">        mov es, ax</span><br><span class="line">        mov di, 0</span><br><span class="line">        mov cx, 4000                    ; 80 * 25 * 2</span><br><span class="line">        cld                             ; df=0</span><br><span class="line">        rep movsb</span><br><span class="line">        jmp screenret</span><br></pre></td></tr></table></figure>

<p>(ah)&#x3D;2è¡¨ç¤ºæ¢å¤ä¿å­˜çš„å±å¹•ï¼Œä¹Ÿå³æ‰§è¡Œè·Ÿå‰ä¸€ä¸ªç›¸åçš„æ“ä½œï¼Œå°†ç¬¬1é¡µçš„å†…å®¹æ‹·è´åˆ°ç¬¬0é¡µã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">restore:</span><br><span class="line">        mov ax, 0b8fah                  ; ç¬¬1é¡µèµ·å§‹åœ°å€</span><br><span class="line">        mov ds, ax</span><br><span class="line">        mov si, 0</span><br><span class="line">        mov ax, 0b800h                  ; ç¬¬0é¡µèµ·å§‹åœ°å€</span><br><span class="line">        mov es, ax</span><br><span class="line">        mov di, 0</span><br><span class="line">        mov cx, 4000</span><br><span class="line">        cld                             ; df=0</span><br><span class="line">        rep movsb</span><br></pre></td></tr></table></figure>

<h3 id="æ—¶é—´è¾“å…¥å­ç¨‹åº"><a href="#æ—¶é—´è¾“å…¥å­ç¨‹åº" class="headerlink" title="æ—¶é—´è¾“å…¥å­ç¨‹åº"></a>æ—¶é—´è¾“å…¥å­ç¨‹åº</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">; è¾“å…¥æ—¶é—´ï¼Œä»é”®ç›˜ç¼“å†²åŒºè¯»å–</span><br><span class="line">; dh, dl æ˜¾ç¤ºçš„è¡Œå·åˆ—å·</span><br><span class="line">; ds:si æŒ‡å‘å­—ç¬¦æ ˆèµ·å§‹ä½ç½®</span><br><span class="line">inputclock:</span><br><span class="line">        push ax</span><br><span class="line">        push bx</span><br><span class="line">        push si</span><br><span class="line"></span><br><span class="line">        mov bx, offset top-task+7e00h</span><br><span class="line">        mov word ptr [bx], 0    ; topå…ˆæ¸…0</span><br><span class="line"></span><br><span class="line">        ; å…ˆæ¸…ç©ºé”®ç›˜ç¼“å†²åŒº</span><br><span class="line">cleanbuf:</span><br><span class="line">        mov ah, 1</span><br><span class="line">        int 16h</span><br><span class="line">        je getstrs</span><br><span class="line">        mov ah, 0</span><br><span class="line">        int 16h</span><br><span class="line">        jmp cleanbuf</span><br><span class="line">        </span><br><span class="line">getstrs:</span><br><span class="line">        mov ah, 0</span><br><span class="line">        int 16h</span><br><span class="line">        cmp al, 20h             ; ASCIIç å°äº20hï¼Œè¯´æ˜ä¸æ˜¯å­—ç¬¦</span><br><span class="line">        jb nochar</span><br><span class="line">        mov ah, 0</span><br><span class="line">        call charstack          ; å­—ç¬¦å…¥æ ˆ</span><br><span class="line">        mov ah, 2</span><br><span class="line">        call charstack          ; æ˜¾ç¤ºæ ˆä¸­çš„å­—ç¬¦</span><br><span class="line">        jmp getstrs</span><br><span class="line">nochar:</span><br><span class="line">        cmp ah, 0eh             ; é€€æ ¼é”®çš„æ‰«æç </span><br><span class="line">        je backspace</span><br><span class="line">        cmp ah, 1ch             ; Enteré”®çš„æ‰«æç </span><br><span class="line">        je enter</span><br><span class="line">        jmp getstrs</span><br><span class="line">backspace:</span><br><span class="line">        mov ah, 1</span><br><span class="line">        call charstack          ; å­—ç¬¦å‡ºæ ˆ</span><br><span class="line">        mov ah, 2</span><br><span class="line">        call charstack          ; æ˜¾ç¤ºæ ˆä¸­çš„å­—ç¬¦</span><br><span class="line">        jmp getstrs</span><br><span class="line">enter:</span><br><span class="line">        pop si</span><br><span class="line">        pop bx</span><br><span class="line">        pop ax</span><br><span class="line">        ret</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªå­—ç¬¦æ ˆæ¥ä¿å­˜ç”¨æˆ·è¾“å…¥çš„å­—ç¬¦ä¸²ï¼Œä¸ºäº†ä»£ç çš„ç®€æ´å°†å­—ç¬¦æ ˆçš„ç›¸å…³æ“ä½œå°è£…æˆäº†<code>charstack</code>å­ç¨‹åºã€‚</p>
<p>é¦–å…ˆå°†topæ¸…é›¶ï¼Œä¿é™©èµ·è§å°†é”®ç›˜ç¼“å†²åŒºæ¸…ç†äº†ä¸€ä¸‹ã€‚æ¥ä¸‹æ¥è°ƒç”¨int 16hä¸­æ–­è¯»å–ç”¨æˆ·çš„é”®ç›˜è¾“å…¥ï¼Œå¦‚æœæ˜¯å­—ç¬¦å°±å…¥æ ˆï¼Œå¦‚æœæ˜¯é€€æ ¼é”®å°±å‡ºæ ˆï¼Œå¦‚æœæ˜¯Enteré”®åˆ™ç»“æŸè¾“å…¥ã€‚æ¯æ¬¡ç”¨æˆ·åšäº†ä¿®æ”¹ä¹‹åï¼Œæ›´æ–°æ˜¾ç¤ºã€‚</p>
<p>å­—ç¬¦æ ˆçš„å­ç¨‹åºå®ç°å¦‚ä¸‹</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">; å­—ç¬¦æ ˆçš„å…¥æ ˆã€å‡ºæ ˆå’Œæ˜¾ç¤º</span><br><span class="line">; å‚æ•°è¯´æ˜: (ah)=åŠŸèƒ½å·ï¼Œ0å…¥æ ˆï¼Œ1å‡ºæ ˆï¼Œ2æ˜¾ç¤º</span><br><span class="line">;           ds:si æŒ‡å‘å­—ç¬¦æ ˆç©ºé—´</span><br><span class="line">;           å¯¹äº0å·åŠŸèƒ½: (al)=å…¥æ ˆå­—ç¬¦</span><br><span class="line">;           å¯¹äº1å·åŠŸèƒ½: (al)=è¿”å›çš„å­—ç¬¦</span><br><span class="line">;           å¯¹äº2å·åŠŸèƒ½: (dh)å’Œ(dl)=å­—ç¬¦ä¸²åœ¨å±å¹•ä¸Šæ˜¾ç¤ºçš„è¡Œã€åˆ—</span><br><span class="line">charstack:</span><br><span class="line">        push bx</span><br><span class="line">        push di</span><br><span class="line">        push es</span><br><span class="line">        push bp</span><br><span class="line">        mov bp, offset top-task+7e00h</span><br><span class="line">        cmp ah, 0</span><br><span class="line">        je charpush</span><br><span class="line">        cmp ah, 1</span><br><span class="line">        je charpop</span><br><span class="line">        cmp ah, 2</span><br><span class="line">        je charshow</span><br><span class="line">        jmp charret</span><br><span class="line">        </span><br><span class="line">charpush:</span><br><span class="line">        mov bx, ds:[bp]         ; topçš„å€¼</span><br><span class="line">        cmp bx, 31              ; é˜²æ­¢æº¢å‡º</span><br><span class="line">        ja charret</span><br><span class="line">        mov [si][bx], al</span><br><span class="line">        inc word ptr ds:[bp]</span><br><span class="line">        jmp charret</span><br><span class="line">charpop:</span><br><span class="line">        cmp word ptr ds:[bp], 0</span><br><span class="line">        je charret</span><br><span class="line">        dec word ptr ds:[bp]</span><br><span class="line">        mov bx, ds:[bp]</span><br><span class="line">        mov al, [si][bx]</span><br><span class="line">        jmp charret</span><br><span class="line">charshow:</span><br><span class="line">        mov bx, 0b800h</span><br><span class="line">        mov es, bx</span><br><span class="line">        mov ax, 160</span><br><span class="line">        mul dh                  ; è¡Œå·*160</span><br><span class="line">        mov di, ax</span><br><span class="line">        mov ax, 2</span><br><span class="line">        mul dl                  ; åˆ—å·*2</span><br><span class="line">        add di, ax</span><br><span class="line"></span><br><span class="line">        mov bx, 0</span><br><span class="line">charshows:</span><br><span class="line">        cmp bx, ds:[bp]</span><br><span class="line">        jne noempty</span><br><span class="line">        mov byte ptr es:[di], &#x27; &#x27;</span><br><span class="line"></span><br><span class="line">        push dx</span><br><span class="line">        mov dl, bl</span><br><span class="line">        mov bx, 0               ; bxå·²ç»ä¸ç”¨äº†, å¯ä»¥è¦†ç›–</span><br><span class="line">        mov ah, 2               ; åŠŸèƒ½å·2: è®¾ç½®å…‰æ ‡</span><br><span class="line">        int 10h</span><br><span class="line">        pop dx</span><br><span class="line">        jmp charret</span><br><span class="line">noempty:</span><br><span class="line">        mov al, [si][bx]</span><br><span class="line">        mov es:[di], al</span><br><span class="line">        mov byte ptr es:[di+2], &#x27; &#x27;</span><br><span class="line">        inc bx</span><br><span class="line">        add di, 2</span><br><span class="line">        jmp charshows</span><br><span class="line"></span><br><span class="line">charret:</span><br><span class="line">        pop bp</span><br><span class="line">        pop es</span><br><span class="line">        pop di</span><br><span class="line">        pop bx</span><br><span class="line">        ret</span><br></pre></td></tr></table></figure>

<p>(ah)è¡¨ç¤ºåŠŸèƒ½å·ï¼Œ0å…¥æ ˆï¼Œ1å‡ºæ ˆï¼Œ2æ˜¾ç¤ºã€‚æ³¨æ„å…¥æ ˆå’Œå‡ºæ ˆæ—¶è¦æ£€æŸ¥æ ˆé¡¶ä½ç½®ï¼Œé˜²æ­¢æº¢å‡ºã€‚å¦å¤–ï¼Œåœ¨æ˜¾ç¤ºçš„æ—¶å€™ï¼Œæˆ‘ä»¬å°†æœ€åä¸€ä¸ªå­—ç¬¦åé¢çš„ä½ç½®ä¹Ÿç½®æˆäº†ç©ºæ ¼ï¼Œæ˜¯ä¸ºäº†å¤„ç†é€€æ ¼çš„æƒ…å†µã€‚</p>
<h3 id="æ—¶é—´æ£€æŸ¥å­ç¨‹åº"><a href="#æ—¶é—´æ£€æŸ¥å­ç¨‹åº" class="headerlink" title="æ—¶é—´æ£€æŸ¥å­ç¨‹åº"></a>æ—¶é—´æ£€æŸ¥å­ç¨‹åº</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">; æ£€æŸ¥æ—¶é—´æ ¼å¼æ˜¯å¦æ­£ç¡®</span><br><span class="line">; å‚æ•°: ds:siæŒ‡å‘å­—ç¬¦æ ˆèµ·å§‹ä½ç½®</span><br><span class="line">; è¿”å›: (ah)=0è¡¨ç¤ºæ ¼å¼æ­£ç¡®, (ah)=1è¡¨ç¤ºæ ¼å¼é”™è¯¯</span><br><span class="line">; yy/MM/dd hh:mm:ss</span><br><span class="line">checkclock:</span><br><span class="line">        push bx</span><br><span class="line">        push cx</span><br><span class="line">        push dx</span><br><span class="line">        push si</span><br><span class="line">        push di</span><br><span class="line">        push ax</span><br><span class="line"></span><br><span class="line">        ; æ£€æŸ¥æ•°å­—</span><br><span class="line">        mov di, offset digitoffset-task+7e00h</span><br><span class="line">        mov bx, 0</span><br><span class="line">        mov cx, 12</span><br><span class="line">        </span><br><span class="line">checkdigits:</span><br><span class="line">        mov bl, [di]            ; è·å–æ•°å­—åœ¨å­—ç¬¦ä¸²ä¸­çš„åç§»é‡</span><br><span class="line">        mov al, [si][bx]</span><br><span class="line">        call isdigit            ; æ£€æŸ¥å¯¹åº”ä½ç½®æ˜¯å¦æ˜¯æ•°å­—</span><br><span class="line">        cmp ah, 0</span><br><span class="line">        jne checkfail           ; è¿”å›å€¼0è¡¨ç¤ºæ˜¯æ•°å­—</span><br><span class="line">        inc di</span><br><span class="line">        loop checkdigits</span><br><span class="line"></span><br><span class="line">        ; æ£€æŸ¥ç‰¹æ®Šç¬¦å·</span><br><span class="line">        mov cx, 5</span><br><span class="line">        mov di, offset timeformat-task+7e00h</span><br><span class="line">        mov bx, 2               ; +3</span><br><span class="line">checksigns:</span><br><span class="line">        mov al, [di][bx]</span><br><span class="line">        cmp [si][bx], al        ; æ£€æŸ¥å¯¹åº”ä½ç½®çš„ç¬¦å·æ˜¯å¦æ­£ç¡®</span><br><span class="line">        jne checkfail</span><br><span class="line">        add bx, 3</span><br><span class="line">        loop checksigns</span><br><span class="line"></span><br><span class="line">        ; æ£€æŸ¥æ—¥æœŸ</span><br><span class="line">        call checkdate          ; æ£€æŸ¥æ—¥æœŸæ˜¯å¦åˆæ³•ï¼ŒåŒ…æ‹¬é—°å¹´çš„æ£€æŸ¥</span><br><span class="line">        cmp ah, 0</span><br><span class="line">        jne checkfail</span><br><span class="line"></span><br><span class="line">        ; æ£€æŸ¥æ—¶é—´</span><br><span class="line">        add si, 9</span><br><span class="line">        call checktime          ; æ£€æŸ¥æ—¶é—´æ˜¯å¦åˆæ³•</span><br><span class="line">        cmp ah, 0</span><br><span class="line">        jne checkfail</span><br><span class="line"></span><br><span class="line">        pop ax</span><br><span class="line">        mov ah, 0</span><br><span class="line">        jmp checkend</span><br><span class="line">checkfail:</span><br><span class="line">        pop ax</span><br><span class="line">        mov ah, 1</span><br><span class="line">checkend:</span><br><span class="line">        pop di</span><br><span class="line">        pop si</span><br><span class="line">        pop dx</span><br><span class="line">        pop cx</span><br><span class="line">        pop bx</span><br><span class="line">        ret</span><br></pre></td></tr></table></figure>

<p><code>checkclock</code>å­ç¨‹åºç”¨äºæ£€æŸ¥æ ¼å¼ï¼Œé¦–å…ˆè¦ç¡®ä¿ç”¨æˆ·è¾“å…¥çš„å­—ç¬¦ä¸²æ˜¯<code>yy/MM/dd hh:mm:ss</code>æ ¼å¼çš„ï¼Œè¿™éƒ¨åˆ†æ¯”è¾ƒç®€å•ï¼Œå…¶ä¸­<code>isdigit</code>ç”¨äºæ£€æŸ¥æŸä¸ªå­—ç¬¦æ˜¯å¦æ˜¯æ•°å­—ã€‚ç„¶åè¿˜è¦æ£€æŸ¥æ—¥æœŸå’Œæ—¶é—´æ˜¯å¦åˆæ³•çš„ï¼Œå› ä¸ºè¿™å—æ¯”è¾ƒå¤æ‚ï¼Œåˆ†åˆ«å°è£…æˆäº†ä¸¤ä¸ªå­ç¨‹åº<code>checkdate</code>å’Œ<code>checktime</code>ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">; æ£€æŸ¥æ—¥æœŸæ˜¯å¦åˆæ³•</span><br><span class="line">; å‚æ•°: ds:siæŒ‡å‘å­—ç¬¦ä¸²èµ·å§‹ä½ç½®</span><br><span class="line">; è¿”å›: (ah)=0è¡¨ç¤ºæ ¼å¼æ­£ç¡®, (ah)=1è¡¨ç¤ºæ ¼å¼é”™è¯¯</span><br><span class="line">; YY/MM/dd</span><br><span class="line">checkdate:</span><br><span class="line">        push bx</span><br><span class="line">        push si</span><br><span class="line">        push di</span><br><span class="line">        push ax</span><br><span class="line"></span><br><span class="line">        ; æ£€æŸ¥æœˆä»½æ˜¯å¦è¶…å‡º</span><br><span class="line">        add si, 3               ; æœˆä»½ä»ä½ç½®3å¼€å§‹</span><br><span class="line">        call char2number        ; å°†ds:siæ‰€æŒ‡ä½ç½®çš„ä¸¤ä¸ªå­—ç¬¦è½¬æˆæ•°å€¼</span><br><span class="line">        cmp al, 1               ; æœˆä»½æœ‰æ•ˆå€¼1åˆ°12</span><br><span class="line">        jb datefail</span><br><span class="line">        cmp al, 12</span><br><span class="line">        ja datefail</span><br><span class="line"></span><br><span class="line">        mov bx, 0</span><br><span class="line">        mov bl, al              ; æœˆä»½å…ˆä¿å­˜åˆ°bl</span><br><span class="line"></span><br><span class="line">        ; æ£€æŸ¥æ—¥æœŸæ˜¯å¦è¶…å‡º</span><br><span class="line">        add si, 3               ; æ—¥æœŸä»ä½ç½®6å¼€å§‹</span><br><span class="line">        call char2number</span><br><span class="line">        cmp al, 1               ; æ—¥æœŸæœ€å°1</span><br><span class="line">        jb datefail</span><br><span class="line"></span><br><span class="line">        mov di, offset daysofmonth-task+7e00h</span><br><span class="line">        cmp al, [di][bx]</span><br><span class="line">        ja datefail             ; æœ€å¤§æ ¹æ®æœˆä»½æ¥åˆ¤æ–­</span><br><span class="line"></span><br><span class="line">        ; ä¸æ˜¯2æœˆ29æ—¥ä¸ç”¨æ£€æŸ¥é—°å¹´</span><br><span class="line">        cmp al, 29</span><br><span class="line">        jne datepass</span><br><span class="line">        cmp bl, 2</span><br><span class="line">        jne datepass</span><br><span class="line">    </span><br><span class="line">        ; æ£€æŸ¥é—°å¹´</span><br><span class="line">        mov bh, al              ; æ—¥æœŸå…ˆä¿å­˜åˆ°bl</span><br><span class="line">        mov ax, 0</span><br><span class="line">        sub si, 6</span><br><span class="line">        call char2number</span><br><span class="line">        add ax, 1900            ; (al)&gt;=90, è®¤ä¸ºæ˜¯19YY</span><br><span class="line">        cmp ax, 1990</span><br><span class="line">        jnb nineteenth</span><br><span class="line">        add ax, 100             ; (al)&lt;90, è®¤ä¸ºæ˜¯20YY</span><br><span class="line">nineteenth:</span><br><span class="line">        call isleapyear         ; åˆ¤æ–­axæ‰€è¡¨ç¤ºçš„å¹´ä»½æ˜¯å¦æ˜¯é—°å¹´</span><br><span class="line">        cmp ah, 0</span><br><span class="line">        jne datepass            ; é—°å¹´ä¸èƒ½æœ‰2æœˆ29æ—¥</span><br><span class="line">datefail:</span><br><span class="line">        pop ax</span><br><span class="line">        mov ah, 1</span><br><span class="line">        jmp dateend</span><br><span class="line">datepass:</span><br><span class="line">        pop ax</span><br><span class="line">        mov ah, 0</span><br><span class="line">dateend:</span><br><span class="line">        pop di</span><br><span class="line">        pop si</span><br><span class="line">        pop dx</span><br><span class="line">        ret</span><br></pre></td></tr></table></figure>

<p>é¦–å…ˆçœ‹æ—¥æœŸçš„æ£€æŸ¥ï¼Œæœˆä»½çš„æœ‰æ•ˆå€¼1åˆ°12ï¼Œæ—¥æœŸçš„æœ€å°å€¼ä¹Ÿæ˜¯1ï¼Œæœ€å¤§å€¼æ ¹æ®æœˆä»½æ¥å†³å®šï¼Œæˆ‘ä»¬å·²ç»å°†æ¯ä¸ªæœˆçš„å¤©æ•°åšæˆäº†è¡¨æ ¼æ”¾åœ¨æ•°æ®ä¸­ï¼Œå¯ä»¥ç›´æ¥æŸ¥è¡¨è·å–ã€‚å…¶ä¸­<code>char2number</code>ç”¨äºå°†ä¸¤ä¸ªå­—ç¬¦è½¬æˆå­—èŠ‚å‹æ•°å€¼ã€‚</p>
<p>å¦‚æœæ˜¯2æœˆ29æ—¥ï¼Œè¿˜éœ€è¦æ£€æŸ¥æ˜¯å¦æ˜¯é—°å¹´ï¼Œæˆ‘ä»¬å°†é—°å¹´çš„æ£€æŸ¥å°è£…æˆäº†<code>isleapyear</code>å­ç¨‹åºï¼Œç¯‡å¹…åŸå› ä¸å†å±•ç¤ºã€‚å¦å¤–ï¼Œå› ä¸º<a href="https://wiki.osdev.org/CMOS#The_Real-Time_Clock">CMOS RTCæ—¶é—´</a>ä¸ä¸€å®šæœ‰è¡¨ç¤ºä¸–çºªçš„å¯„å­˜å™¨ï¼Œæˆ‘ä»¬å°†å¤§äºç­‰äº90çš„å¹´ä»½è®¤ä¸ºæ˜¯20ä¸–çºªï¼Œå…¶ä½™çš„è®¤ä¸ºæ˜¯21ä¸–çºªã€‚</p>
<p><code>checktime</code>å­ç¨‹åºæ¯”è¾ƒç®€å•ï¼Œè¿™é‡Œä¸å†èµ˜è¿°ã€‚</p>
<h3 id="CMOS-RTCæ—¶é—´çš„è¯»å†™"><a href="#CMOS-RTCæ—¶é—´çš„è¯»å†™" class="headerlink" title="CMOS RTCæ—¶é—´çš„è¯»å†™"></a><a href="https://wiki.osdev.org/CMOS#The_Real-Time_Clock">CMOS RTCæ—¶é—´</a>çš„è¯»å†™</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">; è®¾ç½®CMOS RTCæ—¶é—´</span><br><span class="line">; å‚æ•°: ds:siæŒ‡å‘å­—ç¬¦ä¸²èµ·å§‹ä½ç½®</span><br><span class="line">; å®é™…æµ‹è¯•ï¼Œä¸æ˜¯é—°å¹´ä¹Ÿè®¾ç½®ä¸äº†2æœˆ29æ—¥</span><br><span class="line">; 2æœˆ28æ—¥ç›´æ¥è·³åˆ°3æœˆ1æ—¥, æš‚ä¸æ¸…æ¥šåŸå› </span><br><span class="line">setclock:</span><br><span class="line">        push ax</span><br><span class="line">        push cx</span><br><span class="line">        push si</span><br><span class="line">        push di</span><br><span class="line"></span><br><span class="line">        mov di, offset timeoffset-task+7e00h</span><br><span class="line">        mov cx, 6               ; å¾ªç¯æ¬¡æ•°</span><br><span class="line">setclocks:</span><br><span class="line">        mov al, [di]            ; è·å–å†…å­˜å•å…ƒå·</span><br><span class="line">        out 70h, al             ; å†™åˆ°æ§åˆ¶ç«¯å£</span><br><span class="line"></span><br><span class="line">        mov ah, [si]            ; åä½å­—ç¬¦</span><br><span class="line">        sub ah, 30h             ; å®é™…æ•°å€¼</span><br><span class="line">        push cx</span><br><span class="line">        mov cl, 4               ; å·¦ç§»ä½æ•°</span><br><span class="line">        shl ah, cl              ; é«˜4ä½æ”¾åä½çš„å€¼</span><br><span class="line">        pop cx</span><br><span class="line">        mov al, [si].1          ; ä¸ªä½å­—ç¬¦</span><br><span class="line">        sub al, 30h             ; å®é™…æ•°å€¼</span><br><span class="line">        add al, ah              ; ç›¸åŠ </span><br><span class="line"></span><br><span class="line">        out 71h, al             ; å†™åˆ°æ•°æ®ç«¯å£</span><br><span class="line"></span><br><span class="line">        add si, 3</span><br><span class="line">        inc di</span><br><span class="line">        loop setclocks</span><br><span class="line"></span><br><span class="line">        pop di</span><br><span class="line">        pop si</span><br><span class="line">        pop cx</span><br><span class="line">        pop ax</span><br><span class="line">        ret</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬é€šè¿‡ç«¯å£æ¥è·Ÿå¤–è®¾é€šä¿¡ï¼ŒCMOS RAMèŠ¯ç‰‡æœ‰ä¸¤ä¸ªç«¯å£70hå’Œ71hï¼Œ70hæ˜¯åœ°å€ç«¯å£ï¼Œå­˜æ”¾è¦è®¿é—®çš„CMOS RAMå•å…ƒåœ°å€ï¼›71hä¸ºæ•°æ®ç«¯å£ï¼Œå­˜æ”¾è¦è¯»å†™çš„æ•°æ®ã€‚æ¯æ¬¡å¯¹CMOS RAMçš„è¯»å†™åˆ†ä¸¤æ­¥è¿›è¡Œï¼Œé¦–å…ˆå°†åœ°å€å†™å…¥ç«¯å£70hï¼Œç„¶åå°†æ•°æ®å†™åˆ°71hç«¯å£ã€‚</p>
<p>æˆ‘ä»¬ä¾æ¬¡å°†å¹´æœˆæ—¥æ—¶åˆ†ç§’çš„å€¼å†™å…¥CMOSä¸­ï¼Œå…¶ä¸­æ—¶é—´ä¿¡æ¯éƒ½æ˜¯ä»¥BCDç çš„å½¢å¼å­˜æ”¾çš„ï¼Œä¸€ä¸ªå­—èŠ‚è¡¨ç¤ºä¸¤ä¸ªåè¿›åˆ¶æ•°ã€‚æ‰€ä»¥å†™ä¹‹å‰ï¼Œå…ˆè¦å°†ä¸¤ä¸ªå­—ç¬¦è½¬åŒ–å¯¹åº”çš„BCDç ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">; è®¾ç½®CMOS RTCæ—¶é—´</span><br><span class="line">; å‚æ•°: ds:siæŒ‡å‘å­—ç¬¦ä¸²èµ·å§‹ä½ç½®</span><br><span class="line">getclock:</span><br><span class="line">        push ax</span><br><span class="line">        push cx</span><br><span class="line">        push si</span><br><span class="line">        push di</span><br><span class="line"></span><br><span class="line">        mov di, offset timeoffset-task+7e00h</span><br><span class="line">        mov cx, 6               ; å¾ªç¯æ¬¡æ•°</span><br><span class="line">getclocks:</span><br><span class="line">        mov al, [di]            ; è·å–å†…å­˜å•å…ƒå·</span><br><span class="line">        out 70h, al             ; å†™åˆ°æ§åˆ¶ç«¯å£</span><br><span class="line">        in al, 71h              ; ä»æ•°æ®ç«¯å£è¯»å–</span><br><span class="line"></span><br><span class="line">        mov ah, al</span><br><span class="line">        push cx</span><br><span class="line">        mov cl, 4               ; å³ç§»ä½æ•°</span><br><span class="line">        shr ah, cl              ; ahä¸­ä¸ºåä½</span><br><span class="line">        pop cx</span><br><span class="line">        and al, 00001111b       ; alä¸­ä¸ºä¸ªä½</span><br><span class="line">        add ah, 30h             ; å¯¹åº”asciiç </span><br><span class="line">        add al, 30h             ; å¯¹åº”asciiç </span><br><span class="line">        mov [si], ah</span><br><span class="line">        mov [si].1, al</span><br><span class="line"></span><br><span class="line">        add si, 3</span><br><span class="line">        inc di</span><br><span class="line">        loop getclocks</span><br><span class="line"></span><br><span class="line">        pop di</span><br><span class="line">        pop si</span><br><span class="line">        pop cx</span><br><span class="line">        pop ax</span><br><span class="line">        ret</span><br></pre></td></tr></table></figure>

<p><code>getclock</code>å­ç¨‹åºç”¨äºä»CMOSè¯»å–ï¼Œæ“ä½œæ­£å¥½ç›¸åï¼Œè¿™é‡Œä¸å†èµ˜è¿°ã€‚</p>
<h2 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h2><p>æœ€ç»ˆå®Œæˆæ•´ä¸ªç¨‹åºä¹‹åï¼Œå¯ä»¥æŒ‰å¦‚ä¸‹æ­¥éª¤è¿›è¡Œæµ‹è¯•ï¼ˆè¿™é‡Œæˆ‘æ˜¯åœ¨DOSBoxç¯å¢ƒä¸‹å¼€å‘çš„ï¼Œç¨‹åºæ–‡ä»¶åä¸ºdesign2.asmï¼‰</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Z:\&gt;mount c ~</span><br><span class="line">Z:\&gt;c:</span><br><span class="line">C:\&gt;masm design2;</span><br><span class="line">C:\&gt;link design2;</span><br><span class="line">C:\&gt;imgmount 0 c:\floppy.img -t floppy -fs none</span><br><span class="line">C:\&gt;design2.ext</span><br><span class="line">C:\&gt;imgmount -u 0</span><br></pre></td></tr></table></figure>

<p>é¦–å…ˆè¿›è¡Œç¼–è¯‘ã€é“¾æ¥ï¼Œå› ä¸ºè½¯ç›˜æ˜ åƒæˆ‘ä»¬å‰é¢å·²ç»åšå¥½ï¼Œè¿™é‡Œç›´æ¥æŒ‚è½½å³å¯ï¼Œç„¶åè¿è¡Œdesign2å®‰è£…ç¨‹åºå°†ä»»åŠ¡ç¨‹åºå†™åˆ°è½¯ç›˜ä¸­ï¼Œæœ€åå†å¸è½½è½¯ç›˜æ˜ åƒã€‚</p>
<p>ç°åœ¨æˆ‘ä»¬å°±å¯ä»¥æŠŠè¿™ä¸ªè½¯ç›˜æ˜ åƒæ”¾åˆ°è™šæ‹Ÿæœºä¸Šè¿›è¡Œæµ‹è¯•äº†ï¼Œå¦‚æœè™šæ‹Ÿæœºæ²¡æœ‰åˆ›å»ºè¿‡è½¯é©±çš„è¯éœ€è¦å…ˆåˆ›å»ºä¸€ä¸ªï¼Œé€‰æ‹©å¯åŠ¨æ—¶è¿æ¥è¿™ä¸ªè½¯é©±ï¼Œç„¶åå¯åŠ¨è™šæ‹Ÿæœºï¼Œæ¥ä¸‹æ¥å°±æ˜¯è§è¯å¥‡è¿¹çš„æ—¶åˆ»äº†ã€‚</p>
<h2 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h2><p>å®Œæ•´çš„ä»£ç å·²ä¸Šä¼ <a href="https://github.com/catbro666/assembly-course-design2">Github</a>ï¼Œæ¬¢è¿äº¤æµè®¨è®ºã€‚</p>
]]></content>
      <categories>
        <category>ç†è§£è®¡ç®—æœº</category>
      </categories>
      <tags>
        <tag>8086</tag>
        <tag>æ±‡ç¼–</tag>
        <tag>DOS</tag>
      </tags>
  </entry>
  <entry>
    <title>ä¸€ç¯‡æ–‡ç« ææ‡‚å¯†ç å­¦åŸºç¡€åŠSSL/TLSåè®®</title>
    <url>/posts/e92ef4b4/</url>
    <content><![CDATA[<div class="note primary">
            <p>SSLåè®®æ˜¯ç°ä»£ç½‘ç»œé€šä¿¡ä¸­é‡è¦çš„ä¸€ç¯ï¼Œå®ƒæä¾›äº†ä¼ è¾“å±‚ä¸Šçš„æ•°æ®å®‰å…¨ã€‚ä¸ºäº†æ–¹ä¾¿å¤§å®¶çš„ç†è§£ï¼Œæœ¬æ–‡å°†å…ˆä»åŠ å¯†å­¦çš„åŸºç¡€çŸ¥è¯†å…¥æ‰‹ï¼Œç„¶åå±•å¼€å¯¹SSLåè®®åŸç†ã€æµç¨‹ä»¥åŠä¸€äº›é‡è¦çš„ç‰¹æ€§çš„è¯¦è§£ï¼Œæœ€åä¼šæ‰©å±•ä»‹ç»ä¸€ä¸‹å›½å¯†SSLåè®®çš„å·®å¼‚ã€å®‰å…¨æ€§ä»¥åŠTLS 1.3çš„å…³é”®æ–°ç‰¹æ€§ã€‚</p><p>é™äºç¯‡å¹…ä»¥åŠä¸ªäººçŸ¥è¯†æ°´å¹³ï¼Œæœ¬æ–‡ä¸ä¼šæ¶‰åŠè¿‡äºç»†èŠ‚çš„å†…å®¹ã€‚ç‰¹åˆ«åœ°ï¼Œæœ¬æ–‡å°†ä¸æ¶‰åŠç®—æ³•çš„å…·ä½“åŸç†ï¼Œä¹Ÿä¸æ¶‰åŠå®é™…ä»£ç çš„å®ç°ã€‚è€Œæ˜¯è¯•å›¾ä»¥å›¾è¡¨ç­‰ç›´è§‚çš„æ–¹å¼æ¥äº†è§£åŸºæœ¬çš„åŸç†ä»¥åŠæµç¨‹ã€‚</p>
          </div>

<span id="more"></span>

<h1 id="å¯†ç å­¦åŸºç¡€"><a href="#å¯†ç å­¦åŸºç¡€" class="headerlink" title="å¯†ç å­¦åŸºç¡€"></a>å¯†ç å­¦åŸºç¡€</h1><h2 id="å¤å…¸çš„å¯†ç "><a href="#å¤å…¸çš„å¯†ç " class="headerlink" title="å¤å…¸çš„å¯†ç "></a>å¤å…¸çš„å¯†ç </h2><p>å¯†ç å­¦çš„å†å²å¯ä»¥è¿½æº¯åˆ°å¾ˆä¹…ä»¥å‰ï¼Œæ—©åœ¨ç½—é©¬å…±å’Œå›½æ—¶æœŸï¼Œæ®è¯´å‡¯æ’’å°±ä½¿ç”¨å‡¯æ’’å¯†ç å’Œä»–çš„å°†å†›è¿›è¡Œé€šä¿¡ã€‚</p>
<h3 id="å‡¯æ’’å¯†ç "><a href="#å‡¯æ’’å¯†ç " class="headerlink" title="å‡¯æ’’å¯†ç "></a>å‡¯æ’’å¯†ç </h3><p><img src="https://cdn.jsdelivr.net/gh/catbro666/catbro666.github.io/posts/e92ef4b4/Caesar3.svg" alt="Caesar Cipher" loading="lazy"></p>
<p>å‡¯æ’’å¯†ç å°±æ˜¯ä¸€ä¸ªç®€å•åœ°ç§»ä½æ“ä½œã€‚å‡¯æ’’å¯†é’¥éå¸¸å®¹æ˜“è¢«ç ´è§£ï¼Œä½¿ç”¨<strong>æš´åŠ›ç ´è§£</strong>çš„æ–¹å¼æŠŠå¯†é’¥ä»0åˆ°25éƒ½å°è¯•ä¸€éå°±å¯ä»¥äº†ã€‚</p>
<h3 id="ç®€å•æ›¿æ¢å¯†ç "><a href="#ç®€å•æ›¿æ¢å¯†ç " class="headerlink" title="ç®€å•æ›¿æ¢å¯†ç "></a>ç®€å•æ›¿æ¢å¯†ç </h3><p><img src="https://cdn.jsdelivr.net/gh/catbro666/catbro666.github.io/posts/e92ef4b4/simple-substitution-cipher.png" alt="Simple Substitution Cipher" loading="lazy"></p>
<p>ç®€å•æ›¿æ¢å¯†ç ï¼Œå…¶æ˜æ–‡å­—æ¯è¡¨å’Œå¯†æ–‡å­—æ¯è¡¨ä¹‹é—´æ˜¯ä¸€ç§éšæœºçš„æ˜ å°„å…³ç³»ã€‚è¿™ç§æ–¹å¼å¯†é’¥ç©ºé—´ä¸º<code>26! ~= 4 * 10^26</code>ï¼Œè¿™å·²ç»æ— æ³•ä½¿ç”¨æš´åŠ›ç ´è§£æ–¹å¼æ¥æ‰¾åˆ°æ­£ç¡®çš„å¯†é’¥ã€‚ä½†æ˜¯å¯ä»¥ä½¿ç”¨<strong>é¢‘ç‡åˆ†æ</strong>æ¥ç ´è¯‘ã€‚</p>
<h3 id="Enigmaå¯†ç æœº"><a href="#Enigmaå¯†ç æœº" class="headerlink" title="Enigmaå¯†ç æœº"></a>Enigmaå¯†ç æœº</h3><p>äºŒæˆ˜æ—¶æœŸå¾·å›½ä½¿ç”¨çš„ä¸€ç³»åˆ—è½¬å­æœºæ¢°åŠ è§£å¯†æœºå™¨ã€‚å°½ç®¡æ­¤æœºå™¨çš„å®‰å…¨æ€§è¾ƒé«˜ï¼Œä½†ç›Ÿå†›çš„å¯†ç å­¦å®¶ä»¬è¿˜æ˜¯æˆåŠŸåœ°ç ´è¯‘äº†å¤§é‡ç”±è¿™ç§æœºå™¨åŠ å¯†çš„ä¿¡æ¯ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/catbro666/catbro666.github.io/posts/e92ef4b4/Enigma.jpg" alt="Enigma" loading="lazy"></p>
<p>ä¸»è¦å¼±ç‚¹ï¼š</p>
<ul>
<li>å°†é€šä¿¡å¯†ç è¿ç»­è¾“å…¥ä¸¤æ¬¡å¹¶åŠ å¯†</li>
<li>é€šä¿¡å¯†ç æ˜¯äººä¸ºé€‰å®š</li>
<li>å¿…é¡»æ´¾å‘å›½é˜²å†›å¯†ç æœ¬</li>
</ul>
<h2 id="å¯¹ç§°å¯†ç "><a href="#å¯¹ç§°å¯†ç " class="headerlink" title="å¯¹ç§°å¯†ç "></a>å¯¹ç§°å¯†ç </h2><h3 id="å—å¯†ç å’Œæµå¯†ç "><a href="#å—å¯†ç å’Œæµå¯†ç " class="headerlink" title="å—å¯†ç å’Œæµå¯†ç "></a>å—å¯†ç å’Œæµå¯†ç </h3><p>ä¸Šé¢å‡ ç§å¯†ç å…¶å®éƒ½å±äºå¯¹ç§°å¯†ç çš„èŒƒç•´ï¼Œå¯¹ç§°åŠ å¯†ç®—æ³•å¯ä»¥åˆ†ä¸ºå—å¯†ç å’Œæµå¯†ç ä¸¤ç§ï¼š</p>
<ul>
<li>å—å¯†ç ï¼ˆblock cipherï¼‰ï¼šæ¯æ¬¡åªèƒ½å¤„ç†ç‰¹å®šé•¿åº¦çš„æ•°æ®å—ã€‚ä¸€ä¸ªå—çš„é•¿åº¦å°±å«å—é•¿åº¦ï¼ˆåˆ†ç»„é•¿åº¦ï¼‰</li>
<li>æµå¯†ç ï¼ˆstream cipherï¼‰ï¼šå¯¹æ•°æ®æµè¿›è¡Œè¿ç»­å¤„ç†çš„ä¸€ç±»å¯†ç ç®—æ³•ã€‚ä¸€èˆ¬ä»¥1æ¯”ç‰¹ã€8æ¯”ç‰¹æˆ–32æ¯”ç‰¹ä¸ºå•ä½è¿›è¡ŒåŠ å¯†å’Œè§£å¯†ã€‚</li>
</ul>
<h3 id="AES-Advanced-Encryption-Standard"><a href="#AES-Advanced-Encryption-Standard" class="headerlink" title="AES (Advanced Encryption Standard)"></a>AES (Advanced Encryption Standard)</h3><p>AESæ˜¯ç›®å‰æœ€å¸¸ç”¨çš„å¯¹ç§°ç®—æ³•ä¹‹ä¸€ã€‚å¯¹ç§°åŠ å¯†ç®—æ³•ï¼Œé¡¾åæ€ä¹‰ï¼Œå°±æ˜¯<strong>åŠ å¯†å’Œè§£å¯†ä½¿ç”¨ç›¸åŒçš„å¯†é’¥</strong>ã€‚å‘é€æ–¹ä½¿ç”¨å¯†é’¥Kå¯¹æ˜æ–‡Pè¿›è¡ŒåŠ å¯†å¾—åˆ°å¯†æ–‡Cï¼Œç„¶åå°†å¯†æ–‡Cå‘é€ç»™æ¥æ”¶æ–¹ï¼Œæ¥æ”¶æ–¹ä½¿ç”¨ç›¸åŒçš„å¯†é’¥Kå¯¹å¯†æ–‡è¿›è¡Œè§£å¯†ï¼Œå¾—åˆ°æ˜æ–‡Pã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/catbro666/catbro666.github.io/posts/e92ef4b4/symmetric-cipher-flow.png" alt="symmetric-cipher-flow" loading="lazy"></p>
<p>AESé‡‡ç”¨çš„æ˜¯Rijndaelç®—æ³•ï¼Œä¸‹å›¾æ˜¯RijndaelåŠ å¯†ä¸­ä¸€è½®çš„æ“ä½œï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/catbro666/catbro666.github.io/posts/e92ef4b4/RijndaelEncrypt.png" alt="RijndaelEncrypt" loading="lazy"></p>
<p>æ¯ä¸€è½®éƒ½ä¼šè¿›è¡Œå­—èŠ‚æ›¿æ¢ã€è¡Œä½ç§»ã€åˆ—æ··åˆå’Œè½®å¯†é’¥å¼‚æˆ–ï¼Œä½¿å¾—è¾“å…¥çš„ä½å¾—åˆ°å……åˆ†çš„<strong>æ··æ·†</strong>ã€‚ä¸€ä¸ªå—çš„åŠ å¯†ä¼šç»è¿‡å¾ˆå¤šè½®çš„æ“ä½œï¼Œæœ€ç»ˆå¾—åˆ°å¯†æ–‡ã€‚</p>
<p>å› ä¸ºè¿™4è½®æ“ä½œéƒ½æ˜¯<strong>å¯é€†</strong>çš„ï¼Œè§£å¯†çš„æ—¶å€™å°±æ˜¯ä¸€ä¸ªç›¸åçš„è¿‡ç¨‹ã€‚</p>
<h2 id="å—å¯†ç çš„æ¨¡å¼"><a href="#å—å¯†ç çš„æ¨¡å¼" class="headerlink" title="å—å¯†ç çš„æ¨¡å¼"></a>å—å¯†ç çš„æ¨¡å¼</h2><h3 id="æ¨¡å¼"><a href="#æ¨¡å¼" class="headerlink" title="æ¨¡å¼"></a>æ¨¡å¼</h3><p>åˆ†ç»„å¯†ç ç®—æ³•åªèƒ½åŠ å¯†å›ºå®šé•¿åº¦çš„åˆ†ç»„ï¼Œä½†æ˜¯æˆ‘ä»¬éœ€è¦åŠ å¯†çš„æ˜æ–‡é•¿åº¦å¯èƒ½ä¼šè¶…è¿‡åˆ†ç»„å¯†ç çš„åˆ†ç»„é•¿åº¦ï¼Œè¿™æ—¶å°±éœ€è¦å¯¹åˆ†ç»„å¯†ç ç®—æ³•è¿›è¡Œè¿­ä»£ï¼Œä»¥ä¾¿å°†ä¸€æ®µå¾ˆé•¿çš„æ˜æ–‡å…¨éƒ¨åŠ å¯†ã€‚è€Œå—ä¸å—ä¹‹é—´è¿›è¡Œ<strong>è¿­ä»£çš„æ–¹æ³•</strong>å°±ç§°ä¸ºåˆ†ç»„å¯†ç çš„<strong>æ¨¡å¼ï¼ˆmodeï¼‰</strong>ã€‚</p>
<p>å¸¸ç”¨æ¨¡å¼ç”±ï¼šECBã€CBCã€OFBã€CFBã€CTRç­‰ã€‚è¿™è¾¹é™äºç¯‡å¹…ï¼Œä»…ä»‹ç»ECBã€CBCã€CTRä¸‰ç§ã€‚</p>
<h4 id="ECBæ¨¡å¼"><a href="#ECBæ¨¡å¼" class="headerlink" title="ECBæ¨¡å¼"></a>ECBæ¨¡å¼</h4><p>ECBæ˜¯æœ€ç®€å•çš„ä¸€ç§æ¨¡å¼ï¼Œæ¯ä¸ªå—æ˜¯ç‹¬ç«‹è¿›è¡ŒåŠ å¯†çš„ã€‚å°†æ˜æ–‡åˆ†ç»„åŠ å¯†ä¹‹åçš„ç»“æœç›´æ¥æˆä¸ºå¯†æ–‡åˆ†ç»„ã€‚å½“æœ€åä¸€ä¸ªæ˜æ–‡åˆ†ç»„çš„å†…å®¹å°äºåˆ†ç»„é•¿åº¦æ—¶ï¼Œéœ€è¦ç”¨ä¸€äº›ç‰¹å®šçš„æ•°æ®è¿›è¡Œå¡«å……ï¼ˆpaddingï¼‰ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/catbro666/catbro666.github.io/posts/e92ef4b4/Ecb_encryption.png" alt="Ecb_encryption" loading="lazy"></p>
<p><img src="https://cdn.jsdelivr.net/gh/catbro666/catbro666.github.io/posts/e92ef4b4/Ecb_decryption.png" alt="Ecb_decryption" loading="lazy"></p>
<p>ECBæ¨¡å¼æœ‰éå¸¸æ˜¾è‘—çš„<strong>ç¼ºç‚¹</strong>ï¼šåŒæ ·çš„æ˜æ–‡å—ä¼šè¢«åŠ å¯†æˆç›¸åŒçš„å¯†æ–‡å—ï¼›å› æ­¤ï¼Œå®ƒä¸èƒ½å¾ˆå¥½çš„éšè—æ•°æ®æ¨¡å¼ã€‚åœ¨æŸäº›åœºåˆï¼Œè¿™ç§æ–¹æ³•ä¸èƒ½æä¾›ä¸¥æ ¼çš„æ•°æ®ä¿å¯†æ€§ã€‚</p>
<p>æ¯”å¦‚ä¸‹é¢çš„ä¼é¹…å›¾ï¼Œç”¨ECBæ¨¡å¼åŠ å¯†ä¹‹åå¾—åˆ°ä¸­é—´çš„å›¾ï¼Œè¿˜æ˜¯èƒ½å¾ˆæ˜æ˜¾åœ°çœ‹å‡ºå›¾ç‰‡çš„è½®å»“ï¼Œä¸èƒ½å¾ˆå¥½çš„ä¿æŠ¤æ•°æ®çš„æœºå¯†æ€§ã€‚è€Œç”¨å…¶ä»–æ¨¡å¼åŠ å¯†ä¹‹åï¼Œå°±å¾—åˆ°å¦‚ç¬¬ä¸‰ä¸ªå›¾æ‰€ç¤ºçš„ç»“æœï¼Œå·²ç»çœ‹ä¸å‡ºæ˜æ˜¾çš„ç‰¹å¾ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/catbro666/catbro666.github.io/posts/e92ef4b4/ecb-penguin1.jpg" alt="åŸå›¾" loading="lazy"> <img src="https://cdn.jsdelivr.net/gh/catbro666/catbro666.github.io/posts/e92ef4b4/ecb-penguin2.jpeg" alt="ECBæ¨¡å¼" loading="lazy"><img src="https://cdn.jsdelivr.net/gh/catbro666/catbro666.github.io/posts/e92ef4b4/ecb-penguin3.jpg" alt="å…¶ä»–æ¨¡å¼" loading="lazy"></p>
<h4 id="CBCæ¨¡å¼"><a href="#CBCæ¨¡å¼" class="headerlink" title="CBCæ¨¡å¼"></a>CBCæ¨¡å¼</h4><p>CBCæ¨¡å¼ä¸­ï¼Œæ¯ä¸ªæ˜æ–‡å—å…ˆä¸å‰ä¸€ä¸ªå¯†æ–‡å—è¿›è¡Œå¼‚æˆ–ï¼Œå†è¿›è¡ŒåŠ å¯†ã€‚æ‰€ä»¥æ¯ä¸ªæ˜æ–‡å—éƒ½ä¾èµ–äºå‰é¢çš„æ‰€æœ‰æ˜æ–‡å—ã€‚åŒæ—¶ï¼Œä¸ºäº†ä¿è¯æ¯æ¡æ¶ˆæ¯çš„å”¯ä¸€æ€§ï¼Œåœ¨ç¬¬ä¸€ä¸ªå—ä¸­éœ€è¦ä½¿ç”¨åˆå§‹åŒ–å‘é‡ï¼ˆIVï¼‰ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/catbro666/catbro666.github.io/posts/e92ef4b4/Cbc_encryption.png" alt="Cbc_encryption" loading="lazy"></p>
<p><img src="https://cdn.jsdelivr.net/gh/catbro666/catbro666.github.io/posts/e92ef4b4/Cbc_decryption.png" alt="Cbc_decryption" loading="lazy"></p>
<p>CBCæ˜¯TLS1.2æ—¶ä»£æœ€ä¸ºå¸¸ç”¨çš„å·¥ä½œæ¨¡å¼ã€‚å®ƒæ²¡æœ‰ECBæ¨¡å¼é‚£ä¸ªç›¸åŒåŸæ–‡åŠ å¯†ç§°ç›¸åŒå¯†æ–‡çš„é—®é¢˜ï¼Œä½†æ˜¯ä¹Ÿå› æ­¤å¯¼è‡´å…¶å¹¶è¡Œè®¡ç®—èƒ½åŠ›ä¸å¦‚ECBæ¨¡å¼ã€‚</p>
<h4 id="CTRæ¨¡å¼"><a href="#CTRæ¨¡å¼" class="headerlink" title="CTRæ¨¡å¼"></a>CTRæ¨¡å¼</h4><p>è®¡æ•°å™¨æ¨¡å¼å…¶å®æ˜¯å°†å—åŠ å¯†è½¬æ¢æˆäº†æµåŠ å¯†ï¼Œå®ƒå¯¹ä¸€ä¸ªé€æ¬¡ç´¯åŠ çš„è®¡æ•°å™¨è¿›è¡ŒåŠ å¯†ï¼Œç„¶åç”¨åŠ å¯†çš„æ¯”ç‰¹åºåˆ—ä¸æ˜æ–‡è¿›è¡ŒXORæ“ä½œå¾—åˆ°å¯†æ–‡ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/catbro666/catbro666.github.io/posts/e92ef4b4/CTR_encryption_2.svg" alt="CTR_encryption" loading="lazy"></p>
<p><img src="https://cdn.jsdelivr.net/gh/catbro666/catbro666.github.io/posts/e92ef4b4/CTR_decryption_2.svg" alt="CTR_decryption" loading="lazy"></p>
<p>è®¡æ•°å™¨çš„ä½œç”¨è·ŸCBCæ¨¡å¼ä¸­çš„IVç±»ä¼¼ï¼Œä¿è¯ç›¸åŒçš„æ˜æ–‡ä¼šåŠ å¯†æˆä¸åŒçš„å¯†æ–‡ã€‚ç›¸æ¯”CBCç­‰æ¨¡å¼ï¼ŒCTRæ¨¡å¼è¿˜æœ‰å¦‚ä¸‹<strong>ä¼˜ç‚¹</strong>ï¼šå®ƒéå¸¸é€‚åˆå¹¶è¡Œè®¡ç®—ã€é”™è¯¯å¯†æ–‡ä¸­çš„å¯¹åº”æ¯”ç‰¹åªä¼šå½±å“æ˜æ–‡ä¸­çš„å¯¹åº”æ¯”ç‰¹ã€‚</p>
<h3 id="AEADï¼ˆAuthenticated-Encryption-with-Associated-Dataï¼‰"><a href="#AEADï¼ˆAuthenticated-Encryption-with-Associated-Dataï¼‰" class="headerlink" title="AEADï¼ˆAuthenticated Encryption with Associated Dataï¼‰"></a>AEADï¼ˆAuthenticated Encryption with Associated Dataï¼‰</h3><p>å‰é¢çš„é‚£äº›æ¨¡å¼éƒ½å·²ç»è¢«å‘ç°å­˜åœ¨ä¸åŒç¨‹åºçš„ç¼ºç‚¹æˆ–é—®é¢˜ã€‚åœ¨TLS1.3æ—¶ä»£ï¼Œåªä¿ç•™äº†AEADç±»å‹çš„åŠ å¯†æ¨¡å¼ã€‚AEADåœ¨åŠ å¯†çš„åŒæ—¶å¢åŠ äº†è®¤è¯çš„åŠŸèƒ½ï¼Œå¸¸ç”¨çš„æœ‰GCMã€CCMã€Ploy1305ã€‚</p>
<h4 id="GCMï¼ˆGalois-x2F-Counter-Modeï¼‰"><a href="#GCMï¼ˆGalois-x2F-Counter-Modeï¼‰" class="headerlink" title="GCMï¼ˆGalois&#x2F;Counter Modeï¼‰"></a>GCMï¼ˆGalois&#x2F;Counter Modeï¼‰</h4><p>GCMä¸­çš„Gæ˜¯æŒ‡çš„GMACï¼ˆå…³äºMACæˆ‘ä»¬ç¨åä¼šè®²åˆ°ï¼‰ï¼ŒCå°±æ˜¯æŒ‡çš„æˆ‘ä»¬å‰é¢æåˆ°çš„CTRè®¡æ•°å™¨æ¨¡å¼ã€‚ä¸‹å›¾å³ä¸Šè§’çš„éƒ¨åˆ†å°±æ˜¯ä¸Šé¢çš„Counteræ¨¡å¼åŠ å¯†ï¼Œå‰©ä½™éƒ¨åˆ†åˆ™æ˜¯GMACã€‚æœ€ç»ˆçš„ç»“æœåŒ…å«åˆå§‹è®¡æ•°å™¨å€¼ã€åŠ å¯†å¯†æ–‡å’ŒMACå€¼ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/catbro666/catbro666.github.io/posts/e92ef4b4/GCM-Galois_Counter_Mode_with_IV.svg" alt="GCM-Galois_Counter_Mode_with_IV" loading="lazy"></p>
<h2 id="å…¬é’¥å¯†ç ï¼ˆéå¯¹ç§°å¯†ç ï¼‰"><a href="#å…¬é’¥å¯†ç ï¼ˆéå¯¹ç§°å¯†ç ï¼‰" class="headerlink" title="å…¬é’¥å¯†ç ï¼ˆéå¯¹ç§°å¯†ç ï¼‰"></a>å…¬é’¥å¯†ç ï¼ˆéå¯¹ç§°å¯†ç ï¼‰</h2><p>åœ¨ä½¿ç”¨å¯¹ç§°åŠ å¯†æ—¶ï¼Œä¸€å®šä¼šç¢°åˆ°<strong>å¯†é’¥åˆ†å‘ï¼ˆå¯†é’¥äº¤æ¢ï¼‰</strong>çš„é—®é¢˜ã€‚ä½¿ç”¨é¢„å…ˆå…±äº«å¯†é’¥å…·æœ‰å±€é™æ€§ï¼Œéœ€è¦ä¸€ç§å®‰å…¨çš„æ–¹å¼å°†å¯†é’¥äº¤ç»™å¯¹æ–¹ã€‚äºæ˜¯å°±å¼•å‡ºäº†å…¬é’¥å¯†ç ã€‚</p>
<h3 id="å…¬é’¥å¯†ç ç®—æ³•ï¼ˆRSAã€å›½å¯†SM2ï¼‰"><a href="#å…¬é’¥å¯†ç ç®—æ³•ï¼ˆRSAã€å›½å¯†SM2ï¼‰" class="headerlink" title="å…¬é’¥å¯†ç ç®—æ³•ï¼ˆRSAã€å›½å¯†SM2ï¼‰"></a>å…¬é’¥å¯†ç ç®—æ³•ï¼ˆRSAã€å›½å¯†SM2ï¼‰</h3><p>æœ€å¸¸ç”¨çš„å…¬é’¥å¯†é’¥ç®—æ³•è¦æ•°å¤§åé¼é¼çš„RSAäº†ï¼Œå›½å¯†ä¸­åˆ™æœ‰SM2ç®—æ³•ã€‚å…¬é’¥å¯†ç æœ‰ä¸¤ä¸ªå¯†é’¥ï¼Œå…¶ä¸­ä¸€ä¸ªæ˜¯å…¬å¼€å¯†é’¥ï¼Œå…¬å¼€å¯†é’¥å¯ä»¥æ•£å¸ƒï¼Œå¦ä¸€ä¸ªæ˜¯ç§æœ‰å¯†é’¥ï¼Œéœ€è¦è‡ªå·±ä¸¥å¯†ä¿ç®¡ã€‚æ¯”å¦‚Bobè¦å‘æ¶ˆæ¯ç»™Aliceï¼ŒBobç”¨Aliceçš„å…¬é’¥å¯¹æ¶ˆæ¯è¿›è¡ŒåŠ å¯†ï¼Œç„¶åå‘é€ç»™Aliceï¼ŒAliceåˆ™ç”¨è‡ªå·±çš„ç§é’¥è¿›è¡Œè§£å¯†ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/catbro666/catbro666.github.io/posts/e92ef4b4/Public_key_encryption.svg" alt="Public_key_encryption" loading="lazy"></p>
<h3 id="Diffie-Hellmanå¯†é’¥äº¤æ¢"><a href="#Diffie-Hellmanå¯†é’¥äº¤æ¢" class="headerlink" title="Diffie-Hellmanå¯†é’¥äº¤æ¢"></a>Diffie-Hellmanå¯†é’¥äº¤æ¢</h3><p>å¦ä¸€ç§å¸¸ç”¨çš„å…¬é’¥å¯†ç æ˜¯DHç±»ç®—æ³•ï¼Œå¯ä»¥ç”¨ä¸‹å›¾æ¥å½¢è±¡åœ°è§£é‡ŠDHç®—æ³•çš„åŸç†ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/catbro666/catbro666.github.io/posts/e92ef4b4/Diffie-Hellman_Key_Exchange.svg" alt="Diffie-Hellman_Key_Exchange" loading="lazy"></p>
<p>é¦–å…ˆåŒæ–¹åå•†ä¸€ä¸ªç›¸åŒçš„åº•è‰²ï¼ˆç®—æ³•å‚æ•°ï¼‰ï¼Œç„¶åå„è‡ªç”Ÿæˆè‡ªå·±ç§æœ‰çš„é¢œè‰²ï¼ˆç›¸å½“äºç§é’¥ï¼‰ï¼Œå¹¶é€šè¿‡æ··åˆå¾—åˆ°å¯¹åº”çš„å…¬æœ‰é¢œè‰²ï¼ˆç›¸å½“äºå…¬é’¥ï¼‰ã€‚éšååŒæ–¹äº¤æ¢å„è‡ªçš„å…¬æœ‰é¢œè‰²ï¼Œå¹¶ä¸è‡ªå·±çš„ç§é’¥é¢œè‰²æ··åˆï¼Œæœ€ç»ˆåå•†å‡ºä¸€ä¸ªç›¸åŒçš„é¢œè‰²ï¼ˆå³äº¤æ¢çš„å¯†é’¥ï¼‰ã€‚çªƒå¬è€…å°±ç®—å¾—åˆ°äº†åŒæ–¹äº¤æ¢çš„è¿™äº›ä¿¡æ¯ï¼Œä¹Ÿæ— æ³•ç”Ÿæˆç›¸åŒçš„å¯†é’¥ï¼Œ<strong>æ±‚è§£ç¦»æ•£å¯¹è±¡é—®é¢˜çš„å›°éš¾åº¦</strong>ä¿è¯äº†DHç®—æ³•çš„å®‰å…¨æ€§ã€‚</p>
<h3 id="ECDHå’ŒECDHE"><a href="#ECDHå’ŒECDHE" class="headerlink" title="ECDHå’ŒECDHE"></a>ECDHå’ŒECDHE</h3><p><code>ECDH</code>æ˜¯åŸºäºæ¤­åœ†æ›²çº¿çš„DHç®—æ³•ï¼ŒåŸç†ä¸Šè·ŸDHåŸºæœ¬ä¸€æ ·ï¼Œä¸»è¦æ˜¯æŠŠæœ‰é™åŸŸä¸Šçš„æ¨¡å¹‚è¿ç®—æ›¿æ¢æˆäº†æ¤­åœ†æ›²çº¿ä¸Šçš„ç‚¹ä¹˜è¿ç®—ã€‚ç›¸æ¯”DHç®—æ³•é€Ÿåº¦æ›´å¿«ï¼Œå¯é€†æ›´éš¾ã€‚</p>
<p>DHå’ŒECDHéƒ½æ˜¯ä½¿ç”¨çš„ä¸€ä¸ªå›ºå®šå¯†é’¥ï¼Œä¸€æ—¦å¯†é’¥æ³„æ¼ï¼Œä»¥å‰æ‰€æœ‰çš„å¯†æ–‡æ¶ˆæ¯å°±éƒ½éƒ½ç ´è§£äº†ã€‚<code>ECDHE</code>åˆ™æä¾›äº†å‰å‘å®‰å…¨æ€§ï¼Œå®ƒæ¯æ¬¡ä½¿ç”¨ä¸€ä¸ªä¸´æ—¶çš„å¯†é’¥ï¼ŒåŸºäºè¿™ä¸ªä¸´æ—¶å¯†é’¥è¿›è¡Œå¯†é’¥äº¤æ¢ç”Ÿæˆä¼šè¯å¯†é’¥ã€‚å°±ç®—è¿™ä¸ªä¸´æ—¶å¯†é’¥æ³„æ¼äº†ï¼Œä¹Ÿåªå½±å“æœ¬æ¬¡SSLä¼šè¯çš„æ¶ˆæ¯ã€‚</p>
<h2 id="å•å‘æ•£åˆ—å‡½æ•°ï¼ˆHashï¼‰"><a href="#å•å‘æ•£åˆ—å‡½æ•°ï¼ˆHashï¼‰" class="headerlink" title="å•å‘æ•£åˆ—å‡½æ•°ï¼ˆHashï¼‰"></a>å•å‘æ•£åˆ—å‡½æ•°ï¼ˆHashï¼‰</h2><p>å‰é¢çš„å¯¹ç§°å¯†é’¥å’Œå…¬é’¥å¯†ç è§£å†³äº†ä¿¡æ¯ä¼ è¾“çš„<strong>æœºå¯†æ€§</strong>é—®é¢˜ï¼Œä½¿æˆ‘ä»¬ä¼ è¾“çš„ä¿¡æ¯ä¸è¢«çªƒå¬ã€‚ä½†æ˜¯è¿˜æ²¡æœ‰è§£å†³<strong>å®Œæ•´æ€§</strong>çš„é—®é¢˜ï¼Œæ¶ˆæ¯æœ‰å¯èƒ½åœ¨ä¸­é€”è¢«â€œ<strong>ç¯¡æ”¹</strong>â€ã€‚æ‰€ä»¥å°±è½®åˆ°å•å‘æ•£åˆ—å‡½æ•°å‡ºåœºäº†ã€‚</p>
<p><strong>å•å‘æ•£åˆ—å‡½æ•°</strong>å¯ä»¥æ ¹æ®è¾“å…¥çš„ä¿¡æ¯ï¼Œè®¡ç®—å‡ºä¸€ä¸ªå›ºå®šé•¿åº¦çš„æ•£åˆ—å€¼ï¼ˆæ‘˜è¦å€¼ï¼‰ï¼Œè¿™ä¸ªæ•£åˆ—å€¼å¯ä»¥ä½œä¸ºæ¶ˆæ¯çš„æŒ‡çº¹ç”¨äºæ£€æŸ¥æ¶ˆæ¯çš„å®Œæ•´æ€§ã€‚ä¿®æ”¹äº†åŸå§‹æ¶ˆæ¯çš„ä»»æ„1ä¸ªæ¯”ç‰¹ï¼Œæœ€ç»ˆç”Ÿæˆçš„æ•£åˆ—å€¼å¯èƒ½å°±å®Œå…¨ä¸åŒäº†ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/catbro666/catbro666.github.io/posts/e92ef4b4/Cryptographic_Hash_Function.svg" alt="Cryptographic_Hash_Function" loading="lazy"></p>
<p>ç†æƒ³çš„æ•£åˆ—å‡½æ•°å…·æœ‰ä»¥ä¸‹å‡ ä¸ªæ€§è´¨ï¼š</p>
<ol>
<li>ç¡®å®šæ€§ï¼šåŒæ ·çš„æ¶ˆæ¯æ€»æ˜¯äº§ç”ŸåŒæ ·çš„æ•£åˆ—å€¼</li>
<li>ä»»ä½•ç»™å®šæ¶ˆæ¯èƒ½å¤Ÿå¿«é€Ÿè®¡ç®—å‡ºæ•£åˆ—å€¼</li>
<li>å•å‘æ€§ï¼šæ— æ³•é€šè¿‡æ•£åˆ—å€¼åç®—å‡ºæ¶ˆæ¯</li>
<li><strong>å¼±æŠ—ç¢°æ’æ€§</strong>ï¼šéš¾ä»¥æ‰¾åˆ°å¯ä»¥ç”Ÿæˆç»™å®šæ•£åˆ—å€¼çš„æ¶ˆæ¯</li>
<li><strong>å¼ºæŠ—ç¢°æ’æ€§</strong>ï¼šéš¾ä»¥æ‰¾åˆ°å¯ä»¥ç”Ÿæˆä¸¤æ¡ç›¸åŒæ•£åˆ—å€¼çš„æ¶ˆæ¯</li>
<li>æ¶ˆæ¯çš„ä¸€ä¸ªå°çš„æ”¹åŠ¨ä¼šå¯¼è‡´Hashå€¼çš„å·¨å¤§å˜åŒ–</li>
</ol>
<h2 id="æ¶ˆæ¯è®¤è¯ç ï¼ˆMACï¼‰"><a href="#æ¶ˆæ¯è®¤è¯ç ï¼ˆMACï¼‰" class="headerlink" title="æ¶ˆæ¯è®¤è¯ç ï¼ˆMACï¼‰"></a>æ¶ˆæ¯è®¤è¯ç ï¼ˆMACï¼‰</h2><p>å•å‘æ•£åˆ—å‡½æ•°è™½ç„¶ä¿è¯äº†æ¶ˆæ¯çš„<strong>å®Œæ•´æ€§</strong>ï¼Œä½†æ˜¯èªæ˜çš„æ”»å‡»è€…å¯ä»¥å°†æ¶ˆæ¯è¿åŒå…¶æ•£åˆ—å€¼ä¸€èµ·ç¯¡æ”¹äº†ï¼Œè€Œæ¥æ”¶æ–¹å´æ— æ³•è¿›è¡Œè¯†åˆ«ã€‚æ‰€ä»¥è¿˜éœ€è¦å¯¹æ¶ˆæ¯è¿›è¡Œ<strong>è®¤è¯</strong>ï¼Œä¼ ç»Ÿçš„è®¤è¯æ–¹æ³•æœ‰æ‰‹å†™ç­¾åã€ç›–ç« ã€æ‰‹å°ã€èº«ä»½è¯ã€å£ä»¤ï¼ˆå…¶å®æ˜¯ä¸ªå…±äº«å¯†é’¥ï¼‰ç­‰ã€‚åœ¨å¯†ç é¢†åŸŸåˆ™å¯ä»¥é€šè¿‡æ¶ˆæ¯è®¤è¯ç çš„æ–¹æ³•è¿›è¡Œè®¤è¯ã€‚æ¶ˆæ¯è®¤è¯ç ç›¸æ¯”å•å‘æ•£åˆ—å‡½æ•°ï¼Œå¤šäº†ä¸€ä¸ªå…±äº«å¯†é’¥å¯¹æ¶ˆæ¯è¿›è¡Œè®¤è¯ã€‚æ”»å‡»è€…å› ä¸ºæ²¡æœ‰è¿™ä¸ªå¯†é’¥ï¼Œæ‰€ä»¥æ— æ³•ä¼ªé€ å‡ºMACå€¼ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/catbro666/catbro666.github.io/posts/e92ef4b4/MAC-vs-HASH.png" alt="MAC-vs-HASH" loading="lazy"></p>
<p><img src="https://cdn.jsdelivr.net/gh/catbro666/catbro666.github.io/posts/e92ef4b4/HMAC-use-scene.png" alt="HMAC-use-scene" loading="lazy"></p>
<h3 id="MACçš„é—®é¢˜"><a href="#MACçš„é—®é¢˜" class="headerlink" title="MACçš„é—®é¢˜"></a>MACçš„é—®é¢˜</h3><ul>
<li>MACè·Ÿå¯¹ç§°å¯†ç ä¸€æ ·éœ€è¦ä¸€ä¸ªå…±äº«å¯†é’¥ï¼Œæ‰€ä»¥ä¹Ÿä¼šæœ‰å¯†é’¥åˆ†å‘çš„é—®é¢˜ã€‚</li>
<li>æ— æ³•å¯¹ç¬¬ä¸‰æ–¹è¯æ˜</li>
<li>æ— æ³•é˜²æ­¢å¦è®¤</li>
</ul>
<h2 id="æ•°å­—ç­¾åï¼ˆRSAã€ECDSAï¼‰"><a href="#æ•°å­—ç­¾åï¼ˆRSAã€ECDSAï¼‰" class="headerlink" title="æ•°å­—ç­¾åï¼ˆRSAã€ECDSAï¼‰"></a>æ•°å­—ç­¾åï¼ˆRSAã€ECDSAï¼‰</h2><p>ä¸ºäº†è§£å†³MACçš„é—®é¢˜ï¼Œåˆå¼•å…¥äº†æ•°å­—ç­¾åã€‚</p>
<p>æ•°å­—ç­¾ååŒæ ·å±äºå…¬é’¥å¯†ç çš„èŒƒç•´ã€‚è·Ÿä¹‹å‰ä¸åŒçš„åœ°æ–¹æ˜¯ï¼Œå®ƒä½¿ç”¨ç§é’¥è¿›è¡ŒåŠ å¯†ï¼ˆè¯¥æ“ä½œå«ä½œç­¾åï¼‰ï¼Œä»»ä½•äººéƒ½å¯ä»¥ç”¨å…¬é’¥è¿›è¡Œè§£å¯†ï¼ˆè¯¥æ“ä½œå«ä½œéªŒç­¾ï¼‰ã€‚å› ä¸ºå…¬é’¥æ˜¯å…¬å¼€çš„ï¼Œæ‰€ä»¥è§£å†³äº†ç¬¬ä¸‰æ–¹è¯æ˜çš„é—®é¢˜ã€‚åˆå› ä¸ºç§é’¥åªæœ‰æœ¬äººå…·æœ‰ï¼Œæ²¡æœ‰ç§é’¥çš„äººäº‹å®ä¸Šæ— æ³•ç”Ÿæˆè¿™æ®µå¯†æ–‡ï¼Œæ‰€ä»¥ä¹Ÿå¯ä»¥é˜²æ­¢å¦è®¤ã€‚æ‰€ä»¥MACçš„ä¸‰ä¸ªé—®é¢˜éƒ½å¯ä»¥ç”±æ•°å­—ç­¾åè§£å†³ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/catbro666/catbro666.github.io/posts/e92ef4b4/Private_key_signing.svg" alt="Private_key_signing" loading="lazy"></p>
<p>é€šå¸¸é…åˆæ•£åˆ—å‡½æ•°ä½¿ç”¨ï¼ŒåŒæ—¶ä¿è¯äº†å®Œæ•´æ€§ï¼Œä¹ŸåŠ å¿«äº†é€Ÿåº¦ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼ŒAliceå‘é€æ¶ˆæ¯ç»™Bobã€‚å¥¹å…ˆæŠŠè‡ªå·±çš„å…¬é’¥å‘é€ç»™Bobï¼Œæ¥ç€å¥¹å¯¹æ¶ˆæ¯å…ˆè®¡ç®—ä¸€ä¸ªæ•£åˆ—å€¼ï¼Œç„¶åç”¨è‡ªå·±çš„ç§é’¥å¯¹è¿™ä¸ªæ•£åˆ—å€¼è¿›è¡ŒåŠ å¯†å¾—åˆ°æ¶ˆæ¯çš„ç­¾åå€¼ã€‚ç„¶åå¥¹å°†åˆå§‹çš„æ¶ˆæ¯å’Œç­¾åä¸€åŒå‘é€ç»™Bobã€‚Bobæ”¶åˆ°ä¹‹åï¼Œå¯¹æ¶ˆæ¯è¿›è¡ŒåŒæ ·çš„æ•£åˆ—å‡½æ•°è®¡ç®—å¾—åˆ°æ•£åˆ—å€¼ï¼ŒåŒæ—¶ç”¨Aliceçš„å…¬é’¥å¯¹ç­¾åæ•°æ®è¿›è¡Œè§£å¯†ï¼Œå¾—åˆ°è§£å¯†åæ•£åˆ—å€¼ï¼Œç„¶ååœ¨æ¯”è¾ƒä¸¤ä¸ªè®¡ç®—å¾—åˆ°æ•£åˆ—å€¼æ˜¯å¦ä¸€è‡´ï¼Œä»¥éªŒè¯ç­¾åçš„æœ‰æ•ˆæ€§ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/catbro666/catbro666.github.io/posts/e92ef4b4/DigitalSignature.png" alt="DigitalSignature" loading="lazy"></p>
<h2 id="æ•°å­—è¯ä¹¦ã€-CA"><a href="#æ•°å­—è¯ä¹¦ã€-CA" class="headerlink" title="æ•°å­—è¯ä¹¦ã€ CA"></a>æ•°å­—è¯ä¹¦ã€ CA</h2><p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬çš„å…¬é’¥å¯†ç ã€æ•°å­—ç­¾åè§£å†³äº†æœºå¯†æ€§ã€å®Œæ•´æ€§ã€å¯ä»¥è¿›è¡Œè®¤è¯ä»¥åŠé˜²æ­¢å¦è®¤ç­‰ã€‚ä½†å…¶å®è¿™ä¸€åˆ‡éƒ½æ˜¯åŸºäºä¸€ä¸ªå¤§å‰æï¼šå°±æ˜¯<strong>å…¬é’¥æ˜¯å±äºçœŸæ­£çš„å‘é€è€…</strong>ã€‚å¦‚æœå…¬é’¥æ˜¯ä¼ªé€ çš„ã€é‚£ä¹ˆè¿™ä¸€åˆ‡å°±éƒ½å¤±æ•ˆäº†ã€‚å‰é¢æåˆ°çš„æ•°å­—ç­¾ååªèƒ½ä¿è¯å¯¹æ–¹æ‹¥æœ‰è¿™ä¸ªå…¬é’¥å¯¹åº”çš„ç§é’¥ï¼Œä½†æ˜¯æ²¡æ³•è®¤è¯å…¬é’¥æ‰€æœ‰è€…æœ¬èº«çš„èº«ä»½ã€‚</p>
<p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæ•°å­—è¯ä¹¦åº”è¿è€Œå‡ºã€‚å®ƒçš„è§£å†³æ–¹å¼å°±æ˜¯è®©ä¸€ä¸ª<strong>å¯ä¿¡çš„ç¬¬ä¸‰æ–¹</strong>æ¥å¯¹å…¬é’¥è¿›è¡Œç­¾åã€‚è¿™ä¸ªå¯ä¿¡çš„ç¬¬ä¸‰æ–¹ï¼Œæˆ‘ä»¬ä¸€èˆ¬ç§°ä¹‹ä¸º<strong>Certificate authoritiesï¼ˆCAï¼‰</strong>ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/catbro666/catbro666.github.io/posts/e92ef4b4/Chain-of-trust-with-cert.svg" loading="lazy"></p>
<p>æˆ‘ä»¬æ¥çœ‹çœ‹å®é™…è¯ä¹¦æ˜¯ä»€ä¹ˆæ ·å­çš„ã€‚å…¶ä¸­<code>Subject</code>æ˜¯è¯ä¹¦æ‹¥æœ‰è€…çš„ä¿¡æ¯ï¼Œ<code>Issuer</code>å°±æ˜¯å…¶ç­¾å‘è€…çš„ä¿¡æ¯ï¼Œ<code>Subject Public Key Info</code>æ˜¯å®é™…çš„å…¬é’¥ä¿¡æ¯ï¼Œè¿™é‡Œç”¨çš„æ˜¯RSA 2048ä½çš„å¯†é’¥ã€‚è¯ä¹¦æœ€åå°±æ˜¯CAç”¨è‡ªå·±çš„ç§é’¥å¯¹è¿™ä¸ªè¯ä¹¦çš„ç­¾åã€‚ä»»ä½•æ‹¥æœ‰CAçš„è¯ä¹¦ï¼ˆåŒ…å«å…¬é’¥ï¼‰çš„äººéƒ½å¯ä»¥å¯¹è¿™ä¸ªè¯ä¹¦è¿›è¡ŒéªŒè¯ï¼Œä»è€ŒéªŒè¯å…¬é’¥æ‰€æœ‰è€…çš„èº«ä»½ã€‚<code>Validity</code>æ˜¯è¿™ä¸ªè¯ä¹¦çš„æœ‰æ•ˆæœŸã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ openssl x509 -<span class="keyword">in</span> ~/sharefile/certs/rsa-user.pem -text -noout</span><br><span class="line">Certificate:</span><br><span class="line">    Data:</span><br><span class="line">        Version: 3 (0x2)</span><br><span class="line">        Serial Number:</span><br><span class="line">            a2:95:90:e8:e0:f6:3a:e4</span><br><span class="line">    Signature Algorithm: sha256WithRSAEncryption</span><br><span class="line">        Issuer: C=CN, ST=SH, L=Shanghai, O=Awesome Software, OU=SSL Group, CN=RSA_CA_Cert/emailAddress=ssl@ca.com</span><br><span class="line">        Validity</span><br><span class="line">            Not Before: Nov  5 01:47:05 2018 GMT</span><br><span class="line">            Not After : Nov  2 01:47:05 2028 GMT</span><br><span class="line">        Subject: C=CN, ST=SH, L=Shanghai, O=Awesome Software, OU=SSL Group, CN=RSA_USER/emailAddress=rsa@site.com</span><br><span class="line">        Subject Public Key Info:</span><br><span class="line">            Public Key Algorithm: rsaEncryption</span><br><span class="line">                Public-Key: (2048 bit)</span><br><span class="line">                Modulus:</span><br><span class="line">                    00:f4:a0:b6:57:e7:68:39:98:39:13:11:b9:61:ee:</span><br><span class="line">                    1d:5c:60:c6:53:51:ec:0e:59:53:0e:12:75:1c:5b:</span><br><span class="line">                    b1:b7:e4:dd:4d:c8:c1:b8:eb:07:32:12:a1:<span class="built_in">fc</span>:50:</span><br><span class="line">                    33:d9:63:4a:30:7f:b4:b5:e9:87:d9:71:33:65:ab:</span><br><span class="line">                    56:54:ba:34:92:06:9a:af:ff:84:8e:a3:29:af:46:</span><br><span class="line">                    61:3b:45:39:c5:a8:0a:f9:ae:fb:d4:2b:20:5a:9d:</span><br><span class="line">                    ce:00:fe:c9:87:b2:f4:d2:f8:bf:b7:2e:7a:79:5e:</span><br><span class="line">                    94:54:7d:f9:09:73:4a:ec:c7:22:01:79:4c:62:11:</span><br><span class="line">                    55:a9:d3:3b:f8:ef:3e:1d:56:e3:2f:34:ef:c6:0f:</span><br><span class="line">                    2c:94:40:01:a3:6f:1e:3b:61:bd:79:00:bf:26:f7:</span><br><span class="line">                    d6:c3:a6:22:22:50:f0:6e:aa:03:1e:ea:d9:e6:ad:</span><br><span class="line">                    4d:a9:60:4f:6d:81:80:f4:f9:a9:89:31:ab:f1:a3:</span><br><span class="line">                    9b:1a:a2:57:ed:44:30:39:<span class="built_in">fc</span>:3a:3a:c3:6e:c8:a6:</span><br><span class="line">                    db:2e:14:c1:3b:6b:5b:ca:ab:b7:0d:fb:85:39:08:</span><br><span class="line">                    bf:6b:41:c1:f6:42:b1:3f:9c:45:5c:4c:37:8e:7d:</span><br><span class="line">                    c6:18:f8:9b:87:16:80:7f:25:34:8f:14:a9:02:2e:</span><br><span class="line">                    7c:07:c9:8a:21:77:33:03:6a:9c:86:f1:73:9c:c8:</span><br><span class="line">                    2d:f1</span><br><span class="line">                Exponent: 65537 (0x10001)</span><br><span class="line">        X509v3 extensions:</span><br><span class="line">            X509v3 Basic Constraints:</span><br><span class="line">                CA:FALSE</span><br><span class="line">            X509v3 Key Usage:</span><br><span class="line">                Digital Signature, Non Repudiation, Key Encipherment</span><br><span class="line">    Signature Algorithm: sha256WithRSAEncryption</span><br><span class="line">         30:cf:b2:9f:50:ea:d7:0d:e2:87:50:e6:bd:d7:b0:17:12:31:</span><br><span class="line">         b1:9f:59:16:50:60:bc:52:c0:46:7a:43:d0:34:43:48:d0:bd:</span><br><span class="line">         e1:a0:dc:75:a2:60:a0:c9:8f:ed:d4:36:14:18:75:c0:ef:c3:</span><br><span class="line">         92:fa:43:fa:34:5a:12:77:2f:03:00:eb:a6:db:d9:6b:50:ff:</span><br><span class="line">         44:56:22:c6:51:73:73:9a:4b:fd:bb:53:ff:2b:7e:97:55:d3:</span><br><span class="line">         4d:bb:bd:26:69:37:8d:71:30:41:bf:fd:48:40:<span class="built_in">fc</span>:6f:<span class="built_in">cd</span>:e2:</span><br><span class="line">         b7:4a:90:6f:a2:11:85:a7:88:d3:61:d5:03:0a:50:98:cc:0e:</span><br><span class="line">         aa:d5:83:38:b4:d5:f0:06:ff:a5:eb:d4:e6:54:14:e9:65:af:</span><br><span class="line">         36:a5:e4:3e:8b:78:18:0b:d6:7c:cc:f1:a3:da:7a:03:fd:89:</span><br><span class="line">         23:f0:e1:3e:af:7b:b1:7a:53:82:11:4a:5e:1d:84:b6:0b:cc:</span><br><span class="line">         96:b4:3a:8a:43:cf:ff:b3:3a:be:47:e0:40:c0:48:15:b4:f3:</span><br><span class="line">         2d:2b:73:b8:07:d2:21:83:3c:c4:4c:c2:31:17:4e:4c:15:da:</span><br><span class="line">         66:fd:06:9a:b7:ed:b5:9e:71:a3:40:0b:39:12:3c:7b:cb:cb:</span><br><span class="line">         a0:af:d0:c7:fe:59:41:35:04:7f:f3:f3:38:d0:d0:ac:7a:15:</span><br><span class="line">         7e:fa:ee:fd</span><br></pre></td></tr></table></figure>

<p>åœ¨å®é™…ä½¿ç”¨ä¸­ï¼Œé€šå¸¸ä¼šä½¿ç”¨å¤šçº§è¯ä¹¦é“¾ï¼Œæ¯ä¸€çº§è¯ä¹¦ç”±ä¸Šä¸€çº§CAç­¾å‘ï¼Œå¹¶ç”±ä¸Šä¸€çº§CAçš„è¯ä¹¦è¿›è¡ŒéªŒç­¾ã€‚æœ€ç»ˆçš„Root CAè¯ä¹¦åªèƒ½ç”±å®ƒè‡ªå·±ç­¾å‘çš„ï¼Œä¹Ÿå³ç”¨è‡ªå·±çš„ç§é’¥å¯¹è‡ªå·±çš„å…¬é’¥è¿›è¡Œç­¾åï¼Œå¦åˆ™å°±æ— é™é€’å½’äº†ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/catbro666/catbro666.github.io/posts/e92ef4b4/CA-signing-of-digital-certificates.svg" alt="CA-signing-of-digital-certificates" loading="lazy"></p>
<p>æ‰€ä»¥æ•°å­—è¯ä¹¦å®é™…ä¸Šæ˜¯ä¸€ç§ä¿¡ä»»é“¾çš„ä¼ é€’ï¼Œå°†å¯¹ä¼—å¤šä¸ªä½“çš„èº«ä»½è®¤è¯è½¬ç§»åˆ°å¯¹å°‘æ•°å‡ ä¸ªCAçš„èº«ä»½è®¤è¯ï¼Œå¯ä»¥å‡å°‘é­åˆ°ä¸­é—´äººæ”»å‡»çš„é£é™©ã€‚ä»å…¬é’¥å¯†ç å’Œè¯ä¹¦è¿™äº›å‡ºå‘å°±å¼•å‡ºäº†<strong>å…¬é’¥åŸºç¡€è®¾ç½®ï¼ˆPKIï¼‰</strong>ï¼šè¿™æ˜¯ä¸ºäº†èƒ½å¤Ÿæ›´æœ‰æ•ˆåœ°è¿ç”¨å…¬é’¥è€Œåˆ¶å®šçš„ä¸€ç³»åˆ—è§„èŒƒå’Œè§„æ ¼çš„æ€»ç§°ã€‚</p>
<h2 id="æ··åˆå¯†ç ç³»ç»Ÿ"><a href="#æ··åˆå¯†ç ç³»ç»Ÿ" class="headerlink" title="æ··åˆå¯†ç ç³»ç»Ÿ"></a>æ··åˆå¯†ç ç³»ç»Ÿ</h2><p>é‚£ä¹ˆæœ‰äº†å…¬é’¥å¯†ç ï¼Œæ˜¯ä¸æ˜¯å°±ä¸éœ€è¦å¯¹ç§°å¯†ç äº†å‘¢ï¼Ÿå…¬é’¥å¯†ç è™½ç„¶è§£å†³äº†å¯¹ç§°å¯†ç çš„å¯†é’¥åˆ†å‘é—®é¢˜ï¼Œä½†æ˜¯åœ¨è®¡ç®—é€Ÿåº¦ä¸Šå´è¿œä½äºå¯¹ç§°å¯†ç ï¼Œç›¸å·®å‡ ä¸ªæ•°é‡çº§ã€‚ä¸‹é¢æ˜¯ç”¨<code>openssl speed</code>æµ‹è¯•RSA1024å’ŒAES128çš„ç»“æœã€‚AES128ï¼ˆç›¸åŒå—å¤§å°ï¼‰çš„é€Ÿåº¦å¤§æ¦‚æ˜¯RSA1024ç­¾åçš„1200å€ï¼Œæ˜¯éªŒç­¾çš„70å€ã€‚</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ openssl speed rsa1024</span><br><span class="line">                  sign    verify    sign/s verify/s</span><br><span class="line">rsa 1024 bits 0.000103s 0.000006s   9732.8 162578.8</span><br><span class="line"></span><br><span class="line">$ openssl speed -evp aes128</span><br><span class="line"><span class="built_in">type</span>             16 bytes     64 bytes    256 bytes   1024 bytes   8192 bytes  16384 bytes</span><br><span class="line">aes-128-cbc    1075884.36k  1452740.12k  1510392.06k  1530545.83k  1537414.49k  1537114.11k</span><br></pre></td></tr></table></figure>

<p>å› ä¸ºå¯¹ç§°å¯†ç å’Œéå¯¹ç§°å¯†ç å„æœ‰ä¼˜ç¼ºç‚¹ï¼Œæ‰€ä»¥åœ¨å®é™…åº”ç”¨ä¸­é€šå¸¸å°†ä¸¤è€…ç»“åˆèµ·æ¥ï¼Œä½¿ç”¨éå¯¹ç§°å¯†ç æ¥å®Œæˆå¯†é’¥äº¤æ¢ï¼Œç„¶åç”Ÿæˆä¼šè¯å¯†é’¥ä½œä¸ºå¯¹ç§°å¯†ç çš„å¯†é’¥ï¼Œä½¿ç”¨å¯¹ç§°å¯†ç å¯¹ä¿¡æ¯è¿›è¡ŒåŠ è§£å¯†ã€‚</p>
<h2 id="éšæœºæ•°å‘ç”Ÿå™¨"><a href="#éšæœºæ•°å‘ç”Ÿå™¨" class="headerlink" title="éšæœºæ•°å‘ç”Ÿå™¨"></a>éšæœºæ•°å‘ç”Ÿå™¨</h2><p>æˆªæ­¢ç›®å‰ï¼Œæˆ‘ä»¬å·²ç»è§£å†³äº†å¾ˆå¤šé—®é¢˜ï¼ŒåŒ…æ‹¬æœºå¯†æ€§ã€å®Œæ•´æ€§ã€è®¤è¯æ€§ã€é˜²æŠµèµ–ï¼Œä½†å…¶å®è¿˜æœ‰ä¸€ä¸ªå¤§é—®é¢˜æˆ‘ä»¬æ²¡æœ‰è§£å†³ï¼šå³æˆ‘ä»¬çš„<strong>ä¼šè¯å¯†é’¥</strong>å¦‚ä½•ç”Ÿæˆï¼Ÿä¸€ä¸ªå®‰å…¨çš„ç®—æ³•å…¶æ‰€æœ‰çš„å®‰å…¨æ€§åº”è¯¥éƒ½æ˜¯åŸºäºå…¶<strong>å¯†é’¥çš„å®‰å…¨æ€§</strong>ï¼Œå¦‚æœæˆ‘ä»¬çš„å¯†é’¥å¯ä»¥è¢«è½»æ˜“ç ´è§£æˆ–é¢„æµ‹ï¼Œé‚£æˆ‘ä»¬å‰é¢æ„å»ºçš„ä¸€åˆ‡å°±éƒ½åœŸå´©ç“¦è§£äº†ã€‚æ‰€ä»¥éšæœºæ•°å‘ç”Ÿå™¨å°±åœ¨è¿™é‡Œèµ·åˆ°äº†è‡³å…³é‡è¦çš„ä½œç”¨ã€‚</p>
<p>éšæœºæ•°åŒæ ·åœ¨<strong>é˜²é‡æ”¾æ”»å‡»</strong>ä¸­å…·æœ‰é‡è¦çš„ä½œç”¨ï¼Œæ‰€è°“é‡æ”¾æ”»å‡»ï¼Œå°±æ˜¯æ”»å‡»è€…å°†çªƒå¬çš„æ•°æ®ä¿å­˜ä¸‹æ¥ï¼Œåœ¨åé¢å†åŸæ ·å‘é€ç»™æ¥æ”¶è€…ï¼Œä»¥è¾¾åˆ°å…¶ç‰¹å®šçš„æ”»å‡»ç›®çš„ã€‚é˜²é‡æ”¾çš„å¸¸ç”¨æ‰‹æ®µæœ‰ä½¿ç”¨åºå·ã€æ—¶é—´æˆ³ã€éšæœºæ•°ç­‰ã€‚</p>
<p>è¿™é‡Œç•™ä¸ªé—®é¢˜ç»™å¤§å®¶æ€è€ƒï¼Œå› ä¸ºæœºå¯†æ€§å’Œå®Œæ•´æ€§çš„ä¿æŠ¤ï¼Œæ”»å‡»è€…æ—¢ä¸èƒ½è§£å¯†æ¶ˆæ¯ï¼Œåˆä¸èƒ½å¯¹æ¶ˆæ¯è¿›è¡Œç¯¡æ”¹ï¼Œé‚£ä¹ˆé‡æ”¾æœ‰ä»€ä¹ˆç”¨å‘¢ï¼Ÿ</p>
<p>ç†æƒ³çš„éšæœºæ•°å‘ç”Ÿå™¨å…·æœ‰ä»¥ä¸‹ç‰¹æ€§ï¼š</p>
<ul>
<li>éšæœºæ€§ï¼šä¸å­˜åœ¨ç»Ÿè®¡å­¦åå·®ï¼Œæ˜¯å®Œå…¨æ‚ä¹±çš„æ•°åˆ—</li>
<li>ä¸å¯é¢„æµ‹æ€§ï¼šä¸èƒ½ä»è¿‡å»çš„æ•°åˆ—æ¨æµ‹å‡ºä¸‹ä¸€ä¸ªå‡ºç°çš„æ•°</li>
<li>ä¸å¯é‡ç°æ€§ï¼šé™¤éå°†æ•°åˆ—æœ¬èº«ä¿å­˜ä¸‹æ¥ï¼Œå¦åˆ™ä¸èƒ½é‡ç°ç›¸åŒçš„æ•°åˆ—</li>
</ul>
<h2 id="å¯†é’¥æ´¾ç”Ÿå‡½æ•°-key-derivation-function"><a href="#å¯†é’¥æ´¾ç”Ÿå‡½æ•°-key-derivation-function" class="headerlink" title="å¯†é’¥æ´¾ç”Ÿå‡½æ•° key derivation function"></a>å¯†é’¥æ´¾ç”Ÿå‡½æ•° key derivation function</h2><p>KDFå¯ç”¨äºå°†å¯†é’¥ææ–™æ‰©å±•ä¸ºæ›´é•¿çš„å¯†é’¥æˆ–è·å–æ‰€éœ€æ ¼å¼çš„å¯†é’¥ã€‚TLS 1.2ä¸­æ˜¯ç”¨çš„PRFç®—æ³•ï¼ŒTLS 1.3ä¸­åˆ™æ˜¯ç”¨çš„HKDFç®—æ³•ã€‚</p>
<h1 id="SSL-x2F-TLSåè®®è¯¦è§£"><a href="#SSL-x2F-TLSåè®®è¯¦è§£" class="headerlink" title="SSL&#x2F;TLSåè®®è¯¦è§£"></a>SSL&#x2F;TLSåè®®è¯¦è§£</h1><h2 id="ä»€ä¹ˆæ˜¯SSL-x2F-TLSåè®®"><a href="#ä»€ä¹ˆæ˜¯SSL-x2F-TLSåè®®" class="headerlink" title="ä»€ä¹ˆæ˜¯SSL&#x2F;TLSåè®®"></a>ä»€ä¹ˆæ˜¯SSL&#x2F;TLSåè®®</h2><p>å¥½äº†ï¼Œæœ‰äº†å‰é¢çš„å¯†ç å­¦åŸºç¡€ï¼Œæˆ‘ä»¬å°±å¯ä»¥æ­£å¼è¿›å…¥TLSåè®®çš„ä»‹ç»ã€‚å‰é¢ä»‹ç»çš„åŸºæœ¬éƒ½æ˜¯ç‹¬ç«‹çš„ç®—æ³•æˆ–è€…æ˜¯å‡ ä¸ªç®—æ³•ç»“åˆèµ·æ¥çš„ç»„ä»¶ï¼Œè€ŒSSL&#x2F;TLSåè®®åˆ™æ˜¯åŸºäºè¿™äº›åº•å±‚çš„ç®—æ³•åŸè¯­å’Œç»„ä»¶ï¼Œæœ€ç»ˆæ‹¼è£…è€Œæˆçš„ä¸€ä¸ª<strong>æˆå“çš„å¯†ç å­¦åè®®</strong>ã€‚</p>
<p>SSLå…¨ç§°æ˜¯<code>Secure Sockets Layer</code>ï¼Œå®‰å…¨å¥—æ¥å­—å±‚ï¼Œå®ƒæ˜¯ç”±ç½‘æ™¯å…¬å¸(Netscape)è®¾è®¡çš„ä¸»è¦ç”¨äºWebçš„å®‰å…¨ä¼ è¾“åè®®ï¼Œç›®çš„æ˜¯ä¸ºç½‘ç»œé€šä¿¡æä¾›æœºå¯†æ€§ã€è®¤è¯æ€§åŠæ•°æ®å®Œæ•´æ€§ä¿éšœã€‚å¦‚ä»Šï¼ŒSSLå·²ç»æˆä¸ºäº’è”ç½‘ä¿å¯†é€šä¿¡çš„å·¥ä¸šæ ‡å‡†ã€‚</p>
<p>SSLæœ€åˆçš„å‡ ä¸ªç‰ˆæœ¬(SSL 1.0ã€SSL2.0ã€SSL 3.0)ç”±ç½‘æ™¯å…¬å¸è®¾è®¡å’Œç»´æŠ¤ï¼Œä»3.1ç‰ˆæœ¬å¼€å§‹ï¼ŒSSLåè®®ç”±å› ç‰¹ç½‘å·¥ç¨‹ä»»åŠ¡å°ç»„(IETF)æ­£å¼æ¥ç®¡ï¼Œå¹¶æ›´åä¸ºTLS(Transport Layer Security)ï¼Œå‘å±•è‡³ä»Šå·²æœ‰TLS 1.0ã€TLS1.1ã€TLS1.2è¿™å‡ ä¸ªç‰ˆæœ¬ã€‚ç›®å‰ä¸»æµçš„è¿˜æ˜¯TLS1.2ï¼Œä¸è¿‡TLS1.3å³å°†æ˜¯å¤§åŠ¿æ‰€è¶‹ã€‚</p>
<table>
<thead>
<tr>
<th>Protocol</th>
<th>Published</th>
<th>Status</th>
</tr>
</thead>
<tbody><tr>
<td>SSL 1.0</td>
<td>Unpublished</td>
<td>Unpublished</td>
</tr>
<tr>
<td>SSL 2.0</td>
<td>1995</td>
<td>Deprecated in 2011 (RFC <a href="https://datatracker.ietf.org/doc/html/rfc6176">6176</a>)</td>
</tr>
<tr>
<td>SSL 3.0</td>
<td>1996</td>
<td>Deprecated in 2015 (RFC <a href="https://datatracker.ietf.org/doc/html/rfc7568">7568</a>)</td>
</tr>
<tr>
<td>TLS 1.0</td>
<td>1999</td>
<td>Deprecated in 2020 (RFC <a href="https://datatracker.ietf.org/doc/html/rfc8996">8996</a>)[<a href="https://en.wikipedia.org/wiki/Transport_Layer_Security#cite_note-tls-deprecation-8">8]</a>[<a href="https://en.wikipedia.org/wiki/Transport_Layer_Security#cite_note-:3-9">9]</a>[<a href="https://en.wikipedia.org/wiki/Transport_Layer_Security#cite_note-:4-10">10]</a></td>
</tr>
<tr>
<td>TLS 1.1</td>
<td>2006</td>
<td>Deprecated in 2020 (RFC <a href="https://datatracker.ietf.org/doc/html/rfc8996">8996</a>)[<a href="https://en.wikipedia.org/wiki/Transport_Layer_Security#cite_note-tls-deprecation-8">8]</a>[<a href="https://en.wikipedia.org/wiki/Transport_Layer_Security#cite_note-:3-9">9]</a>[<a href="https://en.wikipedia.org/wiki/Transport_Layer_Security#cite_note-:4-10">10]</a></td>
</tr>
<tr>
<td>TLS 1.2</td>
<td>2008</td>
<td></td>
</tr>
<tr>
<td>TLS 1.3</td>
<td>2018</td>
<td></td>
</tr>
</tbody></table>
<p>SSL&#x2F;TLSåè®®èƒ½å¤Ÿæä¾›çš„å®‰å…¨ç›®æ ‡ä¸»è¦åŒ…æ‹¬å¦‚ä¸‹å‡ ä¸ªï¼š</p>
<div class="note info no-icon">
            <ul><li><p><strong>æœºå¯†æ€§</strong>ï¼šå€ŸåŠ©åŠ å¯†é˜²æ­¢ç¬¬ä¸‰æ–¹çªƒå¬</p></li><li><p><strong>è®¤è¯æ€§</strong>ï¼šå€ŸåŠ©æ•°å­—è¯ä¹¦è®¤è¯æœåŠ¡å™¨ç«¯å’Œå®¢æˆ·ç«¯èº«ä»½ï¼Œé˜²æ­¢èº«ä»½ä¼ªé€ </p></li><li><p><strong>å®Œæ•´æ€§</strong>ï¼šå€ŸåŠ©æ¶ˆæ¯è®¤è¯ç (MAC)ä¿éšœæ•°æ®å®Œæ•´æ€§ï¼Œé˜²æ­¢æ¶ˆæ¯ç¯¡æ”¹</p></li><li><p><strong>é˜²é‡æ”¾</strong>ï¼šé˜²æ­¢é‡æ”¾æ”»å‡»</p></li></ul>
          </div>



<h2 id="åè®®åˆ†å±‚"><a href="#åè®®åˆ†å±‚" class="headerlink" title="åè®®åˆ†å±‚"></a>åè®®åˆ†å±‚</h2><p>ç›¸ä¿¡å¤§å®¶å¯¹TCP&#x2F;IP 5å±‚æ¨¡å‹å·²ç»éå¸¸ç†Ÿæ‚‰äº†ï¼ŒTLSåè®®å°±å¦‚å…¶åå­—æ‰€è¯´çš„ï¼ˆTransport Layer Securityï¼‰ï¼Œç”¨äºä¿éšœä¼ è¾“å±‚çš„å®‰å…¨ã€‚å®ƒä½äºä¼ è¾“å±‚ä¹‹ä¸Šï¼Œåº”ç”¨å±‚ä¹‹ä¸‹ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/catbro666/catbro666.github.io/posts/e92ef4b4/TLS-layered-structure.svg" alt="TLS-layered-structure" loading="lazy"></p>
<p>SSL&#x2F;TLSåè®®æœ‰ä¸€ä¸ªé«˜åº¦æ¨¡å—åŒ–çš„æ¶æ„ï¼Œå…¶å†…éƒ¨åˆåˆ†ä¸ºå¾ˆå¤šå­åè®®ï¼šHandshakeåè®®ã€Alertåè®®ã€ChangeCipherSpecåè®®ã€Applicationåè®®ã€‚å®ƒä»¬åº•å±‚éƒ½æ˜¯åŸºäºRecordåè®®ï¼Œè®°å½•å±‚åè®®è´Ÿè´£è¯†åˆ«ä¸åŒçš„ä¸Šå±‚æ¶ˆæ¯ç±»å‹ä»¥åŠæ¶ˆæ¯çš„åˆ†æ®µåŠ å¯†è®¤è¯ç­‰ã€‚</p>
<ul>
<li>Handshakeåè®®ï¼šåŒ…æ‹¬åå•†å®‰å…¨å‚æ•°å’Œç®—æ³•å¥—ä»¶ã€æœåŠ¡å™¨èº«ä»½è®¤è¯(å®¢æˆ·ç«¯èº«ä»½è®¤è¯å¯é€‰)ã€å¯†é’¥äº¤æ¢</li>
<li>Applicationåè®®ï¼šç”¨äºä¼ è¾“åº”ç”¨å±‚æ•°æ®</li>
<li>ChangeCipherSpec åè®®ï¼šä¸€æ¡æ¶ˆæ¯è¡¨æ˜æ¡æ‰‹åè®®å·²ç»å®Œæˆ</li>
<li>Alert åè®®ï¼šå¯¹æ¡æ‰‹åè®®ä¸­ä¸€äº›å¼‚å¸¸çš„é”™è¯¯æé†’ï¼Œåˆ†ä¸ºfatalå’Œwarningä¸¤ä¸ªçº§åˆ«ï¼Œfatalç±»å‹çš„é”™è¯¯ä¼šç›´æ¥ä¸­æ–­SSLè¿æ¥ï¼Œè€Œwarningçº§åˆ«çš„é”™è¯¯ä¸€èˆ¬æƒ…å†µä¸‹SSLè¿æ¥ä¼šç»§ç»­ï¼Œåªæ˜¯ä¼šç»™å‡ºé”™è¯¯è­¦å‘Š</li>
</ul>
<p>SSL&#x2F;TLSåè®®è¢«è®¾è®¡ä¸ºä¸€ä¸ªä¸¤é˜¶æ®µåè®®ï¼Œåˆ†ä¸º<strong>æ¡æ‰‹é˜¶æ®µ</strong>å’Œ<strong>åº”ç”¨é˜¶æ®µ</strong>ã€‚</p>
<p><strong>æ¡æ‰‹é˜¶æ®µ</strong>ï¼šä¹Ÿç§°åå•†é˜¶æ®µï¼Œåœ¨è¿™ä¸€é˜¶æ®µä¸»è¦ç›®æ ‡å°±æ˜¯è¿›è¡Œæˆ‘ä»¬å‰é¢å·²ç»æåˆ°è¿‡çš„åå•†å®‰å…¨å‚æ•°å’Œç®—æ³•å¥—ä»¶ã€èº«ä»½è®¤è¯ï¼ˆåŸºäºæ•°å­—è¯ä¹¦ï¼‰ä»¥åŠå¯†é’¥äº¤æ¢ç”Ÿæˆåç»­åŠ å¯†é€šä¿¡æ‰€ä½¿ç”¨çš„å¯†é’¥ã€‚</p>
<p><strong>åº”ç”¨é˜¶æ®µ</strong>ï¼šåŒæ–¹ä½¿ç”¨æ¡æ‰‹é˜¶æ®µåå•†å¥½çš„å¯†é’¥è¿›è¡Œå®‰å…¨é€šä¿¡ã€‚</p>
<h2 id="SSL-record"><a href="#SSL-record" class="headerlink" title="SSL record"></a>SSL record</h2><p>SSLè®°å½•å±‚åŒ…çš„æ ¼å¼ï¼Œè·Ÿå…¶ä¸‹çš„IPæˆ–TCPå±‚ç±»ä¼¼ï¼Œæ‰€æœ‰åœ¨SSLä¼šè¯ä¸Šäº¤æ¢çš„æ•°æ®éƒ½æŒ‰å¦‚ä¸‹æ ¼å¼å°è£…æˆå¸§ã€‚è®°å½•å±‚åè®®è´Ÿè´£è¯†åˆ«ä¸åŒçš„æ¶ˆæ¯ç±»å‹ï¼Œä¹Ÿè´Ÿè´£å¯¹æ¶ˆæ¯çš„åˆ†æ®µã€å‹ç¼©ã€æ¶ˆæ¯è®¤è¯å’Œå®Œæ•´æ€§ä¿æŠ¤ã€åŠ å¯†ç­‰å·¥ä½œã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/catbro666/catbro666.github.io/posts/e92ef4b4/TLS-record-structure.svg" alt="TLS-record-structure" loading="lazy"></p>
<p>ä¸€ä¸ªå…¸å‹çš„è®°å½•å±‚å·¥ä½œæµï¼ˆåˆ†ç»„å¯†ç ç®—æ³•ï¼‰å¦‚ä¸‹ï¼š</p>
<ul>
<li>è®°å½•å±‚æ¥æ”¶åˆ°åº”ç”¨å±‚çš„æ•°æ®</li>
<li>å°†æ¥æ”¶åˆ°çš„æ•°æ®åˆ†å—</li>
<li>ä½¿ç”¨åå•†çš„MAC keyè®¡ç®—MACæˆ–HMACï¼Œå¹¶å¢åŠ åˆ°è®°å½•å—ä¸­</li>
<li>ä½¿ç”¨åå•†çš„Cipher Keyå°†è®°å½•æ•°æ®åŠ å¯†</li>
</ul>
<p>å½“åŠ å¯†çš„æ•°æ®åˆ°äº†æ¥æ”¶ç«¯ï¼Œå¯¹æ–¹åˆ™è¿›è¡Œç›¸åçš„æ“ä½œï¼šè§£å¯†æ•°æ®ã€éªŒè¯MACã€é‡ç»„æ•°æ®å¹¶äº¤ç»™åº”ç”¨å±‚ã€‚</p>
<p>æ‰€æœ‰è¿™äº›å·¥ä½œéƒ½ç”±SSLå±‚å®Œæˆäº†ï¼Œå¯¹äºä¸Šå±‚åº”ç”¨æ˜¯å®Œå…¨é€æ˜çš„ã€‚</p>
<p>å¯¹äºæ¡æ‰‹é˜¶æ®µçš„æ¶ˆæ¯ï¼Œpayloadæ˜¯æ˜æ–‡ï¼Œå½“ç„¶å°±æ²¡æœ‰MACå’ŒPaddingã€‚å…¶ä»–æ¶ˆæ¯çš„payloadéƒ½æ˜¯å¯†æ–‡ã€‚</p>
<p>å¯¹äº<strong>æµåŠ å¯†ç®—æ³•</strong>ï¼Œæ²¡æœ‰åé¢çš„paddingã€‚å¯¹äº<strong>å—åŠ å¯†ç®—æ³•</strong>çš„è®°å½•ï¼Œæ ¹æ®ä½¿ç”¨çš„ç®—æ³•åœ¨payloadä¹‹å‰æœ‰å¯é€‰çš„IVå­—æ®µã€‚</p>
<p>å¯¹äº<strong>AEADç®—æ³•</strong>ï¼Œå› ä¸ºè®¤è¯å·²ç»åŒ…å«åœ¨ç®—æ³•é‡Œäº†ï¼Œæ‰€ä»¥æ²¡æœ‰åé¢çš„MACå’ŒPaddingå­—æ®µã€‚payloadä¹‹å‰æœ‰ä¸€ä¸ªå¤–éƒ¨nonceå­—æ®µã€‚</p>
<h2 id="ç®—æ³•å¥—ä»¶CipherSuites"><a href="#ç®—æ³•å¥—ä»¶CipherSuites" class="headerlink" title="ç®—æ³•å¥—ä»¶CipherSuites"></a>ç®—æ³•å¥—ä»¶CipherSuites</h2><p>åœ¨æ·±å…¥æ¡æ‰‹æµç¨‹ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥äº†è§£ä¸€ä¸‹ç®—æ³•å¥—ä»¶çš„æ¦‚å¿µã€‚å‰é¢åœ¨å¯†ç å­¦åŸºç¡€éƒ¨åˆ†æˆ‘ä»¬å·²ç»äº†è§£åˆ°äº†å„ç§ç®—æ³•ï¼ŒåŒ…æ‹¬è®¤è¯ç®—æ³•ã€å¯†é’¥äº¤æ¢ç®—æ³•ã€å¯¹ç§°å¯†ç ç®—æ³•ã€å®Œæ•´æ€§è®¤è¯çš„ç®—æ³•ã€‚</p>
<h3 id="TLS-1-2"><a href="#TLS-1-2" class="headerlink" title="TLS 1.2-"></a>TLS 1.2-</h3><p>ä¸€ä¸ª<strong>ç®—æ³•å¥—ä»¶</strong>æ˜¯ä¸€ä¸ªSSLè¿æ¥ä¸­ç”¨åˆ°çš„è¿™äº›ç®—æ³•ç±»å‹çš„ç»„åˆï¼ŒåŒ…å«å¦‚ä¸‹å‡ ä¸ªéƒ¨åˆ†ï¼š</p>
<ul>
<li>Key Exchangeï¼ˆKxï¼‰</li>
<li>Authenticationï¼ˆAuï¼‰</li>
<li>Encryptionï¼ˆEncï¼‰</li>
<li>Message Authentication Codeï¼ˆMacï¼‰</li>
</ul>
<p>å¸¸è§çš„ç®—æ³•å¥—ä»¶ç±»å‹æ¯”å¦‚<code>TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA256</code>ï¼Œ<code>TLS_RSA_WITH_AES_256_GCM_SHA384</code>ã€<code>TLS_ECDH_ECDSA_WITH_AES_256_CBC_SHA384</code>ã€<code>ECC_SM2_WITH_SM4_SM3</code>ï¼ˆå›½å¯†ï¼‰ã€<code>ECDHE_SM2_WITH_SM4_SM3</code>ï¼ˆå›½å¯†ï¼‰ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/catbro666/catbro666.github.io/posts/e92ef4b4/CipherSuite1_2.png" alt="CipherSuite1_2" loading="lazy"></p>
<p>ä»¥<code>ECDHE-ECDSA-AES128-GCM-SHA256</code>ä¸ºä¾‹ï¼Œå‰é¢çš„<code>ECDHE</code>è¡¨ç¤ºå¯†é’¥äº¤æ¢ç®—æ³•ï¼Œ<code>ECDSA</code>è¡¨ç¤ºèº«ä»½è®¤è¯ç®—æ³•ï¼Œ<code>AES128-GCM</code>è¡¨ç¤ºå¯¹ç§°åŠ å¯†ç®—æ³•ï¼Œå…¶ä¸­<code>128</code>è¡¨ç¤ºå—é•¿åº¦ï¼Œ<code>GCM</code>æ˜¯å…¶æ¨¡å¼ï¼Œ<code>SHA256</code>è¡¨ç¤ºå“ˆå¸Œç®—æ³•ã€‚å¯¹äº<code>AEAD</code>å› ä¸ºæ¶ˆæ¯è®¤è¯å’ŒåŠ å¯†å·²ç»åˆå¹¶åˆ°ä¸€èµ·äº†ï¼Œæœ€åçš„<code>SHA256</code>åªè¡¨ç¤ºå¯†é’¥æ´¾ç”Ÿå‡½æ•°çš„ç®—æ³•ï¼Œè€Œå¯¹äºä¼ ç»Ÿçš„æ•°æ®åŠ å¯†å’Œè®¤è¯åˆ†å¼€çš„ç®—æ³•å¥—ä»¶ï¼Œå®ƒè¿˜è¡¨ç¤º<code>MAC</code>çš„ç®—æ³•ã€‚</p>
<p>å¯ä»¥é€šè¿‡å¦‚ä¸‹å‘½ä»¤æŸ¥çœ‹æ¯ç§ç®—æ³•å¥—ä»¶çš„è¯¦ç»†æƒ…å†µï¼š<code>openssl ciphers -V | column -t | less</code>ã€‚</p>
<h3 id="TLS-1-3"><a href="#TLS-1-3" class="headerlink" title="TLS 1.3"></a>TLS 1.3</h3><p>å¯¹äºTLSv1.3ï¼Œå› ä¸ºå·²ç»å°†å¯†é’¥äº¤æ¢å’Œèº«ä»½è®¤è¯ç®—æ³•ä»ç®—æ³•å¥—ä»¶ä¸­ç‹¬ç«‹å‡ºå»ï¼Œç®—æ³•å¥—ä»¶åªè¡¨ç¤ºåŠ å¯†ç®—æ³•å’Œå¯†é’¥æ´¾ç”Ÿå‡½æ•°ã€‚ä¹‹æ‰€ä»¥è¦ç‹¬ç«‹å‡ºå»ï¼Œæ˜¯å› ä¸ºæ”¯æŒçš„ç®—æ³•è¶Šæ¥è¶Šå¤šäº†ï¼Œå¯¼è‡´ç›¸ä¹˜ä¹‹åç®—æ³•å¥—ä»¶æ•°é‡åºå¤§ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/catbro666/catbro666.github.io/posts/e92ef4b4/CipherSuite1_3.png" alt="CipherSuite1_3" loading="lazy"></p>
<p>å¯ä»¥ç”¨å¦‚ä¸‹å‘½ä»¤æŸ¥çœ‹å½“å‰æ”¯æŒå“ªäº›TLS 1.3ç®—æ³•å¥—ä»¶ï¼š<code>openssl ciphers -V | column -t | grep &#39;TLSv1.3&#39;</code>ã€‚</p>
<h2 id="SSL-handshake"><a href="#SSL-handshake" class="headerlink" title="SSL handshake"></a>SSL handshake</h2><p>ç»ˆäºè¿›å…¥æ ¸å¿ƒçš„æ¡æ‰‹åè®®éƒ¨åˆ†äº†ã€‚å¦‚å‰æ‰€è¿°ï¼ŒSSLæ¡æ‰‹ä¸»è¦å¹²ä»¥ä¸‹å‡ ä»¶äº‹æƒ…ï¼šé¦–å…ˆå¾—å•†é‡åŒæ–¹ç”¨ä»€ä¹ˆç®—æ³•å¥—ä»¶ï¼Œç„¶åæ ¹æ®éœ€è¦è®¤è¯å¯¹æ–¹çš„èº«ä»½ï¼ˆåŸºäºæ•°å­—è¯ä¹¦ï¼‰ï¼Œæœ€ååŸºäºé€‰æ‹©çš„ç®—æ³•å¥—ä»¶è¿›è¡Œå¯†é’¥äº¤æ¢ç”Ÿæˆåç»­åŠ å¯†é€šä¿¡æ‰€ä½¿ç”¨çš„å¯†é’¥ã€‚ï¼ˆæœ¬èŠ‚æè¿°çš„æ˜¯TLS 1.2åŠä»¥å‰ç‰ˆæœ¬çš„æƒ…å†µï¼‰</p>
<p>ä¸‹å›¾æ˜¯ä¸€ä¸ªå®Œæ•´SSLæ¡æ‰‹çš„å»ºç«‹æµç¨‹:</p>
<p><img src="https://cdn.jsdelivr.net/gh/catbro666/catbro666.github.io/posts/e92ef4b4/TLS-full-handshake-flow.svg" alt="TLS-full-handshake-flow" loading="lazy"></p>
<p>é¦–å…ˆæ˜¯TCPçš„3æ¬¡æ¡æ‰‹å»ºç«‹TCPè¿æ¥ï¼Œç„¶åå®¢æˆ·ç«¯å‘èµ·SSLæ¡æ‰‹ã€‚ä¸€æ¬¡å®Œæ•´çš„SSLæ¡æ‰‹åŒ…å«ä¸¤æ¬¡äº¤äº’ï¼Œç¬¬ä¸€æ¬¡ä¸»è¦æ˜¯å®Œæˆç®—æ³•å¥—ä»¶çš„é€‰æ‹©ã€‚ç¬¬äºŒæ¬¡äº¤äº’ä¸»è¦æ˜¯å®Œæˆèº«ä»½è®¤è¯ä»¥åŠå¯†é’¥äº¤æ¢ã€‚è¿™äº›éƒ½åå•†å®Œæˆä¹‹åï¼ŒSSLçš„å®‰å…¨é€šé“å°±å»ºç«‹å®Œæˆäº†ã€‚åç»­çš„åº”ç”¨æ•°æ®å°±ä¼šåœ¨å®‰å…¨é€šé“ä¸Šè¿›è¡ŒåŠ å¯†ä¼ è¾“ã€‚</p>
<h3 id="å¯†é’¥äº¤æ¢æµç¨‹-RSA"><a href="#å¯†é’¥äº¤æ¢æµç¨‹-RSA" class="headerlink" title="å¯†é’¥äº¤æ¢æµç¨‹-RSA"></a>å¯†é’¥äº¤æ¢æµç¨‹-RSA</h3><p>åŸºäºRSAçš„å¯†é’¥äº¤æ¢æµç¨‹å¦‚ä¸‹ï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/catbro666/catbro666.github.io/posts/e92ef4b4/SSL-keyexchange-RSA.jpeg" alt="SSL-keyexchange-RSA" loading="lazy"></p>
<p>æˆ‘ä»¬æ¥æ¨¡æ‹Ÿä¸‹åå•†è¿‡ç¨‹ï¼š</p>
<ul>
<li><span class="label info">å®¢æˆ·ç«¯</span>ï¼šHiï¼ŒæœåŠ¡ç«¯ï¼Œæˆ‘è¿™è¾¹æ”¯æŒè¿™äº›ç®—æ³•ï¼Œè¿™æ˜¯æˆ‘æœ¬æ¬¡çš„éšæœºæ•°ã€‚</li>
<li><span class="label success">æœåŠ¡ç«¯</span>ï¼šå¥½çš„ï¼Œæˆ‘çœ‹çœ‹ï¼Œæˆ‘ä»¬å°±é€‰ç”¨è¿™ä¸ªç®—æ³•å¥—ä»¶å§ï¼Œè¿™æ˜¯æˆ‘æœ¬æ¬¡çš„éšæœºæ•°ï¼Œè¿™æ˜¯æˆ‘çš„è¯ä¹¦ï¼Œä½ ç”¨è¿™ä¸ªè¯ä¹¦é‡Œçš„å…¬é’¥æ¥åŠ å¯†é¢„ä¸»å¯†é’¥ã€‚</li>
<li><span class="label info">å®¢æˆ·ç«¯</span>ï¼šç¨ç­‰æˆ‘éªŒä¸‹è¯ä¹¦ï¼Œå—¯ï¼Œçš„ç¡®æ˜¯æœåŠ¡ç«¯çš„è¯ä¹¦ã€‚è¿™æ˜¯ç”¨è¯ä¹¦ä¸­å…¬é’¥åŠ å¯†çš„é¢„ä¸»å¯†é’¥ã€‚ï¼ˆä½¿ç”¨ä¸¤ä¸ªéšæœºæ•°+é¢„ä¸»å¯†é’¥è®¡ç®—ä¸»å¯†é’¥ï¼Œç„¶åç”Ÿæˆä¼šè¯å¯†é’¥ã€‚ã€‚ã€‚ï¼‰å¥½äº†ï¼Œæˆ‘è¿™è¾¹OKäº†ã€‚</li>
<li><span class="label success">æœåŠ¡ç«¯</span>ï¼šæ”¶åˆ°ã€‚ï¼ˆç”¨ç§é’¥è§£å¯†å‡ºé¢„ä¸»å¯†é’¥ï¼Œä½¿ç”¨ä¸¤ä¸ªéšæœºæ•°+é¢„ä¸»å¯†é’¥è®¡ç®—ä¸»å¯†é’¥ï¼Œç„¶åç”Ÿæˆä¼šè¯å¯†é’¥ã€‚ã€‚ã€‚ï¼‰å¥½äº†ï¼Œæˆ‘è¿™è¾¹ä¹ŸOKäº†ã€‚</li>
<li><span class="label info">å®¢æˆ·ç«¯</span>ï¼šè¿™æ˜¯åŠ å¯†çš„åº”ç”¨æ•°æ®ã€‚ã€‚ã€‚</li>
<li><span class="label success">æœåŠ¡ç«¯</span>ï¼šè¿™æ˜¯åŠ å¯†çš„åº”ç”¨æ•°æ®ã€‚ã€‚ã€‚</li>
</ul>
<p>æ³¨ï¼šä¸Šé¢çš„æµç¨‹æ˜¯å•å‘è®¤è¯ï¼ˆæœåŠ¡ç«¯æ²¡æœ‰éªŒè¯å®¢æˆ·ç«¯çš„èº«ä»½ï¼‰ï¼Œå¦‚æœæœåŠ¡ç«¯ä¹Ÿéœ€è¦éªŒå®¢æˆ·ç«¯çš„èº«ä»½ï¼Œä¼šåœ¨ç¬¬ä¸€æ¬¡äº¤äº’ä¸­å‘é€<code>Certificate Request</code>æ¶ˆæ¯ï¼Œå®¢æˆ·ç«¯ç›¸åº”çš„åœ¨ç¬¬äºŒæ¬¡äº¤äº’ä¸­å‘é€è‡ªå·±çš„<code>Certificate</code>ä»¥åŠ<code>CertificateVerify</code>æ¶ˆæ¯ç»™æœåŠ¡ç«¯ã€‚</p>
<h3 id="å¯†é’¥äº¤æ¢æµç¨‹-DH"><a href="#å¯†é’¥äº¤æ¢æµç¨‹-DH" class="headerlink" title="å¯†é’¥äº¤æ¢æµç¨‹-DH"></a>å¯†é’¥äº¤æ¢æµç¨‹-DH</h3><p>åŸºäºDHçš„å¯†é’¥äº¤æ¢æµç¨‹å¦‚ä¸‹ï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/catbro666/catbro666.github.io/posts/e92ef4b4/SSL-keyexchange-DH.jpeg" alt="SSL-keyexchange-DH" loading="lazy"></p>
<p>æˆ‘ä»¬åŒæ ·æ¥æ¨¡æ‹Ÿä¸‹åå•†è¿‡ç¨‹ï¼š</p>
<ul>
<li><span class="label info">å®¢æˆ·ç«¯</span>ï¼šHiï¼ŒæœåŠ¡ç«¯ï¼Œæˆ‘è¿™è¾¹æ”¯æŒè¿™äº›ç®—æ³•ï¼Œè¿™æ˜¯æˆ‘æœ¬æ¬¡çš„éšæœºæ•°ã€‚
</li>
<li><span class="label success">æœåŠ¡ç«¯</span>ï¼šå¥½çš„ï¼Œæˆ‘çœ‹çœ‹ï¼Œæˆ‘ä»¬å°±é€‰ç”¨è¿™ä¸ªç®—æ³•å¥—ä»¶å§ï¼Œè¿™æ˜¯æˆ‘æœ¬æ¬¡çš„éšæœºæ•°ï¼Œç»™ä½ æˆ‘çš„è¯ä¹¦ã€‚æˆ‘è¿™è¾¹ç”¨è¿™ä¸ªDHå‚æ•°ï¼Œè¿™æ˜¯å¯¹åº”çš„ç­¾åã€‚
</li>
<li><span class="label info">å®¢æˆ·ç«¯</span>ï¼šç¨ç­‰æˆ‘éªŒä¸‹è¯ä¹¦å’Œç­¾åï¼Œå—¯ï¼Œçš„ç¡®æ˜¯æœåŠ¡ç«¯çš„è¯ä¹¦ï¼Œç­¾åä¹Ÿæ²¡æœ‰é—®é¢˜ã€‚è¿™æ˜¯æˆ‘è¿™è¾¹çš„DHå‚æ•°ã€‚ï¼ˆä½¿ç”¨DHå‚æ•°æ¨å¯¼å‡ºé¢„ä¸»å¯†é’¥ï¼Œå†ä½¿ç”¨ä¸¤ä¸ªéšæœºæ•°+é¢„ä¸»å¯†é’¥è®¡ç®—ä¸»å¯†é’¥ï¼Œç„¶åç”Ÿæˆä¼šè¯å¯†é’¥ã€‚ã€‚ã€‚ï¼‰å¥½äº†ï¼Œæˆ‘è¿™è¾¹OKäº†ã€‚
</li>
<li><span class="label success">æœåŠ¡ç«¯</span>ï¼šæ”¶åˆ°ã€‚ï¼ˆä½¿ç”¨DHå‚æ•°æ¨å¯¼é¢„ä¸»å¯†é’¥ï¼Œå†ä½¿ç”¨ä¸¤ä¸ªéšæœºæ•°+é¢„ä¸»å¯†é’¥è®¡ç®—ä¸»å¯†é’¥ï¼Œç„¶åç”Ÿæˆä¼šè¯å¯†é’¥ã€‚ã€‚ã€‚ï¼‰å¥½äº†ï¼Œæˆ‘è¿™è¾¹ä¹ŸOKäº†ã€‚
</li>
<li><span class="label info">å®¢æˆ·ç«¯</span>ï¼šè¿™æ˜¯åŠ å¯†çš„åº”ç”¨æ•°æ®ã€‚ã€‚ã€‚
</li>
<li><span class="label success">æœåŠ¡ç«¯</span>ï¼šè¿™æ˜¯åŠ å¯†çš„åº”ç”¨æ•°æ®ã€‚ã€‚ã€‚</li>
</ul>
<h3 id="å¯†é’¥ç”Ÿæˆ"><a href="#å¯†é’¥ç”Ÿæˆ" class="headerlink" title="å¯†é’¥ç”Ÿæˆ"></a>å¯†é’¥ç”Ÿæˆ</h3><p>é€šè¿‡ç¬¬ä¸€æ¬¡ClientHelloå’ŒServerHelloçš„äº¤äº’ã€ä»¥åŠå¯†é’¥äº¤æ¢çš„è¿‡ç¨‹ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯åŒæ–¹ï¼Œéƒ½å¾—åˆ°äº†clientéšæœºæ•°ã€serveréšæœºæ•°ä»¥åŠé¢„ä¸»å¯†é’¥ã€‚æ¥ä¸‹æ¥å°±å¯ä»¥é€šè¿‡è¿™äº›æ¥è®¡ç®—ä¸»å¯†é’¥äº†ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">master_secret = PRF(pre_master_secret, &quot;master secret&quot;,</span><br><span class="line">                    ClientHello.random + ServerHello.random)</span><br><span class="line">                    [0..47];</span><br></pre></td></tr></table></figure>

<p>å¾—åˆ°ä¸»å¯†é’¥ä¹‹åï¼Œå†å°†å…¶æ‰©å±•ä¸ºä¸€ä¸ªå®‰å…¨å­—èŠ‚åºåˆ—ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">key_block = PRF(SecurityParameters.master_secret,</span><br><span class="line">                     &quot;key expansion&quot;,</span><br><span class="line">                     SecurityParameters.server_random +</span><br><span class="line">                     SecurityParameters.client_random);</span><br></pre></td></tr></table></figure>

<p>ç„¶ååˆ†åˆ«åˆ‡åˆ†ä¸ºMACå¯†é’¥ã€å¯¹ç§°åŠ å¯†çš„keyå’ŒIVã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">client_write_MAC_key[SecurityParameters.mac_key_length]</span><br><span class="line">server_write_MAC_key[SecurityParameters.mac_key_length]</span><br><span class="line">client_write_key[SecurityParameters.enc_key_length]</span><br><span class="line">server_write_key[SecurityParameters.enc_key_length]</span><br><span class="line">client_write_IV[SecurityParameters.fixed_iv_length]</span><br><span class="line">server_write_IV[SecurityParameters.fixed_iv_length]</span><br></pre></td></tr></table></figure>

<p>ç”»æˆå›¾çš„è¯å¤§æ¦‚æ˜¯ä¸‹é¢è¿™ä¸ªæ ·å­ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/catbro666/catbro666.github.io/posts/e92ef4b4/TLS1_2-Key-Calculation.png" alt="TLS1_2-Key-Calculation" loading="lazy"></p>
<h2 id="Sessioné‡ç”¨"><a href="#Sessioné‡ç”¨" class="headerlink" title="Sessioné‡ç”¨"></a>Sessioné‡ç”¨</h2><p>SSLæ¡æ‰‹é¢å¤–å¼•å…¥äº†<strong>ä¸¤æ¬¡äº¤äº’</strong>ä»¥åŠ<strong>CPUå¯†é›†å‹</strong>çš„ç®—æ³•è¿ç®—ã€‚æ¯æ¬¡è¿æ¥éƒ½è¿›è¡ŒSSLæ¡æ‰‹æ—¶éå¸¸è€—è´¹æ€§èƒ½çš„ï¼Œæœ‰æ²¡æœ‰ä»€ä¹ˆåŠæ³•è¿›è¡Œæ€§èƒ½ä¼˜åŒ–å‘¢ï¼Ÿæ˜¾ç„¶æå‡ç¡¬ä»¶æ€§èƒ½ã€è½¯ä»¶æ€§èƒ½éƒ½æ˜¯æœ‰æ•ˆçš„æ–¹æ³•ã€‚å…¶å®SSLä»åè®®å±‚é¢ä¹Ÿè€ƒè™‘äº†è¿™ä¸ªé—®é¢˜ï¼Œå®ƒæä¾›äº†â€œä¼šè¯é‡ç”¨â€çš„ç‰¹æ€§ã€‚åŒæ–¹åœ¨å»ºç«‹å‰ä¸€æ¬¡SSLè¿æ¥ä¹‹åï¼Œå¯ä»¥å°†SSLä¼šè¯ä¿å­˜ä¸‹æ¥ã€‚ä¸‹ä¸€æ¬¡æƒ³è¦åœ¨å»ºç«‹SSLè¿æ¥çš„æ—¶å€™ï¼Œå¯ä»¥ç›´æ¥æ¢å¤ä¹‹å‰çš„SSLä¼šè¯ï¼Œä»è€Œç®€åŒ–SSLæ¡æ‰‹æµç¨‹ã€‚Sessioné‡ç”¨çš„æ—¶å€™åªéœ€è¦è¿›è¡Œä¸€æ¬¡SSLæ¡æ‰‹äº¤äº’ï¼Œè€Œä¸”ä¸éœ€è¦å†è¿›è¡Œèº«ä»½è®¤è¯å’Œå¯†é’¥äº¤æ¢ï¼Œä»è€Œå¤§å¹…å‡å°äº†æ•´ä¸ªæµç¨‹çš„å»¶è¿Ÿå’Œè®¡ç®—å¼€é”€ã€‚</p>
<p>äº‹å®ä¸Šï¼Œå¦‚æœæµè§ˆå™¨è¦å¯¹åŒä¸ªç«™ç‚¹å‘èµ·å¤šä¸ªè¿æ¥ï¼Œå®ƒé€šå¸¸å°±ä¼šç­‰ç¬¬ä¸€ä¸ªSSLæ¡æ‰‹å®Œæˆåå†å‘èµ·å…¶ä»–çš„è¿æ¥ï¼Œè¿™æ ·å…¶ä»–çš„è¿æ¥å°±å¯ä»¥å¤ç”¨ä¹‹å‰çš„é‚£ä¸ªSessionã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/catbro666/catbro666.github.io/posts/e92ef4b4/TLS-half-handshake-flow.svg" alt="TLS-half-handshake-flow" loading="lazy"></p>
<p>Sessioné‡ç”¨æœ‰ä¸¤ç§æœºåˆ¶ï¼Œåˆ†åˆ«ä¸ºSession IDså’ŒSession ticketsã€‚</p>
<h3 id="Session-ID"><a href="#Session-ID" class="headerlink" title="Session ID"></a>Session ID</h3><p>æˆ‘ä»¬æ¥çœ‹ä¸‹ä½¿ç”¨Session IDæ—¶çš„Sessioné‡ç”¨æµç¨‹ã€‚ä»å‰é¢å¯†é’¥äº¤æ¢çš„æµç¨‹å›¾ä¸­å¯ä»¥çœ‹åˆ°ï¼ŒæœåŠ¡ç«¯åœ¨<code>Server Hello</code>æ¶ˆæ¯ä¸­ä¼šå‘é€æœ¬æ¬¡ä¼šè¯çš„<code>Session ID</code>ç»™å®¢æˆ·ç«¯ã€‚å®Œæˆæ¡æ‰‹ä¹‹åï¼ŒæœåŠ¡ç«¯ä¼šä¿å­˜æœ¬æ¬¡çš„Sessionã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/catbro666/catbro666.github.io/posts/e92ef4b4/session_resumption_with_session_id.jpeg" alt="session_resumption_with_session_id" loading="lazy"></p>
<p>åç»­å®¢æˆ·ç«¯å¯ä»¥é€šè¿‡æ¢å¤è¿™ä¸ªSessionæ¥å»ºç«‹SSLè¿æ¥ã€‚å…·ä½“åšæ³•å°±æ˜¯åœ¨<code>ClientHello</code>æ¶ˆæ¯ä¸­å¸¦ä¸Šè¦æ¢å¤çš„Session IDï¼Œç„¶åæœåŠ¡ç«¯ä¼šæ ¹æ®Session IDå»æŸ¥æ‰¾å¯¹åº”çš„ä¼šè¯ï¼Œå¦‚æœä¸€åˆ‡éƒ½OKçš„è¯ï¼Œå°±ä¼šæ ¹æ®ä¿å­˜çš„ä¼šè¯æ¢å¤å‡ºä¼šè¯å¯†é’¥ç­‰ä¿¡æ¯ã€‚å¦‚æœæœåŠ¡ç«¯ä¸æ”¯æŒä¼šè¯é‡ç”¨ã€æˆ–è€…æ²¡æ‰¾åˆ°Session IDã€æˆ–è€…ä¼šè¯å·²ç»è¿‡æœŸäº†ï¼Œé‚£ä¹ˆå°±é€€åŒ–åˆ°å®Œæ•´çš„SSLæ¡æ‰‹ã€‚</p>
<h3 id="Session-Ticket"><a href="#Session-Ticket" class="headerlink" title="Session Ticket"></a>Session Ticket</h3><p>Session IDæœºåˆ¶å®ƒè¦æ±‚æœåŠ¡ç«¯ä¿å­˜æ¯ä¸ªå®¢æˆ·ç«¯çš„session cacheï¼Œè¿™ä¼šåœ¨æœåŠ¡ç«¯é€ æˆå‡ ä¸ªé—®é¢˜ï¼šå†…å­˜çš„é¢å¤–å¼€é”€ã€è¦æ±‚Sessionçš„ä¿å­˜å’Œæ·˜æ±°ç­–ç•¥ã€ç„¶åå¯¹æœ‰å¤šä¸ªæœåŠ¡å™¨çš„ç«™ç‚¹ï¼Œå¦‚ä½•é«˜æ€§èƒ½åœ°å…±äº«session cacheæå‡ºäº†æŒ‘æˆ˜ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/catbro666/catbro666.github.io/posts/e92ef4b4/session_resumption_with_session_ticket.jpeg" alt="session_resumption_with_session_ticket" loading="lazy"></p>
<p>Session Ticketæœºåˆ¶çš„æå‡ºå°±æ˜¯ä¸ºäº†è§£å†³Session IDçš„é—®é¢˜ã€‚Session Ticketä¸éœ€è¦æœåŠ¡ç«¯ä¿å­˜æ¯ä¸ªå®¢æˆ·ç«¯çš„ä¼šè¯ã€‚å–è€Œä»£ä¹‹ï¼Œå¦‚æœå®¢æˆ·ç«¯å®£ç§°å®ƒæ”¯æŒsession ticketï¼ŒæœåŠ¡ç«¯ä¼šå‘é€ç»™å®¢æˆ·ç«¯ä¸€ä¸ª<code>New Session Ticket</code>æ¶ˆæ¯ï¼Œå…¶ä¸­åŒ…å«äº†ä¼šè¯ç›¸å…³çš„åŠ å¯†æ•°æ®ï¼ŒåŠ å¯†çš„å¯†é’¥åªæœ‰æœåŠ¡ç«¯çŸ¥é“ã€‚</p>
<p>å®¢æˆ·ç«¯ä¼šä¿å­˜è¿™ä¸ªsession ticketï¼Œå½“éœ€è¦ä¼šè¯æ¢å¤çš„æ—¶å€™ï¼Œå®ƒä¼šåœ¨<code>ClientHello</code>æ¶ˆæ¯çš„<code>SessionTicket</code>æ‰©å±•ä¸­å¸¦ä¸Šè¿™ä¸ªsession ticketã€‚æœåŠ¡ç«¯åœ¨æ”¶åˆ°ä¹‹åè§£å¯†å‡ºå…¶ä¸­çš„sessionæ•°æ®ä»è€Œæ¢å¤ä¸Šæ¬¡çš„ä¼šè¯ã€‚</p>
<p>æ‰€ä»¥Session Ticketæœºåˆ¶å¯¹äºæœåŠ¡ç«¯æ¥è¯´æ˜¯ä¸€ç§æ— çŠ¶æ€ï¼ˆstatelessï¼‰çš„é‡ç”¨ï¼Œä¸éœ€è¦æœåŠ¡ç«¯ä¿å­˜session cacheï¼Œå½“ç„¶ä¹Ÿå°±æ²¡æœ‰å¤šæœåŠ¡å™¨åŒæ­¥çš„é—®é¢˜ã€‚</p>
<h2 id="è¯ä¹¦çš„åŠé”€ï¼ˆé»‘åå•ï¼‰"><a href="#è¯ä¹¦çš„åŠé”€ï¼ˆé»‘åå•ï¼‰" class="headerlink" title="è¯ä¹¦çš„åŠé”€ï¼ˆé»‘åå•ï¼‰"></a>è¯ä¹¦çš„åŠé”€ï¼ˆé»‘åå•ï¼‰</h2><p>æˆ‘ä»¬åœ¨ä»‹ç»è¯ä¹¦çš„æ—¶å€™å·²ç»çœ‹åˆ°äº†è¯ä¹¦æœ‰ä¸€ä¸ªæœ‰æ•ˆæœŸï¼Œåœ¨æœ‰æ•ˆæœŸå¤–æ˜¯æ— æ³•éªŒè¯é€šè¿‡çš„ã€‚ä½†æ˜¯å¦‚æœæˆ‘ä»¬æƒ³åœ¨æœ‰æ•ˆæœŸå†…å°±è®©è¯ä¹¦å¤±æ•ˆè¯¥æ€ä¹ˆåŠï¼Ÿæ¯”å¦‚å…¬å¸å‘˜å·¥ç¦»èŒäº†ã€æˆ–è€…ç§é’¥æ³„æ¼ç­‰ï¼Œæ€»ä¸å¯èƒ½æŠŠå‘å‡ºå»çš„è¯ä¹¦æ”¶å›æ¥å§ã€‚</p>
<p>æ‰€ä»¥å°±å¼•å…¥äº†è¯ä¹¦çš„åŠé”€ï¼ŒCAå¯ä»¥åŠé”€æŸå¼ è¯ä¹¦ï¼Œåœ¨éªŒè¯è¯ä¹¦æœ‰æ•ˆæ€§çš„æ—¶å€™è¿›è¡Œé¢å¤–çš„é»‘åå•éªŒè¯ã€‚é»‘åå•çš„éªŒè¯æœ‰å¦‚ä¸‹å‡ ç§æœºåˆ¶ï¼š</p>
<h3 id="Certificate-Revocation-List-CRL"><a href="#Certificate-Revocation-List-CRL" class="headerlink" title="Certificate Revocation List (CRL)"></a>Certificate Revocation List (CRL)</h3><p>CRLï¼Œå³è¯ä¹¦åŠé”€åˆ—è¡¨ã€‚CAæœºæ„ç»´æŠ¤ä¸€ä¸ªè¢«åŠé”€è¯ä¹¦çš„åˆ—è¡¨ï¼Œé‡Œé¢æ˜¯è¢«åŠé”€è¯ä¹¦çš„ä¿¡æ¯ã€‚éªŒè¯è¯ä¹¦æ–¹éœ€è¦ä¸‹è½½è¿™ä¸ªåˆ—è¡¨ï¼Œè¿›è¡Œé»‘åå•çš„éªŒè¯ã€‚</p>
<p>CRLçš„ç¼ºé™·ä¹Ÿå¾ˆæ˜æ˜¾ï¼šè¯ä¹¦éªŒè¯æ–¹å¿…é¡»ä¸‹è½½è¿™ä¸ªåˆ—è¡¨ï¼Œä¸”ä¸‹è½½çš„åˆ—è¡¨è·Ÿå®é™…CAæœºæ„çš„åˆ—è¡¨ä¹‹é—´å¯èƒ½ä¸åŒæ­¥ã€‚å¦‚æœä¸€ä¸ªè¯ä¹¦å®é™…å·²ç»è¢«åŠé”€ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰åœ¨æœ¬åœ°åˆ—è¡¨ä¸­ï¼Œå°±å¯èƒ½å½¢æˆå®‰å…¨éšæ‚£ã€‚</p>
<h3 id="Online-Certificate-Status-Protocol-OCSP"><a href="#Online-Certificate-Status-Protocol-OCSP" class="headerlink" title="Online Certificate Status Protocol (OCSP)"></a>Online Certificate Status Protocol (OCSP)</h3><p>OCSPï¼Œå³åœ¨çº¿è¯ä¹¦çŠ¶æ€åè®®ã€‚å®ƒé€šè¿‡åœ¨çº¿è¯·æ±‚çš„æ–¹å¼æ¥è¿›è¡Œé»‘åå•éªŒè¯ï¼Œä¸éœ€è¦ä¸‹è½½æ•´ä¸ª listï¼Œåªéœ€è¦å°†è¯¥è¯ä¹¦çš„åºåˆ—å·å‘é€ç»™ CA è¿›è¡ŒéªŒè¯ã€‚éƒ¨ç½² OCSP å¯¹ CAä¹Ÿå¼•å…¥äº†ä¸€å®šçš„è¦æ±‚ï¼ŒCA éœ€è¦æ­å»ºçš„ä¸€ä¸ªé«˜æ€§èƒ½çš„æœåŠ¡å™¨æ¥æä¾›éªŒè¯æœåŠ¡ã€‚ä¸‡ä¸€æœåŠ¡å™¨æŒ‚æ‰äº†ï¼Œé‚£æ‰€æœ‰çš„é»‘åå•éªŒè¯å°±ä¼šå½“æˆæ˜¯é€šè¿‡ï¼Œæœ‰ä¸€å®šçš„å®‰å…¨éšæ‚£ã€‚</p>
<h3 id="OCSP-Stapling"><a href="#OCSP-Stapling" class="headerlink" title="OCSP Stapling"></a>OCSP Stapling</h3><p>OCSP Staplingæ˜¯OCSPæ ‡å‡†çš„ä¸€ä¸ªæ‰©å±•ï¼Œä¸»è¦ç›®æ ‡å°±æ˜¯æå‡æ€§èƒ½å’Œå®‰å…¨æ€§ã€‚è¯ä¹¦æ‹¥æœ‰è€…è‡ªå·±å®šæœŸå‘OCSPæœåŠ¡å™¨å‘é€è¯·æ±‚ã€‚è·å–OCSPå“åº”ï¼Œè¿™ä¸ªå“åº”æ˜¯åŸºäºæ—¶é—´æˆ³çš„ï¼Œè€Œä¸”ç”±CAç›´æ¥ç­¾åã€‚</p>
<p>OCSP Staplingæå‡æ•´ä½“çš„æ€§èƒ½ï¼Œä¸€æ–¹é¢è¯ä¹¦éªŒè¯æ–¹ä¸éœ€è¦å†ç›´æ¥è¯·æ±‚CAçš„æœåŠ¡å™¨å»æŸ¥è¯¢çŠ¶æ€ï¼Œå¦ä¸€æ–¹é¢CAçš„OCSPæœåŠ¡å™¨çš„å‹åŠ›ä¹Ÿå‡å°äº†ã€‚</p>
<h2 id="Server-Name-Indicationï¼ˆSNIï¼‰"><a href="#Server-Name-Indicationï¼ˆSNIï¼‰" class="headerlink" title="Server Name Indicationï¼ˆSNIï¼‰"></a>Server Name Indicationï¼ˆSNIï¼‰</h2><p>å½“ä¸€ä¸ªç«™ç‚¹ä¸Šéƒ¨ç½²äº†å¤šä¸ªServeræ—¶ï¼ˆç›¸å½“äºä¸€ä¸ªIPæ˜ å°„äº†å¤šä¸ªåŸŸåï¼‰ï¼Œä¸åŒçš„Serverå¯èƒ½éœ€è¦ä½¿ç”¨ä¸åŒçš„è¯ä¹¦ã€‚é—®é¢˜æ˜¯å¦‚ä½•åœ¨SSLæ¡æ‰‹é˜¶æ®µçŸ¥é“æ˜¯è®¿é—®é‚£ä¸ªhostï¼ˆè¿˜æ²¡åˆ°HTTPé˜¶æ®µï¼Œæ— æ³•ç”¨è¯·æ±‚å¤´é‡Œçš„<code>HOST</code>å­—æ®µï¼‰ï¼Œä»è€Œå†³å®šä½¿ç”¨å¯¹åº”çš„è¯ä¹¦å‘¢ï¼Ÿ</p>
<p>SNIå°±æ˜¯ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå…·ä½“åšæ³•æ˜¯åœ¨<code>ClientHello</code>æ‰©å±•ä¸­å¸¦ä¸ŠSNIï¼ŒæœåŠ¡ç«¯å°±èƒ½ä»ä¸­å¾—çŸ¥éœ€è¦è®¿é—®å“ªä¸ªhostï¼Œä»è€Œé€‰æ‹©ç›¸åº”çš„è¯ä¹¦ã€‚</p>
<h1 id="GMSSLåè®®å·®å¼‚"><a href="#GMSSLåè®®å·®å¼‚" class="headerlink" title="GMSSLåè®®å·®å¼‚"></a>GMSSLåè®®å·®å¼‚</h1><p>GMSSLä¿®æ”¹è‡ªTLS1.1ï¼Œæ€»ä½“ä¸Šä¸TLSåè®®çš„å·®å¼‚ä¸å¤§ã€‚è¯¦è§ã€ŠGMT 0024-2014 SSL VPNæŠ€æœ¯è§„èŒƒã€‹ã€‚</p>
<h2 id="åè®®å·"><a href="#åè®®å·" class="headerlink" title="åè®®å·"></a>åè®®å·</h2><p>TLSv1.0, TSLv1.1, TLSv1.2ã€TLSv1.3çš„åè®®å·åˆ†åˆ«ä¸º<code>0x0301</code>ã€<code>0x0302</code>ã€<code>0x0303</code>ã€<code>0x0304</code>ã€‚</p>
<p>è€Œå›½å¯†çš„ç‰ˆæœ¬å·æ˜¯<code>0x0101</code>ã€‚</p>
<h2 id="ç®—æ³•å¥—ä»¶"><a href="#ç®—æ³•å¥—ä»¶" class="headerlink" title="ç®—æ³•å¥—ä»¶"></a>ç®—æ³•å¥—ä»¶</h2><p>æ–°å¢äº†å›½å¯†çš„SM1&#x2F;2&#x2F;3&#x2F;4ç­‰ç®—æ³•ï¼Œå®šä¹‰äº†å¤šä¸ªç®—æ³•å¥—ä»¶ï¼Œå…¶ä¸­æ¯”è¾ƒå¸¸ç”¨çš„å¦‚<code>ECC_SM4_SM3</code>å’Œ<code>ECDHE_SM4_SM3</code>ã€‚<code>ECDHE_SM4_SM3</code>è¦æ±‚å¿…é¡»åŒå‘è®¤è¯ã€‚</p>
<p>å…¶ä¸­<code>ECC_SM4_SM3</code>çš„å¯†é’¥äº¤æ¢è¿‡ç¨‹ç±»ä¼¼RSAçš„å¯†é’¥äº¤æ¢è¿‡ç¨‹ï¼Œç”±å®¢æˆ·ç«¯ç”¨æœåŠ¡ç«¯çš„å…¬é’¥å¯¹é¢„ä¸»å¯†é’¥è¿›è¡ŒåŠ å¯†åå‘é€ç»™æœåŠ¡ç«¯ã€‚<code>ECDHE_SM4_SM3</code>çš„å¯†é’¥äº¤æ¢è¿‡ç¨‹ä¸æ™®é€šTLSçš„ECDHEå¯†é’¥äº¤æ¢ç±»ä¼¼ï¼Œé¢„ä¸»å¯†é’¥ç”±å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯åŒæ–¹æ¨å¯¼å¾—å‡ºã€‚<code>ECC_SM4_SM3</code>å’Œ<code>ECDHE_SM4_SM3</code>çš„èº«ä»½è®¤è¯æ˜¯éƒ½æ˜¯é€šè¿‡SM2çš„ç­¾å&#x2F;éªŒç­¾æ¥å®Œæˆã€‚</p>
<h2 id="åŒè¯ä¹¦ä½“ç³»"><a href="#åŒè¯ä¹¦ä½“ç³»" class="headerlink" title="åŒè¯ä¹¦ä½“ç³»"></a>åŒè¯ä¹¦ä½“ç³»</h2><h3 id="è¯ä¹¦æ¶ˆæ¯"><a href="#è¯ä¹¦æ¶ˆæ¯" class="headerlink" title="è¯ä¹¦æ¶ˆæ¯"></a>è¯ä¹¦æ¶ˆæ¯</h3><p>å›½å¯†SSLé‡‡ç”¨åŒè¯ä¹¦ä½“ç³»ï¼šä¸€ä¸ªç­¾åè¯ä¹¦ã€ä¸€ä¸ªåŠ å¯†è¯ä¹¦ã€‚å…¶ä¸­ç­¾åè¯ä¹¦ç”¨äºèº«ä»½è®¤è¯ã€åŠ å¯†è¯ä¹¦ç”¨äºå¯†é’¥äº¤æ¢ã€‚å‘é€<code>Certificate</code>æ¶ˆæ¯æ—¶éœ€è¦åŒæ—¶å‘é€ä¸¤ä¸ªè¯ä¹¦ï¼Œæ ¼å¼ä¸æ ‡å‡†TLSæŠ¥æ–‡æ ¼å¼ä¸€æ ·ï¼Œç¬¬ä¸€ä¸ªè¯ä¹¦æ˜¯ç­¾åè¯ä¹¦ã€ç¬¬äºŒä¸ªè¯ä¹¦æ˜¯åŠ å¯†è¯ä¹¦ã€‚</p>
<h3 id="ECC-SM4-SM3å¯†é’¥äº¤æ¢"><a href="#ECC-SM4-SM3å¯†é’¥äº¤æ¢" class="headerlink" title="ECC_SM4_SM3å¯†é’¥äº¤æ¢"></a>ECC_SM4_SM3å¯†é’¥äº¤æ¢</h3><p>å› ä¸ºé‡‡ç”¨äº†åŒè¯ä¹¦ä½“ç³»ï¼Œåœ¨SSLçŠ¶æ€æœºä¸Šç•¥å¾®æœ‰ç‚¹ä¸åŒã€‚<code>ECC_SM4_SM3</code>çš„å¯†é’¥äº¤æ¢è¿‡ç¨‹å¦‚ä¸‹ï¼šæœåŠ¡ç«¯å‘é€<code>Certificate</code>æ¶ˆæ¯ä¹‹åï¼Œè¿˜è¦å‘é€ä¸€ä¸ª<code>ServerKeyExchange</code>æ¶ˆæ¯ï¼ˆè¿™è·ŸRSAå¯†é’¥äº¤æ¢æœ‰æ‰€ä¸åŒï¼‰ï¼Œ<code>ServerKeyExchange</code>ä¸­åŒ…å«äº†ä¸€ä¸ªç­¾åå€¼ï¼Œç­¾åç”±æœåŠ¡ç«¯ç­¾åè¯ä¹¦å¯¹åº”çš„ç§é’¥ï¼ˆç­¾åç§é’¥ï¼‰è¿›è¡Œè®¡ç®—ï¼Œç­¾åçš„å†…å®¹åŒ…æ‹¬äº†ClientHelloå’ŒServerHelloä¸­çš„éšæœºæ•°ä»¥åŠåŠ å¯†è¯ä¹¦ã€‚</p>
<p>å®¢æˆ·ç«¯éªŒè¯è¯ä¹¦å’Œç­¾åä¹‹åï¼Œä½¿ç”¨æœåŠ¡ç«¯åŠ å¯†è¯ä¹¦åŠ å¯†é¢„ä¸»å¯†é’¥ï¼Œå‘é€ç»™æœåŠ¡ç«¯ï¼ŒæœåŠ¡ç«¯åˆ™ç”±è‡ªå·±çš„åŠ å¯†ç§é’¥è¿›è¡Œè§£å¯†å¾—åˆ°é¢„ä¸»å¯†é’¥ã€‚</p>
<h3 id="ECDHE-SM4-SM3å¯†é’¥äº¤æ¢"><a href="#ECDHE-SM4-SM3å¯†é’¥äº¤æ¢" class="headerlink" title="ECDHE_SM4_SM3å¯†é’¥äº¤æ¢"></a>ECDHE_SM4_SM3å¯†é’¥äº¤æ¢</h3><p><code>ECDHE_SM4_SM3</code>çš„å¯†é’¥äº¤æ¢è¿‡ç¨‹å¦‚ä¸‹ï¼šæœåŠ¡ç«¯å‘é€<code>Certificate</code>æ¶ˆæ¯ä¹‹åï¼ŒåŒæ ·å‘é€ä¸€ä¸ª<code>ServerKeyExchange</code>æ¶ˆæ¯ï¼Œ<code>ServerKeyExchange</code>ä¸­åŒ…å«äº†ä¸€ä¸ªç­¾åå€¼ï¼Œç­¾åç”±æœåŠ¡ç«¯ç­¾åè¯ä¹¦å¯¹åº”çš„ç§é’¥ï¼ˆç­¾åç§é’¥ï¼‰è¿›è¡Œè®¡ç®—ã€‚ç­¾åçš„å†…å®¹è·Ÿ<code>ECC_SM4_SM3</code>æ—¶æœ‰æ‰€ä¸åŒï¼ŒåŒ…æ‹¬äº†ClientHelloå’ŒServerHelloä¸­çš„éšæœºæ•°ä»¥åŠæœåŠ¡ç«¯ECDHå‚æ•°ï¼ˆæ›²çº¿ã€å…¬é’¥ï¼‰ã€‚å›½å¯†ECDHEçš„å¯†é’¥æ¨å¯¼è®¡ç®—æ–¹å¼è·ŸTLSä¹Ÿæœ‰æ‰€ä¸åŒï¼ŒTLSåªéœ€è¦å¯¹æ–¹çš„ä¸´æ—¶å…¬é’¥å’Œè‡ªå·±çš„ä¸´æ—¶ç§é’¥å‚ä¸è®¡ç®—ï¼Œè€Œå›½å¯†éœ€è¦å¯¹æ–¹çš„ä¸´æ—¶å…¬é’¥å’Œå›ºå®šå…¬é’¥ï¼ˆå³åŠ å¯†è¯ä¹¦ä¸­çš„å…¬é’¥ï¼‰åŠè‡ªå·±çš„ä¸´æ—¶ç§é’¥å’Œå›ºå®šç§é’¥ï¼ˆå³åŠ å¯†ç§é’¥ï¼‰å‚ä¸è®¡ç®—ã€‚æ‰€ä»¥å›½å¯†<code>ECDHE</code>å¿…é¡»æ˜¯åŒå‘è®¤è¯ï¼Œå› ä¸ºæœåŠ¡ç«¯åœ¨è¿›è¡Œå¯†é’¥æ¨å¯¼çš„æ—¶å€™ä¹Ÿéœ€è¦ç”¨åˆ°å®¢æˆ·ç«¯çš„åŠ å¯†è¯ä¹¦ã€‚</p>
<p>å®¢æˆ·ç«¯éªŒè¯è¯ä¹¦å’Œç­¾åä¹‹åï¼Œå‘é€è‡ªå·±çš„è¯ä¹¦ç»™æœåŠ¡ç«¯ï¼Œæ¥ç€æ ¹æ®<code>ServerKeyExchange</code>ä¸­ECDHå‚æ•°ä¿¡æ¯ç”Ÿæˆè‡ªå·±çš„ä¸´æ—¶å¯†é’¥ï¼Œç„¶ååŒè‡ªå·±çš„åŠ å¯†å¯†é’¥ã€æœåŠ¡ç«¯ä¸´æ—¶å…¬é’¥å’ŒåŠ å¯†å…¬é’¥ä¸€èµ·è¿›è¡Œå¯†é’¥æ¨å¯¼å¾—åˆ°é¢„ä¸»å¯†é’¥ã€‚å¹¶å°†è‡ªå·±çš„ä¸´æ—¶å¯†é’¥å‚æ•°é€šè¿‡<code>ClientKeyExchange</code>æ¶ˆæ¯å‘é€ç»™æœåŠ¡ç«¯ï¼ŒæœåŠ¡ç«¯åŒæ ·ä½¿ç”¨è‡ªå·±çš„ä¸´æ—¶å¯†é’¥ã€åŠ å¯†å¯†é’¥ã€å®¢æˆ·ç«¯çš„ä¸´æ—¶å…¬é’¥å’ŒåŠ å¯†å…¬é’¥ä¸€èµ·è¿›è¡Œå¯†é’¥æ¨å¯¼å¾—åˆ°é¢„ä¸»å¯†é’¥ã€‚</p>
<p>å› ä¸ºæ˜¯åŒå‘è®¤è¯ï¼Œå®¢æˆ·ç«¯åœ¨å‘é€<code>ClientKeyExchange</code>æ¶ˆæ¯ä¹‹åï¼Œè¿˜éœ€è¦å‘é€ä¸€ä¸ª<code>CertificateVerify</code>æ¶ˆæ¯ï¼Œç­¾åçš„å†…å®¹ä¸ºä»ClientHelloæ¶ˆæ¯å¼€å§‹åˆ°ç›®å‰ä¸ºæ­¢çš„æ‰€æœ‰å·²ç»äº¤æ¢çš„æ¡æ‰‹æ¶ˆæ¯ã€‚</p>
<h1 id="å®‰å…¨æ€§"><a href="#å®‰å…¨æ€§" class="headerlink" title="å®‰å…¨æ€§"></a>å®‰å…¨æ€§</h1><h2 id="å¸¸è§æ”»å‡»"><a href="#å¸¸è§æ”»å‡»" class="headerlink" title="å¸¸è§æ”»å‡»"></a>å¸¸è§æ”»å‡»</h2><p>æœ‰äº›æ˜¯é’ˆå¯¹åè®®è®¾è®¡ä¸Šçš„æ¼æ´ï¼Œæœ‰äº›åˆ™æ˜¯é’ˆå¯¹å®ç°çš„bugï¼Œç»å¸¸ç»“åˆé™çº§æ”»å‡»æ‰‹æ®µä¸€èµ·ä½¿ç”¨ã€‚å› ä¸ºç¯‡å¹…åŸå› ï¼Œè¿™é‡Œä»…æŒ‘é€‰ä¸¤ä¸ªæœ‰ä»£è¡¨æ€§çš„é‡åå•†æ”»å‡»å’ŒHeartbleedç€é‡ä»‹ç»ä¸€ä¸‹ï¼Œå¯¹äºå…¶ä½™æ”»å‡»æ„Ÿå…´è¶£çš„å¯ä»¥å‚è€ƒ<a href="https://datatracker.ietf.org/doc/html/rfc7457">rfc7457-å·²çŸ¥æ”»å‡»æ€»ç»“</a></p>
<ul>
<li>é‡åå•†æ”»å‡»</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/catbro666/catbro666.github.io/posts/e92ef4b4/renegotiation-attack.png" loading="lazy"></p>
<p>ä¸­é—´äººåœ¨ä¸éœ€è¦åŠ«æŒã€è§£å¯†SSL&#x2F;TLSè¿æ¥çš„æƒ…å†µä¸‹ï¼ŒæˆåŠŸåœ°å°†è‡ªå·±ä¼ªé€ çš„æ•°æ®æ’å…¥åˆ°ç”¨æˆ·çœŸæ­£æ•°æ®ä¹‹å‰ã€‚ä¸­é—´äººå¦‚æœäº†è§£APPåè®®ï¼ˆå¦‚HTTPSï¼‰çš„è¯ï¼Œåˆ™ä¼šç²¾å¿ƒæ„é€ ä¸å®Œæ•´çš„æ•°æ®ï¼Œè®©æœåŠ¡å™¨çš„APPç¨‹åºè®¤ä¸ºå‘ç”Ÿç²˜åŒ…ï¼Œå°†æ•°æ®æš‚ç¼“ä¸å¤„ç†ï¼Œç»§ç»­ç­‰å¾…åç»­çš„æ•°æ®ä¸Šæ¥ã€‚ä¾‹å¦‚æ”»å‡»è€…å…ˆå‘é€äº†å¦‚ä¸‹çš„åŠæ‹‰å­è¯·æ±‚</p>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/bank/sendmoney.asp?acct=attacker&amp;amount=1000000</span> <span class="meta">HTTP/1.1</span></span><br><span class="line">X-Ignore-This:</span><br></pre></td></tr></table></figure>

<p>åé¢å½“å®¢æˆ·ç«¯å‘é€è¿‡æ¥çœŸæ­£çš„è¯·æ±‚</p>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/ebanking</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>validcookie</span><br></pre></td></tr></table></figure>

<p>APPç¨‹åºå°†è¯·æ±‚æ‹¼æ¥ï¼ŒçœŸæ­£çš„è¯·æ±‚å¤´è¢«å±è”½äº†ï¼Œä½†æ˜¯å´ä¿ç•™äº†ç”¨æˆ·çš„Cookieä¿¡æ¯ï¼Œä»è€Œåˆ©ç”¨ç”¨æˆ·çš„Cookieå»è®¿é—®ç½‘ç«™å†…å®¹ã€‚æœåŠ¡ç«¯ä¼šä»¥ä¸ºå‰é¢å‘é€çš„è¯·æ±‚æ˜¯çœŸæ­£çš„å®¢æˆ·ç«¯å‘é€çš„ã€‚</p>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/bank/sendmoney.asp?acct=attacker&amp;amount=1000000</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">X-Ignore-This</span><span class="punctuation">: </span>GET /ebanking HTTP/1.1</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>validcookie</span><br></pre></td></tr></table></figure>



<p>è¿™ä¸ªæ¼æ´æˆå› åœ¨äºï¼Œå®¢æˆ·ç«¯è®¤ä¸ºçš„é¦–æ¬¡åå•†å´è¢«æœåŠ¡å™¨è®¤ä¸ºæ˜¯é‡åå•†ï¼Œä»¥åŠé¦–æ¬¡åå•†å’Œé‡åå•†ä¹‹é—´ç¼ºå°‘å…³è”æ€§ã€‚è§£å†³åŠæ³•å°±æ˜¯ç¦ç”¨é‡åå•†æˆ–è€…ä½¿ç”¨<a href="https://datatracker.ietf.org/doc/html/rfc5746">å®‰å…¨é‡åå•†</a>ã€‚å®‰å…¨é‡åå•†ä¼šå¢åŠ ä¸€ä¸ªå®‰å…¨é‡åå•†æ ‡å¿—ï¼Œä»¥åŠç¡®è®¤é¦–æ¬¡åå•†å’Œé‡åå•†çš„å…³è”æ€§æ ¡éªŒï¼Œä»è€Œç¡®ä¿ä¸­é—´äººçš„æ”»å‡»è¡Œä¸ºå¯ä»¥è¢«è¯†åˆ«å¹¶æ‹’ç»ï¼Œä¿è¯é‡åå•†å®‰å…¨ã€‚</p>
<p>æˆ‘ä»¬æ¥çœ‹çœ‹å®‰å…¨é‡åå•†æ˜¯å¦‚ä½•ä¿è¯å®‰å…¨çš„ï¼Œå¯¹äºå‰é¢çš„ClientHello2é‡Œé¢ä¸æºå¸¦å®‰å…¨é‡åå•†è¡¨ç¤ºçš„æƒ…å†µï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/catbro666/catbro666.github.io/posts/e92ef4b4/renegotiation-attack-fix1.png" alt="renegotiation-attack-fix1" loading="lazy"></p>
<p>å¯¹äºå‰é¢çš„ClientHello2é‡Œé¢æºå¸¦å®‰å…¨é‡åå•†è¡¨ç¤ºçš„æƒ…å†µï¼š</p>
<p><img src="https://cdn.jsdelivr.net/gh/catbro666/catbro666.github.io/posts/e92ef4b4/renegotiation-attack-fix2.png" alt="renegotiation-attack-fix2" loading="lazy"></p>
<p>æ— è®ºå“ªç§æƒ…å†µéƒ½èƒ½ä¿è¯ä¸­é—´äººæ— æœºå¯ä¹˜ã€‚è€Œè¿™ä¸ªå®‰å…¨é‡åå•†çš„æ ‡è¯†å°±æ˜¯æä¾›äº†ä¸€ä¸ªæ–°çš„æ‰©å±•æ€§<code>renegotiation_info</code>ã€‚å› ä¸ºSSLv3&#x2F;TLS 1.0ä¸æ”¯æŒæ‰©å±•ï¼Œæ‰€ä»¥æä¾›äº†å¦ä¸€ç§æ–¹æ³•ï¼Œå³åœ¨ç®—æ³•å¥—ä»¶åˆ—è¡¨ä¸­åŠ ä¸Š<code>TLS_EMPTY_RENEGOTIATION_INFO_SCSVï¼ˆ0xFFï¼‰</code>ï¼Œè¿™ä¸ªä¸æ˜¯ä¸€ä¸ªçœŸæ­£çš„ç®—æ³•å¥—ä»¶ï¼Œåªæ˜¯èµ·æ ‡è¯†ä½œç”¨ã€‚</p>
<p>å®‰å…¨é‡åå•†çš„æµç¨‹å¦‚ä¸‹ï¼š</p>
<pre><code> 1. åœ¨è¿æ¥å»ºç«‹ç¬¬ä¸€æ¬¡SSLæ¡æ‰‹æœŸé—´ï¼ŒåŒæ–¹é€šè¿‡`renegotiation_info`æ‰©å±•æˆ–`SCSV`å¥—ä»¶é€šçŸ¥å¯¹æ–¹è‡ªå·±æ”¯æŒå®‰å…¨é‡åå•†
 2. ç„¶ååœ¨æ¡æ‰‹ç»“æŸä¹‹åï¼Œclientå’Œserveréƒ½åˆ†åˆ«è®°å½•`Finish`æ¶ˆæ¯ä¹‹ä¸­çš„`client_verify_data`å’Œ`server_verify_data`
 3. é‡åå•†æ—¶clientåœ¨`ClientHello`ä¸­åŒ…å«`client_verify_data`ï¼Œserveråœ¨`ServerHello`ä¸­åŒ…å«`client_verify_data`å’Œ`server_verify_data`ã€‚å¯¹äºå—å®³è€…ï¼Œå¦‚æœåå•†ä¸­ä¸ä¼šæºå¸¦è¿™äº›æ•°æ®åˆ™è¿æ¥æ— æ³•å»ºç«‹ã€‚è€ŒFinishedæ¶ˆæ¯ç”±äºæ˜¯åŠ å¯†çš„ï¼Œæ”»å‡»è€…æ— æ³•å¾—åˆ°client_verify_dataå’Œserver_verify_dataçš„å€¼ã€‚
</code></pre>
<ul>
<li><a href="https://heartbleed.com/">Heartbleed</a></li>
</ul>
<p>è¿™æ˜¯OpenSSLåº“ä¸€ä¸ªå®ç°ä¸Šçš„bugï¼Œè€Œä¸æ˜¯TLSåè®®æœ¬èº«çš„bugã€‚è¿™ä¸ªbugæ˜¯ç”±äºTLS heartbeatæ‰©å±•çš„å®ç°æ²¡æœ‰è¿›è¡Œæ­£ç¡®çš„è¾“å…¥éªŒè¯ï¼ˆç¼ºå°‘è¾¹ç•Œæ£€æŸ¥ï¼‰å¯¼è‡´çš„ã€‚bugçš„å‘½åä¹Ÿä»heartbeatè€Œæ¥ã€‚ç”±äºæ²¡æœ‰è¿›è¡Œè¾¹ç•Œæ£€æŸ¥ï¼Œå¯¼è‡´å¯ä»¥è¯»å–çš„æ•°æ®è¶…å‡ºå…è®¸çš„èŒƒå›´ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/catbro666/catbro666.github.io/posts/e92ef4b4/Simplified_Heartbleed_explanation.svg" alt="Simplified_Heartbleed_explanation" loading="lazy"></p>
<p>è¿™ä¸ªbugå½“å‰é€ æˆäº†éå¸¸å¹¿æ³›çš„å½±å“ï¼Œæœ‰è°ƒæŸ¥æ˜¾ç¤ºåœ¨è¿™ä¸ªæ¼æ´å…¬å¸ƒåå‡ å¹´ï¼Œä»æœ‰è®¸å¤šç½‘ç«™æš´éœ²åœ¨æ­¤æ”»å‡»ä¹‹ä¸‹ã€‚è¿™ä¸ªbugå‘Šè¯«æˆ‘ä»¬å°±ç®—åè®®æ˜¯å®‰å…¨çš„ï¼Œå®ç°ä»ç„¶å¯èƒ½å¼•å…¥å®‰å…¨é—®é¢˜ã€‚å®‰å…¨æ€§å°±åƒä¸€ä¸ªæœ¨æ¡¶ï¼Œæ•´ä½“çš„å®‰å…¨æ€§å–å†³äºæœ€çŸ­çš„é‚£å—æœ¨æ¿ã€‚</p>
<ul>
<li>CRIMEå’ŒBREACHæ”»å‡»</li>
</ul>
<p>è¿™ä¸¤ä¸ªæ”»å‡»éƒ½æ˜¯åŸºäºå‹ç¼©ç®—æ³•ï¼Œé€šè¿‡æ”¹å˜è¯·æ±‚æ­£æ–‡ï¼Œå¯¹æ¯”è¢«å‹ç¼©åçš„å¯†æ–‡é•¿åº¦ï¼Œå¯ä»¥ç ´è§£å‡ºæŸäº›ä¿¡æ¯ã€‚</p>
<p>CRIMEé€šè¿‡åœ¨å—å®³è€…çš„æµè§ˆå™¨ä¸­è¿è¡ŒJavaScriptä»£ç å¹¶åŒæ—¶ç›‘å¬HTTPSä¼ è¾“æ•°æ®ï¼Œèƒ½å¤Ÿè§£å¯†ä¼šè¯Cookieï¼Œä¸»è¦é’ˆå¯¹TLSå‹ç¼©ã€‚</p>
<p>Javascriptä»£ç å°è¯•ä¸€ä½ä¸€ä½çš„æš´åŠ›ç ´è§£Cookieçš„å€¼ã€‚ä¸­é—´äººç»„ä»¶èƒ½å¤Ÿè§‚å¯Ÿåˆ°æ¯æ¬¡ç ´è§£è¯·æ±‚å’Œå“åº”çš„å¯†æ–‡ï¼Œå¯»æ‰¾ä¸åŒï¼Œä¸€æ—¦å‘ç°äº†ä¸€ä¸ªï¼Œä»–ä¼šå’Œæ‰§è¡Œç ´è§£çš„Javascripté€šä¿¡å¹¶ç»§ç»­ç ´è§£ä¸‹ä¸€ä½ã€‚</p>
<p>BREACHæ”»å‡»æ˜¯CRIMEæ”»å‡»çš„å‡çº§ç‰ˆï¼Œæ”»å‡»æ–¹æ³•å’ŒCRIMEç›¸åŒï¼Œä¸åŒçš„æ˜¯BREACHåˆ©ç”¨çš„ä¸æ˜¯SSL&#x2F;TLSå‹ç¼©ï¼Œè€Œæ˜¯HTTPå‹ç¼©ã€‚æ‰€ä»¥è¦æŠµå¾¡BREACHæ”»å‡»å¿…é¡»ç¦ç”¨HTTPå‹ç¼©ã€‚</p>
<ul>
<li>BEASTæ”»å‡»</li>
</ul>
<p>TLS åœ¨ 1.1ç‰ˆæœ¬ä¹‹å‰ï¼Œä¸‹ä¸€ä¸ªè®°å½•çš„IVæ˜¯ç›´æ¥ä½¿ç”¨çš„å‰ä¸€ä¸ªè®°å½•çš„å¯†æ–‡ã€‚BEASTæ”»å‡»å°±æ˜¯åˆ©ç”¨äº†è¿™ä¸€ç‚¹ï¼Œæ”»å‡»è€…æ§åˆ¶å—å®³è€…å‘é€å¤§é‡è¯·æ±‚ï¼Œåˆ©ç”¨å¯é¢„æµ‹æ€§IVçŒœæµ‹å…³é”®ä¿¡æ¯ã€‚è§£å†³æ–¹æ³•å°±æ˜¯éƒ¨ç½²TLS 1.1æˆ–è€…æ›´é«˜çº§çš„ç‰ˆæœ¬ã€‚</p>
<ul>
<li>RC4æ”»å‡»</li>
</ul>
<p>åŸºäºRC4ç®—æ³•çš„å®‰å…¨æ€§ï¼ŒRC4ç›®å‰å·²ç»ä¸å®‰å…¨ï¼Œåº”è¯¥ç¦ç”¨ã€‚</p>
<ul>
<li>POODLEæ”»å‡»</li>
</ul>
<p>æ˜¯SSL 3.0è®¾è®¡ä¸Šçš„æ¼æ´ï¼Œä½¿ç”¨äº†éç¡®å®šæ€§çš„CBC-paddingï¼Œä½¿ä¸­é—´äººæ”»å‡»è€…æ›´å®¹æ˜“é€šè¿‡padding-oracleæ”»å‡»è·å–æ˜æ–‡æ•°æ®ã€‚</p>
<ul>
<li>é™çº§æ”»å‡»ï¼ˆç‰ˆæœ¬å›é€€æ”»å‡»ï¼‰</li>
</ul>
<p>æ¬ºéª—æœåŠ¡å™¨ä½¿ç”¨ä½ç‰ˆæœ¬çš„ä¸å®‰å…¨çš„TLSåè®®ï¼Œå¸¸å’Œå…¶ä»–æ”»å‡»æ‰‹æ®µç»“åˆä½¿ç”¨ã€‚åˆ é™¤åå‘å…¼å®¹æ€§é€šå¸¸æ˜¯é˜²æ­¢é™ä½æ”»å‡»çš„å”¯ä¸€æ–¹æ³•ã€‚</p>
<h2 id="å‰å‘å®‰å…¨æ€§"><a href="#å‰å‘å®‰å…¨æ€§" class="headerlink" title="å‰å‘å®‰å…¨æ€§"></a>å‰å‘å®‰å…¨æ€§</h2><p>å¦‚æœæ²¡æœ‰å‰å‘å®‰å…¨æ€§ï¼Œä¸€æ—¦ç§é’¥æ³„æ¼ï¼Œä¸ä»…å°†æ¥çš„ä¼šè¯ä¼šå—å½±å“ï¼Œè¿‡å»çš„ä¼šè¯ä¹Ÿéƒ½ä¼šå—å½±å“ã€‚ä¸€ä¸ªè€å¿ƒçš„é»‘å®¢ï¼Œå¯ä»¥å…ˆæŠŠä»¥å‰æˆªè·çš„æ•°æ®å…ˆä¿å­˜ä¸‹æ¥ï¼Œä¸€æ—¦ç§é’¥æ³„éœ²æˆ–è¢«ç ´è§£ï¼Œå°±å¯ä»¥ç ´è§£ä¹‹å‰çš„æ‰€æœ‰å¯†æ–‡ã€‚è¿™å°±æ˜¯æ‰€è°“çš„<strong>ä»Šæ—¥æˆªè·ï¼Œæ˜æ—¥ç ´è§£</strong>ã€‚</p>
<p>TLSçš„å®ç°ä¹‹ä¸€å°±æ˜¯é€šè¿‡ä½¿ç”¨ä¸´æ—¶çš„DHå¯†é’¥äº¤æ¢æ¥ç”Ÿæˆä¼šè¯å¯†é’¥ï¼Œ<strong>ä¸€æ¬¡ä¸€å¯†</strong>ä¿è¯äº†å³ä½¿é»‘å®¢èŠ±å¤§åŠ›æ°”ç ´è§£äº†è¿™ä¸€æ¬¡çš„ä¼šè¯å¯†é’¥ï¼Œä¹Ÿåªæ˜¯è¿™æ¬¡é€šä¿¡è¢«æ”»å‡»ï¼Œä¹‹å‰çš„å†å²æ¶ˆæ¯ä¸ä¼šå—åˆ°å½±å“ã€‚è¿™æˆ‘ä»¬å·²ç»åœ¨ç¬¬ä¸€éƒ¨åˆ†ä¸­è®²åˆ°äº†ã€‚</p>
<p>ä½†å³ä½¿æ˜¯ä½¿ç”¨äº†ä¸´æ—¶DHå¯†é’¥äº¤æ¢ï¼ŒæœåŠ¡ç«¯çš„sessionç®¡ç†æœºåˆ¶ä¹Ÿä¼šå½±å“åˆ°å‰å‘å®‰å…¨æ€§ã€‚å‰é¢Sessioné‡ç”¨çš„éƒ¨åˆ†æˆ‘ä»¬è®²åˆ°äº†session ticketï¼Œå®ƒçš„ä¿æŠ¤å®Œå…¨æ˜¯ä¾èµ–äºå¯¹ç§°åŠ å¯†ï¼Œæ‰€ä»¥é•¿æ—¶é—´æœ‰æ•ˆçš„session ticketå¯†é’¥ä¼šé˜»æ­¢å‰å‘å®‰å…¨æ€§çš„å®ç°ã€‚</p>
<p>åœ¨å®è·µä¸­ï¼Œåº”è¯¥ä¼˜å…ˆä½¿ç”¨ä¸´æ—¶DHå¯†é’¥äº¤æ¢ç±»ç®—æ³•å¥—ä»¶ï¼Œsessionçš„æœ‰æ•ˆæœŸä¸å®œè®¾ç½®è¿‡é•¿ï¼Œsession ticketçš„keyä¹Ÿåº”è¯¥ç»å¸¸æ›´æ¢ã€‚</p>
<h1 id="TLS-1-3æ–°ç‰¹æ€§"><a href="#TLS-1-3æ–°ç‰¹æ€§" class="headerlink" title="TLS 1.3æ–°ç‰¹æ€§"></a>TLS 1.3æ–°ç‰¹æ€§</h1><p>TLS 1.3ç›¸æ¯”TLS 1.2æ”¹åŠ¨å·¨å¤§ï¼Œå®ƒçš„ä¸»è¦æ”¹è¿›ç›®æ ‡æ˜¯<strong>æœ€å¤§å…¼å®¹</strong>ã€<strong>å¼ºåŒ–å®‰å…¨</strong>ã€<strong>æå‡æ€§èƒ½</strong>ã€‚</p>
<p>ä¸‹é¢åˆ—ä¸¾äº†ç›¸æ¯”TLS 1.3çš„<strong>ä¸»è¦å·®å¼‚</strong>ï¼š</p>
<ul>
<li>å¯¹ç§°åŠ å¯†ç®—æ³•åªä¿ç•™äº†AEADç±»ç®—æ³•ï¼Œå°†å¯†é’¥äº¤æ¢å’Œè®¤è¯ç®—æ³•ä»ç®—æ³•å¥—ä»¶çš„æ¦‚å¿µä¸­åˆ†ç¦»å‡ºå»äº†</li>
<li>å¢åŠ äº†0-RTTæ¨¡å¼</li>
<li>ç§»é™¤äº†é™æ€RSAå’ŒDHå¯†é’¥åå•†ï¼ˆç°åœ¨æ‰€æœ‰åŸºäºå…¬é’¥çš„å¯†é’¥äº¤æ¢éƒ½æä¾›äº†å‰å‘å®‰å…¨æ€§ï¼‰</li>
<li>ç°åœ¨æ‰€æœ‰çš„<code>ServerHello</code>åçš„æ¡æ‰‹æ¶ˆæ¯éƒ½æ˜¯åŠ å¯†çš„</li>
<li>å¯†é’¥æ´¾ç”Ÿå‡½æ•°é‡æ–°è®¾è®¡ï¼ŒKDFæ¢æˆäº†æ ‡å‡†çš„<code>HKDF</code></li>
<li>æ¡æ‰‹çŠ¶æ€æœºå¤§å¹…é‡æ„ï¼Œç æ‰äº†å¤šä½™çš„æ¶ˆæ¯å¦‚<code>ChangeCipherSpec</code></li>
<li>ä½¿ç”¨ç»Ÿä¸€çš„PSKæ¨¡å‹ï¼Œæ›¿ä»£äº†ä¹‹å‰çš„Session Resumptionï¼ˆåŒ…æ‹¬Session IDå’ŒSession Ticketï¼‰åŠæ—©æœŸTLSç‰ˆæœ¬åŸºäºPSKï¼ˆrfc4279ï¼‰çš„ç®—æ³•å¥—ä»¶</li>
</ul>
<p>è¿™é‡Œä»‹ç»å‡ ä¸ªå…³é”®çš„ç‰¹æ€§</p>
<h2 id="å¯†é’¥äº¤æ¢æ¨¡å¼"><a href="#å¯†é’¥äº¤æ¢æ¨¡å¼" class="headerlink" title="å¯†é’¥äº¤æ¢æ¨¡å¼"></a>å¯†é’¥äº¤æ¢æ¨¡å¼</h2><p>TLS 1.3æå‡ºäº†3ç§å¯†é’¥äº¤æ¢æ¨¡å¼ï¼š</p>
<ul>
<li>(EC)DHE</li>
<li>PSK-onlyï¼ˆpre-shared symmetric keyï¼‰</li>
<li>PSK with (EC)DHE å‰ä¸¤è€…çš„ç»“åˆï¼Œå…·æœ‰å‰å‘å®‰å…¨æ€§</li>
</ul>
<h2 id="1-RTTæ¡æ‰‹"><a href="#1-RTTæ¡æ‰‹" class="headerlink" title="1-RTTæ¡æ‰‹"></a>1-RTTæ¡æ‰‹</h2><p>å¦‚å‰æ‰€è¿°ï¼ŒTLS 1.2çš„å®Œæ•´æ¡æ‰‹æœ‰2ä¸ªRTTï¼Œç¬¬ä¸€ä¸ªRTTæ˜¯<code>ClientHello/ServerHello</code>ï¼Œç¬¬äºŒä¸ªRTTæ˜¯<code>ServerKeyExchange/ClientKeyExchange</code>ã€‚ä¹‹æ‰€ä»¥éœ€è¦ä¸¤ä¸ªRTTæ˜¯å› ä¸ºTLS 1.2æ”¯æŒå¤šç§å¯†é’¥äº¤æ¢ç®—æ³•åŠå„ç§ä¸åŒçš„å‚æ•°ï¼Œè¿™äº›éƒ½ä¾èµ–ç¬¬ä¸€ä¸ªRTTå»åå•†å‡ºæ¥ã€‚TLS 1.3ç›´æ¥å¤§åˆ€é˜”æ–§ï¼Œç æ‰äº†å„ç§è‡ªå®šä¹‰çš„groupã€curveï¼Œç æ‰äº†RSAå¯†é’¥äº¤æ¢ï¼Œåªå‰©ä¸‹ä¸ºæ•°ä¸å¤šçš„å‡ ä¸ªå¯†é’¥äº¤æ¢ç®—æ³•ï¼Œå®é™…åº”ç”¨ä¸­å¤§éƒ¨åˆ†ä½¿ç”¨<code>ECDH P-256</code>æˆ–<code>X25519</code>ã€‚æ‰€ä»¥å¹²è„†è®©å®¢æˆ·ç«¯ç¼“å­˜æœåŠ¡å™¨ä¸Šä¸€æ¬¡ç”¨çš„æ˜¯å•¥å¯†é’¥äº¤æ¢ç®—æ³•ï¼ŒæŠŠ<code>KeyExchange</code>ç›´æ¥åˆå…¥ç¬¬ä¸€ä¸ªRTTã€‚å¦‚æœæœåŠ¡å™¨å‘ç°å®¢æˆ·ç«¯å‘ä¸Šæ¥çš„ç®—æ³•ä¸å¯¹ï¼Œé‚£ä¹ˆå†å‘Šè¯‰å®ƒæ­£ç¡®çš„ï¼Œè®©å®¢æˆ·ç«¯é‡è¯•å°±å¥½äº†ã€‚ï¼ˆè¿™å°±å¼•å…¥äº†<code>HelloRetryRequest</code>æ¶ˆæ¯ï¼‰ã€‚è¿™æ ·åŸºæœ¬æ²¡æœ‰å‰¯ä½œç”¨ï¼Œå°±å¯ä»¥é™åˆ°1-RTTäº†ã€‚</p>
<p>TLS 1.3çš„å®Œæ•´æ¡æ‰‹æµç¨‹å¦‚ä¸‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">       Client                                           Server</span><br><span class="line"></span><br><span class="line">Key  ^ ClientHello</span><br><span class="line">Exch | + key_share*</span><br><span class="line">     | + signature_algorithms*</span><br><span class="line">     | + psk_key_exchange_modes*</span><br><span class="line">     v + pre_shared_key*       --------&gt;</span><br><span class="line">                                                  ServerHello  ^ Key</span><br><span class="line">                                                 + key_share*  | Exch</span><br><span class="line">                                            + pre_shared_key*  v</span><br><span class="line">                                        &#123;EncryptedExtensions&#125;  ^  Server</span><br><span class="line">                                        &#123;CertificateRequest*&#125;  v  Params</span><br><span class="line">                                               &#123;Certificate*&#125;  ^</span><br><span class="line">                                         &#123;CertificateVerify*&#125;  | Auth</span><br><span class="line">                                                   &#123;Finished&#125;  v</span><br><span class="line">                               &lt;--------  [Application Data*]</span><br><span class="line">     ^ &#123;Certificate*&#125;</span><br><span class="line">Auth | &#123;CertificateVerify*&#125;</span><br><span class="line">     v &#123;Finished&#125;              --------&gt;</span><br><span class="line">       [Application Data]      &lt;-------&gt;  [Application Data]</span><br><span class="line"></span><br><span class="line">              +  Indicates noteworthy extensions sent in the</span><br><span class="line">                 previously noted message.</span><br><span class="line"></span><br><span class="line">              *  Indicates optional or situation-dependent</span><br><span class="line">                 messages/extensions that are not always sent.</span><br><span class="line"></span><br><span class="line">              &#123;&#125; Indicates messages protected using keys</span><br><span class="line">                 derived from a [sender]_handshake_traffic_secret.</span><br><span class="line"></span><br><span class="line">              [] Indicates messages protected using keys</span><br><span class="line">                 derived from [sender]_application_traffic_secret_N.</span><br><span class="line"></span><br><span class="line">               Figure 1: Message Flow for Full TLS Handshake</span><br></pre></td></tr></table></figure>

<p>æ¡æ‰‹è¿‡ç¨‹å¯ä»¥åˆ†æˆä¸‰ä¸ªé˜¶æ®µï¼š</p>
<ul>
<li>å¯†é’¥äº¤æ¢ï¼šå»ºç«‹å…±äº«å¯†é’¥ææ–™ï¼Œé€‰æ‹©åŠ å¯†å‚æ•°ã€‚æ­¤é˜¶æ®µåçš„æ‰€æœ‰ä¿¡æ¯éƒ½æ˜¯åŠ å¯†çš„ã€‚</li>
<li>æœåŠ¡ç«¯å‚æ•°ï¼šå»ºç«‹å…¶ä»–æ¡æ‰‹å‚æ•°ï¼Œå¦‚å®¢æˆ·ç«¯æ˜¯å¦éœ€è¦è®¤è¯ã€åº”ç”¨å±‚åè®®æ”¯æŒ</li>
<li>è®¤è¯ï¼šèº«ä»½è®¤è¯ï¼Œæä¾›å¯†é’¥ç¡®è®¤å’Œæ¡æ‰‹å®Œæ•´æ€§</li>
</ul>
<h2 id="é‡ç”¨å’ŒPSK"><a href="#é‡ç”¨å’ŒPSK" class="headerlink" title="é‡ç”¨å’ŒPSK"></a>é‡ç”¨å’ŒPSK</h2><p>TLSçš„PSKå¯ä»¥ç›´æ¥åœ¨å¸¦å¤–å»ºç«‹ï¼Œä¹Ÿå¯ä»¥é€šè¿‡å‰ä¸€ä¸ªè¿æ¥çš„ä¼šè¯å»ºç«‹ã€‚ä¸€æ—¦ä¸€ä¸ªæ¡æ‰‹å®Œæˆäº†ä¹‹åï¼ŒæœåŠ¡ç«¯å°±ä¼šç»™å®¢æˆ·ç«¯å‘é€ä¸€ä¸ªPSK idï¼Œå¯¹åº”åˆå§‹æ¡æ‰‹æ¨å¯¼å‡ºçš„å¯†é’¥ã€‚ï¼ˆå¯¹åº”TLS 1.2åŠä¹‹å‰ç‰ˆæœ¬çš„Session IDå’ŒSession Ticketsï¼Œè¿™ä¸¤ä¸ªæœºåˆ¶åœ¨TLS 1.3ä¸­éƒ½å¼ƒç”¨äº†ï¼‰ã€‚</p>
<p>PSKå¯ä»¥å•ç‹¬ä½¿ç”¨ï¼Œæˆ–è€…è·Ÿ(EC)DHEå¯†é’¥äº¤æ¢ç»“åˆä½¿ç”¨ä»¥æä¾›å‰å‘å®‰å…¨æ€§ã€‚</p>
<p>é‡ç”¨å’ŒPSKçš„æ¡æ‰‹æµç¨‹å¦‚ä¸‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">       Client                                               Server</span><br><span class="line"></span><br><span class="line">Initial Handshake:</span><br><span class="line">       ClientHello</span><br><span class="line">       + key_share               --------&gt;</span><br><span class="line">                                                       ServerHello</span><br><span class="line">                                                       + key_share</span><br><span class="line">                                             &#123;EncryptedExtensions&#125;</span><br><span class="line">                                             &#123;CertificateRequest*&#125;</span><br><span class="line">                                                    &#123;Certificate*&#125;</span><br><span class="line">                                              &#123;CertificateVerify*&#125;</span><br><span class="line">                                                        &#123;Finished&#125;</span><br><span class="line">                                 &lt;--------     [Application Data*]</span><br><span class="line">       &#123;Certificate*&#125;</span><br><span class="line">       &#123;CertificateVerify*&#125;</span><br><span class="line">       &#123;Finished&#125;                --------&gt;</span><br><span class="line">                                 &lt;--------      [NewSessionTicket]</span><br><span class="line">       [Application Data]        &lt;-------&gt;      [Application Data]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Subsequent Handshake:</span><br><span class="line">       ClientHello</span><br><span class="line">       + key_share*</span><br><span class="line">       + pre_shared_key          --------&gt;</span><br><span class="line">                                                       ServerHello</span><br><span class="line">                                                  + pre_shared_key</span><br><span class="line">                                                      + key_share*</span><br><span class="line">                                             &#123;EncryptedExtensions&#125;</span><br><span class="line">                                                        &#123;Finished&#125;</span><br><span class="line">                                 &lt;--------     [Application Data*]</span><br><span class="line">       &#123;Finished&#125;                --------&gt;</span><br><span class="line">       [Application Data]        &lt;-------&gt;      [Application Data]</span><br><span class="line"></span><br><span class="line">            Figure 3: Message Flow for Resumption and PSK</span><br></pre></td></tr></table></figure>

<p>è¿™ç§æƒ…å†µä¸‹æœåŠ¡ç«¯çš„èº«ä»½é€šè¿‡PSKè®¤è¯ï¼Œæ‰€ä»¥æœåŠ¡ç«¯ä¸å‘é€<code>Certficate</code>å’Œ<code>CertificateVerify</code>æ¶ˆæ¯ã€‚å½“å®¢æˆ·ç«¯é€šè¿‡PSKæè®®é‡ç”¨çš„æ—¶å€™ï¼Œä¹Ÿåº”è¯¥æä¾›<code>key_share</code>æ‰©å±•ï¼Œä»¥ä¾¿æœåŠ¡ç«¯åœ¨æ‹’ç»é‡ç”¨çš„æ—¶å€™å›é€€åˆ°å…¨æ¡æ‰‹ã€‚</p>
<h2 id="æœ‰å‰¯ä½œç”¨çš„0-RTTæ¡æ‰‹"><a href="#æœ‰å‰¯ä½œç”¨çš„0-RTTæ¡æ‰‹" class="headerlink" title="æœ‰å‰¯ä½œç”¨çš„0-RTTæ¡æ‰‹"></a>æœ‰å‰¯ä½œç”¨çš„0-RTTæ¡æ‰‹</h2><p>å½“å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯å…±äº«ä¸€ä¸ªPSKçš„æ—¶å€™ï¼ˆæ— è®ºæ˜¯é€šè¿‡å¤–éƒ¨è·å¾—è¿˜æ˜¯é€šè¿‡å‰é¢çš„æ¡æ‰‹è·å¾—ï¼‰ï¼ŒTLS 1.3å…è®¸å®¢æˆ·ç«¯åœ¨ç¬¬ä¸€ä¸ªflightä¸Šå°±å‘é€æ•°æ®ï¼ˆearly dataï¼‰ã€‚å®¢æˆ·ç«¯ä½¿ç”¨PSKæ¥è®¤è¯æœåŠ¡ç«¯åŠåŠ å¯†early dataã€‚</p>
<p>0-RTTçš„æ¡æ‰‹æµç¨‹å¦‚ä¸‹ï¼Œä¸PSKé‡ç”¨çš„1-RTTæ¡æ‰‹ç›¸æ¯”ï¼Œå¢åŠ <code>early_data</code>æ‰©å±•ä»¥åŠç¬¬ä¸€ä¸ªflightä¸Šçš„0-RTTåº”ç”¨æ•°æ®ã€‚å½“æ¥æ”¶åˆ°æœåŠ¡ç«¯çš„<code>Finished</code>æ¶ˆæ¯ä¹‹åï¼Œä¼šå‘é€ä¸€ä¸ª<code>EndOfEarlyData</code>æ¶ˆæ¯æŒ‡ç¤ºåé¢åŠ å¯†å¯†é’¥çš„æ›´æ¢ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Client                                               Server</span><br><span class="line"></span><br><span class="line">ClientHello</span><br><span class="line">+ early_data</span><br><span class="line">+ key_share*</span><br><span class="line">+ psk_key_exchange_modes</span><br><span class="line">+ pre_shared_key</span><br><span class="line">(Application Data*)     --------&gt;</span><br><span class="line">                                                ServerHello</span><br><span class="line">                                           + pre_shared_key</span><br><span class="line">                                               + key_share*</span><br><span class="line">                                      &#123;EncryptedExtensions&#125;</span><br><span class="line">                                              + early_data*</span><br><span class="line">                                                 &#123;Finished&#125;</span><br><span class="line">                        &lt;--------       [Application Data*]</span><br><span class="line">(EndOfEarlyData)</span><br><span class="line">&#123;Finished&#125;              --------&gt;</span><br><span class="line">[Application Data]      &lt;-------&gt;        [Application Data]</span><br><span class="line"></span><br><span class="line">      +  Indicates noteworthy extensions sent in the</span><br><span class="line">         previously noted message.</span><br><span class="line"></span><br><span class="line">      *  Indicates optional or situation-dependent</span><br><span class="line">         messages/extensions that are not always sent.</span><br><span class="line"></span><br><span class="line">      () Indicates messages protected using keys</span><br><span class="line">         derived from a client_early_traffic_secret.</span><br><span class="line"></span><br><span class="line">      &#123;&#125; Indicates messages protected using keys</span><br><span class="line">         derived from a [sender]_handshake_traffic_secret.</span><br><span class="line"></span><br><span class="line">      [] Indicates messages protected using keys</span><br><span class="line">         derived from [sender]_application_traffic_secret_N.</span><br><span class="line"></span><br><span class="line">      Figure 4: Message Flow for a 0-RTT Handshake</span><br></pre></td></tr></table></figure>

<p>0-RTTçš„æ•°æ®å®‰å…¨æ€§è¾ƒå¼±ï¼š</p>
<ul>
<li>0-RTTæ•°æ®æ²¡æœ‰å‰å‘å®‰å…¨æ€§ï¼Œå› ä¸ºå…¶åŠ å¯†å¯†é’¥å•çº¯æ˜¯ä»PSKæ¨å¯¼å‡ºæ¥çš„</li>
<li>è·¨è¿æ¥å¯ä»¥é‡æ”¾0-RTTé‡Œçš„åº”ç”¨æ•°æ®ï¼ˆå¸¸è§„çš„TLS 1.3 1-RTTæ•°æ®é€šè¿‡æœåŠ¡ç«¯éšæœºæ•°æ¥é˜²é‡æ”¾ï¼‰</li>
</ul>
<h2 id="å¯†é’¥æ´¾ç”Ÿè¿‡ç¨‹"><a href="#å¯†é’¥æ´¾ç”Ÿè¿‡ç¨‹" class="headerlink" title="å¯†é’¥æ´¾ç”Ÿè¿‡ç¨‹"></a>å¯†é’¥æ´¾ç”Ÿè¿‡ç¨‹</h2><p>å¯†é’¥æ´¾ç”Ÿè¿‡ç¨‹ç”¨åˆ°äº†HKDF-Extractå’ŒHKDF-Expandå‡½æ•°ï¼Œä»¥åŠå¦‚ä¸‹çš„å‡½æ•°</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">HKDF-Expand-Label(Secret, Label, Context, Length) =</span><br><span class="line">      HKDF-Expand(Secret, HkdfLabel, Length)</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­<code>HkdfLabel</code>è¡¨ç¤º</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">struct &#123;</span><br><span class="line">  uint16 length = Length;</span><br><span class="line">  opaque label&lt;7..255&gt; = &quot;tls13 &quot; + Label;</span><br><span class="line">  opaque context&lt;0..255&gt; = Context;</span><br><span class="line">&#125; HkdfLabel;</span><br><span class="line"></span><br><span class="line">Derive-Secret(Secret, Label, Messages) = HKDF-Expand-Label(</span><br><span class="line">  Secret, Label, Transcript-Hash(Messages), Hash.length)</span><br></pre></td></tr></table></figure>



<p>ä¸ç®¡æ˜¯å“ªç§å¯†é’¥äº¤æ¢æ¨¡å¼éƒ½ç»™èµ°å®Œä¸‹é¢çš„æ•´ä¸ªæµç¨‹ï¼Œå½“æ²¡æœ‰å¯¹åº”çš„è¾“å…¥å¯†é’¥ææ–™ï¼ˆIKMï¼‰ï¼Œå¯¹åº”çš„ä½ç½®ç”¨Hashé•¿åº¦çš„0å€¼å­—ç¬¦ä¸²ä»£æ›¿ã€‚ä¾‹å¦‚æ²¡æœ‰PSKçš„è¯ï¼ŒEarly Secretå°±æ˜¯<code>HKDF-Extract(0, 0)</code>ã€‚</p>
<p><img src="https://cdn.jsdelivr.net/gh/catbro666/catbro666.github.io/posts/e92ef4b4/TLS1_3-Key-Schedule.png" alt="TLS1_3-Key-Schedule" loading="lazy"></p>
<p>å…¶ä¸­<code>exporter_secret</code>æ˜¯å¯¼å‡ºå¯†é’¥ï¼Œç”¨äºç”¨æˆ·è‡ªå®šä¹‰çš„å…¶ä»–ç”¨é€”ã€‚<code>resumption_master_secret</code>ç”¨äºç”Ÿæˆticketã€‚<code>client_early_traffic_secret</code>ç”¨äºæ¨å¯¼0-RTTçš„early-dataå¯†é’¥ï¼Œ<code>*_handshake_traffic_secret</code>ç”¨äºæ¨åˆ°æ¡æ‰‹æ¶ˆæ¯çš„åŠ å¯†å¯†é’¥ï¼Œ<code>*_application_traffic_secret_N</code>ç”¨äºæ¨å¯¼åº”ç”¨æ¶ˆæ¯çš„åŠ å¯†å¯†é’¥ã€‚</p>
<h1 id="å¸¸è§å®ç°"><a href="#å¸¸è§å®ç°" class="headerlink" title="å¸¸è§å®ç°"></a>å¸¸è§å®ç°</h1><p>OpenSSLï¼šéå¸¸æµè¡Œçš„å¼€æºå®ç°ã€ä»£ç é‡æœ€å¤§ã€å†™å¾—æœ€çƒ‚ï¼Ÿ</p>
<p>LibreSSLï¼šä¹Ÿæ˜¯OpenSSLçš„ä¸€ä¸ªforkï¼ŒOpenBSDé¡¹ç›®</p>
<p>BoringSSLï¼šæ˜¯OpenSSLçš„ä¸€ä¸ªforkåˆ†æ”¯ï¼Œä¸»è¦ç”¨äºGoogleçš„Chrome&#x2F;Chromiumã€Androidä»¥åŠå…¶ä»–åº”ç”¨</p>
<p>JSSEï¼ˆJava Secure Socket Extensionï¼‰ï¼šJavaå®ç°</p>
<p>NSSï¼šæœ€åˆç”±ç½‘æ™¯å¼€å‘çš„åº“ï¼Œç°åœ¨ä¸»è¦è¢«æµè§ˆå™¨å’Œå®¢æˆ·ç«¯è½¯ä»¶ä½¿ç”¨ï¼Œæ¯”å¦‚Firefoxä½¿ç”¨çš„å°±æ˜¯NSSåº“ï¼ˆMozillaå¼€å‘ï¼‰ã€‚</p>
<p>go.cryptoï¼šGoè¯­è¨€çš„å®ç°</p>
<h1 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h1><ul>
<li><a href="https://introspelliam.github.io/2018/03/20/crypto/%E6%B7%B1%E5%BA%A6%E8%A7%A3%E8%AF%BBSSL-TLS%E5%AE%9E%E7%8E%B0/">æ·±åº¦è§£è¯»SSL&#x2F;TLSå®ç°</a></li>
<li><a href="https://blog.helong.info/blog/2015/09/07/tls-protocol-analysis-and-crypto-protocol-design/#1-%E8%87%AA%E9%A1%B6%E5%90%91%E4%B8%8B%E5%88%86%E5%B1%82%E6%8A%BD%E8%B1%A1">TLSåè®®åˆ†æ</a></li>
<li><a href="https://juejin.cn/post/6844903624640823310#heading-5">å®Œå…¨åƒé€</a></li>
<li><a href="https://blog.cloudflare.com/keyless-ssl-the-nitty-gritty-technical-details/">Keyless SSL</a></li>
<li><a href="https://en.wikipedia.org/wiki/Transport_Layer_Security">wiki-Transport_Layer_Security</a></li>
<li><a href="https://hpbn.co/transport-layer-security-tls/">Transport Layer Security</a></li>
<li><a href="https://www.crypto101.io/">Crypto101</a></li>
<li><a href="https://xiaoxueying.gitbooks.io/graphic-cryptology/content/index.html">graphic-cryptology</a></li>
<li><a href="http://www.ruanyifeng.com/blog/2013/06/rsa_algorithm_part_one.html">RSAç®—æ³•åŸç†</a></li>
<li><a href="https://www.pediy.com/kssd/pediy06/pediy6014.htm">ECCåŠ å¯†ç®—æ³•å…¥é—¨</a></li>
<li><a href="https://datatracker.ietf.org/doc/html/rfc5246">TLS1.2-rfc5246</a></li>
<li><a href="https://datatracker.ietf.org/doc/html/rfc8446">TLS1.3-rfc8446</a></li>
<li><a href="https://en.wikipedia.org/wiki/OCSP_stapling">OCSP_stapling</a></li>
<li><a href="http://drops.xmd5.com/static/drops/tips-4403.html">å¸¸è§HTTPSæ”»å‡»æ–¹æ³•</a></li>
</ul>
]]></content>
      <categories>
        <category>åŠ å¯†ä¸å®‰å…¨</category>
      </categories>
      <tags>
        <tag>SSL/TLS</tag>
        <tag>å¯†ç å­¦</tag>
      </tags>
  </entry>
  <entry>
    <title>å¦‚ä½•ç¼–å†™ä¸€ä¸ªå¤šè¿›ç¨‹æ€§èƒ½æµ‹è¯•ç¨‹åº</title>
    <url>/posts/e416d910/</url>
    <content><![CDATA[<div class="note primary">
            <p>åœ¨å·¥ä½œä¸­ç»å¸¸ç¢°åˆ°éœ€è¦å†™ä¸€äº›å¤šè¿›ç¨‹&#x2F;å¤šçº¿ç¨‹çš„æµ‹è¯•ç¨‹åºï¼Œç”¨æ¥æµ‹è¯•æ¥å£çš„æ€§èƒ½ã€‚æœ¬æ–‡å°†ä¼šä»é›¶å¼€å§‹ä¸€ç‚¹ç‚¹å¢åŠ ä»£ç ï¼Œæœ€ç»ˆå®Œæˆä¸€ä¸ªç®€æ˜“çš„å¤šè¿›ç¨‹æµ‹è¯•ç¨‹åºç¼–å†™ã€‚è¯¥ç¨‹åºæ”¯æŒå®æ—¶æ‰“å°æµ‹è¯•è¿›ç»“æœå’Œæœ€ç»ˆæµ‹è¯•ç»“æœçš„ç»Ÿè®¡ã€‚</p><p>åŒæ—¶ï¼Œæœ¬æ–‡è¿˜æ¶µç›–äº†ä»¥ä¸‹çŸ¥è¯†ç‚¹ï¼Œå¯ä»¥ä½œä¸ºå­¦ä¹ å‚è€ƒï¼š</p><ul><li>ä½¿ç”¨<code>getopt_long()</code>å¤„ç†å‘½ä»¤è¡Œé€‰é¡¹å’Œå‚æ•°</li><li>ä½¿ç”¨<code>fork()</code>å’Œ<code>wait()</code>å¤„ç†å¤šè¿›ç¨‹</li><li>ä½¿ç”¨<code>sigaction()</code>é…åˆ<code>alarm()</code>å¤„ç†å®šæ—¶ä¿¡å·<code>SIGALRM</code></li><li>ä½¿ç”¨<code>shmget()</code>ã€<code>shmat()</code>ã€<code>shmdt()</code>ã€<code>shmctl()</code>ç­‰é€šè¿‡å…±äº«å†…å­˜è¿›è¡Œè¿›ç¨‹é—´é€šä¿¡</li><li>ä½¿ç”¨<code>sigaction()</code>æ•è·<code>SIGINT</code>å’Œ<code>SIGQUIT</code>ä¿¡å·ï¼Œåœ¨ç¨‹åºç»ˆæ­¢å‰åšå…±äº«å†…å­˜æ¸…ç†å·¥ä½œ</li></ul>
          </div>

<span id="more"></span>

<p>æœ¬æ–‡æºç å·²å¼€æº<a href="https://github.com/catbro666/multi-process-test-demo">Github</a></p>
<h1 id="é€‰é¡¹å’Œå‚æ•°çš„å¤„ç†"><a href="#é€‰é¡¹å’Œå‚æ•°çš„å¤„ç†" class="headerlink" title="é€‰é¡¹å’Œå‚æ•°çš„å¤„ç†"></a>é€‰é¡¹å’Œå‚æ•°çš„å¤„ç†</h1><p>ä¸ºäº†ä½¿æµ‹è¯•ç¨‹åºæ›´é«˜çš„å¯ç”¨æ€§ï¼Œæˆ‘ä»¬<code>getopt</code>æ¥å¤„ç†é€‰é¡¹å’Œå‚æ•°ã€‚</p>
<div><div class="fold_hider"><div class="close hider_title">ç‚¹å‡»å±•å¼€ä»£ç </div></div><div class="fold">
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span>      <span class="comment">// printf</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;getopt.h&gt;</span>     <span class="comment">// getopt_long</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span>     <span class="comment">// strtol, abort</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;limits.h&gt;</span>     <span class="comment">// LONG_MIN, LONG_MAX</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">ShowHelpInfo</span><span class="params">(<span class="keyword">char</span> *name)</span> </span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Usage: %s [options]\n\n&quot;</span>, name);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;  Options:\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;    -p/--proc         Number of processes (default: 1)\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;    -d/--duration     Duration of test (unit: s, default: 10)\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;    -h/--help         Show the help info\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;  Example:\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;    %s -p 4 -d 30\n&quot;</span>, name);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> c = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> option_index = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">long</span> procs = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">long</span> duration = <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *  å®šä¹‰å‘½ä»¤è¡Œå‚æ•°åˆ—è¡¨ï¼Œoptionç»“æ„çš„å«ä¹‰å¦‚ä¸‹ï¼ˆè¯¦è§ man 3 getoptï¼‰ï¼š</span></span><br><span class="line"><span class="comment">     *  struct option &#123;</span></span><br><span class="line"><span class="comment">     *      const char *name;       // å‚æ•°çš„å®Œæ•´åç§°ï¼Œå¯¹åº”å‘½ä»¤ä¸­çš„ --xxx</span></span><br><span class="line"><span class="comment">     *      int  has_arg;           // è¯¥å‚æ•°æ˜¯å¦å¸¦æœ‰ä¸€ä¸ªå€¼ï¼Œå¦‚ â€“-config xxx.conf</span></span><br><span class="line"><span class="comment">     *      int *flag;              // ä¸€èˆ¬è®¾ç½®ä¸ºNULL</span></span><br><span class="line"><span class="comment">     *      int  val;               // è§£æåˆ°è¯¥å‚æ•°ågetopt_longå‡½æ•°çš„è¿”å›å€¼ï¼Œ</span></span><br><span class="line"><span class="comment">     *                      // ä¸ºäº†æ–¹ä¾¿ç»´æŠ¤ï¼Œä¸€èˆ¬å¯¹åº”getopt_longè°ƒç”¨æ—¶ç¬¬ä¸‰ä¸ªå‚æ•°</span></span><br><span class="line"><span class="comment">     *  &#125;;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">option</span> <span class="title">arg_options</span>[] =</span></span><br><span class="line">    &#123;</span><br><span class="line">        &#123;<span class="string">&quot;proc&quot;</span>, <span class="number">1</span>, <span class="literal">NULL</span>, <span class="string">&#x27;p&#x27;</span>&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;duration&quot;</span>, <span class="number">1</span>, <span class="literal">NULL</span>, <span class="string">&#x27;d&#x27;</span>&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;help&quot;</span>, <span class="number">0</span>, <span class="literal">NULL</span>, <span class="string">&#x27;h&#x27;</span>&#125;,</span><br><span class="line">        &#123;<span class="literal">NULL</span>, <span class="number">0</span>, <span class="literal">NULL</span>, <span class="number">0</span>&#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *  æ³¨æ„ï¼šä¼ é€’ç»™getopt_longçš„ç¬¬ä¸‰ä¸ªå‚æ•°å¯¹åº”äº†å‘½ä»¤è¡Œå‚æ•°çš„ç¼©å†™å½¢å¼ï¼Œå¦‚-hç­‰ï¼Œ</span></span><br><span class="line"><span class="comment">     *  å¦‚æœå­—ç¬¦åé¢å¸¦æœ‰å†’å·&quot;:&quot;ï¼Œåˆ™è¯´æ˜è¯¥å‚æ•°åè·Ÿä¸€ä¸ªå€¼ï¼Œå¦‚-c xxxxxx</span></span><br><span class="line"><span class="comment">     *  å¦‚æœå¼€å¤´æœ‰å†’å·&quot;:&quot;ï¼Œåˆ™å½“ä¸€ä¸ªé€‰é¡¹ç¼ºå°‘å‚æ•°æ—¶ï¼Œè¿”å›&quot;:&quot;ï¼Œå¦åˆ™ï¼Œè¿”å›&quot;?&quot;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">while</span> ((c = getopt_long(argc, argv, <span class="string">&quot;:p:d:h&quot;</span>, arg_options, &amp;option_index)</span><br><span class="line">            ) != <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="keyword">switch</span> (c) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;h&#x27;</span>:</span><br><span class="line">            ShowHelpInfo(argv[<span class="number">0</span>]);</span><br><span class="line">            <span class="comment">//fprintf(stdout,&quot;option is -%c, optarv is %s\n&quot;, c, optarg);</span></span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;p&#x27;</span>:</span><br><span class="line">            procs = strtol(optarg, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (procs == LONG_MIN || procs == LONG_MAX) &#123;</span><br><span class="line">                <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;The number of processes (%s) is overflow\n\n&quot;</span>,</span><br><span class="line">                        optarg);</span><br><span class="line">                ShowHelpInfo(argv[<span class="number">0</span>]);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (procs &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;The number of processes must be &gt; 0\n\n&quot;</span>);</span><br><span class="line">                ShowHelpInfo(argv[<span class="number">0</span>]);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;d&#x27;</span>:</span><br><span class="line">            duration = strtol(optarg, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (duration == LONG_MIN || duration == LONG_MAX) &#123;</span><br><span class="line">                <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;The duration of test (%s) is overflow\n\n&quot;</span>,</span><br><span class="line">                        optarg);</span><br><span class="line">                ShowHelpInfo(argv[<span class="number">0</span>]);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (procs &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;The duration of test must be &gt; 0\n\n&quot;</span>);</span><br><span class="line">                ShowHelpInfo(argv[<span class="number">0</span>]);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;?&#x27;</span>:</span><br><span class="line">            <span class="built_in">fprintf</span> (<span class="built_in">stderr</span>, <span class="string">&quot;Unknown option -%c\n\n&quot;</span>, optopt);</span><br><span class="line">            ShowHelpInfo(argv[<span class="number">0</span>]);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;:&#x27;</span>:</span><br><span class="line">           <span class="built_in">fprintf</span> (<span class="built_in">stderr</span>, <span class="string">&quot;Option -%c requires an argument\n\n&quot;</span>, optopt);</span><br><span class="line">           ShowHelpInfo(argv[<span class="number">0</span>]);</span><br><span class="line">           <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="built_in">abort</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;processes:  %ld\n&quot;</span>, procs);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;duration:   %lds\n&quot;</span>, duration);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n-----------------------------Start Testing----------------------&quot;</span></span><br><span class="line">           <span class="string">&quot;--------\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Hello world\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br></pre></td></tr></table></figure>

</div></div>



<div class="note info">
            <p>æ³¨æ„ï¼šä¼ é€’ç»™getopt_longçš„ç¬¬ä¸‰ä¸ªå‚æ•°å¯¹åº”äº†å‘½ä»¤è¡Œå‚æ•°çš„ç¼©å†™å½¢å¼ï¼Œå¦‚-h, -v, -cç­‰ã€‚</p><p>å¦‚æœå­—ç¬¦åé¢å¸¦æœ‰å†’å·â€:â€ï¼Œåˆ™è¯´æ˜è¯¥å‚æ•°åè·Ÿä¸€ä¸ªå€¼ï¼Œå¦‚-c xxxxxx</p><p>å¦‚æœå¼€å¤´æœ‰å†’å·â€:â€ï¼Œåˆ™å½“ä¸€ä¸ªé€‰é¡¹ç¼ºå°‘å‚æ•°æ—¶ï¼Œè¿”å›â€:â€ï¼Œå¦åˆ™ï¼Œè¿”å›â€?â€</p>
          </div>



<p><strong>æ•ˆæœå¦‚ä¸‹</strong>ï¼š</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">^_^$ make</span><br><span class="line">gcc <span class="string">&quot;-g&quot;</span> -c multi-process.c -o multi-process.o</span><br><span class="line">gcc  -o <span class="built_in">test</span> multi-process.o</span><br><span class="line"></span><br><span class="line">^_^$ ./<span class="built_in">test</span></span><br><span class="line">processes:  1</span><br><span class="line">duration:   10s</span><br><span class="line"></span><br><span class="line">-----------------------------Start Testing------------------------------</span><br><span class="line"></span><br><span class="line">Hello world</span><br></pre></td></tr></table></figure>



<p><strong>é€‰é¡¹æˆ–å‚æ•°é”™è¯¯æ—¶</strong>ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">^_^$ ./test -p</span><br><span class="line">Option -p requires an argument</span><br><span class="line"></span><br><span class="line">Usage: ./test [options]</span><br><span class="line"></span><br><span class="line">  Options:</span><br><span class="line">    -p/--proc         Number of processes (default: 1)</span><br><span class="line">    -d/--duration     Duration of test (unit: s, default: 10)</span><br><span class="line">    -h/--help         Show the help info</span><br><span class="line"></span><br><span class="line">  Example:</span><br><span class="line">    ./test -p 4 -d 30</span><br></pre></td></tr></table></figure>



<h1 id="å¢åŠ å¤šè¿›ç¨‹çš„æ”¯æŒ"><a href="#å¢åŠ å¤šè¿›ç¨‹çš„æ”¯æŒ" class="headerlink" title="å¢åŠ å¤šè¿›ç¨‹çš„æ”¯æŒ"></a>å¢åŠ å¤šè¿›ç¨‹çš„æ”¯æŒ</h1><p>ä¸»è¿›ç¨‹<code>fork</code>å‡ºnä¸ªå­è¿›ç¨‹å<code>wait</code>å­è¿›ç¨‹ï¼Œå­è¿›ç¨‹åˆ™é€šè¿‡<code>sigaction</code>å’Œ<code>alarm</code>è®¾ç½®ä¸€ä¸ªå®šæ—¶å™¨ï¼Œç„¶åè¿›è¡Œä¸šåŠ¡æµ‹è¯•ã€‚</p>
<p>ä¸ºäº†ç®€æ´ï¼Œå·²ç»æŠŠé€‰é¡¹å‚æ•°å¤„ç†çš„éƒ¨åˆ†ç‹¬ç«‹å‡ºå»äº†ã€‚</p>
<div><div class="fold_hider"><div class="close hider_title">ç‚¹å‡»å±•å¼€ä»£ç </div></div><div class="fold">
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span>      <span class="comment">// printf, fprintf</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span>   <span class="comment">// wait</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span>  <span class="comment">// getpid, wait</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span>     <span class="comment">// sigaction, SIGLARM</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;limits.h&gt;</span>     <span class="comment">// LONG_MIN, LONG_MAX, ULLONG_MAX</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span>     <span class="comment">// getpid</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span>     <span class="comment">// memset</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;multi-process.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> isStop = <span class="number">0</span>;             <span class="comment">// ç”¨äºæ ‡è®°æµ‹è¯•ç»ˆæ­¢</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">param_st</span> &#123;</span>   <span class="comment">// è‡ªå®šä¹‰æµ‹è¯•å‚æ•°</span></span><br><span class="line">    <span class="keyword">long</span> index;</span><br><span class="line">&#125; Param;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">handle_signal_child</span><span class="params">(<span class="keyword">int</span> sigNum)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (sigNum == SIGALRM) &#123;</span><br><span class="line">        isStop = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* å®é™…ä¸šåŠ¡æµ‹è¯•å‡½æ•° */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">doTest</span><span class="params">(<span class="keyword">void</span> *param)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> i = <span class="number">0</span>;</span><br><span class="line">    Param *pa = (Param *)param;</span><br><span class="line">    <span class="keyword">for</span>(; i &lt; ULLONG_MAX &amp;&amp; !isStop; ++i) &#123;</span><br><span class="line">        <span class="comment">/* DO YOUR WORK */</span></span><br><span class="line">        <span class="comment">/* DO YOUR WORK */</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;process [pid = %6u] result: %llu\n&quot;</span>, getpid(), i);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> rv = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">long</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> proc_index = <span class="number">0</span>;</span><br><span class="line">    Options opt;</span><br><span class="line">    <span class="keyword">int</span> isParent = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">int</span> wstatus = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">pid_t</span> pid = <span class="number">0</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sigaction</span> <span class="title">act_child</span>;</span></span><br><span class="line"></span><br><span class="line">    rv = process_options(argc, argv, &amp;opt);</span><br><span class="line">    <span class="keyword">if</span> (rv) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n-----------------------------Start Testing----------------------&quot;</span></span><br><span class="line">           <span class="string">&quot;--------\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* COMMON INIT */</span></span><br><span class="line">    <span class="comment">/* COMMON INIT */</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span>(isParent &amp;&amp; i &lt; opt.procs) &#123;</span><br><span class="line">        pid =  fork();</span><br><span class="line">        <span class="keyword">if</span>(pid == <span class="number">-1</span>) &#123;         <span class="comment">/* error */</span></span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;fork failed %d\n&quot;</span>, pid);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(pid == <span class="number">0</span>) &#123;     <span class="comment">/* child */</span></span><br><span class="line">            isParent = <span class="number">0</span>;</span><br><span class="line">            proc_index = i;     <span class="comment">// è®°å½•è¿›ç¨‹ç´¢å¼•</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;                  <span class="comment">/* parent */</span></span><br><span class="line">        &#125;</span><br><span class="line">        ++i;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(isParent) &#123;</span><br><span class="line">        <span class="comment">/* PARENT INIT */</span></span><br><span class="line">        <span class="comment">/* PARENT INIT */</span></span><br><span class="line">        <span class="keyword">for</span>(i =<span class="number">0</span> ; i &lt; opt.procs; ++i) &#123;</span><br><span class="line">            pid = wait(&amp;wstatus);                       <span class="comment">// ç­‰å¾…å­è¿›ç¨‹ç»“æŸ</span></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;process [pid = %6d] exit\n&quot;</span>, pid);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">/* CHILD INIT */</span></span><br><span class="line">        Param param;</span><br><span class="line">        <span class="built_in">memset</span>(&amp;param, <span class="number">0</span>, <span class="keyword">sizeof</span>(Param));</span><br><span class="line">        param.index = proc_index;</span><br><span class="line">        <span class="comment">/* CHILD INIT */</span></span><br><span class="line"></span><br><span class="line">        act_child.sa_handler = handle_signal_child;</span><br><span class="line">        sigemptyset(&amp;act_child.sa_mask);</span><br><span class="line">        act_child.sa_flags = SA_RESETHAND;</span><br><span class="line">        <span class="comment">/* ç”¨äºæµ‹è¯•æ—¶é—´åˆ°æ—¶ï¼Œé€šçŸ¥å­è¿›ç¨‹ç»“æŸæµ‹è¯• */</span></span><br><span class="line">        rv = sigaction(SIGALRM, &amp;act_child, <span class="literal">NULL</span>);</span><br><span class="line">        <span class="keyword">if</span> (rv) &#123;</span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;sigaction() failed\n&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//signal(SIGALRM, handle_signal_child);</span></span><br><span class="line">        alarm(opt.duration);                            <span class="comment">// è®¾ç½®æµ‹è¯•æ—¶é•¿</span></span><br><span class="line">        doTest(&amp;param);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;       <span class="comment">/* child finished work */</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Hello World!\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</div></div>



<p><strong>æ•ˆæœå¦‚ä¸‹</strong>ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">^_^$ ./test -p 4 -d 2</span><br><span class="line">processes:  4</span><br><span class="line">duration:   2s</span><br><span class="line"></span><br><span class="line">-----------------------------Start Testing------------------------------</span><br><span class="line"></span><br><span class="line">process [pid =  11942] result: 446930553</span><br><span class="line">process [pid =  11942] exit</span><br><span class="line">process [pid =  11939] result: 434385097</span><br><span class="line">process [pid =  11939] exit</span><br><span class="line">process [pid =  11940] result: 442246977</span><br><span class="line">process [pid =  11940] exit</span><br><span class="line">process [pid =  11941] result: 442418811</span><br><span class="line">process [pid =  11941] exit</span><br></pre></td></tr></table></figure>



<p>è¿™æ ·å·²ç»å¯ä»¥å®ç°ç®€å•çš„å¤šè¿›ç¨‹æµ‹è¯•ï¼Œç®€å•èµ·è§ï¼Œç¤ºä¾‹ä»£ç é‡Œåªæ˜¯ç®€å•åœ°è¿›è¡Œäº†è®¡æ•°æ“ä½œã€‚è¯»è€…å¦‚æœæƒ³è¦è¿›è¡Œè‡ªå·±ç‰¹å®šçš„æµ‹è¯•ï¼Œåªè¦åœ¨Paramä¸­å¢åŠ éœ€è¦çš„æµ‹è¯•å‚æ•°ï¼Œæ¥ç€åœ¨<code>/* CHILD INIT */</code>å¤„è¿›è¡Œå‚æ•°åˆå§‹åŒ–ï¼Œç„¶ååœ¨<code>/* DO YOUR WORK */</code>å¤„æ·»åŠ å®é™…çš„æµ‹è¯•é€»è¾‘å³å¯ã€‚</p>
<h1 id="å¢åŠ å®æ—¶çš„ç»“æœç»Ÿè®¡åŠæœ€ç»ˆçš„ç»“æœæ±‡æ€»"><a href="#å¢åŠ å®æ—¶çš„ç»“æœç»Ÿè®¡åŠæœ€ç»ˆçš„ç»“æœæ±‡æ€»" class="headerlink" title="å¢åŠ å®æ—¶çš„ç»“æœç»Ÿè®¡åŠæœ€ç»ˆçš„ç»“æœæ±‡æ€»"></a>å¢åŠ å®æ—¶çš„ç»“æœç»Ÿè®¡åŠæœ€ç»ˆçš„ç»“æœæ±‡æ€»</h1><p>ä¸ºäº†ä½¿æµ‹è¯•ç¨‹åºæ›´åŠ äººæ€§åŒ–ï¼Œä½¿å…¶å¯ä»¥å®æ—¶ç»Ÿè®¡æµ‹è¯•ç»“æœï¼Œç»“æŸæ—¶è‡ªåŠ¨è®¡ç®—æ€»çš„ç»“æœã€‚è¿™å°±éœ€è¦å¼•å…¥çˆ¶å­è¿›ç¨‹é—´é€šä¿¡ï¼Œæˆ‘ä»¬é€‰ç”¨å…±äº«å†…å­˜çš„æ–¹å¼æ¥å®ç°ã€‚ä¸ºäº†é¿å…è¿›ç¨‹é—´åŒæ­¥å¯¹æµ‹è¯•å¸¦æ¥çš„å½±å“ï¼Œåœ¨å…±äº«å†…å­˜ä¸­ä¸ºæ¯ä¸ªå­è¿›ç¨‹å¼€è¾Ÿäº†ä¸€ä¸ªç©ºé—´ï¼Œæ¯ä¸ªå­è¿›ç¨‹æ ¹æ®ç´¢å¼•åœ¨è‡ªå·±çš„ç©ºé—´é‡Œå†™æ•°æ®ï¼Œç”±çˆ¶è¿›ç¨‹è¿›è¡Œç»“æœçš„æ±‡æ€»ã€‚</p>
<div><div class="fold_hider"><div class="close hider_title">ç‚¹å‡»å±•å¼€ä»£ç </div></div><div class="fold">
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span>      <span class="comment">// printf, fprintf</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span>   <span class="comment">// wait</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span>  <span class="comment">// getpid, wait</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ipc.h&gt;</span>    <span class="comment">// shmget, shmat, shmctl, shmdt</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/shm.h&gt;</span>    <span class="comment">// shmget, shmat, shmctl, shmdt</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span>     <span class="comment">// sigaction, SIGLARM</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;limits.h&gt;</span>     <span class="comment">// LONG_MIN, LONG_MAX, ULLONG_MAX</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span>      <span class="comment">// errno</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span>     <span class="comment">// getpid</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span>     <span class="comment">// memset</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;multi-process.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">param_st</span> &#123;</span>   <span class="comment">// è‡ªå®šä¹‰æµ‹è¯•å‚æ•°</span></span><br><span class="line">    <span class="keyword">long</span> index;</span><br><span class="line">&#125; Param;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">result_st</span> &#123;</span>   <span class="comment">// è‡ªå®šä¹‰æµ‹è¯•ç»“æœ</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> count;</span><br><span class="line">&#125; Result;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> isStop = <span class="number">0</span>;             <span class="comment">// ç”¨äºæ ‡è®°æµ‹è¯•ç»ˆæ­¢</span></span><br><span class="line">Options opt;                <span class="comment">// å‘½ä»¤è¡Œé€‰é¡¹</span></span><br><span class="line"><span class="keyword">int</span> shmid;                  <span class="comment">// å…±äº«å†…å­˜id</span></span><br><span class="line">Result *shm = <span class="literal">NULL</span>;         <span class="comment">// å…±äº«å†…å­˜åœ°å€ï¼Œç”¨äºå­˜æ”¾æµ‹è¯•ç»“æœ</span></span><br><span class="line">Result res_total;</span><br><span class="line">Result res_last;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">handle_signal_child</span><span class="params">(<span class="keyword">int</span> sigNum)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (sigNum == SIGALRM) &#123;</span><br><span class="line">        isStop = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">handle_signal_parent</span><span class="params">(<span class="keyword">int</span> sigNum)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (sigNum == SIGALRM) &#123;</span><br><span class="line">        <span class="comment">/* DO REAL-TIME STATISTICS */</span></span><br><span class="line">        <span class="built_in">memset</span>(&amp;res_total, <span class="number">0</span>, <span class="keyword">sizeof</span>(Result));</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">long</span> i = <span class="number">0</span>; i &lt; opt.procs; ++i) &#123;</span><br><span class="line">            res_total.count += shm[i].count;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;total count %12llu,  average %12.0lf/s\n&quot;</span>,</span><br><span class="line">                res_total.count, (res_total.count - res_last.count)</span><br><span class="line">                / (<span class="keyword">double</span>)opt.interval);</span><br><span class="line">        <span class="built_in">memcpy</span>(&amp;res_last, &amp;res_total, <span class="keyword">sizeof</span>(Result));</span><br><span class="line">        <span class="comment">/* DO REAL-TIME STATISTICS */</span></span><br><span class="line">        alarm(opt.interval);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* å®é™…ä¸šåŠ¡æµ‹è¯•å‡½æ•° */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">doTest</span><span class="params">(<span class="keyword">void</span> *param)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> i = <span class="number">0</span>;</span><br><span class="line">    Param *pa = (Param *)param;</span><br><span class="line">    <span class="keyword">for</span> (; i &lt; ULLONG_MAX &amp;&amp; !isStop; ++i) &#123;</span><br><span class="line">        <span class="comment">/* DO YOUR WORK */</span></span><br><span class="line">        ++shm[pa-&gt;index].count;</span><br><span class="line">        <span class="comment">/* DO YOUR WORK */</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> rv = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">long</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> proc_index = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> isParent = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">int</span> wstatus = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">pid_t</span> pid = <span class="number">0</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sigaction</span> <span class="title">act_child</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sigaction</span> <span class="title">act_parent</span>;</span></span><br><span class="line"></span><br><span class="line">    rv = process_options(argc, argv, &amp;opt);</span><br><span class="line">    <span class="keyword">if</span> (rv) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;\n-----------------------------Start Testing-------------&quot;</span></span><br><span class="line">            <span class="string">&quot;-----------------\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* COMMON INIT */</span></span><br><span class="line">    shmid = shmget(IPC_PRIVATE, <span class="keyword">sizeof</span>(<span class="keyword">sizeof</span>(Result) * opt.procs), <span class="number">0666</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">-1</span> == shmid) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;shmget() failed\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;shmid = %d\n&quot;</span>, shmid);</span><br><span class="line">    shm = (Result*)shmat(shmid, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> ((<span class="keyword">void</span> *) <span class="number">-1</span> == shm) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;shmat() failed\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">memset</span>(shm, <span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="keyword">sizeof</span>(Result) * opt.procs));</span><br><span class="line">    <span class="comment">/* COMMON INIT */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(isParent &amp;&amp; i &lt; opt.procs) &#123;</span><br><span class="line">        pid =  fork();</span><br><span class="line">        <span class="keyword">if</span>(pid == <span class="number">-1</span>) &#123;         <span class="comment">/* error */</span></span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;fork failed %d\n&quot;</span>, pid);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(pid == <span class="number">0</span>) &#123;     <span class="comment">/* child */</span></span><br><span class="line">            isParent = <span class="number">0</span>;</span><br><span class="line">            proc_index = i;     <span class="comment">// è®°å½•è¿›ç¨‹ç´¢å¼•</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;                  <span class="comment">/* parent */</span></span><br><span class="line">        &#125;</span><br><span class="line">        ++i;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(isParent) &#123;</span><br><span class="line">        <span class="comment">/* PARENT INIT */</span></span><br><span class="line">        <span class="built_in">memset</span>(&amp;act_parent, <span class="number">0</span>, <span class="keyword">sizeof</span>(act_parent));</span><br><span class="line">        act_parent.sa_handler = handle_signal_parent;</span><br><span class="line">        <span class="comment">/* ä½¿waitè¢«ä¸­æ–­æ—¶å¯ä»¥è‡ªåŠ¨æ¢å¤ */</span></span><br><span class="line">        act_parent.sa_flags = SA_RESTART;</span><br><span class="line">        rv = sigaction(SIGALRM, &amp;act_parent, <span class="literal">NULL</span>);     <span class="comment">// ç”¨äºå®šæ—¶ç»Ÿè®¡ç»“æœ</span></span><br><span class="line">        <span class="comment">//signal(SIGALRM, handle_signal_parent);</span></span><br><span class="line">        <span class="keyword">if</span> (rv) &#123;</span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;sigaction() failed\n&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">memset</span>(&amp;res_last, <span class="number">0</span>, <span class="keyword">sizeof</span>(Result));</span><br><span class="line">        alarm(opt.interval);</span><br><span class="line">        <span class="comment">/* PARENT INIT */</span></span><br><span class="line">        <span class="comment">/* DO FINAL STATISTICS */</span></span><br><span class="line">        Result <span class="keyword">final</span>;</span><br><span class="line">        <span class="built_in">memset</span>(&amp;<span class="keyword">final</span>, <span class="number">0</span>, <span class="keyword">sizeof</span>(Result));</span><br><span class="line">        <span class="keyword">for</span>(i =<span class="number">0</span> ; i &lt; opt.procs; ++i) &#123;</span><br><span class="line">            pid = wait(&amp;wstatus);                       <span class="comment">// ç­‰å¾…å­è¿›ç¨‹ç»“æŸ</span></span><br><span class="line">            alarm(<span class="number">0</span>);                                   <span class="comment">// ç»ˆæ­¢å®šæ—¶å™¨</span></span><br><span class="line">            <span class="keyword">if</span>(pid == <span class="number">-1</span>) &#123;</span><br><span class="line">                <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;wait() failed, errno=%d\n&quot;</span>, errno);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;process [pid = %6d] exit\n&quot;</span>, pid);</span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;process [pid = %6u] count %12llu in %lus,  &quot;</span></span><br><span class="line">                    <span class="string">&quot;average %12.0lf/s\n&quot;</span>, pid, shm[i].count, opt.duration, </span><br><span class="line">                    shm[i].count / (<span class="keyword">double</span>)opt.duration);</span><br><span class="line">            <span class="keyword">final</span>.count += shm[i].count;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;total count %12llu in %lus,  average %12.0lf/s\n&quot;</span>,</span><br><span class="line">               <span class="keyword">final</span>.count, opt.duration, <span class="keyword">final</span>.count / (<span class="keyword">double</span>)opt.duration);</span><br><span class="line">        <span class="comment">/* DO FINAL STATISTICS */</span></span><br><span class="line">        shmdt((<span class="keyword">void</span>*)shm);</span><br><span class="line">        <span class="comment">/* å­è¿›ç¨‹é€€å‡ºä¹‹åè‡ªåŠ¨detachäº†, æ‰€ä»¥è¿™é‡Œä¸éœ€è¦é€šè¿‡IPC_STATè¿›è¡Œåˆ¤æ–­ */</span></span><br><span class="line">        shmctl(shmid, IPC_RMID, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">/* CHILD INIT */</span></span><br><span class="line">        Param param;</span><br><span class="line">        <span class="built_in">memset</span>(&amp;param, <span class="number">0</span>, <span class="keyword">sizeof</span>(Param));</span><br><span class="line">        param.index = proc_index;</span><br><span class="line">        <span class="comment">/* CHILD INIT */</span></span><br><span class="line"></span><br><span class="line">        act_child.sa_handler = handle_signal_child;</span><br><span class="line">        sigemptyset(&amp;act_child.sa_mask);</span><br><span class="line">        <span class="comment">//sigaddset(&amp;act_child.sa_mask, SIGQUIT);</span></span><br><span class="line">        <span class="comment">//sigaddset(&amp;act_child.sa_mask, SIGTERM);</span></span><br><span class="line">        act_child.sa_flags = SA_RESETHAND;</span><br><span class="line">        <span class="comment">/* ç”¨äºæµ‹è¯•æ—¶é—´åˆ°æ—¶ï¼Œé€šçŸ¥å­è¿›ç¨‹ç»“æŸæµ‹è¯• */</span></span><br><span class="line">        rv = sigaction(SIGALRM, &amp;act_child, <span class="literal">NULL</span>);</span><br><span class="line">        <span class="keyword">if</span> (rv) &#123;</span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;sigaction() failed\n&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//signal(SIGALRM, handle_signal_child);</span></span><br><span class="line">        alarm(opt.duration);                            <span class="comment">// è®¾ç½®æµ‹è¯•æ—¶é•¿</span></span><br><span class="line">        doTest(&amp;param);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;       <span class="comment">/* child finished work */</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</div></div>



<p><strong>æµ‹è¯•æ•ˆæœå¦‚ä¸‹</strong>ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">^_^$ ./test -p 4 -d 8 -i 1</span><br><span class="line">processes:  4</span><br><span class="line">duration:   8s</span><br><span class="line">interval:   1s</span><br><span class="line"></span><br><span class="line">-----------------------------Start Testing------------------------------</span><br><span class="line"></span><br><span class="line">shmid = 2654220</span><br><span class="line">total count    344235932,  average    344235932/s</span><br><span class="line">total count    679573681,  average    335337749/s</span><br><span class="line">total count   1026283924,  average    346710243/s</span><br><span class="line">total count   1368302354,  average    342018430/s</span><br><span class="line">total count   1708471662,  average    340169308/s</span><br><span class="line">total count   2057211138,  average    348739476/s</span><br><span class="line">total count   2398403059,  average    341191921/s</span><br><span class="line">process [pid =  25124] exit</span><br><span class="line">process [pid =  25124] count    688504473 in 8s,  average     86063059/s</span><br><span class="line">process [pid =  25123] exit</span><br><span class="line">process [pid =  25123] count    682379115 in 8s,  average     85297389/s</span><br><span class="line">process [pid =  25125] exit</span><br><span class="line">process [pid =  25125] count    682467102 in 8s,  average     85308388/s</span><br><span class="line">process [pid =  25126] exit</span><br><span class="line">process [pid =  25126] count    688159459 in 8s,  average     86019932/s</span><br><span class="line">total count   2741510149 in 8s,  average    342688769/s</span><br></pre></td></tr></table></figure>

<div class="note info">
            <p>è¿™é‡Œéœ€è¦ç‰¹åˆ«æä¸€ä¸‹<code>wait()</code>å’Œ<code>sigaction()</code>ç³»ç»Ÿè°ƒç”¨ï¼Œé»˜è®¤æƒ…å†µä¸‹<code>wait()</code>ä¼šé˜»å¡ç›´åˆ°æœ‰ä»»æ„ä¸€ä¸ªå­è¿›ç¨‹æ”¹å˜äº†å…¶çŠ¶æ€ï¼Œæˆ–è€…æœ‰ä¸€ä¸ªä¿¡å·å¤„ç†å‡½æ•°ä¸­æ–­äº†<code>wait()</code>è°ƒç”¨ã€‚æ‰€ä»¥æˆ‘ä»¬ç¨‹åºä¸­çš„<code>wait()</code>è°ƒç”¨å°±ä¼šè¢«è‡ªå·±çš„<code>SIGALRM</code>ä¿¡å·ä¸­æ–­ï¼Œè¿”å›<code>-1</code>åŒæ—¶<code>errno</code>ä¸º<code>EINTR</code>ã€‚è¿™æ ·æˆ‘ä»¬å°±éœ€è¦åœ¨<code>wait()</code>å¤–é¢åŠ ä¸€å±‚å¾ªç¯æ¥å¤„ç†<code>wait()</code>è¢«ä¿¡å·ä¸­æ–­çš„æƒ…å†µã€‚</p><p>é€šè¿‡åœ¨<code>sigaction()</code>æ—¶å¢åŠ <code>SA_RESTART</code>æ ‡å¿—ï¼Œè¢«ä¸­æ–­çš„ç³»ç»Ÿè°ƒç”¨å¯ä»¥è‡ªåŠ¨é‡å¼€ï¼Œä¹Ÿå°±çœå»äº†é‚£ä¸ªå¤–å±‚å¾ªç¯ã€‚å¦å¤–ï¼Œ<code>signal()</code>å°è£…äº†<code>sigaction()</code>ï¼Œå®ƒé‡Œé¢é»˜è®¤å°±æ˜¯è®¾ç½®äº†<code>SA_RESTART</code>ï¼Œä¸è¿‡é™¤éä½ æœ‰ç¡®åˆ‡çš„ç†ç”±ï¼Œä¸ç„¶ä¸å»ºè®®ä½¿ç”¨<code>signal()</code>äº†ã€‚</p>
          </div>

<h1 id="å¢åŠ SIGINTå’ŒSIGQUITä¿¡å·æ•è·"><a href="#å¢åŠ SIGINTå’ŒSIGQUITä¿¡å·æ•è·" class="headerlink" title="å¢åŠ SIGINTå’ŒSIGQUITä¿¡å·æ•è·"></a>å¢åŠ SIGINTå’ŒSIGQUITä¿¡å·æ•è·</h1><p>æˆªæ­¢ç›®å‰ï¼Œæˆ‘ä»¬å·²ç»å®Œæˆäº†å¤šè¿›ç¨‹çš„æµ‹è¯•åŠç»“æœç»Ÿè®¡ã€‚ä½†å…¶å®è¿˜æœ‰ä¸€ä¸ªæ½œåœ¨çš„é—®é¢˜ï¼Œåœ¨å®é™…æµ‹è¯•ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸ä¼šåœ¨æµ‹è¯•è¿˜æ²¡å®Œæˆæ—¶å°±æ‰‹åŠ¨<code>^C</code>ç»ˆæ­¢ç¨‹åºæ‰§è¡Œã€‚è¿™æ ·æˆ‘ä»¬åœ¨ç¨‹åºä¸­ç”³è¯·çš„å…±äº«å†…å­˜å°±ä¼šå¾—ä¸åˆ°é‡Šæ”¾ï¼Œé€ æˆå†…å­˜æ³„æ¼ã€‚æ‰€ä»¥éœ€è¦å¢åŠ å¯¹<code>SIGINT</code>å’Œ<code>SIGQUIT</code>ä¿¡å·çš„å¤„ç†å‡½æ•°ï¼Œåœ¨é‡Œé¢åšæ¸…ç†å·¥ä½œï¼Œé‡Šæ”¾å…±äº«å†…å­˜ã€‚</p>
<div class="note default">
            <p>å¦‚æœå·²ç»ä¸å°å¿ƒé€ æˆäº†å…±äº«å†…å­˜çš„æ³„æ¼ï¼Œå¯ä»¥é€šè¿‡å¦‚ä¸‹å‘½ä»¤æ‰‹åŠ¨è¿›è¡Œåˆ é™¤ã€‚<code>ipcrm shm &lt;id&gt;</code>ï¼Œå¦‚æœæ˜¯æ˜¾å¼æŒ‡å®škeyçš„è¯ä¹Ÿå¯ä»¥é€šè¿‡<code>ipcrm -M &lt;key&gt;</code>æ¥è¿›è¡Œåˆ é™¤ã€‚</p>
          </div>

<div class="note info">
            <p>ä»Šå¤©ï¼Œçªç„¶æƒ³åˆ°äº†ï¼Œå…¶å®æœ‰ä¸€ç§æ›´åŠ ç®€å•çš„æ–¹æ³•ï¼Œå³åœ¨<code>shmat()</code>ä¹‹åç«‹å³è¿›è¡Œ<code>shmctl(shmid, IPC_RMID, 0);</code>ã€‚è¿™æ ·ä¸ä»…ç®€å•ï¼Œè€Œä¸”ä¸­é—´çš„ç©ºçª—æœŸä¹Ÿæ›´çŸ­ï¼Œcoolï¼è¿™æ ·æˆ‘ä»¬å†ä¹Ÿä¸ç”¨æ‹…å¿ƒï¼Œ<code>^C</code>é€ æˆå†…å­˜æ³„æ¼äº†å“ˆã€‚</p>
          </div>

<figure class="highlight diff"><table><tr><td class="code"><pre><span class="line"><span class="meta">@@ -88,12 +88,14 @@</span> int main(int argc, char *argv[]) &#123;</span><br><span class="line">         fprintf(stderr, &quot;shmget() failed\n&quot;);</span><br><span class="line">         return -1;</span><br><span class="line">     &#125;</span><br><span class="line">     fprintf(stderr, &quot;shmid = %d\n&quot;, shmid);</span><br><span class="line">     shm = (Result*)shmat(shmid, 0, 0);</span><br><span class="line">     if ((void *) -1 == shm) &#123;</span><br><span class="line">         fprintf(stderr, &quot;shmat() failed\n&quot;);</span><br><span class="line">         return -1;</span><br><span class="line">     &#125;</span><br><span class="line"><span class="addition">+    /* è¿™é‡Œç›´æ¥è¿›è¡ŒIPC_RMIDæ“ä½œï¼Œè¿›ç¨‹é€€å‡ºåä¼šè‡ªåŠ¨detachäº†, ä»è€Œé‡Šæ”¾å…±äº«å†…å­˜ */</span></span><br><span class="line"><span class="addition">+    shmctl(shmid, IPC_RMID, 0);</span></span><br><span class="line">     memset(shm, 0, sizeof(sizeof(Result) * opt.procs));</span><br><span class="line">     /* COMMON INIT */</span><br><span class="line"></span><br><span class="line"><span class="meta">@@ -156,10 +135,6 @@</span> int main(int argc, char *argv[]) &#123;</span><br><span class="line">         fprintf(stderr, &quot;total count %12llu in %lus,  average %12.0lf/s\n&quot;,</span><br><span class="line">                final.count, opt.duration, final.count / (double)opt.duration);</span><br><span class="line">         /* DO FINAL STATISTICS */</span><br><span class="line"><span class="deletion">-</span></span><br><span class="line"><span class="deletion">-        shmdt((void*)shm);</span></span><br><span class="line"><span class="deletion">-        /* å­è¿›ç¨‹é€€å‡ºä¹‹åè‡ªåŠ¨detachäº†, æ‰€ä»¥è¿™é‡Œä¸éœ€è¦é€šè¿‡IPC_STATè¿›è¡Œåˆ¤æ–­ */</span></span><br><span class="line"><span class="deletion">-        shmctl(shmid, IPC_RMID, 0);</span></span><br><span class="line">     &#125;</span><br><span class="line">     else &#123;</span><br><span class="line">         /* CHILD INIT */</span><br></pre></td></tr></table></figure>



<h1 id="å°è£…é”™è¯¯åˆ¤æ–­å‡½æ•°"><a href="#å°è£…é”™è¯¯åˆ¤æ–­å‡½æ•°" class="headerlink" title="å°è£…é”™è¯¯åˆ¤æ–­å‡½æ•°"></a>å°è£…é”™è¯¯åˆ¤æ–­å‡½æ•°</h1><p>ä¸ºäº†ä½¿ä»£ç çœ‹èµ·æ¥æ›´åŠ ç®€æ´ï¼Œé¿å…æ¯ä¸ªå‡½æ•°è°ƒç”¨åé¢è·Ÿç€ä¸€ä¸ª<code>if()&#123;&#125;</code>åˆ¤æ–­å—ï¼Œæˆ‘ä»¬å¯¹é”™è¯¯åˆ¤æ–­åŠæ—¥å¿—æ‰“å°å‡½æ•°è¿›è¡Œäº†ä¸€ä¸ªç®€å•çš„å°è£…ã€‚å°è£…çš„å‡½æ•°å¦‚ä¸‹ï¼š</p>
<p>å…¶ä¸­<code>mylog()</code>å•çº¯æ‰“å°æ—¥å¿—ï¼Œ<code>fail()</code>æ‰“å°æ—¥å¿—åé€€å‡ºè¿›ç¨‹ï¼Œ<code>fail_if()</code>å…ˆåˆ¤æ–­æ¡ä»¶ï¼Œå¦‚æœæˆç«‹æ‰“å°æ—¥å¿—é€€å‡ºï¼Œ<code>fail_clean_if()</code>ä¹Ÿæ˜¯å…ˆåˆ¤æ–­æ¡ä»¶ï¼Œæ¡ä»¶æˆç«‹åˆ™æ‰“å°æ—¥å¿—ï¼Œæ‰§è¡Œä¼ å…¥çš„æ¸…ç†å‡½æ•°ã€‚ç„¶åé€€å‡ºè¿›ç¨‹ã€‚</p>
<div><div class="fold_hider"><div class="close hider_title">ç‚¹å‡»å±•å¼€ä»£ç </div></div><div class="fold">
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;common.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span>      <span class="comment">// stderr</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdarg.h&gt;</span>     <span class="comment">// va_start, vfprintf, va_end</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span>     <span class="comment">// exit</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">fail_if</span><span class="params">(<span class="keyword">bool</span> condition, <span class="keyword">const</span> <span class="keyword">char</span> *fmt, ...)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (condition) &#123;</span><br><span class="line">        va_list args;</span><br><span class="line">        va_start(args, fmt);</span><br><span class="line">        <span class="built_in">vfprintf</span>(<span class="built_in">stderr</span>, fmt, args);</span><br><span class="line">        va_end(args);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">fail</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *fmt, ...)</span> </span>&#123;</span><br><span class="line">    va_list args;</span><br><span class="line">    va_start(args, fmt);</span><br><span class="line">    <span class="built_in">vfprintf</span>(<span class="built_in">stderr</span>, fmt, args);</span><br><span class="line">    va_end(args);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">mylog</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *fmt, ...)</span> </span>&#123;</span><br><span class="line">    va_list args;</span><br><span class="line">    va_start(args, fmt);</span><br><span class="line">    <span class="built_in">vfprintf</span>(<span class="built_in">stderr</span>, fmt, args);</span><br><span class="line">    va_end(args);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">fail_clean_if</span><span class="params">(<span class="keyword">bool</span> condition, cleanup clean, <span class="keyword">void</span> *param, <span class="keyword">const</span> <span class="keyword">char</span> *fmt, ...)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (condition) &#123;</span><br><span class="line">        va_list args;</span><br><span class="line">        va_start(args, fmt);</span><br><span class="line">        <span class="built_in">vfprintf</span>(<span class="built_in">stderr</span>, fmt, args);</span><br><span class="line">        va_end(args);</span><br><span class="line">        clean(param);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</div></div>



<h1 id="æ·»åŠ å®é™…æµ‹è¯•ç”¨ä¾‹"><a href="#æ·»åŠ å®é™…æµ‹è¯•ç”¨ä¾‹" class="headerlink" title="æ·»åŠ å®é™…æµ‹è¯•ç”¨ä¾‹"></a>æ·»åŠ å®é™…æµ‹è¯•ç”¨ä¾‹</h1><p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥æ·»åŠ å®é™…æœ‰æ„ä¹‰çš„æµ‹è¯•ç”¨ä¾‹ï¼Œè¿™é‡Œä»¥OpenSSLå¼•æ“çš„æ€§èƒ½æµ‹è¯•ä¸ºä¾‹æ¥è¿›è¡Œè¯´æ˜ã€‚ä¸ºäº†æˆ‘ä»¬çš„ä»£ç æ›´æ¸…æ™°ï¼Œå·²ç»å°†å…·ä½“æµ‹è¯•ç›¸å…³çš„ä»£ç ç‹¬ç«‹ä¸ºä¸€ä¸ªæºæ–‡ä»¶ã€‚<code>common.c</code>å°è£…é”™è¯¯å‡½æ•°ï¼Œ<code>opt.c</code>å¤„ç†å‘½ä»¤è¡Œé€‰é¡¹ï¼Œ<code>work.c</code>å¤„ç†å…·ä½“æµ‹è¯•ï¼Œ<code>multi-process.c</code>åˆ™è´Ÿè´£æµ‹è¯•çš„ä¸»æ§ã€‚å®Œæ•´çš„ä»£ç å¦‚ä¸‹ï¼š</p>
<ul>
<li><code>common.h</code></li>
</ul>
<div><div class="fold_hider"><div class="close hider_title">ç‚¹å‡»å±•å¼€ä»£ç </div></div><div class="fold">
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> HEADER_COMMON_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HEADER_COMMON_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdbool.h&gt;</span>    <span class="comment">// bool, true, false</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">void</span> <span class="params">(*cleanup)</span> <span class="params">(<span class="keyword">void</span> *)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">fail_if</span><span class="params">(<span class="keyword">bool</span> condition, <span class="keyword">const</span> <span class="keyword">char</span> *fmt, ...)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">fail</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *fmt, ...)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">mylog</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *fmt, ...)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">fail_clean_if</span><span class="params">(<span class="keyword">bool</span> condition, cleanup clean, <span class="keyword">void</span> *param, <span class="keyword">const</span> <span class="keyword">char</span> *fmt, ...)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* HEADER_COMMON_H */</span></span></span><br></pre></td></tr></table></figure>



</div></div>

<ul>
<li><code>common.c</code></li>
</ul>
<div><div class="fold_hider"><div class="close hider_title">ç‚¹å‡»å±•å¼€ä»£ç </div></div><div class="fold">
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;common.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span>      <span class="comment">// stderr</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdarg.h&gt;</span>     <span class="comment">// va_start, vfprintf, va_end</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span>     <span class="comment">// exit</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">fail_if</span><span class="params">(<span class="keyword">bool</span> condition, <span class="keyword">const</span> <span class="keyword">char</span> *fmt, ...)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (condition) &#123;</span><br><span class="line">        va_list args;</span><br><span class="line">        va_start(args, fmt);</span><br><span class="line">        <span class="built_in">vfprintf</span>(<span class="built_in">stderr</span>, fmt, args);</span><br><span class="line">        va_end(args);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">fail</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *fmt, ...)</span> </span>&#123;</span><br><span class="line">    va_list args;</span><br><span class="line">    va_start(args, fmt);</span><br><span class="line">    <span class="built_in">vfprintf</span>(<span class="built_in">stderr</span>, fmt, args);</span><br><span class="line">    va_end(args);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">mylog</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *fmt, ...)</span> </span>&#123;</span><br><span class="line">    va_list args;</span><br><span class="line">    va_start(args, fmt);</span><br><span class="line">    <span class="built_in">vfprintf</span>(<span class="built_in">stderr</span>, fmt, args);</span><br><span class="line">    va_end(args);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">fail_clean_if</span><span class="params">(<span class="keyword">bool</span> condition, cleanup clean, <span class="keyword">void</span> *param, <span class="keyword">const</span> <span class="keyword">char</span> *fmt, ...)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (condition) &#123;</span><br><span class="line">        va_list args;</span><br><span class="line">        va_start(args, fmt);</span><br><span class="line">        <span class="built_in">vfprintf</span>(<span class="built_in">stderr</span>, fmt, args);</span><br><span class="line">        va_end(args);</span><br><span class="line">        clean(param);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</div></div>

<ul>
<li><code>opt.h</code></li>
</ul>
<div><div class="fold_hider"><div class="close hider_title">ç‚¹å‡»å±•å¼€ä»£ç </div></div><div class="fold">
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> HEADER_OPT_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HEADER_OPT_H</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> <span class="title">test</span>&#123;</span></span><br><span class="line">    hash, sign, verify, enc, dec</span><br><span class="line">&#125; Test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">options_st</span> &#123;</span></span><br><span class="line">    <span class="keyword">long</span> procs;                 <span class="comment">// è¿›ç¨‹æ•°</span></span><br><span class="line">    <span class="keyword">long</span> duration;              <span class="comment">// æµ‹è¯•æ—¶é—´</span></span><br><span class="line">    <span class="keyword">long</span> interval;              <span class="comment">// ç»Ÿè®¡é—´éš”</span></span><br><span class="line">    Test test;                  <span class="comment">// æµ‹è¯•ç±»å‹</span></span><br><span class="line">    <span class="keyword">long</span> len;                   <span class="comment">// æ‘˜è¦åŸæ–‡é•¿åº¦</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *key;            <span class="comment">// å¯†é’¥æ–‡ä»¶è·¯å¾„</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *cert;           <span class="comment">// è¯ä¹¦æ–‡ä»¶è·¯å¾„</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *loglevel;       <span class="comment">// æ—¥å¿—ç­‰çº§</span></span><br><span class="line">&#125; Options;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* å¤„ç†å‚æ•° */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">process_options</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[], Options *opt)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* HEADER_OPT_H */</span></span></span><br></pre></td></tr></table></figure>

</div></div>

<ul>
<li><code>opt.c</code></li>
</ul>
<div><div class="fold_hider"><div class="close hider_title">ç‚¹å‡»å±•å¼€ä»£ç </div></div><div class="fold">
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;opt.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;limits.h&gt;</span>     <span class="comment">// LONG_MIN, LONG_MAX, ULLONG_MAX</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span>     <span class="comment">// memset</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span>     <span class="comment">// strtol, abort</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;getopt.h&gt;</span>     <span class="comment">// geropt_long</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;common.h&quot;</span>     <span class="comment">// mylog</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ShowHelpInfo</span><span class="params">(<span class="keyword">char</span> *name)</span> </span>&#123;</span><br><span class="line">    mylog(<span class="string">&quot;Usage: %s [options]\n\n&quot;</span>, name);</span><br><span class="line">    mylog(<span class="string">&quot;  Options:\n&quot;</span>);</span><br><span class="line">    mylog(<span class="string">&quot;    -p/--proc         Number of processes (default: 1)\n&quot;</span>);</span><br><span class="line">    mylog(<span class="string">&quot;    -d/--duration     Duration of test (unit: s, default: 10)\n&quot;</span>);</span><br><span class="line">    mylog(<span class="string">&quot;    -i/--interval     Interval of statisics (unit: s, default: 1)\n&quot;</span>);</span><br><span class="line">    mylog(<span class="string">&quot;    -t/--test         Test case (hash|sign|verify|enc|dec, default: hash)\n&quot;</span>);</span><br><span class="line">    mylog(<span class="string">&quot;    -l/--len          Hash data len (unit: byte, default: 1024)\n&quot;</span>);</span><br><span class="line">    mylog(<span class="string">&quot;    -k/--key          PEM Key file path (default: ./key.pem)\n&quot;</span>);</span><br><span class="line">    mylog(<span class="string">&quot;    -c/--cert         PEM Cert file path (default: ./cert.pem)\n&quot;</span>);</span><br><span class="line">    mylog(<span class="string">&quot;    -o/--loglevel     Engine log level (0-9, default: 0)\n&quot;</span>);</span><br><span class="line">    mylog(<span class="string">&quot;    -h/--help         Show the help info\n&quot;</span>);</span><br><span class="line">    mylog(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">    mylog(<span class="string">&quot;  Example:\n&quot;</span>);</span><br><span class="line">    mylog(<span class="string">&quot;    %s -p 1 -d 30 -i 1 -t sign -k key.pem -c cert.pem\n&quot;</span>, name);</span><br><span class="line">    mylog(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* å¤„ç†å‚æ•° */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">process_options</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[], Options *opt)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> c = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> option_index = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">long</span> procs = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">long</span> duration = <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">long</span> interval = <span class="number">1</span>;</span><br><span class="line">    Test test = hash;</span><br><span class="line">    <span class="keyword">long</span> len = <span class="number">1024</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *key = <span class="string">&quot;./key.pem&quot;</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *cert = <span class="string">&quot;./cert.pem&quot;</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *loglevel = <span class="string">&quot;0&quot;</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *  å®šä¹‰å‘½ä»¤è¡Œå‚æ•°åˆ—è¡¨ï¼Œoptionç»“æ„çš„å«ä¹‰å¦‚ä¸‹ï¼ˆè¯¦è§ man 3 getoptï¼‰ï¼š</span></span><br><span class="line"><span class="comment">     *  struct option &#123;</span></span><br><span class="line"><span class="comment">     *      const char *name;       // å‚æ•°çš„å®Œæ•´åç§°ï¼Œå¯¹åº”å‘½ä»¤ä¸­çš„ --xxx</span></span><br><span class="line"><span class="comment">     *      int  has_arg;           // è¯¥å‚æ•°æ˜¯å¦å¸¦æœ‰ä¸€ä¸ªå€¼ï¼Œå¦‚ â€“config xxx.conf</span></span><br><span class="line"><span class="comment">     *      int *flag;              // ä¸€èˆ¬è®¾ç½®ä¸ºNULL</span></span><br><span class="line"><span class="comment">     *      int  val;               // è§£æåˆ°è¯¥å‚æ•°ågetopt_longå‡½æ•°çš„è¿”å›å€¼ï¼Œ</span></span><br><span class="line"><span class="comment">     *                      // ä¸ºäº†æ–¹ä¾¿ç»´æŠ¤ï¼Œä¸€èˆ¬å¯¹åº”getopt_longè°ƒç”¨æ—¶ç¬¬ä¸‰ä¸ªå‚æ•°</span></span><br><span class="line"><span class="comment">     *  &#125;;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">option</span> <span class="title">arg_options</span>[] =</span></span><br><span class="line">    &#123;</span><br><span class="line">        &#123;<span class="string">&quot;proc&quot;</span>, <span class="number">1</span>, <span class="literal">NULL</span>, <span class="string">&#x27;p&#x27;</span>&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;duration&quot;</span>, <span class="number">1</span>, <span class="literal">NULL</span>, <span class="string">&#x27;d&#x27;</span>&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;interval&quot;</span>, <span class="number">1</span>, <span class="literal">NULL</span>, <span class="string">&#x27;i&#x27;</span>&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;test&quot;</span>, <span class="number">1</span>, <span class="literal">NULL</span>, <span class="string">&#x27;t&#x27;</span>&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;len&quot;</span>, <span class="number">1</span>, <span class="literal">NULL</span>, <span class="string">&#x27;l&#x27;</span>&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;key&quot;</span>, <span class="number">1</span>, <span class="literal">NULL</span>, <span class="string">&#x27;k&#x27;</span>&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;cert&quot;</span>, <span class="number">1</span>, <span class="literal">NULL</span>, <span class="string">&#x27;c&#x27;</span>&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;log&quot;</span>, <span class="number">1</span>, <span class="literal">NULL</span>, <span class="string">&#x27;g&#x27;</span>&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;help&quot;</span>, <span class="number">0</span>, <span class="literal">NULL</span>, <span class="string">&#x27;h&#x27;</span>&#125;,</span><br><span class="line">        &#123;<span class="literal">NULL</span>, <span class="number">0</span>, <span class="literal">NULL</span>, <span class="number">0</span>&#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *  æ³¨æ„ï¼šä¼ é€’ç»™getopt_longçš„ç¬¬ä¸‰ä¸ªå‚æ•°å¯¹åº”äº†å‘½ä»¤è¡Œå‚æ•°çš„ç¼©å†™å½¢å¼ï¼Œå¦‚-hç­‰ï¼Œ</span></span><br><span class="line"><span class="comment">     *  å¦‚æœå­—ç¬¦åé¢å¸¦æœ‰å†’å·&quot;:&quot;ï¼Œåˆ™è¯´æ˜è¯¥å‚æ•°åè·Ÿä¸€ä¸ªå€¼ï¼Œå¦‚-c xxxxxx</span></span><br><span class="line"><span class="comment">     *  å¦‚æœå¼€å¤´æœ‰å†’å·&quot;:&quot;ï¼Œåˆ™å½“ä¸€ä¸ªé€‰é¡¹ç¼ºå°‘å‚æ•°æ—¶ï¼Œè¿”å›&quot;:&quot;ï¼Œå¦åˆ™ï¼Œè¿”å›&quot;?&quot;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">while</span> ((c = getopt_long(argc, argv, <span class="string">&quot;:p:d:i:t:l:k:c:g:h&quot;</span>, arg_options, &amp;option_index)</span><br><span class="line">            ) != <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="keyword">switch</span> (c) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;h&#x27;</span>:</span><br><span class="line">            ShowHelpInfo(argv[<span class="number">0</span>]);</span><br><span class="line">            <span class="comment">//fprintf(stderr,&quot;option is -%c, optarv is %s\n&quot;, c, optarg);</span></span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;p&#x27;</span>:</span><br><span class="line">            procs = strtol(optarg, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (procs == LONG_MIN || procs == LONG_MAX) &#123;</span><br><span class="line">                mylog(<span class="string">&quot;The number of processes (%s) is overflow\n\n&quot;</span>, optarg);</span><br><span class="line">                ShowHelpInfo(argv[<span class="number">0</span>]);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (procs &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                mylog(<span class="string">&quot;The number of processes must be &gt; 0\n\n&quot;</span>);</span><br><span class="line">                ShowHelpInfo(argv[<span class="number">0</span>]);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;d&#x27;</span>:</span><br><span class="line">            duration = strtol(optarg, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (duration == LONG_MIN || duration == LONG_MAX) &#123;</span><br><span class="line">                mylog(<span class="string">&quot;The duration of test (%s) is overflow\n\n&quot;</span>, optarg);</span><br><span class="line">                ShowHelpInfo(argv[<span class="number">0</span>]);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (duration &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                mylog(<span class="string">&quot;The duration of test must be &gt; 0\n\n&quot;</span>);</span><br><span class="line">                ShowHelpInfo(argv[<span class="number">0</span>]);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;i&#x27;</span>:</span><br><span class="line">            interval = strtol(optarg, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (interval == LONG_MIN || interval == LONG_MAX) &#123;</span><br><span class="line">                mylog(<span class="string">&quot;The interval of statistics (%s) is overflow\n\n&quot;</span>,</span><br><span class="line">                      optarg);</span><br><span class="line">                ShowHelpInfo(argv[<span class="number">0</span>]);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (interval &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                mylog(<span class="string">&quot;The interval of statistics must be &gt; 0\n\n&quot;</span>);</span><br><span class="line">                ShowHelpInfo(argv[<span class="number">0</span>]);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;t&#x27;</span>:</span><br><span class="line">            <span class="keyword">if</span>(!strcasecmp(<span class="string">&quot;hash&quot;</span>, optarg)) &#123;</span><br><span class="line">                test = hash;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(!strcasecmp(<span class="string">&quot;sign&quot;</span>, optarg)) &#123;</span><br><span class="line">                test = sign;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(!strcasecmp(<span class="string">&quot;verify&quot;</span>, optarg)) &#123;</span><br><span class="line">                test = verify;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(!strcasecmp(<span class="string">&quot;enc&quot;</span>, optarg)) &#123;</span><br><span class="line">                test = enc;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(!strcasecmp(<span class="string">&quot;dec&quot;</span>, optarg)) &#123;</span><br><span class="line">                test = dec;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                mylog(<span class="string">&quot;Unknown test case type\n\n&quot;</span>);</span><br><span class="line">                ShowHelpInfo(argv[<span class="number">0</span>]);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;l&#x27;</span>:</span><br><span class="line">            len = strtol(optarg, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (len == LONG_MIN || len == LONG_MAX) &#123;</span><br><span class="line">                mylog(<span class="string">&quot;The len of hash data (%s) is overflow\n\n&quot;</span>,</span><br><span class="line">                      optarg);</span><br><span class="line">                ShowHelpInfo(argv[<span class="number">0</span>]);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (len &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                mylog(<span class="string">&quot;The len of hash data must be &gt; 0\n\n&quot;</span>);</span><br><span class="line">                ShowHelpInfo(argv[<span class="number">0</span>]);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;k&#x27;</span>:</span><br><span class="line">            key = optarg;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;c&#x27;</span>:</span><br><span class="line">            cert = optarg;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;g&#x27;</span>:</span><br><span class="line">            loglevel = optarg;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;?&#x27;</span>:</span><br><span class="line">            mylog(<span class="string">&quot;Unknown option -%c\n\n&quot;</span>, optopt);</span><br><span class="line">            ShowHelpInfo(argv[<span class="number">0</span>]);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;:&#x27;</span>:</span><br><span class="line">            mylog(<span class="string">&quot;Option -%c requires an argument\n\n&quot;</span>, optopt);</span><br><span class="line">            ShowHelpInfo(argv[<span class="number">0</span>]);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    mylog(<span class="string">&quot;processes:  %ld\n&quot;</span>, procs);</span><br><span class="line">    mylog(<span class="string">&quot;duration:   %lds\n&quot;</span>, duration);</span><br><span class="line">    mylog(<span class="string">&quot;interval:   %lds\n&quot;</span>, interval);</span><br><span class="line">    mylog(<span class="string">&quot;test:       #%d\n&quot;</span>, test);</span><br><span class="line">    mylog(<span class="string">&quot;len:        %ld bytes\n&quot;</span>, len);</span><br><span class="line">    mylog(<span class="string">&quot;key:        %s\n&quot;</span>, key);</span><br><span class="line">    mylog(<span class="string">&quot;cert:       %s\n&quot;</span>, cert);</span><br><span class="line">    mylog(<span class="string">&quot;loglevel:   %s\n&quot;</span>, loglevel);</span><br><span class="line">    <span class="built_in">memset</span>(opt, <span class="number">0</span>, <span class="keyword">sizeof</span>(Options));</span><br><span class="line">    opt-&gt;procs = procs;</span><br><span class="line">    opt-&gt;duration = duration;</span><br><span class="line">    opt-&gt;interval = interval;</span><br><span class="line">    opt-&gt;test = test;</span><br><span class="line">    opt-&gt;len = len;</span><br><span class="line">    opt-&gt;key = key;</span><br><span class="line">    opt-&gt;cert = cert;</span><br><span class="line">    opt-&gt;loglevel = loglevel;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</div></div>

<ul>
<li><code>work.h</code></li>
</ul>
<div><div class="fold_hider"><div class="close hider_title">ç‚¹å‡»å±•å¼€ä»£ç </div></div><div class="fold">
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> HEADER_WORK_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HEADER_WORK_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;openssl/evp.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;openssl/bio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;opt.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* è‡ªå®šä¹‰æµ‹è¯•å‚æ•° */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">hash_param_st</span> &#123;</span></span><br><span class="line">    <span class="keyword">long</span> index;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> *data;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> data_len;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> md[<span class="number">128</span>];</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> md_len;</span><br><span class="line">    EVP_MD_CTX *ctx;</span><br><span class="line">&#125; HashParam;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">sign_param_st</span> &#123;</span></span><br><span class="line">    <span class="keyword">long</span> index;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> data[<span class="number">48</span>];</span><br><span class="line">    <span class="keyword">size_t</span> data_len;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> sig[<span class="number">256</span>];</span><br><span class="line">    <span class="keyword">size_t</span> sig_len;</span><br><span class="line">    EVP_PKEY_CTX *ctx;</span><br><span class="line">    BIO *in;</span><br><span class="line">&#125; SignParam;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> SignParam VerifyParam;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">enc_param_st</span> &#123;</span></span><br><span class="line">    <span class="keyword">long</span> index;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> data[<span class="number">48</span>];</span><br><span class="line">    <span class="keyword">size_t</span> data_len;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> enc[<span class="number">256</span>];</span><br><span class="line">    <span class="keyword">size_t</span> enc_len;</span><br><span class="line">    EVP_PKEY_CTX *ctx;</span><br><span class="line">    BIO *in;</span><br><span class="line">&#125; EncParam;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> EncParam DecParam;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* è‡ªå®šä¹‰æµ‹è¯•ç»“æœ */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">result_st</span> &#123;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> count;</span><br><span class="line">&#125; Result;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">void</span> <span class="params">(*init_fn)</span> <span class="params">(Options *opt, <span class="keyword">void</span> **param, <span class="keyword">long</span> proc_index)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">void</span> <span class="params">(*work_fn)</span> <span class="params">(<span class="keyword">void</span> *param)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">void</span> <span class="params">(*clean_fn)</span> <span class="params">(<span class="keyword">void</span> *param)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> init_fn test_init;</span><br><span class="line"><span class="keyword">extern</span> work_fn test_work;</span><br><span class="line"><span class="keyword">extern</span> clean_fn test_clean;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">global_init</span><span class="params">(Options *opt)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">global_clean</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* HEADER_WORK_H */</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

</div></div>

<ul>
<li><code>work.c</code></li>
</ul>
<div><div class="fold_hider"><div class="close hider_title">ç‚¹å‡»å±•å¼€ä»£ç </div></div><div class="fold">
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;work.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;openssl/engine.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;openssl/pem.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;common.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span>* so_path = <span class="string">&quot;/usr/local/ssl/lib/myengine.so&quot;</span>;</span><br><span class="line"></span><br><span class="line">init_fn test_init = <span class="literal">NULL</span>;</span><br><span class="line">work_fn test_work = <span class="literal">NULL</span>;</span><br><span class="line">clean_fn test_clean = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">hash_init</span><span class="params">(Options *opt, <span class="keyword">void</span> **param, <span class="keyword">long</span> proc_index)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">hash_work</span><span class="params">(<span class="keyword">void</span> *param)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">hash_clean</span><span class="params">(<span class="keyword">void</span> *param)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sign_init</span><span class="params">(Options *opt, <span class="keyword">void</span> **param, <span class="keyword">long</span> proc_index)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sign_work</span><span class="params">(<span class="keyword">void</span> *param)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sign_clean</span><span class="params">(<span class="keyword">void</span> *param)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">verify_init</span><span class="params">(Options *opt, <span class="keyword">void</span> **param, <span class="keyword">long</span> proc_index)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">verify_work</span><span class="params">(<span class="keyword">void</span> *param)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">verify_clean</span><span class="params">(<span class="keyword">void</span> *param)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">encrypt_init</span><span class="params">(Options *opt, <span class="keyword">void</span> **param, <span class="keyword">long</span> proc_index)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">encrypt_work</span><span class="params">(<span class="keyword">void</span> *param)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">encrypt_clean</span><span class="params">(<span class="keyword">void</span> *param)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">decrypt_init</span><span class="params">(Options *opt, <span class="keyword">void</span> **param, <span class="keyword">long</span> proc_index)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">decrypt_work</span><span class="params">(<span class="keyword">void</span> *param)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">decrypt_clean</span><span class="params">(<span class="keyword">void</span> *param)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">global_init</span><span class="params">(Options *opt)</span> </span>&#123;</span><br><span class="line">    ENGINE *e = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">if</span> (opt-&gt;test == hash) &#123;</span><br><span class="line">        test_init = hash_init;</span><br><span class="line">        test_work = hash_work;</span><br><span class="line">        test_clean = hash_clean;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (opt-&gt;test == sign) &#123;</span><br><span class="line">        test_init = sign_init;</span><br><span class="line">        test_work = sign_work;</span><br><span class="line">        test_clean = sign_clean;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (opt-&gt;test == verify) &#123;</span><br><span class="line">        test_init = verify_init;</span><br><span class="line">        test_work = verify_work;</span><br><span class="line">        test_clean = verify_clean;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (opt-&gt;test == enc) &#123;</span><br><span class="line">        test_init = encrypt_init;</span><br><span class="line">        test_work = encrypt_work;</span><br><span class="line">        test_clean = encrypt_clean;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (opt-&gt;test == dec) &#123;</span><br><span class="line">        test_init = decrypt_init;</span><br><span class="line">        test_work = decrypt_work;</span><br><span class="line">        test_clean = decrypt_clean;</span><br><span class="line">    &#125;</span><br><span class="line">    OpenSSL_add_all_algorithms();</span><br><span class="line">    <span class="comment">/* ENGINE INIT */</span></span><br><span class="line">    ENGINE_load_dynamic();</span><br><span class="line">    <span class="keyword">if</span> (!(e = ENGINE_by_id(<span class="string">&quot;dynamic&quot;</span>))) &#123;</span><br><span class="line">        fail(<span class="string">&quot;ENGINE_by_id(\&quot;dynamic\&quot;) fail\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!ENGINE_ctrl_cmd_string(e, <span class="string">&quot;SO_PATH&quot;</span>, so_path, <span class="number">0</span>)) &#123;</span><br><span class="line">        fail(<span class="string">&quot;ENGINE_ctrl_cmd_string(\&quot;SO_PATH\&quot;) fail, so_path = %s\n&quot;</span>, </span><br><span class="line">             so_path);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!ENGINE_ctrl_cmd_string(e, <span class="string">&quot;LIST_ADD&quot;</span>, <span class="string">&quot;1&quot;</span>, <span class="number">0</span>)) &#123;</span><br><span class="line">        fail(<span class="string">&quot;ENGINE_ctrl_cmd_string(\&quot;LIST_ADD\&quot;) fail\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!ENGINE_ctrl_cmd_string(e, <span class="string">&quot;LOAD&quot;</span>, <span class="literal">NULL</span>, <span class="number">0</span>)) &#123;</span><br><span class="line">        fail(<span class="string">&quot;ENGINE_ctrl_cmd_string(\&quot;LOAD\&quot;) fail\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!ENGINE_init(e)) &#123;</span><br><span class="line">        fail(<span class="string">&quot;ENGINE_init() fail\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!ENGINE_ctrl_cmd_string( e, <span class="string">&quot;ENGINE_SET_LOGLEVEL&quot;</span>, opt-&gt;loglevel, <span class="number">0</span>)) &#123;</span><br><span class="line">        fail(<span class="string">&quot;ENGINE_ctrl_cmd_string(\&quot;ENGINE_SET_LOGLEVEL\&quot;) fail\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!ENGINE_set_default(e, ENGINE_METHOD_ALL)) &#123;</span><br><span class="line">        fail(<span class="string">&quot;ENGINE_set_default() fail\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    ENGINE_free(e);</span><br><span class="line">    <span class="comment">/* ENGINE INIT */</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">global_clean</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    EVP_cleanup();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">hash_init</span><span class="params">(Options *opt, <span class="keyword">void</span> **param, <span class="keyword">long</span> proc_index)</span> </span>&#123;</span><br><span class="line">    HashParam *p;</span><br><span class="line">    p = OPENSSL_malloc(<span class="keyword">sizeof</span>(HashParam));</span><br><span class="line">    fail_if(!p, <span class="string">&quot;OPENSSL_malloc() fail\n&quot;</span>);</span><br><span class="line">    <span class="built_in">memset</span>(p, <span class="number">0</span>, <span class="keyword">sizeof</span>(HashParam));</span><br><span class="line"></span><br><span class="line">    p-&gt;ctx = EVP_MD_CTX_create();</span><br><span class="line">    fail_clean_if(!p-&gt;ctx, hash_clean, (<span class="keyword">void</span> *)p, <span class="string">&quot;EVP_MD_CTX_create() fail\n&quot;</span>);</span><br><span class="line">    EVP_MD_CTX_init(p-&gt;ctx);</span><br><span class="line"></span><br><span class="line">    p-&gt;data = OPENSSL_malloc(opt-&gt;len);</span><br><span class="line">    fail_clean_if(!p-&gt;data, hash_clean, (<span class="keyword">void</span> *)p, <span class="string">&quot;OPENSSL_malloc() fail\n&quot;</span>);</span><br><span class="line">    fail_clean_if(RAND_bytes(p-&gt;data, <span class="keyword">sizeof</span>(opt-&gt;len)) &lt;= <span class="number">0</span>, hash_clean, (<span class="keyword">void</span> *)p,</span><br><span class="line">                  <span class="string">&quot;RAND_bytes() fail\n&quot;</span>);</span><br><span class="line">    p-&gt;data_len = opt-&gt;len;</span><br><span class="line"></span><br><span class="line">    p-&gt;index = proc_index;</span><br><span class="line"></span><br><span class="line">    *param = p;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">hash_work</span><span class="params">(<span class="keyword">void</span> *param)</span> </span>&#123;</span><br><span class="line">    HashParam *p = (HashParam *)param;</span><br><span class="line">    <span class="keyword">const</span> EVP_MD *md = EVP_get_digestbyname(<span class="string">&quot;SHASH&quot;</span>);</span><br><span class="line">    fail_clean_if(!md, hash_clean, param, </span><br><span class="line">                  <span class="string">&quot;EVP_get_digestbyname(\&quot;SHASH\&quot;) fail\n&quot;</span>);</span><br><span class="line">    fail_clean_if(!EVP_DigestInit_ex(p-&gt;ctx, md, <span class="literal">NULL</span>), </span><br><span class="line">                  hash_clean, param, <span class="string">&quot;EVP_DigestInit_ex() fail\n&quot;</span>);</span><br><span class="line">    fail_clean_if(!EVP_DigestUpdate(p-&gt;ctx, p-&gt;data, p-&gt;data_len),</span><br><span class="line">                  hash_clean, param, <span class="string">&quot;EVP_DigestUpdate() fail\n&quot;</span>);</span><br><span class="line">    fail_clean_if(!EVP_DigestFinal_ex(p-&gt;ctx, p-&gt;md, &amp;p-&gt;md_len),</span><br><span class="line">                  hash_clean, param, <span class="string">&quot;EVP_DigestFinal_ex() fail\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">hash_clean</span><span class="params">(<span class="keyword">void</span> *param)</span> </span>&#123;</span><br><span class="line">    HashParam *p = (HashParam *)param;</span><br><span class="line">    <span class="keyword">if</span> (p-&gt;data)</span><br><span class="line">        OPENSSL_free(p-&gt;data);</span><br><span class="line">    <span class="keyword">if</span> (p-&gt;ctx)</span><br><span class="line">        EVP_MD_CTX_destroy(p-&gt;ctx);</span><br><span class="line">    OPENSSL_free(p);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sign_init</span><span class="params">(Options *opt, <span class="keyword">void</span> **param, <span class="keyword">long</span> proc_index)</span> </span>&#123;</span><br><span class="line">    SignParam *p;</span><br><span class="line">    EVP_PKEY *pkey;</span><br><span class="line">    p = OPENSSL_malloc(<span class="keyword">sizeof</span>(SignParam));</span><br><span class="line">    fail_if(!p, <span class="string">&quot;OPENSSL_malloc() fail\n&quot;</span>);</span><br><span class="line">    <span class="built_in">memset</span>(p, <span class="number">0</span>, <span class="keyword">sizeof</span>(SignParam));</span><br><span class="line"></span><br><span class="line">    p-&gt;in = BIO_new_file(opt-&gt;key, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">    fail_clean_if(!p-&gt;in, sign_clean, (<span class="keyword">void</span> *)p, </span><br><span class="line">                  <span class="string">&quot;BIO_new_file(%s) fail\n&quot;</span>, opt-&gt;key);</span><br><span class="line">    pkey = PEM_read_bio_PrivateKey(p-&gt;in, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line">    fail_clean_if(!pkey, sign_clean, (<span class="keyword">void</span> *)p, </span><br><span class="line">                  <span class="string">&quot;PEM_read_bio_PrivateKey() fail\n&quot;</span>);</span><br><span class="line">    p-&gt;ctx = EVP_PKEY_CTX_new(pkey, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (!p-&gt;ctx) &#123;</span><br><span class="line">        EVP_PKEY_free(pkey);</span><br><span class="line">        fail_clean_if(<span class="number">1</span>, sign_clean, (<span class="keyword">void</span> *)p, <span class="string">&quot;EVP_PKEY_CTX_new() fail\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    fail_clean_if(!EVP_PKEY_sign_init(p-&gt;ctx), sign_clean, (<span class="keyword">void</span> *)p, </span><br><span class="line">                  <span class="string">&quot;EVP_PKEY_sign_init() fail\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    fail_clean_if(RAND_bytes(p-&gt;data, <span class="keyword">sizeof</span>(p-&gt;data)) &lt;= <span class="number">0</span>, sign_clean, (<span class="keyword">void</span> *)p,</span><br><span class="line">                  <span class="string">&quot;RAND_bytes() fail\n&quot;</span>);</span><br><span class="line">    p-&gt;data_len = <span class="keyword">sizeof</span>(p-&gt;data);</span><br><span class="line">    p-&gt;sig_len = <span class="keyword">sizeof</span>(p-&gt;sig);</span><br><span class="line"></span><br><span class="line">    p-&gt;index = proc_index;</span><br><span class="line">    *param = p;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sign_work</span><span class="params">(<span class="keyword">void</span> *param)</span> </span>&#123;</span><br><span class="line">    SignParam *p = (SignParam *)param;</span><br><span class="line">    fail_clean_if(!EVP_PKEY_sign(p-&gt;ctx, p-&gt;sig, &amp;p-&gt;sig_len, p-&gt;data, </span><br><span class="line">                                 p-&gt;data_len), sign_clean, param,</span><br><span class="line">                  <span class="string">&quot;EVP_PKEY_sign() fail\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sign_clean</span><span class="params">(<span class="keyword">void</span> *param)</span> </span>&#123;</span><br><span class="line">    SignParam *p = (SignParam *)param;</span><br><span class="line">    <span class="keyword">if</span> (p-&gt;ctx)</span><br><span class="line">        EVP_PKEY_CTX_free(p-&gt;ctx);</span><br><span class="line">    <span class="keyword">if</span> (p-&gt;in)</span><br><span class="line">        BIO_free(p-&gt;in);</span><br><span class="line">    OPENSSL_free(p);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">verify_init</span><span class="params">(Options *opt, <span class="keyword">void</span> **param, <span class="keyword">long</span> proc_index)</span> </span>&#123;</span><br><span class="line">    VerifyParam *p;</span><br><span class="line">    EVP_PKEY *pkey;</span><br><span class="line">    X509 *x;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> data[<span class="number">48</span>];</span><br><span class="line">    <span class="keyword">size_t</span> data_len;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> sig[<span class="number">256</span>];</span><br><span class="line">    <span class="keyword">size_t</span> sig_len;</span><br><span class="line">    <span class="comment">/* å…ˆç­¾åä¸€æ¬¡ï¼Œè·å–æ•°æ® */</span></span><br><span class="line">    SignParam *sp;</span><br><span class="line">    sign_init(opt, (<span class="keyword">void</span> **)&amp;sp, (<span class="keyword">long</span>)<span class="number">0</span>);</span><br><span class="line">    sign_work(sp);</span><br><span class="line">    <span class="built_in">memcpy</span>(data, sp-&gt;data, sp-&gt;data_len);</span><br><span class="line">    data_len = sp-&gt;data_len;</span><br><span class="line">    <span class="built_in">memcpy</span>(sig, sp-&gt;sig, sp-&gt;sig_len);</span><br><span class="line">    sig_len = sp-&gt;sig_len;</span><br><span class="line">    sign_clean(sp);</span><br><span class="line"></span><br><span class="line">    p = OPENSSL_malloc(<span class="keyword">sizeof</span>(VerifyParam));</span><br><span class="line">    fail_if(!p, <span class="string">&quot;OPENSSL_malloc() fail\n&quot;</span>);</span><br><span class="line">    <span class="built_in">memset</span>(p, <span class="number">0</span>, <span class="keyword">sizeof</span>(VerifyParam));</span><br><span class="line">    </span><br><span class="line">    p-&gt;in = BIO_new_file(opt-&gt;cert, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">    fail_clean_if(!p-&gt;in, verify_clean, (<span class="keyword">void</span> *)p, </span><br><span class="line">                  <span class="string">&quot;BIO_new_file(%s) fail\n&quot;</span>, opt-&gt;cert);</span><br><span class="line">    x = PEM_read_bio_X509(p-&gt;in, <span class="literal">NULL</span>, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">    fail_clean_if(!x, verify_clean, (<span class="keyword">void</span> *)p, </span><br><span class="line">                  <span class="string">&quot;PEM_read_bio_X509() fail\n&quot;</span>);</span><br><span class="line">    pkey = X509_get_pubkey(x);</span><br><span class="line">    X509_free(x);</span><br><span class="line">    fail_clean_if(!pkey, verify_clean, (<span class="keyword">void</span> *)p, <span class="string">&quot;X509_get_pubkey() fail\n&quot;</span>);</span><br><span class="line">    p-&gt;ctx = EVP_PKEY_CTX_new(pkey, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (!p-&gt;ctx) &#123;</span><br><span class="line">        EVP_PKEY_free(pkey);</span><br><span class="line">        fail_clean_if(<span class="number">1</span>, verify_clean, (<span class="keyword">void</span> *)p, <span class="string">&quot;EVP_PKEY_CTX_new() fail\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    fail_clean_if(!EVP_PKEY_verify_init(p-&gt;ctx), verify_clean, (<span class="keyword">void</span> *)p, </span><br><span class="line">                  <span class="string">&quot;EVP_PKEY_verify_init() fail\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memcpy</span>(p-&gt;data, data, data_len);</span><br><span class="line">    p-&gt;data_len = data_len;</span><br><span class="line">    <span class="built_in">memcpy</span>(p-&gt;sig, sig, sig_len);</span><br><span class="line">    p-&gt;sig_len = sig_len;</span><br><span class="line"></span><br><span class="line">    p-&gt;index = proc_index;</span><br><span class="line">    *param = p;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">verify_work</span><span class="params">(<span class="keyword">void</span> *param)</span> </span>&#123;</span><br><span class="line">    VerifyParam *p = (VerifyParam *)param;</span><br><span class="line">    fail_clean_if(!EVP_PKEY_verify(p-&gt;ctx, p-&gt;sig, p-&gt;sig_len, p-&gt;data, </span><br><span class="line">                                 p-&gt;data_len), verify_clean, param,</span><br><span class="line">                  <span class="string">&quot;EVP_PKEY_verify() fail\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">verify_clean</span><span class="params">(<span class="keyword">void</span> *param)</span> </span>&#123;</span><br><span class="line">    VerifyParam *p = (VerifyParam *)param;</span><br><span class="line">    <span class="keyword">if</span> (p-&gt;ctx)</span><br><span class="line">        EVP_PKEY_CTX_free(p-&gt;ctx);</span><br><span class="line">    <span class="keyword">if</span> (p-&gt;in)</span><br><span class="line">        BIO_free(p-&gt;in);</span><br><span class="line">    OPENSSL_free(p);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">encrypt_init</span><span class="params">(Options *opt, <span class="keyword">void</span> **param, <span class="keyword">long</span> proc_index)</span> </span>&#123;</span><br><span class="line">    EncParam *p;</span><br><span class="line">    EVP_PKEY *pkey;</span><br><span class="line">    X509 *x;</span><br><span class="line">    p = OPENSSL_malloc(<span class="keyword">sizeof</span>(EncParam));</span><br><span class="line">    fail_if(!p, <span class="string">&quot;OPENSSL_malloc() fail\n&quot;</span>);</span><br><span class="line">    <span class="built_in">memset</span>(p, <span class="number">0</span>, <span class="keyword">sizeof</span>(EncParam));</span><br><span class="line"></span><br><span class="line">    p-&gt;in = BIO_new_file(opt-&gt;cert, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">    fail_clean_if(!p-&gt;in, encrypt_clean, (<span class="keyword">void</span> *)p, </span><br><span class="line">                  <span class="string">&quot;BIO_new_file(%s) fail\n&quot;</span>, opt-&gt;cert);</span><br><span class="line">    x = PEM_read_bio_X509(p-&gt;in, <span class="literal">NULL</span>, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">    fail_clean_if(!x, encrypt_clean, (<span class="keyword">void</span> *)p, </span><br><span class="line">                  <span class="string">&quot;PEM_read_bio_X509() fail\n&quot;</span>);</span><br><span class="line">    pkey = X509_get_pubkey(x);</span><br><span class="line">    X509_free(x);</span><br><span class="line">    fail_clean_if(!pkey, encrypt_clean, (<span class="keyword">void</span> *)p, <span class="string">&quot;X509_get_pubkey() fail\n&quot;</span>);</span><br><span class="line">    p-&gt;ctx = EVP_PKEY_CTX_new(pkey, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (!p-&gt;ctx) &#123;</span><br><span class="line">        EVP_PKEY_free(pkey);</span><br><span class="line">        fail_clean_if(<span class="number">1</span>, encrypt_clean, (<span class="keyword">void</span> *)p, <span class="string">&quot;EVP_PKEY_CTX_new() fail\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    fail_clean_if(!EVP_PKEY_encrypt_init(p-&gt;ctx), encrypt_clean, (<span class="keyword">void</span> *)p, </span><br><span class="line">                  <span class="string">&quot;EVP_PKEY_encrypt_init() fail\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    fail_clean_if(RAND_bytes(p-&gt;data, <span class="keyword">sizeof</span>(p-&gt;data)) &lt;= <span class="number">0</span>, encrypt_clean, (<span class="keyword">void</span> *)p,</span><br><span class="line">                  <span class="string">&quot;RAND_bytes() fail\n&quot;</span>);</span><br><span class="line">    p-&gt;data_len = <span class="keyword">sizeof</span>(p-&gt;data);</span><br><span class="line">    p-&gt;enc_len = <span class="keyword">sizeof</span>(p-&gt;enc);</span><br><span class="line"></span><br><span class="line">    p-&gt;index = proc_index;</span><br><span class="line">    *param = p;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">encrypt_work</span><span class="params">(<span class="keyword">void</span> *param)</span> </span>&#123;</span><br><span class="line">    EncParam *p = (EncParam *)param;</span><br><span class="line">    fail_clean_if(!EVP_PKEY_encrypt(p-&gt;ctx, p-&gt;enc, &amp;p-&gt;enc_len, p-&gt;data, </span><br><span class="line">                                 p-&gt;data_len), encrypt_clean, param,</span><br><span class="line">                  <span class="string">&quot;EVP_PKEY_encrypt() fail\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">encrypt_clean</span><span class="params">(<span class="keyword">void</span> *param)</span> </span>&#123;</span><br><span class="line">    EncParam *p = (EncParam *)param;</span><br><span class="line">    <span class="keyword">if</span> (p-&gt;ctx)</span><br><span class="line">        EVP_PKEY_CTX_free(p-&gt;ctx);</span><br><span class="line">    <span class="keyword">if</span> (p-&gt;in)</span><br><span class="line">        BIO_free(p-&gt;in);</span><br><span class="line">    OPENSSL_free(p);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">decrypt_init</span><span class="params">(Options *opt, <span class="keyword">void</span> **param, <span class="keyword">long</span> proc_index)</span> </span>&#123;</span><br><span class="line">    DecParam *p;</span><br><span class="line">    EVP_PKEY *pkey;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> data[<span class="number">48</span>];</span><br><span class="line">    <span class="keyword">size_t</span> data_len;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> enc[<span class="number">256</span>];</span><br><span class="line">    <span class="keyword">size_t</span> enc_len;</span><br><span class="line">    <span class="comment">/* å…ˆåŠ å¯†ä¸€æ¬¡ï¼Œè·å–æ•°æ® */</span></span><br><span class="line">    EncParam *ep;</span><br><span class="line">    encrypt_init(opt, (<span class="keyword">void</span> **)&amp;ep, (<span class="keyword">long</span>)<span class="number">0</span>);</span><br><span class="line">    encrypt_work(ep);</span><br><span class="line">    <span class="built_in">memcpy</span>(data, ep-&gt;data, ep-&gt;data_len);</span><br><span class="line">    data_len = ep-&gt;data_len;</span><br><span class="line">    <span class="built_in">memcpy</span>(enc, ep-&gt;enc, ep-&gt;enc_len);</span><br><span class="line">    enc_len = ep-&gt;enc_len;</span><br><span class="line">    encrypt_clean(ep);</span><br><span class="line"></span><br><span class="line">    p = OPENSSL_malloc(<span class="keyword">sizeof</span>(DecParam));</span><br><span class="line">    fail_if(!p, <span class="string">&quot;OPENSSL_malloc() fail\n&quot;</span>);</span><br><span class="line">    <span class="built_in">memset</span>(p, <span class="number">0</span>, <span class="keyword">sizeof</span>(DecParam));</span><br><span class="line">    </span><br><span class="line">    p-&gt;in = BIO_new_file(opt-&gt;key, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">    fail_clean_if(!p-&gt;in, decrypt_clean, (<span class="keyword">void</span> *)p, </span><br><span class="line">                  <span class="string">&quot;BIO_new_file(%s) fail\n&quot;</span>, opt-&gt;key);</span><br><span class="line">    pkey = PEM_read_bio_PrivateKey(p-&gt;in, <span class="literal">NULL</span>, <span class="literal">NULL</span>, PEM_AUTO_KEYPASS);</span><br><span class="line">    fail_clean_if(!pkey, decrypt_clean, (<span class="keyword">void</span> *)p, </span><br><span class="line">                  <span class="string">&quot;PEM_read_bio_PrivateKey() fail\n&quot;</span>);</span><br><span class="line">    p-&gt;ctx = EVP_PKEY_CTX_new(pkey, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (!p-&gt;ctx) &#123;</span><br><span class="line">        EVP_PKEY_free(pkey);</span><br><span class="line">        fail_clean_if(<span class="number">1</span>, decrypt_clean, (<span class="keyword">void</span> *)p, <span class="string">&quot;EVP_PKEY_CTX_new() fail\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    fail_clean_if(!EVP_PKEY_decrypt_init(p-&gt;ctx), decrypt_clean, (<span class="keyword">void</span> *)p, </span><br><span class="line">                  <span class="string">&quot;EVP_PKEY_decrypt_init() fail\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memcpy</span>(p-&gt;data, data, data_len);</span><br><span class="line">    p-&gt;data_len = data_len;</span><br><span class="line">    <span class="built_in">memcpy</span>(p-&gt;enc, enc, enc_len);</span><br><span class="line">    p-&gt;enc_len = enc_len;</span><br><span class="line"></span><br><span class="line">    p-&gt;index = proc_index;</span><br><span class="line">    *param = p;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">decrypt_work</span><span class="params">(<span class="keyword">void</span> *param)</span> </span>&#123;</span><br><span class="line">    DecParam *p = (DecParam *)param;</span><br><span class="line">    fail_clean_if(!EVP_PKEY_decrypt(p-&gt;ctx, p-&gt;data, &amp;p-&gt;data_len, p-&gt;enc, </span><br><span class="line">                                 p-&gt;enc_len), decrypt_clean, param,</span><br><span class="line">                  <span class="string">&quot;EVP_PKEY_decrypt() fail\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">decrypt_clean</span><span class="params">(<span class="keyword">void</span> *param)</span> </span>&#123;</span><br><span class="line">    DecParam *p = (DecParam *)param;</span><br><span class="line">    <span class="keyword">if</span> (p-&gt;ctx)</span><br><span class="line">        EVP_PKEY_CTX_free(p-&gt;ctx);</span><br><span class="line">    <span class="keyword">if</span> (p-&gt;in)</span><br><span class="line">        BIO_free(p-&gt;in);</span><br><span class="line">    OPENSSL_free(p);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</div></div>

<ul>
<li><code>multi-process.c</code></li>
</ul>
<div><div class="fold_hider"><div class="close hider_title">ç‚¹å‡»å±•å¼€ä»£ç </div></div><div class="fold">
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span>   <span class="comment">// wait</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span>  <span class="comment">// getpid, wait</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ipc.h&gt;</span>    <span class="comment">// shmget, shmat, shmctl, shmdt</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/shm.h&gt;</span>    <span class="comment">// shmget, shmat, shmctl, shmdt</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span>     <span class="comment">// sigaction, SIGLARM</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;limits.h&gt;</span>     <span class="comment">// LONG_MIN, LONG_MAX, ULLONG_MAX</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span>      <span class="comment">// errno</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span>     <span class="comment">// getpid</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span>     <span class="comment">// memset</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;common.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;opt.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;work.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> isStop = <span class="number">0</span>;             <span class="comment">// ç”¨äºæ ‡è®°æµ‹è¯•ç»ˆæ­¢</span></span><br><span class="line">Options opt;                <span class="comment">// å‘½ä»¤è¡Œé€‰é¡¹</span></span><br><span class="line"><span class="keyword">int</span> shmid;                  <span class="comment">// å…±äº«å†…å­˜id</span></span><br><span class="line">Result *shm = <span class="literal">NULL</span>;         <span class="comment">// å…±äº«å†…å­˜åœ°å€ï¼Œç”¨äºå­˜æ”¾æµ‹è¯•ç»“æœ</span></span><br><span class="line">Result res_total;</span><br><span class="line">Result res_last;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">handle_signal_child</span><span class="params">(<span class="keyword">int</span> sigNum)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (sigNum == SIGALRM) &#123;</span><br><span class="line">        isStop = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">handle_signal_parent</span><span class="params">(<span class="keyword">int</span> sigNum)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (sigNum == SIGALRM) &#123;</span><br><span class="line">        <span class="comment">/* DO REAL-TIME STATISTICS */</span></span><br><span class="line">        <span class="built_in">memset</span>(&amp;res_total, <span class="number">0</span>, <span class="keyword">sizeof</span>(Result));</span><br><span class="line">        <span class="keyword">long</span> i = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (; i &lt; opt.procs; ++i) &#123;</span><br><span class="line">            res_total.count += shm[i].count;</span><br><span class="line">        &#125;</span><br><span class="line">        mylog(<span class="string">&quot;total count %12llu,  average %12.0lf/s\n&quot;</span>,</span><br><span class="line">                res_total.count, (res_total.count - res_last.count)</span><br><span class="line">                / (<span class="keyword">double</span>)opt.interval);</span><br><span class="line">        <span class="built_in">memcpy</span>(&amp;res_last, &amp;res_total, <span class="keyword">sizeof</span>(Result));</span><br><span class="line">        <span class="comment">/* DO REAL-TIME STATISTICS */</span></span><br><span class="line">        alarm(opt.interval);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* æ‰§è¡Œæµ‹è¯•ä¸»å¾ªç¯å‡½æ•° */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">doTest</span><span class="params">(<span class="keyword">void</span> *param)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span> i = <span class="number">0</span>;</span><br><span class="line">    HashParam *pa = (HashParam *)param;</span><br><span class="line">    <span class="keyword">for</span> (; i &lt; ULLONG_MAX &amp;&amp; !isStop; ++i) &#123;</span><br><span class="line">        <span class="comment">/* DO YOUR WORK */</span></span><br><span class="line">        test_work(param);</span><br><span class="line">        ++shm[pa-&gt;index].count;</span><br><span class="line">        <span class="comment">/* DO YOUR WORK */</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> rv = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">long</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> proc_index = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> isParent = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">int</span> wstatus = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">pid_t</span> pid = <span class="number">0</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sigaction</span> <span class="title">act_child</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sigaction</span> <span class="title">act_parent</span>;</span></span><br><span class="line"></span><br><span class="line">    rv = process_options(argc, argv, &amp;opt);</span><br><span class="line">    <span class="keyword">if</span> (rv) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mylog(<span class="string">&quot;\n-----------------------------Start Testing-----------------------&quot;</span></span><br><span class="line">          <span class="string">&quot;-------\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* COMMON INIT */</span></span><br><span class="line">    shmid = shmget(IPC_PRIVATE, <span class="keyword">sizeof</span>(<span class="keyword">sizeof</span>(Result) * opt.procs), <span class="number">0666</span>);</span><br><span class="line">    fail_if(<span class="number">-1</span> == shmid, <span class="string">&quot;shmget() failed\n&quot;</span>);</span><br><span class="line">    mylog(<span class="string">&quot;shmid = %d\n&quot;</span>, shmid);</span><br><span class="line">    shm = (Result*)shmat(shmid, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    fail_if((<span class="keyword">void</span> *) <span class="number">-1</span> == shm, <span class="string">&quot;shmat() failed\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* è¿™é‡Œç›´æ¥è¿›è¡ŒIPC_RMIDæ“ä½œï¼Œè¿›ç¨‹é€€å‡ºä¹‹åä¼šè‡ªåŠ¨detachäº†, ä»è€Œé‡Šæ”¾å…±äº«å†…å­˜ */</span></span><br><span class="line">    shmctl(shmid, IPC_RMID, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">memset</span>(shm, <span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="keyword">sizeof</span>(Result) * opt.procs));</span><br><span class="line"></span><br><span class="line">    global_init(&amp;opt);</span><br><span class="line">    <span class="comment">/* COMMON INIT */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(isParent &amp;&amp; i &lt; opt.procs) &#123;</span><br><span class="line">        pid =  fork();</span><br><span class="line">        fail_if(<span class="number">-1</span> == pid, <span class="string">&quot;fork failed %d\n&quot;</span>, pid);    <span class="comment">/* error */</span></span><br><span class="line">        <span class="keyword">if</span>(pid == <span class="number">0</span>) &#123;                                  <span class="comment">/* child */</span></span><br><span class="line">            isParent = <span class="number">0</span>;</span><br><span class="line">            proc_index = i;                             <span class="comment">// è®°å½•è¿›ç¨‹ç´¢å¼•</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;                                          <span class="comment">/* parent */</span></span><br><span class="line">        &#125;</span><br><span class="line">        ++i;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(isParent) &#123;</span><br><span class="line">        <span class="comment">/* PARENT INIT */</span></span><br><span class="line">        <span class="built_in">memset</span>(&amp;act_parent, <span class="number">0</span>, <span class="keyword">sizeof</span>(act_parent));</span><br><span class="line">        act_parent.sa_handler = handle_signal_parent;</span><br><span class="line">        <span class="comment">/* ä½¿waitè¢«ä¸­æ–­æ—¶å¯ä»¥è‡ªåŠ¨æ¢å¤ */</span></span><br><span class="line">        act_parent.sa_flags = SA_RESTART;</span><br><span class="line">        rv = sigaction(SIGALRM, &amp;act_parent, <span class="literal">NULL</span>);     <span class="comment">// ç”¨äºå®šæ—¶ç»Ÿè®¡ç»“æœ</span></span><br><span class="line">        fail_if(rv, <span class="string">&quot;sigaction() failed\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">memset</span>(&amp;res_last, <span class="number">0</span>, <span class="keyword">sizeof</span>(Result));</span><br><span class="line">        alarm(opt.interval);</span><br><span class="line">        <span class="comment">/* PARENT INIT */</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/* DO FINAL STATISTICS */</span></span><br><span class="line">        Result <span class="keyword">final</span>;</span><br><span class="line">        <span class="built_in">memset</span>(&amp;<span class="keyword">final</span>, <span class="number">0</span>, <span class="keyword">sizeof</span>(Result));</span><br><span class="line">        <span class="keyword">for</span>(i =<span class="number">0</span> ; i &lt; opt.procs; ++i) &#123;</span><br><span class="line">            pid = wait(&amp;wstatus);                       <span class="comment">// ç­‰å¾…å­è¿›ç¨‹ç»“æŸ</span></span><br><span class="line">            alarm(<span class="number">0</span>);                                   <span class="comment">// ç»ˆæ­¢å®šæ—¶å™¨</span></span><br><span class="line">            fail_if(<span class="number">-1</span> == pid, <span class="string">&quot;wait() failed, errno=%d\n&quot;</span>, errno);</span><br><span class="line">            mylog(<span class="string">&quot;process [pid = %6d] exit\n&quot;</span>, pid);</span><br><span class="line">            mylog(<span class="string">&quot;process [pid = %6u] count %12llu in %lus,&quot;</span></span><br><span class="line">                  <span class="string">&quot;  average %12.0lf/s\n&quot;</span>, pid, shm[i].count, opt.duration, </span><br><span class="line">                  shm[i].count / (<span class="keyword">double</span>)opt.duration);</span><br><span class="line">            <span class="keyword">final</span>.count += shm[i].count;</span><br><span class="line">        &#125;</span><br><span class="line">        mylog(<span class="string">&quot;total count %12llu in %lus,  average %12.0lf/s\n&quot;</span>, </span><br><span class="line">               <span class="keyword">final</span>.count, opt.duration, <span class="keyword">final</span>.count / (<span class="keyword">double</span>)opt.duration);</span><br><span class="line">        <span class="comment">/* DO FINAL STATISTICS */</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/* PARENT CLEANUP */</span></span><br><span class="line">        global_clean();</span><br><span class="line">        <span class="comment">/* PARENT CLEANUP */</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">/* CHILD INIT */</span></span><br><span class="line">        <span class="keyword">void</span> *param;</span><br><span class="line">        test_init(&amp;opt, &amp;param, proc_index);</span><br><span class="line">        <span class="comment">/* CHILD INIT */</span></span><br><span class="line"></span><br><span class="line">        act_child.sa_handler = handle_signal_child;</span><br><span class="line">        sigemptyset(&amp;act_child.sa_mask);</span><br><span class="line">        act_child.sa_flags = SA_RESETHAND;</span><br><span class="line">        <span class="comment">/* ç”¨äºæµ‹è¯•æ—¶é—´åˆ°æ—¶ï¼Œé€šçŸ¥å­è¿›ç¨‹ç»“æŸæµ‹è¯• */</span></span><br><span class="line">        rv = sigaction(SIGALRM, &amp;act_child, <span class="literal">NULL</span>);</span><br><span class="line">        fail_if(rv, <span class="string">&quot;sigaction() failed\n&quot;</span>);</span><br><span class="line">        alarm(opt.duration);                            <span class="comment">// è®¾ç½®æµ‹è¯•æ—¶é•¿</span></span><br><span class="line">        doTest(param);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* CHILD CLEANUP */</span></span><br><span class="line">        test_clean(param);</span><br><span class="line">        global_clean();</span><br><span class="line">        <span class="comment">/* CHILD CLEANUP */</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;       <span class="comment">/* child finished work */</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</div></div>




<h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>è‡³æ­¤ï¼Œä¸€ä¸ªå¤šè¿›ç¨‹çš„æµ‹è¯•ç¨‹åºå°±ç®—å®Œæˆäº†ã€‚è¯»è€…å¯ä»¥æ ¹æ®è‡ªèº«æµ‹è¯•éœ€è¦ï¼ŒæŒ‰å¦‚ä¸‹æ­¥éª¤ä¿®æ”¹ä»¥è¿›è¡Œè‡ªå®šä¹‰çš„æµ‹è¯•ã€‚</p>
<ol>
<li>åœ¨<code>opt.c</code>å’Œ<code>opt.h</code>ä¸­ï¼Œæ·»åŠ éœ€è¦çš„å‘½ä»¤è¡Œé€‰é¡¹</li>
<li>åœ¨<code>work.c</code>å’Œ<code>work.h</code>ä¸­ï¼Œ<code>global_init()</code>å’Œ<code>global_clean()</code>å†…è¿›è¡Œå…¨å±€çš„åˆå§‹åŒ–åŠå…¨å±€çš„æ¸…ç†å·¥ä½œ</li>
<li>åœ¨<code>work.c</code>å’Œ<code>work.h</code>ä¸­ï¼Œæ·»åŠ è‡ªå®šä¹‰çš„æµ‹è¯•å‡½æ•°ï¼Œä»¥åŠç›¸åº”çš„æµ‹è¯•å‚æ•°å’Œæµ‹è¯•ç»“æœ</li>
<li>ä¸»æ§<code>multi-process.c</code>é€šè¿‡<code>test_init()</code>ã€<code>test_work()</code>ã€<code>test_clean()</code>è°ƒç”¨æµ‹è¯•ç›¸å…³çš„åˆå§‹åŒ–ã€æ‰§è¡ŒåŠæ¸…ç†å·¥ä½œ</li>
<li>ä¸»æ§<code>multi-process.c</code>ä¸­ï¼Œä¿®æ”¹æµ‹è¯•ç»“æœçš„æ›´æ–°ä¸ç»Ÿè®¡æ“ä½œã€‚</li>
</ol>
<p>ä¸»æ§<code>multi-process.c</code>ä¸­ï¼š</p>
<ul>
<li><code>COMMON INIT</code>ã€<code>PARENT INIT</code>å’Œ<code>CHILD INIT</code>ä»£ç å—å¤„åˆ†åˆ«è¿›è¡Œå…¬å…±çš„åˆå§‹åŒ–å·¥ä½œå’Œçˆ¶å­è¿›ç¨‹ç‰¹å®šçš„åˆå§‹åŒ–å·¥ä½œã€‚</li>
<li><code>PARENT CLEANUP</code>å’Œ<code>CHILD CLEANUP</code>ä»£ç å—å¤„åˆ™åˆ†åˆ«è¿›è¡Œå¯¹åº”çš„æ¸…ç†å·¥ä½œã€‚</li>
<li><code>DO YOUR WORK</code>å¤„æ‰§è¡Œå…·ä½“çš„æµ‹è¯•ï¼Œ<code>DO REAL-TIME STATISTICS</code>å’Œ<code>DO FINAL STATISTICS</code>å¤„è¿›è¡Œæµ‹è¯•ç»“æœçš„ç»Ÿè®¡ã€‚</li>
</ul>
<p>å½“ç„¶æœ¬æ–‡è¿˜æœ‰ä¸€äº›ä¸è¶³ä¹‹å¤„ï¼Œæ¯”å¦‚å½“å‰æ˜¯ç”¨çš„OpenSSL1.0.2æ¥å£ï¼Œæ²¡æœ‰å…¼å®¹ä¸åŒç‰ˆæœ¬çš„OpenSSLã€‚è¿˜æœ‰ä»£ç é£æ ¼çš„é—®é¢˜ï¼Œåœ¨å‡½æ•°å‘½åå’Œæ³¨é‡Šæ–¹å¼ä¸Šä¸ç»Ÿä¸€ã€‚ä½†æ˜¯è€ƒè™‘åˆ°è¿™ä¸ªæ˜¯æµ‹è¯•ç¨‹åºï¼Œå°±ä¸è®¡è¾ƒè¿™ä¹ˆå¤šäº†ï¼ˆ^ã€‚^ï¼‰</p>
]]></content>
      <categories>
        <category>ç¼–ç¨‹å¼€å‘</category>
        <category>Unixç¯å¢ƒç¼–ç¨‹</category>
      </categories>
      <tags>
        <tag>å…±äº«å†…å­˜</tag>
        <tag>å¤šè¿›ç¨‹</tag>
        <tag>ä¿¡å·</tag>
      </tags>
  </entry>
</search>
